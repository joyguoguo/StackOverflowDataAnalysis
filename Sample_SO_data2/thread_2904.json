{
  "question" : {
    "question_id" : 79589002,
    "title" : "Converting desktop Java gmail access app from password to OAuth2: AUTHENTICATIONFAILED",
    "body" : "<p>I have been using a desktop Java application (DigitGrabber) to peek into my email server (that's hosted by Google) to quickly ferret out the second factor six digit codes that so many sites are using these days.</p>\n<p>This worked great until Google decided to force me to turn on OAuth2.  I configured my regular email client (Thunderbird) for OAuth fine, but I'm having trouble getting my DigitGrabber working.  I'm getting:</p>\n<pre><code>jakarta.mail.AuthenticationFailedException [AUTHENTICATIONFAILED] Invalid credentials (Failure)\n</code></pre>\n<p>I have gone through and registered my application with Google, downloaded the client secret into a json file, got the code working that gets the access token:</p>\n<pre><code>String accessToken = Main.authorize(userId).getAccessToken();\n</code></pre>\n<p><code>Main.authorize().getAccessToken()</code> seems to be working.  At least I get an access token back, but <strong>when I try to get to my inbox, it fails with the authentication issue</strong>.</p>\n<p>QUESTION: What is wrong with my approach or code that is causing the authentication failure?  Is there some application &quot;alignment issue&quot; that I need to address?  All I did was go to <a href=\"https://console.cloud.google.com\" rel=\"nofollow noreferrer\">https://console.cloud.google.com</a> and register and it gave me an application name, a client secret, etc, that I've been using with all my test programs.  And I've just been fumbling around, grabbing code from here and there to get to the point I'm at now, not really familiar with the Google cloud landscape.  Is there somewhere in my code where I can log some details of some objects that might shed light on why I'm not getting authenticated?</p>\n<p>Also, I'm getting a warning that I don't understand:</p>\n<pre><code>Apr 23, 2025 11:51:27 AM com.google.api.client.util.store.FileDataStoreFactory setPermissionsToOwnerOnly\nWARNING: unable to change permissions for everybody: C:\\Users\\Owner\\.credentials\\google-oauth\n</code></pre>\n<p>Below is the code I'm running:</p>\n<pre><code>private String runImap(String userId) {\n    Session session = null;\n    Store store = null;\n    Folder folder = null;\n    try {\n        boolean useOauth = true;\n        //https://kgiann78.github.io/java/gmail/2017/03/16/JavaMail-send-mail-at-Google-with-XOAUTH2/\n        //https://learn.microsoft.com/en-us/answers/questions/1195069/javax-mail-authenticationfailedexception-authentic\n        if (useOauth) {\n            Properties props = System.getProperties();\n            props.put(&quot;mail.store.protocol&quot;, &quot;imap&quot;);\n            props.put(&quot;mail.imap.ssl.enable&quot;, &quot;true&quot;); // required for Gmail\n            props.put(&quot;mail.imap.starttls.enable&quot;, &quot;true&quot;);\n            props.put(&quot;mail.debug&quot;, &quot;true&quot;);\n            props.put(&quot;mail.debug.auth&quot;, &quot;true&quot;);\n            props.put(&quot;mail.imap.auth.mechanisms&quot;, &quot;XOAUTH2&quot;);\n            props.put(&quot;mail.imap.sasl.enable&quot;, &quot;true&quot;);\n            props.put(&quot;mail.imap.sasl.mechanisms&quot;, &quot;XOAUTH2&quot;);\n            props.put(&quot;mail.imap.auth.login.disable&quot;, &quot;true&quot;);\n            props.put(&quot;mail.imap.auth.plain.disable&quot;, &quot;true&quot;);\n            props.put(&quot;mail.imap.user&quot;, userId);\n            session = Session.getInstance(props);\n            session.setDebug(true);\n            store = session.getStore(&quot;imap&quot;);\n            String accessToken = Main.authorize(userId).getAccessToken();\n            System.out.println(&quot;access token [&quot; + accessToken + &quot;]&quot;); // I DO get an access token here!!\n            store.connect(&quot;imap.gmail.com&quot;, userId, accessToken); //&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;Exception thrown here\n        } else { \n            // OLD WAY\n            Properties props = System.getProperties();\n            props.setProperty(&quot;mail.store.protocol&quot;, &quot;imaps&quot;);\n            session = Session.getDefaultInstance(props, null);\n            store = session.getStore(&quot;imaps&quot;);\n            System.out.println(&quot;connecting to &quot; + userId  + &quot; inbox.&quot;);\n            store.connect(&quot;imap.googlemail.com&quot;, userId, password);\n        }\n        \n        folder = store.getFolder(&quot;inbox&quot;);\n        folder.open(Folder.READ_ONLY);\n        Message[] msgs = folder.getMessages();\n        System.out.println(msgs.length + &quot; messages found.&quot;);\n        for (int i = msgs.length - 1; i &gt; -1; i--) {\n            String code = getCodeFromMessage(msgs[i], i);\n            System.out.println(&quot;code [&quot; + code + &quot;]&quot;);\n            if (code !=null &amp;&amp; !&quot;******&quot;.equals(code)) break;\n        }\n    } catch (Exception e) {\n        System.err.println(&quot;SimpleGUI.actionPerformed() runImap(): &quot; + e.getClass().getName() + &quot; &quot; + e.getMessage());\n        e.printStackTrace();\n        return e.getMessage();\n    } finally {\n        try {folder.close(false); System.out.println(&quot;Folder closed.&quot;); /*expunge false means do not delete*/} catch (Throwable t) {System.out.println(&quot;Failed to close folder.&quot;);} \n        try {store.close(); System.out.println(&quot;Store closed.&quot;); } catch (Throwable t) {} // ignore\n    }\n    return null; //good result if we didn't return from the catch\n}\n\n\npublic class Main {\nprivate static final String CLIENT_SECRET_FILENAME = &quot;C:\\\\Users\\\\Owner\\\\eclipse-workspace\\\\GetEmailCodes\\\\client_secret_gibberishhere.json&quot;;\nprivate static final java.io.File DATA_STORE_DIR = new java.io.File(System.getProperty(&quot;user.home&quot;), &quot;.credentials/google-oauth&quot;);\nprivate static FileDataStoreFactory dataStoreFactory;\nprivate static final JacksonFactory JSON_FACTORY = JacksonFactory.getDefaultInstance();\nprivate static NetHttpTransport httpTransport;\nprivate static final List&lt;String&gt; SCOPES = Arrays.asList(&quot;https://mail.google.com&quot;, &quot;https://www.googleapis.com/auth/userinfo.profile&quot;,&quot;https://www.googleapis.com/auth/userinfo.email&quot;);\n\n\nstatic {\n    try {\n        httpTransport = new NetHttpTransport();\n        dataStoreFactory = new FileDataStoreFactory(DATA_STORE_DIR);\n    } catch (IOException e) {\n        e.printStackTrace();\n    }\n}\n\npublic static Credential authorize(String userId) throws Exception {\n    // Load client secrets.\n    System.out.println(&quot;Can read &quot; + CLIENT_SECRET_FILENAME + &quot;: &quot; + new File(CLIENT_SECRET_FILENAME).canRead());\n    \n    InputStreamReader isr = new InputStreamReader(new FileInputStream(CLIENT_SECRET_FILENAME));\n    \n    System.out.println(&quot;InputStream created: &quot; + isr);\n    System.out.println(&quot;InputStream ready &quot; + isr.ready());\n    \n    GoogleClientSecrets clientSecrets = GoogleClientSecrets.load(JSON_FACTORY, isr);\n    \n    System.out.println(&quot;clientSecrets &quot; + clientSecrets);\n    \n    if (clientSecrets == null) {\n        System.out.println(&quot;can read &quot; + CLIENT_SECRET_FILENAME + &quot;: &quot; + new File(CLIENT_SECRET_FILENAME).canRead());\n        throw new Exception(&quot;clientSecrets was null&quot;);\n    }\n\n    // Build flow and trigger user authorization request.\n    GoogleAuthorizationCodeFlow flow =\n            new GoogleAuthorizationCodeFlow.Builder(\n                    httpTransport, JSON_FACTORY, clientSecrets, SCOPES)\n                    .setDataStoreFactory(dataStoreFactory)\n                    .setAccessType(&quot;offline&quot;)\n                    .build();\n    LocalServerReceiver receiver = new LocalServerReceiver.Builder().setPort(8888).build();\n    Credential credential = new AuthorizationCodeInstalledApp(flow, receiver).authorize(userId);\n    \n    long expiresInSeconds = credential.getExpiresInSeconds();\n    System.out.println(&quot;Expires in seconds: &quot; + expiresInSeconds);\n    \n    if (expiresInSeconds &lt; 60) {\n        boolean refreshResult = credential.refreshToken();\n        System.out.println(&quot;refresh token result &quot; + refreshResult);\n        expiresInSeconds = credential.getExpiresInSeconds();\n        System.out.println(&quot;Expires in seconds: &quot; + expiresInSeconds);\n        \n    }\n    \n    \n    return credential;\n}\n} \n</code></pre>\n<p>The following is the output I'm getting:</p>\n<pre><code>checking email for someemail@somedomain.com\nDEBUG: Jakarta Mail version 2.1.3\nDEBUG: URL jar:file:/C:/Users/Owner/.m2/repository/org/eclipse/angus/angus-mail/2.0.3/angus-mail-2.0.3.jar!/META-INF/javamail.providers\nDEBUG: successfully loaded resource: jar:file:/C:/Users/Owner/.m2/repository/org/eclipse/angus/angus-mail/2.0.3/angus-mail-2.0.3.jar!/META-INF/javamail.providers\nDEBUG: successfully loaded resource: /META-INF/javamail.default.providers\nDEBUG: Tables of loaded providers\nDEBUG: Providers Listed By Class Name: {org.eclipse.angus.mail.imap.IMAPStore=jakarta.mail.Provider[STORE,imap,org.eclipse.angus.mail.imap.IMAPStore,Oracle], org.eclipse.angus.mail.smtp.SMTPTransport=jakarta.mail.Provider[TRANSPORT,smtp,org.eclipse.angus.mail.smtp.SMTPTransport,Oracle], org.eclipse.angus.mail.pop3.POP3Store=jakarta.mail.Provider[STORE,pop3,org.eclipse.angus.mail.pop3.POP3Store,Oracle], org.eclipse.angus.mail.pop3.POP3SSLStore=jakarta.mail.Provider[STORE,pop3s,org.eclipse.angus.mail.pop3.POP3SSLStore,Oracle], org.eclipse.angus.mail.smtp.SMTPSSLTransport=jakarta.mail.Provider[TRANSPORT,smtps,org.eclipse.angus.mail.smtp.SMTPSSLTransport,Oracle], org.eclipse.angus.mail.imap.IMAPSSLStore=jakarta.mail.Provider[STORE,imaps,org.eclipse.angus.mail.imap.IMAPSSLStore,Oracle]}\nDEBUG: Providers Listed By Protocol: {imap=jakarta.mail.Provider[STORE,imap,org.eclipse.angus.mail.imap.IMAPStore,Oracle], smtp=jakarta.mail.Provider[TRANSPORT,smtp,org.eclipse.angus.mail.smtp.SMTPTransport,Oracle], pop3=jakarta.mail.Provider[STORE,pop3,org.eclipse.angus.mail.pop3.POP3Store,Oracle], imaps=jakarta.mail.Provider[STORE,imaps,org.eclipse.angus.mail.imap.IMAPSSLStore,Oracle], smtps=jakarta.mail.Provider[TRANSPORT,smtps,org.eclipse.angus.mail.smtp.SMTPSSLTransport,Oracle], pop3s=jakarta.mail.Provider[STORE,pop3s,org.eclipse.angus.mail.pop3.POP3SSLStore,Oracle]}\nDEBUG: successfully loaded resource: /META-INF/javamail.default.address.map\nDEBUG: URL jar:file:/C:/Users/Owner/.m2/repository/org/eclipse/angus/angus-mail/2.0.3/angus-mail-2.0.3.jar!/META-INF/javamail.address.map\nDEBUG: successfully loaded resource: jar:file:/C:/Users/Owner/.m2/repository/org/eclipse/angus/angus-mail/2.0.3/angus-mail-2.0.3.jar!/META-INF/javamail.address.map\nDEBUG: setDebug: Jakarta Mail version 2.1.3\nDEBUG: getProvider() returning jakarta.mail.Provider[STORE,imap,org.eclipse.angus.mail.imap.IMAPStore,Oracle]\nDEBUG IMAP: mail.imap.fetchsize: 16384\nDEBUG IMAP: mail.imap.ignorebodystructuresize: false\nDEBUG IMAP: mail.imap.statuscachetimeout: 1000\nDEBUG IMAP: mail.imap.appendbuffersize: -1\nDEBUG IMAP: mail.imap.minidletime: 10\nDEBUG IMAP: enable STARTTLS\nDEBUG IMAP: enable SASL\nDEBUG IMAP: SASL mechanisms allowed: XOAUTH2\nDEBUG IMAP: closeFoldersOnStoreFailure\nApr 23, 2025 8:18:37 PM com.google.api.client.util.store.FileDataStoreFactory setPermissionsToOwnerOnly\nWARNING: unable to change permissions for everybody: C:\\Users\\Owner\\.credentials\\google-oauth\nApr 23, 2025 8:18:37 PM com.google.api.client.util.store.FileDataStoreFactory setPermissionsToOwnerOnly\nWARNING: unable to change permissions for owner: C:\\Users\\Owner\\.credentials\\google-oauth\nCan read C:\\Users\\Owner\\eclipse-workspace\\EmailCodesOauth\\src\\main\\resources\\client_secret_947814295630-3n(removed some gibberish)ko.apps.googleusercontent.com.json: true\nInputStream created: java.io.InputStreamReader@256f825c\nInputStream ready true\nclientSecrets {&quot;installed&quot;:{&quot;auth_uri&quot;:&quot;https://accounts.google.com/o/oauth2/auth&quot;,&quot;client_id&quot;:&quot;947814295630-3nc1(removed some gibberish)1ko.apps.googleusercontent.com&quot;,&quot;client_secret&quot;:&quot;GOCSPX-E66i(removed some gibberish)mTNl&quot;,&quot;redirect_uris&quot;:[&quot;http://localhost&quot;],&quot;token_uri&quot;:&quot;https://oauth2.googleapis.com/token&quot;,&quot;project_id&quot;:&quot;getemailcodes-45(removed some numbers)&quot;,&quot;auth_provider_x509_cert_url&quot;:&quot;https://www.googleapis.com/oauth2/v1/certs&quot;}}\nExpires in seconds: 3537\naccess token [ya29.a0AZYkNZ(removed some gibberish)g_N7HdPfGlTw0175]\nDEBUG IMAP: trying to connect to host &quot;imap.gmail.com&quot;, port 993, isSSL true\n* OK Gimap ready for requests from 136.000.0000.155 (put 000 twice) tz17(removed some gibberish)qkn\nA0 CAPABILITY\n* CAPABILITY IMAP4rev1 UNSELECT IDLE NAMESPACE QUOTA ID XLIST CHILDREN X-GM-EXT-1 XYZZY SASL-IR AUTH=XOAUTH2 AUTH=PLAIN AUTH=PLAIN-CLIENTTOKEN AUTH=OAUTHBEARER\nA0 OK Thats all she wrote! tz17(removed some gibberish)kn\nDEBUG IMAP: AUTH: XOAUTH2\nDEBUG IMAP: AUTH: PLAIN\nDEBUG IMAP: AUTH: PLAIN-CLIENTTOKEN\nDEBUG IMAP: AUTH: OAUTHBEARER\nDEBUG IMAP: protocolConnect login, host=imap.gmail.com, user=someemail@somedomain.com, password=&lt;non-null&gt;\nDEBUG IMAP: SASL Mechanisms:\nDEBUG IMAP:  XOAUTH2\nDEBUG IMAP: \nDEBUG IMAP: SASL client XOAUTH2\nDEBUG IMAP: SASL callback length: 2\nDEBUG IMAP: SASL callback 0: javax.security.auth.callback.NameCallback@7e5fa540\nDEBUG IMAP: SASL callback 1: javax.security.auth.callback.PasswordCallback@1c9c1c10\nA1 AUTHENTICATE XOAUTH2 dXNlcj1kYWxlQH(removed some gibberish)kdsVHcwMTc1AQE=\n+ eyJzdGF0dXMiOiI0MDAiLCJzY2hlbWVzIjoi(removed some gibberish)Z29vZ2xlLmNvbS8ifQ==\nDEBUG IMAP: SASL no response\n\nA1 NO [AUTHENTICATIONFAILED] Invalid credentials (Failure)\nSimpleGUI.actionPerformed() runImap(): jakarta.mail.AuthenticationFailedException [AUTHENTICATIONFAILED] Invalid credentials (Failure)\njakarta.mail.AuthenticationFailedException: [AUTHENTICATIONFAILED] Invalid credentials (Failure)\n    at org.eclipse.angus.mail.imap.IMAPStore.protocolConnect(IMAPStore.java:724)\n    at jakarta.mail.Service.connect(Service.java:345)\n    at jakarta.mail.Service.connect(Service.java:225)\n    at com.sengsational.eco.SimpleGUI.runImap(SimpleGUI.java:154)\n    at com.sengsational.eco.SimpleGUI.actionPerformed(SimpleGUI.java:116)\n    at java.desktop/javax.swing.AbstractButton.fireActionPerformed(AbstractButton.java:1972)\n    at java.desktop/javax.swing.AbstractButton$Handler.actionPerformed(AbstractButton.java:2313)\n    at java.desktop/javax.swing.DefaultButtonModel.fireActionPerformed(DefaultButtonModel.java:405)\n    at java.desktop/javax.swing.DefaultButtonModel.setPressed(DefaultButtonModel.java:262)\n    at java.desktop/javax.swing.plaf.basic.BasicButtonListener.mouseReleased(BasicButtonListener.java:279)\n    at java.desktop/java.awt.Component.processMouseEvent(Component.java:6620)\n    at java.desktop/javax.swing.JComponent.processMouseEvent(JComponent.java:3398)\n    at java.desktop/java.awt.Component.processEvent(Component.java:6385)\n    at java.desktop/java.awt.Container.processEvent(Container.java:2266)\n    at java.desktop/java.awt.Component.dispatchEventImpl(Component.java:4995)\n    at java.desktop/java.awt.Container.dispatchEventImpl(Container.java:2324)\n    at java.desktop/java.awt.Component.dispatchEvent(Component.java:4827)\n    at java.desktop/java.awt.LightweightDispatcher.retargetMouseEvent(Container.java:4948)\n    at java.desktop/java.awt.LightweightDispatcher.processMouseEvent(Container.java:4575)\n    at java.desktop/java.awt.LightweightDispatcher.dispatchEvent(Container.java:4516)\n    at java.desktop/java.awt.Container.dispatchEventImpl(Container.java:2310)\n    at java.desktop/java.awt.Window.dispatchEventImpl(Window.java:2780)\n    at java.desktop/java.awt.Component.dispatchEvent(Component.java:4827)\n    at java.desktop/java.awt.EventQueue.dispatchEventImpl(EventQueue.java:775)\n    at java.desktop/java.awt.EventQueue$4.run(EventQueue.java:720)\n    at java.desktop/java.awt.EventQueue$4.run(EventQueue.java:714)\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:399)\n    at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:86)\n    at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:97)\n    at java.desktop/java.awt.EventQueue$5.run(EventQueue.java:747)\n    at java.desktop/java.awt.EventQueue$5.run(EventQueue.java:745)\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:399)\n    at java.base/java.security.ProtectionDomain$JavaSecurityAccessImpl.doIntersectionPrivilege(ProtectionDomain.java:86)\n    at java.desktop/java.awt.EventQueue.dispatchEvent(EventQueue.java:744)\n    at java.desktop/java.awt.EventDispatchThread.pumpOneEventForFilters(EventDispatchThread.java:203)\n    at java.desktop/java.awt.EventDispatchThread.pumpEventsForFilter(EventDispatchThread.java:124)\n    at java.desktop/java.awt.EventDispatchThread.pumpEventsForHierarchy(EventDispatchThread.java:113)\n    at java.desktop/java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:109)\n    at java.desktop/java.awt.EventDispatchThread.pumpEvents(EventDispatchThread.java:101)\n    at java.desktop/java.awt.EventDispatchThread.run(EventDispatchThread.java:90)\nFailed to close folder.\nDEBUG IMAP: IMAPStore cleanup, not connected\nStore closed.\n</code></pre>\n",
    "tags" : [ "java", "google-oauth", "email-client", "gmail-imap" ],
    "owner" : {
      "account_id" : 482547,
      "reputation" : 6007,
      "user_id" : 897007,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://www.gravatar.com/avatar/3db84802a7ea6df4e925635d6c3df00c?s=256&d=identicon&r=PG",
      "display_name" : "Dale",
      "link" : "https://stackoverflow.com/users/897007/dale"
    },
    "is_answered" : true,
    "view_count" : 119,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1745519077,
    "creation_date" : 1745423060,
    "link" : "https://stackoverflow.com/questions/79589002/converting-desktop-java-gmail-access-app-from-password-to-oauth2-authentication",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79591260,
    "question_id" : 79589002,
    "body" : "<p>The problem, in my case, was that somehow the data in <code>C:\\Users\\Owner\\.credentials\\google-oauth\\StoredCredential</code> was wrong.</p>\n<p>I ran the following code, then tried again.  It opened the browser, I typed the userId and password, closed the browser, and it was able to access my email account through IMAP.</p>\n<p>The code in the original question is probably full of unneeded things due to my trial and error, and isn't exactly what I've got working (but it's close).</p>\n<pre><code>        File aFile = new File(System.getProperty(&quot;user.home&quot;), &quot;.credentials/google-oauth&quot;);\n        System.out.println(&quot;file [&quot; + aFile.getAbsolutePath() + &quot;]&quot;);\n        FileDataStoreFactory dataStoreFactory = new FileDataStoreFactory(aFile);\n        DataStore dataStore = dataStoreFactory.getDataStore(&quot;StoredCredential&quot;);\n        System.out.println(&quot;dataStore &quot; + dataStore);\n        dataStore.delete(&quot;myemail@gmail.com&quot;);\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 482547,
      "reputation" : 6007,
      "user_id" : 897007,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://www.gravatar.com/avatar/3db84802a7ea6df4e925635d6c3df00c?s=256&d=identicon&r=PG",
      "display_name" : "Dale",
      "link" : "https://stackoverflow.com/users/897007/dale"
    },
    "creation_date" : 1745519077,
    "last_activity_date" : 1745519077,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}