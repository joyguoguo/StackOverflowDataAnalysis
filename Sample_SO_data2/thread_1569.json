{
  "question" : {
    "question_id" : 79697417,
    "title" : "With a minimum of copies, convert length-bounded UTF-8 MemorySegment in java.lang.foreign",
    "body" : "<p>Suppose I have a sequence of bytes coming from C or some other native platform, expressed on the JVM as a <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/MemorySegment.html\" rel=\"noreferrer\"><code>java.lang.foreign.MemorySegment</code></a> and an <code>int</code> (or whatever) length.  This byte sequence is <em>not</em> zero-terminated.</p>\n<p>How can I convert this into a <code>java.lang.String</code> with a minimum of copying?</p>\n<p>In particular, the Javadoc for <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/MemorySegment.html#getString(long,java.nio.charset.Charset)\" rel=\"noreferrer\"><code>MemorySegment.getString(long, Charset)</code></a> suggests creating a fresh <code>byte[]</code>, copying the <code>MemorySegment</code> into that <code>byte[]</code>, and converting that <code>byte[]</code> to a <code>String</code>:</p>\n<pre><code>    byte[] bytes = new byte[length];\n    MemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, length);\n    return new String(bytes, charset);\n</code></pre>\n<p>Given <a href=\"https://minborgsjavapot.blogspot.com/2023/08/java-22-panama-ffm-provides-massive.html\" rel=\"noreferrer\">Oracle's bragging about FFM's efficiency in converting strings</a>, I'd hope for there to be a way that avoids this copy, but perhaps I'm incorrect.</p>\n<p>(Please assume I'm familiar with Knuth's dictum about optimization and know that this is worth the time to optimize.)</p>\n",
    "tags" : [ "java", "project-panama", "java-ffm" ],
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "is_answered" : true,
    "view_count" : 296,
    "answer_count" : 1,
    "score" : 12,
    "last_activity_date" : 1752376787,
    "creation_date" : 1752168776,
    "link" : "https://stackoverflow.com/questions/79697417/with-a-minimum-of-copies-convert-length-bounded-utf-8-memorysegment-in-java-lan",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79698821,
    "question_id" : 79697417,
    "body" : "<p>Looking at the <a href=\"https://github.com/openjdk/jdk/blob/ee0d309bbd33302d8c6f35155e975db77aaea785/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java#L52\" rel=\"nofollow noreferrer\">source code</a>, the implementation of <code>MemorySegment::getString</code> essentially does the same thing as when manually copying the string bytes as demonstrated <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/MemorySegment.html#getString(long,java.nio.charset.Charset)\" rel=\"nofollow noreferrer\">here</a>:</p>\n<blockquote>\n<pre class=\"lang-java prettyprint-override\"><code>byte[] bytes = new byte[length];\nMemorySegment.copy(segment, JAVA_BYTE, offset, bytes, 0, length);\nreturn new String(bytes, charset);\n</code></pre>\n</blockquote>\n<p>Except that approach knows the length ahead of time, so it will be slightly faster for longer strings since the string won't have to be searched for a null character (which <code>getString</code> has to do).</p>\n<p>There has to be at least one copy since you have to get a <code>byte[]</code> from the <code>MemorySegment</code>. With the provided public API, there has to be at least another copy to ensure the integrity of <code>String</code> (i.e., don't want to let anyone modify the <code>byte[]</code> internal to the string). And then on top of that, the bytes may have to be decoded and then encoded to &quot;fit&quot; the internal representation of string (which since Java 9 uses Latin1 when possible and UTF-16 when not).</p>\n<p>The only way I can think of to <em>potentially</em> avoid one of those copies is to use the internal <a href=\"https://github.com/openjdk/jdk/blob/master/src/java.base/share/classes/jdk/internal/access/JavaLangAccess.java\" rel=\"nofollow noreferrer\"><code>JavaLangAccess</code></a> API. Though as you'll see in the benchmarks below, this is not a magic bullet in all cases. And it also behaves differently. The <code>String</code> constructor replaces malformed/unmappable input, whereas <code>JavaLangAccess</code> will throw a <code>CharacterCodingException</code>. Plus, as noted, it's <em>internal</em> API.</p>\n<hr />\n<h1>Benchmarks (JMH)</h1>\n<p>I found the performance can be quite dependent on the encoding used and the content of the string. I also tested using a <code>CharsetDecoder</code> as suggested by g00se.</p>\n<p>I ran the benchmarks using two strings, one which contains only Latin characters (actually only English characters, specifically Lorem Ipsum text) and one which contains Unicode characters (taken from <a href=\"https://www.w3.org/2001/06/utf-8-test/UTF-8-demo.html\" rel=\"nofollow noreferrer\">https://www.w3.org/2001/06/utf-8-test/UTF-8-demo.html</a>). These strings were 7,308 and 7,216 characters (<code>char</code>) in length, respectively.</p>\n<p>I used an 8 core 7th gen Intel CPU (I know, it's old). Configured 5 warmups (10 seconds) and 10 measurements (15 seconds). Only 1 fork. Java 24.0.1 and JMH 1.37.</p>\n<p>Note for the US-ASCII and ISO-8859-1 encodings, processing the Unicode text obviously results in encoding/decoding errors. The benchmarks still run but technically the text is copied incorrectly. This may make the results invalid in these cases specifically. The fact the same two strings are used repeatedly may also affect the results.</p>\n<p>Also note that using <code>JavaLangAccess</code> requires the following at compile-time and run-time:</p>\n<pre class=\"lang-none prettyprint-override\"><code>--add-exports java.base/jdk.internal.access=ALL-UNNAMED\n</code></pre>\n<h2>Results</h2>\n<p>Here's are the different &quot;types&quot; (i.e., approaches).</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Direct</td>\n<td>Used <code>MemorySegment::getString</code></td>\n</tr>\n<tr>\n<td>Manual</td>\n<td>Used <code>MemorySegment::copy</code> and <code>new String(...)</code></td>\n</tr>\n<tr>\n<td>Access</td>\n<td>Used <code>MemorySegment::copy</code> and <code>JavaLangAccess</code></td>\n</tr>\n<tr>\n<td>Decoder</td>\n<td>Used <code>CharsetDecoder</code></td>\n</tr>\n</tbody>\n</table></div>\n<h4>JMH Output</h4>\n<pre class=\"lang-none prettyprint-override\"><code>Benchmark                  (encoding)   (text)   (type)  Mode  Cnt      Score      Error  Units\nStringCopyBenchmarks.copy    US_ASCII    LATIN   DIRECT  avgt   10   1708.419 ±   12.458  ns/op\nStringCopyBenchmarks.copy    US_ASCII    LATIN   MANUAL  avgt   10   1467.333 ±   56.101  ns/op\nStringCopyBenchmarks.copy    US_ASCII    LATIN   ACCESS  avgt   10    827.342 ±    6.862  ns/op\nStringCopyBenchmarks.copy    US_ASCII    LATIN  DECODER  avgt   10   7778.192 ±   84.048  ns/op\nStringCopyBenchmarks.copy    US_ASCII  UNICODE   DIRECT  avgt   10   1898.547 ±    8.694  ns/op\nStringCopyBenchmarks.copy    US_ASCII  UNICODE   MANUAL  avgt   10   1476.463 ±   85.045  ns/op\nStringCopyBenchmarks.copy    US_ASCII  UNICODE   ACCESS  avgt   10    823.858 ±    5.233  ns/op\nStringCopyBenchmarks.copy    US_ASCII  UNICODE  DECODER  avgt   10   7676.579 ±   59.164  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1    LATIN   DIRECT  avgt   10   1585.130 ±   36.055  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1    LATIN   MANUAL  avgt   10   1361.306 ±   13.265  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1    LATIN   ACCESS  avgt   10    707.539 ±    3.944  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1    LATIN  DECODER  avgt   10   7661.786 ±  117.882  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1  UNICODE   DIRECT  avgt   10   1746.565 ±   21.722  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1  UNICODE   MANUAL  avgt   10   1335.783 ±    8.649  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1  UNICODE   ACCESS  avgt   10    695.458 ±    4.038  ns/op\nStringCopyBenchmarks.copy  ISO_8859_1  UNICODE  DECODER  avgt   10   7400.236 ±  130.805  ns/op\nStringCopyBenchmarks.copy       UTF_8    LATIN   DIRECT  avgt   10   1641.523 ±   33.148  ns/op\nStringCopyBenchmarks.copy       UTF_8    LATIN   MANUAL  avgt   10   1389.226 ±    8.598  ns/op\nStringCopyBenchmarks.copy       UTF_8    LATIN   ACCESS  avgt   10    785.470 ±    9.697  ns/op\nStringCopyBenchmarks.copy       UTF_8    LATIN  DECODER  avgt   10  17651.234 ±  330.039  ns/op\nStringCopyBenchmarks.copy       UTF_8  UNICODE   DIRECT  avgt   10  21820.418 ±  215.847  ns/op\nStringCopyBenchmarks.copy       UTF_8  UNICODE   MANUAL  avgt   10  21606.666 ±  157.715  ns/op\nStringCopyBenchmarks.copy       UTF_8  UNICODE   ACCESS  avgt   10  21123.624 ±  127.108  ns/op\nStringCopyBenchmarks.copy       UTF_8  UNICODE  DECODER  avgt   10  33920.903 ±  376.154  ns/op\nStringCopyBenchmarks.copy      UTF_16    LATIN   DIRECT  avgt   10  24348.418 ±  183.817  ns/op\nStringCopyBenchmarks.copy      UTF_16    LATIN   MANUAL  avgt   10  23652.288 ±  240.414  ns/op\nStringCopyBenchmarks.copy      UTF_16    LATIN   ACCESS  avgt   10  13712.874 ±  190.302  ns/op\nStringCopyBenchmarks.copy      UTF_16    LATIN  DECODER  avgt   10  22275.605 ±  183.684  ns/op\nStringCopyBenchmarks.copy      UTF_16  UNICODE   DIRECT  avgt   10  23932.042 ±  206.099  ns/op\nStringCopyBenchmarks.copy      UTF_16  UNICODE   MANUAL  avgt   10  23405.118 ±  152.797  ns/op\nStringCopyBenchmarks.copy      UTF_16  UNICODE   ACCESS  avgt   10  14862.416 ± 1116.815  ns/op\nStringCopyBenchmarks.copy      UTF_16  UNICODE  DECODER  avgt   10  23542.508 ±  907.461  ns/op\nStringCopyBenchmarks.copy      UTF_32    LATIN   DIRECT  avgt   10  37363.304 ±  450.561  ns/op\nStringCopyBenchmarks.copy      UTF_32    LATIN   MANUAL  avgt   10  35796.480 ±  277.327  ns/op\nStringCopyBenchmarks.copy      UTF_32    LATIN   ACCESS  avgt   10  37132.546 ±  526.457  ns/op\nStringCopyBenchmarks.copy      UTF_32    LATIN  DECODER  avgt   10  28896.369 ±  102.584  ns/op\nStringCopyBenchmarks.copy      UTF_32  UNICODE   DIRECT  avgt   10  37690.552 ±  338.005  ns/op\nStringCopyBenchmarks.copy      UTF_32  UNICODE   MANUAL  avgt   10  36168.799 ±  288.271  ns/op\nStringCopyBenchmarks.copy      UTF_32  UNICODE   ACCESS  avgt   10  36136.715 ±  437.596  ns/op\nStringCopyBenchmarks.copy      UTF_32  UNICODE  DECODER  avgt   10  29133.853 ±  255.594  ns/op\n</code></pre>\n<h4>Chart</h4>\n<p><a href=\"https://i.sstatic.net/TVbYXPJj.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/TVbYXPJj.png\" alt=\"PNG of bar chart visually showing results.\" /></a></p>\n<p>Keep in mind the US-ASCII and ISO-8859-1 with Unicode text benchmarks are likely invalid. All the Unicode characters were replaced when allocating the <code>MemorySegment</code>, making the copy no different than with Latin text.</p>\n<h2>Source Code</h2>\n<p><strong>StringCopy.java</strong></p>\n<p>The different approaches used to extract strings out of a <code>MemorySegment</code> into a <code>String</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport java.lang.foreign.MemorySegment;\nimport java.lang.foreign.ValueLayout;\nimport java.nio.charset.CharacterCodingException;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport jdk.internal.access.JavaLangAccess;\nimport jdk.internal.access.SharedSecrets;\n\npublic sealed interface StringCopy {\n\n  String copy(MemorySegment segment, Charset charset);\n\n  private static int nullCharLength(Charset charset) {\n    if (charset == StandardCharsets.UTF_32) return 4;\n    else if (charset == StandardCharsets.UTF_16) return 2;\n    else return 1;\n  }\n\n  final class Direct implements StringCopy {\n\n    @Override\n    public String copy(MemorySegment segment, Charset charset) {\n      return segment.getString(0L, charset);\n    }\n  }\n\n  final class Manual implements StringCopy {\n\n    @Override\n    public String copy(MemorySegment segment, Charset charset) {\n      int length = (int) (segment.byteSize() - nullCharLength(charset));\n\n      byte[] bytes = new byte[length];\n      MemorySegment.copy(segment, ValueLayout.JAVA_BYTE, 0L, bytes, 0, length);\n      return new String(bytes, charset);\n    }\n  }\n\n  final class Access implements StringCopy {\n\n    private static final JavaLangAccess JLA = SharedSecrets.getJavaLangAccess();\n\n    @Override\n    public String copy(MemorySegment segment, Charset charset) {\n      int length = (int) (segment.byteSize() - nullCharLength(charset));\n\n      byte[] bytes = new byte[length];\n      MemorySegment.copy(segment, ValueLayout.JAVA_BYTE, 0L, bytes, 0, length);\n      try {\n        return JLA.newStringNoRepl(bytes, charset);\n      } catch (CharacterCodingException ex) {\n        throw new RuntimeException(ex);\n      }\n    }\n  }\n\n  final class Decoder implements StringCopy {\n\n    @Override\n    public String copy(MemorySegment segment, Charset charset) {\n      var buffer = segment.asByteBuffer();\n      buffer.limit(buffer.limit() - nullCharLength(charset));\n\n      return charset.decode(buffer).toString();\n    }\n  }\n}\n</code></pre>\n<p><strong>StringCopyBenchmarks.java</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport java.lang.foreign.Arena;\nimport java.lang.foreign.MemorySegment;\nimport java.nio.charset.Charset;\nimport java.nio.charset.StandardCharsets;\nimport java.util.concurrent.TimeUnit;\nimport org.openjdk.jmh.annotations.Benchmark;\nimport org.openjdk.jmh.annotations.BenchmarkMode;\nimport org.openjdk.jmh.annotations.Fork;\nimport org.openjdk.jmh.annotations.Measurement;\nimport org.openjdk.jmh.annotations.Mode;\nimport org.openjdk.jmh.annotations.OutputTimeUnit;\nimport org.openjdk.jmh.annotations.Param;\nimport org.openjdk.jmh.annotations.Scope;\nimport org.openjdk.jmh.annotations.Setup;\nimport org.openjdk.jmh.annotations.State;\nimport org.openjdk.jmh.annotations.TearDown;\n\n@Fork(1)\n@BenchmarkMode(Mode.AverageTime)\n@OutputTimeUnit(TimeUnit.NANOSECONDS)\n@Measurement(iterations = 10, time = 15, timeUnit = TimeUnit.SECONDS)\n@State(Scope.Benchmark)\npublic class StringCopyBenchmarks {\n\n  @Param private Encoding encoding;\n  @Param private Type type;\n  @Param private Text text;\n  private StringCopy strcpy;\n\n  private Arena arena;\n  private MemorySegment segment;\n\n  @Setup\n  public void setup() {\n    strcpy = type.createStringCopyInstance();\n    arena = Arena.ofConfined();\n    segment = arena.allocateFrom(text.text(), encoding.charset());\n  }\n\n  @TearDown\n  public void tearDown() {\n    arena.close();\n  }\n\n  @Benchmark\n  public String copy() {\n    return strcpy.copy(segment, encoding.charset());\n  }\n\n  public enum Type {\n    DIRECT(StringCopy.Direct.class),\n    MANUAL(StringCopy.Manual.class),\n    ACCESS(StringCopy.Access.class),\n    DECODER(StringCopy.Decoder.class);\n\n    private final Class&lt;? extends StringCopy&gt; cls;\n\n    Type(Class&lt;? extends StringCopy&gt; cls) {\n      this.cls = cls;\n    }\n\n    StringCopy createStringCopyInstance() {\n      try {\n        return cls.getConstructor().newInstance();\n      } catch (ReflectiveOperationException ex) {\n        throw new RuntimeException(ex);\n      }\n    }\n  }\n\n  public enum Encoding {\n    US_ASCII(StandardCharsets.US_ASCII),\n    ISO_8859_1(StandardCharsets.ISO_8859_1),\n    UTF_8(StandardCharsets.UTF_8),\n    UTF_16(StandardCharsets.UTF_16),\n    UTF_32(StandardCharsets.UTF_32);\n\n    private final Charset charset;\n\n    Encoding(Charset charset) {\n      this.charset = charset;\n    }\n\n    Charset charset() {\n      return charset;\n    }\n  }\n\n  public enum Text {\n    LATIN(TestStrings.LATIN_TEXT),\n    UNICODE(TestStrings.UNICODE_TEXT);\n\n    private final String text;\n\n    Text(String text) {\n      this.text = text;\n    }\n\n    String text() {\n      return text;\n    }\n  }\n}\n</code></pre>\n<p><strong>TestStrings.java</strong></p>\n<p>The strings used in the benchmarks.</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\npublic interface TestStrings {\n\n  String LATIN_TEXT =\n      &quot;&quot;&quot;\n      Lorem ipsum dolor sit amet, consectetur adipiscing elit. Maecenas lacus quam,\n      dignissim eget massa vel, gravida condimentum ante. Donec pharetra vulputate\n      neque. Integer consequat urna ut faucibus lobortis. Proin mi sapien, ornare at\n      tempus eu, semper vitae ipsum. Aliquam rhoncus sem in sagittis eleifend.\n      Suspendisse elementum augue quis consectetur cursus. Ut ut tincidunt turpis, a\n      sodales enim. Pellentesque quis elementum sapien, commodo commodo odio. Nunc\n      venenatis ut risus vitae consequat. Donec ultrices, ligula et euismod posuere,\n      est orci volutpat massa, sed venenatis arcu mauris in felis. Vestibulum\n      ullamcorper, metus in sagittis semper, est ipsum eleifend nisl, eu ultrices\n      diam quam commodo leo. Suspendisse accumsan urna quis enim pretium rhoncus.\n      Morbi posuere semper malesuada. Nulla id congue odio. Aliquam finibus nunc\n      augue, rutrum vehicula dolor cursus eu.\n\n      Suspendisse luctus ullamcorper bibendum. Donec ornare nibh ut nisl ultricies\n      cursus. Aliquam eu dolor eleifend, euismod augue sed, luctus neque. Maecenas\n      sit amet convallis sapien. Proin maximus malesuada dignissim. Quisque quam\n      nisl, vulputate sed ligula et, vestibulum lobortis dui. Vestibulum maximus,\n      nunc vitae condimentum dictum, nulla arcu tempor diam, a semper dui elit sit\n      amet purus.\n\n      In dictum, augue vitae fermentum sodales, leo massa convallis nulla, nec\n      commodo tellus arcu in est. Vivamus commodo tempor pulvinar. Maecenas in libero\n      et justo consequat interdum. Pellentesque nulla velit, ultrices non velit non,\n      congue rutrum augue. Lorem ipsum dolor sit amet, consectetur adipiscing elit.\n      Mauris molestie nisl tortor, et elementum erat semper eget. Aliquam tincidunt\n      rutrum erat.\n\n      Sed volutpat ultrices diam nec aliquam. Nulla ut libero malesuada, viverra\n      nulla nec, efficitur ligula. Aenean sit amet ipsum et leo hendrerit posuere.\n      Donec et placerat est. Nulla facilisi. Curabitur molestie neque condimentum\n      ligula porttitor maximus. Vivamus sed mollis ex, vitae finibus dui. Sed felis\n      nisi, sollicitudin ut molestie ut, aliquam quis eros. Vestibulum volutpat odio\n      eget urna tincidunt, quis eleifend ex gravida. Aliquam erat volutpat. Etiam et\n      commodo arcu. Donec vel nibh nec sem lacinia sodales. Curabitur interdum dolor\n      quis scelerisque pretium. Proin posuere id dolor eu suscipit.\n\n      Morbi a maximus sapien. Ut ultrices, ipsum et gravida mollis, felis urna\n      tincidunt ipsum, ut varius ante ipsum non enim. Cras a ligula lorem. Nulla\n      egestas orci vel ullamcorper tincidunt. Aliquam vitae nunc nunc. Donec eget\n      risus sed odio varius consectetur. Morbi vitae ipsum dignissim, sagittis ipsum\n      vitae, venenatis magna.\n\n      Ut dolor erat, rutrum vitae nibh non, auctor mattis est. Nunc euismod gravida\n      erat nec finibus. Curabitur consequat tristique neque accumsan ornare.\n      Suspendisse potenti. Integer pellentesque pellentesque facilisis. Integer\n      tortor lectus, convallis eget ornare id, pretium vitae lacus. Quisque quis nisi\n      vel dui sagittis fringilla non quis purus. Phasellus non consectetur nisi.\n      Fusce faucibus tortor in purus volutpat mattis et id est.\n\n      Nunc finibus porttitor orci ut malesuada. Nam ut massa eget nisi lobortis\n      commodo non ut erat. Vestibulum in nulla ullamcorper, laoreet arcu non, porta\n      dolor. Donec nec tellus nec mauris pellentesque laoreet. Etiam porta quis nisi\n      non congue. Duis ut ex sit amet risus vestibulum tempor ut a est. In id enim\n      nec tellus volutpat ullamcorper at a turpis. Mauris id felis enim. Maecenas\n      interdum eget augue egestas laoreet. Nunc bibendum et enim nec fringilla.\n      Maecenas at odio et mi bibendum ullamcorper non id elit. Suspendisse potenti.\n      Suspendisse in libero gravida, convallis magna ac, consectetur ipsum. Aenean\n      nec suscipit odio. Nulla nisl odio, mattis nec placerat ut, fermentum non\n      lorem. Suspendisse commodo cursus nunc, eget rutrum quam viverra a.\n\n      Vivamus iaculis consequat eros tempor lacinia. Integer condimentum laoreet quam\n      vitae blandit. Nulla egestas in nulla non tincidunt. In imperdiet dui quis\n      euismod fringilla. Praesent ac turpis euismod, bibendum diam vel, condimentum\n      tellus. Aliquam nulla enim, ornare et imperdiet at, rutrum a enim. Suspendisse\n      nibh nisl, congue ac augue sit amet, tempus mattis dolor. Integer in urna leo.\n      Donec convallis justo varius, faucibus tellus sit amet, laoreet leo. Quisque\n      semper dolor felis, molestie auctor lectus egestas eu. Nulla vel augue a nibh\n      congue vestibulum vel vel massa. Ut quam metus, vestibulum sed accumsan quis,\n      porttitor a elit. Curabitur neque leo, venenatis ac varius at, blandit id\n      justo. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per\n      inceptos himenaeos. Duis gravida fringilla turpis, at fringilla erat fringilla\n      eu. Proin risus ipsum, vestibulum pharetra tortor nec, aliquet rutrum risus.\n\n      Nulla orci sem, auctor in augue euismod, porttitor imperdiet tellus. In hac\n      habitasse platea dictumst. Phasellus dapibus imperdiet urna, id convallis dui.\n      Quisque sed nulla mattis, tempor mauris sit amet, dictum mauris. Aenean sem\n      tortor, ullamcorper eu tristique ultricies, imperdiet eu ipsum. Quisque in nisi\n      auctor metus ultrices pulvinar in ut neque. Duis nisl felis, mollis nec nibh\n      id, convallis vulputate tortor. Sed nec magna nibh. Nunc risus tortor,\n      consectetur in justo non, fermentum mollis odio. Pellentesque habitant morbi\n      tristique senectus et netus et malesuada fames ac turpis egestas. Etiam\n      pharetra et erat eu consequat. Duis tristique hendrerit dolor vitae eleifend.\n      Donec nec orci rhoncus, luctus orci at, interdum metus. Sed dictum ante velit,\n      ac venenatis ligula sodales vehicula.\n\n      Morbi tincidunt diam vitae ligula tincidunt porta nec nec mauris. Pellentesque\n      in massa in turpis iaculis fringilla in eget ante. Morbi eget ex ut tellus\n      volutpat pretium nec ut arcu. Morbi dictum laoreet sem. Nulla id massa\n      porttitor, fermentum eros ac, venenatis augue. Mauris a sollicitudin augue.\n      Praesent hendrerit nunc metus, ac dictum magna rhoncus non. Lorem ipsum dolor\n      sit amet, consectetur adipiscing elit. Ut eleifend neque porta urna interdum,\n      non ullamcorper erat faucibus. Quisque hendrerit ipsum felis, pretium aliquam\n      ante varius vel. Donec volutpat scelerisque eros, id condimentum elit lacinia\n      ac. Nullam sollicitudin, nunc nec pharetra feugiat, justo purus dignissim dui,\n      in hendrerit erat nibh eget elit. Donec sit amet maximus tortor, sit amet\n      laoreet nisl.\n\n      Praesent sit amet dapibus magna. Donec mattis arcu a magna condimentum, nec\n      congue arcu luctus. Phasellus placerat magna sed libero accumsan, ac tincidunt\n      libero gravida. Nam a magna sit amet sem congue varius. Proin velit lectus,\n      blandit commodo enim in, pulvinar laoreet sem. Etiam in ipsum vitae enim\n      maximus rutrum. Nulla mattis, arcu at semper suscipit, nisl est viverra magna,\n      sit amet blandit diam tellus eget purus. Nulla commodo sem luctus semper\n      viverra. Aenean lobortis porta lorem quis euismod. Aenean egestas a est quis\n      ullamcorper. Maecenas laoreet ipsum quis dolor rhoncus iaculis. Donec et\n      facilisis ligula, ut vestibulum felis. Fusce massa urna, rhoncus nec pretium\n      mattis, aliquet ac enim.\n\n      Vestibulum tempor molestie erat sed egestas. Etiam suscipit enim quis augue\n      bibendum auctor. Nunc urna dui, porttitor sed urna sed, porta fringilla lorem.\n      Etiam sollicitudin, lacus vel varius condimentum, neque orci tempus urna, id\n      eleifend justo sem et metus. Nam commodo.\n      &quot;&quot;&quot;;\n\n  // taken from https://www.w3.org/2001/06/utf-8-test/UTF-8-demo.html\n  String UNICODE_TEXT =\n      &quot;&quot;&quot;\n      Original by Markus Kuhn, adapted for HTML by Martin Dürst.\n\n      UTF-8 encoded sample plain-text file\n      ‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾\n\n      Markus Kuhn [ˈmaʳkʊs kuːn] &lt;mkuhn@acm.org&gt; — 1999-08-20\n\n\n      The ASCII compatible UTF-8 encoding of ISO 10646 and Unicode\n      plain-text files is defined in RFC 2279 and in ISO 10646-1 Annex R.\n\n\n      Using Unicode/UTF-8, you can write in emails and source code things such as\n\n      Mathematics and Sciences:\n\n        ∮ E⋅da = Q,  n → ∞, ∑ f(i) = ∏ g(i), ∀x∈ℝ: ⌈x⌉ = −⌊−x⌋, α ∧ ¬β = ¬(¬α ∨ β),\n\n        ℕ ⊆ ℕ₀ ⊂ ℤ ⊂ ℚ ⊂ ℝ ⊂ ℂ, ⊥ &lt; a ≠ b ≡ c ≤ d ≪ ⊤ ⇒ (A ⇔ B),\n\n        2H₂ + O₂ ⇌ 2H₂O, R = 4.7 kΩ, ⌀ 200 mm\n\n      Linguistics and dictionaries:\n\n        ði ıntəˈnæʃənəl fəˈnɛtık əsoʊsiˈeıʃn\n        Y [ˈʏpsilɔn], Yen [jɛn], Yoga [ˈjoːgɑ]\n\n      APL:\n\n        ((V⍳V)=⍳⍴V)/V←,V    ⌷←⍳→⍴∆∇⊃‾⍎⍕⌈\n\n      Nicer typography in plain text files:\n\n        ╔══════════════════════════════════════════╗\n        ║                                          ║\n        ║   • ‘single’ and “double” quotes         ║\n        ║                                          ║\n        ║   • Curly apostrophes: “We’ve been here” ║\n        ║                                          ║\n        ║   • Latin-1 apostrophe and accents: '´`  ║\n        ║                                          ║\n        ║   • ‚deutsche‘ „Anführungszeichen“       ║\n        ║                                          ║\n        ║   • †, ‡, ‰, •, 3–4, —, −5/+5, ™, …      ║\n        ║                                          ║\n        ║   • ASCII safety test: 1lI|, 0OD, 8B     ║\n        ║                      ╭─────────╮         ║\n        ║   • the euro symbol: │ 14.95 € │         ║\n        ║                      ╰─────────╯         ║\n        ╚══════════════════════════════════════════╝\n\n      Greek (in Polytonic):\n\n        The Greek anthem:\n\n        Σὲ γνωρίζω ἀπὸ τὴν κόψη\n        τοῦ σπαθιοῦ τὴν τρομερή,\n        σὲ γνωρίζω ἀπὸ τὴν ὄψη\n        ποὺ μὲ βία μετράει τὴ γῆ.\n\n        ᾿Απ᾿ τὰ κόκκαλα βγαλμένη\n        τῶν ῾Ελλήνων τὰ ἱερά\n        καὶ σὰν πρῶτα ἀνδρειωμένη\n        χαῖρε, ὦ χαῖρε, ᾿Ελευθεριά!\n\n        From a speech of Demosthenes in the 4th century BC:\n\n        Οὐχὶ ταὐτὰ παρίσταταί μοι γιγνώσκειν, ὦ ἄνδρες ᾿Αθηναῖοι,\n        ὅταν τ᾿ εἰς τὰ πράγματα ἀποβλέψω καὶ ὅταν πρὸς τοὺς\n        λόγους οὓς ἀκούω· τοὺς μὲν γὰρ λόγους περὶ τοῦ\n        τιμωρήσασθαι Φίλιππον ὁρῶ γιγνομένους, τὰ δὲ πράγματ᾿\n        εἰς τοῦτο προήκοντα,  ὥσθ᾿ ὅπως μὴ πεισόμεθ᾿ αὐτοὶ\n        πρότερον κακῶς σκέψασθαι δέον. οὐδέν οὖν ἄλλο μοι δοκοῦσιν\n        οἱ τὰ τοιαῦτα λέγοντες ἢ τὴν ὑπόθεσιν, περὶ ἧς βουλεύεσθαι,\n        οὐχὶ τὴν οὖσαν παριστάντες ὑμῖν ἁμαρτάνειν. ἐγὼ δέ, ὅτι μέν\n        ποτ᾿ ἐξῆν τῇ πόλει καὶ τὰ αὑτῆς ἔχειν ἀσφαλῶς καὶ Φίλιππον\n        τιμωρήσασθαι, καὶ μάλ᾿ ἀκριβῶς οἶδα· ἐπ᾿ ἐμοῦ γάρ, οὐ πάλαι\n        γέγονεν ταῦτ᾿ ἀμφότερα· νῦν μέντοι πέπεισμαι τοῦθ᾿ ἱκανὸν\n        προλαβεῖν ἡμῖν εἶναι τὴν πρώτην, ὅπως τοὺς συμμάχους\n        σώσομεν. ἐὰν γὰρ τοῦτο βεβαίως ὑπάρξῃ, τότε καὶ περὶ τοῦ\n        τίνα τιμωρήσεταί τις καὶ ὃν τρόπον ἐξέσται σκοπεῖν· πρὶν δὲ\n        τὴν ἀρχὴν ὀρθῶς ὑποθέσθαι, μάταιον ἡγοῦμαι περὶ τῆς\n        τελευτῆς ὁντινοῦν ποιεῖσθαι λόγον.\n\n        Δημοσθένους, Γ´ ᾿Ολυνθιακὸς\n\n      Georgian:\n\n        From a Unicode conference invitation:\n\n        გთხოვთ ახლავე გაიაროთ რეგისტრაცია Unicode-ის მეათე საერთაშორისო\n        კონფერენციაზე დასასწრებად, რომელიც გაიმართება 10-12 მარტს,\n        ქ. მაინცში, გერმანიაში. კონფერენცია შეჰკრებს ერთად მსოფლიოს\n        ექსპერტებს ისეთ დარგებში როგორიცაა ინტერნეტი და Unicode-ი,\n        ინტერნაციონალიზაცია და ლოკალიზაცია, Unicode-ის გამოყენება\n        ოპერაციულ სისტემებსა, და გამოყენებით პროგრამებში, შრიფტებში,\n        ტექსტების დამუშავებასა და მრავალენოვან კომპიუტერულ სისტემებში.\n\n      Russian:\n\n        From a Unicode conference invitation:\n\n        Зарегистрируйтесь сейчас на Десятую Международную Конференцию по\n        Unicode, которая состоится 10-12 марта 1997 года в Майнце в Германии.\n        Конференция соберет широкий круг экспертов по  вопросам глобального\n        Интернета и Unicode, локализации и интернационализации, воплощению и\n        применению Unicode в различных операционных системах и программных\n        приложениях, шрифтах, верстке и многоязычных компьютерных системах.\n\n      Thai (UCS Level 2):\n\n        Excerpt from a poetry on The Romance of The Three Kingdoms (a Chinese\n        classic 'San Gua'):\n\n        [----------------------------|------------------------]\n          ๏ แผ่นดินฮั่นเสื่อมโทรมแสนสังเวช  พระปกเกศกองบู๊กู้ขึ้นใหม่\n        สิบสองกษัตริย์ก่อนหน้าแลถัดไป       สององค์ไซร้โง่เขลาเบาปัญญา\n          ทรงนับถือขันทีเป็นที่พึ่ง           บ้านเมืองจึงวิปริตเป็นนักหนา\n        โฮจิ๋นเรียกทัพทั่วหัวเมืองมา         หมายจะฆ่ามดชั่วตัวสำคัญ\n          เหมือนขับไสไล่เสือจากเคหา      รับหมาป่าเข้ามาเลยอาสัญ\n        ฝ่ายอ้องอุ้นยุแยกให้แตกกัน          ใช้สาวนั้นเป็นชนวนชื่นชวนใจ\n          พลันลิฉุยกุยกีกลับก่อเหตุ          ช่างอาเพศจริงหนาฟ้าร้องไห้\n        ต้องรบราฆ่าฟันจนบรรลัย           ฤๅหาใครค้ำชูกู้บรรลังก์ ฯ\n\n        (The above is a two-column text. If combining characters are handled\n        correctly, the lines of the second column should be aligned with the\n        | character above.)\n\n      Ethiopian:\n\n        Proverbs in the Amharic language:\n\n        ሰማይ አይታረስ ንጉሥ አይከሰስ።\n        ብላ ካለኝ እንደአባቴ በቆመጠኝ።\n        ጌጥ ያለቤቱ ቁምጥና ነው።\n        ደሀ በሕልሙ ቅቤ ባይጠጣ ንጣት በገደለው።\n        የአፍ ወለምታ በቅቤ አይታሽም።\n        አይጥ በበላ ዳዋ ተመታ።\n        ሲተረጉሙ ይደረግሙ።\n        ቀስ በቀስ፥ ዕንቁላል በእግሩ ይሄዳል።\n        ድር ቢያብር አንበሳ ያስር።\n        ሰው እንደቤቱ እንጅ እንደ ጉረቤቱ አይተዳደርም።\n        እግዜር የከፈተውን ጉሮሮ ሳይዘጋው አይድርም።\n        የጎረቤት ሌባ፥ ቢያዩት ይስቅ ባያዩት ያጠልቅ።\n        ሥራ ከመፍታት ልጄን ላፋታት።\n        ዓባይ ማደሪያ የለው፥ ግንድ ይዞ ይዞራል።\n        የእስላም አገሩ መካ የአሞራ አገሩ ዋርካ።\n        ተንጋሎ ቢተፉ ተመልሶ ባፉ።\n        ወዳጅህ ማር ቢሆን ጨርስህ አትላሰው።\n        እግርህን በፍራሽህ ልክ ዘርጋ።\n\n      Runes:\n\n        ᚻᛖ ᚳᚹᚫᚦ ᚦᚫᛏ ᚻᛖ ᛒᚢᛞᛖ ᚩᚾ ᚦᚫᛗ ᛚᚪᚾᛞᛖ ᚾᚩᚱᚦᚹᛖᚪᚱᛞᚢᛗ ᚹᛁᚦ ᚦᚪ ᚹᛖᛥᚫ\n\n        (Old English, which transcribed into Latin reads 'He cwaeth that he\n        bude thaem lande northweardum with tha Westsae.' and means 'He said\n        that he lived in the northern land near the Western Sea.')\n\n      Braille:\n\n        ⡌⠁⠧⠑ ⠼⠁⠒  ⡍⠜⠇⠑⠹⠰⠎ ⡣⠕⠌\n\n        ⡍⠜⠇⠑⠹ ⠺⠁⠎ ⠙⠑⠁⠙⠒ ⠞⠕ ⠃⠑⠛⠔ ⠺⠊⠹⠲ ⡹⠻⠑ ⠊⠎ ⠝⠕ ⠙⠳⠃⠞\n        ⠱⠁⠞⠑⠧⠻ ⠁⠃⠳⠞ ⠹⠁⠞⠲ ⡹⠑ ⠗⠑⠛⠊⠌⠻ ⠕⠋ ⠙⠊⠎ ⠃⠥⠗⠊⠁⠇ ⠺⠁⠎\n        ⠎⠊⠛⠝⠫ ⠃⠹ ⠹⠑ ⠊⠇⠻⠛⠹⠍⠁⠝⠂ ⠹⠑ ⠊⠇⠻⠅⠂ ⠹⠑ ⠥⠝⠙⠻⠞⠁⠅⠻⠂\n        ⠁⠝⠙ ⠹⠑ ⠡⠊⠑⠋ ⠍⠳⠗⠝⠻⠲ ⡎⠊⠗⠕⠕⠛⠑ ⠎⠊⠛⠝⠫ ⠊⠞⠲ ⡁⠝⠙\n        ⡎⠊⠗⠕⠕⠛⠑⠰⠎ ⠝⠁⠍⠑ ⠺⠁⠎ ⠛⠕⠕⠙ ⠥⠏⠕⠝ ⠰⡡⠁⠝⠛⠑⠂ ⠋⠕⠗ ⠁⠝⠹⠹⠔⠛ ⠙⠑\n        ⠡⠕⠎⠑ ⠞⠕ ⠏⠥⠞ ⠙⠊⠎ ⠙⠁⠝⠙ ⠞⠕⠲\n\n        ⡕⠇⠙ ⡍⠜⠇⠑⠹ ⠺⠁⠎ ⠁⠎ ⠙⠑⠁⠙ ⠁⠎ ⠁ ⠙⠕⠕⠗⠤⠝⠁⠊⠇⠲\n\n        ⡍⠔⠙⠖ ⡊ ⠙⠕⠝⠰⠞ ⠍⠑⠁⠝ ⠞⠕ ⠎⠁⠹ ⠹⠁⠞ ⡊ ⠅⠝⠪⠂ ⠕⠋ ⠍⠹\n        ⠪⠝ ⠅⠝⠪⠇⠫⠛⠑⠂ ⠱⠁⠞ ⠹⠻⠑ ⠊⠎ ⠏⠜⠞⠊⠊⠥⠇⠜⠇⠹ ⠙⠑⠁⠙ ⠁⠃⠳⠞\n        ⠁ ⠙⠕⠕⠗⠤⠝⠁⠊⠇⠲ ⡊ ⠍⠊⠣⠞ ⠙⠁⠧⠑ ⠃⠑⠲ ⠔⠊⠇⠔⠫⠂ ⠍⠹⠎⠑⠇⠋⠂ ⠞⠕\n        ⠗⠑⠛⠜⠙ ⠁ ⠊⠕⠋⠋⠔⠤⠝⠁⠊⠇ ⠁⠎ ⠹⠑ ⠙⠑⠁⠙⠑⠌ ⠏⠊⠑⠊⠑ ⠕⠋ ⠊⠗⠕⠝⠍⠕⠝⠛⠻⠹\n        ⠔ ⠹⠑ ⠞⠗⠁⠙⠑⠲ ⡃⠥⠞ ⠹⠑ ⠺⠊⠎⠙⠕⠍ ⠕⠋ ⠳⠗ ⠁⠝⠊⠑⠌⠕⠗⠎\n        ⠊⠎ ⠔ ⠹⠑ ⠎⠊⠍⠊⠇⠑⠆ ⠁⠝⠙ ⠍⠹ ⠥⠝⠙⠁⠇⠇⠪⠫ ⠙⠁⠝⠙⠎\n        ⠩⠁⠇⠇ ⠝⠕⠞ ⠙⠊⠌⠥⠗⠃ ⠊⠞⠂ ⠕⠗ ⠹⠑ ⡊⠳⠝⠞⠗⠹⠰⠎ ⠙⠕⠝⠑ ⠋⠕⠗⠲ ⡹⠳\n        ⠺⠊⠇⠇ ⠹⠻⠑⠋⠕⠗⠑ ⠏⠻⠍⠊⠞ ⠍⠑ ⠞⠕ ⠗⠑⠏⠑⠁⠞⠂ ⠑⠍⠏⠙⠁⠞⠊⠊⠁⠇⠇⠹⠂ ⠹⠁⠞\n        ⡍⠜⠇⠑⠹ ⠺⠁⠎ ⠁⠎ ⠙⠑⠁⠙ ⠁⠎ ⠁ ⠙⠕⠕⠗⠤⠝⠁⠊⠇⠲\n\n        (The first couple of paragraphs of &quot;A Christmas Carol&quot; by Dickens)\n\n      Compact font selection example text:\n\n        ABCDEFGHIJKLMNOPQRSTUVWXYZ /0123456789\n        abcdefghijklmnopqrstuvwxyz £©µÀÆÖÞßéöÿ\n        –—‘“”„†•…‰™œŠŸž€ ΑΒΓΔΩαβγδω АБВГДабвгд\n        ∀∂∈ℝ∧∪≡∞ ↑↗↨↻⇣ ┐┼╔╘░►☺♀ ﬁ�⑀₂ἠḂӥẄɐː⍎אԱა\n\n      Greetings in various languages:\n\n        Hello world, Καλημέρα κόσμε, コンニチハ\n\n      Box drawing alignment tests:                                          █\n                                                                            ▉\n        ╔══╦══╗  ┌──┬──┐  ╭──┬──╮  ╭──┬──╮  ┏━━┳━━┓  ┎┒┏┑   ╷  ╻ ┏┯┓ ┌┰┐    ▊ ╱╲╱╲╳╳╳\n        ║┌─╨─┐║  │╔═╧═╗│  │╒═╪═╕│  │╓─╁─╖│  ┃┌─╂─┐┃  ┗╃╄┙  ╶┼╴╺╋╸┠┼┨ ┝╋┥    ▋ ╲╱╲╱╳╳╳\n        ║│╲ ╱│║  │║   ║│  ││ │ ││  │║ ┃ ║│  ┃│ ╿ │┃  ┍╅╆┓   ╵  ╹ ┗┷┛ └┸┘    ▌ ╱╲╱╲╳╳╳\n        ╠╡ ╳ ╞╣  ├╢   ╟┤  ├┼─┼─┼┤  ├╫─╂─╫┤  ┣┿╾┼╼┿┫  ┕┛┖┚     ┌┄┄┐ ╎ ┏┅┅┓ ┋ ▍ ╲╱╲╱╳╳╳\n        ║│╱ ╲│║  │║   ║│  ││ │ ││  │║ ┃ ║│  ┃│ ╽ │┃  ░░▒▒▓▓██ ┊  ┆ ╎ ╏  ┇ ┋ ▎\n        ║└─╥─┘║  │╚═╤═╝│  │╘═╪═╛│  │╙─╀─╜│  ┃└─╂─┘┃  ░░▒▒▓▓██ ┊  ┆ ╎ ╏  ┇ ┋ ▏\n        ╚══╩══╝  └──┴──┘  ╰──┴──╯  ╰──┴──╯  ┗━━┻━━┛           └╌╌┘ ╎ ┗╍╍┛ ┋  ▁▂▃▄▅▆▇█\n      &quot;&quot;&quot;;\n}\n</code></pre>\n",
    "score" : 5,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1752267032,
    "last_activity_date" : 1752376787,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140583173,
    "post_id" : 79697417,
    "body" : "@Slaw: further analysis of JMH results suggest it <i>is</i> optimized away magically for null-terminated strings, despite the source code, so there <i>is</i> something to be gained here and my deleted answer was wrong.",
    "score" : 0,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1752255574,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140583082,
    "post_id" : 79697417,
    "body" : "@VGR: That intermediate object would definitely cost the allocation we&#39;re hoping to avoid, and trying to beat HotSpot&#39;s UTF-8 conversion fast path performance is...impractical.  (I&#39;ve tried, several times.)  Any use of the <code>newDecoder</code> approach also loses that fast path, which tends to cost a lot of CPU time even if it saves the memory.  I&#39;d call that answer &quot;technically valid&quot; but it&#39;s not especially useful.",
    "score" : 0,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1752253548,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140582749,
    "post_id" : 79697417,
    "body" : "Would it be worth writing your own UTF-8 decoder and retrieving the bytes using <code>MemorySegment.get(ValueLayout.JAVA_BYTE, i)</code>?  Though there’s no avoiding the use of an intermediate CharBuffer, StringBuilder, or char array…",
    "score" : 0,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44991,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1752245045,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581179,
    "post_id" : 79697417,
    "body" : "(just noticed you found the same thing regarding <code>MemorySegment::getString</code> in your deleted answer)",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1752190993,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581170,
    "post_id" : 79697417,
    "body" : "From looking at the <a href=\"https://github.com/openjdk/jdk/blob/ee0d309bbd33302d8c6f35155e975db77aaea785/src/java.base/share/classes/jdk/internal/foreign/StringSupport.java#L52\" rel=\"nofollow noreferrer\">source code</a>, even <code>MemorySegment::getString</code> ultimately copies the segment into a byte array and then calls the string constructor. Also, the decoder approach might actually be less efficient due to an intermediate <code>char[]</code> (internal to the <code>CharBuffer</code>), but not sure.",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1752190317,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140580621,
    "post_id" : 79697417,
    "body" : "Maybe <code>String s = StandardCharsets.UTF_8.newDecoder().decode(segment.asByteBuf&zwnj;&#8203;fer()).toString();</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1752170948,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79698821" : [ {
      "comment_id" : 140591745,
      "post_id" : 79698821,
      "body" : "That issue looks like it&#39;d only benefit zero-terminated strings, FWIW.",
      "score" : 0,
      "owner" : {
        "account_id" : 465573,
        "reputation" : 200423,
        "user_id" : 869736,
        "user_type" : "registered",
        "accept_rate" : 82,
        "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Louis Wasserman",
        "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
      },
      "creation_date" : 1752600399,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140589328,
      "post_id" : 79698821,
      "body" : "It looks like they <a href=\"https://bugs.openjdk.org/browse/JDK-8313238\" rel=\"nofollow noreferrer\">want to improve the current <code>getString</code> performance</a> by using vectors. But that will have to wait until <code>jdk.incubator.vector</code> is no longer incubating, which won&#39;t be promoted to a preview feature until the &quot;<i>necessary features of Project Valhalla become available</i>&quot; (see <a href=\"https://openjdk.org/jeps/508\" rel=\"nofollow noreferrer\">JEP 508</a>).",
      "score" : 0,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49904,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1752527467,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140589297,
      "post_id" : 79698821,
      "body" : "I agree, <code>StringSupport</code> should probably use <code>JavaLangAccess</code> in this case. At least for a known set of encodings. It could fall back to <code>new String(...)</code> if and when a <code>CharacterCodingException</code> is thrown. That will slow things down when there&#39;s errors in the string, but that &quot;should be&quot; the uncommon path. Could maybe introduce a way to disable using <code>JavaLangAccess</code> if a project finds it to be generally detrimental. Also, I think <code>MemorySegment</code> should add a <code>getString</code> overload that takes a length for when the length (in bytes) is known ahead of time.",
      "score" : 1,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49904,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1752526451,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140588974,
      "post_id" : 79698821,
      "body" : "Thank you for the exceptionally thorough answer.  I think this is the best that&#39;s plausible today, though I definitely get the impression the JDK could do better.  (In particular, the <code>StringSupport</code> already has a <code>JavaLangAccess</code> and could use it...)",
      "score" : 0,
      "owner" : {
        "account_id" : 465573,
        "reputation" : 200423,
        "user_id" : 869736,
        "user_type" : "registered",
        "accept_rate" : 82,
        "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Louis Wasserman",
        "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
      },
      "creation_date" : 1752517976,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}