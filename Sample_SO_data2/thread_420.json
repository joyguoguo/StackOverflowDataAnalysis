{
  "question" : {
    "question_id" : 79811184,
    "title" : "How to implement post remove behavior on a JoinTable using EclipseLink jpa?",
    "body" : "<p>Having unidirectional <code>ManyToMany</code> mapping in an entity called <code>A</code> to entity called <code>B</code> on field called <code>files</code>:</p>\n<pre><code>@ManyToMany(fetch = FetchType.LAZY)\n@JoinTable(name = JOIN_TABLE_NAME)\nprivate List&lt;B&gt; files = new ArrayList&lt;&gt;();\n</code></pre>\n<p>, which creates a join table with ids of each entity as composite primary key.</p>\n<p>Automatically, when an item is removed from files list and A entity is saved, a row is also removed from join table.</p>\n<p>I would like to implement this behavior:</p>\n<p>Whenever a row is removed from this join table, check if there are no more rows with B-id as removed row B-id, if so, remove rows from B table matching that B-id.</p>\n<p>There might be several ways to implement this. Some of which i have tought, but are unsatisfactory or do not work:</p>\n<p>Create join table as separate entity and add a post remove method. However this method is not called:</p>\n<pre><code>@Entity\n@PrimaryKeyJoinColumns(\n    @PrimaryKeyJoinColumn(name = &quot;a_id&quot;),\n    @PrimaryKeyJoinColumn(name = &quot;b_id&quot;)\n)\n@Table(name = JOIN_TABLE_NAME)\npublic class ABjoinTable {\n    \n    @EmbeddedId\n    private ABId abid;\n    \n    @Embeddable\n    public static final class ABId {\n    \n        @Column(name = &quot;a_id);\n        public long aid;\n    \n        @Column(name = &quot;b_id);\n        public long bid;\n    }\n    \n    @PostRemove\n    public void removeDanglingFiles() {\n            // not called\n    }\n}\n</code></pre>\n<p>Create a remove trigger on join table, however <code>B</code> entity has\n<code>PostRemove</code> method already implemented, which in this solution will\nnot be called (trigger is on db level).</p>\n<p>Use <code>PostUpdate</code> method on <code>A</code> entity and remove dangling rows manually, however rows are not yet removed from join table in post update context:</p>\n<pre><code>@PostLoad\npublic void createFilesSnapshot() {\n    filesSnapshot = new ArrayList&lt;&gt;(this.files);\n}\n\n@PostUpdate\npublic void removeDanglingFiles() {\n    // if there are no more references to other Bids, delete that B\n    val removed = filesSnapshot.stream()\n            .filter(b -&gt; !this.files.contains(b))\n            .map(PersistentObject::getId)\n            .collect(Collectors.toSet());\n    try (val em = JPAutil.getEntityManager()) {\n        val tx = em.getTransaction();\n        tx.begin();\n        for (val rId : removed) {\n            val q = em.createQuery(&quot;SELECT a&quot; +\n                    &quot; FROM A a JOIN a.files b&quot; +\n                    &quot; WHERE b.id = :bId&quot;, B.class);\n            q.setParameter(&quot;bId&quot;, rId);\n            val result = q.getResultList();\n            if (result.size() == 0) { // at this point in post load, join table row is not yet removed, so size is &gt;= 1\n                em.remove(...);\n            }\n        }\n        tx.commit();\n    } catch (final Exception e) {\n    }\n}\n</code></pre>\n<p>Using EclipseLink jpa provider and MySql db.</p>\n",
    "tags" : [ "java", "jpa" ],
    "owner" : {
      "account_id" : 14571259,
      "reputation" : 1186,
      "user_id" : 10524503,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TTMbFydM2wc/AAAAAAAAAAI/AAAAAAAAIbU/tMY5KezwBbg/s256-rj/photo.jpg",
      "display_name" : "MarekChr",
      "link" : "https://stackoverflow.com/users/10524503/marekchr"
    },
    "is_answered" : true,
    "view_count" : 70,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762522252,
    "creation_date" : 1762426709,
    "link" : "https://stackoverflow.com/questions/79811184/how-to-implement-post-remove-behavior-on-a-jointable-using-eclipselink-jpa",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79811371,
    "question_id" : 79811184,
    "body" : "<p>You can solve this by doing the cleanup <strong>after the transaction is flushed</strong>, i.e. using a <strong><code>@TransactionalEventListener</code></strong> or a <strong><code>SessionEventListener</code></strong> (if using EclipseLink-specific APIs).<br />\nAlternatively, you can hook into your service layer logic, which is the most straightforward and JPA-compliant solution.</p>\n<h4>Option 1) Handle it in your service layer (recommended)</h4>\n<p>Instead of relying on entity callbacks, handle the cleanup explicitly after saving <code>A</code>:</p>\n<pre><code>@Transactional\npublic void saveA(A a) {\n    // Snapshot before save (to know what was removed)\n    List&lt;B&gt; oldFiles = repository.findById(a.getId())\n                                 .map(A::getFiles)\n                                 .orElse(Collections.emptyList());\n\n    repository.save(a); // triggers join table updates\n\n    // Flush to ensure join table rows are removed\n    entityManager.flush();\n\n    // Check which Bs were removed\n    Set&lt;Long&gt; removedIds = oldFiles.stream()\n            .filter(b -&gt; !a.getFiles().contains(b))\n            .map(B::getId)\n            .collect(Collectors.toSet());\n\n    // Delete Bs no longer referenced\n    for (Long bId : removedIds) {\n        Long count = entityManager.createQuery(\n            &quot;SELECT COUNT(a) FROM A a JOIN a.files b WHERE b.id = :bId&quot;, Long.class)\n            .setParameter(&quot;bId&quot;, bId)\n            .getSingleResult();\n\n        if (count == 0) {\n            B b = entityManager.find(B.class, bId);\n            entityManager.remove(b);\n        }\n    }\n}\n</code></pre>\n<p>This approach:</p>\n<ul>\n<li><p>Guarantees the join table is already synchronized (<code>flush()</code>).</p>\n</li>\n<li><p>Keeps the logic in your domain/service layer instead of relying on low-level callbacks.</p>\n</li>\n<li><p>Works with any JPA provider (EclipseLink, Hibernate, etc.).</p>\n</li>\n</ul>\n<hr />\n<h4>Option 2) Use EclipseLink session events (provider-specific)</h4>\n<p>EclipseLink exposes a lower-level <code>SessionEventAdapter</code> you can register to catch <strong>post-commit or post-delete</strong> events at the session level:</p>\n<pre><code>public class CleanupListener extends SessionEventAdapter {\n    @Override\n    public void postCommitUnitOfWork(SessionEvent event) {\n        EntityManager em = (EntityManager) event.getResult();\n        // Perform the same orphan check logic here\n    }\n}\n</code></pre>\n<p>You’d register this via <code>persistence.xml</code> or <code>SessionCustomizer</code>.<br />\nThis gives you “after commit” behavior without polluting your entity model.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 30281557,
      "reputation" : 147,
      "user_id" : 23206601,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dad884861a2495bc4f846faf227b5026?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Bazzas",
      "link" : "https://stackoverflow.com/users/23206601/bazzas"
    },
    "creation_date" : 1762438246,
    "last_activity_date" : 1762438246,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79811371" : [ {
      "comment_id" : 140841741,
      "post_id" : 79811371,
      "body" : "I tried option 1. and it works! I have a follow up question - having debug breakpoint at that count query and looking in database - join table row is still there. Does flush() method just, in this case, remove that row in some abstract way inside jpa logic, not physically removing it from database yet, since it is inside same transaction?",
      "score" : 0,
      "owner" : {
        "account_id" : 14571259,
        "reputation" : 1186,
        "user_id" : 10524503,
        "user_type" : "registered",
        "profile_image" : "https://lh4.googleusercontent.com/-TTMbFydM2wc/AAAAAAAAAAI/AAAAAAAAIbU/tMY5KezwBbg/s256-rj/photo.jpg",
        "display_name" : "MarekChr",
        "link" : "https://stackoverflow.com/users/10524503/marekchr"
      },
      "creation_date" : 1762516497,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}