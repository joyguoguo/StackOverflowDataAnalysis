{
  "question" : {
    "question_id" : 79672179,
    "title" : "Running helidon-mp application gives IncompatibleClassChangeError",
    "body" : "<p>I need to upgrade our application from Helidon 3.0.2 to Helidon 3.2.12, but running gives this error:</p>\n<pre><code>[INFO] 2025-06-17 13:24:37,043 [main] org.jboss.weld.Bootstrap - WELD-ENV-002001: Weld SE container 144ebd95-bb80-4310-98e2-a1d4f9ebd02e shut down\nException in thread &quot;main&quot; jakarta.enterprise.inject.CreationException\n    at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n        ...\n    at io.helidon.microprofile.cdi.HelidonContainerImpl.doStart(HelidonContainerImpl.java:340)\n    at io.helidon.common.context.Contexts.runInContext(Contexts.java:137)\n    at io.helidon.microprofile.cdi.HelidonContainerImpl.start(HelidonContainerImpl.java:250)\n    at io.helidon.microprofile.cdi.Main.main(Main.java:80)\nCaused by: java.lang.IncompatibleClassChangeError: Method 'package02.MyID package02.MyID.valueOf(java.lang.String)' must be InterfaceMethodref constant\n    at package01.MyFactory.&lt;init&gt;(MyFactory.java:55)\n    at java.base/jdk.internal.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n        ...\n    at org.jboss.weld.injection.ConstructorInjectionPoint.newInstance(ConstructorInjectionPoint.java:119)\n    ... 68 more\n</code></pre>\n<p>The library classes (separated jar file):</p>\n<pre><code>package package02;\n\npublic class MyID extends AbstractID implements ID {\n \n    protected MyID(final Builder builder) {\n        super(builder);\n    }\n\n    public static MyID valueOf(final String ocid) {\n        return (MyID) new Builder(id).accept(&lt;key&gt;, &lt;value&gt;).build();\n    }\n}\n\npackage package02.internal;\n\npublic abstract class AbstractID implements ID {\n \n    protected AbstractID(final Builder builder) {\n        //...\n    }\n \n    public static class Builder {\n        \n        public Builder(final String id) {\n            //...\n        }\n    }\n}\n</code></pre>\n<p>The implementation of the application:</p>\n<pre><code>package package01;\n\nimport io.helidon.config.Config;\nimport jakarta.enterprise.context.ApplicationScoped;\nimport jakarta.inject.Inject;\n\n@ApplicationScoped\npublic class MyFactory {\n\n    @Inject\n    public MyFactory(final Config config) {\n        this. = MyID.valueOf(loadProperty(config, &lt;key&gt;)); // this is the problematic line\n    }\n\n    private String loadProperty(final Config config, final String key) {\n        //...\n    }\n}\n</code></pre>\n<p>All classes are freshly compiled. Running on Java 17.</p>\n<p>Could someone give me a hint what to do?</p>\n<p>Thanks</p>\n",
    "tags" : [ "java", "helidon" ],
    "owner" : {
      "account_id" : 2514821,
      "reputation" : 449,
      "user_id" : 2186495,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/a9caeb0de28072254fbe7ed9eb721557?s=256&d=identicon&r=PG",
      "display_name" : "Pat",
      "link" : "https://stackoverflow.com/users/2186495/pat"
    },
    "is_answered" : false,
    "view_count" : 41,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1750341845,
    "creation_date" : 1750341229,
    "link" : "https://stackoverflow.com/questions/79672179/running-helidon-mp-application-gives-incompatibleclasschangeerror",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140563255,
    "post_id" : 79672179,
    "body" : "Glad you found it. And just to be clear, Helidon <i>does not</i> change app byte code.",
    "score" : 0,
    "owner" : {
      "account_id" : 16909678,
      "reputation" : 241,
      "user_id" : 12229062,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mC54WmzNSsmFEnyPInhIMbiIjLg_hFFdDKR8pOQ=k-s256",
      "display_name" : "Tim Quinn",
      "link" : "https://stackoverflow.com/users/12229062/tim-quinn"
    },
    "creation_date" : 1751572367,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140538395,
    "post_id" : 79672179,
    "body" : "Solved: there was another implementation (interface) in different library, I&#39;ve missed it ... damn :-|",
    "score" : 0,
    "owner" : {
      "account_id" : 2514821,
      "reputation" : 449,
      "user_id" : 2186495,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/a9caeb0de28072254fbe7ed9eb721557?s=256&d=identicon&r=PG",
      "display_name" : "Pat",
      "link" : "https://stackoverflow.com/users/2186495/pat"
    },
    "creation_date" : 1750772230,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140538098,
    "post_id" : 79672179,
    "body" : "Hi, the application doesn&#39;t use bytecode modification tools itself ... I expect the helidon is using some bytecode modification tool (javassist). The I&#39;m not able to provide small example will not be so small :-( I&#39;m not able to provide such example in a short time :-(",
    "score" : 0,
    "owner" : {
      "account_id" : 2514821,
      "reputation" : 449,
      "user_id" : 2186495,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/a9caeb0de28072254fbe7ed9eb721557?s=256&d=identicon&r=PG",
      "display_name" : "Pat",
      "link" : "https://stackoverflow.com/users/2186495/pat"
    },
    "creation_date" : 1750766547,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529916,
    "post_id" : 79672179,
    "body" : "Oh boy, I see the comment now about the problematic line. Apologies.   That&#39;s an intriguing exception you uncovered. Why would the bytecode for the class be weird? I&#39;m not a Weld expert, but AFAIK Weld uses byte code <i>scanning</i> to look at the app code and maybe byte code <i>generation</i> to create proxies, but I&#39;m not aware of it <i>changing</i> byte code of app classes.  Is there anything involved in your app that might be changing your byte code? Any Java agents running, for example?   I&#39;ll renew my plea for a simple reproducer you can share that shows this.",
    "score" : 0,
    "owner" : {
      "account_id" : 16909678,
      "reputation" : 241,
      "user_id" : 12229062,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mC54WmzNSsmFEnyPInhIMbiIjLg_hFFdDKR8pOQ=k-s256",
      "display_name" : "Tim Quinn",
      "link" : "https://stackoverflow.com/users/12229062/tim-quinn"
    },
    "creation_date" : 1750431618,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529636,
    "post_id" : 79672179,
    "body" : "I&#39;ve just omit the imports. The line 55 is marked in the code by comment &quot;this is the problematic line&quot;. I&#39;m debugging the code and find out that original cause is swallowed :-| The original exception is &quot;IncompatibleClassChangeError: Inconsistent constant pool data in classfile for class package02/MyID. Method &#39;void &lt;init&gt;(package02/internal/AbstractID$Builder)&#39; at index 54 is CONSTANT_MethodRef and should be CONSTANT_InterfaceMethodRef&quot;.",
    "score" : 0,
    "owner" : {
      "account_id" : 2514821,
      "reputation" : 449,
      "user_id" : 2186495,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/a9caeb0de28072254fbe7ed9eb721557?s=256&d=identicon&r=PG",
      "display_name" : "Pat",
      "link" : "https://stackoverflow.com/users/2186495/pat"
    },
    "creation_date" : 1750426041,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529528,
    "post_id" : 79672179,
    "body" : "I know Weld has significant logging capabilities but I&#39;m not sure whether that would show anything helpful related to this.  In your <code>package01</code> I don&#39;t see an <code>import</code> of <code>package02.MyID</code>. Did you just omit it from your snippet? (I&#39;m not necessarily saying that&#39;s the problem; just thinking out loud a bit.)   And which line in <code>MyFactory</code> is 55 that&#39;s mentioned in the exception?  If you can share a small but complete, self-contained reproducer project that shows this problem that would help.",
    "score" : 0,
    "owner" : {
      "account_id" : 16909678,
      "reputation" : 241,
      "user_id" : 12229062,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mC54WmzNSsmFEnyPInhIMbiIjLg_hFFdDKR8pOQ=k-s256",
      "display_name" : "Tim Quinn",
      "link" : "https://stackoverflow.com/users/12229062/tim-quinn"
    },
    "creation_date" : 1750423299,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528819,
    "post_id" : 79672179,
    "body" : "Yes, all mentioned classes are compiled with same Java version. I&#39;ve also checked the dependencies and there&#39;s not older version of the library classes.",
    "score" : 0,
    "owner" : {
      "account_id" : 2514821,
      "reputation" : 449,
      "user_id" : 2186495,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/a9caeb0de28072254fbe7ed9eb721557?s=256&d=identicon&r=PG",
      "display_name" : "Pat",
      "link" : "https://stackoverflow.com/users/2186495/pat"
    },
    "creation_date" : 1750406341,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140527957,
    "post_id" : 79672179,
    "body" : "Have not seen that before!  My quick web searching suggests that you might be using libraries that were compiled against an earlier, incompatible API vs. what&#39;s on the app&#39;s class path  at runtime now.   When you said all classes are freshly compiled does that include the two libraries you mentioned?  <code>mvn dependency:tree</code> might show that different versions of one or more libraries are present.",
    "score" : 0,
    "owner" : {
      "account_id" : 16909678,
      "reputation" : 241,
      "user_id" : 12229062,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mC54WmzNSsmFEnyPInhIMbiIjLg_hFFdDKR8pOQ=k-s256",
      "display_name" : "Tim Quinn",
      "link" : "https://stackoverflow.com/users/12229062/tim-quinn"
    },
    "creation_date" : 1750366204,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}