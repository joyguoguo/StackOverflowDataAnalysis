{
  "question" : {
    "question_id" : 79783467,
    "title" : "wiremock AutoConfigureWireMock HttpHostConnectException: Connection refused",
    "body" : "<pre><code>@ActiveProfiles(&quot;it&quot;)\n@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)\n@ContextConfiguration(classes = ServiceApplication.class)\n@AutoConfigureWireMock(port = 0)\n@TestPropertySource(properties = {\n        &quot;server.servlet.context-path=http://localhost:${wiremock.server.port}/abc&quot;\n})\npublic class ABCTest {\n\n    \n    @Autowired\n    protected TestRestTemplate restTemplate;\n\n    private static final String INIT_URL = &quot;/init&quot;;\n\n    private static final String JSON_RESPONSE = &quot;&quot;&quot;\n            {&quot;result&quot;:...\n            &quot;generatedAt&quot;:&quot;2025-10-06T06:46:28.745Z&quot;}\n    &quot;&quot;&quot;;\n\n    @BeforeClass\n    public void beforeClass() {\n    }\n\n    @Test\n    public void init() throws IOException {\n\n\n        stubFor(get(urlEqualTo(&quot;/abc&quot; + INIT_URL))\n                .willReturn(aResponse()\n                        .withStatus(status)\n                        .withHeader(&quot;Content-Type&quot;, &quot;application/json&quot;)\n                        .withBody(JSON_RESPONSE)));\n\n        HttpHeaders headers = new HttpHeaders();\n        headers.setAccept(Collections.singletonList(MediaType.APPLICATION_JSON));\n        headers.add(&quot;X-API-KEY&quot;, apiKey);\n        HttpEntity&lt;String&gt; entity = new HttpEntity&lt;&gt;(&quot;body&quot;, headers);\n        ResponseEntity&lt;String&gt; response = restTemplate.exchange(INIT_URL, HttpMethod.GET, entity, String.class);\n\n        System.out.println(response.getBody());\n       \n    }\n</code></pre>\n<p>I received this:</p>\n<pre><code>wiremock.org.apache.hc.client5.http.HttpHostConnectException: Connect to http://localhost:8080 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused\n\n    at java.base/sun.nio.ch.Net.pollConnect(Native Method)\n    at java.base/sun.nio.ch.Net.pollConnectNow(Net.java:682)\n    at java.base/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:549)\n    at java.base/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:592)\n    at java.base/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327)\n    at java.base/java.net.Socket.connect(Socket.java:751)\n    at wiremock.org.apache.hc.client5.http.socket.PlainConnectionSocketFactory$1.run(PlainConnectionSocketFactory.java:87)\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:571)\n</code></pre>\n<p>i used <code>spring-cloud-contract-wiremock-4.3.0.jar</code> and <code>spring-boot-test-3.5.4.jar</code></p>\n",
    "tags" : [ "java", "spring-boot", "junit", "spring-test", "wiremock" ],
    "owner" : {
      "account_id" : 2990507,
      "reputation" : 5179,
      "user_id" : 2538180,
      "user_type" : "registered",
      "accept_rate" : 53,
      "profile_image" : "https://www.gravatar.com/avatar/93be29c31504e7b76f60064d2fe28e2f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "emoleumassi",
      "link" : "https://stackoverflow.com/users/2538180/emoleumassi"
    },
    "is_answered" : true,
    "view_count" : 121,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1759831151,
    "creation_date" : 1759739020,
    "link" : "https://stackoverflow.com/questions/79783467/wiremock-autoconfigurewiremock-httphostconnectexception-connection-refused",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79784423,
    "question_id" : 79783467,
    "body" : "<p>as M. Deinum pointed out, the <code>server.servlet.context-path</code> property is weird.</p>\n<p><strong>Just remove the <code>@TestPropertySource</code>  annotation from your test class</strong>.</p>\n<p>For more information, see my explanation below. Also, if the issue persists, please provide us more details regarding your project, like Java version, settings for the <code>&quot;it&quot;</code> Profile, and so on.</p>\n<p>I tried to reproduce your project as close as I can, here are <strong>my versions &amp; dependencies</strong>:</p>\n<ul>\n<li><p>Java version: <code>JDK17</code></p>\n</li>\n<li><p>Spring Boot: <code>3.5.4</code></p>\n</li>\n<li><p>Spring Cloud: <code>2024.0.1</code></p>\n</li>\n<li><p>My dependencies: <code>spring-boot-starter-web</code>, <code>spring-boot-starter-test</code> (test scope), <code>spring-cloud-starter-contract-stub-runner</code> (test scope), <code>wiremock-jre8-standalone</code> (test scope)</p>\n</li>\n</ul>\n<hr />\n<p>Just removing the <code>@TestPropertySource</code> annotation with the <code>server.servlet.context-path</code> property:</p>\n<pre><code>@ActiveProfiles(&quot;it&quot;)\n@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)\n@ContextConfiguration(classes = ServiceApplication.class)\n@AutoConfigureWireMock(port = 0)\npublic class ABCTest {\n   // ...\n}\n</code></pre>\n<p>Made my test green:</p>\n<pre><code>mvn test -Dtest=ABCTest\n\n# ...\n2025-10-07T11:45:34.345+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] is already running at http port [10435] / https port [12650]\n2025-10-07T11:45:34.345+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] is already running at http port [10435] / https port [12650]. It has [1] mappings registered\n2025-10-07T11:45:34.802+02:00  INFO 41774 --- [spring-wiremock-demo-it] [o-auto-1-exec-1] o.a.c.c.C.[Tomcat].[localhost].[/]       : Initializing Spring DispatcherServlet 'dispatcherServlet'\n2025-10-07T11:45:34.802+02:00  INFO 41774 --- [spring-wiremock-demo-it] [o-auto-1-exec-1] o.s.web.servlet.DispatcherServlet        : Initializing Servlet 'dispatcherServlet'\n2025-10-07T11:45:34.803+02:00  INFO 41774 --- [spring-wiremock-demo-it] [o-auto-1-exec-1] o.s.web.servlet.DispatcherServlet        : Completed initialization in 1 ms\n{&quot;timestamp&quot;:&quot;2025-10-07T09:45:34.825+00:00&quot;,&quot;status&quot;:404,&quot;error&quot;:&quot;Not Found&quot;,&quot;path&quot;:&quot;/init&quot;}\n2025-10-07T11:45:34.855+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.w.WireMockTestExecutionListener  : WireMockConfiguration is missing [false]\n2025-10-07T11:45:34.861+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.w.WireMockTestExecutionListener  : WireMockConfiguration is missing [false]\n2025-10-07T11:45:34.861+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.w.WireMockTestExecutionListener  : Http port [10435] dynamic [true] https port [12650] dynamic [true]\n2025-10-07T11:45:34.861+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.w.WireMockTestExecutionListener  : Resetting mappings for the next test to restart them. That's necessary when reusing the same context with new servers running on random ports\n2025-10-07T11:45:34.861+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Stopping server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] at port [12650]\n2025-10-07T11:45:34.865+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Stopped WireMock [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] instance port [12650]\n2025-10-07T11:45:34.869+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] is already running at http port [10435] / https port [12650]. It has [2] mappings registered\n2025-10-07T11:45:34.869+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Started server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] at http port [10435] and https port [12650]\n2025-10-07T11:45:34.869+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : WireMock server has [2] stubs registered\n2025-10-07T11:45:34.870+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Will register [0] stub locations\n2025-10-07T11:45:34.871+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : WireMock server has [1] stubs registered\n2025-10-07T11:45:34.871+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] o.s.c.c.wiremock.WireMockConfiguration   : Server [com.github.tomakehurst.wiremock.WireMockServer@68479e8b] is already running at http port [10435] / https port [12650]. It has [1] mappings registered\n2025-10-07T11:45:34.873+02:00 DEBUG 41774 --- [spring-wiremock-demo-it] [           main] .StubRunnerWireMockTestExecutionListener : No @AutoConfigureStubRunner annotation found on [class com.example.springwiremock.integration.ABCTest]. Skipping\n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0, Time elapsed: 2.053 s -- in com.example.springwiremock.integration.ABCTest\n[INFO] \n[INFO] Results:\n[INFO] \n[INFO] Tests run: 1, Failures: 0, Errors: 0, Skipped: 0\n[INFO] \n[INFO] ------------------------------------------------------------------------\n[INFO] BUILD SUCCESS\n[INFO] ------------------------------------------------------------------------\n[INFO] Total time:  5.146 s\n[INFO] Finished at: 2025-10-07T11:45:35+02:00\n[INFO] ------------------------------------------------------------------------\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 30203153,
      "reputation" : 582,
      "user_id" : 23146886,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e3c4e0cc1f6a6d4956e63a0779338b48?s=256&d=identicon&r=PG",
      "display_name" : "Tamas Csizmadia",
      "link" : "https://stackoverflow.com/users/23146886/tamas-csizmadia"
    },
    "creation_date" : 1759831151,
    "last_activity_date" : 1759831151,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140779746,
    "post_id" : 79783467,
    "body" : "Your configuration is weird. Why the <code>server.servlet.context-path</code>? That doesn&#39;t make sense.",
    "score" : 2,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1759760818,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}