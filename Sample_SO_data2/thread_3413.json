{
  "question" : {
    "question_id" : 79553113,
    "title" : "NoResourceFoundException in Spring Boot Oauth flow after spring boot 3 upgrade",
    "body" : "<p>I've recently upgraded spring boot from 2.x.x version to 3.3.3 and spring security v.6.4.3 and faced an issue when calling my <code>/api/v1/authentication/login</code> endpoint. When the user is authenticated with oauth2 and should be redirected to the endpoint, a NoResourceFoundException is thrown. For some reason DispatcherServlet is classyfing the request as a request for a static resource, instead of a dynamic endpoint. I'm attaching related logs below.</p>\n<p>This endpoint is oauth protected and defined as</p>\n<pre><code>@Slf4j\n@Validated\n@RestController\n@Tag(name = &quot;Authentication&quot;)\n@RequestMapping(&quot;/api/v1/authentication&quot;)\npublic class AuthenticationControllerBase {\n\n    protected final UserService userService;\n    private final ObjectMapper objectMapper;\n\n    public AuthenticationControllerBase(UserService userService, ObjectMapper objectMapper) {\n        log.info(&quot;Initializing AuthenticationControllerBase&quot;);\n        this.userService = userService;\n        this.objectMapper = objectMapper;\n    }\n\n    @PostMapping(value = &quot;/login&quot;)\n    public LoginResponse login(@AuthenticationPrincipal OidcUser principal) throws StatusManagementException {\n        String email = principal.getUserInfo().getEmail();\n        email = EmailUtil.normalizeEmail(email);\n        User user = userService.getUser(email);\n        return user.getRole() == UserRole.APPLICATION_ADMIN\n                ? userService.loginWithLock(email)\n                : userService.loginWithoutLock(email);\n    }\n}\n</code></pre>\n<p>My Security configuration is</p>\n<pre><code>package com.kyc.service.config;\n\nimport jakarta.servlet.http.HttpServletRequest;\nimport jakarta.servlet.http.HttpServletResponse;\nimport lombok.RequiredArgsConstructor;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.context.annotation.Profile;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.session.SessionAuthenticationStrategy;\nimport org.springframework.security.web.session.InvalidSessionStrategy;\nimport org.springframework.security.web.session.SessionInformationExpiredEvent;\nimport org.springframework.security.web.session.SessionInformationExpiredStrategy;\nimport org.springframework.security.web.util.matcher.AntPathRequestMatcher;\n\nimport java.io.IOException;\n\n\n@Slf4j\n@Configuration\n@Profile({&quot;pl-demo&quot;, &quot;pl-stage&quot;})\n@RequiredArgsConstructor\n@EnableWebSecurity\npublic class OIDCSecurityConfigurationPl {\n\n    @Value(&quot;${service.configuration.oidc.auth-redirection-uri}&quot;)\n    private String authorizeRedirectionURI;\n    @Value(&quot;${service.configuration.oidc.logout-redirection-url}&quot;)\n    private String logoutRedirectionURL;\n    @Value(&quot;${service.configuration.oidc.logout-uri}&quot;)\n    private String logoutURI;\n\n    private final SessionAuthenticationStrategy sessionAuthenticationStrategy;\n\n    @Bean\n    protected SecurityFilterChain configure(HttpSecurity http) {\n\n        try {\n            http.csrf(AbstractHttpConfigurer::disable);\n            http.cors(AbstractHttpConfigurer::disable);\n            http.authorizeHttpRequests(authorizeRequests -&gt; authorizeRequests.requestMatchers(&quot;/&quot;, &quot;/error&quot;, &quot;/actuator/health&quot;,\n                            &quot;/oauth2/authorization/**&quot;, &quot;/api/v1/identity-verification/webhook&quot;,\n                            &quot;/api/v1/engagements/*/export/*/pdf&quot;)\n                    .permitAll()\n                    .anyRequest()\n                    .authenticated());\n            setupOauth(http);\n            http.sessionManagement(sess -&gt; sess.sessionAuthenticationStrategy(sessionAuthenticationStrategy)\n                    .requireExplicitAuthenticationStrategy(false)\n                    .invalidSessionStrategy(new KYCSessionExpirationStrategy()).maximumSessions(1));\n            http.logout(logout -&gt; logout.logoutRequestMatcher(new AntPathRequestMatcher(logoutURI))\n                    .invalidateHttpSession(true)\n                    .logoutSuccessUrl(logoutRedirectionURL));\n            return http.build();\n        } catch (Exception e) {\n            log.error(&quot;Exception in OIDC configuration&quot;, e);\n            throw new SecurityException(e);\n        }\n    }\n\n    private void setupOauth(HttpSecurity http) {\n        try {\n            http.oauth2Login(oauth -&gt; oauth.redirectionEndpoint(redir -&gt; redir.baseUri(authorizeRedirectionURI)));\n        } catch (Exception e) {\n            log.error(&quot;oauth2Login:: Exception in oauth2Login configuration&quot;, e);\n        }\n    }\n\n    private static class KYCSessionExpirationStrategy implements SessionInformationExpiredStrategy, InvalidSessionStrategy {\n\n        @Override\n        public void onExpiredSessionDetected(SessionInformationExpiredEvent sessionInformationExpiredEvent)\n                throws IOException {\n            sessionInformationExpiredEvent.getResponse().sendError(HttpServletResponse.SC_UNAUTHORIZED);\n        }\n\n        @Override\n        public void onInvalidSessionDetected(HttpServletRequest httpServletRequest,\n                                             HttpServletResponse httpServletResponse)\n                throws IOException {\n            log.info(&quot;invalid session...&quot;);\n            httpServletResponse.sendError(HttpServletResponse.SC_UNAUTHORIZED);\n        }\n    }\n}\n</code></pre>\n<pre><code>2025-04-03 15:36:00 \norg.springframework.web.servlet.resource.NoResourceFoundException: No static resource api/v1/authentication/login.\n2025-04-03 15:36:00 \n2025-04-03 13:36:00.546 ERROR 31 ---    34 [  XNIO-1 task-2] c.p.k.s.a.e.GlobalExceptionHandler       : Internal server error \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.546 DEBUG 31 ---    34 [  XNIO-1 task-2] .m.m.a.ExceptionHandlerExceptionResolver : Using @ExceptionHandler com.pwc.kyc.service.api.exception.GlobalExceptionHandler#handleAll(Exception) \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.545 DEBUG 31 ---    34 [  XNIO-1 task-2] o.s.w.s.r.ResourceHttpRequestHandler     : Resource not found \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.542 DEBUG 31 ---    34 [  XNIO-1 task-2] o.s.w.s.h.SimpleUrlHandlerMapping        : Mapped to ResourceHttpRequestHandler [classpath [META-INF&amp;#x2F;resources&amp;#x2F;], classpath [resources&amp;#x2F;], classpath [static&amp;#x2F;], classpath [public&amp;#x2F;], ServletContext [&amp;#x2F;]] \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.541 DEBUG 31 ---    34 [  XNIO-1 task-2] o.s.w.s.DispatcherServlet                : POST &amp;quot;&amp;#x2F;stage&amp;#x2F;api&amp;#x2F;v1&amp;#x2F;authentication&amp;#x2F;login&amp;#x2F;&amp;quot;, parameters={} \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.540 DEBUG 31 ---    34 [  XNIO-1 task-2] c.p.k.s.c.f.ConcurrentAdminSessionFilter : All sessions det size: 1 \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.540 DEBUG 31 ---    34 [  XNIO-1 task-2] c.p.k.s.c.f.ConcurrentAdminSessionFilter : All principals size: 1 \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.531 DEBUG 31 ---    34 [  XNIO-1 task-2] tor$SharedEntityManagerInvocationHandler : Creating new EntityManager for shared EntityManager invocation \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.529 DEBUG 31 ---    34 [  XNIO-1 task-2] o.s.s.w.FilterChainProxy                 : Secured POST &amp;#x2F;api&amp;#x2F;v1&amp;#x2F;authentication&amp;#x2F;login&amp;#x2F; \n2025-04-03 15:36:00 \n2025-04-03 13:36:00.528 DEBUG 31 ---    34 [  XNIO-1 task-2] w.c.HttpSessionSecurityContextRepository : Retrieved SecurityContextImpl [Authentication=OAuth2AuthenticationToken [PROTECTED]]\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "spring-security", "oauth-2.0" ],
    "owner" : {
      "account_id" : 10728310,
      "reputation" : 63,
      "user_id" : 7895169,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/34097a63cc9df667268944f18eacbb9a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "KonradK",
      "link" : "https://stackoverflow.com/users/7895169/konradk"
    },
    "is_answered" : false,
    "view_count" : 96,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743687657,
    "creation_date" : 1743687657,
    "link" : "https://stackoverflow.com/questions/79553113/noresourcefoundexception-in-spring-boot-oauth-flow-after-spring-boot-3-upgrade",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}