{
  "question" : {
    "question_id" : 79717119,
    "title" : "I have an encrypted text from Java&#39;s Bouncy Castle Library using AES/GCM which I am unable to decrypt using C# Bouncy Castle library AES/GCM",
    "body" : "<p>I have a text which I am encrypting using Java's Bouncy Castle AES/GCM utility.</p>\n<pre><code>package com.stackoflow.symmetric_token_decryptor;\n    \nimport static org.apache.commons.codec.binary.Hex.encodeHex;\n\nimport java.nio.charset.StandardCharsets;\nimport java.security.Key;\nimport java.security.NoSuchAlgorithmException;\n\nimport javax.crypto.KeyGenerator;\n\nimport org.bouncycastle.util.encoders.Base64;\nimport org.springframework.security.crypto.encrypt.BouncyCastleAesGcmBytesEncryptor;\nimport org.springframework.security.crypto.encrypt.BytesEncryptor;\n\npublic class App \n{\n    public static void main( String[] args ) throws Exception\n    {\n        String generatedKey = generateSymmetricKey();\n        \n        System.out.println(&quot;generatedKey = &quot; + generatedKey);\n        \n        String encryptedToken = encrypt(&quot;abc&quot;, generatedKey);\n        \n        System.out.println(&quot;encryptedToken = &quot; + encryptedToken);\n        \n        String plainToken = decryptToken(encryptedToken, generatedKey);\n        \n        System.out.println(plainToken);\n    }\n\n    private static String generateSymmetricKey() throws NoSuchAlgorithmException {\n\n            KeyGenerator keyGen = KeyGenerator.getInstance(&quot;AES&quot;);\n            keyGen.init(256);\n            Key key = keyGen.generateKey();\n\n            return new String(encodeHex(key.getEncoded()));\n        }\n    \n    private static String encrypt(String text, String secretKey) {\n        BytesEncryptor encryptor = new BouncyCastleAesGcmBytesEncryptor(&quot;&quot;, secretKey);\n        return new String(Base64.encode(encryptor.encrypt(text.getBytes())), StandardCharsets.UTF_8);\n    }\n}\n</code></pre>\n<p>Output:</p>\n<pre><code>generatedKey = e4deeabbdfbf504f5a980bb7e4ae6b8e9cb8896cd5e64692e162a9691449c196\nencryptedToken = 52nvbvyz2mEYBIb+grW5SNXplUufgeTtlVVOVOmhqRFvmeg=\n</code></pre>\n<p>Spring Framework's Bouncy Castle AES/GCM utility uses 16 byte IV by default.</p>\n<p>pom.xml:</p>\n<pre><code>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;com.stackoflow&lt;/groupId&gt;\n    &lt;artifactId&gt;symmetric-token-decryptor&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;packaging&gt;jar&lt;/packaging&gt;\n    &lt;name&gt;symmetric-token-decryptor&lt;/name&gt;\n    &lt;url&gt;http://maven.apache.org&lt;/url&gt;\n    &lt;properties&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n        &lt;java.version&gt;17&lt;/java.version&gt;\n        &lt;maven.compiler.source&gt;${java.version}&lt;/maven.compiler.source&gt;\n        &lt;maven.compiler.target&gt;${java.version}&lt;/maven.compiler.target&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-crypto&lt;/artifactId&gt;\n            &lt;version&gt;5.8.10&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;\n            &lt;artifactId&gt;bcprov-jdk18on&lt;/artifactId&gt;\n            &lt;version&gt;1.80&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;commons-codec&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;\n            &lt;version&gt;1.18.0&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n&lt;/project&gt;\n</code></pre>\n<p>I have to decrypt the cipher text in C# (.NET Core 3.1), for which I am using the below code:</p>\n<pre><code>using Org.BouncyCastle.Crypto.Engines;\nusing Org.BouncyCastle.Crypto.Modes;\nusing Org.BouncyCastle.Crypto.Parameters;\nusing System;\nusing System.Linq;\nusing System.Security.Cryptography;\nusing System.Text;\n\nnamespace Symmetric_Decryption_AES_GCM_C_ {\n\nclass Program\n{\n    static void Main(string[] args)\n    {\n        String encryptedToken = &quot;52nvbvyz2mEYBIb+grW5SNXplUufgeTtlVVOVOmhqRFvmeg=&quot;;\n\n        String secretKey = &quot;e4deeabbdfbf504f5a980bb7e4ae6b8e9cb8896cd5e64692e162a9691449c196&quot;;\n\n        Console.WriteLine(DecryptPayload(encryptedToken, secretKey));\n    }\n\n    private static string DecryptPayload(string base64EncryptedToken, string stringKey)\n    {\n        Console.WriteLine(&quot;----C# Decryption Details----&quot;);\n        byte[] encryptedToken = Convert.FromBase64String(base64EncryptedToken); // Converting the base64 string encrypted text to byte[]\n\n        byte[] key = Enumerable.Range(0, stringKey.Length / 2)\n           .Select(i =&gt; Convert.ToByte(stringKey.Substring(i * 2, 2), 16))\n           .ToArray(); // Converting hex encoded key to byte[]\n\n        int ivLength = 16;\n        int ciphertextTagLength = encryptedToken.Length - ivLength;\n\n        byte[] iv = new byte[ivLength];\n        byte[] ciphertextTag = new byte[ciphertextTagLength];\n\n        Buffer.BlockCopy(encryptedToken, 0, iv, 0, ivLength);\n        Buffer.BlockCopy(encryptedToken, ivLength, ciphertextTag, 0, ciphertextTagLength);\n\n        return DecryptWithGCM(ciphertextTag, key, iv);\n    }\n\n    private static string DecryptWithGCM(byte[] ciphertextTag, byte[] key, byte[] nonce)\n    {\n        var cipher = new GcmBlockCipher(new AesEngine());\n        cipher.Init(false, new AeadParameters(new KeyParameter(key), 128, nonce, null));\n\n        int outputSizeDecryptedData = cipher.GetOutputSize(ciphertextTag.Length);\n\n        byte[] decryptedBytes = new byte[outputSizeDecryptedData];\n\n        int processedBytes = cipher.ProcessBytes(ciphertextTag, 0, ciphertextTag.Length, decryptedBytes, 0);\n\n        cipher.DoFinal(decryptedBytes, processedBytes);\n\n        return Encoding.UTF8.GetString(decryptedBytes);\n    }\n}\n}\n</code></pre>\n<p>This decryption code works fine if I am encrypting/decrypting a text in C#, hence the code is working.\nBut when I am giving the encrypted text generated from Java code then I am getting</p>\n<blockquote>\n<p>mac check failed in GCM</p>\n</blockquote>\n<p>Also, the Java code works fine as well if I am encrypting/decrypting only in Java</p>\n",
    "tags" : [ "java", "c#", "spring", "bouncycastle", "aes-gcm" ],
    "owner" : {
      "account_id" : 12945841,
      "reputation" : 434,
      "user_id" : 9360232,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ashtrix-001",
      "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "is_answered" : true,
    "view_count" : 245,
    "answer_count" : 1,
    "score" : 3,
    "last_activity_date" : 1762801703,
    "creation_date" : 1753695074,
    "link" : "https://stackoverflow.com/questions/79717119/i-have-an-encrypted-text-from-javas-bouncy-castle-library-using-aes-gcm-which-i",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79717239,
    "question_id" : 79717119,
    "body" : "<p>As noted in my comment, <code>BouncyCastleAesGcmBytesEncryptor</code> implicitly performs a key derivation.</p>\n<p>The Java implementation can be found e.g. <a href=\"https://github.com/spring-projects/spring-security/blob/bf877a986410216bbf3f29118455f05fad2873a3/crypto/src/main/java/org/springframework/security/crypto/encrypt/BouncyCastleAesBytesEncryptor.java#L43\" rel=\"nofollow noreferrer\">here</a> (<code>BouncyCastleAesBytesEncryptor</code> is the base class of <code>BouncyCastleAesGcmBytesEncryptor</code>). This key derivation is to be ported to C#/BouncyCastle, e.g:</p>\n<pre class=\"lang-cs prettyprint-override\"><code>using System.Text;\nusing Org.BouncyCastle.Crypto;\nusing Org.BouncyCastle.Crypto.Engines;\nusing Org.BouncyCastle.Crypto.Generators;\nusing Org.BouncyCastle.Crypto.Modes;\nusing Org.BouncyCastle.Crypto.Parameters;\n...\nstring stringKey = &quot;e4deeabbdfbf504f5a980bb7e4ae6b8e9cb8896cd5e64692e162a9691449c196&quot;;\nstring ivCiphertextTag = &quot;52nvbvyz2mEYBIb+grW5SNXplUufgeTtlVVOVOmhqRFvmeg=&quot;; \n\nPbeParametersGenerator keyGenerator = new Pkcs5S2ParametersGenerator();\nbyte[] pkcs12PasswordBytes = PbeParametersGenerator.Pkcs5PasswordToUtf8Bytes(String.Empty);\nkeyGenerator.Init(pkcs12PasswordBytes, Convert.FromHexString(stringKey), 1024);\nKeyParameter secretKey = (KeyParameter)keyGenerator.GenerateDerivedParameters(&quot;AES&quot;, 256);\nbyte[] data = Decrypt(secretKey.GetKey(), ivCiphertextTag, null);\n\nConsole.WriteLine(Encoding.UTF8.GetString(data)); // abc\n\n// from https://stackoverflow.com/a/79262242/9014097, but with a 16 bytes nonce size\npublic static byte[] Decrypt(byte[] key, string nonceCiphertextTagBase64, byte[] aad)\n{\n    int nonceSize = 16;\n    byte[] nonceCiphertextTag = Convert.FromBase64String(nonceCiphertextTagBase64);\n    byte[] nonce = nonceCiphertextTag[..nonceSize];\n    byte[] ciphertextTag = nonceCiphertextTag[nonceSize..];\n\n    GcmBlockCipher gcmBlockCipher = new GcmBlockCipher(new AesEngine());\n    gcmBlockCipher.Init(false, new AeadParameters(new KeyParameter(key), 128, nonce, aad));\n    int outputSizeDecryptedData = gcmBlockCipher.GetOutputSize(ciphertextTag.Length);\n    byte[] decryptedData = new byte[outputSizeDecryptedData];\n    int processedBytes = gcmBlockCipher.ProcessBytes(ciphertextTag, 0, ciphertextTag.Length, decryptedData, 0);\n    gcmBlockCipher.DoFinal(decryptedData, processedBytes);\n    \n    return decryptedData;\n}\n</code></pre>\n<hr />\n<p>Functionally, the key derivation corresponds to PBKDF2 with HMAC/SHA1, an empty password, the hex decoding of <code>stringKey</code> as salt, and an iteration count of 1024. This can also be implemented using native .NET methods like <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.rfc2898derivebytes.-ctor?view=netcore-3.1#system-security-cryptography-rfc2898derivebytes-ctor(system-byte()-system-byte()-system-int32-system-security-cryptography-hashalgorithmname)\" rel=\"nofollow noreferrer\"><code>Rfc2898DeriveBytes</code></a> (even under .NET Core 3.1).<br />\nHowever, the entire logic cannot be implemented with native .NET methods, as the native <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.aesgcm.noncebytesizes?view=netcore-3.1#system-security-cryptography-aesgcm-noncebytesizes\" rel=\"nofollow noreferrer\"><code>AesGcm</code></a> class does not a support a 16 bytes nonce as required here, but exclusively a 12 bytes nonce, so that a third-party provider like BouncyCastle is necessary and therefore its PBKDF2 implementation can just as well be used.</p>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 12359353,
      "reputation" : 50593,
      "user_id" : 9014097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Y9EVM.jpg?s=256",
      "display_name" : "Topaco",
      "link" : "https://stackoverflow.com/users/9014097/topaco"
    },
    "creation_date" : 1753701207,
    "last_activity_date" : 1762801703,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140623728,
    "post_id" : 79717119,
    "body" : "@jdweng, Sure thanks, let me check.",
    "score" : 0,
    "owner" : {
      "account_id" : 12945841,
      "reputation" : 434,
      "user_id" : 9360232,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ashtrix-001",
      "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "creation_date" : 1753705271,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623727,
    "post_id" : 79717119,
    "body" : "@Charlieface Yes, because in our enterprise they have a separate service to handle encryption/decryption and they have used Java Spring Security&#39;s Bouncy Castle library internally. In C#, I earlier tried using AESGCM class as a part of System library but that didn&#39;t work since it was only accepting 12 byte nonce. Java lib uses 16 byte nonce by default.",
    "score" : 0,
    "owner" : {
      "account_id" : 12945841,
      "reputation" : 434,
      "user_id" : 9360232,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ashtrix-001",
      "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "creation_date" : 1753705247,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623712,
    "post_id" : 79717119,
    "body" : "The default key padding is different in java and c# and that is why you are failing.  See <a href=\"https://stackoverflow.com/questions/55029481/aes-encryption-in-java-to-match-with-c-sharp-output\" title=\"aes encryption in java to match with c sharp output\">stackoverflow.com/questions/55029481/&hellip;</a>",
    "score" : 1,
    "owner" : {
      "account_id" : 6156307,
      "reputation" : 34503,
      "user_id" : 5015238,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f8790f8091d3c6c58fd45664a165117a?s=256&d=identicon&r=PG",
      "display_name" : "jdweng",
      "link" : "https://stackoverflow.com/users/5015238/jdweng"
    },
    "creation_date" : 1753704856,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623644,
    "post_id" : 79717119,
    "body" : "Is there any reason you are using BouncyCastle rather than the <a href=\"https://learn.microsoft.com/en-us/dotnet/api/system.security.cryptography.aesgcm?view=net-9.0\" rel=\"nofollow noreferrer\">built in libraries</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 20264817,
      "reputation" : 78793,
      "user_id" : 14868997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/40cbeeb90667c9a8c1830f615a9b2899?s=256&d=identicon&r=PG",
      "display_name" : "Charlieface",
      "link" : "https://stackoverflow.com/users/14868997/charlieface"
    },
    "creation_date" : 1753703095,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623484,
    "post_id" : 79717119,
    "body" : "Topaco and jsweng - I have edited by question with updated code. &quot;the implicit use of a key derivation function (where in the Java code an empty password and secretKey is used as salt), which is missing in the C# code&quot; - Seems like it, will look through.",
    "score" : 0,
    "owner" : {
      "account_id" : 12945841,
      "reputation" : 434,
      "user_id" : 9360232,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ashtrix-001",
      "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "creation_date" : 1753699288,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623393,
    "post_id" : 79717119,
    "body" : "I&#39;ve not looked at the documentation of <code>BouncyCastleAesGcmBytesEncryptor</code> in detail, but the signature of the constructor you used is <code>BouncyCastleAesGcmBytesEncryptor(String password, CharSequence salt)</code>, which indicates the implicit use of a key derivation function (where in the Java code an empty password and <code>secretKey</code> is used as salt), which is missing in the C# code. You must therefore determine this key derivation from the Spring documentation or the source code and add it to the C# code.",
    "score" : 1,
    "owner" : {
      "account_id" : 12359353,
      "reputation" : 50593,
      "user_id" : 9014097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Y9EVM.jpg?s=256",
      "display_name" : "Topaco",
      "link" : "https://stackoverflow.com/users/9014097/topaco"
    },
    "creation_date" : 1753697211,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623364,
    "post_id" : 79717119,
    "body" : "<code>BouncyCastleAesGcmBytesEncryptor</code> points to the spring framework. You should mention this in your question. Since not everyone has one installed, it would be useful if you could add test data generated with the Java code: Key, plaintext and ciphertext.",
    "score" : 1,
    "owner" : {
      "account_id" : 12359353,
      "reputation" : 50593,
      "user_id" : 9014097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Y9EVM.jpg?s=256",
      "display_name" : "Topaco",
      "link" : "https://stackoverflow.com/users/9014097/topaco"
    },
    "creation_date" : 1753696191,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623331,
    "post_id" : 79717119,
    "body" : "@jdweng - I am converting base64 string to byte[] only once, using the output string from Java as it is.",
    "score" : 0,
    "owner" : {
      "account_id" : 12945841,
      "reputation" : 434,
      "user_id" : 9360232,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ashtrix-001",
      "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
    },
    "creation_date" : 1753695480,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140623322,
    "post_id" : 79717119,
    "body" : "Is the encrypted data base 64 string?  You then do not needs to convert a 2nd time to base 64 string.",
    "score" : 1,
    "owner" : {
      "account_id" : 6156307,
      "reputation" : 34503,
      "user_id" : 5015238,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f8790f8091d3c6c58fd45664a165117a?s=256&d=identicon&r=PG",
      "display_name" : "jdweng",
      "link" : "https://stackoverflow.com/users/5015238/jdweng"
    },
    "creation_date" : 1753695338,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79717239" : [ {
      "comment_id" : 140623837,
      "post_id" : 79717239,
      "body" : "@Topaco Thank you so much! This solved my issue after struggling for so many days. Basically, I just printed out key in byte[] and base64 at both sides and it looked similar hence I couldn&#39;t figure the issue is with the key. At one point I did look at the Java internal code and saw the derivation but since I am not aware of encryption/keys at a deep level I couldn&#39;t think much of it. But, thanks a lot!",
      "score" : 1,
      "owner" : {
        "account_id" : 12945841,
        "reputation" : 434,
        "user_id" : 9360232,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/31d1f2677bb34a6a8864509ba482f8b5?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "ashtrix-001",
        "link" : "https://stackoverflow.com/users/9360232/ashtrix-001"
      },
      "creation_date" : 1753707679,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}