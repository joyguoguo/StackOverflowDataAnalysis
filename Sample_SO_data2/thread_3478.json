{
  "question" : {
    "question_id" : 79549084,
    "title" : "Custom OncePerRequestFilter reads empty request body – why is the body already consumed?",
    "body" : "<p>I'm developing a Spring Boot application (with Spring Security) and need to add default headers (specifically, Content-Type and Content-Length) to requests targeting the endpoint /api/v1/mpos/set-token when those headers are missing. To achieve this, I wrote a custom filter that extends OncePerRequestFilter and wraps the incoming HttpServletRequest so that I can read and cache its body. I use the following code:</p>\n<pre><code>@Component\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic class SetTokenDefaultHeadersFilter extends OncePerRequestFilter {\n\n    private static final String DEFAULT_CONTENT_TYPE = &quot;application/json&quot;;\n    private static final String TARGET_URI = &quot;/api/v1/mpos/set-token&quot;;\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n            throws ServletException, IOException {\n        if (TARGET_URI.equals(request.getRequestURI())\n                &amp;&amp; &quot;POST&quot;.equalsIgnoreCase(request.getMethod())\n                &amp;&amp; (request.getHeader(&quot;Content-Type&quot;) == null || request.getHeader(&quot;Content-Length&quot;) == null)) {\n\n            HttpServletRequest wrappedRequest = new HttpServletRequestWrapper(request) {\n                private final byte[] cachedBody = toByteArray(request.getInputStream());\n\n                private byte[] toByteArray(InputStream input) throws IOException {\n                    ByteArrayOutputStream baos = new ByteArrayOutputStream();\n                    byte[] buffer = new byte[1024];\n                    int len;\n                    while ((len = input.read(buffer)) != -1) {\n                        baos.write(buffer, 0, len);\n                    }\n                    return baos.toByteArray();\n                }\n\n                @Override\n                public ServletInputStream getInputStream() {\n                    final ByteArrayInputStream bais = new ByteArrayInputStream(cachedBody);\n                    return new ServletInputStream() {\n                        @Override\n                        public int read() {\n                            return bais.read();\n                        }\n                        @Override\n                        public boolean isFinished() {\n                            return bais.available() == 0;\n                        }\n                        @Override\n                        public boolean isReady() {\n                            return true;\n                        }\n                        @Override\n                        public void setReadListener(ReadListener readListener) {\n                            // Not implemented\n                        }\n                    };\n                }\n\n                @Override\n                public BufferedReader getReader() {\n                    return new BufferedReader(new InputStreamReader(getInputStream(), StandardCharsets.UTF_8));\n                }\n\n                @Override\n                public int getContentLength() {\n                    return cachedBody.length;\n                }\n\n                @Override\n                public long getContentLengthLong() {\n                    return cachedBody.length;\n                }\n\n                @Override\n                public String getHeader(String name) {\n                    if (&quot;Content-Type&quot;.equalsIgnoreCase(name)) {\n                        String header = super.getHeader(name);\n                        return header == null ? DEFAULT_CONTENT_TYPE : header;\n                    }\n                    if (&quot;Content-Length&quot;.equalsIgnoreCase(name)) {\n                        String header = super.getHeader(name);\n                        return header == null ? String.valueOf(cachedBody.length) : header;\n                    }\n                    return super.getHeader(name);\n                }\n            };\n\n            filterChain.doFilter(wrappedRequest, response);\n        } else {\n            filterChain.doFilter(request, response);\n        }\n    }\n}\n</code></pre>\n<p>I have verified (via logging and FilterRegistrationBean) that my filter is registered with the highest precedence and should run first. However, when I call input.read(buffer), it immediately returns -1 (i.e. EOF), and the cached body is an empty array.</p>\n<p>What I've tried so far:</p>\n<p>Verified the filter order – my filter is running first.</p>\n<p>Checked for other filters that might be reading the body; the logs indicate that my filter is before them.</p>\n<p>My questions:</p>\n<p>What could be consuming the request body before my filter even gets a chance to read it?</p>\n<p>How can I ensure that my filter has access to the full request body so I can wrap it and add the default headers?</p>\n<p>Is there a recommended approach in Spring Boot to cache the request body before any processing?</p>\n<p>Any insights or suggestions would be greatly appreciated.</p>\n",
    "tags" : [ "java", "spring-boot", "servlets", "httprequest", "servlet-filters" ],
    "owner" : {
      "account_id" : 14900694,
      "reputation" : 81,
      "user_id" : 10759610,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-XEp9W1sMmjo/AAAAAAAAAAI/AAAAAAABv6o/z5oLkV3dbwA/s256-rj/photo.jpg",
      "display_name" : "Roman Patrushev",
      "link" : "https://stackoverflow.com/users/10759610/roman-patrushev"
    },
    "is_answered" : false,
    "view_count" : 103,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743537814,
    "creation_date" : 1743537814,
    "link" : "https://stackoverflow.com/questions/79549084/custom-onceperrequestfilter-reads-empty-request-body-why-is-the-body-already-c",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140289350,
    "post_id" : 79549084,
    "body" : "You should edit your question in well-format, easy to understand.",
    "score" : 0,
    "owner" : {
      "account_id" : 4597208,
      "reputation" : 1,
      "user_id" : 3728901,
      "user_type" : "registered",
      "accept_rate" : 58,
      "profile_image" : "https://www.gravatar.com/avatar/8621a1f0563a46ea809098b960d7923f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Vy Do",
      "link" : "https://stackoverflow.com/users/3728901/vy-do"
    },
    "creation_date" : 1743581807,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288971,
    "post_id" : 79549084,
    "body" : "My problem is that I need to add a content-length header and calculate the length of the body to add a value to this header. but when trying to get the Body from the request, it does not return anything, that is, it looks like the input stream was read earlier somewhere.",
    "score" : 0,
    "owner" : {
      "account_id" : 14900694,
      "reputation" : 81,
      "user_id" : 10759610,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-XEp9W1sMmjo/AAAAAAAAAAI/AAAAAAABv6o/z5oLkV3dbwA/s256-rj/photo.jpg",
      "display_name" : "Roman Patrushev",
      "link" : "https://stackoverflow.com/users/10759610/roman-patrushev"
    },
    "creation_date" : 1743575604,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140287725,
    "post_id" : 79549084,
    "body" : "Why don&#39;t you do it this way? <a href=\"https://medium.com/@vaibhavpithadiya09/how-to-add-a-custom-header-to-an-http-request-in-java-82aeb944a81e\" rel=\"nofollow noreferrer\">medium.com/@vaibhavpithadiya09/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 11555562,
      "reputation" : 569,
      "user_id" : 8466853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd7f72b426ce3c46739900b8ba014e26?s=256&d=identicon&r=PG",
      "display_name" : "Arno",
      "link" : "https://stackoverflow.com/users/8466853/arno"
    },
    "creation_date" : 1743539027,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}