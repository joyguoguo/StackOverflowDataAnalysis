{
  "question" : {
    "question_id" : 79614259,
    "title" : "How to make @ConditionalOnMissingBean in the context of a @SpringBootTest work?",
    "body" : "<p>I have a SpringBoot application that declares two beans in a @Configuration class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class ServiceConfig {\n\n    @Bean\n    public RequestHeaderSetter requestHeaderSetter() {\n        return new RequestHeaderSetter(...);\n    }\n\n    @Bean\n    public MyService myService(RequestHeaderSetter headerSetter) {\n        return new MyService(headerSetter);\n    }\n\n}\n</code></pre>\n<p>Besides that, I have a library that also defines a bean of type <code>RequestHeaderSetter</code>, but only if it's not present yet:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class LibConfig {\n\n    @Bean\n    @ConditionalOnMissingBean(RequestHeaderSetter.class)\n    public RequestHeaderSetter requestHeaderSetterFromTheLib() {\n        return new RequestHeaderSetter(...);\n    }\n\n}\n</code></pre>\n<p>The application includes the library as a dependency.</p>\n<p>The application starts just fine. The problem arises in a test.</p>\n<p>I have a SpringBoot test:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootTest\n@ActiveProfiles(&quot;integrationTest&quot;)\n@DirtiesContext\nclass IntegrationTest {\n  . . .\n}\n</code></pre>\n<p>When I start the test I get the error that the bean <code>myService</code> can't be instantiated because there are two beans of type <code>RequestHeaderSetter</code>: requestHeaderSetter and requestHeaderSetterFromTheLib (No qualifying bean of type 'RequestHeaderSetter' available: expected single matching bean but found 2). I.e. the annotation <code>@ConditionalOnMissingBean</code> does not seem to work in the context of a @SpringBootTest.</p>\n<p>How can I make the test work as expected? Since my application defines a bean of type <code>RequestHeaderSetter</code>, I expect that the library does not create the bean.</p>\n<p>Thank you!</p>\n",
    "tags" : [ "java", "spring", "spring-boot" ],
    "owner" : {
      "account_id" : 7983379,
      "reputation" : 362,
      "user_id" : 6023830,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d56761493a4f6e29d291dd6b6c1e65d7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "fml2",
      "link" : "https://stackoverflow.com/users/6023830/fml2"
    },
    "is_answered" : true,
    "view_count" : 127,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1746848587,
    "creation_date" : 1746798092,
    "link" : "https://stackoverflow.com/questions/79614259/how-to-make-conditionalonmissingbean-in-the-context-of-a-springboottest-work",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79614718,
    "question_id" : 79614259,
    "body" : "<p>Order of bean configuration/loading in runtime and test environmentss in Spring slightly differs from each other.<br />\nPlease, see issue <a href=\"https://github.com/spring-projects/spring-boot/issues/29996\" rel=\"nofollow noreferrer\">https://github.com/spring-projects/spring-boot/issues/29996</a> and repo example in it.<br />\nIn your case workaround may be in explicit ordering:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootTest(classes = {\n  LibConfig.class,\n  ServiceConfig.class\n})\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2861986,
      "reputation" : 410,
      "user_id" : 2457058,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/eb31120d1e8298007e911d74d27e23f0?s=256&d=identicon&r=PG",
      "display_name" : "artild",
      "link" : "https://stackoverflow.com/users/2457058/artild"
    },
    "creation_date" : 1746817033,
    "last_activity_date" : 1746817033,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79615120,
    "question_id" : 79614259,
    "body" : "<pre><code>The @ConditionalOnMissingBean annotation is not working in your @SpringBootTest because the test context may process LibConfig before ServiceConfig, causing both RequestHeaderSetter beans to be created.\n\nTry adding a test-specific @TestConfiguration to define a RequestHeaderSetter bean, ensuring LibConfig skips its bean due to @ConditionalOnMissingBean.\n\n@SpringBootTest\n@ActiveProfiles(&quot;integrationTest&quot;)\n@DirtiesContext\nclass IntegrationTest {\n\n    @TestConfiguration\n    static class TestConfig {\n        @Bean\n        public RequestHeaderSetter requestHeaderSetter() {\n            return new RequestHeaderSetter(/* test params */);\n        }\n    }\n\n    @Test\n    void testMyService() {\n        // Your test logic here\n    }\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 20686847,
      "reputation" : 62,
      "user_id" : 15189063,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0fbe8d6b4dd70a526004e9a5e20dbeaf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Oladejo Olajide",
      "link" : "https://stackoverflow.com/users/15189063/oladejo-olajide"
    },
    "creation_date" : 1746848587,
    "last_activity_date" : 1746848587,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140412304,
    "post_id" : 79614259,
    "body" : "Thank you! I&#39;ve never read that part!",
    "score" : 0,
    "owner" : {
      "account_id" : 7983379,
      "reputation" : 362,
      "user_id" : 6023830,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d56761493a4f6e29d291dd6b6c1e65d7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "fml2",
      "link" : "https://stackoverflow.com/users/6023830/fml2"
    },
    "creation_date" : 1746821515,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140411223,
    "post_id" : 79614259,
    "body" : "<code>@ConditionalOnMissingBean</code> javadoc states: &quot;The condition can only match the bean definitions that have been processed by the application context so far and, as such, <b>it is strongly recommended to use this condition on auto-configuration classes only</b>&quot;. The best option is to create two autoconfigurations and establish order between them using <code>@AutoConfigureAfter&#47;@AutoConfigureBefore</code>",
    "score" : 2,
    "owner" : {
      "account_id" : 4181375,
      "reputation" : 6263,
      "user_id" : 3426309,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/v58O6.jpg?s=256",
      "display_name" : "Andrey B. Panfilov",
      "link" : "https://stackoverflow.com/users/3426309/andrey-b-panfilov"
    },
    "creation_date" : 1746799373,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79614718" : [ {
      "comment_id" : 140414275,
      "post_id" : 79614718,
      "body" : "Also, thank you for the issue reference.",
      "score" : 0,
      "owner" : {
        "account_id" : 7983379,
        "reputation" : 362,
        "user_id" : 6023830,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d56761493a4f6e29d291dd6b6c1e65d7?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "fml2",
        "link" : "https://stackoverflow.com/users/6023830/fml2"
      },
      "creation_date" : 1746909339,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140412307,
      "post_id" : 79614718,
      "body" : "Thank you! I&#39;ll probably use the auto configuration feature.",
      "score" : 0,
      "owner" : {
        "account_id" : 7983379,
        "reputation" : 362,
        "user_id" : 6023830,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d56761493a4f6e29d291dd6b6c1e65d7?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "fml2",
        "link" : "https://stackoverflow.com/users/6023830/fml2"
      },
      "creation_date" : 1746821565,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79615120" : [ {
      "comment_id" : 140413173,
      "post_id" : 79615120,
      "body" : "Thank you for the hint. I&#39;d still prefer to not create a special test infrastructure but rather have it as close as possible to the real application. It&#39;s strange that it works differently in the application and in the code.",
      "score" : 0,
      "owner" : {
        "account_id" : 7983379,
        "reputation" : 362,
        "user_id" : 6023830,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d56761493a4f6e29d291dd6b6c1e65d7?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "fml2",
        "link" : "https://stackoverflow.com/users/6023830/fml2"
      },
      "creation_date" : 1746866733,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}