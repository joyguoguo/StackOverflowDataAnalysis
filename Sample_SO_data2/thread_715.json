{
  "question" : {
    "question_id" : 79783499,
    "title" : "SonarQube provides an error message for Optional with value marked as Nullable (JSpecify)",
    "body" : "<p>We have migrated our null-check annotations from javax.annotation to org.jspecify.annotations and got a new message from SonarQube in different locations of our code.</p>\n<p>Here is an example of code that now brings an error message:</p>\n<pre><code>import java.util.Optional;\n\nimport org.jspecify.annotations.Nullable;\n\npublic class SonarLinOptionaJSpecifyProblem {\n\n    public static String toLowerCaseNullSafe(@Nullable String string) {\n        return Optional.ofNullable(string).map(String::toLowerCase).orElse(null);\n    }\n}\n</code></pre>\n<p>The Sonar message is: A &quot;NullPointerException&quot; could be thrown; &quot;ofNullable()&quot; can return null. (rule java:S2259)</p>\n<p>May be I'm wrong, but Optional.ofNullable can't return null.</p>\n<p>Is it a bug of Sonar or I completely missunderstand Optional?</p>\n<p>P.S. If I switch back to javax.annotation.Nullable, I get no such message from SonarQube</p>\n<p>Thanks to <strong>k314159</strong>. It's a <a href=\"https://community.sonarsource.com/t/a-nullpointerexception-could-be-thrown-ofnullable-can-return-null/134892/9\" rel=\"nofollow noreferrer\">bug</a> of SonarQube. Discussion is closed. I hope the great SonarQube team will fix this bug as soon as possible.</p>\n",
    "tags" : [ "java", "sonarlint" ],
    "owner" : {
      "account_id" : 2259314,
      "reputation" : 11357,
      "user_id" : 1989769,
      "user_type" : "registered",
      "accept_rate" : 45,
      "profile_image" : "https://i.sstatic.net/37IMZ.jpg?s=256",
      "display_name" : "Sergiy Medvynskyy",
      "link" : "https://stackoverflow.com/users/1989769/sergiy-medvynskyy"
    },
    "is_answered" : true,
    "view_count" : 128,
    "answer_count" : 1,
    "score" : 3,
    "last_activity_date" : 1759822494,
    "creation_date" : 1759741709,
    "link" : "https://stackoverflow.com/questions/79783499/sonarqube-provides-an-error-message-for-optional-with-value-marked-as-nullable",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79783575,
    "question_id" : 79783499,
    "body" : "<p>Because of <code>orElse(null)</code> the <code>return</code> can yield <code>null</code>. The Sonar message erroneously labels this returnal as &quot;ofNullable&quot;.</p>\n<p>Use <code>@Nullable</code> on the <code>toLowerCaseNullSafe</code>.</p>\n<pre><code>@Nullable\npublic static String toLowerCaseNullSafe(@Nullable String string) {\n    return Optional.ofNullable(string).map(String::toLowerCase).orElse(null);\n    return string == null ? null : string.toLowerCase();\n}\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 960307,
      "reputation" : 110397,
      "user_id" : 984823,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Z2KYN.jpg?s=256",
      "display_name" : "Joop Eggen",
      "link" : "https://stackoverflow.com/users/984823/joop-eggen"
    },
    "creation_date" : 1759746492,
    "last_activity_date" : 1759746492,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140779385,
    "post_id" : 79783499,
    "body" : "@k314159 Thanks. This is what I was looking for",
    "score" : 0,
    "owner" : {
      "account_id" : 2259314,
      "reputation" : 11357,
      "user_id" : 1989769,
      "user_type" : "registered",
      "accept_rate" : 45,
      "profile_image" : "https://i.sstatic.net/37IMZ.jpg?s=256",
      "display_name" : "Sergiy Medvynskyy",
      "link" : "https://stackoverflow.com/users/1989769/sergiy-medvynskyy"
    },
    "creation_date" : 1759751405,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140779366,
    "post_id" : 79783499,
    "body" : "See <a href=\"https://community.sonarsource.com/t/a-nullpointerexception-could-be-thrown-ofnullable-can-return-null/134892/9\" rel=\"nofollow noreferrer\">community.sonarsource.com/t/&hellip;</a>",
    "score" : 3,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1759750829,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140779222,
    "post_id" : 79783499,
    "body" : "<code>Optional.ofNullable</code> indeed <i>cannot</i> return <code>null</code>. That would defeat the whole purpose of <code>Optional</code>. So if Sonar reports that <code>Optional.ofNullable()</code> can return <code>null</code>, then that&#39;s simply not true.",
    "score" : 3,
    "owner" : {
      "account_id" : 238684,
      "reputation" : 23306,
      "user_id" : 507738,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://i.sstatic.net/7ghSp.jpg?s=256",
      "display_name" : "MC Emperor",
      "link" : "https://stackoverflow.com/users/507738/mc-emperor"
    },
    "creation_date" : 1759745572,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79783575" : [ {
      "comment_id" : 140781071,
      "post_id" : 79783575,
      "body" : "It&#39;s a bug of sonar Qube. See the comment from <code>k314159</code>. Question is closed. Thanks for your attention.",
      "score" : 2,
      "owner" : {
        "account_id" : 2259314,
        "reputation" : 11357,
        "user_id" : 1989769,
        "user_type" : "registered",
        "accept_rate" : 45,
        "profile_image" : "https://i.sstatic.net/37IMZ.jpg?s=256",
        "display_name" : "Sergiy Medvynskyy",
        "link" : "https://stackoverflow.com/users/1989769/sergiy-medvynskyy"
      },
      "creation_date" : 1759822062,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140779442,
      "post_id" : 79783575,
      "body" : "@SergiyMedvynskyy Try a name without usage <code>toLowerCaseNullSafeXXX</code>. If the error disappears it is some dereferencing usage of <code>toLowerCaseNullSafe</code>. Probably my added <code>@Nullable</code> then is not recognized.",
      "score" : 0,
      "owner" : {
        "account_id" : 960307,
        "reputation" : 110397,
        "user_id" : 984823,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/Z2KYN.jpg?s=256",
        "display_name" : "Joop Eggen",
        "link" : "https://stackoverflow.com/users/984823/joop-eggen"
      },
      "creation_date" : 1759752815,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140779351,
      "post_id" : 79783575,
      "body" : "Added. Nothig changed. The wrong message is still here. Here ist the explanation of SonarQuebe: <code>1: &#39;ofNullable()&#39; can return null. 2: Result of &#39;ofNullable()&#39; is dereferenced.</code>. The fitrst sentence is simply incorrect.",
      "score" : 2,
      "owner" : {
        "account_id" : 2259314,
        "reputation" : 11357,
        "user_id" : 1989769,
        "user_type" : "registered",
        "accept_rate" : 45,
        "profile_image" : "https://i.sstatic.net/37IMZ.jpg?s=256",
        "display_name" : "Sergiy Medvynskyy",
        "link" : "https://stackoverflow.com/users/1989769/sergiy-medvynskyy"
      },
      "creation_date" : 1759750235,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140779297,
      "post_id" : 79783575,
      "body" : "@SergiyMedvynskyy I think the error message is due to the missing <code>@Nullable</code> on the method. The ternary alternative is irrelevant, just added because shorter here.",
      "score" : 0,
      "owner" : {
        "account_id" : 960307,
        "reputation" : 110397,
        "user_id" : 984823,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/Z2KYN.jpg?s=256",
        "display_name" : "Joop Eggen",
        "link" : "https://stackoverflow.com/users/984823/joop-eggen"
      },
      "creation_date" : 1759748187,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140779275,
      "post_id" : 79783575,
      "body" : "Sorry, but I cann&#39;t use your suggestion. We get this message in different locations. Some of them use chain of optional methods like <code>map().filter().flatMap()</code> and/or don&#39;t return any value because they are end with <code>ifPresent()</code>",
      "score" : 1,
      "owner" : {
        "account_id" : 2259314,
        "reputation" : 11357,
        "user_id" : 1989769,
        "user_type" : "registered",
        "accept_rate" : 45,
        "profile_image" : "https://i.sstatic.net/37IMZ.jpg?s=256",
        "display_name" : "Sergiy Medvynskyy",
        "link" : "https://stackoverflow.com/users/1989769/sergiy-medvynskyy"
      },
      "creation_date" : 1759747453,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}