{
  "question" : {
    "question_id" : 79643454,
    "title" : "Could not open JPA EntityManager for transaction problem after reconnecting to DB",
    "body" : "<p>I develop Spring Boot migrate data app.</p>\n<p>I test the case when app loses connection to DB (PostgreSQL) while makes &quot;save&quot; operation, reconnects and continues to work.</p>\n<p>What I try to do:</p>\n<ol>\n<li>save with normal connection - OK</li>\n<li>switch DB off -&gt; trying save -&gt; get no connection error - OK</li>\n<li>reconnect -&gt; trying to save -&gt; get following error:</li>\n</ol>\n<pre><code>org.springframework.transaction.CannotCreateTransactionException: Could not open JPA EntityManager for transaction\n    at org.springframework.orm.jpa.JpaTransactionManager.doBegin(JpaTransactionManager.java:466)\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.startTransaction(AbstractPlatformTransactionManager.java:532)\n    at org.springframework.transaction.support.AbstractPlatformTransactionManager.getTransaction(AbstractPlatformTransactionManager.java:405)\n    at org.springframework.transaction.interceptor.TransactionAspectSupport.createTransactionIfNecessary(TransactionAspectSupport.java:639)\n    at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:374)\n    at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:138)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:165)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy123.save(Unknown Source)\n    at ru.etpgpb.migration_tool.service.NewDataConvertService.handleData(NewDataConvertService.java:90)\n    at ru.etpgpb.migration_tool.service.RawDataConvertService.buildAndHandleObject(RawDataConvertService.java:65)\n    at ru.etpgpb.migration_tool.service.RawDataConvertService.getRawData(RawDataConvertService.java:52)\n    at ru.etpgpb.migration_tool.controllers.EdsDataController.getUserCertificates(EdsDataController.java:22)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.web.method.support.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:258)\n    at org.springframework.web.method.support.InvocableHandlerMethod.invokeForRequest(InvocableHandlerMethod.java:191)\n    at org.springframework.web.servlet.mvc.method.annotation.ServletInvocableHandlerMethod.invokeAndHandle(ServletInvocableHandlerMethod.java:118)\n    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.invokeHandlerMethod(RequestMappingHandlerAdapter.java:986)\n    at org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter.handleInternal(RequestMappingHandlerAdapter.java:891)\n    at org.springframework.web.servlet.mvc.method.AbstractHandlerMethodAdapter.handle(AbstractHandlerMethodAdapter.java:87)\n    at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089)\n    at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979)\n    at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014)\n    at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903)\n    at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:564)\n    at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885)\n    at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.FormContentFilter.doFilterInternal(FormContentFilter.java:93)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:201)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)\n    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)\n    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)\n    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:116)\n    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\n    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\n    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)\n    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:398)\n    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\n    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:903)\n    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1740)\n    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n    at java.base/java.lang.Thread.run(Thread.java:840)\nCaused by: org.hibernate.TransactionException: JDBC begin transaction failed: \n    at org.hibernate.resource.jdbc.internal.AbstractLogicalConnectionImplementor.begin(AbstractLogicalConnectionImplementor.java:78)\n    at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.begin(LogicalConnectionManagedImpl.java:295)\n    at org.hibernate.resource.transaction.backend.jdbc.internal.JdbcResourceLocalTransactionCoordinatorImpl$TransactionDriverControlImpl.begin(JdbcResourceLocalTransactionCoordinatorImpl.java:232)\n    at org.hibernate.engine.transaction.internal.TransactionImpl.begin(TransactionImpl.java:83)\n    at org.springframework.orm.jpa.vendor.HibernateJpaDialect.beginTransaction(HibernateJpaDialect.java:176)\n    at org.springframework.orm.jpa.JpaTransactionManager.doBegin(JpaTransactionManager.java:420)\n    ... 66 more\nCaused by: java.sql.SQLException: Connection is closed\n    at com.zaxxer.hikari.pool.ProxyConnection$ClosedConnection.lambda$getClosedConnection$0(ProxyConnection.java:503)\n    at jdk.proxy3/jdk.proxy3.$Proxy68.setAutoCommit(Unknown Source)\n    at com.zaxxer.hikari.pool.ProxyConnection.setAutoCommit(ProxyConnection.java:402)\n    at com.zaxxer.hikari.pool.HikariProxyConnection.setAutoCommit(HikariProxyConnection.java)\n    at org.hibernate.resource.jdbc.internal.AbstractLogicalConnectionImplementor.begin(AbstractLogicalConnectionImplementor.java:72)\n</code></pre>\n<p>although I expect successful save.</p>\n<p>I use Spring Boot 3.4.5, JpaRepository for saving. Make save with:</p>\n<pre><code>try {\n     edsUserRepository.save(record);\n } catch (Exception e) {\n   e.printStackTrace();\n}\n</code></pre>\n<p>My application.propertises:</p>\n<pre><code>spring.datasource.driver-class-name=org.postgresql.Driver\nspring.datasource.url=jdbc:postgresql://localhost:5432/app?currentSchema=public\nspring.datasource.username={...}\nspring.datasource.password={...}\n\nspring.datasource.hikari.connection-timeout=30000\nspring.datasource.hikari.idle-timeout=600000\nspring.datasource.hikari.max-lifetime=1800000\nspring.datasource.hikari.minimum-idle=15\nspring.datasource.hikari.maximum-pool-size=10\nspring.datasource.hikari.test-on-borrow=true\nspring.datasource.hikari.validation.query=SELECT 1\n</code></pre>\n<p>As I learned if above-mentioned Hikari are set there wouldn't be any problems but I still get error.</p>\n",
    "tags" : [ "java", "spring", "postgresql", "jpa", "boot" ],
    "owner" : {
      "account_id" : 40650301,
      "reputation" : 19,
      "user_id" : 29884518,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1b7bdda82579bc3e718f854529269401?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "KommRex",
      "link" : "https://stackoverflow.com/users/29884518/kommrex"
    },
    "is_answered" : false,
    "view_count" : 92,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1751846185,
    "creation_date" : 1748503009,
    "link" : "https://stackoverflow.com/questions/79643454/could-not-open-jpa-entitymanager-for-transaction-problem-after-reconnecting-to-d",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140468847,
    "post_id" : 79643454,
    "body" : "Maybe enabling logging on <code>com.zaxxer.hikari</code> can shine a light on your problem.",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20796,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1748511348,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140468744,
    "post_id" : 79643454,
    "body" : "Hi, talex. Thanks for hint, I removed test-on-borrow, but error keeps going ...",
    "score" : 0,
    "owner" : {
      "account_id" : 40650301,
      "reputation" : 19,
      "user_id" : 29884518,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1b7bdda82579bc3e718f854529269401?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "KommRex",
      "link" : "https://stackoverflow.com/users/29884518/kommrex"
    },
    "creation_date" : 1748509181,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140468694,
    "post_id" : 79643454,
    "body" : "hikari doesn&#39;t support <code>test-on-borrow</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20796,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1748507923,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}