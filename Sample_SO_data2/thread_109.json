{
  "question" : {
    "question_id" : 79828471,
    "title" : "Drools rule fails for genuine use case at high scale",
    "body" : "<p>I have written the rule below to evaluate a very easy use case.</p>\n<pre><code>rule &quot;WIN_DRL&quot;\n    when\n        $featureMap: Map()\n        $reward: Reward()\n        $rewardSummery : RewardSummery(\n            $milestoneId: milestoneId,\n            additionalParam[&quot;eventSource&quot;] == $reward.getEventSource(),\n            &quot;SUPER_AMOUNT_MONTHLY_SUM&quot; == aggregationsDrl\n        )\n        $container: WinningRuleResultContainer()\n    then\n       System.out.println( &quot;in then condition&quot;);\n       WinningRuleResult result = new WinningRuleResult($milestoneId, &quot;&quot; );\n       $container.addResult(result);\nend\n</code></pre>\n<p>The rule runs perfectly at low scale (2000 events per minute).</p>\n<p>The rule doesn't pass for genuine use cases at high scale (5000 events per minute).</p>\n<p>I have cached <code>kieContainerSessionsPool</code> in my pods memory.</p>\n<p>During runtime I:</p>\n<ol>\n<li>Get a new <code>KieSession</code> from these containers</li>\n<li>Insert all the objects in the container</li>\n<li><code>fireAllRules</code></li>\n</ol>\n<p>I am adding my java code that I use to initialize containers.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Singleton\n@Log4j2\npublic class RuleEngineServiceImpl implements RuleEngineService {\n\n    Map&lt;String, KieContainerSessionsPool&gt; kieContainersPoolMap = new ConcurrentHashMap&lt;&gt;();\n\n    public void executeRules(String shaKey, List&lt;Object&gt; objects){\n        KieContainerSessionsPool kieContainerPool = this.kieContainersPoolMap.get(shaKey);\n        long startTime = CommonUtil.getCurrentEpoch() ;\n        log.info(&quot;KieSession for shaKey: {}, startTime: {}&quot;, shaKey, startTime);\n        KieSession kSession = null;\n        Reward rewardObject = null ;\n        WinningRuleResultContainer winningRuleResultContainer = null ;\n\n        synchronized(RuleEngineServiceImpl.class) {\n            kSession = kieContainerPool.newKieSession();\n            long identifier = kSession.getIdentifier();\n        }\n\n        if(Objects.isNull(kSession)){\n            log.info(&quot;KieSession is null, shaKey: {}&quot;, shaKey);\n        }\n\n        // insert all the data object to drools.\n        for (Object ob : objects) {\n            kSession.insert(ob);\n        }\n        // Fire all rules\n        int fireRulesResult = 0;\n        int retryCount = 0;\n\n        while(fireRulesResult==0 &amp;&amp; retryCount&lt;5){\n            log.info(&quot;BEFORE :: winningRuleResultContainer data fire for reward_id: {}, container : {}&quot;,\n                rewardObject != null ? rewardObject.getId() : &quot;&quot;,\n                winningRuleResultContainer != null ? winningRuleResultContainer.getWinningRuleResultList() : &quot;&quot;\n            );\n            fireRulesResult = kSession.fireAllRules();\n            log.info(&quot;attempting fireRulesResult : {}, retryCount: {}&quot;, fireRulesResult, retryCount);\n            retryCount++;\n            log.info(&quot;AFTER :: winningRuleResultContainer data fire for reward_id: {}, container : {}&quot;,\n                rewardObject != null ? rewardObject.getId() : &quot;&quot;,\n                winningRuleResultContainer != null ? winningRuleResultContainer.getWinningRuleResultList() : &quot;&quot;\n            );\n        }\n\n        log.info(&quot;KieSession, shaKey: {}, fireRulesResult: {}&quot;, shaKey, fireRulesResult);\n\n        // Dispose of the session\n        // the KIE session is reset and pushed back into the pool instead of being destroyed.\n        kSession.dispose();\n        log.info(&quot;KieSession for shaKey: {}, totalTimeTaken: {}&quot;, shaKey, CommonUtil.getCurrentEpoch() - startTime);\n    }\n\n}\n</code></pre>\n<p>I am not sure what is happening here exactly. Any help will be deeply appreciated.</p>\n",
    "tags" : [ "java", "drools" ],
    "owner" : {
      "account_id" : 38396543,
      "reputation" : 11,
      "user_id" : 28753467,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e760aa3a68418d922074c7fa3f10981d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "holeInWater",
      "link" : "https://stackoverflow.com/users/28753467/holeinwater"
    },
    "is_answered" : false,
    "view_count" : 36,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1763980713,
    "creation_date" : 1763977777,
    "link" : "https://stackoverflow.com/questions/79828471/drools-rule-fails-for-genuine-use-case-at-high-scale",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}