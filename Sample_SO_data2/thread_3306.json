{
  "question" : {
    "question_id" : 79560213,
    "title" : "Issue with corrupt PDF when encrypting pages directly using PDFBox",
    "body" : "<p>Our application processes uploaded PDFs by extracting individual pages, grouping them per user, and then creating a new PDF that is encrypted with a password. However, when we apply the encryption directly during the document creation process, the resulting PDF becomes corrupt.</p>\n<p>Although the PDF reader prompts for a password, it fails to open the document, indicating that the file is invalid or corrupt.</p>\n<p>Below is an excerpt of our code that illustrates the process:</p>\n<p>Opening the original PDF and extracting pages:</p>\n<pre><code>// Open the original PDF\ntry (PDDocument originalDocument = PDDocument.load(new File(&quot;input.pdf&quot;))) {\n    // Extract pages and group them per user (example for one user)\n    List&lt;PDPage&gt; userPages = new ArrayList&lt;&gt;();\n    for (PDPage page : originalDocument.getPages()) {\n        // Additional processing can be done here if needed\n        userPages.add(page);\n    }\n    // Proceed to create a new document for the user...\n}\n</code></pre>\n<p>Creating a new PDF and applying encryption directly:</p>\n<pre><code>try (PDDocument employeeDocument = new PDDocument()) {\n    // Attempt 1: Adding pages directly\n    for (PDPage page : userPages) {\n        employeeDocument.addPage(page);\n    }\n    \n    // Attempt 2: Importing pages as an alternative (currently commented out)\n    /*\n    for (PDPage page : userPages) {\n        employeeDocument.importPage(page);\n    }\n    */\n\n    Path fullPath = payrollManager.getTempPayrollsPath().resolve(Path.of(&quot;user_pdf.pdf&quot;));\n\n    String password = &quot;test&quot;;\n    AccessPermission accessPermission = new AccessPermission();\n    StandardProtectionPolicy spp = new StandardProtectionPolicy(password, password, accessPermission);\n    spp.setEncryptionKeyLength(256);\n    spp.setPermissions(accessPermission);\n\n    // Apply password protection directly\n    employeeDocument.protect(spp);\n    employeeDocument.save(fullPath.toFile());\n}\n</code></pre>\n<p>It is important to note that if we remove the encryption step (i.e., if we do not call the <code>protect(spp)</code> method), the newly generated PDF opens normally without any issues. Furthermore, when we encrypt the documents after the document has been closed (encrypting them in a subsequent step), everything works as expected. However, our requirement is to have the document encrypted directly during the creation process.</p>\n<p>Despite trying both the <code>addPage()</code> and <code>importPage()</code> methods, the encrypted PDFs remain corrupt when the encryption is applied immediately. We have also considered a two-step approach (saving the document unencrypted, closing it, and then encrypting), but this does not fit our use case.</p>\n<p>Could you please advise on how to properly copy or import pages into a new PDDocument before applying encryption, so that the resulting PDF remains valid when encrypted directly during creation?</p>\n",
    "tags" : [ "java", "pdf", "pdf-generation", "pdfbox", "pdf-extraction" ],
    "owner" : {
      "account_id" : 28864519,
      "reputation" : 23,
      "user_id" : 22107570,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTtfnYFrmZrY8qPiAwqi5E1L-UP06UVCxy1nrx2V7MA=k-s256",
      "display_name" : "Lvkas_",
      "link" : "https://stackoverflow.com/users/22107570/lvkas"
    },
    "is_answered" : false,
    "view_count" : 79,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1744093039,
    "creation_date" : 1744037963,
    "link" : "https://stackoverflow.com/questions/79560213/issue-with-corrupt-pdf-when-encrypting-pages-directly-using-pdfbox",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140479097,
    "post_id" : 79560213,
    "body" : "Since 3.0 PDFBox moved from PDDocument.load() to Loader.loadPDF(), so I guess you&#39;re on PDFBox 2.x, right? Neither 2.0 nor 3.0 reproduces the issue with <i>my</i> input test PDFs. Could you please share an input PDF you&#39;re using?",
    "score" : 0,
    "owner" : {
      "account_id" : 35354441,
      "reputation" : 44,
      "user_id" : 27156279,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/oJPdtGFA.jpg?s=256",
      "display_name" : "Alexey Gagarinov",
      "link" : "https://stackoverflow.com/users/27156279/alexey-gagarinov"
    },
    "creation_date" : 1748865076,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310934,
    "post_id" : 79560213,
    "body" : "@TilmanHausherr I have to store the PDFs for some reasons also on the disk. So keeping the things in the memory is basically not working for me.",
    "score" : 0,
    "owner" : {
      "account_id" : 28864519,
      "reputation" : 23,
      "user_id" : 22107570,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTtfnYFrmZrY8qPiAwqi5E1L-UP06UVCxy1nrx2V7MA=k-s256",
      "display_name" : "Lvkas_",
      "link" : "https://stackoverflow.com/users/22107570/lvkas"
    },
    "creation_date" : 1744101304,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310917,
    "post_id" : 79560213,
    "body" : "I assume you&#39;re doing a mass mailing of payroll PDFs. Although you don&#39;t want to save/load, you can do this in memory with a ByteArrayOutputStream and then load from a byte array.",
    "score" : 0,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19235,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1744101088,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310662,
    "post_id" : 79560213,
    "body" : "I see that the javadoc warns about it, but only very indirectly: &quot;Do not use the document after saving, because the structures are encrypted.&quot; I&#39;ll think about an improved text.",
    "score" : 0,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19235,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1744097313,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310641,
    "post_id" : 79560213,
    "body" : "I was able to reproduce it. I first made a code change that the destination files don&#39;t get closed before all is done but this didn&#39;t help. I suspect that the problem is that the encryption encrypts parts that are used by later produced files. So it&#39;s encrypted twice.",
    "score" : 0,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19235,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1744096996,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}