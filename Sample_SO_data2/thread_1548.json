{
  "question" : {
    "question_id" : 79700067,
    "title" : "How to properly shade with Maven to avoid version conflicts?",
    "body" : "<p>My app is unable to deploy and run on a servlet container because of a clash in Guava dependencies.</p>\n<p>The runtime uses version 15.0 (see: <a href=\"https://github.com/capedwarf/capedwarf-blue/blob/a1f04e0eaee578a4b39857cd6a86a2df096de7d1/pom.xml#L61\" rel=\"nofollow noreferrer\">https://github.com/capedwarf/capedwarf-blue/blob/a1f04e0eaee578a4b39857cd6a86a2df096de7d1/pom.xml#L61</a>)\nbut my web app is using Guice that depends on a more recent Guava.</p>\n<p>Here's the stack trace:</p>\n<pre><code>23:25:10,323 INFO  [org.infinispan.jmx.CacheJmxRegistration] (MSC service thread 1-9) ISPN000031: MBeans were successfully registered to the platform MBean server.\n23:25:10,327 INFO  [org.jboss.as.clustering.infinispan] (MSC service thread 1-9) JBAS010281: Started logs_restlet-appstart cache from capedwarf container\n23:25:10,779 ERROR [org.jboss.msc.service.fail] (MSC service thread 1-2) MSC000001: Failed to start service jboss.undertow.deployment.default-server.default-host./ROOT: org.jboss.msc.service.StartException in service jboss.undertow.deployment.default-server.default-host./ROOT: Failed to start service\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.run(ServiceControllerImpl.java:1904) [jboss-msc-1.2.2.Final.jar:1.2.2.Final]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [rt.jar:1.8.0_452]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [rt.jar:1.8.0_452]\n    at java.lang.Thread.run(Thread.java:750) [rt.jar:1.8.0_452]\nCaused by: java.lang.NoSuchMethodError: com.google.common.base.Preconditions.checkArgument(ZLjava/lang/String;Ljava/lang/Object;Ljava/lang/Object;)V\n    at com.google.inject.TypeLiteral.getParameterTypes(TypeLiteral.java:269)\n    at com.google.inject.spi.InjectionPoint.forMember(InjectionPoint.java:113)\n    at com.google.inject.spi.InjectionPoint.&lt;init&gt;(InjectionPoint.java:72)\n    at com.google.inject.spi.InjectionPoint.forMethod(InjectionPoint.java:316)\n    at com.google.inject.internal.ProviderMethodsModule.createProviderMethod(ProviderMethodsModule.java:293)\n    at com.google.inject.internal.ProviderMethodsModule.getProviderMethods(ProviderMethodsModule.java:135)\n    at com.google.inject.internal.ProviderMethodsModule.configure(ProviderMethodsModule.java:105)\n    at com.google.inject.spi.Elements$RecordingBinder.install(Elements.java:347)\n    at com.google.inject.spi.Elements$RecordingBinder.install(Elements.java:356)\n    at com.google.inject.AbstractModule.install(AbstractModule.java:103)\n    at com.google.inject.servlet.ServletModule.configure(ServletModule.java:49)\n    at com.google.inject.AbstractModule.configure(AbstractModule.java:61)\n    at com.google.inject.spi.Elements$RecordingBinder.install(Elements.java:347)\n    at com.google.inject.spi.Elements.getElements(Elements.java:104)\n    at com.google.inject.internal.InjectorShell$Builder.build(InjectorShell.java:137)\n    at com.google.inject.internal.InternalInjectorCreator.build(InternalInjectorCreator.java:105)\n    at com.google.inject.Guice.createInjector(Guice.java:87)\n    at com.google.inject.Guice.createInjector(Guice.java:69)\n    at com.google.inject.Guice.createInjector(Guice.java:59)\n    at app.company.server.StartupListener.getInjector(StartupListener.java:10)\n    at com.google.inject.servlet.GuiceServletContextListener.contextInitialized(GuiceServletContextListener.java:45)\n    at io.undertow.servlet.core.ApplicationListeners.contextInitialized(ApplicationListeners.java:173)\n    at io.undertow.servlet.core.DeploymentManagerImpl.deploy(DeploymentManagerImpl.java:194)\n    at org.wildfly.extension.undertow.deployment.UndertowDeploymentService.startContext(UndertowDeploymentService.java:87)\n    at org.wildfly.extension.undertow.deployment.UndertowDeploymentService.start(UndertowDeploymentService.java:72)\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.startService(ServiceControllerImpl.java:1948) [jboss-msc-1.2.2.Final.jar:1.2.2.Final]\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.run(ServiceControllerImpl.java:1881) [jboss-msc-1.2.2.Final.jar:1.2.2.Final]\n    ... 3 more\n\n23:25:10,805 ERROR [org.jboss.as.controller.management-operation] (Controller Boot Thread) JBAS014613: Operation (&quot;add&quot;) failed - address: ([(&quot;deployment&quot; =&gt; &quot;/home/quarks/Projects/company/company_gwtapp_gwt28/deployments/ROOT.war&quot;)]) - failure description: {&quot;JBAS014671: Failed services&quot; =&gt; {&quot;jboss.undertow.deployment.default-server.default-host./ROOT&quot; =&gt; &quot;org.jboss.msc.service.StartException in service jboss.undertow.deployment.default-server.default-host./ROOT: Failed to start service\n    Caused by: java.lang.NoSuchMethodError: com.google.common.base.Preconditions.checkArgument(ZLjava/lang/String;Ljava/lang/Object;Ljava/lang/Object;)V&quot;}}\n</code></pre>\n<p>I have tried to shade it with this config:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;plugin&gt;\n&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n&lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;\n&lt;version&gt;3.2.4&lt;/version&gt;\n&lt;executions&gt;\n    &lt;execution&gt;\n        &lt;phase&gt;package&lt;/phase&gt;\n        &lt;goals&gt;\n            &lt;goal&gt;shade&lt;/goal&gt;\n        &lt;/goals&gt;\n        &lt;configuration&gt;\n            &lt;createDependencyReducedPom&gt;false&lt;/createDependencyReducedPom&gt;\n            &lt;relocations&gt;\n                &lt;relocation&gt;\n                    &lt;pattern&gt;com.google.common&lt;/pattern&gt;\n                    &lt;shadedPattern&gt;com.shaded.google.common&lt;/shadedPattern&gt;\n                &lt;/relocation&gt;\n            &lt;/relocations&gt;\n        &lt;/configuration&gt;\n    &lt;/execution&gt;\n&lt;/executions&gt;\n&lt;/plugin&gt;\n&lt;plugin&gt;\n&lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n&lt;artifactId&gt;maven-war-plugin&lt;/artifactId&gt;\n&lt;configuration&gt;\n    &lt;archiveClasses&gt;true&lt;/archiveClasses&gt;\n    &lt;outputDirectory&gt;deployments&lt;/outputDirectory&gt;\n    &lt;warName&gt;ROOT&lt;/warName&gt;\n    &lt;webResources&gt;\n        &lt;resource&gt;\n            &lt;directory&gt;${basedir}/src/main/webapp/WEB-INF&lt;/directory&gt;\n            &lt;filtering&gt;true&lt;/filtering&gt;\n            &lt;targetPath&gt;WEB-INF&lt;/targetPath&gt;\n        &lt;/resource&gt;\n    &lt;/webResources&gt;\n&lt;/configuration&gt;\n&lt;/plugin&gt;\n</code></pre>\n<p>Then checking the package WAR:</p>\n<pre><code>$ jar tf deployments/ROOT.war | grep com.shaded.google.common\ncom/shaded/google/common/\ncom/shaded/google/common/annotations/\ncom/shaded/google/common/annotations/Beta.class\ncom/shaded/google/common/annotations/GwtCompatible.class\ncom/shaded/google/common/annotations/GwtIncompatible.class\ncom/shaded/google/common/annotations/VisibleForTesting.class\n</code></pre>\n<p>And also updating the POM config:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependencyManagement&gt;\n&lt;dependencies&gt;\n    &lt;!-- Capedwarf fix: --&gt;\n    &lt;!-- mark the _old_ container version as provided so it is NOT bundled --&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.google.guava&lt;/groupId&gt;\n        &lt;artifactId&gt;guava&lt;/artifactId&gt;\n        &lt;version&gt;15.0&lt;/version&gt;\n        &lt;scope&gt;provided&lt;/scope&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.google.guava&lt;/groupId&gt;\n        &lt;artifactId&gt;guava&lt;/artifactId&gt;\n        &lt;version&gt;27.1-jre&lt;/version&gt;\n    &lt;/dependency&gt;\n</code></pre>\n<p>However, the error in the runtime still persists.</p>\n",
    "tags" : [ "java", "maven" ],
    "owner" : {
      "account_id" : 412334,
      "reputation" : 35687,
      "user_id" : 785349,
      "user_type" : "registered",
      "accept_rate" : 94,
      "profile_image" : "https://i.sstatic.net/OuJeX.jpg?s=256",
      "display_name" : "quarks",
      "link" : "https://stackoverflow.com/users/785349/quarks"
    },
    "is_answered" : false,
    "view_count" : 55,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1752421317,
    "creation_date" : 1752421317,
    "link" : "https://stackoverflow.com/questions/79700067/how-to-properly-shade-with-maven-to-avoid-version-conflicts",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140586476,
    "post_id" : 79700067,
    "body" : "Before shading, did you try to run the app with the &quot;more recent guava&quot; instead of version 15.0 ?",
    "score" : 2,
    "owner" : {
      "account_id" : 888714,
      "reputation" : 36717,
      "user_id" : 927493,
      "user_type" : "registered",
      "accept_rate" : 61,
      "profile_image" : "https://i.sstatic.net/sxsnm.png?s=256",
      "display_name" : "JF Meier",
      "link" : "https://stackoverflow.com/users/927493/jf-meier"
    },
    "creation_date" : 1752428594,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}