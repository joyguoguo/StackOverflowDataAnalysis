{
  "question" : {
    "question_id" : 79749922,
    "title" : "Mockito and module-info with Version 5.16.0+: Mockito cannot mock this class",
    "body" : "<p>I'm using the Java Module System since some years now and until Mockito 5.15.2 this was no Problem. But with Version 5.16.0+ I now got the following error:</p>\n<pre><code>Mockito cannot mock this class: class javax.xml.parsers.DocumentBuilder\n</code></pre>\n<p>Because of this I tried to add something like the following to the test module-info:</p>\n<pre><code>opens java.xml to org.mockito;\n</code></pre>\n<p>without luck.\nSo within the release notes of Mockito 5.16.0 I found:</p>\n<pre><code>Add support for including module-info in Mockito.\n</code></pre>\n<p>Which is great/nice, but an explanation what to change would be nice.\nBut maybe my module-info:</p>\n<pre><code>requires org.mockito;\n</code></pre>\n<p>is wrong, because mockito seems to export every package like <code>org.mockito.internal.*</code> which looks strange to me.</p>\n<p>So my question is how to correctly make my tests work again with mockito Versions 5.16.0+?</p>\n<p>Full error message:</p>\n<pre><code>[ERROR] Errors:\n[ERROR]   AHASessionMiniTests.testNewInstance2:345 Mockito\nMockito cannot mock this class: class javax.xml.parsers.DocumentBuilder.\n\nIf you're not sure why you're getting this error, please open an issue on GitHub.\n\n\nJava               : 17\nJVM vendor name    : Oracle Corporation\nJVM vendor version : 17.0.8+9-LTS-211\nJVM name           : Java HotSpot(TM) 64-Bit Server VM\nJVM version        : 17.0.8+9-LTS-211\nJVM info           : mixed mode, sharing\nOS name            : Windows 10\nOS version         : 10.0\n\n\nYou are seeing this disclaimer because Mockito is configured to create inlined mocks.\nYou can learn about inline mocks and their limitations under item #39 of the Mockito class javadoc.\n\nUnderlying exception : java.lang.IllegalArgumentException: Could not create type\n</code></pre>\n<p>Stacktrace:</p>\n<pre><code>Underlying exception : java.lang.IllegalArgumentException: Could not create type\n        at de.powerstat.fb.mini/de.powerstat.fb.mini.test.TR64SessionMiniTests.testToString(TR64SessionMiniTests.java:151)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\n        at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\n        at java.base/java.util.ArrayList.forEach(ArrayList.java:1511)\nCaused by: java.lang.IllegalArgumentException: Could not create type\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:170)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:399)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:190)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:410)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:75)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.InlineBytecodeGenerator.mockClass(InlineBytecodeGenerator.java:223)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.lambda$mockClass$0(TypeCachingBytecodeGenerator.java:78)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:168)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:399)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:190)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache$WithInlineExpunction.findOrInsert(TypeCache.java:410)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.mockClass(TypeCachingBytecodeGenerator.java:75)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMockType(InlineDelegateByteBuddyMockMaker.java:429)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.doCreateMock(InlineDelegateByteBuddyMockMaker.java:388)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.InlineDelegateByteBuddyMockMaker.createMock(InlineDelegateByteBuddyMockMaker.java:367)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.InlineByteBuddyMockMaker.createMock(InlineByteBuddyMockMaker.java:56)\n        at org.mockito/org.mockito.internal.util.MockUtil.createMock(MockUtil.java:99)\n        at org.mockito/org.mockito.internal.MockitoCore.mock(MockitoCore.java:84)\n        at org.mockito/org.mockito.Mockito.mock(Mockito.java:2198)\n        at org.mockito/org.mockito.Mockito.mock(Mockito.java:2113)\n        ... 4 more\nCaused by: java.lang.IllegalAccessError: superclass access check failed: class org.mockito.internal.creation.bytebuddy.codegen.DocumentBuilder$MockitoMock$0UHi1uwe (in module org.mockito) cannot access class javax.xml.parsers.DocumentBuilder (in module java.xml) because module org.mockito does not read module java.xml\n        at java.base/java.lang.ClassLoader.defineClass0(Native Method)\n        at java.base/java.lang.System$2.defineClass(System.java:2307)\n        at java.base/java.lang.invoke.MethodHandles$Lookup$ClassDefiner.defineClass(MethodHandles.java:2439)\n        at java.base/java.lang.invoke.MethodHandles$Lookup$ClassDefiner.defineClass(MethodHandles.java:2416)\n        at java.base/java.lang.invoke.MethodHandles$Lookup.defineClass(MethodHandles.java:1843)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n        at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77)\n        at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n        at java.base/java.lang.reflect.Method.invoke(Method.java:568)\n        at net.bytebuddy.utility.Invoker$Dispatcher.invoke(Unknown Source)\n        at net.bytebuddy@1.15.11/net.bytebuddy.utility.dispatcher.JavaDispatcher$Dispatcher$ForNonStaticMethod.invoke(JavaDispatcher.java:1033)\n        at net.bytebuddy@1.15.11/net.bytebuddy.utility.dispatcher.JavaDispatcher$ProxiedInvocationHandler.invoke(JavaDispatcher.java:1163)\n        at jdk.proxy2/jdk.proxy2.$Proxy86.defineClass(Unknown Source)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.loading.ClassInjector$UsingLookup.injectRaw(ClassInjector.java:1685)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.loading.ClassInjector$AbstractBase.injectRaw(ClassInjector.java:166)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.loading.ClassInjector$AbstractBase.inject(ClassInjector.java:154)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.loading.ClassLoadingStrategy$UsingLookup.load(ClassLoadingStrategy.java:519)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.TypeResolutionStrategy$Passive.initialize(TypeResolutionStrategy.java:101)\n        at net.bytebuddy@1.15.11/net.bytebuddy.dynamic.DynamicType$Default$Unloaded.load(DynamicType.java:6424)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.SubclassBytecodeGenerator.mockClass(SubclassBytecodeGenerator.java:282)\n        at org.mockito/org.mockito.internal.creation.bytebuddy.TypeCachingBytecodeGenerator.lambda$mockClass$0(TypeCachingBytecodeGenerator.java:78)\n        at net.bytebuddy@1.15.11/net.bytebuddy.TypeCache.findOrInsert(TypeCache.java:168)\n        ... 23 more\n</code></pre>\n",
    "tags" : [ "java", "mockito", "java-module" ],
    "owner" : {
      "account_id" : 3623129,
      "reputation" : 3873,
      "user_id" : 3021395,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/MkpSU.jpg?s=256",
      "display_name" : "PowerStat",
      "link" : "https://stackoverflow.com/users/3021395/powerstat"
    },
    "is_answered" : true,
    "view_count" : 117,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1756458315,
    "creation_date" : 1756450903,
    "link" : "https://stackoverflow.com/questions/79749922/mockito-and-module-info-with-version-5-16-0-mockito-cannot-mock-this-class",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79750022,
    "question_id" : 79749922,
    "body" : "<p>The cause of the problem is:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Caused by: java.lang.IllegalAccessError: superclass access check failed: class org.mockito.internal.creation.bytebuddy.codegen.DocumentBuilder$MockitoMock$0UHi1uwe (in module org.mockito) cannot access class javax.xml.parsers.DocumentBuilder (in module java.xml) because module org.mockito does not read module java.xml\n</code></pre>\n<p>This comes from the fact that Mockito is defining the mock class in the <code>org.mockito</code> module. But the mock class inherits from the class being mocked, and that latter class comes from the <code>java.xml</code> module. This causes the <code>IllegalAccessError</code> because the <code>org.mockito</code> module does not <em>reads</em> the <code>java.xml</code> module (because the former does not require the latter, nor does it require any modules which transitively require the latter).</p>\n<p>There's two solutions I can think of:</p>\n<ol>\n<li><p>Don't put Mockito on the module-path (i.e., don't load Mockito as a named module). When Mockito is on the class-path it will be placed in the &quot;unnamed module&quot; which <em>reads</em> all resolved named modules<sup>1</sup>.</p>\n</li>\n<li><p>Pass <code>--add-reads org.mockito=java.xml</code> when running your tests. This would be needed in addition to any <code>--add-opens</code> argument you might already be passing.</p>\n</li>\n</ol>\n<hr />\n<p>A solution that keeps Mockito on the module-path but also avoids the <code>--add-reads</code> argument would need to be implemented by Mockito, if I'm not mistaken. Two potential solutions might be:</p>\n<ol>\n<li><p>Use a <code>MethodHandles.Lookup</code> that defines the mock class in the class-to-mock's module instead of the <code>org.mockito</code> module. Doing that would mean both classes are in the same module, and a module obviously <em>reads</em> itself. The problem with this is that the <code>Lookup</code> would need package access for the class-to-mock's package, which might force <code>--add-opens</code> arguments that were not previously needed.</p>\n</li>\n<li><p>Mockito could call <code>Module#addReads(Module)</code> on its module for all modules in its <code>ModuleLayer</code> (and any parent layers, recursively). Alternatively, it could call <code>addReads</code> on demand (as mocks are requested).</p>\n</li>\n</ol>\n<p>I only mention these options in case someone submits a bug report to Mockito and wants to offer potential solutions.</p>\n<hr />\n<p><sup>1. If you were placing the previous versions of Mockito on the module-path, and those versions of Mockito did not include a <code>module-info</code> descriptor yet, then Mockito was an <em>automatic</em> module. That would explain why it worked before. An automatic module, like the unnamed module, <em>reads</em> all resolved named modules.</sup></p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1756456806,
    "last_activity_date" : 1756458315,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140700928,
    "post_id" : 79749922,
    "body" : "I can confirm that adding &lt;argLine&gt;--add-reads org.mockito=java.xml&lt;/argLine&gt; to the maven-surefire-plugin configuration resolves my problem.",
    "score" : 1,
    "owner" : {
      "account_id" : 3623129,
      "reputation" : 3873,
      "user_id" : 3021395,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/MkpSU.jpg?s=256",
      "display_name" : "PowerStat",
      "link" : "https://stackoverflow.com/users/3021395/powerstat"
    },
    "creation_date" : 1756456014,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140700898,
    "post_id" : 79749922,
    "body" : "That error should be fixed by including <code>--add-reads org.mockito=java.xml</code>. I think a solution that avoids that argument, other than not putting Mockito on the module-path, would need to be implemented by Mockito (perhaps defining the mock class in the class-to-mock&#39;s module instead of org.mockito).",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1756455405,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140700790,
    "post_id" : 79749922,
    "body" : "Added everything from mvn -X run",
    "score" : 0,
    "owner" : {
      "account_id" : 3623129,
      "reputation" : 3873,
      "user_id" : 3021395,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/MkpSU.jpg?s=256",
      "display_name" : "PowerStat",
      "link" : "https://stackoverflow.com/users/3021395/powerstat"
    },
    "creation_date" : 1756452464,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140700739,
    "post_id" : 79749922,
    "body" : "Please add the full stacktrace / error you get instead of a snippet.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1756451220,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140700733,
    "post_id" : 79749922,
    "body" : "Is there more to the &quot;Mockito cannot mock this class&quot; error? Like a stack trace?",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1756451079,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}