{
  "question" : {
    "question_id" : 79598784,
    "title" : "Java Google Mail API send &quot;Precondition check failed&quot; - 400 Bad Request for Service Account server-to-server no user",
    "body" : "<p>In response to Google's recent change to disallow <code>username/password</code> access to Google Workspace accounts from Google Cloud VM-instances, I am attempted to replace <code>sendmail</code> calls with Google API calls to Gmail API using Java with OAuth2 authentication using service accounts. The error seems to be fairly standard with what many others are seeing, with no details to help troubleshoot:</p>\n<pre class=\"lang-none prettyprint-override\"><code>com.google.api.client.googleapis.json.GoogleJsonResponseException: 400 Bad Request\nPOST https://gmail.googleapis.com/gmail/v1/users/*****@*****.com/messages/send\n{\n  &quot;code&quot;: 400,\n  &quot;errors&quot;: [\n    {\n      &quot;domain&quot;: &quot;global&quot;,\n      &quot;message&quot;: &quot;Precondition check failed.&quot;,\n      &quot;reason&quot;: &quot;failedPrecondition&quot;\n    }\n  ],\n  &quot;message&quot;: &quot;Precondition check failed.&quot;,\n  &quot;status&quot;: &quot;FAILED_PRECONDITION&quot;\n}\n        at com.google.api.client.googleapis.json.GoogleJsonResponseException.from(GoogleJsonResponseException.java:146)\n        at com.google.api.client.googleapis.services.json.AbstractGoogleJsonClientRequest.newExceptionOnError(AbstractGoogleJsonClientRequest.java:118)\n        at com.google.api.client.googleapis.services.json.AbstractGoogleJsonClientRequest.newExceptionOnError(AbstractGoogleJsonClientRequest.java:37)\n        at com.google.api.client.googleapis.services.AbstractGoogleClientRequest$1.interceptResponse(AbstractGoogleClientRequest.java:439)\n        at com.google.api.client.http.HttpRequest.execute(HttpRequest.java:1111)\n        at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:525)\n        at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.executeUnparsed(AbstractGoogleClientRequest.java:466)\n        at com.google.api.client.googleapis.services.AbstractGoogleClientRequest.execute(AbstractGoogleClientRequest.java:576)\n\n</code></pre>\n<p>After researching using Google's documentation pages and stackoverflow articles I have performed all of the following steps:</p>\n<ol>\n<li>Created a new <strong>Service Account</strong> under my Google Cloud production project and granted it <code>Basic/Editor</code> role.</li>\n<li>Updated my VM-instance to use this new service account (maybe unnecessary).</li>\n<li>Downloaded the Service Account's key file as JSON.</li>\n<li>In my Java application code, copied and modified Google's sample code from <a href=\"https://developers.google.com/workspace/gmail/api/guides/sending\" rel=\"nofollow noreferrer\">Sending Mail</a>.</li>\n<li>In Google Workspace, enabled <strong>domain-wide delegation</strong> by adding a new client using my Service Account's client id, and setting the scope value to <code>https://www.googleapis.com/auth/gmail.send</code></li>\n<li>Deployed my code to the VM-instance and tested.</li>\n</ol>\n<p>Here is the Java email-sending code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    public void send(String toEmailAddress, String[] ccEmailAddress, String[] bccEmailAddress, String replyToAddress,\n            String subject, String htmlBodyText) {\n        GoogleCredentials credentials;\n        try {\n            String json = /** fetch the service account JSON file **/\n            InputStream stream = new ByteArrayInputStream(json.getBytes(StandardCharsets.UTF_8));\n            \n            credentials = ServiceAccountCredentials.fromStream(stream).createScoped(GmailScopes.GMAIL_SEND);\n\n            HttpRequestInitializer requestInitializer = new HttpCredentialsAdapter(credentials);\n\n            // Create the gmail API client\n            Gmail service = new Gmail.Builder(new NetHttpTransport(), GsonFactory.getDefaultInstance(),\n                    requestInitializer).setApplicationName(MyAppName).build();\n\n            // Encode as MIME message\n            Properties props = new Properties();\n            Session session = Session.getDefaultInstance(props, null);\n            MimeMessage email = new MimeMessage(session);\n            email.setFrom(new InternetAddress(fromEmailAddress));\n            email.addRecipient(javax.mail.Message.RecipientType.TO, new InternetAddress(toEmailAddress));\n\n            if (ccEmailAddress != null) {\n                for (String addr : ccEmailAddress) {\n                    email.addRecipient(javax.mail.Message.RecipientType.CC, new InternetAddress(addr));\n                }\n            }\n\n            if (bccEmailAddress != null) {\n                for (String addr : bccEmailAddress) {\n                    email.addRecipient(javax.mail.Message.RecipientType.BCC, new InternetAddress(addr));\n                }\n            }\n\n            email.setSubject(subject);\n            email.setText(htmlBodyText);\n\n            // Encode and wrap the MIME message into a gmail message\n            ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n            email.writeTo(buffer);\n            byte[] rawMessageBytes = buffer.toByteArray();\n            String encodedEmail = Base64.encodeBase64URLSafeString(rawMessageBytes);\n            Message message = new Message();\n            message.setRaw(encodedEmail);\n\n            try {\n                // Create send message\n                message = service.users().messages().send(workspaceAccountEmail, message).execute();\n                LOGGER.debug(&quot;\\&quot;Message id: {}, {}&quot;, message.getId(),message.toPrettyString());\n                \n                // return message;\n            } catch (GoogleJsonResponseException e) {\n                LOGGER.warn(&quot;Caught an {} exception when trying to send mail&quot;, e.getClass().getName(), e);\n            }\n            // return null;\n\n        } catch (IOException | MessagingException e) {\n            LOGGER.warn(&quot;Caught an {} exception when trying to prepare sendmail&quot;, e.getClass().getName(), e);\n        }\n\n    }\n\n</code></pre>\n<p>Google Workspace account impersonation is happening in the code when calling the Google API service <code>send()</code> function, and passing in the workspace account email address.</p>\n<p>I have verified the contents of the service account JSON file by changing it manually, and seeing different error messages based on missing attributes etc., so I know that it's using the correct file contents.</p>\n",
    "tags" : [ "java", "gmail-api", "google-workspace", "service-accounts", "google-api-java-client" ],
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "is_answered" : true,
    "view_count" : 146,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1746191402,
    "creation_date" : 1745942606,
    "link" : "https://stackoverflow.com/questions/79598784/java-google-mail-api-send-precondition-check-failed-400-bad-request-for-serv",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79598878,
    "question_id" : 79598784,
    "body" : "<p>I stumbled across a couple of posts <a href=\"https://stackoverflow.com\">FAILED_PRECONDITION - Gmail API</a> which provided an answer that worked for my case:</p>\n<p>This line from the google code sample:</p>\n<pre class=\"lang-java prettyprint-override\"><code>credentials = ServiceAccountCredentials.fromStream(stream).createScoped(GmailScopes.GMAIL_SEND);\n</code></pre>\n<p>needs to change to this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>ServiceAccountCredentials.fromStream(stream).createScoped(GmailScopes.GMAIL_SEND).createDelegated(workspaceEmailAddress);\n</code></pre>\n<p>The <code>.createDelegate(workspaceEmailAddress)</code> apparently ensures that the impersonation is happening at the right place.</p>\n<p>Also for a bonus, to send an HTML formatted email, we need to change this line from the google sample code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>email.setText(htmlBodyText);\n</code></pre>\n<p>to this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>email.setContent(htmlBodyText, &quot;text/html&quot;);\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1745946846,
    "last_activity_date" : 1745948080,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}