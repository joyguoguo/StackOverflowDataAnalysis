{
  "question" : {
    "question_id" : 79564979,
    "title" : "S3Exception: x-amz-content-sha256 error in Java client",
    "body" : "<p>I have onTap ObjectStore setup, able to access ObjectStore for finding list of objects, download object actions using java code. I am using Amazon's software.amazon.awssdk. Here is my maven dependency</p>\n<pre><code>      &lt;dependency&gt;\n        &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n        &lt;artifactId&gt;aws-sdk-java&lt;/artifactId&gt;\n        &lt;version&gt;2.31.14&lt;/version&gt;\n      &lt;/dependency&gt;\n      &lt;dependency&gt;\n        &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n        &lt;artifactId&gt;apache-client&lt;/artifactId&gt;\n        &lt;version&gt;2.31.14&lt;/version&gt;\n      &lt;/dependency&gt;\n</code></pre>\n<p>Here is the code that creates S3 Client. With S3Client, I am able to get the list of objects or download a object.</p>\n<pre><code>private S3Client getS3Client()\n    {\n        String secretKey = &quot;secretKey&quot;;\n        String accessKey = &quot;accessKey&quot;;\n        String endPoint = &quot;http://198.10.11.131&quot;;\n        AwsCredentials credentials = AwsBasicCredentials.create(accessKey, secretKey);\n        S3Configuration s3Config = S3Configuration.builder()\n            .pathStyleAccessEnabled(true)\n            .build();\n        S3ClientBuilder s3ClientBuilder = S3Client.builder()\n            .endpointOverride(URI.create(endPoint))\n            .region(Region.US_WEST_2)\n            .serviceConfiguration(s3Config)\n            .credentialsProvider(StaticCredentialsProvider.create(credentials));\n        return s3ClientBuilder.build();\n    }\n</code></pre>\n<p>Here is the code to upload file which fails.</p>\n<pre><code> PutObjectRequest request = PutObjectRequest.builder()\n            .bucket(bucketName)\n            .key(keyName)\n            .build();\n        s3Client.putObject(request, Path.of(filePath));\n</code></pre>\n<p>The exception</p>\n<pre><code>Caused by: software.amazon.awssdk.services.s3.model.S3Exception: x-amz-content-sha256 must be UNSIGNED-PAYLOAD, STREAMING-AWS4-HMAC-SHA256-PAYLOAD or a valid sha256 value. (Service: S3, Status Code: 400, Request ID: null) (SDK Attempt Count: 1)\n</code></pre>\n<p>I don't see a way to set this header either in PutObjectRequest or putObject method. I tried to set checkAlgorithm on PutObjectRequest didn't help. I tried different method of putObject, I see same error.</p>\n<p>Any one facing such error, How to pass this header from java. I am following AWS user guide - <a href=\"https://docs.aws.amazon.com/AmazonS3/latest/userguide/upload-objects.html\" rel=\"nofollow noreferrer\">https://docs.aws.amazon.com/AmazonS3/latest/userguide/upload-objects.html</a></p>\n<p>Any help in this is greatly helpful, TIA</p>\n",
    "tags" : [ "java", "amazon-s3", "file-upload" ],
    "owner" : {
      "account_id" : 340001,
      "reputation" : 635,
      "user_id" : 669789,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://www.gravatar.com/avatar/6ef19f6d112f25ef31d12d7414c4e677?s=256&d=identicon&r=PG",
      "display_name" : "user669789",
      "link" : "https://stackoverflow.com/users/669789/user669789"
    },
    "is_answered" : true,
    "view_count" : 627,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1756909426,
    "creation_date" : 1744219859,
    "link" : "https://stackoverflow.com/questions/79564979/s3exception-x-amz-content-sha256-error-in-java-client",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79754728,
    "question_id" : 79564979,
    "body" : "<h2>Problem (in my case)</h2>\n<p>I had the same issue. The header was set to <code>STREAMING-AWS4-HMAC-SHA256-PAYLOAD-TRAILER</code> which produced an error.</p>\n<p>Within <code>ChecksumUtil</code> there is the evaluation to determine the corresponding header value:\n<a href=\"https://github.com/aws/aws-sdk-java-v2/blob/master/core/http-auth-aws/src/main/java/software/amazon/awssdk/http/auth/aws/internal/signer/util/ChecksumUtil.java#L175-L178\" rel=\"nofollow noreferrer\">https://github.com/aws/aws-sdk-java-v2/blob/master/core/http-auth-aws/src/main/java/software/amazon/awssdk/http/auth/aws/internal/signer/util/ChecksumUtil.java#L175-L178</a></p>\n<pre><code>boolean isTrailing = request.request().firstMatchingHeader(X_AMZ_TRAILER).isPresent();\nboolean isFlexible = request.hasProperty(CHECKSUM_ALGORITHM) &amp;&amp; !hasChecksumHeader;\n\n...\n\nif (isFlexible || isTrailing) {\n  return Checksummer.forPrecomputed256Checksum(STREAMING_SIGNED_PAYLOAD_TRAILER);\n}\nreturn Checksummer.forPrecomputed256Checksum(STREAMING_SIGNED_PAYLOAD);\n</code></pre>\n<p>In my case the request included the property <code>CHECKSUM_ALGORITHM</code> and had no checksum-header so <code>isFlexible</code> was <code>true</code> and the checksummer used <code>STREAMING_SIGNED_PAYLOAD_TRAILER</code>.</p>\n<h2>Solution</h2>\n<p>Since I did not need to have the checksum on my request, In my case configuring <code>RequestChecksumCalculation.WHEN_REQUIRED</code> within the <code>S3Client</code> fixed the problem.</p>\n<p>For your client:</p>\n<pre><code>S3ClientBuilder s3ClientBuilder = S3Client.builder()\n            .endpointOverride(URI.create(endPoint))\n            .region(Region.US_WEST_2)\n            .serviceConfiguration(s3Config)\n            .credentialsProvider(StaticCredentialsProvider.create(credentials))\n            .requestChecksumCalculation(RequestChecksumCalculation.WHEN_REQUIRED);\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43779315,
      "reputation" : 11,
      "user_id" : 31412877,
      "user_type" : "unregistered",
      "profile_image" : "https://www.gravatar.com/avatar/637d59069ec8ec29d7b533ce7c9f24b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "oscar",
      "link" : "https://stackoverflow.com/users/31412877/oscar"
    },
    "creation_date" : 1756909426,
    "last_activity_date" : 1756909426,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140319946,
    "post_id" : 79564979,
    "body" : "Looks like in 2.31.14, this got broke. In 2.29.21 works fine.",
    "score" : 0,
    "owner" : {
      "account_id" : 340001,
      "reputation" : 635,
      "user_id" : 669789,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://www.gravatar.com/avatar/6ef19f6d112f25ef31d12d7414c4e677?s=256&d=identicon&r=PG",
      "display_name" : "user669789",
      "link" : "https://stackoverflow.com/users/669789/user669789"
    },
    "creation_date" : 1744281826,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}