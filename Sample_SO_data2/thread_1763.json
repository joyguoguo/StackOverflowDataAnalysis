{
  "question" : {
    "question_id" : 79680183,
    "title" : "org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before successfully committing offsets with kafkaTransactionManager",
    "body" : "<p>I am using kafka @KafkaListener with @Transactional(&quot;kafkaTransactionManager&quot;).My flow will be something read/process/commit using transaction consumer.</p>\n<pre><code> public void listen(List&lt;ConsumerRecord&gt; records) {    \n  \n    // do some database activities           \n    final Object result = kafkaTemplate.send(producerRecord).get(); \n    //I am sending data and waiting for response to capture offset and store in DB\n    long offset = ((SendResult) result).getRecordMetadata().offset();\n    int partition = ((SendResult) result).getRecordMetadata().partition();\n    log.info(offset ,partition  );\n}\n</code></pre>\n<p>When anything happen before or at sender then transaction rolled back and it read from same offset happy path flow.</p>\n<p><strong>Issue</strong> - Say data is published and after consumer is going to commit the offset and i get error\n<strong>org.apache.kafka.common.errors.TimeoutException: Timeout of 60000ms expired before successfully committing offsets</strong>\nIn this case consumer  will read the same offset again ( i think so since transaction is NOT successfully completed)?</p>\n<p>If <strong>yes</strong> - this will cause the duplicate since message already sent?<br />\nIf <strong>No</strong> - then how the message will be removed from target topic ( where producer sent the message)</p>\n<p>I am using acks = -1 and idempotence = true.</p>\n",
    "tags" : [ "java", "apache-kafka", "spring-kafka" ],
    "owner" : {
      "account_id" : 14651915,
      "reputation" : 47,
      "user_id" : 10581692,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/038d7deca75007112d120b83edcc700e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "TechUk",
      "link" : "https://stackoverflow.com/users/10581692/techuk"
    },
    "is_answered" : false,
    "view_count" : 88,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1752183132,
    "creation_date" : 1750927819,
    "link" : "https://stackoverflow.com/questions/79680183/org-apache-kafka-common-errors-timeoutexception-timeout-of-60000ms-expired-befo",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79697623,
    "question_id" : 79680183,
    "body" : "<p>First of all, make sure that ack is -1 and idempotence is true, because one will get ConfigException, saying that &quot;ack must be all in order to use idempotent producer&quot;</p>\n<p>The consumer in the listener container will read the same message again, because consumer position will be reset by method recordAfterRollback of ListenerConsumer, when tx is rolled back on exception.</p>\n<p>Commiting offset (via producer's sendOffsetsToTransaction) and sending message via kafka template is done in the same kafka transaction and the same producer instance.</p>\n<p>If you're worried about duplicates in the topic, which may occur, set isolation.level for your consumers = read_committed, this will make consumers read only committed messages.<br />\nYou can read about kafka transactions and how it works <a href=\"https://www.confluent.io/blog/transactions-apache-kafka/\" rel=\"nofollow noreferrer\">here</a></p>\n<p>Also, since you're inserting something in a database, read how to sync jdbc and kafka transactions <a href=\"https://docs.spring.io/spring-kafka/reference/tips.html#ex-jdbc-sync\" rel=\"nofollow noreferrer\">here</a>. Because KafkaTransactionManager can't cover this alone.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 20850387,
      "reputation" : 108,
      "user_id" : 15315053,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1db5386ca04a80b976c5a77df9bcbe01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Yan",
      "link" : "https://stackoverflow.com/users/15315053/yan"
    },
    "creation_date" : 1752183132,
    "last_activity_date" : 1752183132,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}