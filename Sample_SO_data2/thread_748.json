{
  "question" : {
    "question_id" : 79779626,
    "title" : "Kafka Streams main consumer fetch rate stays low after GlobalKTable (RocksDB) restore",
    "body" : "<p>I’m running a Kafka Streams application (tested with versions 3.9.1 and 4.1.0) that uses a GlobalKTable backed by RocksDB. There are multiple instances of the application, each with 4 stream threads.\nThe application applies only very basic transformations to incoming messages (no joins or other stateful operations). The GlobalKTable is a simple mapping from ID → value that is used to enrich the stream. The sst files are lost after restart, so global stream threads reads the full topic.</p>\n<p>During startup, the GlobalKTable restore runs as expected.\nAfter the restore is complete, the main stream consumer fetch rate stays relatively low (~140k msgs/s across all consumers) and the CPU utilization stays at 70%s.\nIf I re-produce all data to the underlying topic for the GlobalKTable, the consumers start fetching at a much higher rate (~200k msgs/s) and the CPU utilization increases to 90s until the lag is processed.</p>\n<p>The GlobalKTable holds about 500 MB of data, and the underlying topic is configured as compact.\nI set the RocksDB block cache size to roughly the dataset size so most data should be cached in memory.\nThe cache hit ratio is close to 1 most of the time.</p>\n<p>I tried prepopulating the RocksDB block cache by iterating over the global store in setGlobalStateRestoreListener. I verified via RocksDB metrics that the block cache size increased to near capacity, but the low consumer fetch rate persisted.</p>\n<p>I also switched to an in-memory state store to verify if the issue is due to RocksDB. In this case the issue did not occur - consumer fetch rate increased to what I expected.</p>\n<p>I also tried less consumers with much less amount of data, and the issue remained.</p>\n<p>Q: What could cause the main stream consumers to remain slow after a RocksDB-backed GlobalKTable restore, and is there a RocksDB configuration or workaround to avoid this?</p>\n",
    "tags" : [ "java", "apache-kafka", "apache-kafka-streams", "rocksdb" ],
    "owner" : {
      "account_id" : 44155010,
      "reputation" : 1,
      "user_id" : 31605646,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5507cb6e0c8387d77190835966ad7cf7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sona Torosyan",
      "link" : "https://stackoverflow.com/users/31605646/sona-torosyan"
    },
    "is_answered" : false,
    "view_count" : 77,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1759340626,
    "creation_date" : 1759287171,
    "link" : "https://stackoverflow.com/questions/79779626/kafka-streams-main-consumer-fetch-rate-stays-low-after-globalktable-rocksdb-re",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}