{
  "question" : {
    "question_id" : 79615170,
    "title" : "401 code return when read mail by msal Credential Grant, the access token is correct and /users is success",
    "body" : "<p>I need read email from my hotmail account,my app is a daemon, so I use client secret mode to get tokens, yes, its success got token, and get /users is success also, however when i try to get /users/{id}/messages, code 401 response with empty body.</p>\n<p>Account type:\n<code>Accounts in any organizational directory (Any Microsoft Entra ID tenant - Multitenant) and personal Microsoft accounts (e.g. Skype, Xbox)</code></p>\n<pre><code>Access tokens (used for implicit flows)  ----- checked\nID tokens (used for implicit and hybrid flows)----- checked\n</code></pre>\n<p><a href=\"https://i.sstatic.net/Z4J0jEZm.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/Z4J0jEZm.png\" alt=\"Api permissions\" /></a></p>\n<p>I use {tenant} as my Tenant Id, not /common and others</p>\n<pre><code>// Copyright (c) Microsoft Corporation. All rights reserved.\n// Licensed under the MIT License.\n\nimport com.microsoft.aad.msal4j.ClientCredentialFactory;\nimport com.microsoft.aad.msal4j.ClientCredentialParameters;\nimport com.microsoft.aad.msal4j.ConfidentialClientApplication;\nimport com.microsoft.aad.msal4j.IAuthenticationResult;\nimport com.nimbusds.oauth2.sdk.http.HTTPResponse;\n\nimport java.io.BufferedReader;\nimport java.io.IOException;\nimport java.io.InputStreamReader;\nimport java.net.HttpURLConnection;\nimport java.net.URL;\nimport java.util.Collections;\nimport java.util.Properties;\nimport java.util.concurrent.CompletableFuture;\n\nclass ClientCredentialGrant {\n\nprivate static String authority;\nprivate static String clientId;\nprivate static String secret;\nprivate static String scope;\nprivate static ConfidentialClientApplication app;\n\npublic static void main(String args[]) throws Exception{\n\n    setUpSampleData();\n\n    try {\n        BuildConfidentialClientObject();\n        IAuthenticationResult result = getAccessTokenByClientCredentialGrant();\n        System.out.println(result.accessToken());\n        String usersListFromGraph = getUsersListFromGraph(result.accessToken());\n        System.out.println(&quot;Users in the Tenant = &quot; + usersListFromGraph);\n\n        String mailsListFromGraph = getEmailsFromGraph(result.accessToken());\n        System.out.println(&quot;Mails in the Tenant = &quot; + mailsListFromGraph);\n\n    } catch(Exception ex){\n        System.out.println(&quot;Oops! We have an exception of type - &quot; + ex.getClass());\n        System.out.println(&quot;Exception message - &quot; + ex.getMessage());\n        throw ex;\n    }\n}\nprivate static void BuildConfidentialClientObject() throws Exception {\n    \n    // Load properties file and set properties used throughout the sample\n    app = ConfidentialClientApplication.builder(\n            clientId,\n            ClientCredentialFactory.createFromSecret(secret))\n            .authority(authority)\n            .build();               \n}\n\nprivate static IAuthenticationResult getAccessTokenByClientCredentialGrant() throws Exception {\n    \n    // With client credentials flows the scope is ALWAYS of the shape &quot;resource/.default&quot;, as the\n    // application permissions need to be set statically (in the portal), and then granted by a tenant administrator\n    ClientCredentialParameters clientCredentialParam = ClientCredentialParameters.builder(\n            Collections.singleton(scope))\n            .build();\n    \n    CompletableFuture&lt;IAuthenticationResult&gt; future = app.acquireToken(clientCredentialParam);\n    return future.get();\n}\n\nprivate static String getUsersListFromGraph(String accessToken) throws IOException {\n    URL url = new URL(&quot;https://graph.microsoft.com/v1.0/users&quot;);\n    HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n\n    conn.setRequestMethod(&quot;GET&quot;);\n    conn.setRequestProperty(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);\n    conn.setRequestProperty(&quot;Accept&quot;,&quot;application/json&quot;);\n\n    int httpResponseCode = conn.getResponseCode();\n    if(httpResponseCode == HTTPResponse.SC_OK) {\n\n        StringBuilder response;\n        try(BufferedReader in = new BufferedReader(\n                new InputStreamReader(conn.getInputStream()))){\n\n            String inputLine;\n            response = new StringBuilder();\n            while (( inputLine = in.readLine()) != null) {\n                response.append(inputLine);\n            }\n        }\n        return response.toString();\n    } else {\n        return String.format(&quot;Connection returned HTTP code: %s with message: %s&quot;,\n                httpResponseCode, conn.getResponseMessage());\n    }\n}\n\n\nprivate static String getEmailsFromGraph(String accessToken) throws IOException {\n    URL url = new URL(&quot;https://graph.microsoft.com/v1.0/users/9dfb85a5-b8bb-4e7d-8e05-a60d418ca16d/messages?$select=sender,subject&quot;);\n    HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n\n    conn.setRequestMethod(&quot;GET&quot;);\n    conn.setRequestProperty(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);\n    conn.setRequestProperty(&quot;Accept&quot;,&quot;application/json&quot;);\n\n    int httpResponseCode = conn.getResponseCode();\n    if(httpResponseCode == HTTPResponse.SC_OK) {\n\n        StringBuilder response;\n        try(BufferedReader in = new BufferedReader(\n                new InputStreamReader(conn.getInputStream()))){\n\n            String inputLine;\n            response = new StringBuilder();\n            while (( inputLine = in.readLine()) != null) {\n                response.append(inputLine);\n            }\n        }\n        return response.toString();\n    } else {\n        return String.format(&quot;Connection returned HTTP code: %s with message: %s&quot;,\n                httpResponseCode, conn.getResponseMessage());\n    }\n}\n\n/**\n * Helper function unique to this sample setting. In a real application these wouldn't be so hardcoded, for example\n * different users may need different authority endpoints or scopes\n */\nprivate static void setUpSampleData() throws IOException {\n    // Load properties file and set properties used throughout the sample\n    Properties properties = new Properties();\n    properties.load(Thread.currentThread().getContextClassLoader().getResourceAsStream(&quot;application.properties&quot;));\n    authority = properties.getProperty(&quot;AUTHORITY&quot;);\n    clientId = properties.getProperty(&quot;CLIENT_ID&quot;);\n    secret = properties.getProperty(&quot;SECRET&quot;);\n    scope = properties.getProperty(&quot;SCOPE&quot;);\n}\n</code></pre>\n<p>}</p>\n<pre><code>token ... CXlTBW8OAh4HMED7UKSFqvuD_YSalGZ1tiSZwWRyNB-_Cn-jhAO1fDBuPPOKjrz8XOWAdQSa7ipGj4gTDiPwNeNdw4d2Qg7G4lny5D2Hav9BROxzQSx82eilA5w-qJOMaOuSLRHJTj1usFTnlCqaPoZWUQoF9v2AxqRBBMe105-nnZmSuoeiOobjFFtx8X8l4FaKACj4zwncW8igLsHSslU9YeQ_gXXVUiYgTEGhokMKj5IFSOMngiU2GuY4pVBWsHpHXKAilHXl5D2_pA\nUsers in the Tenant = {&quot;@odata.context&quot;:&quot;https://graph.microsoft.com/v1.0/$metadata#users&quot;,&quot;value&quot;:[{&quot;businessPhones&quot;:[],&quot;displayName&quot;:&quot;caron_liu&quot;, .... &quot;d418ca16d&quot;}]}\nMails in the Tenant = Connection returned HTTP code: 401 with message: Unauthorized\n</code></pre>\n<p>I donwload the sample code form github: <a href=\"https://github.com/Azure-Samples/ms-identity-java-daemon\" rel=\"nofollow noreferrer\">https://github.com/Azure-Samples/ms-identity-java-daemon</a></p>\n<p>Is there somebody help me? thanks.</p>\n",
    "tags" : [ "java", "azure", "microsoft-graph-api", "msal", "outlook-api" ],
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "is_answered" : true,
    "view_count" : 105,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1746935275,
    "creation_date" : 1746854338,
    "link" : "https://stackoverflow.com/questions/79615170/401-code-return-when-read-mail-by-msal-credential-grant-the-access-token-is-cor",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79616142,
    "question_id" : 79615170,
    "body" : "<p>Note that, you need <strong><a href=\"https://learn.microsoft.com/en-us/graph/api/message-get?view=graph-rest-1.0&amp;tabs=http#permissions:%7E:text=Delegated%20%28personal%20Microsoft%20account%29:%7E:text=Delegated%20(personal%20Microsoft%20account)\" rel=\"nofollow noreferrer\">Delegated</a></strong> type permissions to read mails of personal Microsoft accounts like Hotmail but client credential flow uses <strong>Application</strong> type permissions that won't work in your scenario.</p>\n<p>To resolve the error, you need to switch to <strong>delegated</strong> flow like interactive flow or authorization code flow by granting <em>Delegated</em> type permissions and use <code>/common</code> token endpoint as authority.</p>\n<p>Initially, I registered one application and granted <code>Mail.Read</code> permission of <strong>Delegated</strong> type with consent:</p>\n<p><a href=\"https://i.sstatic.net/tk56pjyf.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/tk56pjyf.png\" alt=\"enter image description here\" /></a></p>\n<p>Now, I added <strong>redirect URI</strong> as http://localhost in <em>Mobile and desktop applications</em> platform like this:</p>\n<p><a href=\"https://i.sstatic.net/ZVMYIsmS.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/ZVMYIsmS.png\" alt=\"enter image description here\" /></a></p>\n<p>Make sure to <strong>enable</strong> public client flow option that is required while using interactive flow:</p>\n<p><a href=\"https://i.sstatic.net/OlFmzkP1.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/OlFmzkP1.png\" alt=\"enter image description here\" /></a></p>\n<p>In my case, I used below code files that invokes interactive flow for token generation with <code>/common</code> endpoint and retrieves mail:</p>\n<p><strong>application.properties:</strong></p>\n<pre class=\"lang-none prettyprint-override\"><code>CLIENT_ID=yourAppId\nAUTHORITY=https://login.microsoftonline.com/common/  \nREDIRECT_URI=http://localhost  \nSCOPE=Mail.Read\n</code></pre>\n<p><strong>Main.java:</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport com.microsoft.aad.msal4j.*;\n\nimport java.io.BufferedReader;\nimport java.io.IOException;\nimport java.io.InputStream;\nimport java.io.InputStreamReader;\nimport java.net.HttpURLConnection;\nimport java.net.URI;\nimport java.net.URL;\nimport java.util.*;\nimport java.util.concurrent.*;\n\npublic class Main {\n\n    private static String clientId;\n    private static String authority;\n    private static String redirectUri;\n    private static String scope;\n\n    public static void main(String[] args) throws Exception {\n        loadConfig();\n\n        PublicClientApplication app = PublicClientApplication.builder(clientId)\n                .authority(authority)\n                .build();\n\n        Set&lt;String&gt; scopes = Collections.singleton(scope);\n        IAuthenticationResult result;\n\n        Optional&lt;IAccount&gt; firstAccount = app.getAccounts().get().stream().findFirst();\n        if (firstAccount.isPresent()) {\n            try {\n                SilentParameters silentParams = SilentParameters.builder(scopes, firstAccount.get()).build();\n                result = app.acquireTokenSilently(silentParams).get();\n                System.out.println(&quot;Token acquired silently.&quot;);\n            } catch (ExecutionException ex) {\n                System.out.println(&quot;Silent token acquisition failed: &quot; + ex.getCause().getMessage());\n                result = acquireInteractive(app, scopes);\n            }\n        } else {\n            result = acquireInteractive(app, scopes);\n        }\n\n        System.out.println(&quot;Access Token:\\n&quot; + result.accessToken());\n\n        String emailsJson = getEmailsFromGraph(result.accessToken());\n        System.out.println(&quot;\\nInbox Messages:\\n&quot;);\n\n        String[] items = emailsJson.split(&quot;\\&quot;subject\\&quot;&quot;);\n        for (int i = 1; i &lt; items.length; i++) {\n            if (!items[i].contains(&quot;\\&quot;name\\&quot;&quot;) || !items[i].contains(&quot;\\&quot;address\\&quot;&quot;)) {\n                continue;\n            }\n\n            String subject = items[i].split(&quot;,&quot;)[0].split(&quot;:&quot;)[1].replace(&quot;\\&quot;&quot;, &quot;&quot;);\n            String senderName = items[i].split(&quot;\\&quot;name\\&quot;:\\&quot;&quot;)[1].split(&quot;\\&quot;&quot;)[0];\n            String senderEmail = items[i].split(&quot;\\&quot;address\\&quot;:\\&quot;&quot;)[1].split(&quot;\\&quot;&quot;)[0];\n\n            System.out.println(&quot;Subject : &quot; + subject);\n            System.out.println(&quot;From    : &quot; + senderName + &quot; &lt;&quot; + senderEmail + &quot;&gt;&quot;);\n            System.out.println();\n        }\n    }\n\n    private static IAuthenticationResult acquireInteractive(PublicClientApplication app, Set&lt;String&gt; scopes) throws Exception {\n        InteractiveRequestParameters parameters = InteractiveRequestParameters.builder(new URI(redirectUri)).scopes(scopes).build();\n        return app.acquireToken(parameters).get();\n    }\n\n    private static String getEmailsFromGraph(String accessToken) throws IOException {\n        URL url = new URL(&quot;https://graph.microsoft.com/v1.0/me/messages?$select=subject,sender&quot;);  \n        HttpURLConnection conn = (HttpURLConnection) url.openConnection();\n        conn.setRequestMethod(&quot;GET&quot;);\n        conn.setRequestProperty(&quot;Authorization&quot;, &quot;Bearer &quot; + accessToken);\n        conn.setRequestProperty(&quot;Accept&quot;, &quot;application/json&quot;);\n\n        int responseCode = conn.getResponseCode();\n        if (responseCode == 200) {\n            BufferedReader in = new BufferedReader(new InputStreamReader(conn.getInputStream()));\n            StringBuilder content = new StringBuilder();\n            String line;\n            while ((line = in.readLine()) != null) {\n                content.append(line);\n            }\n            in.close();\n            return content.toString();\n        } else {\n            return &quot;Error: &quot; + responseCode + &quot; - &quot; + conn.getResponseMessage();\n        }\n    }\n\n    private static void loadConfig() throws IOException {\n        Properties props = new Properties();\n        try (InputStream input = Thread.currentThread().getContextClassLoader().getResourceAsStream(&quot;application.properties&quot;)) {\n            props.load(input);\n        }\n        clientId = props.getProperty(&quot;CLIENT_ID&quot;);\n        authority = props.getProperty(&quot;AUTHORITY&quot;);\n        redirectUri = props.getProperty(&quot;REDIRECT_URI&quot;);\n        scope = props.getProperty(&quot;SCOPE&quot;);\n    }\n}\n</code></pre>\n<p><strong>Response:</strong></p>\n<p><a href=\"https://i.sstatic.net/lQsnCSZ9.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/lQsnCSZ9.png\" alt=\"enter image description here\" /></a></p>\n<p><strong>Reference:</strong></p>\n<p><a href=\"https://learn.microsoft.com/en-us/entra/identity-platform/v2-protocols#endpoints\" rel=\"nofollow noreferrer\">OAuth 2.0 Token Endpoints - Microsoft identity platform</a></p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 24067318,
      "reputation" : 23624,
      "user_id" : 18043665,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/31XZp.jpg?s=256",
      "display_name" : "Sridevi",
      "link" : "https://stackoverflow.com/users/18043665/sridevi"
    },
    "creation_date" : 1746935275,
    "last_activity_date" : 1746935275,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140416388,
    "post_id" : 79615170,
    "body" : "Got it, thanks for your help, guys",
    "score" : 1,
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "creation_date" : 1747012575,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140414665,
    "post_id" : 79615170,
    "body" : "You cannot read mails of hotmail account using token generated with client credentials flow. Client credentials flow uses <code>Application</code> type permission whereas reading <b>personal Microsoft account</b> mail requires <code>Delegated</code> type permissions where user must sign in at least once. Refer this <a href=\"https://learn.microsoft.com/en-us/graph/api/message-get?view=graph-rest-1.0&amp;tabs=http#permissions\" rel=\"nofollow noreferrer\">learn.microsoft.com/en-us/graph/api/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 24067318,
      "reputation" : 23624,
      "user_id" : 18043665,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/31XZp.jpg?s=256",
      "display_name" : "Sridevi",
      "link" : "https://stackoverflow.com/users/18043665/sridevi"
    },
    "creation_date" : 1746930455,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79616142" : [ {
      "comment_id" : 140416391,
      "post_id" : 79616142,
      "body" : "Thanks very much for  your help, Successfully got it, thanks again.",
      "score" : 1,
      "owner" : {
        "account_id" : 2285518,
        "reputation" : 25,
        "user_id" : 2009576,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
        "display_name" : "Leo",
        "link" : "https://stackoverflow.com/users/2009576/leo"
      },
      "creation_date" : 1747012613,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}