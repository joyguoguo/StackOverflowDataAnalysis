{
  "question" : {
    "question_id" : 79663171,
    "title" : "Intercepting worker thread in smallrye incoming channel",
    "body" : "<p>We are using Quarkus 3.15.3.1, Java 21 and JSONata4Java version 2.5.1. We want to optimize JSONata usage, so we prepare expressions for JSONata transformations like this</p>\n<pre><code>Map&lt;String, Expressions&gt; preparedExpressions = new ConcurrentHashMap&lt;&gt;();\n...\nExpressions expression = Expressions.parse(transformation);\npreparedExpressions.put(key, expression);\n</code></pre>\n<p>Then we use that prepared expressions in our incoming channels, which are processed concurrently (smallrye library should initiate worker threads if I understand it correctly).</p>\n<pre><code>@Blocking(ordered = false, value = &quot;custom-parallel-pool&quot;)\n@Incoming(&quot;incoming-channel&quot;)\n@Outgoing(&quot;outgoing-channel&quot;)\n@Acknowledgment(MANUAL)\npublic Message&lt;String&gt; consume(Message&lt;ConsumerRecord&lt;String, Object&gt;&gt; message) {\n    ...\n    Expression expression = preparedExpressions.get(key);\n    JsonNode result = expression.evaluate(incomingJsonNode);\n    ...\n}\n</code></pre>\n<p>However, JSONata4Java library doesn't work well multithreaded, as the Expressions class is some working class storing the traversal tree when going through the JSON and thus is overwritten by other threads. We see a possible solution by having a separate Expressions instance per each thread which would be stored into the preparedExpressions map by including the thread name in the key string so a new thread would create its own Expressions instance.</p>\n<p>But we have a problem with removal of old entries in the preparedExpressions map when some worker thread's life would come to an end. Is there some way to intercept the worker thread removal? We would use the worker thread name and search for all keys in the preparedExpressions map that would contain the thread name to be removed from the map so garbage collector would get rid of the old objects.</p>\n<p>Or do you know about any other solution? I have also tried to search for other libary, but dash-join library (although having better memory management) was much slower as per processing time point of view.</p>\n",
    "tags" : [ "java", "multithreading", "quarkus", "jsonata", "smallrye" ],
    "owner" : {
      "account_id" : 24292914,
      "reputation" : 11,
      "user_id" : 18237580,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJzYL4gkdEaiogmW9-6SfvbQmvHc7ktwpNiiEdnq=k-s256",
      "display_name" : "Matej Lipt&#225;k",
      "link" : "https://stackoverflow.com/users/18237580/matej-lipt%c3%a1k"
    },
    "is_answered" : false,
    "view_count" : 30,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1749716958,
    "creation_date" : 1749716958,
    "link" : "https://stackoverflow.com/questions/79663171/intercepting-worker-thread-in-smallrye-incoming-channel",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}