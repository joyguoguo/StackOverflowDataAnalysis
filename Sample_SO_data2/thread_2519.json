{
  "question" : {
    "question_id" : 79617789,
    "title" : "Force Spring to cache lazy prototype beans injected into singleton beans",
    "body" : "<p>Is there a way to force Spring to cache <code>prototype</code> beans in <code>LazyDependencyTargetSource</code>? As far as I know, it only caches singletons.</p>\n<p>I have a lazy <code>prototype</code> bean, that I want to inject into a singleton bean.</p>\n<p>Spring injects a proxy (that is fine), but the proxy creates a new target bean on each access. Normally, when a <code>prototype</code> bean is injected into a singleton bean, this happens only once.</p>\n<p>However, with the lazy proxy, the relatively expensive creation of the <code>prototype</code> bean occurs multiple times even for successive method calls.</p>\n<p>Custom annotation:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Target({ElementType.FIELD, ElementType.PARAMETER, ElementType.ANNOTATION_TYPE})\n@Retention(RetentionPolicy.RUNTIME)\n@Documented\n@Value(&quot;#{&quot; + &quot;getCache&quot; + &quot;}&quot;) // there are other reasons why this is necessary\n@Lazy\npublic @interface CacheAnnotation {\n    String value() default &quot;&quot;;\n}\n</code></pre>\n<p>Creating a new bean is far more complex in my case.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class CacheConfiguration {\n    @Bean\n    @Primary\n    @Scope(BeanDefinition.SCOPE_PROTOTYPE)\n    public Cache getCache() {\n        System.out.println(&quot;Creating a new bean...&quot;);\n        return new Cache();\n    }\n}\n</code></pre>\n<p>Controller:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@RestController\n@RequestMapping(path = &quot;/api/cache&quot;)\npublic class NullController {\n    @CacheAnnotation(&quot;something&quot;)\n    private Cache cache;\n\n    @GetMapping\n    public String getCache() {\n        cache.toString();\n        cache.toString();\n        cache.toString();\n        cache.toString();\n        cache.toString();\n        return &quot;&quot;;\n    }\n}\n</code></pre>\n<p>Hitting this REST endpoint prints</p>\n<blockquote>\n<p><code>Creating a new bean...</code></p>\n</blockquote>\n<p>five times.</p>\n<p>To work around this, I created a custom <code>BeanPostProcessor</code> that injects a caching proxy into fields and methods. I also had to create a <code>BeanFactoryPostProcessor</code> to enable caching proxy injection into constructors, but there are many moving parts involved. I would prefer to fix the original issue in a simpler way, if possible.</p>\n",
    "tags" : [ "java", "spring" ],
    "owner" : {
      "account_id" : 5564,
      "reputation" : 579,
      "user_id" : 9026,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/146f513464d0f25757c5a0303e02b847?s=256&d=identicon&r=PG",
      "display_name" : "vasac",
      "link" : "https://stackoverflow.com/users/9026/vasac"
    },
    "is_answered" : false,
    "view_count" : 51,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747124102,
    "creation_date" : 1747050873,
    "link" : "https://stackoverflow.com/questions/79617789/force-spring-to-cache-lazy-prototype-beans-injected-into-singleton-beans",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140421940,
    "post_id" : 79617789,
    "body" : "Read the documentation please. <a href=\"https://docs.spring.io/spring-framework/reference/core/beans/factory-scopes.html\" rel=\"nofollow noreferrer\">docs.spring.io/spring-framework/reference/core/beans/&hellip;</a> the default scope of a bean on Spring is Singleton",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1747148809,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140420507,
    "post_id" : 79617789,
    "body" : "@JorgeCampos - because bean isn&#39;t a singleton - there will be many different caches. I can not use request scope as caches can be used in non-web apps.",
    "score" : 0,
    "owner" : {
      "account_id" : 5564,
      "reputation" : 579,
      "user_id" : 9026,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/146f513464d0f25757c5a0303e02b847?s=256&d=identicon&r=PG",
      "display_name" : "vasac",
      "link" : "https://stackoverflow.com/users/9026/vasac"
    },
    "creation_date" : 1747124145,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140420161,
    "post_id" : 79617789,
    "body" : "Feels like you are trying to fix a lifecycle problem in the wrong way. If the beans are needed in the configuration then that should be made explicit so Spring knows beforehand what to create when. Ideally you do this by putting the dependencies into the method signatures and not as autowired fields.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1747115053,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418773,
    "post_id" : 79617789,
    "body" : "So why not a simple bean (Singleton) with @Lazy (annotation) then? Or Request scoped?",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1747068310,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418668,
    "post_id" : 79617789,
    "body" : "@JorgeCampos I need to cache it because creating a new bean in my case is expensive operation. I want it injected only once into other beans (once that NullController from the example gets created), not on each method call. Simply, I have a prototype bean that I want to instantiate once per injection point, not each time some method is being called on it. And it has to be lazy as otherwise deadlock can happen.",
    "score" : 0,
    "owner" : {
      "account_id" : 5564,
      "reputation" : 579,
      "user_id" : 9026,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/146f513464d0f25757c5a0303e02b847?s=256&d=identicon&r=PG",
      "display_name" : "vasac",
      "link" : "https://stackoverflow.com/users/9026/vasac"
    },
    "creation_date" : 1747066257,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418650,
    "post_id" : 79617789,
    "body" : "@M.Deinum - it&#39;s lazy because if it is not lazy then in certain cases (legitimate ones) it can cause a deadlock (cache bean expects other beans to be injected in its configuration). If it wasn&#39;t lazy Spring would inject this prototype bean once into singleton and call it a day, which is kinda behaviour I&#39;m looking for (except for a lazy part).",
    "score" : 0,
    "owner" : {
      "account_id" : 5564,
      "reputation" : 579,
      "user_id" : 9026,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/146f513464d0f25757c5a0303e02b847?s=256&d=identicon&r=PG",
      "display_name" : "vasac",
      "link" : "https://stackoverflow.com/users/9026/vasac"
    },
    "creation_date" : 1747065921,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418590,
    "post_id" : 79617789,
    "body" : "Why do you think you need to cache a prototype bean? It is behaving exactly as <a href=\"https://docs.spring.io/spring-framework/reference/core/beans/factory-scopes.html#beans-factory-scopes-prototype\" rel=\"nofollow noreferrer\">it was designed</a> You should first explain what you are trying to achieve rather than looking for a solution you think is the correct one. Classical <a href=\"https://xyproblem.info\" rel=\"nofollow noreferrer\">xyproblem.info</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1747065044,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140417775,
    "post_id" : 79617789,
    "body" : "Which is basically what I would expect to happen with a scoped prototype bean. Why is it lazy to start with?",
    "score" : 1,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1747051528,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}