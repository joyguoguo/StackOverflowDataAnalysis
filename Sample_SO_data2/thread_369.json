{
  "question" : {
    "question_id" : 79806469,
    "title" : "PKCS11 error at KeyStore.getEntry(alias, null) at Java 22 statement",
    "body" : "<p>I'm developing SOAP envelope signing code in a Java environment. My code running properly when I use the RSA_SHA256 signature algorithm with proper smart card based pkcs11. I have another smart card prepared usage with SHA384withECDSA signature algorithm (Elliptic Curve).</p>\n<p>My java code gets an error at statement <code>KeyStore.Entry entry = ks.getEntry(alias, null);</code>.</p>\n<p>I'm using Java 22. I think Java 22 has a bug with elliptic curve cryptography. Do you have any experience with this? How can I fix the error?</p>\n<p>Error related code part:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class App \n{\n    public static String pin;\n    \n    static CallbackHandler handler = callbacks -&gt; {\n        for (Callback cb : callbacks) {\n            if (cb instanceof PasswordCallback) {\n                ((PasswordCallback) cb).setPassword(pin.toCharArray());\n            } else {\n                System.out.println(&quot;CallbackHandler hatasÄ±&quot;);\n                throw new UnsupportedCallbackException(cb);\n            }\n        }\n    };\n\n    public static void main(String[] args) throws Exception {\n        \n\n    try{\n        String pkcs11DriverPath = &quot;C:/Windows/System32/akisp11.dll&quot;;\n        String alias = &quot;1234567891ABCD&quot;;\n        String certSerial = &quot;112233445678934567&quot;;\n        String Slot = getSlot(certSerial);\n        pin = &quot;123456&quot;; \n            \n        Provider pkcs11Provider = createPkcs11Provider(pkcs11DriverPath, Slot);\n        \n        Security.addProvider(pkcs11Provider);\n\n        KeyStore.Builder builder = KeyStore.Builder.newInstance(&quot;PKCS11&quot;, pkcs11Provider, new KeyStore.CallbackHandlerProtection(handler));\n\n        KeyStore ks = builder.getKeyStore();                \n            \n        ks.load(null, pin.toCharArray());   \n                \n        KeyStore.Entry entry = ks.getEntry(alias, null);\n        \n        .....\n        .....\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n    }\n    \n    private static Provider createPkcs11Provider(String pkcs11Path, String slot) throws Exception {\n\n        Provider configured_p = null;\n        try {\n\n            String config = &quot;name = pkcs11SmartCard\\n&quot; + &quot;library = &quot; + libraryPath + &quot;\\n&quot; + &quot;slot = &quot; + slot + &quot;\\n&quot;;           \n\n            java.nio.file.Path tmpCfg = java.nio.file.Files.createTempFile(&quot;pkcs11-&quot;, &quot;.cfg&quot;);\n\n            java.nio.file.Files.write(tmpCfg, config.getBytes(java.nio.charset.StandardCharsets.UTF_8));\n\n            Provider p = Security.getProvider(&quot;SunPKCS11&quot;);\n\n            if (p == null) {\n                throw new RuntimeException(&quot;SunPKCS11 provider not available in this JDK.&quot;);\n            }\n\n            configured_p = p.configure(tmpCfg.toAbsolutePath().toString());\n\n        } catch (Exception e) {\n            e.printStackTrace();\n        }\n        return configured_p;\n    }\n    \n    public static String getSlot(String cert_sn) {\n        String slot = &quot;&quot;;\n        try {\n        ......\n        ......\n            return slot;\n    \n        } catch (Exception e) {\n            e.printStackTrace();\n            return null;\n        }\n    }\n    ...\n    ...\n}\n</code></pre>\n<p><strong>Error</strong></p>\n<pre class=\"lang-none prettyprint-override\"><code>java.security.KeyStoreException: Unsupported parameters\n    at jdk.crypto.cryptoki/sun.security.pkcs11.P11KeyStore.loadPkey(P11KeyStore.java:1385)\n    at jdk.crypto.cryptoki/sun.security.pkcs11.P11KeyStore.engineGetEntry(P11KeyStore.java:971)\n    at java.base/java.security.KeyStore.getEntry(KeyStore.java:1575)\n    at pkt.mvn.App.main(App.java:269)\nCaused by: java.io.IOException: Only named ECParameters supported\n    at java.base/sun.security.util.ECParameters.engineInit(ECParameters.java:149)\n    at java.base/java.security.AlgorithmParameters.init(AlgorithmParameters.java:311)\n    at java.base/sun.security.util.ECUtil.getECParameterSpec(ECUtil.java:190)\n    at jdk.crypto.cryptoki/sun.security.pkcs11.P11KeyStore.loadPkey(P11KeyStore.java:1381)\n</code></pre>\n",
    "tags" : [ "java", "keystore", "pkcs#11", "elliptic-curve" ],
    "owner" : {
      "account_id" : 31235712,
      "reputation" : 11,
      "user_id" : 24040072,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3bd7e8cf6ab3d2428520f797a5c11019?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cemil Bozlagan",
      "link" : "https://stackoverflow.com/users/24040072/cemil-bozlagan"
    },
    "is_answered" : false,
    "view_count" : 69,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762181989,
    "creation_date" : 1761992407,
    "link" : "https://stackoverflow.com/questions/79806469/pkcs11-error-at-keystore-getentryalias-null-at-java-22-statement",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79807995,
    "question_id" : 79806469,
    "body" : "<p>This could be &quot;not-related&quot; to your inquiry, but i've ran into problems with new cards which only support EC and not RSA and had to do a proper division and find which card i'm working with before doing anything with them, here's the code excerpt that i hope can be useful for you:</p>\n<pre><code>XMLSignatureFactory fac;\nfac = XMLSignatureFactory.getInstance(&quot;DOM&quot;);\n\nKeyStore.Builder builder = KeyStore.Builder.newInstance(&quot;PKCS11&quot;, providerPKCS11, new KeyStore.CallbackHandlerProtection(cmdLineHdlr));\n\nKeyStore keystore = builder.getKeyStore();\nKey key1 = keystore.getKey(assinaturaCertifLabel1, null);\n\nif (&quot;RSA&quot;.equalsIgnoreCase(key1.getAlgorithm())) {\n    System.out.println(&quot;I AM RSA AND GOING&quot;);\n\n    signedInfo = fac.newSignedInfo(\n        fac.newCanonicalizationMethod(\n            CanonicalizationMethod.EXCLUSIVE, // CanonicalizationMethod.EXCLUSIVE_WITH_COMMENTS,\n            (C14NMethodParameterSpec) null\n        ),\n        fac.newSignatureMethod(\n            &quot;http://www.w3.org/2001/04/xmldsig-more#rsa-sha256&quot;,\n            null\n        ),\n        Collections.singletonList(ref)\n    );\n\n} else if (&quot;EC&quot;.equals(key1.getAlgorithm())) {\n    System.out.println(&quot;I AM EC AND GOING&quot;);\n\n    signedInfo = fac.newSignedInfo(\n        fac.newCanonicalizationMethod(\n            CanonicalizationMethod.EXCLUSIVE, // CanonicalizationMethod.EXCLUSIVE_WITH_COMMENTS,\n            (C14NMethodParameterSpec) null\n        ),\n        fac.newSignatureMethod(\n            &quot;http://www.w3.org/2001/04/xmldsig-more#ecdsa-sha256&quot;,\n            null\n        ),\n        Collections.singletonList(ref)\n    );\n\n} else {\n    throw new InvalidAlgorithmParameterException(&quot;ALGORITHM IS NOT RSA OR EC&quot;);\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1340191,
      "reputation" : 45,
      "user_id" : 1282015,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/0538e3b936bb975512fda8f68da3db1f?s=256&d=identicon&r=PG",
      "display_name" : "Fabio Abreu",
      "link" : "https://stackoverflow.com/users/1282015/fabio-abreu"
    },
    "creation_date" : 1762181989,
    "last_activity_date" : 1762181989,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140832060,
    "post_id" : 79806469,
    "body" : "I tested with jdk 24. Same error occurs.",
    "score" : 0,
    "owner" : {
      "account_id" : 31235712,
      "reputation" : 11,
      "user_id" : 24040072,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3bd7e8cf6ab3d2428520f797a5c11019?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cemil Bozlagan",
      "link" : "https://stackoverflow.com/users/24040072/cemil-bozlagan"
    },
    "creation_date" : 1762086491,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140831965,
    "post_id" : 79806469,
    "body" : "<i>&quot;Only named ECParameters supported&quot;</i> sounds like your key has parameters that aren&#39;t supported. And as aled says, don&#39;t use Java 22.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1762080969,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140830958,
    "post_id" : 79806469,
    "body" : "JDK 22 was End of Life in 2024.is there any reason to use that specific version? If you want to check if there is any bug fix try with newer supported versions. LTS versions are recommended.",
    "score" : 2,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1762008125,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79807995" : [ {
      "comment_id" : 140835064,
      "post_id" : 79807995,
      "body" : "Thanks for your sharing Fabio, but my code stucks at statement &quot;Key key1 = keystore.getKey(certAlias, null);&quot;. Gets &quot;unsupported parameters&quot; error. I think it can be related with config of pkcs11 provider definition.",
      "score" : 0,
      "owner" : {
        "account_id" : 31235712,
        "reputation" : 11,
        "user_id" : 24040072,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3bd7e8cf6ab3d2428520f797a5c11019?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Cemil Bozlagan",
        "link" : "https://stackoverflow.com/users/24040072/cemil-bozlagan"
      },
      "creation_date" : 1762241617,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}