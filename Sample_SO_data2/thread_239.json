{
  "question" : {
    "question_id" : 79819222,
    "title" : "Mockito MockStatic behavior leaking to other junit tests",
    "body" : "<p>I am using Mockito 5.20.0 to mock a static method, but the mock is not correctly closing / the mocked behavior is leaking outside of the tests it is intended to apply to. This is only a problem if <code>MyMockedTest</code> runs before <code>MyUnmockedTest</code>. If <code>MyUnmockedTest</code> runs first, there is no problem and both test classes pass. From what I can tell, the try-with-resources should be closing and un-mocking <code>MyUtil</code> when <code>MyMockedTest::testStuff</code> is complete, and the mocked behavior should not carry over to another class.</p>\n<p>I have run the tests both in IntelliJ and with <code>./gradlew clean build test</code>. The tests do not run in parallel.</p>\n<p>Illustrative example code with details redacted, hopefully it communicates the gist of what's going on:</p>\n<pre><code>public class MyUtil {\n    public static DBConnection getMyDbConnection() {\n        // ....\n        // The other code here makes a network call\n        return new DBConnection();\n    }\n}\n\n\nimport org.mockito.MockedStatic;\n\nimport static org.mockito.Mockito.*;\n\npublic class MyMockedTest {\n    @ParameterizedTest\n    @EnumSource(value = Source.class, names = {&quot;SOURCE_ONE&quot;, &quot;SOURCE_TWO&quot;})\n    public void testStuff() {\n        // MyUtil has several methods called, and I only want to change the behavior of \n        // getMyDbConnection.\n        try (MockedStatic&lt;MyUtil&gt; myUtilMockedStatic = mockStatic(MyUtil.class, CALLS_REAL_METHODS)) {\n            DBConnection dbConnection = mock(DBConnection.class);\n            when(dbConnection.getConnectionName()).thenReturn(&quot;myConnection&quot;);\n            myUtilMockedStatic.when(MyUtil::getMyDbConnection).thenReturn(redshiftConnection);\n            // MyUtil.getMyDbConnection() is called downstream in code under test\n            MyFirstClass myFirstClass = new MyFirstClass();\n            DBConnection results = myFirstClass.getDbConnection()\n            // Assertion passes \n            assertEquals(results.getDbConnection().getConnectionName(), &quot;myConnection&quot;);\n        }\n    }\n}\n\npublic class MyUnmockedTest {\n    @ParameterizedTest\n    @EnumSource(value = Source.class, names = {&quot;SOURCE_ONE&quot;, &quot;SOURCE_TWO&quot;})\n    public void testStuffWithoutMockedUtils() {\n        MyOtherClass myOtherClass = new MyOtherClass();\n        // MyUtil.getMyDbConnection() is called downstream in code under test\n        DBConnection results = myOtherClass.getDbConnection();\n        // Assertion fails, because the downstream MyUtil.getMyDbConnection() is still returning the mocked DBConnection.\n        assertNotEquals(results.getDbConnection().getConnectionName(), &quot;myConnection&quot;);\n    }\n}\n</code></pre>\n<p>Relevant <code>build.gradle</code> Test configuration:</p>\n<pre><code>test {\n    useJUnitPlatform {\n        includeEngines &quot;jqwik&quot;, &quot;junit-jupiter&quot;\n    }\n\n    include &quot;**/*Test.class&quot;\n}\n\n\nconfigurations {\n    mockitoAgent\n}\n\ndependencies {\n    // ...\n    testImplementation &quot;org.junit.jupiter:junit-jupiter-api:6.0.1&quot;\n    testImplementation &quot;org.junit.jupiter:junit-jupiter-params:6.0.1&quot;\n    testRuntimeOnly &quot;org.junit.jupiter:junit-jupiter-engine:6.0.1&quot;\n    testRuntimeOnly &quot;org.junit.platform:junit-platform-launcher:1.13.4&quot;\n    testImplementation &quot;net.jqwik:jqwik:1.9.3&quot;\n    testImplementation &quot;org.wiremock:wiremock:3.13.1&quot;\n    testImplementation &quot;org.mockito:mockito-core:5.20.0&quot;\n    testImplementation &quot;org.mockito:mockito-junit-jupiter:5.20.0&quot;\n    mockitoAgent(&quot;org.mockito:mockito-core:5.20.0&quot;) {\n        transitive = false\n    }\n    // ...\n}\n\ntasks {\n    test {\n        jvmArgs += &quot;-javaagent:${configurations.mockitoAgent.asPath}&quot;\n    }\n}\n\ntest {\n    environment &quot;ENVIRONMENT&quot;, &quot;test&quot;\n\n    testLogging {\n        exceptionFormat = 'full'\n        showStandardStreams = true\n        events &quot;passed&quot;, &quot;skipped&quot;, &quot;failed&quot;\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "testing", "junit", "mockito", "junit5" ],
    "owner" : {
      "account_id" : 2864110,
      "reputation" : 596,
      "user_id" : 2458755,
      "user_type" : "registered",
      "accept_rate" : 84,
      "profile_image" : "https://www.gravatar.com/avatar/83ab5b95215907c328e37b2f996fc293?s=256&d=identicon&r=PG",
      "display_name" : "PunDefeated",
      "link" : "https://stackoverflow.com/users/2458755/pundefeated"
    },
    "is_answered" : false,
    "view_count" : 55,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1763062789,
    "creation_date" : 1763054404,
    "link" : "https://stackoverflow.com/questions/79819222/mockito-mockstatic-behavior-leaking-to-other-junit-tests",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140853093,
    "post_id" : 79819222,
    "body" : "@Mureinik I&#39;m currently having trouble paring it down to a minimal reproducible example given the size of the project. I&#39;ll update the question if I can figure it out.",
    "score" : 0,
    "owner" : {
      "account_id" : 2864110,
      "reputation" : 596,
      "user_id" : 2458755,
      "user_type" : "registered",
      "accept_rate" : 84,
      "profile_image" : "https://www.gravatar.com/avatar/83ab5b95215907c328e37b2f996fc293?s=256&d=identicon&r=PG",
      "display_name" : "PunDefeated",
      "link" : "https://stackoverflow.com/users/2458755/pundefeated"
    },
    "creation_date" : 1763063550,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140853076,
    "post_id" : 79819222,
    "body" : "Can you share a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>?",
    "score" : 0,
    "owner" : {
      "account_id" : 2818342,
      "reputation" : 315931,
      "user_id" : 2422776,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2353050223ebecb113741c29458de4b2?s=256&d=identicon&r=PG",
      "display_name" : "Mureinik",
      "link" : "https://stackoverflow.com/users/2422776/mureinik"
    },
    "creation_date" : 1763062498,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140853002,
    "post_id" : 79819222,
    "body" : "Do your unit tests run in parallel in any way, even for a small overlap? Also <a href=\"https://stackoverflow.com/posts/79819222/edit\">edit</a> your question to include a detailed description how exactly you run your unit tests and how you execution of the unit tests is configured.",
    "score" : 0,
    "owner" : {
      "account_id" : 108033,
      "reputation" : 20099,
      "user_id" : 286934,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f16a184d26b72795ff243464d715cffe?s=256&d=identicon&r=PG",
      "display_name" : "Progman",
      "link" : "https://stackoverflow.com/users/286934/progman"
    },
    "creation_date" : 1763058845,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}