{
  "question" : {
    "question_id" : 79808212,
    "title" : "How to audit @ElementCollection of Value Objects without ID?",
    "body" : "<p>I am trying to audit a @ElementCollection of value objects (@Embeddable) using Hibernate Envers (Hibernate 6.x, ValidityAuditStrategy).\nBecause it's DDD, the value object must not have its own @Id.\nBut Hibernate Envers seems unable to track changes correctly without a primary key.</p>\n<p>When I update the parent, Envers throws errors like:</p>\n<blockquote>\n<p>ERROR: duplicate key value violates unique constraint &quot;..._pkey&quot;<br />\nERROR: column ... &quot;revend&quot; does not exist</p>\n</blockquote>\n<p>We tried the common workaround with @OrderColumn / SETORDINAL, but it does not solve the problem — Envers still tries to insert duplicates for the same (owner_id, rev, setordinal).</p>\n<pre><code>@Entity\n@Audited\nclass ParentEntity {\n\n    @Id\n    private Long id;\n\n    @ElementCollection\n    @OrderColumn(name = &quot;position&quot;)\n    @CollectionTable(name = &quot;parent_values&quot;,\n        joinColumns = @JoinColumn(name = &quot;parent_id&quot;))\n    private List&lt;ValueObject&gt; values = new ArrayList&lt;&gt;();\n}\n@Embeddable\n@Audited\nclass ValueObject {\n\n    private String propertyA;\n    private Integer propertyB;\n\n    // equals/hashCode implemented based on all fields\n}\n</code></pre>\n<p>What we tried / already know</p>\n<ul>\n<li>Using @OrderColumn so that Envers has a stable key</li>\n<li>Added integer ordinal column (position), similar to workaround described here:\n<a href=\"https://stackoverflow.com/questions/16507596\">Auditing @ElementCollection/@Embeddable with hibernate-envers</a></li>\n<li>Proper equals/hashCode on ValueObject (@EqualsAndHashCode)</li>\n<li>List instead of Set (as Set lost ordering in DB)</li>\n<li>Using ValidityAuditStrategy</li>\n</ul>\n<p>Is there any supported way to audit mutable @ElementCollection of @Embeddable without introducing a synthetic @Id on the value object?</p>\n<p>Or is Envers fundamentally relying on a technical identifier for collection auditing under ValidityAuditStrategy?</p>\n<p>Any real working example or recommended design alternative is appreciated.</p>\n",
    "tags" : [ "java", "hibernate-envers" ],
    "owner" : {
      "account_id" : 14195569,
      "reputation" : 906,
      "user_id" : 10254976,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-LBKWMRbnsJE/AAAAAAAAAAI/AAAAAAAAAAA/APUIFaN5MFh2qq87AeYj-As-DJbY0Opi0g/mo/s256-rj/photo.jpg",
      "display_name" : "Самир Шахмурадлы",
      "link" : "https://stackoverflow.com/users/10254976/%d0%a1%d0%b0%d0%bc%d0%b8%d1%80-%d0%a8%d0%b0%d1%85%d0%bc%d1%83%d1%80%d0%b0%d0%b4%d0%bb%d1%8b"
    },
    "is_answered" : false,
    "view_count" : 48,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762251264,
    "creation_date" : 1762195748,
    "link" : "https://stackoverflow.com/questions/79808212/how-to-audit-elementcollection-of-value-objects-without-id",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79808325,
    "question_id" : 79808212,
    "body" : "<p>Envers might use the stable ValueObject.id as the primary identifier to track changes, completely bypassing the composite key issue with @ElementCollection</p>\n<pre><code>@Entity\n@Audited\nclass ValueObject {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n    \n    private String propertyA;\n    private Integer propertyB;\n}\n\n@Entity\n@Audited\nclass ParentEntity {\n    @Id\n    private Long id;\n\n    @OneToMany(cascade = CascadeType.ALL, orphanRemoval = true)\n    @JoinColumn(name = &quot;parent_id&quot;)\n    @OrderColumn(name = &quot;position&quot;)\n    private List&lt;ValueObject&gt; values = new ArrayList&lt;&gt;();\n}\n</code></pre>\n<p>Changed @Embeddable to @Entity</p>\n<p>Added @GeneratedValue</p>\n<p>Changed @ElementCollection to @OneToMany</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 17553626,
      "reputation" : 521,
      "user_id" : 12733532,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-EAww28wDCxk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcgKS9dXdmUh-hOQPlZYZygBUfLwQ/s256-rj/photo.jpg",
      "display_name" : "Max",
      "link" : "https://stackoverflow.com/users/12733532/max"
    },
    "creation_date" : 1762204622,
    "last_activity_date" : 1762204622,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}