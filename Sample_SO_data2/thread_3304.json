{
  "question" : {
    "question_id" : 79560237,
    "title" : "Issuer validation failed. Issuer did not match. Azure BlobContainerClient",
    "body" : "<p>I am trying to upload to azure blob storage. I have successfully uploaded using the azure cli:</p>\n<pre><code>az login --service-principal -u &lt;clientId&gt; -p &lt;clientSecret&gt; --tenant &lt;tenantId&gt; &amp;&amp; \naz storage blob upload \\\n  --container-name &quot;\\$web&quot; \\\n  --account-name &lt;accountName&gt; \\\n  --name test.txt \\\n  --file test.txt \\\n  --auth-mode login\n</code></pre>\n<p>But when I attempt to upload with the same credentials from my application, using the <code>BlobContainerClient</code> like so:</p>\n<pre><code>    val defaultAzureCredential: DefaultAzureCredential =\n        DefaultAzureCredentialBuilder()\n            .tenantId(azureConfig.azureTenantId)\n            .build()\n\n    val blobServiceClient =\n        blobServiceClientBuilder\n            .endpoint(azureConfig.storageAccountUrl)\n            .credential(defaultAzureCredential)\n            .buildClient()\n    val blobContainerClient = blobServiceClient.getBlobContainerClient(STORAGE_ACCOUNT_CONTAINER)\n    try {\n        val fileName = &quot;${appSlug}_${LocalDateTime.now().format(pattern)}.zip&quot;\n        val blobClient = blobContainerClient.getBlobClient(fileName)\n\n        blobClient.upload(inputStream, true)\n</code></pre>\n<p>I get the following error:</p>\n<pre><code>&lt;AuthenticationErrorDetail&gt;Issuer validation failed. Issuer did not match.&lt;/AuthenticationErrorDetail&gt;\n</code></pre>\n<p>The issuer in the token in the cli is <code>https://sts.windows.net/&lt;tenantId&gt;/</code>\nand I checked getting the token from the <code>defaultAzureCredential</code>, and it has the same issuer.</p>\n<p>I really don't know why it's not working when using the java lib... Any ideas?</p>\n",
    "tags" : [ "java", "azure", "azure-blob-storage" ],
    "owner" : {
      "account_id" : 5998187,
      "reputation" : 1299,
      "user_id" : 4712288,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://lh6.googleusercontent.com/-oHf4ZUwnHao/AAAAAAAAAAI/AAAAAAAAAJA/QfjIKkQR8mw/s256-rj/photo.jpg",
      "display_name" : "Edward Rixon",
      "link" : "https://stackoverflow.com/users/4712288/edward-rixon"
    },
    "is_answered" : false,
    "view_count" : 256,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744108200,
    "creation_date" : 1744038725,
    "link" : "https://stackoverflow.com/questions/79560237/issuer-validation-failed-issuer-did-not-match-azure-blobcontainerclient",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79561778,
    "question_id" : 79560237,
    "body" : "<p>Ok turns out I made a dumb mistake with the storage account name in the app config! So the error message is a bit misleading, but also makes sense. It was trying to connect to the wrong storage account, which does explain the error message.</p>\n<p>I would advise anyone who has this same issue, add this logging option to your client:</p>\n<pre><code>val httpLogOptions = com.azure.core.http.policy.HttpLogOptions()\n        .setLogLevel(HttpLogDetailLevel.BODY_AND_HEADERS)\n\n    return BlobServiceClientBuilder()\n        .endpoint(url)\n        .credential(credential)\n        .httpLogOptions(httpLogOptions)\n        .addPolicy(HttpLoggingPolicy(httpLogOptions))\n        .buildClient()\n</code></pre>\n<p>It allowed me to see the request and headers.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 5998187,
      "reputation" : 1299,
      "user_id" : 4712288,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://lh6.googleusercontent.com/-oHf4ZUwnHao/AAAAAAAAAAI/AAAAAAAAAJA/QfjIKkQR8mw/s256-rj/photo.jpg",
      "display_name" : "Edward Rixon",
      "link" : "https://stackoverflow.com/users/4712288/edward-rixon"
    },
    "creation_date" : 1744108200,
    "last_activity_date" : 1744108200,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140311165,
    "post_id" : 79560237,
    "body" : "@Venkatesan yo thanks for your help I found the mistake! answer incoming",
    "score" : 0,
    "owner" : {
      "account_id" : 5998187,
      "reputation" : 1299,
      "user_id" : 4712288,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://lh6.googleusercontent.com/-oHf4ZUwnHao/AAAAAAAAAAI/AAAAAAAAAJA/QfjIKkQR8mw/s256-rj/photo.jpg",
      "display_name" : "Edward Rixon",
      "link" : "https://stackoverflow.com/users/4712288/edward-rixon"
    },
    "creation_date" : 1744105355,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310888,
    "post_id" : 79560237,
    "body" : "@EdwardRixon <a href=\"https://stackoverflow.com/questions/79495357/how-to-access-azure-storage-blob-container-having-managed-identity-assigned-from/79498190#79498190\" title=\"how to access azure storage blob container having managed identity assigned from\">stackoverflow.com/questions/79495357/&hellip;</a>  Check the <code>ClientSecretCredential</code> code and try it from your end.",
    "score" : 0,
    "owner" : {
      "account_id" : 25323437,
      "reputation" : 11346,
      "user_id" : 19144428,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/xwLaPRiI.jpg?s=256",
      "display_name" : "Venkatesan",
      "link" : "https://stackoverflow.com/users/19144428/venkatesan"
    },
    "creation_date" : 1744100672,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310874,
    "post_id" : 79560237,
    "body" : "@EdwardRixon , Have you tried to login with Azure CLI before running the code or You login using Az login",
    "score" : 0,
    "owner" : {
      "account_id" : 26618588,
      "reputation" : 4283,
      "user_id" : 20237633,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/99efbd77a32fe6cb66f7dae24ef5f6bf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "P Sampath",
      "link" : "https://stackoverflow.com/users/20237633/p-sampath"
    },
    "creation_date" : 1744100537,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310676,
    "post_id" : 79560237,
    "body" : "@Venkatesan Yes I have tried that. Using the same creds. No difference. It&#39;s not to do with the method of Auth, as they work fine with the CLI. There is some difference in how the java lib sends the request...",
    "score" : 0,
    "owner" : {
      "account_id" : 5998187,
      "reputation" : 1299,
      "user_id" : 4712288,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://lh6.googleusercontent.com/-oHf4ZUwnHao/AAAAAAAAAAI/AAAAAAAAAJA/QfjIKkQR8mw/s256-rj/photo.jpg",
      "display_name" : "Edward Rixon",
      "link" : "https://stackoverflow.com/users/4712288/edward-rixon"
    },
    "creation_date" : 1744097444,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310176,
    "post_id" : 79560237,
    "body" : "If you are using a client ID, tenant ID, and client secret, you can use <code>ClientSecretCredential</code> to authenticate with Azure Storage",
    "score" : 0,
    "owner" : {
      "account_id" : 25323437,
      "reputation" : 11346,
      "user_id" : 19144428,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/xwLaPRiI.jpg?s=256",
      "display_name" : "Venkatesan",
      "link" : "https://stackoverflow.com/users/19144428/venkatesan"
    },
    "creation_date" : 1744086307,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}