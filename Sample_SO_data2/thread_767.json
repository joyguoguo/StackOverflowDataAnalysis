{
  "question" : {
    "question_id" : 79778308,
    "title" : "Hibernate specification with parentheses",
    "body" : "<p>I am trying to create a Hibernate specification with parentheses but was not able to do it.</p>\n<p>I have many specifications. My problem is with the following specification:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public static Specification&lt;ListingEntity&gt; locations(List&lt;String&gt; locations) {\n    if (locations == null || locations.isEmpty()) {\n        return null;\n    } else {\n        return (root, query, builder) -&gt; {\n            Join&lt;ListingEntity, GeoLevelTwoEntity&gt; joinGeoLevelTwo = root.join(&quot;geoLevelTwoEntity&quot;);\n            Join&lt;GeoLevelTwoEntity, GeoLevelOneEntity&gt; joinGeoLevelOne = joinGeoLevelTwo.join(&quot;geoLevelOneEntity&quot;);\n\n            Predicate predicate = builder.conjunction();\n            for (String location : locations) {\n\n                if (location.contains(&quot;_&quot;)) {\n                    String[] locationParts = location.split(&quot;_&quot;);\n                    Predicate predicateLevelOne = builder.equal(joinGeoLevelOne.get(&quot;geographyLevelOne&quot;), locationParts[1]);\n\n                    Predicate predicateLevelTwo = joinGeoLevelTwo.get(&quot;geographyLevelTwo&quot;).in(locationParts[0]);\n                    Predicate locationPredicate = builder.and(predicateLevelOne, predicateLevelTwo);\n\n                    predicate = builder.or(predicate, locationPredicate);\n                }\n\n            }\n            return predicate;\n\n        };\n    }\n}\n</code></pre>\n<p>It creates the following SQL script:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>from \n  listings le1_0 \n  join geo_level_two glte1_0 on glte1_0.id = le1_0.geography_level_two_id \n  join geo_level_one gloe1_0 on gloe1_0.id = glte1_0.geography_level_one_id \nwhere \n  1 = 1 \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) \norder by \n  (\n    select \n      0\n  ) offset ? rows fetch first ? rows only\n</code></pre>\n<p>I want it to create the following way:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>where \n  1 = 1 \n  and ( gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) )\norder by \n</code></pre>\n<p>I have other specifications that create <code>and</code> conditions like <code>and floor = 2</code> etc. Thus I cannot think it without using parentheses. I think it needs to look like the following:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>(geographyL1 = 'New York' and geographyL2 = 'USA' or geographyL1 = 'London' and geographyL2 = 'UK') and floor = 2 and price &gt; 100000\n</code></pre>\n<p>I have no issue with other specifications that generate the following SQL. Each condition has its own separate specification:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>floor = 2 and price &gt; 100000 and numberOfRooms = 2\n</code></pre>\n<p>What should I do so that my specification for location lies inside parentheses?</p>\n",
    "tags" : [ "java", "sql", "spring-boot", "hibernate", "predicate" ],
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "is_answered" : true,
    "view_count" : 103,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1759245914,
    "creation_date" : 1759159948,
    "link" : "https://stackoverflow.com/questions/79778308/hibernate-specification-with-parentheses",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79778429,
    "question_id" : 79778308,
    "body" : "<blockquote>\n<p>It creates the following SQL script:</p>\n<p>[...]</p>\n<pre><code>where \n  1 = 1 \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?)\n</code></pre>\n<p>[...]</p>\n</blockquote>\n<p>Well yes, it does.  For the predicate, you start with <code>builder.conjunction()</code>, which corresponds to the <code>1 = 1</code>, and then you add zero or more additional pieces via <code>builder.or()</code>.  <em>Of course</em> the top-level operators are all <code>OR</code>.</p>\n<p><code>builder.conjunction()</code> is intended to provide a starting point for an arbitrary sequence of predicates joined with <code>AND</code>, whereas for a similar sequence joined with <code>OR</code>, you should start with <code>builder.disjunction()</code> instead.  Do bear in mind, however, that these two have opposite logical sense when there are zero (other) predicates in the sequence.</p>\n<h3>If you want to reject everything when there are no locations on which to filter</h3>\n<p>... or if you're willing to assume that that that situation will never arise, then you could just switch from <code>builder.conjunction()</code> to <code>builder.disjunction()</code>.</p>\n<pre><code>            Predicate predicate = builder.disunction();\n            for (String location : locations) {\n                // ...\n            }\n            return predicate;\n</code></pre>\n<p>I would expect the generated criteria to be something like</p>\n<pre><code>where \n  1 &lt;&gt; 1 \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) \n  or gloe1_0.geography_level_one = ? \n  and glte1_0.geography_level_two in (?) \n</code></pre>\n<p>, which, you should satisfy yourself, is logically equivalent to what you say you are looking for. At least when there are any locations to filter on.</p>\n<h3>Otherwise</h3>\n<p>... you need a special case when there are no locations.  One way to do that would be to proceed as above, but at the end,</p>\n<pre><code>            return predicate.getExpressions().isEmpty()\n                    ? builder.conjunction()\n                    : predicate;\n</code></pre>\n<p>(Or possibly you need <code>predicate.getExpressions().size() &lt; 2</code> instead of <code>.isEmpty()</code>.  Or you can use any other mechanism you choose to determine whether any locations have been added to the predicate.)</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1759169333,
    "last_activity_date" : 1759175776,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79779275,
    "question_id" : 79778308,
    "body" : "<pre class=\"lang-java prettyprint-override\"><code>return (root, query, builder) -&gt; {\n    Join&lt;ListingEntity, GeoLevelTwoEntity&gt; joinGeoLevelTwo = root.join(&quot;geoLevelTwoEntity&quot;);\n    Join&lt;GeoLevelTwoEntity, GeoLevelOneEntity&gt; joinGeoLevelOne = joinGeoLevelTwo.join(&quot;geoLevelOneEntity&quot;);\n\n    HashMap&lt;String, Byte&gt; specialCities = new HashMap&lt;&gt;();\n    specialCities.put(&quot;Define special ones here&quot;, (byte) 8);\n    specialCities.put(&quot;and here etc&quot;, (byte) 9);\n\n    List&lt;Predicate&gt; groupPredicates = new ArrayList&lt;&gt;();\n    for (String location : locations) {\n\n        if (location.contains(&quot;_&quot;)) {\n            String[] locationParts = location.split(&quot;_&quot;);\n            String country = locationParts[0];\n            String bigCity = locationParts[1];\n\n            Predicate levelOnePredicate = builder.equal(joinGeoLevelOne.get(&quot;geographyLevelOne&quot;), bigCity);\n            Predicate levelTwoPredicate = builder.equal(joinGeoLevelTwo.get(&quot;geographyLevelTwo&quot;), country);\n\n            List&lt;Predicate&gt; innerPredicates = new ArrayList&lt;&gt;();\n            innerPredicates.add(levelOnePredicate);\n            innerPredicates.add(levelTwoPredicate);\n\n            Predicate groupPredicate = builder.and(innerPredicates.toArray(innerPredicates.toArray(new Predicate[0])));\n            groupPredicates.add(groupPredicate);\n        } else if (specialCities.containsKey(location)) {\n            Predicate levelOnePredicate = builder.equal(joinGeoLevelOne.get(&quot;geographyLevelOne&quot;), location);\n            groupPredicates.add(levelOnePredicate);\n        } else {\n            Predicate smallerCityPredicate = builder.equal(joinGeoLevelTwo.get(&quot;geographyLevelTwo&quot;), location);\n            groupPredicates.add(smallerCityPredicate);\n        }\n\n    }\n    return builder.or(groupPredicates.toArray(new Predicate[0]));\n\n};\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "creation_date" : 1759245914,
    "last_activity_date" : 1759245914,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140767330,
    "post_id" : 79778308,
    "body" : "If there is no filter is entered everything should be listed/returned.",
    "score" : 0,
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "creation_date" : 1759173578,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140767191,
    "post_id" : 79778308,
    "body" : "What should be the effect when there are no locations upon which to filter?  Is everything accepted, or is nothing accepted?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1759168824,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79778429" : [ {
      "comment_id" : 140767365,
      "post_id" : 79778429,
      "body" : "@ilhan This answer already presents the only changes required to your original code to produce a predicate with the required meaning.  Again, if you have issues around combining that predicate with others then that&#39;s a separate question.  <code>CriteriaBuilder</code> does not have or need provision for explicit parentheses.",
      "score" : 0,
      "owner" : {
        "account_id" : 2792262,
        "reputation" : 190832,
        "user_id" : 2402272,
        "user_type" : "registered",
        "accept_rate" : 85,
        "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
        "display_name" : "John Bollinger",
        "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
      },
      "creation_date" : 1759174980,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140767357,
      "post_id" : 79778429,
      "body" : "I was unable to write the correct <code>CriteriaBuilder</code> or <code>predicate</code>.",
      "score" : 0,
      "owner" : {
        "account_id" : 83131,
        "reputation" : 9085,
        "user_id" : 233286,
        "user_type" : "registered",
        "accept_rate" : 73,
        "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
        "display_name" : "ilhan",
        "link" : "https://stackoverflow.com/users/233286/ilhan"
      },
      "creation_date" : 1759174732,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140767352,
      "post_id" : 79778429,
      "body" : "@ilhan If you&#39;re writing SQL code directly then you worry about parentheses.  If you&#39;re using a <code>CriteriaBuilder</code> then you perform operations at that level of abstraction, and let the system figure out the parentheses.  In particular, if you end up with the kind of issue you now describe then it arises from using an inappropriate mechanism to combine the predicate produced by this method with your <code>floor</code> predicate.  That mechanism not having been presented in the question, and such a problem not even having been mentioned, these are out of scope.",
      "score" : 0,
      "owner" : {
        "account_id" : 2792262,
        "reputation" : 190832,
        "user_id" : 2402272,
        "user_type" : "registered",
        "accept_rate" : 85,
        "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
        "display_name" : "John Bollinger",
        "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
      },
      "creation_date" : 1759174502,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140767338,
      "post_id" : 79778429,
      "body" : "But in this case <code>location New York and USA or London and UK and floor = 2</code> will return unexpected results. That is why I was asking for parentheses.  <code>(location New York and location USA or location London and location UK) and floor = 2</code>",
      "score" : 0,
      "owner" : {
        "account_id" : 83131,
        "reputation" : 9085,
        "user_id" : 233286,
        "user_type" : "registered",
        "accept_rate" : 73,
        "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
        "display_name" : "ilhan",
        "link" : "https://stackoverflow.com/users/233286/ilhan"
      },
      "creation_date" : 1759173903,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}