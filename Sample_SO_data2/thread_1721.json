{
  "question" : {
    "question_id" : 79684756,
    "title" : "Inconsistent update behavior with R2DBC and PostgreSQL: returns Successfully updated campaign 0197bf72b3-92ef-ebe128bdb15e rows affected 0: MDC: {}",
    "body" : "<p>Background</p>\n<p>I'm a beginner with Apache Pekko and R2DBC, working on a reactive application using pekko-persistence-r2dbc with a PostgreSQL database hosted on AWS RDS). My application processes events via Pekko projections to update a public.campaigns table, but I’m facing an intermittent issue where a SELECT query returns Optional.empty, and the subsequent UPDATE query affects 0 rows, even though the campaign record is confirmed to be inserted.</p>\n<p>Issue</p>\n<p>In my CampaignTableStatisticsUpdaterProjectionHandler, a MessageSent event triggers an UPDATE query (UPDATE public.campaigns SET message_sent_count = message_sent_count + 1, total_cost = total_cost + $1 WHERE id = $2;). Occasionally, this update affects 0 rows, and logs show Campaign exists with id Optional.empty, despite the campaign (id: 0197bf4a-1ab7-72b3-92ef-ebe128bdb15e) being inserted ~500–900ms earlier. This happens in a low-load environment (single message, no concurrency) and doesn’t occur every time—sometimes the update works correctly.</p>\n<p>Environment</p>\n<p>Database: PostgreSQL on AWS RDS (unwaveringmedia_platform_prod)\nDriver: R2DBC (r2dbc-postgresql)\nFramework: Apache Pekko with pekko-persistence-r2dbc</p>\n<p>Connection Pool</p>\n<pre><code>pekko.persistence.r2dbc {\n  connection-factory {\n    initial-size = 100\n    max-size = 100\n    connect-timeout = 5 seconds\n    acquire-timeout = 10 seconds\n    acquire-retry = 1\n    max-idle-time = 10 minutes\n  }\n  query {\n    behind-current-time = 5000 millis\n    refresh-interval = 20s\n  }\n}\n</code></pre>\n<p><code>code</code></p>\n<pre><code>public class CampaignTableStatisticsUpdaterProjectionHandler extends R2dbcHandler&lt;EventEnvelope&lt;OutboundCampaignMessageEntity.Event&gt;&gt; {\n    @Override\n    public CompletionStage&lt;Done&gt; process(R2dbcSession session, EventEnvelope&lt;OutboundCampaignMessageEntity.Event&gt; eventEventEnvelope) throws Exception {\n        if (eventEventEnvelope.event().getTimestamp().isBefore(ServiceUtils.BEFORE_INCIDENT)) {\n            return CompletableFuture.completedFuture(Done.done());\n        }\n        log.debug(&quot;Processing event: {}, sequence: {}&quot;, eventEventEnvelope.event(), eventEventEnvelope.sequenceNr());\n        if (eventEventEnvelope.event() instanceof OutboundCampaignMessageEntity.MessageSent evt) {\n            var selectStatement = session\n                    .createStatement(&quot;SET TRANSACTION ISOLATION LEVEL READ COMMITTED; SELECT id FROM public.campaigns WHERE id = $1;&quot;)\n                    .bind(0, evt.getCampaignId());\n            return session.selectOne(selectStatement, row -&gt; row.get(&quot;id&quot;))\n                    .thenCompose(row -&gt; {\n                        log.info(&quot;Campaign exists with id {}&quot;, row);\n                        if (row == null) {\n                            return CompletableFuture.completedFuture(Done.done());\n                        }\n                        var updateStatement = session\n                                .createStatement(&quot;UPDATE public.campaigns SET message_sent_count = message_sent_count + 1, total_cost = total_cost + $1 WHERE id = $2;&quot;)\n                                .bind(0, evt.getMessageCost())\n                                .bind(1, evt.getCampaignId());\n                        return session.updateOne(updateStatement)\n                                .thenApply(rowsUpdated -&gt; {\n                                    log.info(&quot;Successfully updated campaign {}, rows affected: {}&quot;, evt.getCampaignId(), rowsUpdated);\n                                    return Done.done();\n                                });\n                    });\n        } else if (eventEventEnvelope.event() instanceof OutboundCampaignMessageEntity.MessageCreated evt) {\n            var statement = session\n                    .createStatement(&quot;UPDATE public.campaigns SET message_created_count = message_created_count + 1 WHERE id = $1;&quot;)\n                    .bind(0, evt.getCampaignId());\n            return session.updateOne(statement).thenApply(rowsUpdated -&gt; Done.done());\n        }\n        return CompletableFuture.completedFuture(Done.done());\n    }\n}\n</code></pre>\n<p><em><strong>Logs</strong></em></p>\n<pre><code>Executing update: PostgresqlStatement{bindings=[Binding{parameters=[Parameter{format=FORMAT_BINARY, type=701, value=MonoSupplier}, Parameter{format=FORMAT_TEXT, type=1043, value=MonoSupplier}]}], context=ConnectionContext{client=io.r2dbc.postgresql.client.ReactorNettyClient@38bf4137, codecs=io.r2dbc.postgresql.codec.DefaultCodecs@714d4d6, connection=PostgresqlConnection{client=io.r2dbc.postgresql.client.ReactorNettyClient@38bf4137, codecs=io.r2dbc.postgresql.codec.DefaultCodecs@714d4d6}, configuration=PostgresqlConnectionConfiguration{applicationName='r2dbc-postgresql', autodetectExtensions='true', compatibilityMode=false, connectTimeout=PT5S, errorResponseLogLevel=DEBUG, database='unwaveringmedia_platform_prod', extensions=[], fetchSize=io.r2dbc.postgresql.PostgresqlConnectionConfiguration$Builder$$Lambda/0x00007f0cdea42348@234a08ea, forceBinary='true', host='unwavering-media-marketing-platform-db.cl248qc4ol90.us-east-1.rds.amazonaws.com', lockWaitTimeout='null, loopResources='null', noticeLogLevel='DEBUG', options='{}', password='**********************', port=5432, preferAttachedBuffers=true, socket=null, statementTimeout=null, tcpKeepAlive=false, tcpNoDelay=true, username='boban'}, portalNameSupplier=io.r2dbc.postgresql.DefaultPortalNameSupplier@28e388a9, statementCache=LimitedStatementCache{cache={io.r2dbc.postgresql.BoundedStatementCache$CacheKey@9418b150=S_0, io.r2dbc.postgresql.BoundedStatementCache$CacheKey@589270a3=S_1, io.r2dbc.postgresql.BoundedStatementCache$CacheKey@f6d8b11a=S_2, io.r2dbc.postgresql.BoundedStatementCache$CacheKey@de50be46=S_3}, counter=4, client=io.r2dbc.postgresql.client.ReactorNettyClient@38bf4137, limit=5000}}, sql='UPDATE public.campaigns SET message_sent_count = message_sent_count + 1, total_cost = total_cost + $1 WHERE id = $2;', generatedColumns=null}\n2025-06-30 05:23:18.924 [INFO ] [com.unwaveringmedia.platform.message.projection.updater.campaign.CampaignTableStatisticsUpdaterProjectionHandler] [] [ForkJoinPool.commonPool-worker-5] - Campaign exists with id Optional.empty MDC: {}\n2025-06-30 05:23:18.925 [INFO ] `enter code here`[com.unwaveringmedia.platform.message.projection.updater.campaign.CampaignTableStatisticsUpdaterProjectionHandler] [] [ForkJoinPool.commonPool-worker-5] - Successfully updated campaign 0197bf4a-1ab7-72b3-92ef-ebe128bdb15e rows affected 0:  MDC: {}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "amazon-rds", "r2dbc-postgresql" ],
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "is_answered" : false,
    "view_count" : 61,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1751449874,
    "creation_date" : 1751286593,
    "link" : "https://stackoverflow.com/questions/79684756/inconsistent-update-behavior-with-r2dbc-and-postgresql-returns-successfully-upd",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}