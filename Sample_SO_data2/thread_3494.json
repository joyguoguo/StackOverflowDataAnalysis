{
  "question" : {
    "question_id" : 79548027,
    "title" : "Tapestry bean with Around aspect class loading problem",
    "body" : "<p>I have a big application written in Tapestry using <code>@Transactional</code> annotation from Spring to manage transactions and Hibernate sessions. At the moment I'm in a process of upgrading dependencies, including Spring.</p>\n<p>The problem is that <code>@Transactional</code> aspect used to be before/after, but has been changed to around and this collides with <code>PlasticClassLoader</code>. The aspect is weaved using post-compile weaving. Whenever any local method (private or public) is called, it fails with</p>\n<pre><code>java.lang.ClassCastException: class XYZ cannot be cast to class XYZ (XYZ is in unnamed module of loader org.apache.tapestry5.internal.plastic.PlasticClassLoader @162b4f91; XYZ is in unnamed module of loader 'app')\n</code></pre>\n<p>For example I have an <code>onSuccessFrom</code>... method and this method cannot call another method from the same class which is annotated with <code>@Transactional</code>, because it fails like above.</p>\n<p>Any idea how to fix it?</p>\n",
    "tags" : [ "java", "spring", "tapestry" ],
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "is_answered" : false,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743499243,
    "creation_date" : 1743494440,
    "link" : "https://stackoverflow.com/questions/79548027/tapestry-bean-with-around-aspect-class-loading-problem",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79548200,
    "question_id" : 79548027,
    "body" : "<p>Too many issues can exist, with unnamed module, since I am not able to comment due to point issues, I have found the answer check the answers on the link &amp; fix your the issue.</p>\n<p><a href=\"https://stackoverflow.com/a/57753612/16897849\">https://stackoverflow.com/a/57753612/16897849</a></p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 22735623,
      "reputation" : 9,
      "user_id" : 16897849,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/rYthvEkZ.gif?s=256",
      "display_name" : "Alan AU",
      "link" : "https://stackoverflow.com/users/16897849/alan-au"
    },
    "creation_date" : 1743499243,
    "last_activity_date" : 1743499243,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140287000,
    "post_id" : 79548027,
    "body" : "Does it work with JDK11 or JDK17? Wouldn&#39;t be the first time that some specific combination would lead to errors. Regarding the upgrade I&#39;ve been in the industry long enough to fully understand that it is hard (or nearly impossible) to upgrade everything.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743512460,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286918,
    "post_id" : 79548027,
    "body" : "Exactly, at one point I thought I could ditch Spring and implement my own transactional handling and I had the very same problem when I used Around aspect. Turns out that implementing your own transactional annotation with nested transactions is not that simple, so I returned back to Spring for transaction handling. Tapestry PlasticClassLoader doesn&#39;t work well with AspectJ in Java 21.",
    "score" : 0,
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "creation_date" : 1743511554,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286812,
    "post_id" : 79548027,
    "body" : "Nonetheless you can still upgrade to 5.9 without moving to jakarta. It isn&#39;t the move to jakarta but rather an update of Spring. Although I doubt the issue is Spring but more the way that Tapestry is operating with classloaders.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743510283,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286798,
    "post_id" : 79548027,
    "body" : "Well, when something is developed since 2010, it&#39;s not easy, more impossible, to switch to another technology. Anyway, there&#39;s a lot other dependencies using javax (e.g. Hibernate search), so it will take time to switch to jakarta and may not resolve the issue at all.",
    "score" : 0,
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "creation_date" : 1743510038,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286622,
    "post_id" : 79548027,
    "body" : "<a href=\"https://tapestry.apache.org/release-notes-590.html\" rel=\"nofollow noreferrer\">tapestry.apache.org/release-notes-590.html</a> the release notes are here. Which does support Jakarta. So I expect it to be officially released. Never knew (or expected) Tapestry still being a thing in 2025 :). But it is possible to upgrade not sure if that fixes it (or maybe even further down upgrade to 5.9.0 and Spring 6).",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743507474,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286382,
    "post_id" : 79548027,
    "body" : "Because Tapestry 5.8 uses Javax. Tapestry 5.9.0 hasn&#39;t been officially released yet, so I can&#39;t use it in production. .... oh 5.9.0 has been released, but it&#39;s not listed in <a href=\"https://tapestry.apache.org/download.html\" rel=\"nofollow noreferrer\">tapestry.apache.org/download.html</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "creation_date" : 1743503873,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286263,
    "post_id" : 79548027,
    "body" : "Have you tried with Tapestry 5.9.0? Could you create a MVP so we can test/see what is happening. Also why is Jakarta preventing you from using Spring 6 or up?",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743501915,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286228,
    "post_id" : 79548027,
    "body" : "Java 11 to 21, Spring 4.3.15 to 5.3 (cannot use 6 because of Jakarta). The weaved code before had  <code>AnnotationTransactionAspect.aspectOf().ajc$before$org_spring&zwnj;&#8203;framework_transactio&zwnj;&#8203;n_aspectj_AbstractTr&zwnj;&#8203;ansactionAspect$1$2a&zwnj;&#8203;73e96c(this, ajc$tjp_1);</code> at the begining of @Transactional method, while now it&#39;s <code>((AbstractTransactionAspect)var10000).ajc$around$org_springf&zwnj;&#8203;ramework_transaction&zwnj;&#8203;_aspectj_AbstractTra&zwnj;&#8203;nsactionAspect$1$2a7&zwnj;&#8203;3e96c(this, new ApplicationPropertiesImpl$AjcClosure1(var6), ajc$tjp_0);</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "creation_date" : 1743501458,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286183,
    "post_id" : 79548027,
    "body" : "You are upgrading from what to what. Also Spring 5.3 might not even support Java 21. Please add that information in your question and not as a comment.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743500594,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286067,
    "post_id" : 79548027,
    "body" : "Well, previous Spring version was quite old, so old that it was indeed before/after. Anyhow, the problem seems to be with the way AspectJ with Java 21 weaves the classes. It now generates closure classes rather than inlining the code and the closure class has a different loader.  Version setup is Java 21, Tapestry 5.8.7, Spring 5.3.39 (only spring-context, tx, aspects and orm), AspectJ 1.9.23 with io.freefair.aspectj.post-compile-weaving.",
    "score" : 0,
    "owner" : {
      "account_id" : 4094074,
      "reputation" : 1,
      "user_id" : 3361360,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bednee",
      "link" : "https://stackoverflow.com/users/3361360/bednee"
    },
    "creation_date" : 1743498692,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140286002,
    "post_id" : 79548027,
    "body" : "In addition it was an <code>around</code> aspect since the beginning and not an <code>before</code>/<code>after</code> aspect . So not sure where you get that information from but that is plain wrong, as it would only work with an around aspect.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743497822,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140285928,
    "post_id" : 79548027,
    "body" : "If post-compile weaving is used the error doesn&#39;t make sense. As post-compile would modify the bytecode before anything else. This is a runtime exception indicating that proxies are also created (or that other things are going on). Add your configuration to the question and the versions of the frameworks in use.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743496823,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79548200" : [ {
      "comment_id" : 140286374,
      "post_id" : 79548200,
      "body" : "Well, the @Transactional is used over 2000 times in the app, so it&#39;s not that simple to rewrite it.",
      "score" : 0,
      "owner" : {
        "account_id" : 4094074,
        "reputation" : 1,
        "user_id" : 3361360,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "bednee",
        "link" : "https://stackoverflow.com/users/3361360/bednee"
      },
      "creation_date" : 1743503770,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140286313,
      "post_id" : 79548200,
      "body" : "Has it failed with protected signature? If I was having the issue, so I simply type the methods in an another class &amp; import it to my main class. I also could try to copy the class with refactoring another name class.",
      "score" : 0,
      "owner" : {
        "account_id" : 22735623,
        "reputation" : 9,
        "user_id" : 16897849,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/rYthvEkZ.gif?s=256",
        "display_name" : "Alan AU",
        "link" : "https://stackoverflow.com/users/16897849/alan-au"
      },
      "creation_date" : 1743502570,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140286217,
      "post_id" : 79548200,
      "body" : "I saw this one, but that&#39;s not it. Trust me, I looked everywhere before posting the question here.",
      "score" : 0,
      "owner" : {
        "account_id" : 4094074,
        "reputation" : 1,
        "user_id" : 3361360,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/8ebcc4f4a9b96ed231cd61a9191538c0?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "bednee",
        "link" : "https://stackoverflow.com/users/3361360/bednee"
      },
      "creation_date" : 1743501258,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}