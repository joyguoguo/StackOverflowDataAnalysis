{
  "question" : {
    "question_id" : 79823619,
    "title" : "ConcurrentMap: atomically check if a value if present, and then mutate it with a consumer",
    "body" : "<p>Given a Java <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/ConcurrentMap.html\" rel=\"nofollow noreferrer\"><code>ConcurrentMap</code></a>, I would like to atomically:</p>\n<ul>\n<li>Check if an entry is contained in the map</li>\n<li>If it is present, run an action (I'm thinkng of a <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/function/BiConsumer.html\" rel=\"nofollow noreferrer\"><code>BiConsumer</code></a> taking the key and its value)</li>\n<li>Otherwise, run another action (a <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/function/Consumer.html\" rel=\"nofollow noreferrer\"><code>Consumer</code></a> which accepts the missing key)</li>\n</ul>\n<p>How could I use existing <code>ConcurrentMap</code> API to perform the following actions in a thread-safe way?</p>\n<pre><code>if (map.containsKey(key)) {\n    V value = map.get(key);\n    ifPresentAction.accept(key, value);\n} else {\n    ifAbsentAction.accept(key);\n}\n</code></pre>\n<p>where <code>map</code> is of type <code>ConcurrentMap&lt;K, V&gt;</code>, <code>key</code> is of type <code>K</code>, and <code>ifPresentAction</code> and <code>ifAbsentAction</code> are respectively a <code>BiConsumer&lt;K, V&gt;</code> and a <code>Consumer&lt;K&gt;</code>.</p>\n<hr />\n<p><strong>Additional Information</strong></p>\n<p>I thought of invoking <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/Optional.html#ifPresentOrElse(java.util.function.Consumer,java.lang.Runnable)\" rel=\"nofollow noreferrer\"><code>Optional.ifPresentOrElse</code></a> (with the correct types), but I am not sure if it would be thread-safe.</p>\n<pre><code>Optional.ofNullable(map.get(key))\n        .ifPresentOrElse(ifPresentAction, ifAbsentAction);\n</code></pre>\n",
    "tags" : [ "java", "java.util.concurrent", "concurrenthashmap" ],
    "owner" : {
      "account_id" : 85548,
      "reputation" : 7926,
      "user_id" : 238421,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
      "display_name" : "Danilo Piazzalunga",
      "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
    },
    "is_answered" : true,
    "view_count" : 81,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1763485763,
    "creation_date" : 1763484846,
    "link" : "https://stackoverflow.com/questions/79823619/concurrentmap-atomically-check-if-a-value-if-present-and-then-mutate-it-with-a",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79823643,
    "question_id" : 79823619,
    "body" : "<p>Assuming that your map won't contain any <code>null</code> values, you can (mis)use <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/util/Map.html#compute(K,java.util.function.BiFunction)\" rel=\"nofollow noreferrer\">Map.compute</a>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>map.compute(key, (k, v) -&gt; {\n    if (v != null) {\n        ifPresentAction.accept(key, v);\n    } else {\n        ifAbsentAction.accept(key);\n    }\n    return v;\n});\n</code></pre>\n<p>If the actions can be run outside of the locking then you can use <code>Optional</code> instead:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Optional.ofNullable(map.get(key)).ifPresentOrElse(\n        v -&gt; ifPresentAction.accept(key, v),\n        () -&gt; ifAbsentAction.accept(key));\n</code></pre>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1211967,
      "reputation" : 10014,
      "user_id" : 1180351,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
      "display_name" : "Rob Spoor",
      "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
    },
    "creation_date" : 1763485763,
    "last_activity_date" : 1763485763,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140866557,
    "post_id" : 79823619,
    "body" : "@MarkRotteveel my goal is to modify the contents of the value stored in the map (hence mutate the object), not to remap and/or replace a value. Do you have any suggestions on how to improve the title?",
    "score" : 0,
    "owner" : {
      "account_id" : 85548,
      "reputation" : 7926,
      "user_id" : 238421,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
      "display_name" : "Danilo Piazzalunga",
      "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
    },
    "creation_date" : 1763741615,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140862287,
    "post_id" : 79823619,
    "body" : "The title is a bit confusing, as you don&#39;t seem to want to mutate the value in the map, you just want to perform a calculation with the value of the map (or maybe modify the contents of the value?).",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1763558121,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860781,
    "post_id" : 79823619,
    "body" : "@RobSpoor You&#39;re right. Any single method from <code>ConcurrentMap</code> is thread-safe; however, if I were to call multiple methods (for example, <code>containsKey</code>and <code>get</code>), it would not be atomical (the map could be updated between two method calls).",
    "score" : 0,
    "owner" : {
      "account_id" : 85548,
      "reputation" : 7926,
      "user_id" : 238421,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
      "display_name" : "Danilo Piazzalunga",
      "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
    },
    "creation_date" : 1763486474,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860778,
    "post_id" : 79823619,
    "body" : "@JohnBollinger It&#39;s safe to assume a <code>ConcurrentHashMap</code>, and the two consumers do not, in fact, access the map.",
    "score" : 1,
    "owner" : {
      "account_id" : 85548,
      "reputation" : 7926,
      "user_id" : 238421,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
      "display_name" : "Danilo Piazzalunga",
      "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
    },
    "creation_date" : 1763486336,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860771,
    "post_id" : 79823619,
    "body" : "Do <code>ifPresentAction</code> and / or <code>ifAbsentAction</code> access the map?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1763485995,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860769,
    "post_id" : 79823619,
    "body" : "Define &quot;thread-safe&quot;. The <code>ConcurrentMap</code> operation (in this case <code>get</code>) is always thread-safe. If the actions can update your value then no, using <code>Optional</code> is not thread-safe. Note that you can&#39;t directly use the consumers because <code>ifPresentOrElse</code> doesn&#39;t provide the key to them.",
    "score" : 0,
    "owner" : {
      "account_id" : 1211967,
      "reputation" : 10014,
      "user_id" : 1180351,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
      "display_name" : "Rob Spoor",
      "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
    },
    "creation_date" : 1763485925,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860767,
    "post_id" : 79823619,
    "body" : "Your text says <code>ConcurrentMap</code>, but you tagged [concurrenthashmap].  Are you expecting answers that apply to all <code>ConcurrentMap</code>s, or are we to assume a <code>ConcurrentHashMap</code>?",
    "score" : 2,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1763485911,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79823643" : [ {
      "comment_id" : 140860793,
      "post_id" : 79823643,
      "body" : "Your (mis)use of <code>compute</code> is really what I&#39;m looking for, as its <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/util/concurrent/ConcurrentHashMap.html#compute(K,java.util.function.BiFunction)\" rel=\"nofollow noreferrer\">atomicity guarantees</a> will make me confident I&#39;m not introducing any concurrency issues.",
      "score" : 0,
      "owner" : {
        "account_id" : 85548,
        "reputation" : 7926,
        "user_id" : 238421,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
        "display_name" : "Danilo Piazzalunga",
        "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
      },
      "creation_date" : 1763486946,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140860792,
      "post_id" : 79823643,
      "body" : "Thank you! I failed to realise that <code>Optional.ifPresentOrElse</code> was safe to use, as my actions are not accessing the map.",
      "score" : 1,
      "owner" : {
        "account_id" : 85548,
        "reputation" : 7926,
        "user_id" : 238421,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/364633fd122d04290ae7257642b45800?s=256&d=identicon&r=PG",
        "display_name" : "Danilo Piazzalunga",
        "link" : "https://stackoverflow.com/users/238421/danilo-piazzalunga"
      },
      "creation_date" : 1763486880,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140860774,
      "post_id" : 79823643,
      "body" : "@teapot418 You&#39;re right, I never considered implementations other than <code>ConcurrentHashMap</code> which does guarantee that the function is called exactly once. The default implementation in <code>ConcurrentMap</code> even documents that it may call the function more than once.",
      "score" : 1,
      "owner" : {
        "account_id" : 1211967,
        "reputation" : 10014,
        "user_id" : 1180351,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
        "display_name" : "Rob Spoor",
        "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
      },
      "creation_date" : 1763486117,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140860766,
      "post_id" : 79823643,
      "body" : "Note: atomicity of <code>compute</code> may vary. To quote ConcurrentSkipListMap docs: &quot;The function is NOT guaranteed to be applied once atomically.&quot;. While it is atomic in <code>ConcurrentHashMap</code>.",
      "score" : 1,
      "owner" : {
        "account_id" : 19435569,
        "reputation" : 2968,
        "user_id" : 21105992,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/kKQkV.png?s=256",
        "display_name" : "teapot418",
        "link" : "https://stackoverflow.com/users/21105992/teapot418"
      },
      "creation_date" : 1763485902,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}