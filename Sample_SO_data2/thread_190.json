{
  "question" : {
    "question_id" : 79822552,
    "title" : "Are there any plans to expose internal arrays in java.lang.String?",
    "body" : "<p>When trying to performance-tune our Java XML parsing/validation/binding pipeline, I observed the following:</p>\n<ul>\n<li>Iterating a String's chars via <code>String.charAt()</code> is slow, cf. e.g. <a href=\"https://github.com/FasterXML/woodstox/blob/main/src/main/java/com/ctc/wstx/sw/BaseStreamWriter.java#L95\" rel=\"nofollow noreferrer\">Woodstox</a> (I was able to verify this statement with own benchmarks):</li>\n</ul>\n<blockquote>\n<p>Intermediate buffer into which characters of a String can be copied, in cases where such a copy followed by array access is faster than calling <code>String.charAt()</code> (which perhaps surprisingly is often case, and especially significant for longer buffers).</p>\n</blockquote>\n<ul>\n<li>Copying to a buffer array with <code>String.getChars()</code> and <em>then</em> iterating the buffer is obviously more expensive than just iterating over an array.</li>\n<li>Heavily performance-optimized libraries like <a href=\"https://www.alibabacloud.com/blog/techniques-to-construct-string-objects-and-access-internal-members-quickly_599831\" rel=\"nofollow noreferrer\">FastJSON</a> use a mix of unsafe, deprecated and undocumented APIs (AFAIU) to directly access a String's backing array (I verified with own benchmarks that this approach has performance benefits)</li>\n</ul>\n<p>Are you aware of any plans to &quot;officially&quot; offer an API to directly access a String's backing array?</p>\n",
    "tags" : [ "java", "performance", "unsafe", "lambda-metafactory", "varhandle" ],
    "owner" : {
      "account_id" : 1364678,
      "reputation" : 2232,
      "user_id" : 1301373,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/56eb9a131846d4447ca24b5ea9ecb600?s=256&d=identicon&r=PG",
      "display_name" : "winne2",
      "link" : "https://stackoverflow.com/users/1301373/winne2"
    },
    "is_answered" : true,
    "view_count" : 147,
    "closed_date" : 1763460470,
    "answer_count" : 1,
    "score" : -9,
    "last_activity_date" : 1764475822,
    "creation_date" : 1763397607,
    "link" : "https://stackoverflow.com/questions/79822552/are-there-any-plans-to-expose-internal-arrays-in-java-lang-string",
    "closed_reason" : "Opinion-based"
  },
  "answers" : [ {
    "answer_id" : 79822684,
    "question_id" : 79822552,
    "body" : "<p>The short answer to your question is: no. On the contrary, steps have been taken to make it <em>harder</em> to access internals. There's no way Oracle is going to make it easier. (Well, maaaaaybe after <a href=\"https://openjdk.org/jeps/8261007\" rel=\"nofollow noreferrer\">frozen arrays</a> are implemented; just don't count on it.)</p>\n<p>As said in the comments, String internals are guarded because otherwise it's possible to violate the immutability of String. Years ago I've already experimented with modifying Strings using reflection, and in Java 11 it's still possible:</p>\n<pre class=\"lang-java prettyprint-override\"><code>String s = &quot;hello world&quot;;\n\nvar valueHandle = MethodHandles.privateLookupIn(String.class, MethodHandles.lookup())\n        .findVarHandle(String.class, &quot;value&quot;, byte[].class);\n\nbyte[] value = (byte[]) valueHandle.get(s);\nvalue[0] = 'H';\n\nSystem.out.println(s); // prints Hello world, not hello world\n</code></pre>\n<p>To make it harder, <a href=\"https://openjdk.org/jeps/396\" rel=\"nofollow noreferrer\">JEP 396</a> in Java 16 and <a href=\"https://openjdk.org/jeps/403\" rel=\"nofollow noreferrer\">JEP 403</a> in Java 17 have been implemented to prevent the above unless you explicitly open packages using <code>--add-opens</code>. For instance, the above is still possible in Java 17 by using the <code>--add-opens java.base/java.lang=ALL-UNNAMED</code> JVM flag (for use in a named module, replace <code>ALL-UNNAMED</code> with your module name). But while it's possible, it's bad practice to do so. Any use of <code>--add-opens</code> indicates someone is trying to do something that the authors (of any opened module, not just Oracle) don't intend you to do.</p>\n<p>I was hoping that <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/text/StringCharacterIterator.html\" rel=\"nofollow noreferrer\">StringCharacterIterator</a> could perhaps be a bit more efficient, but it still uses <code>charAt</code> and <code>length</code> internally. Perhaps Oracle can be persuaded to update it to use String internals, but I wouldn't count on it.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1211967,
      "reputation" : 10014,
      "user_id" : 1180351,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
      "display_name" : "Rob Spoor",
      "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
    },
    "creation_date" : 1763406795,
    "last_activity_date" : 1763408079,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140879685,
    "post_id" : 79822552,
    "body" : "@winne2 Do not include answers into questions please.",
    "score" : 0,
    "owner" : {
      "account_id" : 5195749,
      "reputation" : 3000,
      "user_id" : 4157124,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ccb2110df592e8d6b210ad3a764f092a?s=256&d=identicon&r=PG",
      "display_name" : "user4157124",
      "link" : "https://stackoverflow.com/users/4157124/user4157124"
    },
    "creation_date" : 1764475826,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140873957,
    "post_id" : 79822552,
    "body" : "Range check elimination is irrelevant to the fact that a range check is O(1) and not O(n).",
    "score" : 1,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1764154149,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140869221,
    "post_id" : 79822552,
    "body" : "@Holger &quot;How did you verify that accessing the array was 3&#215; faster when you don’t know how to do it&quot; -&gt; I used the JDKUtils from FastJSON mentioned in the question; &quot;the range checks are, of course, not O(n) but O(1) and accessing the array directly gives you nothing as Java arrays still have range checks&quot; -&gt; HotSpot&#39;s range check elimination is currently <i>not</i> performed correctly for <code>String.charAt()</code> , as pointed out by a recent JDK bug: <a href=\"https://bugs.openjdk.org/browse/JDK-8364043\" rel=\"nofollow noreferrer\">bugs.openjdk.org/browse/JDK-8364043</a> (but range checks <i>are</i> eliminated in counting loops when accessing an array)",
    "score" : 0,
    "owner" : {
      "account_id" : 1364678,
      "reputation" : 2232,
      "user_id" : 1301373,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/56eb9a131846d4447ca24b5ea9ecb600?s=256&d=identicon&r=PG",
      "display_name" : "winne2",
      "link" : "https://stackoverflow.com/users/1301373/winne2"
    },
    "creation_date" : 1763930719,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140860008,
    "post_id" : 79822552,
    "body" : "If they had done this in the past, they would never have been able to make the changes they did to the internals: originally <code>char[]</code> based, now <code>byte[]</code> based with either ISO-8859-1 encoding or UTF-16 encoding depending on the actual characters in the string. This is never going to happen.",
    "score" : 4,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1763460446,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140858903,
    "post_id" : 79822552,
    "body" : "the specification of <code>String</code> is for it to be immutable (even included in the Java Language Specification) and (many parts of) the Java architecture relies on it being immutable, it must not expose the internal array",
    "score" : 4,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1763404626,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140858838,
    "post_id" : 79822552,
    "body" : "The title of the question doesn&#39;t reflect the question in the body. Also that would be an opinion based question. <a href=\"https://stackoverflow.com/posts/79822552/edit\">edit</a> the title to improve it.",
    "score" : 3,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1763402399,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140858772,
    "post_id" : 79822552,
    "body" : "By the way, if your operations are simple enough to operate on a <code>byte</code>  array, as the question suggests, in other words, don’t need the <code>String</code> API: don’t create a <code>String</code> in the first place. Whether you’re processing XML or JSON, in either case, the source input is a byte sequence and all you need, is parsers giving you the byte arrays they were processing, together with identified ranges of the keys and values.. It’s striking that <i>they</i> don’t trust you enough to give you that but rather construct <code>String</code> objects first, to pass to your code…",
    "score" : 5,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1763400086,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140858758,
    "post_id" : 79822552,
    "body" : "Absolutely not.  This is never going to happen, and will only get harder, not easier.",
    "score" : 6,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1763399635,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140858731,
    "post_id" : 79822552,
    "body" : "How did you verify that accessing the array was 3&#215; faster when you don’t know how to do it? Besides that, the range checks are, of course, <i>not</i> O(n) but O(1) and accessing the array directly gives you nothing as Java arrays still have range checks.",
    "score" : 6,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1763398822,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79822684" : [ {
      "comment_id" : 140860227,
      "post_id" : 79822684,
      "body" : "<code>StringCharacterIterator</code> is a very old class not worth getting redesigned for direct access. It’s not even clear whether using <code>char(…)</code> and <code>length()</code> is a bottleneck at all, even if this class was used extensively. After all, hotspot inlining is a thing in common JVMs. On the other hand, methods like <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/nio/file/Files.html#readString(java.nio.file.Path)\" rel=\"nofollow noreferrer\"><code>Files.readString</code></a> can operate copying-free, turning the I/O buffer into the <code>String</code>’s backend array, if all prerequisites are met.",
      "score" : 2,
      "owner" : {
        "account_id" : 3211603,
        "reputation" : 300941,
        "user_id" : 2711488,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name" : "Holger",
        "link" : "https://stackoverflow.com/users/2711488/holger"
      },
      "creation_date" : 1763467958,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140859773,
      "post_id" : 79822684,
      "body" : "@greg-449 Probably the same for <code>chars()</code>.",
      "score" : 1,
      "owner" : {
        "account_id" : 1211967,
        "reputation" : 10014,
        "user_id" : 1180351,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
        "display_name" : "Rob Spoor",
        "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
      },
      "creation_date" : 1763454085,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140859221,
      "post_id" : 79822684,
      "body" : "The <code>String.codePoints</code> stream Spliterator accesses the array directly for Latin-1 strings (it&#39;s more complex for UTF-16)",
      "score" : 4,
      "owner" : {
        "account_id" : 3159259,
        "reputation" : 111551,
        "user_id" : 2670892,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/4iPV5.png?s=256",
        "display_name" : "greg-449",
        "link" : "https://stackoverflow.com/users/2670892/greg-449"
      },
      "creation_date" : 1763416883,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}