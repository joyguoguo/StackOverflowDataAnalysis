{
  "question" : {
    "question_id" : 79784757,
    "title" : "Receiving &quot;Connection prematurely closed BEFORE response&quot; after JDK upgrade to 21 and spring-cloud-zulu to spring-cloud-gateway",
    "body" : "<p>After upgrading Spring Boot gateway application Java version from JDK11 to JDK21 and changing the dependency of the gateway from <code>spring-cloud-netflix-zuul</code> to <code>spring-cloud-starter-gateway</code> (spring cloud version: <code>2023.0.2</code>) there started coming errors when many requests are made to the gateway and the request processing time is big.</p>\n<p>These errors are:</p>\n<blockquote>\n<p>PrematureCloseException: Connection prematurely closed BEFORE\nresponse<code>and</code>PrematureCloseException: Connection prematurely closed\nDURING response.</p>\n</blockquote>\n<p>What are the possible reasons for this? And possible solutions?</p>\n",
    "tags" : [ "java", "spring-boot", "spring-cloud-gateway", "spring-cloud-netflix" ],
    "owner" : {
      "account_id" : 22844906,
      "reputation" : 163,
      "user_id" : 16991369,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ba1ac37d75fc3ca8752b210b17902626?s=256&d=identicon&r=PG",
      "display_name" : "Mykoliux",
      "link" : "https://stackoverflow.com/users/16991369/mykoliux"
    },
    "is_answered" : true,
    "view_count" : 103,
    "closed_date" : 1759989954,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1759927995,
    "creation_date" : 1759854730,
    "link" : "https://stackoverflow.com/questions/79784757/receiving-connection-prematurely-closed-before-response-after-jdk-upgrade-to-2",
    "closed_reason" : "Not suitable for this site"
  },
  "answers" : [ {
    "answer_id" : 79785469,
    "question_id" : 79784757,
    "body" : "<p>Possible solutions</p>\n<p>Configure maxIdleTime on the ConnectionProvider</p>\n<pre><code>ConnectionProvider connectionProvider = ConnectionProvider.builder(&quot;custom&quot;)\n    .maxIdleTime(Duration.ofSeconds(60))\n    .build();\n\nHttpClient httpClient = HttpClient.create(connectionProvider);\n\nWebClient webClient = WebClient.builder()\n    .clientConnector(new ReactorClientHttpConnector(httpClient))\n    .build();\n</code></pre>\n<p>Set Timeouts on the HttpClient</p>\n<pre><code>HttpClient httpClient = HttpClient.create()\n    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 10000)\n    .responseTimeout(Duration.ofSeconds(60));\n</code></pre>\n<p>Disable TCP Keep-Alive</p>\n<pre><code>HttpClient httpClient = HttpClient.create()\n    .option(ChannelOption.SO_KEEPALIVE, false);\n</code></pre>\n<p>You also might have more useful logs by changing log level for Netty</p>\n<pre><code>logging:\n  level:\n    reactor.netty.http.client: DEBUG\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 17553626,
      "reputation" : 521,
      "user_id" : 12733532,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-EAww28wDCxk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcgKS9dXdmUh-hOQPlZYZygBUfLwQ/s256-rj/photo.jpg",
      "display_name" : "Max",
      "link" : "https://stackoverflow.com/users/12733532/max"
    },
    "creation_date" : 1759927995,
    "last_activity_date" : 1759927995,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140784173,
    "post_id" : 79784757,
    "body" : "If I google &quot;spring cloud gateway premature closure&quot;, I get pretty decent looking results. Since only you have access to the code and configuration, given that you share none of it in your question, only you can know what is wrong.",
    "score" : 0,
    "owner" : {
      "account_id" : 187094,
      "reputation" : 5301,
      "user_id" : 424903,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
      "display_name" : "Gimby",
      "link" : "https://stackoverflow.com/users/424903/gimby"
    },
    "creation_date" : 1759933217,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}