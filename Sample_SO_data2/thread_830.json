{
  "question" : {
    "question_id" : 79771945,
    "title" : "Apache MINA SSH client in Shell mode - non-printable /escape characters polluting stream",
    "body" : "<p>I have some Java code that uses the Apache MINA SSH client to connect to a Windows server running OpenSSH.<br />\nThe objective is to get an <strong>interactive</strong> prompt (One that I can issue a command, get a response, then issue another command).<br />\nI have this working, however, the response I am getting from the stream has a load of extra stuff in it.<br />\n<strong>Please no answers suggesting to use exec() and chain multiple commands on one line using eg &amp;&amp; - this is NOT what I want. Some of the commands that I execute modify environment variables, etc, so if I started a new session for each command, those would get lost</strong><br />\nSome sample code:</p>\n<pre><code>        SshResponse response;\n        shell = session.createShellChannel();\n        shell.open();\n\n        in = shell.getInvertedOut();\n        response = getResponse();\n        System.out.println(String.join(&quot;\\r\\n&quot;, response.responseLines));\n\n        // Not really relevant to this question, but this is the kind of stuff I will be doing:\n        out = shell.getInvertedIn();       \n        out.write(&quot;setenv.bat\\r\\n&quot;.getBytes()); // Do something which sets some env variables\n        out.flush();\n        response = getResponse();\n        // Analyse response\n        out.write(&quot;dosomething_else\\r\\n&quot;.getBytes());\n        // etc\n\n        session.close(false);\n        client.stop();\n</code></pre>\n<p>See linked Gist at end of post for full working code.<br />\nTo summarise - essentially all <code>getResponse()</code> does is read <code>in</code> (The InputStream) character by character into a <code>StringBuilder</code>, and when it encounters a new line, adds that line to <code>responseLines</code> (A <code>List&lt;String&gt;</code>).<br />\nIt knows when to end by looking for the command prompt, eg, <code>C:\\Users\\Administrator&gt;</code><br />\nIt does not add the prompt line to the <code>responseLines</code>.</p>\n<p>Therefore, <code>responseLines</code> should only contain two lines:</p>\n<pre><code>Microsoft Windows [Version 10.0.26100.3775]\n(c) Microsoft Corporation. All rights reserved.\n</code></pre>\n<p>However, what I get is this:<br />\n<a href=\"https://i.sstatic.net/OlAqsP81.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/OlAqsP81.png\" alt=\"enter image description here\" /></a><br />\nLine 0 is pure pollution and should not be present at all.<br />\nLine 1 starts with some escape characters and something about conhost.exe, and then after that contains the Windows version number as it should.<br />\nLine 2 is 100% correct.<br />\nLine 3 is also pure pollution, again, some escape characters, and something to do with conhost.exe</p>\n<p>However, note in my code that do al <code>System.out.println(String.join(&quot;\\r\\n&quot;, response.responseLines));</code> - when I do this, it looks as per above - just the 2 copyright lines<br />\n<a href=\"https://i.sstatic.net/zOJ8cSU5.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/zOJ8cSU5.png\" alt=\"enter image description here\" /></a></p>\n<p>So my question is - what are these extra characters? I <em>think</em> they are maybe some kind of control characters - formatting or something? Each of the bad sequences starts with an <code>ESC</code> character, and there's also a <code>BEL</code> in there, too.<br />\nHow can I get rid of them from the response? Obviously, you could use Regexes or something to remove them, but ideally, I would prefer some method that means they don't even get in the response at all. I have written code which uses the exact same approach using the SSHJ library (Hell, <code>getResponse()</code> is identical in my SSHJ implementation), and I don't get this problem with SSHJ (Although unfortunately SFTP upload is broken in SSHJ - hence me looking into using Apache MINA instead), so I am guessing that this is something which is Apache MINA specific, and can maybe just be fixed with some configuration change.</p>\n<p>UPDATE: Here is a Gist which demonstrates the issue: <a href=\"https://gist.github.com/evilC/8c977c735dca358e944c3deed4a236a3\" rel=\"nofollow noreferrer\">https://gist.github.com/evilC/8c977c735dca358e944c3deed4a236a3</a><br />\nThe behaviour is slightly different in terms of the number of response lines (Sometimes 2 lines, sometimes 3, but not 4 like in the picture), however it does show the exact same escape characters. You will need to edit the machineName, userName, password etc to match your system.</p>\n",
    "tags" : [ "java", "ssh", "apache-mina" ],
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "is_answered" : false,
    "view_count" : 120,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1758636104,
    "creation_date" : 1758565503,
    "link" : "https://stackoverflow.com/questions/79771945/apache-mina-ssh-client-in-shell-mode-non-printable-escape-characters-pollutin",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140757049,
    "post_id" : 79771945,
    "body" : "Yes, they are in my output too. If you&#39;re determined to use that API and not sshj, then I&#39;d find an API that will allow you to parse out the ANSI escape sequences",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758721110,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140756467,
    "post_id" : 79771945,
    "body" : "@g00se Uncomment line 52 in the sample code - this will log each character it sees in the InputStream to the log, along with it&#39;s ASCII code. If you see code 27, you are seeing escape characters like I am. It&#39;s 100% not an artefact of the IDE.  At the end of the day, outputting to a file is not going to work for me, because I need to inspect the contents of the output - eg a command may result in an output of &quot;100 records written&quot;, which I would need to do a string comparison against - so the string needs to be free of pollution.",
    "score" : 0,
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "creation_date" : 1758705954,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140755664,
    "post_id" : 79771945,
    "body" : "Well actually that&#39;s how it worked out (Powershell being used) when I activated OpenSSH in Windows 10. I couldn&#39;t, owing to the way I was running it, easily show the debug value. But that&#39;s not really a good move anyway as there are too many variable factors caused by the IDE. It would be more reliable to write to a <code>ByteArrayOutputStream</code> or just a dump it into a binary file with <code>FileOutputStream</code> then inspect that. You can &#39;shadow&#39; that approach with your string output",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758665946,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140755416,
    "post_id" : 79771945,
    "body" : "@g00se As per the MS docs, CMD is the default. Your server probably has PS set via the reg key? Whatever, that is moot anyway, seeing as if I also set mine to Powershell, I see the exact same pollution. Did you inspect the value of response when debugging? as I mentioned, the output logged in the terminal will look fine. WRT Reader - do you have an example? getInvertedOut() does not accept a Reader, so not quite sure how I would go about this?",
    "score" : 0,
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "creation_date" : 1758654664,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140755390,
    "post_id" : 79771945,
    "body" : "I would caution to use a <code>Reader</code> as well, since recent Javas will by default be expecting UTF-8, which might be a bad assumption with Windows",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758653222,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140755363,
    "post_id" : 79771945,
    "body" : "fwiw I get <code>Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved.     Try the new cross-platform PowerShell https:&#47;&#47;aka.ms&#47;pscore6  Loading personal and system profiles took 617ms.</code> No apparent problems. Maybe you ought to reverse the sense of my previous comments ;)",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758652413,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754687,
    "post_id" : 79771945,
    "body" : "@g00se done. Added at the end of the OP",
    "score" : 0,
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "creation_date" : 1758635711,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754489,
    "post_id" : 79771945,
    "body" : "OK. It would help us to help you were you to provide a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758631800,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754334,
    "post_id" : 79771945,
    "body" : "@g00se RE JSch is not on approved software list. Only MINA and ssshj are. RE powershell - it&#39;s defo using CMD, I checked. Thanks for the input though!",
    "score" : 0,
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "creation_date" : 1758627985,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754193,
    "post_id" : 79771945,
    "body" : "I&#39;m wondering though why you&#39;re not using JSch which will theoretically not return &#39;metadata&#39;",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758624299,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754132,
    "post_id" : 79771945,
    "body" : "I was thinking that cruft (poss. ANSI escape sequences) is more likely to issue from Powershell than cmd.exe",
    "score" : 1,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758622656,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140754057,
    "post_id" : 79771945,
    "body" : "@g00se Nothing set for either server or client (Although I guess it&#39;s only relevant for the server, as the client is MINA, not OpenSSH)",
    "score" : 0,
    "owner" : {
      "account_id" : 1099417,
      "reputation" : 512,
      "user_id" : 1092198,
      "user_type" : "registered",
      "accept_rate" : 29,
      "profile_image" : "https://www.gravatar.com/avatar/f52c3ce467c84b779c8d0d467deaa949?s=256&d=identicon&r=PG",
      "display_name" : "Clive Galway",
      "link" : "https://stackoverflow.com/users/1092198/clive-galway"
    },
    "creation_date" : 1758621020,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140753122,
    "post_id" : 79771945,
    "body" : "Out of interest, what value is set for key <code>DefaultShell</code> in the registry under  <code>HKEY_LOCAL_MACHINE\\SOFTWARE\\OpenSSH</code>?",
    "score" : 1,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1758575751,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140752894,
    "post_id" : 79771945,
    "body" : "<a href=\"https://en.wikipedia.org/wiki/ANSI_escape_code\" rel=\"nofollow noreferrer\">ANSI Escape Codes</a>",
    "score" : 3,
    "owner" : {
      "account_id" : 3159259,
      "reputation" : 111562,
      "user_id" : 2670892,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/4iPV5.png?s=256",
      "display_name" : "greg-449",
      "link" : "https://stackoverflow.com/users/2670892/greg-449"
    },
    "creation_date" : 1758567713,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140752853,
    "post_id" : 79771945,
    "body" : "Probably ANSI escape codes (eg ESC 2J clears screen), you can check by printing the byte values, or to terminal which supports ANSI codes.",
    "score" : 4,
    "owner" : {
      "account_id" : 5998820,
      "reputation" : 16284,
      "user_id" : 4712734,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6e922a2cb7e2da59286f27b162aaca5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "DuncG",
      "link" : "https://stackoverflow.com/users/4712734/duncg"
    },
    "creation_date" : 1758566665,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}