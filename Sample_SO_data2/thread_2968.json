{
  "question" : {
    "question_id" : 79584625,
    "title" : "Java Spring - unit test config class",
    "body" : "<p>I have a Java Spring application with a <code>RedisService</code> for interacting with a Redis database. The <code>RedisService</code> constructor takes a <code>JedisPooled</code> object as the constructor dependency for using the Redis connection:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Repository\npublic class RedisService {\n    private final JedisPooled jedisPooled;\n\n    @Autowired\n    public RedisService(final JedisPooled jedisPooled) {\n        this.jedisPooled = jedisPooled;\n    }\n\n    public String set(final String key, final String val) {\n        return jedisPooled.set(key, val);\n    }\n\n    public String get(final String key) {\n        return jedisPooled.get(key);\n    }\n}\n</code></pre>\n<p>I use a <code>RedisServiceConfig</code> class to manage the configuration for this service:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class RedisServiceConfig {\n    @Bean\n    public RedisService redisService(@Value(&quot;${redis.auth.password}&quot;) final String redisAuthPassword,\n                                     @Value(&quot;${redis.endpoint}&quot;) final String redisEndpoint,\n                                     @Value(&quot;${redis.port}&quot;) final int redisPort) {\n        final JedisPooled jedisPooled;\n\n        try {\n            jedisPooled = new JedisPooled(redisEndpoint, redisPort, redisAuthPassword);\n        } catch (final Exception e) {\n            throw new JedisConnectionException(&quot;Error connecting to Redis&quot;);\n        }\n\n        return new RedisService(jedisPooled);\n    }\n}\n</code></pre>\n<p>How can I unit test the exception handling in the config class? I've tried something like this, but I can't quite get it to work:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class RedisServiceConfigTest {\n    @Mock\n    private JedisPooled mockJedisPooled;\n    @InjectMocks\n    private RedisServiceConfig redisServiceConfig;\n\n    @Test\n    public void testRedisServiceBeanCreation() {\n        when(mockJedisPooled.created()).thenThrow(new JedisConnectionException(&quot;Connection error&quot;));\n        // I need something ^ like this?\n\n        final RedisService redisService = redisServiceConfig.redisService(&quot;testPassword&quot;, &quot;localhost&quot;, 6379);\n\n        Assertions.assertNotNull(redisService);\n    }\n}\n</code></pre>\n<p>I've tried mocking the <code>mockJedisPooled</code> and tried to force it to throw exceptions. Is this the correct approach for unit testing a config class like this?</p>\n",
    "tags" : [ "java", "spring", "unit-testing", "mockito", "jedis" ],
    "owner" : {
      "account_id" : 13160610,
      "reputation" : 135,
      "user_id" : 9506231,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8b29f4cbd82a7413bb6e24d9523ae7ef?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user9506231",
      "link" : "https://stackoverflow.com/users/9506231/user9506231"
    },
    "is_answered" : true,
    "view_count" : 168,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1746304711,
    "creation_date" : 1745238142,
    "link" : "https://stackoverflow.com/questions/79584625/java-spring-unit-test-config-class",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79586162,
    "question_id" : 79584625,
    "body" : "<p>It looks like some refactoring is needed here.</p>\n<p>You're trying to unit test a configuration class that creates a <code>JedisPooled</code>\ninstance inside a <code>@Bean</code> method. Since <code>JedisPooled</code> is instantiated directly in the method, it can't be mocked via standard <code>@Mock</code> or <code>@InjectMocks</code>.</p>\n<p>Try to split the creation of <code>JedisPooled</code> into a separate <code>@Bean</code>, like this:</p>\n<pre><code>@Configuration\npublic class RedisServiceConfig {\n\n    @Bean\n    public JedisPooled jedisPooled(\n            @Value(&quot;${redis.auth.password}&quot;) String password,\n            @Value(&quot;${redis.endpoint}&quot;) String endpoint,\n            @Value(&quot;${redis.port}&quot;) int port)\n    {\n        try {\n            return new JedisPooled(endpoint, port, password);\n        } catch (Exception e) {\n            throw new JedisConnectionException(&quot;Error connecting to Redis&quot;, e);\n        }\n    }\n\n    @Bean\n    public RedisService redisService(JedisPooled jedisPooled) {\n        return new RedisService(jedisPooled);\n    }\n}\n</code></pre>\n<p>Let's simulate a connection error in the <code>JedisPooled</code> constructor, to make the test meaningful and realistic:</p>\n<pre><code>public class JedisPooled {\n\n    private String password;\n    private String endpoint;\n    private int port;\n\n    public JedisPooled(String password, int port, String endpoint) {\n        this.password = password;\n        this.endpoint = endpoint;\n        this.port = port;\n\n        // Simulate a connection failure for testing purposes\n        if (&quot;invalid-host&quot;.equals(endpoint)) {\n            throw new JedisConnectionException(&quot;Error connecting to Redis&quot;);\n        }\n    }\n...\n</code></pre>\n<p>Now you can mock <code>JedisPooled</code> in your unit test, and easily test the logic, something like:</p>\n<pre><code>@ExtendWith(MockitoExtension.class)\nclass RedisServiceConfigTest {\n\n    @Mock\n    private JedisPooled mockJedisPooled;\n\n    private RedisServiceConfig redisServiceConfig;\n\n    @BeforeEach\n    void setUp() {\n        redisServiceConfig = new RedisServiceConfig();\n    }\n\n    @Test\n    void testRedisServiceBeanUsesInjectedJedisPooled() {\n        RedisService redisService = redisServiceConfig.redisService(\n                mockJedisPooled\n        );\n\n        assertNotNull(redisService);\n        assertEquals(\n                &quot;mockJedisPooled&quot;,\n                redisService.getJedisPooled().toString()\n        );\n    }\n\n    @Test\n    void testJedisPooledBeanThrowsCustomExceptionWhenFails() {\n        JedisConnectionException thrown = assertThrows(\n                JedisConnectionException.class,\n                () -&gt; {\n                    config.jedisPooled(&quot;test-pass&quot;, &quot;invalid-host&quot;, 9999);\n                }\n        );\n        assertEquals(&quot;Error connecting to Redis&quot;, thrown.getMessage());\n    }\n}\n</code></pre>\n<p>If you want to play with <code>when(...).then Throw(...)</code>, then you can do this:</p>\n<pre><code>when(mockJedisPooled.get(&quot;someKey&quot;))\n      .thenThrow(new JedisConnectionException(&quot;boom&quot;));\n</code></pre>\n<p>But this is for testing the <code>RedisService</code> itself, not the configuration.</p>\n<p>If refactoring is not possible, you can use <a href=\"https://github.com/powermock/powermock\" rel=\"nofollow noreferrer\">PowerMock</a>, but this is not recommended in the general case (more complicated and depends on the bytecode hacks).</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 38931631,
      "reputation" : 671,
      "user_id" : 29023248,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/WxoZEuKw.png?s=256",
      "display_name" : "Aleksey Bykov",
      "link" : "https://stackoverflow.com/users/29023248/aleksey-bykov"
    },
    "creation_date" : 1745316259,
    "last_activity_date" : 1746304711,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140410606,
    "post_id" : 79584625,
    "body" : "Good point. Because the constructor doesn&#39;t <code>throw</code>, I have removed the try/catch, thank you",
    "score" : 0,
    "owner" : {
      "account_id" : 13160610,
      "reputation" : 135,
      "user_id" : 9506231,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8b29f4cbd82a7413bb6e24d9523ae7ef?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user9506231",
      "link" : "https://stackoverflow.com/users/9506231/user9506231"
    },
    "creation_date" : 1746787488,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140354381,
    "post_id" : 79584625,
    "body" : "For that constructor, I don&#39;t see anything in the constructor chain that would throw, so the try/catch should be removed.",
    "score" : 2,
    "owner" : {
      "account_id" : 8909811,
      "reputation" : 2861,
      "user_id" : 6650475,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fe85994d05ad7aaaa1c47d638b37bc45?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Andrew S",
      "link" : "https://stackoverflow.com/users/6650475/andrew-s"
    },
    "creation_date" : 1745238992,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79586162" : [ {
      "comment_id" : 140410638,
      "post_id" : 79586162,
      "body" : "You&#39;re welcome!) Cool to hear it was useful.",
      "score" : 0,
      "owner" : {
        "account_id" : 38931631,
        "reputation" : 671,
        "user_id" : 29023248,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/WxoZEuKw.png?s=256",
        "display_name" : "Aleksey Bykov",
        "link" : "https://stackoverflow.com/users/29023248/aleksey-bykov"
      },
      "creation_date" : 1746787870,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140410609,
      "post_id" : 79586162,
      "body" : "Thank you for the detailed answer. I have removed the try/catch as the constructor doesn&#39;t actually throw anything.",
      "score" : 0,
      "owner" : {
        "account_id" : 13160610,
        "reputation" : 135,
        "user_id" : 9506231,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/8b29f4cbd82a7413bb6e24d9523ae7ef?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "user9506231",
        "link" : "https://stackoverflow.com/users/9506231/user9506231"
      },
      "creation_date" : 1746787526,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}