{
  "question" : {
    "question_id" : 79655347,
    "title" : "Facing issue in moving focus b/w different components in Richtext&#39;s CodeArea in javaFx",
    "body" : "<p>i am trying to include a suggestion box (similar to VSCode's code completion box) in richtext's codearea. But it faces major issues:</p>\n<ol>\n<li>cursor doesn't change when the mouse is inside the suggestion box, it remains I-beam</li>\n<li>scroll doesn't work when doing with mouse inside the suggestion box, instead it scrolls the codearea</li>\n<li>position of suggestion box must be below the caret position on next line (Y-axis) and layoutX must be just at the caret's X position.</li>\n</ol>\n<p>java file</p>\n<pre><code>package com.example.notepad;\nimport javafx.application.Platform;\nimport javafx.fxml.FXML;\nimport javafx.geometry.Pos;\nimport javafx.scene.Cursor;\nimport javafx.scene.control.ListView;\nimport javafx.scene.input.KeyCode;\nimport javafx.scene.input.KeyEvent;\nimport javafx.scene.input.MouseEvent;\nimport javafx.scene.layout.StackPane;\nimport javafx.scene.layout.VBox;\nimport org.fxmisc.richtext.CodeArea;\n\nimport java.util.*;\nimport java.util.stream.Collectors;\n\npublic class suggestion_handler {\n\n    public VBox codeContainer;\n    @FXML private StackPane editorRoot;\n    @FXML public ListView&lt;String&gt; suggestionList;\n\n    private CodeArea codeArea;\n\n    @FXML\n    public void initialize() {\n        // This makes the suggestionBox itself transparent for mouse events\n        editorRoot.setMouseTransparent(false);\n        suggestionList.setCursor(Cursor.DEFAULT);\n\n\n        configureSuggestionList();\n        editorRoot.setCursor(Cursor.TEXT);\n        suggestionList.setCursor(Cursor.DEFAULT);\n    }\n\n    public void setCodeArea(CodeArea area) {\n        this.codeArea = area;\n        attachListeners();  // safe to call now, codeArea is assigned\n    }\n\n    private void configureSuggestionList() {\n        suggestionList.setFixedCellSize(24);\n\n        suggestionList.setFocusTraversable(false);\n\n        suggestionList.setOnMouseReleased(event -&gt; {\n            acceptSelected();\n            event.consume();\n        });\n        suggestionList.setOnScroll(event -&gt; {\n            if (codeArea != null) {\n                codeArea.fireEvent(event.copyFor(codeArea, codeArea));\n                event.consume();\n            }\n        });\n\n        suggestionList.setOnKeyPressed(event -&gt; {\n            if (event.getCode() == KeyCode.ENTER) acceptSelected();\n            else if (event.getCode() == KeyCode.ESCAPE) hideSuggestions();\n        });\n    }\n\n    private boolean listenersAttached = false;\n\n    private void attachListeners() {\n        if (listenersAttached || codeArea == null) return;\n        listenersAttached = true;\n\n        codeArea.textProperty().addListener((_, _, _) -&gt; Platform.runLater(this::showSuggestionsIfNeeded));\n        codeArea.caretPositionProperty().addListener((_, _, _) -&gt; Platform.runLater(this::showSuggestionsIfNeeded));\n\n        codeArea.addEventFilter(KeyEvent.KEY_PRESSED, event -&gt; {\n            if (suggestionList.isVisible()) {\n                suggestionList.getSelectionModel().selectFirst();\n                if (event.getCode() == KeyCode.UP) {\n                    suggestionList.requestFocus();\n                    suggestionList.getSelectionModel().selectFirst();\n                    event.consume();\n                } else if (event.getCode() == KeyCode.DOWN) {\n                    suggestionList.requestFocus();\n                    suggestionList.getSelectionModel().select(1);\n                    event.consume();\n                } else {\n                    if (event.getCode() == KeyCode.ENTER) {\n                        acceptSelected();\n                        event.consume();\n                    } else if (event.getCode() == KeyCode.ESCAPE) {\n                        hideSuggestions();\n                        event.consume();\n                    }\n                }\n            }\n            else codeArea.requestFocus();\n        });\n    }\n\n    private void showSuggestionsIfNeeded() {\n        String prefix = getCurrentWordPrefix();\n        System.out.println(prefix);\n        if (!prefix.isEmpty()) {\n            List&lt;String&gt; matches = findMatches(prefix);\n            if (!matches.isEmpty()) {\n                suggestionList.getItems().setAll(matches);\n                suggestionList.getSelectionModel().selectFirst();\n                showSuggestions();\n                positionSuggestionBox();\n                return;\n            }\n        }\n        hideSuggestions();\n    }\n\n    private String getCurrentWordPrefix() {\n        int caretPos = codeArea.getCaretPosition();\n        if (caretPos == 0) return &quot;&quot;;\n        String text = codeArea.getText(0, caretPos);\n        int i = text.length() - 1;\n        while (i &gt;= 0 &amp;&amp; Character.isLetterOrDigit(text.charAt(i))) i--;\n        return text.substring(i + 1);\n    }\n\n    private List&lt;String&gt; findMatches(String prefix) {\n        String text = codeArea.getText();\n        Set&lt;String&gt; words = new HashSet&lt;&gt;(Arrays.asList(text.split(&quot;\\\\W+&quot;)));\n        return words.stream()\n                .filter(w -&gt; !w.equals(prefix) &amp;&amp; w.startsWith(prefix))\n                .sorted()\n                .collect(Collectors.toList());\n    }\n\n    private void positionSuggestionBox() {\n        suggestionList.setPrefWidth(200);\n        suggestionList.setPrefHeight(120);\n        suggestionList.setMaxWidth(200);\n        suggestionList.setMaxHeight(120);\n        StackPane.setAlignment(suggestionList, Pos.TOP_LEFT); // necessary for layoutX/Y to apply\n\n        if (codeArea == null || suggestionList == null) return;\n\n        // Get the pixel position of the caret\n        int caretPos = codeArea.getCaretPosition();\n\n        try {\n            // Get the bounds of the caret in the editor\n            var caretBoundsOpt = codeArea.getCaretBounds();\n            if (caretBoundsOpt.isEmpty()) return;\n\n            var caretBounds = caretBoundsOpt.get();\n\n            // Convert local bounds of CodeArea caret to parent (StackPane) coordinates\n            var localToScene = codeArea.localToScene(caretBounds);\n            var sceneToParent = editorRoot.sceneToLocal(localToScene);\n\n            double x = localToScene.getMinX()+100;\n            double y = localToScene.getMaxY()+20;\n\n            suggestionList.setLayoutX(x);\n            suggestionList.setLayoutY(y);\n        } catch (Exception e) {\n            System.err.println(&quot;Failed to position suggestion box: &quot; + e.getMessage());\n        }\n    }\n\n    private void acceptSelected() {\n        String selected = suggestionList.getSelectionModel().getSelectedItem();\n        if (selected != null) {\n            selected+=&quot; &quot;;\n            int caretPos = codeArea.getCaretPosition();\n            int start = caretPos - 1;\n            String text = codeArea.getText();\n            while (start &gt;= 0 &amp;&amp; Character.isLetterOrDigit(text.charAt(start))) start--;\n            start++;\n            codeArea.replaceText(start, caretPos, selected);\n            codeArea.moveTo(start + selected.length());\n        }\n        hideSuggestions();\n        codeArea.requestFocus();\n    }\n\n    private void showSuggestions() {\n        suggestionList.setVisible(true);\n        suggestionList.setManaged(true);\n        suggestionList.setOnMouseEntered(e -&gt;{\n            suggestionList.setCursor(Cursor.DEFAULT);\n            suggestionList.requestFocus();\n            editorRoot.setMouseTransparent(false);\n        });\n        suggestionList.setOnMouseExited(e -&gt;{\n            suggestionList.setCursor(Cursor.TEXT);\n            codeArea.requestFocus();\n            editorRoot.setMouseTransparent(true);\n        });\n\n        suggestionList.setCursor(Cursor.DEFAULT);\n    }\n\n    private void hideSuggestions() {\n        editorRoot.setCursor(Cursor.TEXT);\n        editorRoot.setMouseTransparent(true);\n        suggestionList.setVisible(false);\n        suggestionList.setManaged(false);\n    }\n}\n</code></pre>\n<p>FXML code:</p>\n<pre><code>&lt;?import javafx.scene.layout.VBox?&gt;\n&lt;?import javafx.scene.layout.StackPane?&gt;\n&lt;?import javafx.scene.control.ListView?&gt;\n\n&lt;StackPane fx:id=&quot;editorRoot&quot; xmlns:fx=&quot;http://javafx.com/fxml&quot; fx:controller=&quot;com.example.notepad.suggestion_handler&quot;&gt;\n    &lt;VBox fx:id=&quot;codeContainer&quot;/&gt;\n        &lt;ListView fx:id=&quot;suggestionList&quot; visible=&quot;false&quot; managed=&quot;false&quot; /&gt;\n&lt;/StackPane&gt;\n</code></pre>\n",
    "tags" : [ "java", "javafx", "javafx-8", "fxml", "richtext" ],
    "owner" : {
      "account_id" : 30470319,
      "reputation" : 11,
      "user_id" : 23350347,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLOas3v5roF8wfmwQ0SR_Icvm4Suhm7eMTco6cYhZdY=k-s256",
      "display_name" : "Mick Lennar",
      "link" : "https://stackoverflow.com/users/23350347/mick-lennar"
    },
    "is_answered" : false,
    "view_count" : 37,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749276307,
    "creation_date" : 1749176642,
    "link" : "https://stackoverflow.com/questions/79655347/facing-issue-in-moving-focus-b-w-different-components-in-richtexts-codearea-in",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140633741,
    "post_id" : 79655347,
    "body" : "JavaFX 24 versions includes an <a href=\"https://bugs.openjdk.org/browse/JDK-8301121\" rel=\"nofollow noreferrer\">incubator rich text editor</a>.  You could try that if you can&#39;t get the functionality you want from the <code>org.fxmisc.richtext.CodeArea</code> that you are currently using.  You tagged the question as JavaFX 8, so if you are using that obsolete version of JavaFX and must stick with it, then the new inbuilt JavaFX rich text editor control won&#39;t work with that version and you can ignore this comment.",
    "score" : 0,
    "owner" : {
      "account_id" : 1180113,
      "reputation" : 160487,
      "user_id" : 1155209,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5192e7cbcf2f72a847d6fb0d1552f049?s=256&d=identicon&r=PG",
      "display_name" : "jewelsea",
      "link" : "https://stackoverflow.com/users/1155209/jewelsea"
    },
    "creation_date" : 1753989175,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}