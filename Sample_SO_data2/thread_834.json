{
  "question" : {
    "question_id" : 79771233,
    "title" : "android app for detecting user on bike then calculates total distance travelled while on bike not posting the total distance as a notification",
    "body" : "<p>I am trying to create an Android application that runs as a service in the background, it detects if am riding a bicycle and then starts calculating total distance traveled and stops when it detects am on foot. I have a service, a broadcast receiver and a main activity for requesting permissions from the user. I have declared all the relevant permisisons in the manifest but its just posting a single notification titled <strong>Monitoring activity</strong> which is a result of some code in the service.</p>\n<p><em>Manifest</em></p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;manifest xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;\n    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;\n\n    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACCESS_BACKGROUND_LOCATION&quot;/&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACTIVITY_RECOGNITION&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.POST_NOTIFICATIONS&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.RECEIVE_BOOT_COMPLETED&quot;/&gt;\n    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot;/&gt;\n    &lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_LOCATION&quot;/&gt;\n\n\n    &lt;application\n\n        android:allowBackup=&quot;true&quot;\n        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;\n        android:fullBackupContent=&quot;@xml/backup_rules&quot;\n        android:icon=&quot;@mipmap/ic_launcher&quot;\n        android:label=&quot;@string/app_name&quot;\n        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;\n        android:supportsRtl=&quot;true&quot;\n        android:theme=&quot;@style/Theme.BikeDistanceTracker&quot;\n        &gt;\n        &lt;service\n            android:foregroundServiceType=&quot;location&quot;\n            android:name=&quot;.BikeDetectionService&quot;\n            android:enabled=&quot;true&quot;\n            android:exported=&quot;false&quot; /&gt;\n\n        &lt;receiver\n\n            android:name=&quot;.BootReceiver&quot;\n            android:enabled=&quot;true&quot;\n            android:exported=&quot;true&quot;&gt;\n            &lt;intent-filter&gt;\n                &lt;action android:name=&quot;android.intent.action.BOOT_COMPLETED&quot; /&gt;\n            &lt;/intent-filter&gt;\n        &lt;/receiver&gt;\n        &lt;activity android:name=&quot;.PermissionActivity&quot;\n            android:exported=&quot;true&quot;&gt;\n            &lt;intent-filter&gt;\n                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;\n                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;\n            &lt;/intent-filter&gt;\n        &lt;/activity&gt;\n\n    &lt;/application&gt;\n\n\n&lt;/manifest&gt;\n</code></pre>\n<p><em>BikeDetectionService.java</em></p>\n<pre><code>package com.example.bikedistancetracker;\n\n\nimport android.Manifest;\nimport android.app.Notification;\nimport android.app.NotificationChannel;\nimport android.app.NotificationManager;\nimport android.app.Service;\nimport android.content.Intent;\nimport android.content.pm.PackageManager;\nimport android.location.Location;\nimport android.os.Build;\nimport android.os.IBinder;\nimport android.os.Looper;\nimport android.widget.Toast;\n\nimport androidx.annotation.Nullable;\nimport androidx.core.app.ActivityCompat;\nimport androidx.core.app.NotificationCompat;\n\nimport com.google.android.gms.location.ActivityRecognition;\nimport com.google.android.gms.location.ActivityRecognitionClient;\nimport com.google.android.gms.location.DetectedActivity;\nimport com.google.android.gms.location.FusedLocationProviderClient;\nimport com.google.android.gms.location.LocationCallback;\nimport com.google.android.gms.location.LocationRequest;\nimport com.google.android.gms.location.LocationResult;\nimport com.google.android.gms.location.LocationServices;\n\npublic class BikeDetectionService extends Service {\n    private static final String CHANNEL_ID = &quot;BikeTrackingChannel&quot;;\n    private ActivityRecognitionClient activityRecognitionClient;\n    private FusedLocationProviderClient fusedLocationClient;\n\n    private Location lastLocation;\n    private float totalDistance = 0f;\n    private boolean isRiding = false;\n\n    @Override\n    public int onStartCommand(Intent intent, int flags, int startId) {\n        int type = intent.getIntExtra(&quot;activityType&quot;, -1);\n        int confidence = intent.getIntExtra(&quot;confidence&quot;, -1);\n        handleActivity(type, confidence);\n        return START_STICKY;\n    }\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        createNotificationChannel();\n\n        // Start foreground service\n        Notification notification = new NotificationCompat.Builder(this, CHANNEL_ID)\n                .setContentTitle(&quot;Bike Tracker&quot;)\n                .setContentText(&quot;Monitoring activityâ€¦&quot;)\n                .setSmallIcon(R.drawable.ic_bike)\n                .build();\n        startForeground(1, notification);\n\n        activityRecognitionClient = ActivityRecognition.getClient(this);\n        fusedLocationClient = LocationServices.getFusedLocationProviderClient(this);\n\n        // Start listening for activity changes\n        requestActivityUpdates();\n    }\n\n    private void requestActivityUpdates() {\n        Intent intent = new Intent(this, BikeTransitionReceiver.class);\n        intent.setAction(&quot;BIKE_ACTIVITY_UPDATE&quot;);\n\n        // PendingIntent must target a BroadcastReceiver\n        android.app.PendingIntent pendingIntent = android.app.PendingIntent.getBroadcast(\n                this,\n                0,\n                intent,\n                android.app.PendingIntent.FLAG_UPDATE_CURRENT | android.app.PendingIntent.FLAG_IMMUTABLE\n        );\n\n        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACTIVITY_RECOGNITION) != PackageManager.PERMISSION_GRANTED) {\n            // TODO: Consider calling\n            //    ActivityCompat#requestPermissions\n            // here to request the missing permissions, and then overriding\n            //   public void onRequestPermissionsResult(int requestCode, String[] permissions,\n            //                                          int[] grantResults)\n            // to handle the case where the user grants the permission. See the documentation\n            // for ActivityCompat#requestPermissions for more details.\n            Toast.makeText(this, &quot;activity update permission denied&quot;, Toast.LENGTH_LONG).show();\n            return;\n        }\n        activityRecognitionClient.requestActivityUpdates(5000, pendingIntent);\n    }\n\n    // Called externally from BikeTransitionReceiver\n    public void handleActivity(int activityType, int confidence) {\n        if (activityType == DetectedActivity.ON_BICYCLE &amp;&amp; confidence &gt; 70) {\n            if (!isRiding) {\n                startRide();\n            }\n        } else if (isRiding &amp;&amp; (activityType == DetectedActivity.STILL || activityType == DetectedActivity.IN_VEHICLE)) {\n            stopRide();\n        }\n    }\n\n    private void startRide() {\n        isRiding = true;\n        totalDistance = 0f;\n        lastLocation = null;\n\n        LocationRequest locationRequest = LocationRequest.create()\n                .setInterval(5000)\n                .setFastestInterval(2000)\n                .setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);\n\n        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_FINE_LOCATION) != PackageManager.PERMISSION_GRANTED &amp;&amp; ActivityCompat.checkSelfPermission(this, Manifest.permission.ACCESS_COARSE_LOCATION) != PackageManager.PERMISSION_GRANTED) {\n            // TODO: Consider calling\n            //    ActivityCompat#requestPermissions\n            // here to request the missing permissions, and then overriding\n            //   public void onRequestPermissionsResult(int requestCode, String[] permissions,\n            //                                          int[] grantResults)\n            // to handle the case where the user grants the permission. See the documentation\n            // for ActivityCompat#requestPermissions for more details.\n            return;\n        }\n        fusedLocationClient.requestLocationUpdates(locationRequest, locationCallback, Looper.getMainLooper());\n    }\n\n    private void stopRide() {\n        isRiding = false;\n        fusedLocationClient.removeLocationUpdates(locationCallback);\n\n        // Save ride data to DB here (distance, time, etc.)\n        // Example: RideRepository.saveRide(totalDistance);\n\n        NotificationManager manager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);\n        Notification stoppedNotification = new NotificationCompat.Builder(this, CHANNEL_ID)\n                .setContentTitle(&quot;Ride Finished&quot;)\n                .setContentText(&quot;Distance: &quot; + totalDistance + &quot; meters&quot;)\n                .setSmallIcon(R.drawable.ic_bike)\n                .build();\n        manager.notify(2, stoppedNotification);\n    }\n\n    private LocationCallback locationCallback = new LocationCallback() {\n        @Override\n        public void onLocationResult(LocationResult locationResult) {\n            for (Location location : locationResult.getLocations()) {\n                if (lastLocation != null) {\n                    totalDistance += lastLocation.distanceTo(location);\n                }\n                lastLocation = location;\n            }\n        }\n    };\n    private void createNotificationChannel() {\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n            NotificationChannel channel = new NotificationChannel(\n                    CHANNEL_ID,\n                    &quot;Bike Tracking&quot;,\n                    NotificationManager.IMPORTANCE_LOW\n            );\n            NotificationManager manager = getSystemService(NotificationManager.class);\n            if (manager != null) {\n                if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n                    manager.createNotificationChannel(channel);\n                }\n            }\n        }\n    }\n\n    @Nullable\n    @Override\n    public IBinder onBind(Intent intent) {\n        return null; // not a bound service\n    }\n\n\n}\n\n</code></pre>\n<p><em>The Broadcast Receiver for detecting bike transitions</em></p>\n<pre><code>package com.example.bikedistancetracker;\n\nimport android.content.BroadcastReceiver;\nimport android.content.Context;\nimport android.content.Intent;\n\nimport com.google.android.gms.location.ActivityRecognitionResult;\nimport com.google.android.gms.location.DetectedActivity;\n\npublic class BikeTransitionReceiver extends BroadcastReceiver {\n    @Override\n    public void onReceive(Context context, Intent intent) {\n        if (ActivityRecognitionResult.hasResult(intent)) {\n            ActivityRecognitionResult result = ActivityRecognitionResult.extractResult(intent);\n            DetectedActivity activity = result.getMostProbableActivity();\n\n            Intent serviceIntent = new Intent(context, BikeDetectionService.class);\n            serviceIntent.putExtra(&quot;activityType&quot;, activity.getType());\n            serviceIntent.putExtra(&quot;confidence&quot;, activity.getConfidence());\n            context.startService(serviceIntent);\n        }\n    }\n}\n\n</code></pre>\n<p>I expected the code to detect on bike transition , starts calculating the distance and posts it as a notification but the only notification posted is <strong>Monitoring activity...</strong></p>\n<p>I have programatically requested all the relevant permissions from the user at runtime in my activity</p>\n<pre><code> private void requestAllPermissions() {\n        // Collect all the permissions you need\n        // (BOOT_COMPLETED is manifest-only, no runtime dialog)\n        String[] basePermissions = new String[]{\n                Manifest.permission.ACCESS_FINE_LOCATION,\n                Manifest.permission.ACCESS_COARSE_LOCATION,\n                Manifest.permission.ACTIVITY_RECOGNITION\n        };\n\n        // Add POST_NOTIFICATIONS only if Android 13+\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU) {\n            basePermissions = new String[]{\n                    Manifest.permission.ACCESS_FINE_LOCATION,\n                    Manifest.permission.ACCESS_COARSE_LOCATION,\n                    Manifest.permission.ACTIVITY_RECOGNITION,\n                    Manifest.permission.POST_NOTIFICATIONS,\n                    Manifest.permission.ACCESS_BACKGROUND_LOCATION\n            };\n        }\n\n        // Request them\n        ActivityCompat.requestPermissions(this, basePermissions, REQ_PERMISSIONS);\n    }\n\n</code></pre>\n",
    "tags" : [ "java", "android", "location" ],
    "owner" : {
      "account_id" : 15123707,
      "reputation" : 147,
      "user_id" : 30532921,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-6EyKrzo2EUU/AAAAAAAAAAI/AAAAAAAAASM/R-HEOF0Wpjk/s256-rj/photo.jpg",
      "display_name" : "So Few Against So Many",
      "link" : "https://stackoverflow.com/users/30532921/so-few-against-so-many"
    },
    "is_answered" : true,
    "view_count" : 60,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1758519690,
    "creation_date" : 1758515929,
    "link" : "https://stackoverflow.com/questions/79771233/android-app-for-detecting-user-on-bike-then-calculates-total-distance-travelled",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79771260,
    "question_id" : 79771233,
    "body" : "<p>You're incorrectly registering your activity.  StartForeground() needs to be called in onStartCommand, not onCreate.  Calling it in onCreate is too early and will be ignored, the service is not yet eligible to become foreground.  This may not be your only bug, but it's definitely one of them.</p>\n<p>In addition, remember this will not work forever.  Foreground services still eventually get killed for resources, they're just more robust.  So if your thought is that it will run in the background all the time from when the user boots up their phone until they power it down-  that will never work on Android.  If you expect it to work only after they start your app for a few hours, then it likely will.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1790714,
      "reputation" : 94818,
      "user_id" : 1631193,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://www.gravatar.com/avatar/ac9dfee58394495fa69f12f58a928be3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Gabe Sechan",
      "link" : "https://stackoverflow.com/users/1631193/gabe-sechan"
    },
    "creation_date" : 1758519690,
    "last_activity_date" : 1758519690,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140751506,
    "post_id" : 79771233,
    "body" : "@Stultuske, there is an existing health app built by Samsung that automatically detects if riding or on foot.",
    "score" : 0,
    "owner" : {
      "account_id" : 15123707,
      "reputation" : 147,
      "user_id" : 30532921,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-6EyKrzo2EUU/AAAAAAAAAAI/AAAAAAAAASM/R-HEOF0Wpjk/s256-rj/photo.jpg",
      "display_name" : "So Few Against So Many",
      "link" : "https://stackoverflow.com/users/30532921/so-few-against-so-many"
    },
    "creation_date" : 1758529284,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140751405,
    "post_id" : 79771233,
    "body" : "you expect your phone to know whether you are riding a bike or not?",
    "score" : 0,
    "owner" : {
      "account_id" : 3116234,
      "reputation" : 9469,
      "user_id" : 2636929,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/85fa83a02c04af43fcd224821ca9b750?s=256&d=identicon&r=PG",
      "display_name" : "Stultuske",
      "link" : "https://stackoverflow.com/users/2636929/stultuske"
    },
    "creation_date" : 1758526630,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}