{
  "question" : {
    "question_id" : 79562498,
    "title" : "Spring Boot 3 migration: Started getting org.springframework.ws.client.WebServiceTransportException: Missing certificate authentication [403]",
    "body" : "<p>After upgrading to spring boot 3.4 from spring boot 2.5, We started getting 403 missing certificate authentication while calling a client SOAP service. We have the correct keystore and cacerts. We can get response from REST APIs hosted at same host. Here is my marshler configuration class. I have tried multiple different ways to pass the keystore and truststore but can't figure out what's missing. Can someone please suggest what I might be missing</p>\n<pre><code>@SpringBootConfiguration\n@EnableAutoConfiguration\npublic class SoapConfiguration {\n    \n    @Bean\n    public Jaxb2Marshaller awardsMarshaller() {\n        Jaxb2Marshaller marshaller = new Jaxb2Marshaller();\n        marshaller.setContextPath(&quot;com.google.get&quot;);\n        return marshaller;\n    }\n\n    @Bean\n    public AwardsClient awardsClient(Jaxb2Marshaller awardsMarshaller) throws Exception {\n        AwardsClient client = new AwardsClient();\n        client.setDefaultUri(kpmgUrl);\n        client.setMarshaller(awardsMarshaller);\n        client.setUnmarshaller(awardsMarshaller);\n        client.setMessageSender(getKpmgHttpComponentsMessageSender());\n        return client;\n    }   \n\n      @Bean \n      public HttpComponents5MessageSender getKpmgHttpComponentsMessageSender() throws Exception {\n      final HttpComponents5MessageSender sender = new HttpComponents5MessageSender();\n      sender.setConnectionTimeout(Duration.ofMillis(kpmgConnectionTimeout));\n      sender.setReadTimeout(Duration.ofMillis(kpmgReadTimeout));\n      sender.setHttpClient(getKpmgHttpClient()); \n      return sender; \n      }\n      \n        @Bean\n        public HttpClient getKpmgHttpClient() throws Exception {\n            PoolingHttpClientConnectionManager httpClientConnectionManager;\n                SSLConnectionSocketFactory sslSocketFactory = getSSLConnectionSocketFactory();\n                httpClientConnectionManager = new PoolingHttpClientConnectionManager(\n                        RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()\n                                .register(&quot;http&quot;, PlainConnectionSocketFactory.getSocketFactory())\n                                .register(&quot;https&quot;, sslSocketFactory).build());\n                httpClientConnectionManager.setDefaultMaxPerRoute(3000);\n                httpClientConnectionManager.setMaxTotal(4000);\n                httpClientConnectionManager.setDefaultConnectionConfig(ConnectionConfig.custom().setValidateAfterInactivity(TimeValue.ofMilliseconds(120000))\n                        .setConnectTimeout(Timeout.ofMilliseconds(3000)).build());\n                HttpClientBuilder httpClientBuilder = HttpClients.custom()\n                        .setConnectionManager(httpClientConnectionManager).setConnectionManagerShared(true)\n                        .addRequestInterceptorFirst(new RemoveSoapHeadersInterceptor()) ;\n            return httpClientBuilder.build();\n        }\n        \n        private SSLConnectionSocketFactory getSSLConnectionSocketFactory() throws Exception {\n            HostnameVerifier hostnameVerifier = null;\n                hostnameVerifier = NoopHostnameVerifier.INSTANCE;\n\n            try {\n                return new SSLConnectionSocketFactory(getKpmgSSLContext(), hostnameVerifier);\n            } catch (Exception e) {\n                throw new Exception(e.getCause());\n            }\n        }\n\n    @Bean\n    public SSLContext getKpmgSSLContext() {\n        SSLContext sslContext;\n        try {\n            byte[] passwd = Base64.getDecoder().decode(keyStorePassword);\n            byte[] keyStoreBytes = BaseEncoding.base64().decode(encodedkeyStore);\n            String keypassword = new String(passwd, StandardCharsets.UTF_8);\n            KeyStore keyStore = KeyStore.getInstance(&quot;jks&quot;);\n            byte[] trustStoreBytes = BaseEncoding.base64().decode(encodedTrustStore);\n            KeyStore trustStore = KeyStore.getInstance(&quot;jks&quot;);\n            keyStore.load(new ByteArrayInputStream(keyStoreBytes), null);\n            trustStore.load(new ByteArrayInputStream(trustStoreBytes), null);\n            \n              sslContext = new SSLContextBuilder().loadKeyMaterial(keyStore, keypassword.toCharArray()).loadTrustMaterial(new File(&quot;\\\\cacerts2.jks&quot;), keypassword.toCharArray())\n                      .build();\n             \n\n            return sslContext;\n        } catch (KeyManagementException | KeyStoreException | UnrecoverableKeyException e) {\n        } catch (NoSuchAlgorithmException | CertificateException | IOException e) {\n        }\n        return null;\n    }\n    \n    }\n</code></pre>\n<p>Exception:</p>\n<pre><code>org.springframework.ws.client.WebServiceTransportException: Missing certificate authentication [403]\n    at org.springframework.ws.client.core.WebServiceTemplate.handleError(WebServiceTemplate.java:666) ~[spring-ws-core-4.0.11.jar:?]\n    at org.springframework.ws.client.core.WebServiceTemplate.doSendAndReceive(WebServiceTemplate.java:588) ~[spring-ws-core-4.0.11.jar:?]\n    at org.springframework.ws.client.core.WebServiceTemplate.sendAndReceive(WebServiceTemplate.java:539) ~[spring-ws-core-4.0.11.jar:?]\n    at org.springframework.ws.client.core.WebServiceTemplate.marshalSendAndReceive(WebServiceTemplate.java:391) ~[spring-ws-core-4.0.11.jar:?]\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:?]\n    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:77) ~[?:?]\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:?]\n    at java.base/java.lang.reflect.Method.invoke(Method.java:568) ~[?:?]\n    at org.glassfish.jersey.server.model.internal.ResourceMethodInvocationHandlerFactory.lambda$static$0(ResourceMethodInvocationHandlerFactory.java:52) ~[jersey-server-3.1.10.jar:?]\n    at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher$1.run(AbstractJavaResourceMethodDispatcher.java:146) [jersey-server-3.1.10.jar:?]\n    at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.invoke(AbstractJavaResourceMethodDispatcher.java:189) [jersey-server-3.1.10.jar:?]\n    at org.glassfish.jersey.server.model.internal.JavaResourceMethodDispatcherProvider$TypeOutInvoker.doDispatch(JavaResourceMethodDispatcherProvider.java:219) [jersey-server-3.1.10.jar:?]\n    at org.glassfish.jersey.server.model.internal.AbstractJavaResourceMethodDispatcher.dispatch(AbstractJavaResourceMethodDispatcher.java:93) [jersey-server-3.1.10.jar:?]\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "java-17", "spring-boot-3" ],
    "owner" : {
      "account_id" : 14633560,
      "reputation" : 165,
      "user_id" : 10568521,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-9qt2zgjy28s/AAAAAAAAAAI/AAAAAAAABQA/SaIgZdjvd84/s256-rj/photo.jpg",
      "display_name" : "NOT_FOUND",
      "link" : "https://stackoverflow.com/users/10568521/not-found"
    },
    "is_answered" : false,
    "view_count" : 121,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1744126800,
    "creation_date" : 1744126800,
    "link" : "https://stackoverflow.com/questions/79562498/spring-boot-3-migration-started-getting-org-springframework-ws-client-webservic",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140318951,
    "post_id" : 79562498,
    "body" : "Looking at the error it looks like it expects a certificate for mutual TLS and not sure if that is what you are setting up currently. Could you also add the full stacktrace?",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1744263983,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140317286,
    "post_id" : 79562498,
    "body" : "The keystore is base64 encoded. It is part of the properties. However I tried adding keystore directly by providing path, and ran it in debug to make sure it is loading fine. Also added loggers in catch block but don&#39;t see any exception. Earlier too, the configuration was exactly same, only difference is httpclient5 classes instead of httpclient.",
    "score" : 0,
    "owner" : {
      "account_id" : 14633560,
      "reputation" : 165,
      "user_id" : 10568521,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-9qt2zgjy28s/AAAAAAAAAAI/AAAAAAAABQA/SaIgZdjvd84/s256-rj/photo.jpg",
      "display_name" : "NOT_FOUND",
      "link" : "https://stackoverflow.com/users/10568521/not-found"
    },
    "creation_date" : 1744219584,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140314639,
    "post_id" : 79562498,
    "body" : "Please include the previous working configuration as well.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1744180299,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140314561,
    "post_id" : 79562498,
    "body" : "Remove the try/catches you have or at least catch the exception, wrap it in a runtime exception and let it crash your application. Currently it silenty fails. I would also suggest to use the <code>KeyStoreFactoryBean</code> to load the keystore. Where is your keystore located? You are trying to load it as a file but that will fail if it is on the classpath. You are also missing the actual property values and how get those properties in your file. I would also suggest to use <code>@Configuration</code> instead of <code>@SpringBootConfiguration</code> and the <code>@EnableAutoConfiguration</code> isn&#39;t needed.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1744178524,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}