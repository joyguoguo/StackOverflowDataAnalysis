{
  "question" : {
    "question_id" : 79600123,
    "title" : "Nonce not working in browser even though it is set in policy and script",
    "body" : "<p>The nonce doesn't seem to work anywhere. Currently we cut out everything that could make problems, since of course it should be generated, but now it is just static for testing purposes.</p>\n<p>Our content policy is defined in our filter:</p>\n<pre><code>@Component\npublic class CSPFilter extends OncePerRequestFilter {\n\n    @Override\n    public void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws IOException, ServletException {\n\n        HttpServletResponse httpResponse = (HttpServletResponse) response;\n\n        SecureRandom random = new SecureRandom();\n\n        byte[] nonceBytes = new byte[16];\n\n        random.nextBytes(nonceBytes);\n\n        String nonce = Base64.getEncoder().encodeToString(nonceBytes);\n        nonce = &quot;static&quot;;\n\n        String policy = &quot;default-src 'self'; script-src 'self' 'nonce-&quot; + nonce + &quot;'  img-src 'self'; object-src 'none';&quot;;\n\n        var oldHeader = httpResponse.getHeader(&quot;Content-Security-Policy&quot;);\n        if (oldHeader!=null) {\n            oldHeader = oldHeader + &quot; &quot; + policy;\n            httpResponse.setHeader(&quot;Content-Security-Policy&quot;, oldHeader);\n        }\n        else\n            httpResponse.setHeader(&quot;Content-Security-Policy&quot;, policy);\n\n        request.setAttribute(&quot;nonce&quot;, nonce);\n\n        filterChain.doFilter(request, response);\n    }\n}\n</code></pre>\n<p>and the html looks like this:</p>\n<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot; xmlns:th=&quot;https://www.thymeleaf.org&quot;&gt;\n&lt;!DOCTYPE html&gt;\n&lt;head&gt;\n    &lt;title&gt;Login to ToDo Roo&lt;/title&gt;\n    &lt;link th:href=&quot;@{/main.css}&quot; rel=&quot;stylesheet&quot;/&gt;\n&lt;/head&gt;\n&lt;body  nonce=&quot;static&quot; class=&quot;todoroo-body&quot; onload=&quot;test()3&quot;&gt;\n&lt;script language=&quot;text/javascript&quot; nonce=&quot;static&quot;&gt;function test3(){console.log(&quot;this should work&quot;)}&lt;/script&gt;\n&lt;script&gt;function test(){console.log(&quot;this shouldn't work&quot;)}&lt;/script&gt;\n&lt;h2 th:nonce=&quot;${nonce}&quot; th:text=&quot;${nonce}&quot; align=&quot;center&quot;&gt;&lt;/h2&gt;\n\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n<p>yet all browsers state something like this:</p>\n<blockquote>\n<p>Content-Security-Policy: The page’s settings blocked an event handler\n(script-src-attr) from being executed because it violates the\nfollowing directive: “script-src 'self' 'nonce-static' http://img-src\n'self'” Source: test()3</p>\n</blockquote>\n<p><img src=\"https://i.sstatic.net/5VxRr6HO.png\" alt=\"\" /></p>\n<blockquote>\n<p>Content-Security-Policy: The page’s settings blocked an inline script\n(script-src-elem) from being executed because it violates the\nfollowing directive: “script-src 'self' 'nonce-static' http://img-src\n'self'”</p>\n</blockquote>\n<p><img src=\"https://i.sstatic.net/ttDOM1yf.png\" alt=\"\" /></p>\n<p>We tried multiple solutions, even putting the content policy into a meta tag and loading the site by drag and drop into the browser. We tried multiple policy options like &quot;unsafe-hashes&quot; or the like to no avail.</p>\n",
    "tags" : [ "java", "html", "content-security-policy", "nonce" ],
    "owner" : {
      "account_id" : 10691839,
      "reputation" : 11,
      "user_id" : 8020931,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gnrrV9Iz.png?s=256",
      "display_name" : "Ezydenias",
      "link" : "https://stackoverflow.com/users/8020931/ezydenias"
    },
    "is_answered" : true,
    "view_count" : 189,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1746172340,
    "creation_date" : 1746008718,
    "link" : "https://stackoverflow.com/questions/79600123/nonce-not-working-in-browser-even-though-it-is-set-in-policy-and-script",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79602991,
    "question_id" : 79600123,
    "body" : "<p>The problem is that you use a script attribute with an inline event handler 'onload=&quot;test()3&quot;' (or 'onload=&quot;test3()&quot;'). Script attributes are not nonceable elements. You should add this with an event listeners instead, or add its hash and 'unsafe-hashes' to script-src.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 12717906,
      "reputation" : 3723,
      "user_id" : 9239311,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2bef7e51f3fc072a88efd5d1e93fceb6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Halvor Sakshaug",
      "link" : "https://stackoverflow.com/users/9239311/halvor-sakshaug"
    },
    "creation_date" : 1746172340,
    "last_activity_date" : 1746172340,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140396705,
    "post_id" : 79600123,
    "body" : "what I meant was, that it didn&#39;t changed the output in the slightest, and that we used specifically these two options, tried different combinations of those two options, and they all resulted in the exact same outcome.",
    "score" : 0,
    "owner" : {
      "account_id" : 10691839,
      "reputation" : 11,
      "user_id" : 8020931,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gnrrV9Iz.png?s=256",
      "display_name" : "Ezydenias",
      "link" : "https://stackoverflow.com/users/8020931/ezydenias"
    },
    "creation_date" : 1746446023,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389244,
    "post_id" : 79600123,
    "body" : "@Ezydenias What C3roe means is if you tried something, you&#39;re supposed to show exactly what you tried - meaning the exact code you used, and whether it resulted in any different error messages or results, or not. Then we can a) rule out incorrect usage or further typos as the reason it failed and b) see if it had <i>any effect</i> at all. &quot;No avail&quot; isn&#39;t a useful description of the outcome, and a description of code does not convey the  same level of information as actual code. Programmers are supposed to have precision and specificity as one of their key skills.",
    "score" : 0,
    "owner" : {
      "account_id" : 7869117,
      "reputation" : 62884,
      "user_id" : 5947043,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/jUK37.png?s=256",
      "display_name" : "ADyson",
      "link" : "https://stackoverflow.com/users/5947043/adyson"
    },
    "creation_date" : 1746172617,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140388983,
    "post_id" : 79600123,
    "body" : "yes it should be test3(). But that sadly doesn&#39;t solve the problem,  Also the policy is set like that, striping away more of the policy string doesn&#39;t result in a different outcome.  I don&#39;t know what more details you want, we had &quot;unsafe-hashes&quot; and &quot;unsafe-inline&quot;",
    "score" : 0,
    "owner" : {
      "account_id" : 10691839,
      "reputation" : 11,
      "user_id" : 8020931,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gnrrV9Iz.png?s=256",
      "display_name" : "Ezydenias",
      "link" : "https://stackoverflow.com/users/8020931/ezydenias"
    },
    "creation_date" : 1746165171,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140383706,
    "post_id" : 79600123,
    "body" : "<code>onload=&quot;test()3&quot;</code> looks like a typo...shouldn&#39;t it be <code>onload=&quot;test3()&quot;</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 7869117,
      "reputation" : 62884,
      "user_id" : 5947043,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/jUK37.png?s=256",
      "display_name" : "ADyson",
      "link" : "https://stackoverflow.com/users/5947043/adyson"
    },
    "creation_date" : 1746009552,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140383704,
    "post_id" : 79600123,
    "body" : "I would try <code>script-src &#39;nonce-static&#39;</code> as a policy.",
    "score" : 0,
    "owner" : {
      "account_id" : 38870157,
      "reputation" : 679,
      "user_id" : 28993166,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/40f55b63213d62c189e6dfd59ab06e04?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Frox",
      "link" : "https://stackoverflow.com/users/28993166/frox"
    },
    "creation_date" : 1746009492,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140383699,
    "post_id" : 79600123,
    "body" : "<i>&quot;We tried multiple policy options like &quot;unsafe-hashes&quot; or the like to no avail.&quot;</i> - details, please.",
    "score" : 1,
    "owner" : {
      "account_id" : 1530592,
      "reputation" : 97801,
      "user_id" : 1427878,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6bd890954a792dbee22792c2402f13a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "C3roe",
      "link" : "https://stackoverflow.com/users/1427878/c3roe"
    },
    "creation_date" : 1746009426,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140383688,
    "post_id" : 79600123,
    "body" : "<a href=\"https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Content-Security-Policy/script-src-attr#source-expression-list\" rel=\"nofollow noreferrer\">developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/&zwnj;&#8203;&hellip;</a> lists only <code>&#39;unsafe-hashes&#39;</code>, <code>&#39;unsafe-inline&#39;</code> and <code>&#39;report-sample&#39;</code> as valid source expressions for <code>script-src-attr</code> - so I don&#39;t think using nonces is even possible for this particular purpose.",
    "score" : 1,
    "owner" : {
      "account_id" : 1530592,
      "reputation" : 97801,
      "user_id" : 1427878,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6bd890954a792dbee22792c2402f13a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "C3roe",
      "link" : "https://stackoverflow.com/users/1427878/c3roe"
    },
    "creation_date" : 1746009293,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79602991" : [ {
      "comment_id" : 140396785,
      "post_id" : 79602991,
      "body" : "thanks, this solved the problem we where facing.",
      "score" : 0,
      "owner" : {
        "account_id" : 10691839,
        "reputation" : 11,
        "user_id" : 8020931,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/gnrrV9Iz.png?s=256",
        "display_name" : "Ezydenias",
        "link" : "https://stackoverflow.com/users/8020931/ezydenias"
      },
      "creation_date" : 1746447436,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}