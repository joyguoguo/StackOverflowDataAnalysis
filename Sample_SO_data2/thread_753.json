{
  "question" : {
    "question_id" : 79769651,
    "title" : "java.io.IOException: request to write bytes exceeds size in header of bytes for entry make more robust",
    "body" : "<p>I'm trying to convert a zip into a TAR. For this I'm using a <em>visitor</em>, but sometimes when I'm doing the conversion I have a:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Caused by: platform.kernel.io.compresser.CompresserException: \n    at platform.kernel.io.compresser.TarIdefixCompresser.compress(TarIdefixCompresser.java:69)\n    at platform.kernel.io.compresser.IdefixCompresser.compress(IdefixCompresser.java:165)\n    at telegestion.daemon.sadmin.distribution.NodeFilesConsumer.sendFile(NodeFilesConsumer.java:351)\n    ... 9 more\nCaused by: java.io.IOException: request to write '69013' bytes exceeds size in header of '198041' bytes for entry 'CAT_ST_20250108-215416738.zip'\n    at org.apache.commons.compress.archivers.tar.TarArchiveOutputStream.write(TarArchiveOutputStream.java:377)\n    at platform.kernel.io.compresser.TarVisitor.visitFile(TarVisitor.java:55)\n    at platform.kernel.io.compresser.TarVisitor.visitFile(TarVisitor.java:27)\n    at java.nio.file.Files.walkFileTree(Unknown Source)\n    at java.nio.file.Files.walkFileTree(Unknown Source)\n    at platform.kernel.io.compresser.TarIdefixCompresser.compress(TarIdefixCompresser.java:66)\n    ... 11 more\n    Suppressed: java.io.IOException: This archives contains unclosed entries.\n        at org.apache.commons.compress.archivers.tar.TarArchiveOutputStream.finish(TarArchiveOutputStream.java:220)\n        at org.apache.commons.compress.archivers.tar.TarArchiveOutputStream.close(TarArchiveOutputStream.java:236)\n        at platform.kernel.io.compresser.TarIdefixCompresser.compress(TarIdefixCompresser.java:68)\n        ... 11 more\n</code></pre>\n<p>The method <code>visitFile</code> of <code>TarVisitor</code> class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic FileVisitResult visitFile(Path pFile, BasicFileAttributes pAttrs) throws IOException {\n    try (FileInputStream lFis = new FileInputStream(pFile.toFile())) {\n        ArchiveEntry lArchiveEntry = tarOs.createArchiveEntry(pFile.toFile(), \n                pFile.getFileName().toString());\n        tarOs.putArchiveEntry(lArchiveEntry);\n        byte[] lBytesTampon = new byte[bufferSize];\n        int lCount;\n        while ((lCount = lFis.read(lBytesTampon)) != -1) {\n            tarOs.write(lBytesTampon, 0, lCount);\n        }\n    }\n    tarOs.closeArchiveEntry();\n    return FileVisitResult.CONTINUE;\n}\n</code></pre>\n<p>I would like to know how can I make my method more robust and avoid this type of problem.\nShould I do a retry for each exception?\nI expect that my ZIP file is not well closed after its creation, so the direct conversion in a tar can be sometimes not really stable.\nShould I have something like <code>fos.getFD().sync();</code> after my try-with-resources ?</p>\n<p>The code that compresses my file into zip:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic List&lt;Path&gt; compress(String pFileName, Path pParentPath, List&lt;Path&gt; pPathlist,\n        Integer pLevel, boolean pDeleteInputFiles) throws CompresserException {\n\n    String lFileName = pFileName + getExtension();\n    Path lPathCompressed = pParentPath.resolve(lFileName);\n    List&lt;Path&gt; lPathReturn = new ArrayList&lt;&gt;();\n    lPathReturn.add(lPathCompressed);\n    logCompression(lFileName, pPathlist);\n    try (ZipOutputStream lZipOs = \n            new ZipOutputStream(new FileOutputStream(lPathCompressed.toFile()))) {\n        lZipOs.setLevel(pLevel);\n        for (Path lPath : pPathlist) {\n            ZipVisitor lZipVisitor = new ZipVisitor(lZipOs, BUFFER_SIZE);\n            Files.walkFileTree(lPath, lZipVisitor);\n        }\n    } catch (IOException lEx) {\n        throw new CompresserException(IdefixComponentName.NONE,\n                KernelError.COMPRESSION_ERROR, lEx, &quot;ZIP&quot;);\n    }\n    return lPathReturn;\n}\n</code></pre>\n",
    "tags" : [ "java", "zip", "tar", "apache-commons-compress" ],
    "owner" : {
      "account_id" : 26474010,
      "reputation" : 25,
      "user_id" : 20114202,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4a1804f0df3c7ae7c455e8a5b7b027f8?s=256&d=identicon&r=PG",
      "display_name" : "Etienne",
      "link" : "https://stackoverflow.com/users/20114202/etienne"
    },
    "is_answered" : true,
    "view_count" : 83,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1758555516,
    "creation_date" : 1758293029,
    "link" : "https://stackoverflow.com/questions/79769651/java-io-ioexception-request-to-write-bytes-exceeds-size-in-header-of-bytes-for",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79769703,
    "question_id" : 79769651,
    "body" : "<p>I believe that the problem here is in your <code>compress()</code> method.</p>\n<p>If an error occurs at certain steps in closing a <code>ZipOutputStream</code>, it's possible for the underlying output stream to remain open. In this case, that's the <code>FileOutputStream</code> that you create directly to the <code>ZipOutputStream</code> constructor.</p>\n<p>First, I would recommend managing the underlying output stream via the try-with-resource block:</p>\n<pre class=\"lang-java prettyprint-override\"><code>try (OutputStream lFileOs = new FileOutputStream(lPathCompressed.toFile());\n     ZipOutputStream lZipOs = new ZipOutputStream(lFileOs)) {\n    ...\n</code></pre>\n<p>This will ensure that the <code>FileOutputStream</code> is closed, and I believe that will address the error from your <code>TarVisitor</code>.</p>\n<p>Beyond that, though, if an error occurs during the compression of the ZIP file, that archive is corrupt, and it doesn't make sense to turn around and add it to the TAR archive. So it would be worthwhile to explore the larger error-handling flow around the <code>compress()</code> method.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2496,
      "reputation" : 270515,
      "user_id" : 3474,
      "user_type" : "registered",
      "accept_rate" : 83,
      "profile_image" : "https://www.gravatar.com/avatar/ffbf4e85b8ffbae4e9039b9c0cf07bc8?s=256&d=identicon&r=PG",
      "display_name" : "erickson",
      "link" : "https://stackoverflow.com/users/3474/erickson"
    },
    "creation_date" : 1758296470,
    "last_activity_date" : 1758555516,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140751959,
    "post_id" : 79769651,
    "body" : "It’s not clear how the zip file relates to the tar file. The call <code>tarOs.createArchiveEntry(pFile.toFile(), …</code> attempts to convert the <code>Path</code> to a <code>java.io.File</code> before passing it to the archive. This can only work for the default filesystem, but not for a zip filesystem. So if you are not operating on a zip filesystem but the default filesystem at this point, the whole mentioning of the zip file is an unnecessary distraction, as the tar compressor doesn’t see any zip file artifacts.",
    "score" : 1,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1758543485,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140751711,
    "post_id" : 79769651,
    "body" : "The stack trace I shared is the only one that I have, the problem occurs in our client production system.  As well a the Hungarian notation, I&#39;m on a legacy project aged of 10 years old so we decide to keep the standard even if I personnally don&#39;t thing it is usefull",
    "score" : 1,
    "owner" : {
      "account_id" : 26474010,
      "reputation" : 25,
      "user_id" : 20114202,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4a1804f0df3c7ae7c455e8a5b7b027f8?s=256&d=identicon&r=PG",
      "display_name" : "Etienne",
      "link" : "https://stackoverflow.com/users/20114202/etienne"
    },
    "creation_date" : 1758535430,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140749647,
    "post_id" : 79769651,
    "body" : "Starting every parameter with <code>p</code> and every local variable with <code>l</code> is a practice known as Hungarian notation, which has been understood as being more harmful than helpful for many years now.  You may think it helps readability, but in fact it makes your code less readable.",
    "score" : 0,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44936,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1758402689,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140747640,
    "post_id" : 79769651,
    "body" : "I suggest that you post the entire stack trace as well as a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 2485939,
      "reputation" : 20969,
      "user_id" : 2164365,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/RKSgV.png?s=256",
      "display_name" : "Abra",
      "link" : "https://stackoverflow.com/users/2164365/abra"
    },
    "creation_date" : 1758296257,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79769703" : [ {
      "comment_id" : 140752439,
      "post_id" : 79769703,
      "body" : "@Etienne Sorry Etienne, I realized I was missing the argument to the ZipOutputStream constructor. Hopefully that oversight was obvious, but I updated my answer to reflect it.",
      "score" : 0,
      "owner" : {
        "account_id" : 2496,
        "reputation" : 270515,
        "user_id" : 3474,
        "user_type" : "registered",
        "accept_rate" : 83,
        "profile_image" : "https://www.gravatar.com/avatar/ffbf4e85b8ffbae4e9039b9c0cf07bc8?s=256&d=identicon&r=PG",
        "display_name" : "erickson",
        "link" : "https://stackoverflow.com/users/3474/erickson"
      },
      "creation_date" : 1758555571,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140751713,
      "post_id" : 79769703,
      "body" : "Thanks you for your analysis erickson, i will try this solution in the code, hope that we no longer have this issue.",
      "score" : 0,
      "owner" : {
        "account_id" : 26474010,
        "reputation" : 25,
        "user_id" : 20114202,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/4a1804f0df3c7ae7c455e8a5b7b027f8?s=256&d=identicon&r=PG",
        "display_name" : "Etienne",
        "link" : "https://stackoverflow.com/users/20114202/etienne"
      },
      "creation_date" : 1758535463,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}