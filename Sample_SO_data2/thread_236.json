{
  "question" : {
    "question_id" : 79827783,
    "title" : "Does it safe to modify the oldValue of remappingFunction in java.util.Map#merge?",
    "body" : "<p>I want to implement something like this:</p>\n<pre><code>Map&lt;String, List&lt;String&gt;&gt; m = new HashMap&lt;&gt;();\nfor (... in ...) {\n    String key = ...;\n    String val = ...;\n    m.merge(key, Lists.newArrayList(val), (oldValue, newValue) -&gt; {\n       if (oldValue.size() == 1) {\n            oldValue.addAll(newValue);\n       } else {\n            // log error\n       }\n       return oldValue;\n    });\n}\n</code></pre>\n<p>so does it safe to modify the oldValue here ?  I don't want to get trouble when someday the jvm is updated.</p>\n",
    "tags" : [ "java", "hashmap" ],
    "owner" : {
      "account_id" : 4695771,
      "reputation" : 61,
      "user_id" : 3800680,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/21a2f58a44e0cc0f18cf5301da338bc7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "los",
      "link" : "https://stackoverflow.com/users/3800680/los"
    },
    "is_answered" : true,
    "view_count" : 85,
    "answer_count" : 3,
    "score" : 0,
    "last_activity_date" : 1763998177,
    "creation_date" : 1763889186,
    "link" : "https://stackoverflow.com/questions/79827783/does-it-safe-to-modify-the-oldvalue-of-remappingfunction-in-java-util-mapmerge",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79827829,
    "question_id" : 79827783,
    "body" : "<p>Yea It's safe but for that usecase better use something like computeIfAbsent</p>\n<pre class=\"lang-java prettyprint-override\"><code>Map&lt;String, List&lt;String&gt;&gt; m = new HashMap&lt;&gt;();\nfor (... in ...) {\n    String key = ...;\n    String val = ...;\n    \n    List&lt;String&gt; list = m.computeIfAbsent(key, k -&gt; new ArrayList&lt;&gt;());\n    if (list.size() == 1) {\n        list.add(val);\n    } else if (list.isEmpty()) {\n        list.add(val);\n    } else {\n        // log error\n    }\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 29786822,
      "reputation" : 1,
      "user_id" : 22828013,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/3sbntSlD.png?s=256",
      "display_name" : "Maxim",
      "link" : "https://stackoverflow.com/users/22828013/maxim"
    },
    "creation_date" : 1763896352,
    "last_activity_date" : 1763896352,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79828473,
    "question_id" : 79827783,
    "body" : "<p>It's safe.</p>\n<p><a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#merge-K-V-java.util.function.BiFunction-\" rel=\"nofollow noreferrer\">This statement in the Javadoc</a>:</p>\n<blockquote>\n<p>Otherwise, replaces the associated value with the results of the given remapping function</p>\n</blockquote>\n<p>means that it doesn't actually matter whether <code>oldValue</code> really is the &quot;old value&quot; if that's the value that you return: the return value is the value which will be inserted into the map afterwards.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 162699,
      "reputation" : 141055,
      "user_id" : 3788176,
      "user_type" : "registered",
      "accept_rate" : 54,
      "profile_image" : "https://www.gravatar.com/avatar/44c841338e1646af9a977f1fa0e23948?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Andy Turner",
      "link" : "https://stackoverflow.com/users/3788176/andy-turner"
    },
    "creation_date" : 1763977976,
    "last_activity_date" : 1763977976,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79828820,
    "question_id" : 79827783,
    "body" : "<p>It's safe. Map has no idea what the types are of the keys and values it contains. As far as its implementation is concerned, they are both Object, and Object does not expose any relevant state.</p>\n<p>When you write <code>oldValue.anything</code> you're 'following the pointer' (in javaspeak, 'dereferencing'). From the point of view of the hashmap, you're not changing anything. Or rather, the things you might change cannot possibly affect the map.</p>\n<p>Ordinarily you'd then think that <code>oldValue = x</code> <em>would</em> be a problem; that's not 'dereferencing', that's modifying the pointer directly. Except that's not true either: Java is pass-by-value, so that <code>oldValue</code> is a <em>copy</em> of the pointer the hashmap internally uses. You can change it all day, the map cannot witness any of these changes thus by definition that cannot break anything.</p>\n<p>Finally, <code>return oldValue;</code> - that <em>does</em> have an effect, and the spec indicates what that is. What you're doing fits within that spec, and specs are guaranteed future proof (or rather, OpenJDK's backwards compatibility promises aren't absolute, but if OpenJDK really thinks its a good idea to modify how maps work, that would break all existing code anyway, you can't prepare for such a thing).</p>\n<p>Thus, we end up at the answer: What you're doing is <strong>guaranteed</strong> safe. Not becauser the spec suggests it, no, because java itself implies no imaginable future change to any map impl could possibly be affected.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 401843,
      "reputation" : 107206,
      "user_id" : 768644,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b13bedc5215730fbce5edff6c130988a?s=256&d=identicon&r=PG",
      "display_name" : "rzwitserloot",
      "link" : "https://stackoverflow.com/users/768644/rzwitserloot"
    },
    "creation_date" : 1763998177,
    "last_activity_date" : 1763998177,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}