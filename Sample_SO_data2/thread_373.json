{
  "question" : {
    "question_id" : 79805804,
    "title" : "Out of Memory when deleting comment-classes with childstructure",
    "body" : "<p>I use Hibernate for a project. It's a ticket system.\nFor that I created comments with childcomments.\nBut every time I want to delete a comment, hibernate escalates and tries to load just EVERYTHING.</p>\n<p>This is my Comment-Entity:</p>\n<pre><code>@Entity\n@Setter\n@Getter\npublic class Comment extends AuditedEntity {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n    //--Hierarchy for CommentToTicket--\n    @ManyToOne\n    private Ticket ticket;\n    //--Hierarchy for Comments--\n    @OneToMany(mappedBy = &quot;parentComment&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    @OrderBy(&quot;createdDate ASC&quot;)\n    private List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();\n    @ManyToOne\n    private Comment parentComment;\n    private String commentText; //TODO: pictures? (blob maybe)\n    private int likes;\n    private int dislikes;\n}\n</code></pre>\n<p>This is my Delete-function in my Service:</p>\n<pre><code>    @Transactional\n    public void deleteComment(Long id) {\n        commentRepository.deleteById(id);\n    }\n</code></pre>\n<p>After sending the delete request it loads extremely long and says Out of Memory.</p>\n<p>Can anyone help me? Thank you</p>\n<p><strong>IMPORTANT</strong>\nFor my project, I'm not allowed to lazyload. I know that this would fix this problem. Is there another solution?\nAnd pls excuse me. I'm a beginner.</p>\n",
    "tags" : [ "java", "spring-boot", "hibernate", "jpa", "spring-data-jpa" ],
    "owner" : {
      "account_id" : 36980554,
      "reputation" : 29,
      "user_id" : 28015346,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/eA6j5XAv.jpg?s=256",
      "display_name" : "LostQuotient117",
      "link" : "https://stackoverflow.com/users/28015346/lostquotient117"
    },
    "is_answered" : false,
    "view_count" : 106,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1761941401,
    "creation_date" : 1761914870,
    "link" : "https://stackoverflow.com/questions/79805804/out-of-memory-when-deleting-comment-classes-with-childstructure",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79805864,
    "question_id" : 79805804,
    "body" : "<p>The issue is, as you pointed out that everything is being loaded. So in order to fix the issue you will need to detect what is the exact reason everything is being loaded. Your <code>comments</code> look like this:</p>\n<pre><code>    //--Hierarchy for Comments--\n    @OneToMany(mappedBy = &quot;parentComment&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    @OrderBy(&quot;createdDate ASC&quot;)\n    private List&lt;Comment&gt; comments = new ArrayList&lt;&gt;();\n</code></pre>\n<p>Let's see the elements of this:</p>\n<ul>\n<li><code>cascade</code>: it is triggering cascading, so if you remove your comment, all its subcomments are to be removed. However, there may be issues. For example if you have a cycle in your comment graph, that may very well be the reason, with cascade possibly trying to find the leaf with no leaf existing to be found</li>\n<li><code>orphanRemoval</code>: searches for orphans, that is, comments whose parent is the comment to be removed. If you have lots of comments as sub comments and sub-sub comments etc. etc., then all of those are to be removed, which could be slow. And if there are cycles in the comment graph, that could also cause the issue</li>\n<li><code>OrderBy</code>: the sub-comments of the comment are being ordered. If you remove a comment, its parent will have to reorder its subcomments. In our case you stated the <code>parentCommand</code> had this comment only, in which case this would not be problematic, but I advise you to double-check. Your</li>\n</ul>\n<pre><code>    @Transactional\n    public void deleteComment(Long id) {\n        commentRepository.deleteById(id);\n    }\n</code></pre>\n<p>suggests that anything that may be triggered will be executed inside a transaction. So, when <code>deleteById</code> is being executed, so you could try and debug in order to figure out what exactly is executed.</p>\n<p>A way to solve this is to gradually remove references, such as <code>cascade</code>, <code>orphanRemoval</code>, etc. etc. one-by-one until the test succeeds. The last thing you removed is the culprit. Hence you can put back everything else and ponder whether you still need the culprit, in which case you will need to adjust, or you don't need it in which case you leave it removed.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 194308,
      "reputation" : 80415,
      "user_id" : 436560,
      "user_type" : "registered",
      "accept_rate" : 87,
      "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
      "display_name" : "Lajos Arpad",
      "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
    },
    "creation_date" : 1761919264,
    "last_activity_date" : 1761919264,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79805865,
    "question_id" : 79805804,
    "body" : "<p>I got it working with a native query like this:<br />\nService:</p>\n<pre><code>@Transactional\npublic void deleteCommentWithChildren(Long parentId) {\nList&lt;Long&gt; childIds = commentRepository.findChildIdsByParentId(parentId);\nfor (Long childId : childIds) {\ndeleteCommentWithChildren(childId);\n}\ncommentRepository.deleteByIdQuery(parentId);\n}\n</code></pre>\n<p>Repository:</p>\n<pre><code>@Query(value = &quot;SELECT id FROM comment WHERE parent_comment_id = :parentId&quot;, nativeQuery = true)\nList&lt;Long&gt; findChildIdsByParentId(@Param(&quot;parentId&quot;) Long parentId);\n\n@Modifying\n@Transactional\n@Query(value = &quot;DELETE FROM comment WHERE id = :id&quot;, nativeQuery = true)\nvoid deleteByIdQuery(@Param(&quot;id&quot;) Long id);\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 36980554,
      "reputation" : 29,
      "user_id" : 28015346,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/eA6j5XAv.jpg?s=256",
      "display_name" : "LostQuotient117",
      "link" : "https://stackoverflow.com/users/28015346/lostquotient117"
    },
    "creation_date" : 1761919268,
    "last_activity_date" : 1761919268,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140836687,
    "post_id" : 79805804,
    "body" : "Are you maybe loading the ticket and the ticket have a bidirectional relationship to ALL comments and other classes? If you aren&#39;t using lazy loading.. I can imagine you&#39;ve got tickets, users, and all of them linked - making one fetch for a simple &#39;comment&#39; having to load everything in the DB.",
    "score" : 0,
    "owner" : {
      "account_id" : 231721,
      "reputation" : 21335,
      "user_id" : 496099,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/efa7510cf47d7bd79e80486246e7e39e?s=256&d=identicon&r=PG",
      "display_name" : "Chris",
      "link" : "https://stackoverflow.com/users/496099/chris"
    },
    "creation_date" : 1762291667,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829385,
    "post_id" : 79805804,
    "body" : "Check for loops (self-references over a distance), and check the foreign keys and custom functions in your Database table. Maybe there are some leftovers from previous trials, that influence this negatively. Or if the setup is easy enough, let Hiberante completely re-create the db. The other solution: Delete the children manually via a native query, then invalidate the according HIBERNATE caches (NOT &#39;hybernate&#39;; that&#39;s women&#39;s sleepwear).",
    "score" : 0,
    "owner" : {
      "account_id" : 2182934,
      "reputation" : 2660,
      "user_id" : 1932011,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://www.gravatar.com/avatar/612163480a1ccb4785fd647a003eefbb?s=256&d=identicon&r=PG",
      "display_name" : "JayC667",
      "link" : "https://stackoverflow.com/users/1932011/jayc667"
    },
    "creation_date" : 1761918490,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829320,
    "post_id" : 79805804,
    "body" : "Well then you know that you have not yet found the root cause, because that would not cause an outofmemory error. Are the parent and child comment the same object by any chance?",
    "score" : 1,
    "owner" : {
      "account_id" : 187094,
      "reputation" : 5301,
      "user_id" : 424903,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
      "display_name" : "Gimby",
      "link" : "https://stackoverflow.com/users/424903/gimby"
    },
    "creation_date" : 1761916777,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829314,
    "post_id" : 79805804,
    "body" : "@LucaBassoRicci and in the testdata are literally only one parentcomment with one childcomment so its not big data",
    "score" : 0,
    "owner" : {
      "account_id" : 36980554,
      "reputation" : 29,
      "user_id" : 28015346,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/eA6j5XAv.jpg?s=256",
      "display_name" : "LostQuotient117",
      "link" : "https://stackoverflow.com/users/28015346/lostquotient117"
    },
    "creation_date" : 1761916669,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829310,
    "post_id" : 79805804,
    "body" : "@LucaBassoRicci unfortunately, i get the same problem. Removed Cascade and OrphanRemoval and instead used a &quot;manual&quot; function like this: //at first a function that calls this one and then removing main-comment     private void deleteChildren(Long parentId) {         List&lt;Long&gt; childIds = commentRepository.findAllByParentCommentId(parentId)                 .stream()                 .map(Comment::getId)                 .toList();         for (Long childId : childIds) {             deleteChildren(childId);         }         commentRepository.deleteByParentCommentId(parentId);     }",
    "score" : 0,
    "owner" : {
      "account_id" : 36980554,
      "reputation" : 29,
      "user_id" : 28015346,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/eA6j5XAv.jpg?s=256",
      "display_name" : "LostQuotient117",
      "link" : "https://stackoverflow.com/users/28015346/lostquotient117"
    },
    "creation_date" : 1761916563,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829271,
    "post_id" : 79805804,
    "body" : "if you may have a large number of cihld comments just remove cascade for deletion and use a &quot;manual&quot; delete (eg Comment#deleteByParentComment(...))",
    "score" : 0,
    "owner" : {
      "account_id" : 3052937,
      "reputation" : 18534,
      "user_id" : 2587166,
      "user_type" : "registered",
      "accept_rate" : 83,
      "profile_image" : "https://i.sstatic.net/pgHgd.jpg?s=256",
      "display_name" : "Luca Basso Ricci",
      "link" : "https://stackoverflow.com/users/2587166/luca-basso-ricci"
    },
    "creation_date" : 1761915677,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79805865" : [ {
      "comment_id" : 140836681,
      "post_id" : 79805865,
      "body" : "This only handles delete. If your application can&#39;t handle loading this single comment to delete it, how does it fair when you are fetching it or otherwise modifying it?",
      "score" : 0,
      "owner" : {
        "account_id" : 231721,
        "reputation" : 21335,
        "user_id" : 496099,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/efa7510cf47d7bd79e80486246e7e39e?s=256&d=identicon&r=PG",
        "display_name" : "Chris",
        "link" : "https://stackoverflow.com/users/496099/chris"
      },
      "creation_date" : 1762291496,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140835368,
      "post_id" : 79805865,
      "body" : "You made the problem temporarily go away; whatever code or data problem you had to cause the problem to begin with is still there, waiting.",
      "score" : 0,
      "owner" : {
        "account_id" : 187094,
        "reputation" : 5301,
        "user_id" : 424903,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
        "display_name" : "Gimby",
        "link" : "https://stackoverflow.com/users/424903/gimby"
      },
      "creation_date" : 1762250295,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79805864" : [ {
      "comment_id" : 140829433,
      "post_id" : 79805864,
      "body" : "@LostQuotient117 No worries. You found a work-around which is of course great",
      "score" : 0,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80415,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1761920009,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140829411,
      "post_id" : 79805864,
      "body" : "Oh sorry. I didnt read your Answer but thanks for the input. I just now fixed it with a Native Query that deletes the comments without loading them:      (at)Query(value = &quot;SELECT id FROM comment WHERE parent_comment_id = :parentId&quot;, nativeQuery = true)      List&lt;Long&gt; findChildIdsByParentId((at)Param(&quot;parentId&quot;) Long parentId);        (at)Modifying      (at)Transactional      (at)Query(value = &quot;DELETE FROM comment WHERE id = :id&quot;, nativeQuery = true)      void deleteByIdQuery((at)Param(&quot;id&quot;) Long id);",
      "score" : 0,
      "owner" : {
        "account_id" : 36980554,
        "reputation" : 29,
        "user_id" : 28015346,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/eA6j5XAv.jpg?s=256",
        "display_name" : "LostQuotient117",
        "link" : "https://stackoverflow.com/users/28015346/lostquotient117"
      },
      "creation_date" : 1761919401,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}