{
  "question" : {
    "question_id" : 79596594,
    "title" : "HMAC keys in system.keys collection and HMAC key monitoring thread",
    "body" : "<p>In Mongodb  PSSSA (1 primary, 3 secondary, 1 arbiter) deployments when 2 secondary DB’s go down and only PSA is present. when the primary mongo db is restart few times , all database queries start to fail and following error in observed in mongo db logs ,</p>\n<p><strong>Logs :</strong></p>\n<p><strong>&quot;ctx&quot;:&quot;monitoring-keys-for-HMAC&quot;,&quot;msg&quot;:&quot;setting timestamp read source&quot;,&quot;attr&quot;:{&quot;readSource&quot;:&quot;kMajorityCommitted&quot;,&quot;provided&quot;:&quot;none&quot;\n&quot;ctx&quot;:&quot;monitoring-keys-for-HMAC&quot;,&quot;msg&quot;:&quot;setting timestamp read source&quot;,&quot;attr&quot;:{&quot;readSource&quot;:&quot;kNoTimestamp&quot;,&quot;provided&quot;:&quot;none&quot;\n&quot;ctx&quot;:&quot;monitoring-keys-for-HMAC&quot;,&quot;msg&quot;:&quot;Failed to refresh key cache&quot;,&quot;attr&quot;:{&quot;error&quot;:&quot;ReadConcernMajorityNotAvailableYet: Read concern majority reads are currently not possible.</strong></p>\n<p>All other application queries also fail with “Failed to refresh key cache” error. The cluster wide read concern is set as local. Though the above logs indicate it expects a majority read concern. The mongo db remains in the same state until one secondary comes up , when PSSA is present and when there is majority read possible the server self heals and this issue doesn’t occur.</p>\n<p>There are no logs to indicate the exact query that is being operated on system.keys collection to figure out what is the readconcern on the query being executed. Is this expected behaviour or if we are missing something ?</p>\n<p>Mongodb version used : 8.0.6 community edition in kubernetes environment</p>\n<p>Code suspect : <a href=\"https://github.com/mongodb/mongo/blob/master/src/mongo/db/keys_collection_manager.cpp#L184\" rel=\"nofollow noreferrer\">Mongo code for key refresh</a></p>\n",
    "tags" : [ "java", "mongodb", "high-availability", "replicaset" ],
    "owner" : {
      "account_id" : 38089419,
      "reputation" : 1,
      "user_id" : 28589915,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "sakthivel C",
      "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
    },
    "is_answered" : false,
    "view_count" : 144,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1745864172,
    "creation_date" : 1745847816,
    "link" : "https://stackoverflow.com/questions/79596594/hmac-keys-in-system-keys-collection-and-hmac-key-monitoring-thread",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79597075,
    "question_id" : 79596594,
    "body" : "<p>This is not really a coding problem, this is a database management problem, but there is a simple answer: Arbiters suck.</p>\n<p>When you have a 5-node PSSSA replica set with 2 members down, i.e. (PSDDA) , majority write is not possible.</p>\n<p>Majority in a 5-node replica set is 3, since data can only be written to 2 node, majority writes will never complete.  Hence the underlying error <code>ReadConcernMajorityNotAvailableYet: Read concern majority reads are currently not possible.</code></p>\n<p>Solution: get rid of the arbiter.  If you replace it with a data bearing node, majority write will be possible when 2 nodes are down.  If you just remove it, there will not be a primary when 2 nodes are down, making it more obvious that majority write is not available.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2638471,
      "reputation" : 29001,
      "user_id" : 2282634,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/46c5a01e93856e53a2f16eec3267a9b2?s=256&d=identicon&r=PG",
      "display_name" : "Joe",
      "link" : "https://stackoverflow.com/users/2282634/joe"
    },
    "creation_date" : 1745864172,
    "last_activity_date" : 1745864172,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140376986,
    "post_id" : 79596594,
    "body" : "Please provide enough code so others can better understand or reproduce the problem.",
    "score" : 0,
    "owner" : {
      "account_id" : -1,
      "reputation" : 1,
      "user_id" : -1,
      "user_type" : "moderator",
      "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
      "display_name" : "Community",
      "link" : "https://stackoverflow.com/users/-1/community"
    },
    "creation_date" : 1745853365,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79597075" : [ {
      "comment_id" : 140388118,
      "post_id" : 79597075,
      "body" : "PSS and PSSSS are ideal choices for 3 data center setups, in 2 Data center setups to ensure high availability what would be ideal setup instead of PSA (which ensure high availabilities in 2DC scenarios)",
      "score" : 0,
      "owner" : {
        "account_id" : 38089419,
        "reputation" : 1,
        "user_id" : 28589915,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "sakthivel C",
        "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
      },
      "creation_date" : 1746128508,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140387455,
      "post_id" : 79597075,
      "body" : "PSDDA will not just prevent HMAC refresh, the majority commit cannot advance, so cache pressure on the primary will grow until it crashes, so yet, getting rid of the arbiter would definitely be the best choice for stability and consistency",
      "score" : 0,
      "owner" : {
        "account_id" : 2638471,
        "reputation" : 29001,
        "user_id" : 2282634,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/46c5a01e93856e53a2f16eec3267a9b2?s=256&d=identicon&r=PG",
        "display_name" : "Joe",
        "link" : "https://stackoverflow.com/users/2282634/joe"
      },
      "creation_date" : 1746114737,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140387227,
      "post_id" : 79597075,
      "body" : "So this is a limitation in Mongo db deployments ? In PSDDA , the HMAC key refresh operations will fail as it cannot achieve  majority read concern ? So Moving from PSSSA to PSSSS deployments would be the wise choice ?",
      "score" : 0,
      "owner" : {
        "account_id" : 38089419,
        "reputation" : 1,
        "user_id" : 28589915,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "sakthivel C",
        "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
      },
      "creation_date" : 1746110367,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140384972,
      "post_id" : 79597075,
      "body" : "That is the <i>default</i> read concern for operations that are not submitted with an explicit read concern.  There are many internal operations in the mongod that require higher consistency guarantees to function properly, so they are internally submitted with an explicit  non-default read concern such as &quot;majority&quot;",
      "score" : 0,
      "owner" : {
        "account_id" : 2638471,
        "reputation" : 29001,
        "user_id" : 2282634,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/46c5a01e93856e53a2f16eec3267a9b2?s=256&d=identicon&r=PG",
        "display_name" : "Joe",
        "link" : "https://stackoverflow.com/users/2282634/joe"
      },
      "creation_date" : 1746031983,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140382693,
      "post_id" : 79597075,
      "body" : "One more thing , [link] (<a href=\"https://www.mongodb.com/docs/manual/release-notes/5.0-compatibility/#local-is-the-default-read-concern\" rel=\"nofollow noreferrer\">mongodb.com/docs/manual/release-notes/5.0-compatibility/&hellip;</a>) also states default read concern is local. how could default read concern be true and enableMajorityReadConcern be true at same time ?. does this enableMajorityReadConcern only applies to mongo&#39;s internal operations ?",
      "score" : 0,
      "owner" : {
        "account_id" : 38089419,
        "reputation" : 1,
        "user_id" : 28589915,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "sakthivel C",
        "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
      },
      "creation_date" : 1745992227,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140382673,
      "post_id" : 79597075,
      "body" : "When i run this command &quot;db.adminCommand({getDefaultRWConcern:1})&quot; , i get following output in my server, &quot;defaultReadConcern: { level: &#39;local&#39; }, defaultWriteConcern: { w: 1, wtimeout: 0 }, defaultWriteConcernSource: &#39;global&#39;, defaultReadConcernSource: &#39;global&#39;,&quot; . Doesn&#39;t this mean my cluster has readconcern local. then how is enableMajorityReadConcern could be true in this case ? Mongo documentation though states this enableMajorityReadConcern is true by default from 5.0v.",
      "score" : 0,
      "owner" : {
        "account_id" : 38089419,
        "reputation" : 1,
        "user_id" : 28589915,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "sakthivel C",
        "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
      },
      "creation_date" : 1745991702,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140381286,
      "post_id" : 79597075,
      "body" : "<a href=\"https://www.mongodb.com/docs/manual/release-notes/5.0-compatibility/#enablemajorityreadconcern-is-not-configurable\" rel=\"nofollow noreferrer\">enableMajorityReadConcern</a> defaults to true, and cannot be disabled in MongoDB 5.0 or later.  This was required for changes to the storage engine to fix some really nasty bugs in the 4.x series",
      "score" : 0,
      "owner" : {
        "account_id" : 2638471,
        "reputation" : 29001,
        "user_id" : 2282634,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/46c5a01e93856e53a2f16eec3267a9b2?s=256&d=identicon&r=PG",
        "display_name" : "Joe",
        "link" : "https://stackoverflow.com/users/2282634/joe"
      },
      "creation_date" : 1745949650,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140378706,
      "post_id" : 79597075,
      "body" : "Thanks for the reply. My doubt here is the default cluster level read concern I have set is local and not majority. In this case why &quot;monitoring-keys-for-HMAC&quot; thread tries to do a majority read for refreshing the HMAC keys. Shouldn&#39;t it try with read concern local by default or a fallback mechanism when majority read is not possible try with default clutser level read concern .Is this the expected behaviour of mongo or we are missing something here ?.",
      "score" : 0,
      "owner" : {
        "account_id" : 38089419,
        "reputation" : 1,
        "user_id" : 28589915,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/dcd6070bce975e1d3176d46c6eddbac3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "sakthivel C",
        "link" : "https://stackoverflow.com/users/28589915/sakthivel-c"
      },
      "creation_date" : 1745901400,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}