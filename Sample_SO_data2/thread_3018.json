{
  "question" : {
    "question_id" : 79580218,
    "title" : "Can mapstruct do a partial update on records?",
    "body" : "<p>I was led to believe by IntelliJ's code AI that mapstruct could do a partial update on a Java record.</p>\n<p><strong>Update</strong>:  The AI said mapstruct would automatically (automagically?) use a builder or canonical constructor to create a new instance merging the two records and return that new instance.</p>\n<p>Am I doing something wrong or was I mislead by the AI?</p>\n<p>Thanks for thinking about my question!</p>\n<p>My records and mapper code</p>\n<pre class=\"lang-java prettyprint-override\"><code>public record Example(Long id, String name){}\n\npublic record ExampleWithBuilder(Long id, String name) {\n    public static ExampleWithBuilderBuilder builder() {\n        return new ExampleWithBuilderBuilder();\n    }\n\n    public static class ExampleWithBuilderBuilder {\n        private Long id;\n        private String name;\n\n        ExampleWithBuilderBuilder() {\n        }\n\n        public ExampleWithBuilderBuilder id(Long id) {\n            this.id = id;\n            return this;\n        }\n\n        public ExampleWithBuilderBuilder name(String name) {\n            this.name = name;\n            return this;\n        }\n\n        public ExampleWithBuilder build() {\n            return new ExampleWithBuilder(this.id, this.name);\n        }\n\n        public String toString() {\n            return &quot;ExampleWithBuilder.ExampleWithBuilderBuilder(id=&quot; + this.id + &quot;, name=&quot; + this.name + &quot;)&quot;;\n        }\n    }\n}\n\n@Mapper(unmappedTargetPolicy = ReportingPolicy.IGNORE, componentModel = MappingConstants.ComponentModel.SPRING)\npublic interface RacerMapper {\n    @BeanMapping(nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE)\n    void partialUpdate(ExampleWithBuilder exampleWithBuilder, @MappingTarget Example example);\n\n    @BeanMapping(nullValuePropertyMappingStrategy = NullValuePropertyMappingStrategy.IGNORE)\n    ExampleWithBuilder partialUpdate(Example example, @MappingTarget ExampleWithBuilder exampleWithBuilder);\n}\n</code></pre>\n<p>Generated code is showing just returning the MappingTarget</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic Example partialUpdate(ExampleWithBuilder exampleWithBuilder, Example example) {\n    if ( exampleWithBuilder == null ) {\n        return example;\n    }\n\n    return example;\n}\n\n@Override\npublic ExampleWithBuilder partialUpdate(Example example, ExampleWithBuilder exampleWithBuilder) {\n    if ( example == null ) {\n        return exampleWithBuilder;\n    }\n\n    return exampleWithBuilder;\n}\n\n</code></pre>\n<p>pom.xml dependency</p>\n<pre><code>    &lt;!-- https://mvnrepository.com/artifact/org.mapstruct/mapstruct --&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;\n        &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;\n        &lt;version&gt;1.6.3&lt;/version&gt;\n    &lt;/dependency&gt;\n\n</code></pre>\n",
    "tags" : [ "java", "mapstruct" ],
    "owner" : {
      "account_id" : 1740073,
      "reputation" : 1665,
      "user_id" : 1591729,
      "user_type" : "registered",
      "accept_rate" : 93,
      "profile_image" : "https://www.gravatar.com/avatar/aefa758ae16f9a593316b9565edbf560?s=256&d=identicon&r=PG",
      "display_name" : "Timothy Vogel",
      "link" : "https://stackoverflow.com/users/1591729/timothy-vogel"
    },
    "is_answered" : true,
    "view_count" : 219,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1744984177,
    "creation_date" : 1744931614,
    "link" : "https://stackoverflow.com/questions/79580218/can-mapstruct-do-a-partial-update-on-records",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79581152,
    "question_id" : 79580218,
    "body" : "<p>As I said, records are immutable and do not provide a setter for its attributes. Hence, <code>@MappingTarget</code> cannot be used. If you want to stick to records, you need to implement the logic by yourself for the &quot;patch&quot; part or use use mapstruct's <code>defaultExpression</code> for fallback values. The latter only applies if source value is <code>null</code>. In any case the resulting object will be a new and not a patched one.</p>\n<p>following an Example:</p>\n<pre><code>public record SourceRecord(Long uid, String uname) {}\npublic record TargetRecord(Long id, String name) {}\n\n@Mapper\npublic interface RecordMapper {\n\n  RecordMapper INSTANCE = Mappers.getMapper(RecordMapper.class);\n\n  @Mapping(target = &quot;id&quot;, source = &quot;source.uid&quot;, defaultExpression = &quot;java(patchObject.id())&quot;)\n  @Mapping(target = &quot;name&quot;, source = &quot;source.uname&quot;, defaultExpression = &quot;java(patchObject.name())&quot;)\n  TargetRecord map(SourceRecord source, TargetRecord patchObject); \n\n  default TargetRecord updateManual(TargetRecord existing, SourceRecord input) {\n    return new TargetRecord(\n        input.uid() != null ? input.uid() : existing.id(),\n        input.uname() != null ? input.uname() : existing.name()\n    );\n  }\n}\n\n public void map() {\n    final TargetRecord existing = new TargetRecord(1L, &quot;John&quot;);\n    final SourceRecord source = new SourceRecord(null, &quot;Joanna&quot;);\n    final TargetRecord mapped = RecordMapper.INSTANCE.map(source); // Results in TargetRecord[id=1, name=Joanna]\n    final TargetRecord update = RecordMapper.INSTANCE.updateManual(existing, source); // Results in TargetRecord[id=1, name=Joanna]\n  }\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 11555562,
      "reputation" : 569,
      "user_id" : 8466853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd7f72b426ce3c46739900b8ba014e26?s=256&d=identicon&r=PG",
      "display_name" : "Arno",
      "link" : "https://stackoverflow.com/users/8466853/arno"
    },
    "creation_date" : 1744983631,
    "last_activity_date" : 1744984177,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140351328,
    "post_id" : 79580218,
    "body" : "FYI, <a href=\"https://openjdk.org/jeps/468\" rel=\"nofollow noreferrer\">work is underway</a> to add “withers” to a future version of Java. This feature would enable  more easily building a new record instance based on the values of an existing record object.",
    "score" : 1,
    "owner" : {
      "account_id" : 322981,
      "reputation" : 347089,
      "user_id" : 642706,
      "user_type" : "registered",
      "accept_rate" : 58,
      "profile_image" : "https://i.sstatic.net/ZWEI3.jpg?s=256",
      "display_name" : "Basil Bourque",
      "link" : "https://stackoverflow.com/users/642706/basil-bourque"
    },
    "creation_date" : 1745101230,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140347860,
    "post_id" : 79580218,
    "body" : "@chubbsondubs The actual code is MUCH more complicated than shown in the question.  I simplified the code to focus on the specific behavior I had a question about on mapstruct.",
    "score" : 1,
    "owner" : {
      "account_id" : 1740073,
      "reputation" : 1665,
      "user_id" : 1591729,
      "user_type" : "registered",
      "accept_rate" : 93,
      "profile_image" : "https://www.gravatar.com/avatar/aefa758ae16f9a593316b9565edbf560?s=256&d=identicon&r=PG",
      "display_name" : "Timothy Vogel",
      "link" : "https://stackoverflow.com/users/1591729/timothy-vogel"
    },
    "creation_date" : 1744979963,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140347856,
    "post_id" : 79580218,
    "body" : "@Arno Thanks.  I switched to a class and of course mapstruct worked fine.  I want to know if mapstruct will work with records as the AI indicated.",
    "score" : 0,
    "owner" : {
      "account_id" : 1740073,
      "reputation" : 1665,
      "user_id" : 1591729,
      "user_type" : "registered",
      "accept_rate" : 93,
      "profile_image" : "https://www.gravatar.com/avatar/aefa758ae16f9a593316b9565edbf560?s=256&d=identicon&r=PG",
      "display_name" : "Timothy Vogel",
      "link" : "https://stackoverflow.com/users/1591729/timothy-vogel"
    },
    "creation_date" : 1744979878,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140347785,
    "post_id" : 79580218,
    "body" : "Why even have the builder for such a simple class.  The builder doesn&#39;t seem to add much that the constructor already provides.  <code>new Example( 1, &quot;Racer 1&quot;)</code> is far easier than <code>ExampleWithBuilder.builder().id(1).name(&quot;Racer 1&quot;).builder()</code> and gives you an <code>ExampleWithBuilder</code>?!?!  What is the point?  That being said Mapstruct works with classes as with records so you can definitely do partial updates in the DB.  You can&#39;t change a record, but you can a class.  This looks like AI spaghetti to me but maybe what you intended?",
    "score" : 0,
    "owner" : {
      "account_id" : 51881,
      "reputation" : 39410,
      "user_id" : 155020,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://i.sstatic.net/fEqVo.png?s=256",
      "display_name" : "chubbsondubs",
      "link" : "https://stackoverflow.com/users/155020/chubbsondubs"
    },
    "creation_date" : 1744978038,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140347337,
    "post_id" : 79580218,
    "body" : "Java records are immutable, hence, no partial update is possible. However you can create new record containing values from original records applying partial update values.",
    "score" : 2,
    "owner" : {
      "account_id" : 11555562,
      "reputation" : 569,
      "user_id" : 8466853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd7f72b426ce3c46739900b8ba014e26?s=256&d=identicon&r=PG",
      "display_name" : "Arno",
      "link" : "https://stackoverflow.com/users/8466853/arno"
    },
    "creation_date" : 1744965708,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}