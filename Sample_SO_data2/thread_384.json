{
  "question" : {
    "question_id" : 79804852,
    "title" : "Received request message is changed from TCP server after upgrading Spring boot to 3.4.2",
    "body" : "<p>After upgrading Spring Boot from 2.7 to 3.4, receiving message from TCP server to our service is getting changed with different code. For example, previously the received message is 1784 after deserialization of that message, and now it has changed to 1684, which is a response message that we need to send back to the server.</p>\n<p>Below is the error we are currently facing:</p>\n<pre class=\"lang-none prettyprint-override\"><code>    ERROR [Regi-service,,,,,,,] 8 --- [pool-2-thread-3] [                                                 ] a.s.o.d.m.r.DeserializedIsoMessage       : Extracted raw message type value: 6292 (int), hex: 1894\n2025-10-31T09:02:41.411+01:00 ERROR [otis-service,,,,,,,] 8 --- [pool-2-thread-3] [                                                 ] at.regi.otis.api.oli.OliController        : Deserialization failed\n\njava.util.NoSuchElementException: No value present\n    at java.base/java.util.Optional.orElseThrow(Optional.java:377) ~[na:na]\n    at at.regi.otis.domain.message.request.RequestMessageType.byType(RequestMessageType.java:549) ~[!/:3.0.0]\n    at at.regi.otis.domain.message.request.DeserializedIsoMessage.type(DeserializedIsoMessage.java:36) ~[!/:3.0.0]\n    at at.regi.otis.domain.message.request.DeserializedRequestMessageWithType.type(DeserializedRequestMessageWithType.java:15) ~[!/:3.0.0]\n    at at.regi.otis.domain.message.request.RequestMessage.type(RequestMessage.java:41) ~[!/:3.0.0]\n    at at.regi.otis.api.oli.OliController.handle(OliController.java:60) ~[!/:3.0.0]\n    at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103) ~[na:na]\n    at java.base/java.lang.reflect.Method.invoke(Method.java:580) ~[na:na]\n    at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:169) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.integration.handler.support.IntegrationInvocableHandlerMethod.doInvoke(IntegrationInvocableHandlerMethod.java:45) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:119) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.integration.handler.support.MessagingMethodInvokerHelper$HandlerMethod.invoke(MessagingMethodInvokerHelper.java:1086) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.support.MessagingMethodInvokerHelper.invokeHandlerMethod(MessagingMethodInvokerHelper.java:569) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.support.MessagingMethodInvokerHelper.processInternal(MessagingMethodInvokerHelper.java:482) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.support.MessagingMethodInvokerHelper.process(MessagingMethodInvokerHelper.java:360) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.MethodInvokingMessageProcessor.processMessage(MethodInvokingMessageProcessor.java:114) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.ServiceActivatingHandler.handleRequestMessage(ServiceActivatingHandler.java:95) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.AbstractReplyProducingMessageHandler.handleMessageInternal(AbstractReplyProducingMessageHandler.java:145) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.AbstractMessageHandler.doHandleMessage(AbstractMessageHandler.java:105) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.AbstractMessageHandler.handleWithMetrics(AbstractMessageHandler.java:90) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.handler.AbstractMessageHandler.handleMessage(AbstractMessageHandler.java:70) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.dispatcher.UnicastingDispatcher.doDispatch(UnicastingDispatcher.java:145) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.dispatcher.UnicastingDispatcher.dispatch(UnicastingDispatcher.java:106) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.channel.AbstractSubscribableChannel.doSend(AbstractSubscribableChannel.java:72) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.channel.AbstractMessageChannel.sendInternal(AbstractMessageChannel.java:378) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.channel.AbstractMessageChannel.sendWithMetrics(AbstractMessageChannel.java:349) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.channel.AbstractMessageChannel.send(AbstractMessageChannel.java:329) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.messaging.core.GenericMessagingTemplate.doSend(GenericMessagingTemplate.java:187) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.messaging.core.GenericMessagingTemplate.doSendAndReceive(GenericMessagingTemplate.java:234) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.messaging.core.GenericMessagingTemplate.doSendAndReceive(GenericMessagingTemplate.java:47) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.messaging.core.AbstractMessagingTemplate.sendAndReceive(AbstractMessagingTemplate.java:46) ~[spring-messaging-6.2.2.jar!/:6.2.2]\n    at org.springframework.integration.core.MessagingTemplate.sendAndReceive(MessagingTemplate.java:107) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.gateway.MessagingGatewaySupport.doSendAndReceive(MessagingGatewaySupport.java:687) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.gateway.MessagingGatewaySupport.sendAndReceiveWithMetrics(MessagingGatewaySupport.java:675) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.gateway.MessagingGatewaySupport.sendAndReceive(MessagingGatewaySupport.java:612) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.gateway.MessagingGatewaySupport.sendAndReceiveMessage(MessagingGatewaySupport.java:588) ~[spring-integration-core-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.ip.tcp.TcpInboundGateway.doOnMessage(TcpInboundGateway.java:125) ~[spring-integration-ip-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.ip.tcp.TcpInboundGateway.onMessage(TcpInboundGateway.java:103) ~[spring-integration-ip-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.ip.tcp.connection.TcpNetConnection.receiveAndProcessMessage(TcpNetConnection.java:233) ~[spring-integration-ip-6.2.4.jar!/:6.2.4]\n    at org.springframework.integration.ip.tcp.connection.TcpNetConnection.run(TcpNetConnection.java:206) ~[spring-integration-ip-6.2.4.jar!/:6.2.4]\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144) ~[na:na]\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642) ~[na:na]\n    at java.base/java.lang.Thread.run(Thread.java:1583) ~[na:na]\n\n2025-10-31T09:02:41.412+01:00 INFO  [Regi-service,,,,,,,] 8 --- [pool-2-thread-3] [                                                 ] at.regi.otis.api.oli.OliController        : Started errorResponse method\n</code></pre>\n<p>Some received request messages are working correctly, but in between some are failing with the above error.</p>\n<p>This is the deserialize code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic RequestMessageType type() {\n    int rawType = deserializedMessage().getType();\n    String formattedType = String.format(&quot;%02x&quot;, rawType);\n    log.error(&quot;Extracted raw message type value: {} (int), hex: {}&quot;, rawType, formattedType);\n    return RequestMessageType.byType(formattedType);\n}\n</code></pre>\n<p>we are using spring-intergation-ip-6.4.2.jar it has ByteArrayRawSerializer class like this</p>\n<pre><code>public abstract class AbstractByteArraySerializer implements Serializer&lt;byte[]&gt;, Deserializer&lt;byte[]&gt;, ApplicationEventPublisherAware {\n    public static final int DEFAULT_MAX_MESSAGE_SIZE = 2048;\n    protected final LogAccessor logger = new LogAccessor(this.getClass());\n    private int maxMessageSize = 2048;\n    private ApplicationEventPublisher applicationEventPublisher;\n\n    public AbstractByteArraySerializer() {\n    }\n\n    public int getMaxMessageSize() {\n        return this.maxMessageSize;\n    }\n\n    public void setMaxMessageSize(int maxMessageSize) {\n        this.maxMessageSize = maxMessageSize;\n    }\n\n    public void setApplicationEventPublisher(ApplicationEventPublisher applicationEventPublisher) {\n        this.applicationEventPublisher = applicationEventPublisher;\n    }\n\n    protected void checkClosure(int bite) throws IOException {\n        if (bite &lt; 0) {\n            this.logger.debug(&quot;Socket closed during message assembly&quot;);\n            throw new IOException(&quot;Socket closed during message assembly&quot;);\n        }\n    }\n\n    protected void publishEvent(Exception cause, byte[] buffer, int offset) {\n        TcpDeserializationExceptionEvent event = new TcpDeserializationExceptionEvent(this, cause, buffer, offset);\n        if (this.applicationEventPublisher != null) {\n            this.applicationEventPublisher.publishEvent(event);\n        } else {\n            this.logger.trace(() -&gt; {\n                return &quot;No event publisher for &quot; + event;\n            });\n        }\n\n    }\n}\n</code></pre>\n<p>RequestMessageType</p>\n<pre class=\"lang-java prettyprint-override\"><code>    public static RequestMessageType byType(String type) {\n            Optional&lt;RequestMessageType&gt; match = Arrays.stream(RequestMessageType.values())\n                    .filter(message -&gt; message.type.equals(type))\n                    .findFirst();\n    \n            if (match.isEmpty()) {\n                log.error(&quot;RequestMessageType lookup FAILED for type string: '{}'. No matching enum found.&quot;, type);\n            }\n    \n            return match.orElseThrow();\n        }\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-boot", "tcp", "spring-integration" ],
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "is_answered" : true,
    "view_count" : 126,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1762627408,
    "creation_date" : 1761833466,
    "link" : "https://stackoverflow.com/questions/79804852/received-request-message-is-changed-from-tcp-server-after-upgrading-spring-boot",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79804884,
    "question_id" : 79804852,
    "body" : "<p>I found the root cause of this issue. The problem was not in the business logic but how Spring Integration (Spring Framework 6) handles byte based message serialization internally.</p>\n<p>The problem was fixed for all message types when we specifically set the byte order in our custom deserializer.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic ByteArrayRawSerializer customDeserializer() {\n    ByteArrayRawSerializer serializer = new ByteArrayRawSerializer();\n    serializer.setByteOrder(ByteOrder.LITTLE_ENDIAN);// this one depends on server\n    return serializer;\n}\n\n</code></pre>\n<p>Then we can use the above code in TCP connection Factory.</p>\n<pre><code>@Bean\npublic TcpNetServerConnectionFactory serverConnectionFactory() {\n    TcpNetServerConnectionFactory factory = new TcpNetServerConnectionFactory(12345);\n    factory.setDeserializer(customDeserializer());\n    factory.setSerializer(customDeserializer());\n    return factory;\n}\n</code></pre>\n<p>I think after Spring Boot 3.4, the byte order used in TCP serialization was changed and it will show message type parsing.<br />\nI think this will work.</p>\n",
    "score" : 4,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 44318283,
      "reputation" : 107,
      "user_id" : 31691216,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/331d80b7ddd44ea266a2a0876e0b0074?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Siripireddy Giri",
      "link" : "https://stackoverflow.com/users/31691216/siripireddy-giri"
    },
    "creation_date" : 1761835054,
    "last_activity_date" : 1761835263,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140840127,
    "post_id" : 79804852,
    "body" : "Oh I see, you&#39;re expecting a value other than 6292 / 1894? My apologies if so, I thought you were having trouble finding the source of the exception.",
    "score" : 0,
    "owner" : {
      "account_id" : 13097820,
      "reputation" : 312,
      "user_id" : 9463210,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/zqvA4.jpg?s=256",
      "display_name" : "DrRelling",
      "link" : "https://stackoverflow.com/users/9463210/drrelling"
    },
    "creation_date" : 1762440672,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140839146,
    "post_id" : 79804852,
    "body" : "yes added please check",
    "score" : 0,
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "creation_date" : 1762400040,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140838029,
    "post_id" : 79804852,
    "body" : "Have you looked at the static method <code>byType</code> on <code>RequestMessageType</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 13097820,
      "reputation" : 312,
      "user_id" : 9463210,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/zqvA4.jpg?s=256",
      "display_name" : "DrRelling",
      "link" : "https://stackoverflow.com/users/9463210/drrelling"
    },
    "creation_date" : 1762354145,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837842,
    "post_id" : 79804852,
    "body" : "I got the logger &quot;Extracted raw message type value: 6292 (int), hex: 1894&quot;",
    "score" : 0,
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "creation_date" : 1762348532,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837806,
    "post_id" : 79804852,
    "body" : "So the problem is that <code>formattedType</code> is null?",
    "score" : 0,
    "owner" : {
      "account_id" : 13097820,
      "reputation" : 312,
      "user_id" : 9463210,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/zqvA4.jpg?s=256",
      "display_name" : "DrRelling",
      "link" : "https://stackoverflow.com/users/9463210/drrelling"
    },
    "creation_date" : 1762347605,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140829417,
    "post_id" : 79804852,
    "body" : "And for you information yours is always BIG_ENDIAN so i don&#39;t think byte order will cause a issue",
    "score" : 0,
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "creation_date" : 1761919595,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140828713,
    "post_id" : 79804852,
    "body" : "I have given the full stack trace  above even after trying with below solution. @DrRelling",
    "score" : 0,
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "creation_date" : 1761899299,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140828709,
    "post_id" : 79804852,
    "body" : "Hello. @SiripiReddy Giri, I have tried you below solution by using that code in my socket configuration and for you info  serializer.setByteOrder this method was not avaliable in spring integration till 6.5.2 i have checked this so, instead i created that method in ISO file and used  but still the issue persists with same error  in below comments",
    "score" : 0,
    "owner" : {
      "account_id" : 29980082,
      "reputation" : 22,
      "user_id" : 22975283,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d8fe2371fbb53959e3419e1cb0b2495?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "mannam jayanth",
      "link" : "https://stackoverflow.com/users/22975283/mannam-jayanth"
    },
    "creation_date" : 1761899139,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140827298,
    "post_id" : 79804852,
    "body" : "The problem isn&#39;t in the block of code you&#39;ve posted. As the stack trace says, the exception is thrown because somewhere you&#39;ve tried to get a value from an empty <code>Optional</code> with <code>orElseThrow</code>. I&#39;d suggest looking at the <code>RequestMessageType</code> class first for somewhere you&#39;re using <code>orElseThrow</code>, as that&#39;s the first class in the stack.",
    "score" : 0,
    "owner" : {
      "account_id" : 13097820,
      "reputation" : 312,
      "user_id" : 9463210,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/zqvA4.jpg?s=256",
      "display_name" : "DrRelling",
      "link" : "https://stackoverflow.com/users/9463210/drrelling"
    },
    "creation_date" : 1761834095,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79804884" : [ {
      "comment_id" : 140837978,
      "post_id" : 79804884,
      "body" : "I&#39;m sorry. I don&#39;t <code>setByteOrder()</code> in the <code>ByteArrayRawSerializer</code> hierarchy even in <code>v6.4.2</code> tag: <a href=\"https://github.com/spring-projects/spring-integration/blob/v6.4.2/spring-integration-ip/src/main/java/org/springframework/integration/ip/tcp/serializer/ByteArrayRawSerializer.java\" rel=\"nofollow noreferrer\">github.com/spring-projects/spring-integration/blob/v6.4.2/&hellip;</a>. Please, elaborate.",
      "score" : 0,
      "owner" : {
        "account_id" : 3273937,
        "reputation" : 122596,
        "user_id" : 2756547,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/2158ce6e7c048277890eb64458864c1c?s=256&d=identicon&r=PG",
        "display_name" : "Artem Bilan",
        "link" : "https://stackoverflow.com/users/2756547/artem-bilan"
      },
      "creation_date" : 1762352734,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140834035,
      "post_id" : 79804884,
      "body" : "I think the blame for Spring is not fully correct. The out-of-the-box <code>ByteArrayRawSerializer</code> just does this: <code>outputStream.write(bytes);</code>. The <code>ByteOrder</code> has nothing to do over there. Please, elaborate where exactly in the Spring Integration we can incorporate that <code>ByteOrder</code> to make the fix in the library for everyone. Otherwise, explain, please, your custom <code>ByteArrayRawSerializer</code>.",
      "score" : 1,
      "owner" : {
        "account_id" : 3273937,
        "reputation" : 122596,
        "user_id" : 2756547,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/2158ce6e7c048277890eb64458864c1c?s=256&d=identicon&r=PG",
        "display_name" : "Artem Bilan",
        "link" : "https://stackoverflow.com/users/2756547/artem-bilan"
      },
      "creation_date" : 1762187898,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}