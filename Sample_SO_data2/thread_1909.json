{
  "question" : {
    "question_id" : 79668564,
    "title" : "cipher.init() with a valid key from android KeyStore throws error of key incompatibility",
    "body" : "<p>In my kivy 2.3.1, buildozer 1.5.0, p4a 2024.01.21, python 3.11.16 on MacOS, there is a piece of code for secure save locally. The cipher.init() keeps throws the following error:</p>\n<pre><code>06-18 15:49:56.872  4851  4988 I python  : Save failed: Invalid instance of 'javax/crypto/SecretKey' passed for a 'java/security/cert/Certificate'\n06-18 15:49:56.873  4851  4988 I python  :  Traceback (most recent call last):\n06-18 15:49:56.873  4851  4988 I python  :    File &quot;/Users/macbook/Documents/code/py/vmonfront/.buildozer/android/app/lib/android_secure_store.py&quot;, line 101, in save\n06-18 15:49:56.873  4851  4988 I python  :    File &quot;jnius/jnius_export_class.pxi&quot;, line 1163, in jnius.JavaMultipleMethod.__call__\n06-18 15:49:56.873  4851  4988 I python  :    File &quot;jnius/jnius_export_class.pxi&quot;, line 871, in jnius.JavaMethod.__call__\n06-18 15:49:56.873  4851  4988 I python  :    File &quot;jnius/jnius_conversion.pxi&quot;, line 83, in jnius.populate_args\n06-18 15:49:56.874  4851  4988 I python  :    File &quot;jnius/jnius_utils.pxi&quot;, line 259, in jnius.check_assignable_from\n06-18 15:49:56.874  4851  4988 I python  :  TypeError: Invalid instance of 'javax/crypto/SecretKey' passed for a 'java/security/cert/Certificate'\n</code></pre>\n<p>Here is the line of code in save() which causes the error:</p>\n<pre><code>     cipher.init(Cipher.ENCRYPT_MODE, secret_key)\n</code></pre>\n<p>According to Java doc, cipher can be initialized as simple as above. Tried quite several ways to init and they all throw the same type mismatch error. It is verified that key is generated successfully and stored in android keyStore. The key is the following:</p>\n<pre><code>06-17 23:43:02.559  5820  5898 I python  : [DEBUG] SecretKey class: jnius.reflect.keystore2.AndroidKeyStoreSecretKey\n06-17 23:43:02.559  5820  5898 I python  : [DEBUG] SecretKey algorithm: AES\n06-17 23:43:02.559  5820  5898 I python  : [DEBUG] SecretKey format: None\n</code></pre>\n<p>Here is the full code:</p>\n<h1>android_secure_store.py</h1>\n<pre><code>from jnius import autoclass, cast\nimport base64\nimport json\nfrom kivy.storage.jsonstore import JsonStore\n\n# Android &amp; Java classes\nKeyStore = autoclass(&quot;java.security.KeyStore&quot;)\nKeyGenerator = autoclass(&quot;javax.crypto.KeyGenerator&quot;)\nCipher = autoclass(&quot;javax.crypto.Cipher&quot;) \nGCMParameterSpec = autoclass(&quot;javax.crypto.spec.GCMParameterSpec&quot;)\nKeyGenParameterSpecBuilder = autoclass(&quot;android.security.keystore.KeyGenParameterSpec$Builder&quot;)\nKeyProperties = autoclass(&quot;android.security.keystore.KeyProperties&quot;)\nPythonActivity = autoclass(&quot;org.kivy.android.PythonActivity&quot;)\n\n# Constants\nKEY_ALIAS = &quot;KivyAppSecretKey&quot;\nTRANSFORMATION = &quot;AES/GCM/NoPadding&quot;\nSTORE_FILE = &quot;secure_store.json&quot;\n\nclass AndroidSecureStore:\n    def __init__(self):\n        self.context = PythonActivity.mActivity\n        self.store = JsonStore(STORE_FILE)\n        self.keystore = KeyStore.getInstance(&quot;AndroidKeyStore&quot;)\n        self.keystore.load(None)\n\n        if not self.keystore.containsAlias(KEY_ALIAS):\n            self._generate_key()\n\n    def _generate_key(self):  ##&lt;&lt;==key seems not properly generated\n        try:\n            builder = KeyGenParameterSpecBuilder(\n                KEY_ALIAS,\n                KeyProperties.PURPOSE_ENCRYPT | KeyProperties.PURPOSE_DECRYPT\n            ).setBlockModes(&quot;GCM&quot;) \\\n             .setEncryptionPaddings(&quot;NoPadding&quot;) \\\n             .setSize(256) \\\n             .setRandomizedEncryptionRequired(True)\n\n            key_generator = KeyGenerator.getInstance(\n                KeyProperties.KEY_ALGORITHM_AES, &quot;AndroidKeyStore&quot;\n            )\n            key_generator.init(builder.build())\n            key_generator.generateKey()\n            print(&quot;Key generated successfully&quot;). ##&lt;&lt;== this line never fired\n        except Exception as e:\n            print(f&quot;Key generation failed: {e}&quot;)\n            raise\n        \n    def _get_secret_key(self):\n        # Get the entry from KeyStore\n        entry = self.keystore.getEntry(KEY_ALIAS, None)\n        \n        # Get the SecretKeyEntry class reference\n        SecretKeyEntry = autoclass('java.security.KeyStore$SecretKeyEntry')\n        \n        # Properly cast and extract the secret key\n        if isinstance(entry, SecretKeyEntry):\n            secret_key_entry = cast('java.security.KeyStore$SecretKeyEntry', entry)\n            return secret_key_entry.getSecretKey()\n        else:\n            raise ValueError(f&quot;KeyStore entry is not a SecretKeyEntry (got {type(entry)})&quot;)\n\n    def save(self, key, value):\n        try:\n            cipher = Cipher.getInstance(TRANSFORMATION)\n            secret_key = self._get_secret_key()\n            iv = bytearray(12)\n            SecureRandom().nextBytes(iv)  # Cryptographically secure\n        \n            params = GCMParameterSpec(128, iv)\n        \n            #standard init method\n            cipher.init(Cipher.ENCRYPT_MODE, secret_key, params). ##&lt;&lt;==this line throws error of save failed:\n\n            encrypted_bytes = cipher.doFinal(value.encode(&quot;utf-8&quot;))\n\n            self.store.put(key, \n                iv=base64.b64encode(iv).decode(),\n                data=base64.b64encode(encrypted_bytes).decode()\n            )\n            return True\n        except Exception as e:\n            print(f&quot;Save failed: {e}&quot;)\n            return False\n\n    \n</code></pre>\n<p>Here is the portion of buildozer.spec:</p>\n<pre><code>requirements = python3==3.11.12,kivy,pyjnius,cython\n\n#\nandroid.skip_download = True\nandroid.accept_sdk_license = True\nandroid.ndk_version = 25b\nandroid.sdk_version = 34\nandroid.api = 34\nandroid.minapi = 21\nandroid.ndk_path = /Users/macbook/Library/Android/sdk/ndk/25.2.9519653\nandroid.sdk_path = /Users/macbook/Library/Android/sdk\nandroid.sdkmanager_path = /Users/macbook/Library/Android/sdk/cmdline-tools/latest/bin/sdkmanager\nandroid.permissions = INTERNET,WRITE_EXTERNAL_STORAGE, READ_EXTERNAL_STORAGE, MANAGE_KEYS\np4a.branch = develop\n</code></pre>\n<p>Tried quite several other ways to init cipher, including one with iv and GCM params. But they all throw the same save failed ... error. cipher.init() seems to be very straight forward in the document and there quite several overloading available. Why cipher.init() mistakenly asks for an certs for asymmetrical algorithm?</p>\n",
    "tags" : [ "java", "android", "python-3.x", "kivy", "python-for-android" ],
    "owner" : {
      "account_id" : 902651,
      "reputation" : 10270,
      "user_id" : 938363,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://www.gravatar.com/avatar/23d75d7db4d98e9004cc9988c4b3a67f?s=256&d=identicon&r=PG",
      "display_name" : "user938363",
      "link" : "https://stackoverflow.com/users/938363/user938363"
    },
    "is_answered" : false,
    "view_count" : 143,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1750754401,
    "creation_date" : 1750141989,
    "link" : "https://stackoverflow.com/questions/79668564/cipher-init-with-a-valid-key-from-android-keystore-throws-error-of-key-incompa",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79677267,
    "question_id" : 79668564,
    "body" : "<p>To ensure the correct overload is chosen, <strong>explicitly cast</strong> the SecretKey to a javax.crypto.SecretKey. This helps PyJNIus resolve the correct method:</p>\n<pre><code>def save(self, key, value):\n    try:\n        cipher = Cipher.getInstance(TRANSFORMATION)\n        secret_key = self._get_secret_key()\n        \n        SecretKey = autoclass(&quot;javax.crypto.SecretKey&quot;)\n        secret_key = cast(&quot;javax.crypto.SecretKey&quot;, secret_key)\n        iv = bytearray(12)\n        SecureRandom = autoclass(&quot;java.security.SecureRandom&quot;)\n        secure_random = SecureRandom()\n        secure_random.nextBytes(iv)\n        \n        params = GCMParameterSpec(128, iv)\n        cipher.init(Cipher.ENCRYPT_MODE, secret_key, params)\n\n        encrypted_bytes = cipher.doFinal(value.encode(&quot;utf-8&quot;))\n\n        self.store.put(\n            key, \n            iv=base64.b64encode(iv).decode(),\n            data=base64.b64encode(encrypted_bytes).decode()\n        )\n        return True\n    except Exception as e:\n        print(f&quot;Save failed: {e}&quot;)\n        return False\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 22315638,
      "reputation" : 585,
      "user_id" : 16539029,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Ggpj0Cz_K_u5xRq1HNAGekj9q85jGzg6mjunRJp=k-s256",
      "display_name" : "Cihangir Yaman",
      "link" : "https://stackoverflow.com/users/16539029/cihangir-yaman"
    },
    "creation_date" : 1750754401,
    "last_activity_date" : 1750754401,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}