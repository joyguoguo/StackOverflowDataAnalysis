{
  "question" : {
    "question_id" : 79549524,
    "title" : "Use SQL Server temporary tables on a JDBC connection from Apache tomcat connection pool?",
    "body" : "<p>The fundamental requirement of SQL Server temporary tables is that the exist as long as the connection that created them is still open and is not reset with <code>sp_reset_connection</code>.</p>\n<p>If I create a temp table using code like this...</p>\n<pre><code>    sql = &quot;create table #SomeTable (\\n&quot; +\n          &quot;    SomeID   int,\\n&quot; +\n          &quot;    SomeTime datetime,\\n&quot; +\n          &quot;    primary key (SomeID,SomeTime)\\n&quot; +\n          &quot;);\\n&quot; +\n          &quot;select * from tempdb.sys.tables order by name desc&quot;;\n    \n    PreparedStatement pstmt = con.prepareStatement(sql);\n    ResultSet rs = pstmt.executeQuery();\n    // extract rows from result set....\n\n    sql = &quot;select * from #SomeTable&quot;;\n    pstmt = con.prepareStatement(sql);\n    rs = pstmt.executeQuery();\n    // extract rows from result set....\n</code></pre>\n<p>The first query produces a result that shows that the temp table was created and is listed in tempdb.sys.tables.</p>\n<p>The second query gets an SQLException because now #SomeTable does not exist.</p>\n<p>The general reason for this is probably that the connection pool is resetting the underlying connection using sp_connection_reset. It is supposed to do this at certain times, and according to configuration. Examples are when a connection is borrowed from the pool or returned to the pool, when a connection is determined to be abandoned. My abandon timeout is currently 10 minutes. It's not happening here.</p>\n<p>I have not found a configuration parameter for the pool that determines whether the connection is reset in between prepared statements.</p>\n<p>I can eventually chase this down in the tomcat pool source code, of course.</p>\n<p>I am looking for ideas from anyone who happens to know what tomcat pool configuration parameters might allow me to re-use a connection for two or three statements that use a temp table on SQL Server.</p>\n",
    "tags" : [ "java", "sql-server", "tomcat", "jdbc", "connection-pooling" ],
    "owner" : {
      "account_id" : 1438342,
      "reputation" : 1892,
      "user_id" : 1359231,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/65be125b470a0bf7c14fa973d9fbb50e?s=256&d=identicon&r=PG",
      "display_name" : "joshp",
      "link" : "https://stackoverflow.com/users/1359231/joshp"
    },
    "is_answered" : false,
    "view_count" : 83,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743562421,
    "creation_date" : 1743559760,
    "link" : "https://stackoverflow.com/questions/79549524/use-sql-server-temporary-tables-on-a-jdbc-connection-from-apache-tomcat-connecti",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140290428,
    "post_id" : 79549524,
    "body" : "@siggemannen Yes, it may cause a mess in multi-tenant applications. (Or perhaps it is not messy because it is a &#39;Global Temp Table,&#39; which is originally intended for global use. It depends on how the OP wants to use it.) So, another approach, as Charlieface mentioned, is to avoid using prepared statements and use regular statements instead.",
    "score" : 0,
    "owner" : {
      "account_id" : 26698569,
      "reputation" : 4090,
      "user_id" : 20306007,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/98bbc403493aee3681b71dae7abef66e?s=256&d=identicon&r=PG",
      "display_name" : "life888888",
      "link" : "https://stackoverflow.com/users/20306007/life888888"
    },
    "creation_date" : 1743597359,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140290175,
    "post_id" : 79549524,
    "body" : "@life888888 that would be messy in a tomcat multi-tenant application",
    "score" : 0,
    "owner" : {
      "account_id" : 17972905,
      "reputation" : 10131,
      "user_id" : 13061224,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/GyOMS.jpg?s=256",
      "display_name" : "siggemannen",
      "link" : "https://stackoverflow.com/users/13061224/siggemannen"
    },
    "creation_date" : 1743593126,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140289819,
    "post_id" : 79549524,
    "body" : "Another Temp Table approach: use  Global Temp Table : add two &#39;#&#39; as Global Temp Table. ex: <code>create table ##SomeTable</code> ,  <code>select * from ##SomeTable;</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 26698569,
      "reputation" : 4090,
      "user_id" : 20306007,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/98bbc403493aee3681b71dae7abef66e?s=256&d=identicon&r=PG",
      "display_name" : "life888888",
      "link" : "https://stackoverflow.com/users/20306007/life888888"
    },
    "creation_date" : 1743588219,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140289477,
    "post_id" : 79549524,
    "body" : "Temp tables are dropped at the end of the <i>scope</i> they are created in, if using a prepared statement. It needs to be an ad-hoc batch, not a prepared statement, if you want to use it in a different command. So try <code>con.createStatement</code> and <code>stmt.executeBatch</code> instead.",
    "score" : 1,
    "owner" : {
      "account_id" : 20264817,
      "reputation" : 78793,
      "user_id" : 14868997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/40cbeeb90667c9a8c1830f615a9b2899?s=256&d=identicon&r=PG",
      "display_name" : "Charlieface",
      "link" : "https://stackoverflow.com/users/14868997/charlieface"
    },
    "creation_date" : 1743583596,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288899,
    "post_id" : 79549524,
    "body" : "It would be hard to use such a pool where statements can be randomly evicted. Are you sure you didn&#39;t misspell something? What driver version and Conn string are you using? Perhaps it uses dynamic SQL to prepare the statement so the temp table goes out of scope",
    "score" : 0,
    "owner" : {
      "account_id" : 17972905,
      "reputation" : 10131,
      "user_id" : 13061224,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/GyOMS.jpg?s=256",
      "display_name" : "siggemannen",
      "link" : "https://stackoverflow.com/users/13061224/siggemannen"
    },
    "creation_date" : 1743574341,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288871,
    "post_id" : 79549524,
    "body" : "@siggemannen Most likely there is a policy within Tomcat pool that may be configurable. Anyway, my question is not about whether one should use temp tables. That&#39;s a long and different conversation.",
    "score" : 0,
    "owner" : {
      "account_id" : 1438342,
      "reputation" : 1892,
      "user_id" : 1359231,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/65be125b470a0bf7c14fa973d9fbb50e?s=256&d=identicon&r=PG",
      "display_name" : "joshp",
      "link" : "https://stackoverflow.com/users/1359231/joshp"
    },
    "creation_date" : 1743573692,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288866,
    "post_id" : 79549524,
    "body" : "@life888888 First and second queries are in the same method. Does not close the connection. Does not return it to pool. Connection is acquired once, and used for two statements.",
    "score" : 0,
    "owner" : {
      "account_id" : 1438342,
      "reputation" : 1892,
      "user_id" : 1359231,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/65be125b470a0bf7c14fa973d9fbb50e?s=256&d=identicon&r=PG",
      "display_name" : "joshp",
      "link" : "https://stackoverflow.com/users/1359231/joshp"
    },
    "creation_date" : 1743573600,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288794,
    "post_id" : 79549524,
    "body" : "If you don&#39;t close the connection in between, this is not supposed to happen. Or tomcat pool is way too aggressive! But I wouldn&#39;t use temp tables for transient lifecycles like tomcat.",
    "score" : 0,
    "owner" : {
      "account_id" : 17972905,
      "reputation" : 10131,
      "user_id" : 13061224,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/GyOMS.jpg?s=256",
      "display_name" : "siggemannen",
      "link" : "https://stackoverflow.com/users/13061224/siggemannen"
    },
    "creation_date" : 1743571899,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140288526,
    "post_id" : 79549524,
    "body" : "(1) Are the second Query and the first Query in different methods? (2) Does the Connection variable of the second Query use the same Connection variable as the first Query? (3) Is the Connection re-acquired each time?",
    "score" : 1,
    "owner" : {
      "account_id" : 26698569,
      "reputation" : 4090,
      "user_id" : 20306007,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/98bbc403493aee3681b71dae7abef66e?s=256&d=identicon&r=PG",
      "display_name" : "life888888",
      "link" : "https://stackoverflow.com/users/20306007/life888888"
    },
    "creation_date" : 1743560833,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}