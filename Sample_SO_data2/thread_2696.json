{
  "question" : {
    "question_id" : 79605654,
    "title" : "Gmail API HTML message with UTF-8 character-set extended characters",
    "body" : "<p>Just converted my GCP cloud Java app to send email messages to Google Workspace via Gmail API rather than sendmail. In the past I was able to format HTML UTF-8 and send extended characters, but now it seems google is replacing them with &quot;?&quot; literals once it receives the message. I have verified that prior to sending using Gmail API the characters are there, and verified that after the message is sent through Gmail and distributed to the client, the raw message text contains &quot;?&quot; instead of the original characters.</p>\n<p>In my HTML message body I am using this meta tag:</p>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;head&gt;\n   &lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=UTF-8&quot; /&gt;\n&lt;/head&gt;\n</code></pre>\n<p>The special characters include the alternative form for double-open quotes, double-close quotes, and stylized apostrophe:</p>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;p&gt;“Must’ve been fate, you and I.”&lt;/p&gt;\n</code></pre>\n<p>Gmail API is replacing this with:</p>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;p&gt;?Must?ve been fate, you and I.?&lt;/p&gt;\n</code></pre>\n<p>and it shows that way on all devices/mail clients because the &quot;?&quot; are now literal.</p>\n<p>Java code that calls the Gmail API:</p>\n<pre class=\"lang-java prettyprint-override\"><code>MimeMessage email = new MimeMessage(session);\n...\n\nemail.setSubject(subject);\nemail.setContent(htmlBodyText, &quot;text/html&quot;);\n...\nByteArrayOutputStream buffer = new ByteArrayOutputStream();\nemail.writeTo(buffer);\nbyte[] rawMessageBytes = buffer.toByteArray();\nString encodedEmail = Base64.encodeBase64URLSafeString(rawMessageBytes);\nMessage message = new Message();\nmessage.setRaw(encodedEmail);\n...\nmessage = service.users().messages().send(myEmailAddress, message).execute();\n</code></pre>\n<p>Suggestions?</p>\n<p><strong>UPDATE:</strong> Adding the raw message source received by Thunderbird mail client for reference:</p>\n<pre><code>--0000000000002d8e4006346347a4\nContent-Type: text/html; charset=&quot;UTF-8&quot;\nContent-Transfer-Encoding: quoted-printable\n\n&lt;html&gt;\n\n&lt;head&gt;\n  =20\n   &lt;meta http-equiv=3D&quot;Content-Type&quot; content=3D&quot;text/html; charset=3DUTF-8&quot;=\n&gt;\n&lt;/head&gt;\n\n&lt;body&gt;\n   &lt;div style=3D&quot;padding:10px 15% 10px 15%;text-align:center;font-family:&amp;#=\n39;Open Sans&amp;#39;,Helvetica,Arial,sans-serif&quot;&gt;\n      =20\n   &lt;div style=3D&quot;width:100%;height:100px;background-color:black;margin-bott=\nom:20px;color:white;text-align:center;vertical-align:bottom;display:inline-=\nblock;font-family:WeezerFont,Verdana,&amp;#39;Open Sans&amp;#39;,Helvetica,Arial,sa=\nns-serif;padding-top:10px;padding-bottom:10px;padding-top:10px&quot;&gt;\n   &lt;/div&gt;\n=20\n\n      &lt;div style=3D&quot;width:100%;height:100px;margin-bottom:20px;text-align:c=\nenter;vertical-align:bottom;display:inline-block;font-family:WeezerFont,Ver=\ndana,&amp;#39;Open Sans&amp;#39;,Helvetica,Arial,sans-serif&quot;&gt;\n      &lt;/div&gt;\n\n      &lt;h2&gt;Test Email Message&lt;/h2&gt;\n\n      &lt;p&gt;?Must?ve been fate, you and I.?&lt;/p&gt;\n     =20\n      &lt;p&gt;        =20\n         Lorem ipsum dolor sit amet, consectetur adipiscing elit. Proin con=\nsectetur mauris ac placerat consequat. Nulla\n         dictum libero mi, ac tempor neque tincidunt vitae. Quisque sagitti=\ns dignissim erat non accumsan. Cras eget\n         mauris orci. Proin sed ullamcorper metus. Donec ut turpis vitae er=\nos consequat egestas vitae ac mi. Duis\n         tristique ipsum dictum diam imperdiet, tempus sagittis ante ultric=\nies. In hac habitasse platea dictumst. Sed\n         consectetur imperdiet turpis, vel consequat ex malesuada vel. Inte=\nger ut mauris metus. Phasellus eleifend\n         sollicitudin est et posuere. Nam cursus sapien quis erat tincidunt=\n pharetra. Praesent id neque ut felis\n         scelerisque aliquam. Nunc gravida ac erat quis dignissim. &lt;/p&gt;\n\n   &lt;/div&gt;\n\n=20\n\n&lt;/body&gt;\n\n&lt;/html&gt;\n\n--0000000000002d8e4006346347a4--\n</code></pre>\n",
    "tags" : [ "java", "html", "email", "utf-8", "gmail-api" ],
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "is_answered" : true,
    "view_count" : 139,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1746546355,
    "creation_date" : 1746364645,
    "link" : "https://stackoverflow.com/questions/79605654/gmail-api-html-message-with-utf-8-character-set-extended-characters",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79609053,
    "question_id" : 79605654,
    "body" : "<p>Thank you to everyone who responded.</p>\n<p>I received some input here: <a href=\"https://www.googlecloudcommunity.com/gc/Workspace-Developer/Gmail-API-HTML-message-with-UTF-8-character-set-extended/m-p/903889#M2940\" rel=\"nofollow noreferrer\">https://www.googlecloudcommunity.com/gc/Workspace-Developer/Gmail-API-HTML-message-with-UTF-8-character-set-extended/m-p/903889#M2940</a>  which indeed solved the problem by adding additional calls to set the UTF-8 in additional places in the code.</p>\n<p>Here are the updates that worked:</p>\n<pre class=\"lang-java prettyprint-override\"><code>            Properties props = new Properties();\n            props.put(&quot;mail.mime.charset&quot;, StandardCharsets.UTF_8.displayName());\n            Session session = Session.getInstance(props);\n            MimeMessage email = new MimeMessage(session);\n            \n            email.setFrom(new InternetAddress(appConfig.getThreadedApp()));\n            email.addRecipient(javax.mail.Message.RecipientType.TO, new InternetAddress(toEmailAddress));\n\n         ...\n\n            email.setSubject(subject, StandardCharsets.UTF_8.displayName());\n            email.setContent(htmlBodyText, ContentType.TEXT_HTML.getMimeType()+ &quot;; charset=&quot;+StandardCharsets.UTF_8.displayName());\n            \n            ByteArrayOutputStream buffer = new ByteArrayOutputStream();\n            email.writeTo(buffer);\n            byte[] rawMessageBytes = buffer.toByteArray();\n            String encodedEmail = Base64.encodeBase64URLSafeString(rawMessageBytes);\n            Message message = new Message();\n            message.setRaw(encodedEmail);\n\n         ...\n\n            message = service.users().messages().send(myEmailAddress, message).execute();\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746546355,
    "last_activity_date" : 1746546355,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140399577,
    "post_id" : 79605654,
    "body" : "<i>it says that the text file encoding is UTF-8</i> That could be actually saying you&#39;ve <i>set</i> it to utf8. If you&#39;re not using Windows, then something like <code>xxd the_file</code> might settle the matter",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1746522835,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140398017,
    "post_id" : 79605654,
    "body" : "I checked the template file in my IDE, and it says that the text file encoding is UTF-8, and I don&#39;t use Windows OS.",
    "score" : 0,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746472868,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140397640,
    "post_id" : 79605654,
    "body" : "Okay, the message text comes from a Thymeleaf template.  Since each quotation mark is being replaced with only a single <code>?</code>, I wonder if perhaps your template was saved using a windows-125x encoding (in the US, it would be <a href=\"https://en.wikipedia.org/wiki/Windows-1252#Codepage_layout\" rel=\"nofollow noreferrer\">windows-1252</a>), which encodes the <code>‘ ’ “ ”</code> characters as single bytes.",
    "score" : 0,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44991,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1746464076,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140396905,
    "post_id" : 79605654,
    "body" : "Yes it is a literal ? character, not the one inside a diamond.",
    "score" : 0,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746449708,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140396896,
    "post_id" : 79605654,
    "body" : "The message text is generated programmatically by my Java app, with the assistance of a library called thymeleaf, which worked perfectly before and after the transition to Gmail API. It is a templating engine that takes a template with a set of properties and produces a string output.",
    "score" : 0,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746449650,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140396847,
    "post_id" : 79605654,
    "body" : "I&#39;m viewing the pre-sent message body by logging it to logfile using Log4J framework to ensure that the extended characters are actually there.",
    "score" : 0,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746448677,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140396831,
    "post_id" : 79605654,
    "body" : "<code>email.setText()</code> isn&#39;t being called at all. The code is calling <code>email.setContent()</code> as shown above instead to specify the content type.  <code>Base64.encodeBase64URLSafeString()</code> is converting the MimeMessage object into a streamable buffer that will be sent to Google Workspace using the Gmail API call shown in the last line of code.  I am examining the output in different mail clients and browsers including: Thunderbird, Google Mail, Spark, and also looking at the raw message source to see what was data was actually received by the email client before rendering.",
    "score" : 0,
    "owner" : {
      "account_id" : 13744894,
      "reputation" : 53,
      "user_id" : 9918913,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae83d65c10ef6424b21bfe882bf6b608?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jn4",
      "link" : "https://stackoverflow.com/users/9918913/jn4"
    },
    "creation_date" : 1746448379,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140394800,
    "post_id" : 79605654,
    "body" : "Lots of unknowns here.  Where did the message text come from?  What does the call to <code>email.setText</code> look like?  What is <code>Base64.encodeBase64URLSafeString</code> doing?  Is it making assumptions about the charset?  Is it letting the default charset?  And finally, how are you examining the message?  What editor or mail client is showing <code>?Must?ve</code>?  What charset is in the message’s Content-Type header?",
    "score" : 1,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44991,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1746375528,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140394519,
    "post_id" : 79605654,
    "body" : "Is this a literal ? or a <a href=\"https://en.wikipedia.org/wiki/Specials_(Unicode_block)#Replacement_character\" rel=\"nofollow noreferrer\">Replacement character</a> � ?",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1746366764,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}