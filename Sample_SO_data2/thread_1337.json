{
  "question" : {
    "question_id" : 79721229,
    "title" : "Massive performance overhead for @Transactional methods",
    "body" : "<p>using a Spring Boot (3.5) service and an Azure hosted MySQL 8 Database I found that we have quite a lot of performance loss when calling methods that are annotated as @org.springframework.transaction.annotation.Transactional</p>\n<p>What I found is that whatever happens inside the dynamic proxy takes twice as long as what happens inside the service. I've experienced this behaviour in many cases throughout the application and was able to reproduce it in the following simplified setup:</p>\n<pre><code>@Controller\n@RequiredArgsConstructor\npublic class TransactionPerformanceInvestigatingController {\n\n    private final TransactionalTestingService transactionalTestingService;\n\n    @GetMapping(&quot;/transaction-performance-investigating&quot;)\n    @ResponseBody\n    public Object investigate() {\n        // Measure A start\n        transactionalTestingService.doSomething();\n        // Measure A stop\n        return &quot;done&quot;;\n    }\n}\n\n/////////////////////////////////////////////////////////////////////\n\n@Component\n@RequiredArgsConstructor\nclass TransactionalTestingService {\n\n    private final ShopTenantProvider provider;\n\n    @Transactional(readOnly = true)\n    public Object doSomething() {\n        // Measure B start\n        final List&lt;ShopTenant&gt; result = provider.getAll();\n        // Measure B stop\n        return result; \n    }\n}Â \n</code></pre>\n<p>in terms of durations, what I could see is that, Measure A will typically be between 2-4 times of Measure B.</p>\n<p>(e.g. P50 Measure A is 16ms, P50 Mesure B is 6ms; P99 Measure A is 42ms, Measure B is 16ms)</p>\n<p>I am trying to understand what mechanisms at play here to optimize the performance as we're struggling with the latency (especially in the higher percentiles) What I've been able to rule out is:</p>\n<ul>\n<li>Connection pool size is not the problem. This behaviour is the same on our test system with one query as it is with 30 parallell queries.</li>\n<li>Acquiring connections and setting autocommit to false seems pretty fast (3ms)</li>\n<li>commit itself seems pretty fast too (0ms, as there's nothing to commit in a select query)</li>\n<li>when running locally against a local MySQL, this effect does not exist</li>\n</ul>\n<p>The questions I have is:</p>\n<ul>\n<li>What exactly are the things happening here?</li>\n<li>How can I get more insights into why they take so long? (we're using NewRelic for performance tracking, and whatever happens inside the proxy is invisible there)</li>\n<li>Is this overhead normal? (maybe it is, but I am rather skeptical)</li>\n</ul>\n<p>Some more details about the involved tech:</p>\n<ul>\n<li>MySQL Server: Azure managed service</li>\n<li>Persistence Provider: JPA and spring-boot-data-jpa</li>\n<li>driver: com.mysql.cj.jdbc.Driver</li>\n<li>connection pool: hikari, wrapped in a <a href=\"https://github.com/jdbc-observations/datasource-proxy/\" rel=\"nofollow noreferrer\">datasource-proxy</a>.</li>\n</ul>\n",
    "tags" : [ "java", "spring-boot", "spring-data-jpa", "transactions" ],
    "owner" : {
      "account_id" : 792027,
      "reputation" : 2875,
      "user_id" : 869368,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2fbecbc4c9b1c79fd9a903b48cac5dba?s=256&d=identicon&r=PG",
      "display_name" : "Matthias",
      "link" : "https://stackoverflow.com/users/869368/matthias"
    },
    "is_answered" : true,
    "view_count" : 340,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1754049319,
    "creation_date" : 1753961608,
    "link" : "https://stackoverflow.com/questions/79721229/massive-performance-overhead-for-transactional-methods",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79722413,
    "question_id" : 79721229,
    "body" : "<p>The combination of OSIV (Open Session In View) with network delay (RTT (round-trip time) between the app and Azure MySQL) can cause this.</p>\n<p>Disable OSIV, this way your database connections will be released immediately which is vital especially under high load.</p>\n<pre class=\"lang-yaml prettyprint-override\"><code>spring:\n  jpa:\n    open-in-view: false\n</code></pre>\n<p>Also, to avoid Spring AOP overhead issues, I would recommend using TransactionTemplate instead of @Transactional annotation.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\n@RequiredArgsConstructor\nclass TransactionalTestingService {\n\n    private final ShopTenantProvider provider;\n    private final TransactionTemplate transactionTemplate;\n\n    public Object doSomething() {\n        // Measure B start\n        final List&lt;ShopTenant&gt; result = transactionTemplate.execute(r -&gt; provider.getAll());\n        \n        // Measure B stop\n        return result; \n    }\n} \n</code></pre>\n<pre><code></code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 39339042,
      "reputation" : 101,
      "user_id" : 29227008,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/M63oMOgp.jpg?s=256",
      "display_name" : "Oleg Cheban",
      "link" : "https://stackoverflow.com/users/29227008/oleg-cheban"
    },
    "creation_date" : 1754046430,
    "last_activity_date" : 1754049319,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140661663,
    "post_id" : 79721229,
    "body" : "Can you provide the generated SQL for each case?",
    "score" : 0,
    "owner" : {
      "account_id" : 529143,
      "reputation" : 143656,
      "user_id" : 1766831,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1ee974306d2def46eb69534fbcf95cc5?s=256&d=identicon&r=PG",
      "display_name" : "Rick James",
      "link" : "https://stackoverflow.com/users/1766831/rick-james"
    },
    "creation_date" : 1755060915,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140640708,
    "post_id" : 79721229,
    "body" : "@M.Deinum setting autocommit to false helped a lot. Now the time lost before the actual work starts is basically zero. So first part is solved. But I am still wondering, why the finishing of the transaction still takes longer than the queries performend in it (esp. with super simple select queries on small tables)?",
    "score" : 0,
    "owner" : {
      "account_id" : 792027,
      "reputation" : 2875,
      "user_id" : 869368,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2fbecbc4c9b1c79fd9a903b48cac5dba?s=256&d=identicon&r=PG",
      "display_name" : "Matthias",
      "link" : "https://stackoverflow.com/users/869368/matthias"
    },
    "creation_date" : 1754312194,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140633339,
    "post_id" : 79721229,
    "body" : "can you try using for those queries methods: <code>@Transactional(readOnly = true)</code> see if it improves. The reasoning is that this will skip unnecessary flushes and depending on the RDBMs it might skip commits (spring will still issue it though, db might decide to skip)",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1753979548,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140632709,
    "post_id" : 79721229,
    "body" : "setting auto-commit generally isn&#39;t fast and at the end it is reset. You can configure HIkari to enable auto-commit to false and instruct Hibernate not to interfere. Next to that you are using JPA, which at a commit will do a dirty checking which can take time (I&#39;m not sure if things propagate to Hibernate). It is also unclear what your <code>getAll</code> method actually does, normally a get returns a proxy (whereas a find returns actual objects) which are filled later which leads to additional db access. In short without your properties and some more insight in your code this is impossible to answer.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1753966088,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140632582,
    "post_id" : 79721229,
    "body" : "Misconception: &quot;commit is pretty fast as there is nothing to do&quot;. Not necessarily. A proper DB will then check that each query run in the transaction would produce the same result now and fail (with error &#39;retry&#39;) if not - assuming transaction isolation level SERIALIZABLE (which you should use, unless you really know what you are doing). However, I somewhat doubt MySQL&#39;s ability to do it right.",
    "score" : 0,
    "owner" : {
      "account_id" : 401843,
      "reputation" : 107206,
      "user_id" : 768644,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b13bedc5215730fbce5edff6c130988a?s=256&d=identicon&r=PG",
      "display_name" : "rzwitserloot",
      "link" : "https://stackoverflow.com/users/768644/rzwitserloot"
    },
    "creation_date" : 1753963458,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140632541,
    "post_id" : 79721229,
    "body" : "Looks like it is network delay. Transaction requires at least two additional roundtrip to db (one to start, another to commit). So it explains 3x times (I guess all roundtrip dominate all other costs).",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20796,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1753962680,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79722413" : [ {
      "comment_id" : 140640705,
      "post_id" : 79722413,
      "body" : "good answer, but unfortunately didn&#39;t address the issue. First because we have open-in-view already disabled and second, the TransactinTemplate did not show any measurable improvements.",
      "score" : 0,
      "owner" : {
        "account_id" : 792027,
        "reputation" : 2875,
        "user_id" : 869368,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/2fbecbc4c9b1c79fd9a903b48cac5dba?s=256&d=identicon&r=PG",
        "display_name" : "Matthias",
        "link" : "https://stackoverflow.com/users/869368/matthias"
      },
      "creation_date" : 1754312099,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}