{
  "question" : {
    "question_id" : 79619569,
    "title" : "TWA postMessage not working - No navigation events or message channel callbacks",
    "body" : "<p><strong>Problem</strong></p>\n<p>I have a Trusted Web Activity (TWA) Android app built using Bubblewrap. The TWA launches successfully, and the CustomTabs service connects without issues.</p>\n<p>However, I'm not receiving any navigation events or message channel callbacks when trying to implement postMessage communication between the native Android code and the web content.</p>\n<p>My objective is to use this communication to trigger the notification permission popup based on whether the user is registered or not.</p>\n<p>I've followed the <a href=\"https://developer.chrome.com/docs/android/post-message-twa\" rel=\"nofollow noreferrer\">official postMessage documentation</a> for TWAs, but the expected callbacks are not firing.</p>\n<p>What could be the potential causes for this, and how can I properly establish the postMessage communication channel for handling notification permissions in a TWA?</p>\n<p><strong>Environment</strong></p>\n<ul>\n<li>Android app using TWA</li>\n<li>Chrome version: 115+ (required for TWA postMessage support)</li>\n<li>androidx.browser library: v1.6.0-alpha02+</li>\n<li>Digital Asset Links (DAL) properly configured (verified by TWA launching without address bar)</li>\n</ul>\n<p><strong>Current Implementation</strong></p>\n<p>AndroidManifest.xml:</p>\n<pre><code>&lt;service android:name=&quot;androidx.browser.customtabs.PostMessageService&quot;\n         android:exported=&quot;true&quot;/&gt;\n</code></pre>\n<p>LauncherActivity.java:</p>\n<pre><code>    package com.mywebsite.twa;\n\nimport android.Manifest;\nimport android.content.ComponentName;\nimport android.content.pm.ActivityInfo;\nimport android.content.pm.PackageManager;\nimport androidx.core.app.ActivityCompat;\nimport androidx.core.content.ContextCompat;\nimport android.net.Uri;\nimport android.os.Build;\nimport android.os.Bundle;\nimport android.util.Log;\n\nimport androidx.annotation.NonNull;\nimport androidx.annotation.Nullable;\nimport androidx.browser.customtabs.CustomTabsCallback;\nimport androidx.browser.customtabs.CustomTabsClient;\nimport androidx.browser.customtabs.CustomTabsServiceConnection;\nimport androidx.browser.customtabs.CustomTabsSession;\n\npublic class LauncherActivity extends com.google.androidbrowserhelper.trusted.LauncherActivity {\n    private static final String TAG = &quot;MywebsiteTWA&quot;;\n    private static final String MESSAGE_TO_JS = &quot;Hello from Android&quot;;\n    \n    private CustomTabsClient mClient;\n    private CustomTabsSession mSession;\n    private boolean mValidated;\n    private boolean mChannelRequested;\n    private final CustomTabsCallback mCustomTabsCallback = new CustomTabsCallback() {\n        @Override\n        public void onNavigationEvent(int navigationEvent, @Nullable Bundle extras) {\n            String eventName;\n            switch (navigationEvent) {\n                case NAVIGATION_STARTED:\n                    eventName = &quot;NAVIGATION_STARTED&quot;;\n                    break;\n                case NAVIGATION_FINISHED:\n                    eventName = &quot;NAVIGATION_FINISHED&quot;;\n                    break;\n                case NAVIGATION_FAILED:\n                    eventName = &quot;NAVIGATION_FAILED&quot;;\n                    break;\n                case NAVIGATION_ABORTED:\n                    eventName = &quot;NAVIGATION_ABORTED&quot;;\n                    break;\n                case TAB_SHOWN:\n                    eventName = &quot;TAB_SHOWN&quot;;\n                    break;\n                case TAB_HIDDEN:\n                    eventName = &quot;TAB_HIDDEN&quot;;\n                    break;\n                default:\n                    eventName = &quot;UNKNOWN(&quot; + navigationEvent + &quot;)&quot;;\n            }\n            Log.i(TAG, &quot;Navigation event: &quot; + eventName);\n\n            if (navigationEvent == TAB_SHOWN &amp;&amp; !mChannelRequested) {\n                Uri launchUrl = Uri.parse(getLaunchingUrl().toString());\n                Log.i(TAG, &quot;Requesting post message channel for &quot; + launchUrl);\n                \n                // Using the simpler approach that's been reported to work better\n                boolean channelRequested = mSession.requestPostMessageChannel(launchUrl);\n                Log.i(TAG, &quot;Post message channel request result: &quot; + channelRequested);\n                mChannelRequested = channelRequested;\n            }\n        }\n\n        @Override\n        public void onMessageChannelReady(@Nullable Bundle extras) {\n            Log.i(TAG, &quot;Message channel ready, sending initial message&quot;);\n            int result = mSession.postMessage(MESSAGE_TO_JS, null);\n            Log.i(TAG, &quot;Initial message send result: &quot; + result);\n        }\n\n        @Override\n        public void onPostMessage(@NonNull String message, @Nullable Bundle extras) {\n            Log.i(TAG, &quot;Received message from web: &quot; + message);\n            \n            // Handle specific messages from web\n            if (&quot;request_notification_permission&quot;.equals(message)) {\n                requestNotificationPermissionIfNeeded();\n            }\n        }\n\n        @Override\n        public void onRelationshipValidationResult(int relation, @NonNull Uri requestedOrigin,\n                boolean result, @Nullable Bundle extras) {\n            Log.i(TAG, &quot;Relationship validation result: &quot; + result);\n            mValidated = result;\n        }\n    };\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        Log.i(TAG, &quot;onCreate called&quot;);\n        super.onCreate(savedInstanceState);\n\n        if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.O) {\n            setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_PORTRAIT);\n        } else {\n            setRequestedOrientation(ActivityInfo.SCREEN_ORIENTATION_UNSPECIFIED);\n        }\n\n        initializeCustomTabs();\n    }\n\n    @Override\n    protected Uri getLaunchingUrl() {\n        Uri uri = super.getLaunchingUrl();\n        Log.i(TAG, &quot;Getting launch URL: &quot; + uri.toString());\n        return uri;\n    }\n\n    protected void requestNotificationPermissionIfNeeded() {\n        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.TIRAMISU &amp;&amp;\n                ContextCompat.checkSelfPermission(this, Manifest.permission.POST_NOTIFICATIONS)\n                        != PackageManager.PERMISSION_GRANTED) {\n            ActivityCompat.requestPermissions(\n                    this,\n                    new String[]{Manifest.permission.POST_NOTIFICATIONS},\n                    1001\n            );\n        }\n    }\n\n    private void initializeCustomTabs() {\n        Log.i(TAG, &quot;Initializing CustomTabs&quot;);\n        String packageName = CustomTabsClient.getPackageName(this, null);\n        Log.i(TAG, &quot;Using browser package: &quot; + packageName);\n        \n        CustomTabsClient.bindCustomTabsService(this, packageName, new CustomTabsServiceConnection() {\n            @Override\n            public void onCustomTabsServiceConnected(@NonNull ComponentName name, \n                                                   @NonNull CustomTabsClient client) {\n                Log.i(TAG, &quot;CustomTabs service connected&quot;);\n                mClient = client;\n                \n                // Warm up must be called before session creation\n                client.warmup(0L);\n                Log.i(TAG, &quot;Called warmup on CustomTabsClient&quot;);\n                \n                mSession = mClient.newSession(mCustomTabsCallback);\n                if (mSession == null) {\n                    Log.e(TAG, &quot;Failed to create new session&quot;);\n                } else {\n                    Log.i(TAG, &quot;CustomTabs session created successfully&quot;);\n                    // Pre-load the launch URL\n                    Uri launchUrl = Uri.parse(getLaunchingUrl().toString());\n                    Log.i(TAG, &quot;Pre-loading URL: &quot; + launchUrl);\n                    boolean success = mSession.mayLaunchUrl(launchUrl, null, null);\n                    Log.i(TAG, &quot;URL pre-load result: &quot; + success);\n                }\n            }\n\n            @Override\n            public void onServiceDisconnected(ComponentName name) {\n                Log.i(TAG, &quot;CustomTabs service disconnected&quot;);\n                mClient = null;\n                mSession = null;\n                mValidated = false;\n                mChannelRequested = false;\n            }\n        });\n    }\n\n    protected CustomTabsSession getSession() {\n        return mSession;\n    }\n}\n</code></pre>\n<p><strong>Current Behavior</strong></p>\n<p>From the logs:</p>\n<pre><code>---------------------------- PROCESS STARTED (27377) for package com.mywebsite.twa ----------------------------\n2025-05-13 16:30:44.715 27377-27399 AdrenoGLES-0            com.mywebsite.twa                   I  QUALCOMM build                   : ee3f1da111, Ie1e5aac4cc\n                                                                                                    Build Date                       : 01/11/24\n                                                                                                    OpenGL ES Shader Compiler Version: EV031.35.01.12\n                                                                                                    Local Branch                     : \n                                                                                                    Remote Branch                    : refs/tags/AU_LINUX_ANDROID_LA.UM.9.14.11.00.00.571.148\n                                                                                                    Remote Branch                    : NONE\n                                                                                                    Reconstruct Branch               : NOTHING\n2025-05-13 16:30:44.715 27377-27399 AdrenoGLES-0            com.mywebsite.twa                   I  Build Config                     : S P 10.0.7 AArch64\n2025-05-13 16:30:44.715 27377-27399 AdrenoGLES-0            com.mywebsite.twa                   I  Driver Path                      : /vendor/lib64/egl/libGLESv2_adreno.so\n2025-05-13 16:30:44.724 27377-27399 AdrenoGLES-0            com.mywebsite.twa                   I  PFP: 0x016dc094, ME: 0x00000000\n2025-05-13 16:30:44.741 27377-27399 OpenGLRenderer          com.mywebsite.twa                   I  setGrContext nullptr--&gt;validptr\n2025-05-13 16:30:44.744 27377-27399 OpenGLRenderer          com.mywebsite.twa                   E  Unable to match the desired swap behavior.\n2025-05-13 16:30:44.758 27377-27377 Compatibil...geReporter com.mywebsite.twa                   D  Compat change id reported: 160794467; UID 10542; state: ENABLED\n2025-05-13 16:30:44.761 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  CustomTabs service connected\n2025-05-13 16:30:44.763 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  Called warmup on CustomTabsClient\n2025-05-13 16:30:44.764 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  CustomTabs session created successfully\n2025-05-13 16:30:44.764 27377-27377 TWALauncherActivity     com.mywebsite.twa                   D  Using url from Manifest: https://mywebsite.com/index.html\n2025-05-13 16:30:44.764 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  Getting launch URL: https://mywebsite.com/index.html\n2025-05-13 16:30:44.764 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  Pre-loading URL: https://mywebsite.com/index.html\n2025-05-13 16:30:44.765 27377-27377 MywebsiteTWA           com.mywebsite.twa                   I  URL pre-load result: true\n2025-05-13 16:30:45.098 27377-27377 TwaLauncher             com.mywebsite.twa                   D  Launching Trusted Web Activity.\n2025-05-13 16:30:46.047 27377-27399 Surface                 com.mywebsite.twa                   D  Surface::disconnect\n2025-05-13 16:30:46.047 27377-27399 BufferQueueProducer     com.mywebsite.twa                   D  [VRI[LauncherActivity]#0(BLAST Consumer)0](id:6af100000000,api:1,p:27377,c:27377) disconnect: api 1\n2025-05-13 16:30:50.152 27377-27499 ProfileInstaller        com.mywebsite.twa                   D  Skipping profile installation for com.mywebsite.twa\n</code></pre>\n<p>The TWA launches successfully, but:</p>\n<ol>\n<li>No navigation events are being logged</li>\n<li>No message channel callbacks are triggered</li>\n<li>No communication is established between native code and web content</li>\n</ol>\n<p><strong>What I've Tried</strong></p>\n<ol>\n<li><p>Initially used the three-parameter version of\nrequestPostMessageChannel</p>\n<p>mSession.requestPostMessageChannel(sourceOrigin, targetOrigin, new Bundle())</p>\n</li>\n<li><p>Switched to the simpler single-parameter version as recommended in\nrecent discussions List item</p>\n</li>\n<li><p>Verified Digital Asset Links setup (TWA launches without address bar)</p>\n</li>\n<li><p>Added proper logging throughout the callback methods</p>\n</li>\n<li><p>Ensured web content has proper message event listener</p>\n</li>\n</ol>\n<p><strong>Question</strong></p>\n<ol>\n<li>Why aren't the navigation events being triggered in the\nCustomTabsCallback?</li>\n<li>What could be preventing the message channel\nfrom being established?</li>\n<li>Are there any additional steps needed to\nproperly initialize the postMessage functionality in TWA?</li>\n</ol>\n<p><strong>Additional Context</strong></p>\n<p>The TWA itself works correctly - it launches and displays the web content as expected. The issue seems specific to the postMessage implementation. The logs show successful service connection and URL pre-loading, but no subsequent navigation or message channel events.\nAny insights on what might be missing or what could be preventing the callback events from firing would be greatly appreciated.</p>\n<p><strong>Official Documentation at:</strong></p>\n<ol>\n<li><a href=\"https://developer.chrome.com/docs/android/post-message-twa\" rel=\"nofollow noreferrer\">https://developer.chrome.com/docs/android/post-message-twa</a></li>\n<li><a href=\"https://github.com/GoogleChrome/android-browser-helper/tree/main/demos/twa-post-message/src/main/java/com/google/androidbrowserhelper/demos/twapostmessage\" rel=\"nofollow noreferrer\">https://github.com/GoogleChrome/android-browser-helper/tree/main/demos/twa-post-message/src/main/java/com/google/androidbrowserhelper/demos/twapostmessage</a></li>\n</ol>\n",
    "tags" : [ "java", "android", "postmessage", "chrome-custom-tabs", "trusted-web-activity" ],
    "owner" : {
      "account_id" : 16506045,
      "reputation" : 61,
      "user_id" : 11926054,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-WCqLMLGYLz4/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdf3reMNf6sKdPAdyRQcPEo8OmtvA/s256-rj/photo.jpg",
      "display_name" : "Vishwajeet Singh Kushwah",
      "link" : "https://stackoverflow.com/users/11926054/vishwajeet-singh-kushwah"
    },
    "is_answered" : false,
    "view_count" : 167,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1747136507,
    "creation_date" : 1747136507,
    "link" : "https://stackoverflow.com/questions/79619569/twa-postmessage-not-working-no-navigation-events-or-message-channel-callbacks",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140873235,
    "post_id" : 79619569,
    "body" : "Maybe the problem is that you are preloading and checking for TAB_SHOWN? Try doing actual navigation, and then checking for NAVIGATION_FINISHED.",
    "score" : 0,
    "owner" : {
      "account_id" : 1773546,
      "reputation" : 31,
      "user_id" : 1617841,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/7282a8c55e042a004a4fabd42842de0e?s=256&d=identicon&r=PG",
      "display_name" : "ydragunov",
      "link" : "https://stackoverflow.com/users/1617841/ydragunov"
    },
    "creation_date" : 1764110954,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140607125,
    "post_id" : 79619569,
    "body" : "Did you resolve this? I am facing the same issue.",
    "score" : 0,
    "owner" : {
      "account_id" : 13402484,
      "reputation" : 496,
      "user_id" : 9671590,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-XdUIqdMkCWA/AAAAAAAAAAI/AAAAAAAAAAA/4252rscbv5M/s256-rj/photo.jpg",
      "display_name" : "dc09",
      "link" : "https://stackoverflow.com/users/9671590/dc09"
    },
    "creation_date" : 1753128774,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}