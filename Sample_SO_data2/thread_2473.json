{
  "question" : {
    "question_id" : 79620457,
    "title" : "Alfresco Content Services: Getting &quot;Node does not exist&quot; when creating new version via CMIS concurrently",
    "body" : "<p>I am currently working on upgrading Alfresco from 5.0.d to 25.1. My upgrade path was following: 5.0 -&gt; 5.2 -&gt; 7.4 -&gt; 25.1. Alfresco utilizes MariaDB 10.5 underneath. While the upgrade was mostly straightforward and pain free, I ran into a weird issue.</p>\n<p>I have a CMIS based script that keeps some files up to date (1k+ files) and script will basically go file by file, find current one in Alfresco via CMIS query, then upload new version via check-out, check-in. This was working great on 5.0.d. However, on 25.1 it's randomly breaking when I run the script with 3+ threads. Script is getting 'Object Info Missing' from the CMIS client and the catalina.out shows following stack trace:</p>\n<pre><code>org.alfresco.service.cmr.repository.InvalidNodeRefException: Node does not exist: workspace://SpacesStore/f2bddaef-a344-412a-bdda-efa344712a7c (status:Status[id=517226changeTxnId=8134b6bb-1846-4d54-b4b6-bb18463d542e, dbTxnId=251500, deleted=true])\n    at org.alfresco.repo.node.db.DbNodeServiceImpl.getNodePairNotNull(DbNodeServiceImpl.java:187)\n    at org.alfresco.repo.node.db.DbNodeServiceImpl.hasAspect_aroundBody38(DbNodeServiceImpl.java:1007)\n    at org.alfresco.repo.node.db.DbNodeServiceImpl$AjcClosure39.run(DbNodeServiceImpl.java:1)\n    at org.aspectj.runtime.reflect.JoinPointImpl.proceed(JoinPointImpl.java:164)\n    at org.alfresco.traitextender.RouteExtensions.intercept(RouteExtensions.java:100)\n    at org.alfresco.repo.node.db.DbNodeServiceImpl.hasAspect(DbNodeServiceImpl.java:1001)\n    at jdk.internal.reflect.GeneratedMethodAccessor261.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n    at org.alfresco.repo.lock.mem.LockableAspectInterceptor.invoke(LockableAspectInterceptor.java:129)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy42.hasAspect(Unknown Source)\n    at jdk.internal.reflect.GeneratedMethodAccessor261.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n    at org.alfresco.repo.tenant.MultiTNodeServiceInterceptor.invoke(MultiTNodeServiceInterceptor.java:111)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy42.hasAspect(Unknown Source)\n    at jdk.internal.reflect.GeneratedMethodAccessor261.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.alfresco.repo.service.StoreRedirectorProxyFactory$RedirectorInvocationHandler.invoke(StoreRedirectorProxyFactory.java:231)\n    at jdk.proxy2/jdk.proxy2.$Proxy57.hasAspect(Unknown Source)\n    at org.alfresco.repo.node.MLPropertyInterceptor.getPivotNodeRef(MLPropertyInterceptor.java:329)\n    at org.alfresco.repo.node.MLPropertyInterceptor.invoke(MLPropertyInterceptor.java:179)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.node.NodeRefPropertyMethodInterceptor.invoke(NodeRefPropertyMethodInterceptor.java:219)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy42.getProperties(Unknown Source)\n    at jdk.internal.reflect.GeneratedMethodAccessor297.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:216)\n    at jdk.proxy2/jdk.proxy2.$Proxy42.getProperties(Unknown Source)\n    at jdk.internal.reflect.GeneratedMethodAccessor297.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n    at org.alfresco.repo.node.ContentPropertyRestrictionInterceptor.invoke(ContentPropertyRestrictionInterceptor.java:207)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.audit.DisableAuditableBehaviourInterceptor.invoke(DisableAuditableBehaviourInterceptor.java:120)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at net.sf.acegisecurity.intercept.method.aopalliance.MethodSecurityInterceptor.invoke(MethodSecurityInterceptor.java:80)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.security.permissions.impl.ExceptionTranslatorMethodInterceptor.invoke(ExceptionTranslatorMethodInterceptor.java:53)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.audit.AuditMethodInterceptor.invoke(AuditMethodInterceptor.java:166)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.transaction.RetryingTransactionInterceptor$1.execute(RetryingTransactionInterceptor.java:95)\n    at org.alfresco.repo.transaction.RetryingTransactionHelper.doInTransaction(RetryingTransactionHelper.java:452)\n    at org.alfresco.repo.transaction.RetryingTransactionInterceptor.invoke(RetryingTransactionInterceptor.java:85)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy42.getProperties(Unknown Source)\n    at org.alfresco.opencmis.CMISNodeInfoImpl.getNodeProps(CMISNodeInfoImpl.java:1117)\n    at org.alfresco.opencmis.mapping.DirectProperty.getValueInternal(DirectProperty.java:72)\n    at org.alfresco.opencmis.mapping.AbstractProperty.getValue(AbstractProperty.java:124)\n    at org.alfresco.opencmis.CMISConnector.getNodeProperties(CMISConnector.java:1952)\n    at org.alfresco.opencmis.CMISConnector.createCMISObject(CMISConnector.java:1553)\n    at org.alfresco.opencmis.AlfrescoCmisServiceImpl.getObjectInfo(AlfrescoCmisServiceImpl.java:2848)\n    at org.alfresco.opencmis.AlfrescoCmisServiceImpl.getObjectInfo(AlfrescoCmisServiceImpl.java:2810)\n    at jdk.internal.reflect.GeneratedMethodAccessor555.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.invokeJoinpoint(ReflectiveMethodInvocation.java:196)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:163)\n    at org.alfresco.opencmis.CMISTransactionAwareHolderInterceptor.invoke(CMISTransactionAwareHolderInterceptor.java:54)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.repo.transaction.RetryingTransactionInterceptor$1.execute(RetryingTransactionInterceptor.java:95)\n    at org.alfresco.repo.transaction.RetryingTransactionHelper.doInTransaction(RetryingTransactionHelper.java:452)\n    at org.alfresco.repo.transaction.RetryingTransactionInterceptor.invoke(RetryingTransactionInterceptor.java:85)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.opencmis.AlfrescoCmisStreamInterceptor.invoke(AlfrescoCmisStreamInterceptor.java:96)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.opencmis.AlfrescoCmisServiceInterceptor.invoke(AlfrescoCmisServiceInterceptor.java:108)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.alfresco.opencmis.AlfrescoCmisExceptionInterceptor.invoke(AlfrescoCmisExceptionInterceptor.java:90)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy373.getObjectInfo(Unknown Source)\n    at lib3party.org.apache.chemistry.opencmis.server.support.wrapper.AbstractCmisServiceWrapper.getObjectInfo(AbstractCmisServiceWrapper.java:478)\n    at org.apache.chemistry.opencmis.server.impl.atompub.ObjectService$UpdateProperties.serve(ObjectService.java:750)\n    at org.apache.chemistry.opencmis.server.shared.Dispatcher.dispatch(Dispatcher.java:92)\n    at org.apache.chemistry.opencmis.server.impl.atompub.CmisAtomPubServlet.dispatch(CmisAtomPubServlet.java:295)\n    at org.apache.chemistry.opencmis.server.impl.atompub.CmisAtomPubServlet.service(CmisAtomPubServlet.java:206)\n    at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)\n    at org.alfresco.opencmis.CMISServletDispatcher.execute(CMISServletDispatcher.java:238)\n    at org.alfresco.opencmis.CMISWebScript.execute(CMISWebScript.java:58)\n    at org.alfresco.repo.web.scripts.RepositoryContainer.transactionedExecute(RepositoryContainer.java:506)\n    at org.alfresco.repo.web.scripts.RepositoryContainer.transactionedExecuteAs(RepositoryContainer.java:685)\n    at org.alfresco.repo.web.scripts.RepositoryContainer.transactionedExecuteAs(RepositoryContainer.java:721)\n    at org.alfresco.repo.web.scripts.RepositoryContainer.executeScriptInternal(RepositoryContainer.java:413)\n    at org.alfresco.repo.web.scripts.RepositoryContainer.executeScript(RepositoryContainer.java:309)\n    at org.alfresco.rest.api.PublicApiRepositoryContainer.access$001(PublicApiRepositoryContainer.java:47)\n    at org.alfresco.rest.api.PublicApiRepositoryContainer$1.doWork(PublicApiRepositoryContainer.java:84)\n    at org.alfresco.repo.tenant.TenantUtil.runAsWork(TenantUtil.java:126)\n    at org.alfresco.repo.tenant.TenantUtil.runAsTenant(TenantUtil.java:95)\n    at org.alfresco.rest.api.PublicApiRepositoryContainer.executeScript(PublicApiRepositoryContainer.java:80)\n    at org.springframework.extensions.webscripts.AbstractRuntime.executeScript(AbstractRuntime.java:423)\n    at org.springframework.extensions.webscripts.AbstractRuntime.executeScript(AbstractRuntime.java:210)\n    at org.alfresco.repo.web.scripts.TenantWebScriptServlet.service(TenantWebScriptServlet.java:82)\n    at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:658)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:195)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:51)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.extensions.webscripts.servlet.SecurityHeadersFilter.doFilter(SecurityHeadersFilter.java:177)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.alfresco.repo.web.filter.beans.NullFilter.doFilter(NullFilter.java:75)\n    at jdk.internal.reflect.GeneratedMethodAccessor532.invoke(Unknown Source)\n    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.base/java.lang.reflect.Method.invoke(Method.java:569)\n    at org.alfresco.repo.management.subsystems.ChainingSubsystemProxyFactory$1.invoke(ChainingSubsystemProxyFactory.java:132)\n    at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n    at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223)\n    at jdk.proxy2/jdk.proxy2.$Proxy164.doFilter(Unknown Source)\n    at org.alfresco.repo.web.filter.beans.BeanProxyFilter.doFilter(BeanProxyFilter.java:89)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.alfresco.web.app.servlet.GlobalLocalizationFilter.doFilter(GlobalLocalizationFilter.java:68)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.alfresco.web.app.servlet.ClearSecurityContextFilter.doFilter(ClearSecurityContextFilter.java:53)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167)\n    at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)\n    at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483)\n    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:116)\n    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\n    at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:666)\n    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\n    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)\n    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:398)\n    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\n    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:903)\n    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1740)\n    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n    at java.base/java.lang.Thread.run(Thread.java:840)\n</code></pre>\n<p>If I run with a single thread or 2 threads MAX, there are no errors. Anything more than that and I get random errors. Sometimes just couple of documents, sometime dozens. I've tried following so far:</p>\n<ol>\n<li>Upgrading MariaDB to 10.6</li>\n<li>Upgrading CMIS client to the latest version (Apache Chemistry CMIS)</li>\n<li>Trying both MariaDB and MySQL JDBC driver</li>\n</ol>\n<p>None of these helped. If I move away from CMIS and call custom webscript that I have in place in charge of document update, the problem goes away. Unfortunately, CMIS is still heavily being used in my system so I have to figure this problem out before I can fully proceed with upgrade.</p>\n",
    "tags" : [ "java", "alfresco", "cmis", "alfresco-content-repository" ],
    "owner" : {
      "account_id" : 1292806,
      "reputation" : 197,
      "user_id" : 1244555,
      "user_type" : "registered",
      "accept_rate" : 54,
      "profile_image" : "https://www.gravatar.com/avatar/b8d29dac9c82d7a3d26f733c32590046?s=256&d=identicon&r=PG",
      "display_name" : "dodjavola",
      "link" : "https://stackoverflow.com/users/1244555/dodjavola"
    },
    "is_answered" : false,
    "view_count" : 69,
    "closed_date" : 1759897162,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1747397708,
    "creation_date" : 1747172191,
    "link" : "https://stackoverflow.com/questions/79620457/alfresco-content-services-getting-node-does-not-exist-when-creating-new-versi",
    "closed_reason" : "Not suitable for this site"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140523682,
    "post_id" : 79620457,
    "body" : "I had similar issues on upload after migrating to 7.4. My issue was with Deadlocks (DeadlockLoserDataAccessException which rolled back the transaction). Finally we migrated the repo db from mysql/mariadb to postgres which fixed the issue for us.",
    "score" : 0,
    "owner" : {
      "account_id" : 2138996,
      "reputation" : 2777,
      "user_id" : 1898538,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8042f6d3f323861fd329fd6a043b3828?s=256&d=identicon&r=PG",
      "display_name" : "Heiko Robert",
      "link" : "https://stackoverflow.com/users/1898538/heiko-robert"
    },
    "creation_date" : 1750250696,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}