{
  "question" : {
    "question_id" : 79843872,
    "title" : "Adding a new HandlerInterceptor causes many existing tests to fail — how to fix or isolate it?",
    "body" : "<p>I have a large Spring Boot application with an extensive test suite (unit tests + controller tests).</p>\n<p>After introducing a new <code>HandlerInterceptor</code>, many of my previously passing tests started failing. Most of these tests were not written with interceptors in mind, and now the interceptor’s logic is being executed for almost every request inside the tests.</p>\n<p>I'm looking for guidance on how to fix or isolate the interceptor for tests, and what the recommended approach is:</p>\n<ul>\n<li><p>Should I disable the interceptor in certain tests?</p>\n</li>\n<li><p>Should I mock the service the interceptor depends on?</p>\n</li>\n<li><p>Should I update every test to account for the interceptor?</p>\n</li>\n<li><p>Is there a way to automatically exclude it in MockMvc/WebMvcTest setups?</p>\n</li>\n</ul>\n<p>Below is a simplified example of the configuration and interceptor. (Names changed.)</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\n@RequiredArgsConstructor\npublic class DemoPathConfig implements WebMvcConfigurer {\n\n    private final DemoAccessInterceptor demoAccessInterceptor;\n\n    @Override\n    public void addInterceptors(InterceptorRegistry registry) {\n        registry.addInterceptor(demoAccessInterceptor)\n                .addPathPatterns(&quot;/api/internal/**&quot;);\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\n@RequiredArgsConstructor\n@Slf4j\npublic class DemoAccessInterceptor implements HandlerInterceptor {\n\n    private final DemoCheckService demoCheckService;\n\n    @Override\n    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) {\n        if (HttpMethod.OPTIONS.matches(request.getMethod())) {\n            return true;\n        }\n\n        demoCheckService.validateAccess();\n        return true;\n    }\n}\n</code></pre>\n<p>What is the best way to handle the sudden test failures after adding an interceptor?**</p>\n<p>I'm especially interested in strategies used in large code bases, such as disabling interceptors globally for tests, conditional registration, or MockMvc/WebMvcTest configuration tricks.</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "mockito" ],
    "owner" : {
      "account_id" : 22577442,
      "reputation" : 1127,
      "user_id" : 16775102,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VZtyD.jpg?s=256",
      "display_name" : "Feel free",
      "link" : "https://stackoverflow.com/users/16775102/feel-free"
    },
    "is_answered" : true,
    "view_count" : 77,
    "closed_date" : 1765625828,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1765625812,
    "creation_date" : 1765449961,
    "link" : "https://stackoverflow.com/questions/79843872/adding-a-new-handlerinterceptor-causes-many-existing-tests-to-fail-how-to-fix",
    "closed_reason" : "Opinion-based"
  },
  "answers" : [ {
    "answer_id" : 79844478,
    "question_id" : 79843872,
    "body" : "<p>I guess, you're talking mainly about spring-driven tests (for simple unit tests, you probably don't load this interceptor anyway).</p>\n<p>In this case, your options are:</p>\n<ol>\n<li><p>Don't load this interceptor in tests</p>\n</li>\n<li><p>Rewrite the tests that will work with this new code</p>\n</li>\n</ol>\n<p>I believe you're into option 1.</p>\n<p>Consider conditionally excluding the interceptor in the configuration:</p>\n<pre><code>@ConditionalOnProprety(name='security.enabled', havingValue=&quot;true&quot;, matchIfMissing = false)\n// Configuration that load WebMvcConfigurer goes here\n</code></pre>\n<p>Then, in tests, configure it to be &quot;false&quot; (I assume there is some configuration file for tests), and it won't be loaded at all.</p>\n",
    "score" : -1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 298886,
      "reputation" : 42992,
      "user_id" : 605153,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/771f1c4e90ceeec0060c62ff0dbb762e?s=256&d=identicon&r=PG",
      "display_name" : "Mark Bramnik",
      "link" : "https://stackoverflow.com/users/605153/mark-bramnik"
    },
    "creation_date" : 1765501404,
    "last_activity_date" : 1765501404,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140898243,
    "post_id" : 79843872,
    "body" : "Do you <i>really</i> need to &quot;update every test&quot; ? In general, there is some kind of shared setup method to set common headers and such. If you don&#39;t have something like that, your problem is more in the area of code maintainability I&#39;d say.",
    "score" : 0,
    "owner" : {
      "account_id" : 187094,
      "reputation" : 5301,
      "user_id" : 424903,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
      "display_name" : "Gimby",
      "link" : "https://stackoverflow.com/users/424903/gimby"
    },
    "creation_date" : 1765465678,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140898072,
    "post_id" : 79843872,
    "body" : "I already explained what to do. Don&#39;t modify your configuration because your tests fail that is the wrong solution (unless it is a unit test but then you shouldn&#39;t be using the interceptors at all, the fact that those are in use means it is an Integration test and thus should be as close to your real configuration as possible).",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1765459284,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140898056,
    "post_id" : 79843872,
    "body" : "I am not finding it weird. Its expected that all my tests with api calls( 200 of them ) are failed. But i would like to know what is the best way to fix it. DO i need to go in every tests and put doNothing() or do i need to put condition on interceptor and so on. I am seeking for cleaniest solution",
    "score" : 0,
    "owner" : {
      "account_id" : 22577442,
      "reputation" : 1127,
      "user_id" : 16775102,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VZtyD.jpg?s=256",
      "display_name" : "Feel free",
      "link" : "https://stackoverflow.com/users/16775102/feel-free"
    },
    "creation_date" : 1765458867,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140898026,
    "post_id" : 79843872,
    "body" : "Judging from what this interceptor is doing you added security and now find it weird that your tests are failing. Mock the <code>DemoCheckService</code> so that it returns <code>true</code> or doesn&#39;t throw an exception or whatever for your tests.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1765457820,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}