{
  "question" : {
    "question_id" : 79802242,
    "title" : "KafkaAvroSerializer UnresolvedUnionException with nullable timestamp-millis field",
    "body" : "<p>I'm using confluent's KafkaAvroSerializer with a schema that includes a nullable timestamp-millis field. The field maps to <code>Instant</code> in Java, but when I send a non-null I get an UnresolvedUnionException.  Why is the Instant not resolving properly. Here is the relevant part of my Avro schema:</p>\n<pre class=\"lang-none prettyprint-override\"><code>       {\n            &quot;name&quot;: &quot;source_created_ts&quot;,\n            &quot;doc&quot;: &quot;The created TS of the record.&quot;,\n            &quot;type&quot;: {\n                &quot;type&quot;: &quot;long&quot;,\n                &quot;logicalType&quot;: &quot;timestamp-millis&quot;\n            }\n        },\n        {\n            &quot;name&quot;: &quot;source_deleted_ts&quot;,\n            &quot;doc&quot;: &quot;The deleted TS of the record.&quot;,\n            &quot;type&quot;: [\n                &quot;null&quot;,\n                {\n                    &quot;type&quot;: &quot;long&quot;,\n                    &quot;logicalType&quot;: &quot;timestamp-millis&quot;\n                }\n            ]\n        },\n</code></pre>\n<p>I am using the avro-maven-plugin to generate Java classes and the fields both get mapped to java.time.Instant.\nHere is an example of how I am producing records</p>\n<pre class=\"lang-java prettyprint-override\"><code>Properties props = new Properties();\n        props.setProperty(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, &quot;io.confluent.kafka.serializers.KafkaAvroSerializer&quot;);\n        props.setProperty(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, &quot;io.confluent.kafka.serializers.KafkaAvroSerializer&quot;);\n        props.setProperty(&quot;specific.avro.reader&quot;, &quot;true&quot;);\n        props.setProperty(KafkaAvroSerializerConfig.AUTO_REGISTER_SCHEMAS, &quot;false&quot;);\n        props.setProperty(KafkaAvroSerializerConfig.USE_LATEST_VERSION, &quot;true&quot;);\n        props.setProperty(&quot;schema.registry.rules.enabled&quot;, &quot;true&quot;);\n        props.setProperty(KafkaAvroSerializerConfig.RULE_EXECUTORS, &quot;CEL&quot;);\n        KafkaProducer producer = new KafkaProducer&lt;&gt;(props);\n\n        TestValue value = new TestValue();\n        value.setSourceCreatedTs(Instant.parse(&quot;2023-05-15T14:10:00Z&quot;));\n        value.setSourceDeletedTs(null);\n        producer.send(new ProducerRecord&lt;&gt;(&quot;test-topic&quot;, key, value)).get();\n\n        value = new TestValue();\n        value.setSourceCreatedTs(Instant.parse(&quot;2023-05-15T14:10:00Z&quot;));\n        value.setSourceDeletedTs(Instant.parse(&quot;2025-10-08T09:46:00Z&quot;));\n        producer.send(new ProducerRecord&lt;&gt;(&quot;test-topic&quot;, key, value)).get();\n</code></pre>\n<p>The first record works properly, but when I send the second record with the non-null timestamp it appears to send not as a long and I get this not in union error:</p>\n<pre><code>Caused by: org.apache.avro.UnresolvedUnionException: Not in union [&quot;null&quot;,{&quot;type&quot;:&quot;long&quot;,&quot;logicalType&quot;:&quot;timestamp-millis&quot;}]: 2025-10-08T09:46:00Z\n    at org.apache.avro.generic.GenericData.resolveUnion(GenericData.java:910)\n    at io.confluent.kafka.schemaregistry.avro.AvroSchema.toTransformedMessage(AvroSchema.java:555)\n    at io.confluent.kafka.schemaregistry.avro.AvroSchema.toTransformedMessage(AvroSchema.java:589)\n    at io.confluent.kafka.schemaregistry.avro.AvroSchema.transformMessage(AvroSchema.java:531)\n    at io.confluent.kafka.schemaregistry.rules.FieldRuleExecutor.transform(FieldRuleExecutor.java:102)\n    at io.confluent.kafka.serializers.AbstractKafkaSchemaSerDe.executeRules(AbstractKafkaSchemaSerDe.java:708)\n    at io.confluent.kafka.serializers.AbstractKafkaSchemaSerDe.executeRules(AbstractKafkaSchemaSerDe.java:654)\n    at io.confluent.kafka.serializers.AbstractKafkaAvroSerializer.serializeImpl(AbstractKafkaAvroSerializer.java:144)\n    ... 5 more\n</code></pre>\n<p>Here are the kafka/confluent dependencies:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>      &lt;dependency&gt;\n        &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n        &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;\n        &lt;version&gt;7.6.2-ccs&lt;/version&gt;\n      &lt;/dependency&gt;\n        \n      &lt;dependency&gt;\n        &lt;groupId&gt;io.confluent&lt;/groupId&gt;\n        &lt;artifactId&gt;kafka-avro-serializer&lt;/artifactId&gt;\n        &lt;version&gt;7.6.2&lt;/version&gt;\n      &lt;/dependency&gt;\n\n      &lt;dependency&gt;\n      &lt;groupId&gt;io.confluent&lt;/groupId&gt;\n      &lt;artifactId&gt;kafka-schema-rules&lt;/artifactId&gt;\n      &lt;version&gt;7.6.2&lt;/version&gt;\n    &lt;/dependency&gt;\n    \n      &lt;dependency&gt;\n        &lt;groupId&gt;org.apache.avro&lt;/groupId&gt;\n        &lt;artifactId&gt;avro&lt;/artifactId&gt;\n        &lt;version&gt;1.11.3&lt;/version&gt;\n      &lt;/dependency&gt;\n</code></pre>\n<p>I have seen similar questions using Apache Spark but as we are not using that the solutions have not worked for my situation.  I expect the serializer to handle Instant correctly, and it does for a non-nullable field but when I have the null union field it does not recognize the type it should send.  Why is Instant not resolving correctly in the union?</p>\n",
    "tags" : [ "java", "serialization", "apache-kafka", "avro" ],
    "owner" : {
      "account_id" : 44465316,
      "reputation" : 1,
      "user_id" : 31766666,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/029a5fc45a6de6e361fba7e0dd143777?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "John Leon",
      "link" : "https://stackoverflow.com/users/31766666/john-leon"
    },
    "is_answered" : false,
    "view_count" : 43,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1761670010,
    "creation_date" : 1761598578,
    "link" : "https://stackoverflow.com/questions/79802242/kafkaavroserializer-unresolvedunionexception-with-nullable-timestamp-millis-fiel",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79803075,
    "question_id" : 79802242,
    "body" : "<p>This was solved by upgrading all of the kafka dependencies.  It required me to add a few more in order to get the CEL executor to work properly on the newer version.  Here is what my pom looked like in the end:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependency&gt;\n        &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n        &lt;artifactId&gt;kafka-clients&lt;/artifactId&gt;\n        &lt;version&gt;8.1.0-ccs&lt;/version&gt;\n      &lt;/dependency&gt;\n        \n      &lt;dependency&gt;\n        &lt;groupId&gt;io.confluent&lt;/groupId&gt;\n        &lt;artifactId&gt;kafka-avro-serializer&lt;/artifactId&gt;\n        &lt;version&gt;8.1.0&lt;/version&gt;\n      &lt;/dependency&gt;\n\n      &lt;dependency&gt;\n      &lt;groupId&gt;io.confluent&lt;/groupId&gt;\n      &lt;artifactId&gt;kafka-schema-rules&lt;/artifactId&gt;\n      &lt;version&gt;8.1.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    \n      &lt;dependency&gt;\n        &lt;groupId&gt;org.apache.avro&lt;/groupId&gt;\n        &lt;artifactId&gt;avro&lt;/artifactId&gt;\n        &lt;version&gt;1.12.1&lt;/version&gt;\n      &lt;/dependency&gt;\n\n      &lt;dependency&gt;\n        &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;\n        &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;\n        &lt;version&gt;4.28.3&lt;/version&gt;\n      &lt;/dependency&gt;\n\n      &lt;dependency&gt;\n        &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;\n        &lt;artifactId&gt;protobuf-java-util&lt;/artifactId&gt;\n        &lt;version&gt;4.28.3&lt;/version&gt;\n      &lt;/dependency&gt;\n\n      &lt;dependency&gt;\n        &lt;groupId&gt;com.google.api.grpc&lt;/groupId&gt;\n        &lt;artifactId&gt;proto-google-common-protos&lt;/artifactId&gt;\n        &lt;version&gt;2.20.0&lt;/version&gt;\n      &lt;/dependency&gt;\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 44465316,
      "reputation" : 1,
      "user_id" : 31766666,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/029a5fc45a6de6e361fba7e0dd143777?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "John Leon",
      "link" : "https://stackoverflow.com/users/31766666/john-leon"
    },
    "creation_date" : 1761670010,
    "last_activity_date" : 1761670010,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140821982,
    "post_id" : 79802242,
    "body" : "I found a github issue on confluent discussing the exact same issue. Seems that it is an unfixed issue and you will likely need to revert to 7.5.0 for the serializer <a href=\"https://github.com/confluentinc/schema-registry/issues/1604\" rel=\"nofollow noreferrer\">github.com/confluentinc/schema-registry/issues/1604</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 21724606,
      "reputation" : 1441,
      "user_id" : 16034206,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/MRBdT.jpg?s=256",
      "display_name" : "pebble unit",
      "link" : "https://stackoverflow.com/users/16034206/pebble-unit"
    },
    "creation_date" : 1761636997,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}