{
  "question" : {
    "question_id" : 79810464,
    "title" : "Migrate Elasticsearch code to OpenSearch multi request search",
    "body" : "<p>I have this code:</p>\n<pre><code>import org.elasticsearch.ElasticsearchException;\nimport org.elasticsearch.action.ActionListener;\nimport org.elasticsearch.action.DocWriteResponse.Result;\nimport org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\nimport org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\nimport org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\nimport org.elasticsearch.action.bulk.BackoffPolicy;\nimport org.elasticsearch.action.bulk.BulkItemResponse;\nimport org.elasticsearch.action.bulk.BulkRequestBuilder;\nimport org.elasticsearch.action.bulk.BulkResponse;\nimport org.elasticsearch.action.bulk.Retry;\nimport org.elasticsearch.action.delete.DeleteResponse;\nimport org.elasticsearch.action.get.GetResponse;\nimport org.elasticsearch.action.get.MultiGetItemResponse;\nimport org.elasticsearch.action.get.MultiGetRequestBuilder;\nimport org.elasticsearch.action.get.MultiGetResponse;\nimport org.elasticsearch.action.index.IndexRequest;\nimport org.elasticsearch.action.index.IndexRequestBuilder;\nimport org.elasticsearch.action.index.IndexResponse;\nimport org.elasticsearch.action.search.ClearScrollRequest;\nimport org.elasticsearch.action.search.ClearScrollResponse;\nimport org.elasticsearch.action.search.MultiSearchRequestBuilder;\nimport org.elasticsearch.action.search.MultiSearchResponse;\nimport org.elasticsearch.action.search.SearchRequestBuilder;\nimport org.elasticsearch.action.search.SearchResponse;\nimport org.elasticsearch.action.search.SearchScrollRequestBuilder;\nimport org.elasticsearch.action.support.master.AcknowledgedResponse;\nimport org.elasticsearch.action.update.UpdateRequest;\nimport org.elasticsearch.action.update.UpdateResponse;\nimport org.elasticsearch.client.transport.TransportClient;\nimport org.elasticsearch.common.settings.Settings;\nimport org.elasticsearch.common.transport.InetSocketTransportAddress;\nimport org.elasticsearch.common.unit.TimeValue;\nimport org.elasticsearch.index.engine.DocumentMissingException;\nimport org.elasticsearch.index.reindex.BulkByScrollResponse;\nimport org.elasticsearch.index.reindex.DeleteByQueryAction;\nimport org.elasticsearch.index.reindex.DeleteByQueryRequestBuilder;\nimport org.elasticsearch.script.mustache.SearchTemplateRequestBuilder;\nimport org.elasticsearch.transport.client.PreBuiltTransportClient;\n\nprivate TransportClient client;\n\npublic List&lt;SearchResponse&gt; multiSearch(List&lt;SearchRequestBuilder&gt; requestList) {\n    try {\n      MultiSearchRequestBuilder multiBuilder = client.prepareMultiSearch();\n\n      for (SearchRequestBuilder request : requestList) {\n        multiBuilder.add(request);\n      }\n\n      MultiSearchResponse searchResponse = multiBuilder.execute().actionGet();\n\n      List&lt;SearchResponse&gt; responseList = new ArrayList&lt;&gt;();\n      for (MultiSearchResponse.Item item : searchResponse.getResponses()) {\n        responseList.add(item.getResponse());\n      }\n      return responseList;\n    } catch (Exception exception) {\n      throw new Exception();\n    }\n  }\n\n\n\nimport org.elasticsearch.ElasticsearchException;\nimport org.elasticsearch.action.ActionListener;\nimport org.elasticsearch.action.DocWriteResponse.Result;\nimport org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\nimport org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\nimport org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\nimport org.elasticsearch.action.bulk.BackoffPolicy;\nimport org.elasticsearch.action.bulk.BulkItemResponse;\nimport org.elasticsearch.action.bulk.BulkRequestBuilder;\nimport org.elasticsearch.action.bulk.BulkResponse;\nimport org.elasticsearch.action.bulk.Retry;\nimport org.elasticsearch.action.delete.DeleteResponse;\nimport org.elasticsearch.action.get.GetResponse;\nimport org.elasticsearch.action.get.MultiGetItemResponse;\nimport org.elasticsearch.action.get.MultiGetRequestBuilder;\nimport org.elasticsearch.action.get.MultiGetResponse;\nimport org.elasticsearch.action.index.IndexRequest;\nimport org.elasticsearch.action.index.IndexRequestBuilder;\nimport org.elasticsearch.action.index.IndexResponse;\nimport org.elasticsearch.action.search.ClearScrollRequest;\nimport org.elasticsearch.action.search.ClearScrollResponse;\nimport org.elasticsearch.action.search.MultiSearchRequestBuilder;\nimport org.elasticsearch.action.search.MultiSearchResponse;\nimport org.elasticsearch.action.search.SearchRequestBuilder;\nimport org.elasticsearch.action.search.SearchResponse;\nimport org.elasticsearch.action.search.SearchScrollRequestBuilder;\nimport org.elasticsearch.action.support.master.AcknowledgedResponse;\nimport org.elasticsearch.action.update.UpdateRequest;\nimport org.elasticsearch.action.update.UpdateResponse;\nimport org.elasticsearch.client.transport.TransportClient;\nimport org.elasticsearch.common.settings.Settings;\nimport org.elasticsearch.common.transport.InetSocketTransportAddress;\nimport org.elasticsearch.common.unit.TimeValue;\nimport org.elasticsearch.index.engine.DocumentMissingException;\nimport org.elasticsearch.index.reindex.BulkByScrollResponse;\nimport org.elasticsearch.index.reindex.DeleteByQueryAction;\nimport org.elasticsearch.index.reindex.DeleteByQueryRequestBuilder;\nimport org.elasticsearch.script.mustache.SearchTemplateRequestBuilder;\nimport org.elasticsearch.transport.client.PreBuiltTransportClient;\n\nprivate TransportClient client\n\n\npublic class GroupSearchIndexRepository{\n\npublic SearchTemplateRequestBuilder getSearchTemplateRequestBuilder() {\n    try {\n      return new SearchTemplateRequestBuilder(client);\n    } catch (Exception exception) {\n      LOGGER.error(&quot;Search template request builder not available.&quot;, exception);\n        new Exception(&quot;error&quot;);\n    }\n      return null;\n  }\n\npublic SearchResponse searchScript(Map&lt;String, Object&gt; parameters, String scriptName) {\n        SearchTemplateRequestBuilder searchTemplateRequestBuilder = getSearchTemplateRequestBuilder();\n        SearchTemplateResponse response = searchTemplateRequestBuilder.setScript(scriptName)\n                .setScriptType(ScriptType.STORED).setScriptParams(parameters)\n                .setRequest(new SearchRequest(this.readIndex)).get();\n        return response.getResponse();\n    }\n}\n\npublic class GroupSearchIndexRepository groupSearchIndexRepository\n \n\nprivate JSONObject getGroupFromElastic(Map&lt;String, Object&gt; params, String searchTemplateName) {\n    SearchResponse response = groupSearchIndexRepository.searchScript(params, searchTemplateName);\n\n    if (response.getHits().getTotalHits() &gt; 0) {\n        try {\n            SearchHit hit = response.getHits().getAt(0);\n            String payload = hit.getSourceAsString();\n            return new JSONObject(payload);\n        } catch (Exception e) {\n            logger.info(&quot;exception - elastic response {}&quot;, response);\n            throw e;\n        }\n\n    } else {\n        return null;\n    }\n  }\n</code></pre>\n<p>how to migrate this code to aws opensearch? I can't find a proper replacement.</p>\n",
    "tags" : [ "java", "opensearch", "amazon-opensearch" ],
    "owner" : {
      "account_id" : 965625,
      "reputation" : 1102,
      "user_id" : 1103606,
      "user_type" : "registered",
      "accept_rate" : 51,
      "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
      "display_name" : "Peter Penzov",
      "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
    },
    "is_answered" : true,
    "view_count" : 260,
    "closed_date" : 1763110430,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762877624,
    "creation_date" : 1762367125,
    "link" : "https://stackoverflow.com/questions/79810464/migrate-elasticsearch-code-to-opensearch-multi-request-search",
    "closed_reason" : "Needs more focus"
  },
  "answers" : [ {
    "answer_id" : 79816874,
    "question_id" : 79810464,
    "body" : "<p>According to official documentation TransportClient was removed after Elasticsearch 7.x and isn't supported by AWS OpenSearch.\nThe replacement is the OpenSearch Java Client (org.opensearch.client:opensearch-java), which is the official client published by the OpenSearch\nYou can migrate your existing logic like this:</p>\n<pre><code>import org.opensearch.client.RestClient;\nimport org.opensearch.client.opensearch.OpenSearchClient;\nimport org.opensearch.client.transport.rest_client.RestClientTransport;\nimport org.opensearch.client.json.jackson.JacksonJsonpMapper;\nimport org.opensearch.client.opensearch.core.*;\nimport org.opensearch.client.opensearch.core.msearch.*;\nimport org.apache.http.HttpHost;\nimport org.json.JSONObject;\nimport java.io.IOException;\nimport java.util.*;\n\n\npublic class GroupSearchIndexRepository {\n\n    private final OpenSearchClient client;\n\n    public GroupSearchIndexRepository() {\n        // here is a basic REST setup\n        RestClient restClient = RestClient.builder(\n                        new HttpHost(&quot;your-opensearch-domain&quot;, 443, &quot;https&quot;))\n                .build();\n\n        //must create OpenSearch java client (new REST style, not Transport)\n        this.client = new OpenSearchClient(\n                new RestClientTransport(restClient, new JacksonJsonpMapper()));\n    }\n\n    //the same idea as old multiSearch, just new API calls\n    public List&lt;SearchResponse&lt;Map&lt;String, Object&gt;&gt;&gt; multiSearch(List&lt;SearchRequest&gt; requests) throws IOException {\n        MsearchRequest.Builder builder = new MsearchRequest.Builder();\n        for (SearchRequest req : requests) {\n            // add each single search into the multi request\n            builder.searches(s -&gt; s.header(h -&gt; h.index(req.index()))\n                    .body(req.query()));\n        }\n\n        //multi search excution\n        MsearchResponse&lt;Map&lt;String, Object&gt;&gt; response = client.msearch(builder.build(), Map.class);\n\n        // collect all results back\n        List&lt;SearchResponse&lt;Map&lt;String, Object&gt;&gt;&gt; results = new ArrayList&lt;&gt;();\n        for (MultiSearchResponseItem&lt;Map&lt;String, Object&gt;&gt; item : response.responses()) {\n            if (item.result() != null) results.add(item.result());\n        }\n        return results;\n    }\n\n    //stored script\n    public SearchResponse&lt;Map&lt;String, Object&gt;&gt; searchScript(\n            String index, String scriptId, Map&lt;String, Object&gt; params) throws IOException {\n\n        //build and execute search template\n        SearchTemplateRequest request = new SearchTemplateRequest.Builder()\n                .id(scriptId)\n                .params(params)\n                .build();\n\n        return client.searchTemplate(request, Map.class);\n    }\n\n    // retrieve first hit as JSONObject\n    public JSONObject getGroupFromElastic(String index, String scriptId, Map&lt;String, Object&gt; params) throws IOException {\n        var response = searchScript(index, scriptId, params);\n        if (response.hits().total() != null &amp;&amp; response.hits().total().value() &gt; 0) {\n            var hit = response.hits().hits().get(0);\n            return new JSONObject(hit.source());\n        }\n        return null;\n    }\n}\n\n\n</code></pre>\n<p><code>TransportClient </code>is long gone after <code>Elasticsearch7</code>, and OpenSearch never shipped with it.\nThe new OpenSearchClient is the official, a REST based replacement, it talk directly to the same HTTP endpoints and works fine with AWS OpenSearch Service.\nThe migration can feel a bit noisy at first, but it's the right move if you want your code to stay compatible going forward...</p>\n<p>See the official OpenSearch Java Client docs : <a href=\"https://github.com/opensearch-project/opensearch-java\" rel=\"nofollow noreferrer\">the GitHub repository</a>\n, and <a href=\"https://github.com/opensearch-project/opensearch-java/blob/main/COMPATIBILITY.md\" rel=\"nofollow noreferrer\">the compatibility matrix</a>\nfor exact version details.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 12972904,
      "reputation" : 762,
      "user_id" : 9377995,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Hl13jffO.png?s=256",
      "display_name" : "gdoura mohamed",
      "link" : "https://stackoverflow.com/users/9377995/gdoura-mohamed"
    },
    "creation_date" : 1762877624,
    "last_activity_date" : 1762877624,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140846342,
    "post_id" : 79810464,
    "body" : "Can you give me a code sample with OpenSearch Java Client?",
    "score" : 0,
    "owner" : {
      "account_id" : 965625,
      "reputation" : 1102,
      "user_id" : 1103606,
      "user_type" : "registered",
      "accept_rate" : 51,
      "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
      "display_name" : "Peter Penzov",
      "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
    },
    "creation_date" : 1762763469,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846310,
    "post_id" : 79810464,
    "body" : "Your code is built around the old Elasticsearch TransportClient, which was deprecated after Elasticsearch 7.x and removed entirely in OpenSearch and Elasticsearch 8+.  AWS OpenSearch (which is forked from Elasticsearch 7.10) uses the REST client not the TransportClient. So youâ€™ll need to migrate to the Java REST High-Level Client or OpenSearch Java Client.",
    "score" : 0,
    "owner" : {
      "account_id" : 39747302,
      "reputation" : 1,
      "user_id" : 29430839,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/JfIrGDS2.jpg?s=256",
      "display_name" : "Omprakash S",
      "link" : "https://stackoverflow.com/users/29430839/omprakash-s"
    },
    "creation_date" : 1762762600,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}