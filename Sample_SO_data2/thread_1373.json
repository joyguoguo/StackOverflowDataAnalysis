{
  "question" : {
    "question_id" : 79717475,
    "title" : "Logstash Logback encoder unable to parse Spring WebClientResponseException due to cycle",
    "body" : "<p>I have some code making a remote call</p>\n<pre><code>        try {\n            containerApi(tenant).updateContainerStorageUri(\n                    tenant,\n                    containerId,\n                    updateContainerRequest).block();\n        } catch (RuntimeException e) {\n            log.error(&quot;Exception while updating storageURI for container&quot;,\n                    v(StructuredLoggingFields.TENANT_ID, tenant),\n                    v(StructuredLoggingFields.CONTAINER_ID, containerId),\n                    v(StructuredLoggingFields.EXCEPTION_MESSAGE, e.getMessage()),\n                    v(StructuredLoggingFields.EXCEPTION, e));\n            throw e;\n        }\n</code></pre>\n<p>When an error occurs logstack logback encoder reports the following</p>\n<pre><code>signal-offloader-84b96dbb4c-6cgbd signal-offloader 15:34:54,345 |-WARN in \nnet.logstash.logback.encoder.LoggingEventCompositeJsonEncoder@59febcf9 - \nError encountered while encoding log event. Event: [ERROR] Exception while \nupdating storageURI for container com.fasterxml.jackson.databind.exc.InvalidDefinitionException: \nDirect self-reference leading to cycle (through reference chain: org.springframework.web.reactive\n.function.client.WebClientResponseException$Conflict[&quot;mostSpecificCause&quot;])\n</code></pre>\n<p>Per the logstash folks for a similar issue:</p>\n<pre><code>As far as I can tell, the problem is caused by Jackson that complains about a cycle in the object graph to serialise. . . . \n\nThis likely comes from an object you added to the log via the \nStructuredArguments feature. There is unfortunately not much \nlogstash-logback-encoder can do about it... You should definitely \nlook at what solution Jackson has to offer to work around this situation.\n</code></pre>\n<p><a href=\"https://github.com/logfellow/logstash-logback-encoder/discussions/710\" rel=\"nofollow noreferrer\">https://github.com/logfellow/logstash-logback-encoder/discussions/710</a></p>\n<p>It's probably the logging of the Exception (or maybe it's the <code>getMessage()</code>).</p>\n<p>This is my logback configuration</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;configuration&gt;\n    &lt;contextName&gt;Offloader&lt;/contextName&gt;\n    &lt;appender name=&quot;CONSOLE&quot; class=&quot;ch.qos.logback.core.ConsoleAppender&quot;&gt;\n        &lt;encoder class=&quot;net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder&quot;&gt;\n            &lt;providers&gt;\n                &lt;contextName&gt;\n                    &lt;fieldName&gt;app&lt;/fieldName&gt;\n                &lt;/contextName&gt;\n                &lt;timestamp&gt;\n                    &lt;fieldName&gt;ts&lt;/fieldName&gt;\n                    &lt;timeZone&gt;UTC&lt;/timeZone&gt;\n                &lt;/timestamp&gt;\n                &lt;logLevel&gt;\n                    &lt;fieldName&gt;level&lt;/fieldName&gt;\n                &lt;/logLevel&gt;\n                &lt;callerData&gt;\n                    &lt;classFieldName&gt;class&lt;/classFieldName&gt;\n                    &lt;methodFieldName&gt;method&lt;/methodFieldName&gt;\n                    &lt;lineFieldName&gt;line&lt;/lineFieldName&gt;\n                &lt;/callerData&gt;\n                &lt;threadName&gt;\n                    &lt;fieldName&gt;thread&lt;/fieldName&gt;\n                &lt;/threadName&gt;\n                &lt;mdc/&gt;\n                &lt;arguments&gt;\n                    &lt;includeNonStructuredArguments&gt;false&lt;/includeNonStructuredArguments&gt;\n                &lt;/arguments&gt;\n                &lt;stackTrace&gt;\n                    &lt;throwableConverter class=&quot;net.logstash.logback.stacktrace.ShortenedThrowableConverter&quot;&gt;\n                        &lt;lineSeparator&gt;,&lt;/lineSeparator&gt;\n                    &lt;/throwableConverter&gt;\n                    &lt;fieldName&gt;stack&lt;/fieldName&gt;\n                &lt;/stackTrace&gt;\n                &lt;message&gt;\n                    &lt;fieldName&gt;msg&lt;/fieldName&gt;\n                &lt;/message&gt;\n            &lt;/providers&gt;\n        &lt;/encoder&gt;\n    &lt;/appender&gt;\n    &lt;root level=&quot;INFO&quot;&gt;\n        &lt;appender-ref ref=&quot;CONSOLE&quot;/&gt;\n    &lt;/root&gt;\n&lt;/configuration&gt;\n</code></pre>\n<p>NOTE: I don't see this occurring before my upgrade to Spring Boot 3.5.0</p>\n<p>Appreciate any insights, workarounds or fixes. Thanks!</p>\n<p>UPDATE: I only now just learned</p>\n<pre><code>Do NOT use structured arguments or markers for exceptions.\n</code></pre>\n<p><a href=\"https://github.com/logfellow/logstash-logback-encoder?tab=readme-ov-file#customizing-stack-traces\" rel=\"nofollow noreferrer\">https://github.com/logfellow/logstash-logback-encoder?tab=readme-ov-file#customizing-stack-traces</a></p>\n",
    "tags" : [ "java", "spring", "jackson", "spring-logback", "logstash-logback-encoder" ],
    "owner" : {
      "account_id" : 103429,
      "reputation" : 7070,
      "user_id" : 277023,
      "user_type" : "registered",
      "accept_rate" : 56,
      "profile_image" : "https://i.sstatic.net/o2cv8.png?s=256",
      "display_name" : "kellyfj",
      "link" : "https://stackoverflow.com/users/277023/kellyfj"
    },
    "is_answered" : true,
    "view_count" : 122,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1753796378,
    "creation_date" : 1753713045,
    "link" : "https://stackoverflow.com/questions/79717475/logstash-logback-encoder-unable-to-parse-spring-webclientresponseexception-due-t",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79718277,
    "question_id" : 79717475,
    "body" : "<p>I think that is this line that cause error :</p>\n<pre><code> v(StructuredLoggingFields.EXCEPTION, e)\n</code></pre>\n<p>Exception may have cycle with nestedException.</p>\n<p>So Jackson can't parse un cycle in Json.</p>\n<p>But what is v() function ? Arguments need to be remplacement in message string and last is a throwable object.</p>\n<p>For what I understand, you may use MDC <a href=\"https://logback.qos.ch/manual/mdc.html\" rel=\"nofollow noreferrer\">https://logback.qos.ch/manual/mdc.html</a>.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 4739993,
      "reputation" : 2062,
      "user_id" : 3833111,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/kL1Bd.png?s=256",
      "display_name" : "Mr_Thorynque",
      "link" : "https://stackoverflow.com/users/3833111/mr-thorynque"
    },
    "creation_date" : 1753775493,
    "last_activity_date" : 1753775493,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79718277" : [ {
      "comment_id" : 140626967,
      "post_id" : 79718277,
      "body" : "Thanks the <code>v()</code> function is the following static method <a href=\"https://javadoc.io/static/net.logstash.logback/logstash-logback-encoder/5.1/index.html?net/logstash/logback/argument/StructuredArguments.html\" rel=\"nofollow noreferrer\">javadoc.io/static/net.logstash.logback/logstash-logback-enco&zwnj;&#8203;der/&hellip;</a>",
      "score" : 1,
      "owner" : {
        "account_id" : 103429,
        "reputation" : 7070,
        "user_id" : 277023,
        "user_type" : "registered",
        "accept_rate" : 56,
        "profile_image" : "https://i.sstatic.net/o2cv8.png?s=256",
        "display_name" : "kellyfj",
        "link" : "https://stackoverflow.com/users/277023/kellyfj"
      },
      "creation_date" : 1753796450,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}