{
  "question" : {
    "question_id" : 79750492,
    "title" : "Cannot resolve method &#39;setDefaultSocketFactory&#39; in &#39;PoolingHttpClientConnectionManager&#39;",
    "body" : "<p>I have to migrate this httpclient 4 code to httpclient 5:</p>\n<pre><code>import org.apache.http.client.HttpClient;\nimport org.apache.http.impl.client.HttpClients;\nimport org.apache.http.ssl.SSLContextBuilder;\n\n\n  @Bean(name = &quot;sslRestTemplateBean&quot;)\n  public RestTemplate sslRestTemplate() throws Exception {\n    char[] unlockPhrase = &quot;test&quot;.toCharArray();\n    SSLContext sslContext = SSLContextBuilder.create()\n        .loadKeyMaterial(pkcsKeyStore(&quot;/key.p12&quot;, unlockPhrase), unlockPhrase)\n        .build();\n    HttpClient client = HttpClients.custom()\n        .setSSLContext(sslContext)\n        .build();\n    return new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n  }\n\n  private KeyStore pkcsKeyStore(String file, char... password) throws Exception {\n    KeyStore keyStore = KeyStore.getInstance(&quot;PKCS12&quot;);\n    try (InputStream in = this.getClass().getClassLoader().getResourceAsStream(file)) {\n      keyStore.load(in, password);\n    }\n    return keyStore;\n  }\n\n  static RestTemplate createSslRestTemplate(SslCertificate sslCertificate) throws Exception {\n    char[] password = generateRandomString().toCharArray();\n    SSLContext sslContext = SSLContextBuilder.create()\n        .loadKeyMaterial(keyStore(sslCertificate, password), password)\n        .build();\n    HttpClient client = HttpClients.custom()\n        .disableAutomaticRetries()\n        .setSSLContext(sslContext)\n        .build();\n    return new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n  }\n</code></pre>\n<p>I migrated in to this:</p>\n<pre><code>import org.apache.hc.client5.http.impl.classic.CloseableHttpClient;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\nimport org.apache.hc.client5.http.ssl.SSLConnectionSocketFactory;\nimport org.apache.hc.core5.ssl.SSLContextBuilder;\n\n\n@Bean(name = &quot;sslRestTemplateBean&quot;)\n  public RestTemplate sslRestTemplate() throws Exception {\n    char[] unlockPhrase = &quot;test&quot;.toCharArray();\n    SSLContext sslContext = SSLContextBuilder.create()\n        .loadKeyMaterial(pkcsKeyStore(&quot;/key.p12&quot;, unlockPhrase), unlockPhrase)\n        .build();\n\n      // Create SSL socket factory\n      SSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory(sslContext);\n\n      // Create connection manager with SSL socket factory\n      PoolingHttpClientConnectionManager connectionManager =\n              new PoolingHttpClientConnectionManager();\n      connectionManager.setDefaultSocketFactory(sslSocketFactory);\n\n      // Build HTTP client\n      CloseableHttpClient client = HttpClients.custom()\n              .setConnectionManager(connectionManager)\n              .build();\n\n      return new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n  }\n\n  private KeyStore pkcsKeyStore(String file, char... password) throws Exception {\n    KeyStore keyStore = KeyStore.getInstance(&quot;PKCS12&quot;);\n    try (InputStream in = this.getClass().getClassLoader().getResourceAsStream(file)) {\n      keyStore.load(in, password);\n    }\n    return keyStore;\n  }\n\n  static RestTemplate createSslRestTemplate(SslCertificate sslCertificate) throws Exception {\n    char[] password = generateRandomString().toCharArray();\n    SSLContext sslContext = SSLContextBuilder.create()\n        .loadKeyMaterial(keyStore(sslCertificate, password), password)\n        .build();\n\n      // Create SSL socket factory\n      SSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory(sslContext);\n\n      // Create connection manager with SSL socket factory\n      PoolingHttpClientConnectionManager connectionManager =\n              new PoolingHttpClientConnectionManager();\n      connectionManager.setDefaultSocketFactory(sslSocketFactory);\n\n      // Build HTTP client\n      CloseableHttpClient client = HttpClients.custom()\n              .disableAutomaticRetries()\n              .setConnectionManager(connectionManager)\n              .build();\n\n    return new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n  }\n</code></pre>\n<p>But I get error: <code>Cannot resolve method 'setDefaultSocketFactory' in 'PoolingHttpClientConnectionManager'</code></p>\n<p>Do you know how I can fix this issue and migrate the code properly?</p>\n",
    "tags" : [ "java", "apache-httpclient-4.x", "apache-httpclient-5.x" ],
    "owner" : {
      "account_id" : 965625,
      "reputation" : 1102,
      "user_id" : 1103606,
      "user_type" : "registered",
      "accept_rate" : 51,
      "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
      "display_name" : "Peter Penzov",
      "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
    },
    "is_answered" : true,
    "view_count" : 85,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1756568446,
    "creation_date" : 1756480913,
    "link" : "https://stackoverflow.com/questions/79750492/cannot-resolve-method-setdefaultsocketfactory-in-poolinghttpclientconnectionm",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79751150,
    "question_id" : 79750492,
    "body" : "<p>In the latest version, <code>SSLConnectionSocketFactory</code> has been deprecated in favour of <a href=\"https://hc.apache.org/httpcomponents-client-5.5.x/current/httpclient5/apidocs/org/apache/hc/client5/http/ssl/DefaultClientTlsStrategy.html\" rel=\"nofollow noreferrer\">DefaultClientTlsStrategy</a>. After creating the <code>SSLContext</code>, use this instead to create the connection manager:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean(name = &quot;sslRestTemplateBean&quot;)\npublic RestTemplate sslRestTemplate() throws Exception {\n    char[] unlockPhrase = &quot;test&quot;.toCharArray();\n    SSLContext sslContext = SSLContextBuilder.create()\n            .loadKeyMaterial(pkcsKeyStore(&quot;/key.p12&quot;, unlockPhrase), unlockPhrase)\n            .build();\n\n    // Create connection manager with SSL context\n    PoolingHttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create()\n            .setTlsSocketStrategy(new DefaultClientTlsStrategy(sslContext))\n            .build();\n\n    // Build HTTP client\n    CloseableHttpClient client = HttpClients.custom()\n            .setConnectionManager(connectionManager)\n            .build();\n\n    return new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n}\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1211967,
      "reputation" : 10014,
      "user_id" : 1180351,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
      "display_name" : "Rob Spoor",
      "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
    },
    "creation_date" : 1756557411,
    "last_activity_date" : 1756568446,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79750516,
    "question_id" : 79750492,
    "body" : "<p>The new API is:</p>\n<pre class=\"lang-java prettyprint-override\"><code>SSLContext sslContext = ...;\nSSLConnectionSocketFactory sslSocketFactory = new SSLConnectionSocketFactory(sslContext);\n\nRegistry&lt;ConnectionSocketFactory&gt; socketFactoryRegistry = RegistryBuilder.&lt;ConnectionSocketFactory&gt;create()\n   .register(&quot;https&quot;, sslSocketFactory)\n   .build();\n\nHttpClientConnectionManager connManager = new PoolingHttpClientConnectionManager(socketFactoryRegistry);\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1096470,
      "reputation" : 29415,
      "user_id" : 1089967,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
      "display_name" : "lance-java",
      "link" : "https://stackoverflow.com/users/1089967/lance-java"
    },
    "creation_date" : 1756482586,
    "last_activity_date" : 1756482586,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79750516" : [ {
      "comment_id" : 140703548,
      "post_id" : 79750516,
      "body" : "That&#39;s not the new API anymore, because <code>SSLConnectionSocketFactory</code> is deprecated now. See my answer for a replacement.",
      "score" : 0,
      "owner" : {
        "account_id" : 1211967,
        "reputation" : 10014,
        "user_id" : 1180351,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
        "display_name" : "Rob Spoor",
        "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
      },
      "creation_date" : 1756557488,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140702091,
      "post_id" : 79750516,
      "body" : "Is it possible somehow to simplify the code?",
      "score" : 0,
      "owner" : {
        "account_id" : 965625,
        "reputation" : 1102,
        "user_id" : 1103606,
        "user_type" : "registered",
        "accept_rate" : 51,
        "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
        "display_name" : "Peter Penzov",
        "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
      },
      "creation_date" : 1756483159,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79751150" : [ {
      "comment_id" : 140703797,
      "post_id" : 79751150,
      "body" : "@PeterPenzov Done",
      "score" : 0,
      "owner" : {
        "account_id" : 1211967,
        "reputation" : 10014,
        "user_id" : 1180351,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
        "display_name" : "Rob Spoor",
        "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
      },
      "creation_date" : 1756568451,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140703587,
      "post_id" : 79751150,
      "body" : "can you show me the complete updated bean please?",
      "score" : 0,
      "owner" : {
        "account_id" : 965625,
        "reputation" : 1102,
        "user_id" : 1103606,
        "user_type" : "registered",
        "accept_rate" : 51,
        "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
        "display_name" : "Peter Penzov",
        "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
      },
      "creation_date" : 1756559141,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}