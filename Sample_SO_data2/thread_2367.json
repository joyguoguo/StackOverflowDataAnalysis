{
  "question" : {
    "question_id" : 79628435,
    "title" : "Connection reset by peer error using Netty",
    "body" : "<p>I’m seeing intermittent <code>&quot;connection reset by peer&quot;</code> errors with a few of our third‑party integrations. Our setup is:</p>\n<ol>\n<li>Java 17</li>\n<li>Spring Boot 2.6.6</li>\n<li>Reactor Netty 0.9.12.RELEASE and reactor‑netty‑http 1.0.17</li>\n<li>Idle‑connection timeout on our load balancer / NGINX: 30 seconds</li>\n</ol>\n<p>I tried using provided solution, and added following properties only, as I want to keep my connections unbounded.</p>\n<pre class=\"lang-java prettyprint-override\"><code>ConnectionProvider provider = ConnectionProvider.builder(&quot;fixed&quot;)\n                .maxIdleTime(Duration.ofSeconds(20))\n                .evictInBackground(Duration.ofSeconds(120))\n                .build();\nHttpClient client = HttpClient.create(provider);\n</code></pre>\n<p>This stopped the <code>&quot;connection reset by peer&quot;</code> errors, but I then started getting <code>&quot;handshake timed out after 10000ms&quot;</code> errors. I also verified that the default TLS version for Java 17 is v1.3 (with fallback to v1.2). So I tried explicitly forcing TLS v1.2:</p>\n<pre class=\"lang-java prettyprint-override\"><code>HttpClient client = HttpClient.create()\n                .headers(headers -&gt; headers.add(HttpHeaders.CONNECTION, &quot;keep-alive&quot;))\n                .secure(sslContextSpec -&gt; {\n                    try {\n                        sslContextSpec.sslContext(SslContextBuilder.forClient().protocols(&quot;TLSv1.2&quot;).build());\n                    } catch (SSLException e) {\n                        throw new RuntimeException(e);\n                    }\n                });\n</code></pre>\n<p>This fixed the <code>“connection reset by peer”</code> issue, but still resulted in <code>&quot;handshake timed out after 10000ms&quot;</code> errors. I wanted to understand that how are TLS version settings related to the <code>ConnectionProvider</code>’s <code>idle‑time</code> settings, and why am I now seeing handshake timeouts with both approaches, and how can I resolve this issue?</p>\n",
    "tags" : [ "java", "spring-boot", "reactor-netty" ],
    "owner" : {
      "account_id" : 42065294,
      "reputation" : 1,
      "user_id" : 30577008,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/43f5c0b96e06a1a54833c69bb04938bd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sahajdeep Kharbanda",
      "link" : "https://stackoverflow.com/users/30577008/sahajdeep-kharbanda"
    },
    "is_answered" : false,
    "view_count" : 662,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747940135,
    "creation_date" : 1747646068,
    "link" : "https://stackoverflow.com/questions/79628435/connection-reset-by-peer-error-using-netty",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140741367,
    "post_id" : 79628435,
    "body" : "You may want to ask/open issue with Netty project as Reactor Netty uses Netty&#39;s implementation.",
    "score" : 0,
    "owner" : {
      "account_id" : 5024231,
      "reputation" : 2352,
      "user_id" : 4036754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cba5f3a4f164acdf5e0a313036203993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Violeta Georgieva",
      "link" : "https://stackoverflow.com/users/4036754/violeta-georgieva"
    },
    "creation_date" : 1758091011,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140740319,
    "post_id" : 79628435,
    "body" : "@VioletaGeorgieva Recently, I investigated this issue in detail and concluded that the errors started appearing after migrating to Java 17. Since Java 17 uses TLS 1.3 by default, and TLS 1.3 enforces a half-close policy (unlike the duplex-close policy in TLS 1.2), the connection behaviour changed. Is there a better way to resolve this issue rather than relying on idle timeouts, since different servers may use different timeout values? I also tried adding -Djdk.tls.acknowledgeCloseNotify=true to my JVM, but it did not resolve the problem.",
    "score" : 0,
    "owner" : {
      "account_id" : 42065294,
      "reputation" : 1,
      "user_id" : 30577008,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/43f5c0b96e06a1a54833c69bb04938bd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sahajdeep Kharbanda",
      "link" : "https://stackoverflow.com/users/30577008/sahajdeep-kharbanda"
    },
    "creation_date" : 1758043856,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140441491,
    "post_id" : 79628435,
    "body" : "there is no relation, try to understand why the server closes with RST",
    "score" : 0,
    "owner" : {
      "account_id" : 5024231,
      "reputation" : 2352,
      "user_id" : 4036754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cba5f3a4f164acdf5e0a313036203993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Violeta Georgieva",
      "link" : "https://stackoverflow.com/users/4036754/violeta-georgieva"
    },
    "creation_date" : 1747721437,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140441401,
    "post_id" : 79628435,
    "body" : "Understood @VioletaGeorgieva. Also, I wanted to understand that how are TLS version settings related to the ConnectionProvider’s idle‑time settings since changing TLS to v1.2 resolved connection reset issue as well ?",
    "score" : 0,
    "owner" : {
      "account_id" : 42065294,
      "reputation" : 1,
      "user_id" : 30577008,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/43f5c0b96e06a1a54833c69bb04938bd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sahajdeep Kharbanda",
      "link" : "https://stackoverflow.com/users/30577008/sahajdeep-kharbanda"
    },
    "creation_date" : 1747718030,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140439481,
    "post_id" : 79628435,
    "body" : "The relation between connection pool max idle timeout and handshake timeout - with too aggressive max idle timeout you will close the connections too often and this will require TLS handshake for the newly established connections.",
    "score" : 0,
    "owner" : {
      "account_id" : 5024231,
      "reputation" : 2352,
      "user_id" : 4036754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cba5f3a4f164acdf5e0a313036203993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Violeta Georgieva",
      "link" : "https://stackoverflow.com/users/4036754/violeta-georgieva"
    },
    "creation_date" : 1747664083,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140439470,
    "post_id" : 79628435,
    "body" : "You need to update your versions which are quite old. For handshake timeout - it doesn&#39;t depend on TLS version, you need to configure it like this <a href=\"https://projectreactor.io/docs/netty/release/reference/http-client.html#ssl-tls-timeout\" rel=\"nofollow noreferrer\">projectreactor.io/docs/netty/release/reference/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 5024231,
      "reputation" : 2352,
      "user_id" : 4036754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cba5f3a4f164acdf5e0a313036203993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Violeta Georgieva",
      "link" : "https://stackoverflow.com/users/4036754/violeta-georgieva"
    },
    "creation_date" : 1747663956,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140439299,
    "post_id" : 79628435,
    "body" : "@MarkRotteveel although I have fixed the issue with above shared code but now I am facing &quot;handshake timed out after 10000ms&quot; errors. Also, I wanted to understand that how are TLS version settings related to the ConnectionProvider’s idle‑time settings, and why am I now seeing handshake timeouts with both approaches and how can I resolve this issue?",
    "score" : 0,
    "owner" : {
      "account_id" : 42065294,
      "reputation" : 1,
      "user_id" : 30577008,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/43f5c0b96e06a1a54833c69bb04938bd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sahajdeep Kharbanda",
      "link" : "https://stackoverflow.com/users/30577008/sahajdeep-kharbanda"
    },
    "creation_date" : 1747660448,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140438680,
    "post_id" : 79628435,
    "body" : "Connection reset by peer means that your peer (to other side of the connection), or intermediate network equipment sent an RST packet because the connection broke in some way (or intermediate network equipment wants to get rid of it for other reasons). That you get timeouts and connection resets might be an indication that something is wrong with your network, the network(s) between you and your peer, or the peer itself.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110280,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1747647854,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}