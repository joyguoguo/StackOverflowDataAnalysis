{
  "question" : {
    "question_id" : 79659097,
    "title" : "apache-commons-csv adding extra double quote characters",
    "body" : "<p>I'm working on a Kotlin project where I need to take some incoming data and output a csv formatted string. I decided to try using the apache-commons csv library to handle building the csv output. While it mostly works, there is some strange behavior in the way it handles double-quotes in the incoming data. If I understand the rules for csv formatting correctly, a string containing a double quote should get escaped with an additional double quote. So if my input string is <code>&quot;foo</code>, the output string should be <code>&quot;&quot;foo</code>. However, when I build my output string using CSVFormat, I instead get the output <code>&quot;&quot;&quot;foo</code>.</p>\n<p>Why am I getting an extra double quote in the output? Is this a bug or expected behavior? Is there any way to work around this without completely disabling quoting?</p>\n<p>For reference, my function responsible for creating the scv string looks like:</p>\n<pre><code>fun Rosters.toCsvString(includeHeader: Boolean): String {\n\n    val writer = StringWriter()\n    val builder = CSVFormat.DEFAULT.builder().setQuoteMode(QuoteMode.MINIMAL)\n    if(includeHeader){\n        builder.setHeader(Rosters.Header::class.java)\n    }\n    val printer = CSVPrinter(writer, builder.get())\n    return writer.use {\n        printer.printRecords(this.rosters.map { it.values() })\n        writer.toString()\n    }\n\n}\n</code></pre>\n<p>If I run a test against that function:</p>\n<pre><code>    @Test\n    fun `Test convertRosterToCsvWithSpecialChars`()\n    {\n        val expected = &quot;&quot;&quot;\nEPPN,FirstName,LastName,Email,ClassStanding,StudentID,Degree,College,Department,SuitableRole\n&quot;&quot;foo014&quot;&quot;,Foo,Bar,fbar014@test.edu,,9200#8210,,,,ROLE_TENANT_ADVISOR,\n\n&quot;&quot;&quot;.trimMargin()\n\n        val worker1 = Roster(&quot;\\&quot;foo014\\&quot;&quot;,&quot;Foo&quot;,&quot;Bar&quot;,&quot;fbar014@test.edu&quot;,\n                    studentId = &quot;9200#8210&quot;, suitableRole = &quot;ROLE_TENANT_ADVISOR&quot;)\n\n        val incomingRosters = Rosters(listOf( worker1))\n        val actual = incomingRosters.toCsvString(true)\n        assertThat(actual).isEqualToNormalizingNewlines(expected)\n    }\n</code></pre>\n<p>I get the error:</p>\n<pre><code>Expecting actual:\n  \n\n&quot;EPPN,FirstName,LastName,Email,ClassStanding,StudentID,Degree,College,Department,SuitableRole\n&quot;&quot;&quot;foo014&quot;&quot;&quot;,Foo,Bar,fbar014@test.edu,,9200#8210,,,,ROLE_TENANT_ADVISOR\n&quot;\nto be equal to:\n  &quot;EPPN,FirstName,LastName,Email,ClassStanding,StudentID,Degree,College,Department,SuitableRole\n&quot;&quot;foo014&quot;&quot;,Foo,Bar,fbar014@test.edu,,9200#8210,,,,ROLE_TENANT_ADVISOR,\n&quot;\nwhen ignoring newline differences ('\\r\\n' == '\\n')\n</code></pre>\n",
    "tags" : [ "java", "kotlin", "csv", "apache-commons", "apache-commons-csv" ],
    "owner" : {
      "account_id" : 2090213,
      "reputation" : 1839,
      "user_id" : 1860222,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/dcd9cf0881ee1e7a5f28175308628e25?s=256&d=identicon&r=PG",
      "display_name" : "pbuchheit",
      "link" : "https://stackoverflow.com/users/1860222/pbuchheit"
    },
    "is_answered" : true,
    "view_count" : 90,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1749514044,
    "creation_date" : 1749482017,
    "link" : "https://stackoverflow.com/questions/79659097/apache-commons-csv-adding-extra-double-quote-characters",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79659217,
    "question_id" : 79659097,
    "body" : "<p>In most CSV dialects, inside a quoted string a quote needs to be escaped using two quotes. You're using <code>CSVFormat.DEFAULT</code> which is based on RFC 4180. <a href=\"https://datatracker.ietf.org/doc/html/rfc4180#section-2\" rel=\"nofollow noreferrer\">RFC 4180 section 2.7</a> states:</p>\n<blockquote>\n<p>If double-quotes are used to enclose fields, then a double-quote appearing inside a field must be escaped by preceding it with another double quote.</p>\n</blockquote>\n<p>So the problem is not in your production code, nor in the library, but in your <code>expected</code> value.</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1749486909,
    "last_activity_date" : 1749486909,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140500830,
    "post_id" : 79659097,
    "body" : "Should <code>&quot;&quot;&quot;foo</code> really be <code>&quot;&quot;&quot;foo&quot;</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 89455,
      "reputation" : 11436,
      "user_id" : 246801,
      "user_type" : "registered",
      "accept_rate" : 81,
      "profile_image" : "https://www.gravatar.com/avatar/54ac1ed63d1eb6bfc3eb0d89a8c2e135?s=256&d=identicon&r=PG",
      "display_name" : "Zach Young",
      "link" : "https://stackoverflow.com/users/246801/zach-young"
    },
    "creation_date" : 1749514065,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140499924,
    "post_id" : 79659097,
    "body" : "btw you don&#39;t need <code>.trimMargin()</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1749490591,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}