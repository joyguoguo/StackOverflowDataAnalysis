{
  "question" : {
    "question_id" : 79672386,
    "title" : "Path does not chain with any of the trust anchors",
    "body" : "<p>I try to setup standalone wiremock to check client cert.\nI prepare truststore.jks, that contains RootCA and Intermediate certificates.\nAnd start wiremock with command</p>\n<pre><code>java -Djavax.net.debug=all -Djava.security.debug=certpath -jar wiremock3.jar --port 9080 --https-port 9443 --https-keystore ./certificates/server/server_cert.jks --keystore-password qwerty --key-manager-password qwerty --https-require-client-cert --https-truststore ./certificates/client/truststore.jks --truststore-password qwerty --verbose\n</code></pre>\n<p>But when I try to connect from my client I've got an error:</p>\n<pre><code>javax.net.ssl|ERROR|E2|qtp1927963027-46|2025-06-19 19:31:52.728 MSK|TransportContext.java:370|Fatal (CERTIFICATE_UNKNOWN): PKIX path validation failed: java.security.cert.CertPathValidatorException: Path does not chain with any of the trust anchors (\n&quot;throwable&quot; : {\n  sun.security.validator.ValidatorException: PKIX path validation failed: java.security.cert.CertPathValidatorException: Path does not chain with any of the trust anchors\n        at java.base/sun.security.validator.PKIXValidator.doValidate(PKIXValidator.java:318)\n        at java.base/sun.security.validator.PKIXValidator.engineValidate(PKIXValidator.java:256)\n        at java.base/sun.security.validator.Validator.validate(Validator.java:256)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkTrusted(X509TrustManagerImpl.java:284)\n        at java.base/sun.security.ssl.X509TrustManagerImpl.checkClientTrusted(X509TrustManagerImpl.java:138)\n        at java.base/sun.security.ssl.CertificateMessage$T12CertificateConsumer.checkClientCerts(CertificateMessage.java:674)\n        at java.base/sun.security.ssl.CertificateMessage$T12CertificateConsumer.onCertificate(CertificateMessage.java:405)\n        at java.base/sun.security.ssl.CertificateMessage$T12CertificateConsumer.consume(CertificateMessage.java:369)\n        at java.base/sun.security.ssl.SSLHandshake.consume(SSLHandshake.java:393)\n        at java.base/sun.security.ssl.HandshakeContext.dispatch(HandshakeContext.java:476)\n        at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1273)\n        at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1260)\n        at java.base/java.security.AccessController.doPrivileged(AccessController.java:714)\n        at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask.run(SSLEngineImpl.java:1205)\n        at wiremock.org.eclipse.jetty.io.ssl.SslConnection$SslEndPoint.fill(SslConnection.java:674)\n        at wiremock.org.eclipse.jetty.http2.HTTP2Connection.fill(HTTP2Connection.java:165)\n        at wiremock.org.eclipse.jetty.http2.HTTP2Connection$HTTP2Producer.produce(HTTP2Connection.java:359)\n        at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.produceTask(AdaptiveExecutionStrategy.java:514)                                  at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.tryProduce(AdaptiveExecutionStrategy.java:258)                      19:36        at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.produce(AdaptiveExecutionStrategy.java:195)                                      at wiremock.org.eclipse.jetty.http2.HTTP2Connection.produce(HTTP2Connection.java:209)                                                                         at wiremock.org.eclipse.jetty.http2.HTTP2Connection.onFillable(HTTP2Connection.java:156)                                                                      at wiremock.org.eclipse.jetty.http2.HTTP2Connection$FillableCallback.succeeded(HTTP2Connection.java:442)                                                      at wiremock.org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:99)                                                                                  at wiremock.org.eclipse.jetty.io.ssl.SslConnection$SslEndPoint.onFillable(SslConnection.java:575)                                                             at wiremock.org.eclipse.jetty.io.ssl.SslConnection.onFillable(SslConnection.java:390)                                                                         at wiremock.org.eclipse.jetty.io.ssl.SslConnection$2.succeeded(SslConnection.java:150)                                                                        at wiremock.org.eclipse.jetty.io.FillInterest.fillable(FillInterest.java:99)                                                                                  at wiremock.org.eclipse.jetty.io.SelectableChannelEndPoint$1.run(SelectableChannelEndPoint.java:53)                                                           at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.runTask(AdaptiveExecutionStrategy.java:480)                                      at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.consumeTask(AdaptiveExecutionStrategy.java:443)                                  at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.tryProduce(AdaptiveExecutionStrategy.java:293)                                   at wiremock.org.eclipse.jetty.util.thread.strategy.AdaptiveExecutionStrategy.run(AdaptiveExecutionStrategy.java:201)                                          at wiremock.org.eclipse.jetty.util.thread.ReservedThreadExecutor$ReservedThread.run(ReservedThreadExecutor.java:311)                                          at wiremock.org.eclipse.jetty.util.thread.QueuedThreadPool.runJob(QueuedThreadPool.java:981)                                                                  at wiremock.org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.doRunJob(QueuedThreadPool.java:1211)                                                        at wiremock.org.eclipse.jetty.util.thread.QueuedThreadPool$Runner.run(QueuedThreadPool.java:1166)                                                             at java.base/java.lang.Thread.run(Thread.java:1583)                                                                                                     Caused by: java.security.cert.CertPathValidatorException: Path does not chain with any of the trust anchors                                                         at java.base/sun.security.provider.certpath.PKIXCertPathValidator.validate(PKIXCertPathValidator.java:157)                                                    at java.base/sun.security.provider.certpath.PKIXCertPathValidator.engineValidate(PKIXCertPathValidator.java:83)                                               at java.base/java.security.cert.CertPathValidator.validate(CertPathValidator.java:309)                                                                        at java.base/sun.security.validator.PKIXValidator.doValidate(PKIXValidator.java:313)                                                                          ... 37 more}   \n</code></pre>\n<p>In logs I see that certificates authorities are good:</p>\n<pre><code>&quot;CertificateRequest&quot;: {\n  &quot;certificate types&quot;: [ecdsa_sign, rsa_sign, dss_sign]\n  &quot;supported signature algorithms&quot;: [ecdsa_secp256r1_sha256, ecdsa_secp384r1_sha384, ecdsa_secp521r1_sha512, ed25519, ed448, rsa_pss_rsae_sha256, rsa_pss_rsae_sha384, rsa_pss_rsae_sha512, rsa_pss_pss_sha256, rsa_pss_pss_sha384, rsa_pss_pss_sha512, rsa_pkcs1_sha256, rsa_pkcs1_sha384, rsa_pkcs1_sha512, dsa_sha256, ecdsa_sha1, rsa_pkcs1_sha1, dsa_sha1]\n  &quot;certificate authorities&quot;: [CN=Root CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO, CN=Intermediate CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO]\n}\n</code></pre>\n<p>And client send needed chain of certificates (as you can see client cert is issued by Intermediate cert that is in certificate authorities list)</p>\n<pre><code>javax.net.ssl|DEBUG|F2|qtp1540894701-47|2025-06-19 19:37:45.740 MSK|CertificateMessage.java:366|Consuming client Certificate handshake message (\n&quot;Certificates&quot;: [\n  &quot;certificate&quot; : {\n    &quot;version&quot;            : &quot;v3&quot;,\n    &quot;serial number&quot;      : &quot;327A90FA4BBCF1859AD5DFE2ECF9267FBA35AFEC&quot;,\n    &quot;signature algorithm&quot;: &quot;SHA256withRSA&quot;,\n    &quot;issuer&quot;             : &quot;CN=Intermediate CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;not before&quot;         : &quot;2025-06-06 08:42:41.000 MSK&quot;,\n    &quot;not  after&quot;         : &quot;2026-06-06 08:42:41.000 MSK&quot;,\n    &quot;subject&quot;            : &quot;EMAILADDRESS=thor@tls-experts.no, CN=Thor Odinson, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;subject public key&quot; : &quot;RSA&quot;,\n    &quot;extensions&quot;         : [\n      {\n        ObjectId: 1.3.6.1.5.5.7.1.1 Criticality=false\n        AuthorityInfoAccess [\n          [\n           accessMethod: ocsp\n           accessLocation: URIName: http://srv8-beattownma:9999/\n        ]\n        ]\n      },\n      {\n        ObjectId: 2.5.29.35 Criticality=false\n        AuthorityKeyIdentifier [\n        KeyIdentifier [\n        0000: 26 1F 3B 38 59 AB F2 6C   9B 7E C0 82 FA CA EF 1A  &amp;.;8Y..l........\n        0010: 88 AE 0F A0                                        ....\n        ]\n        ]\n      },\n      {\n        ObjectId: 2.5.29.19 Criticality=true\n        BasicConstraints:[\n          CA:false\n          PathLen: undefined\n        ]\n      },\n      {\n        ObjectId: 2.5.29.31 Criticality=false\n        CRLDistributionPoints [\n          [DistributionPoint:\n             [URIName: http://crl.tls-experts.no/intermediate_crl.der]\n        ]]\n      },\n      {\n        ObjectId: 2.5.29.37 Criticality=false\n        ExtendedKeyUsages [\n          clientAuth\n          emailProtection\n        ]\n      },\n      {\n        ObjectId: 2.5.29.15 Criticality=true\n        KeyUsage [\n          DigitalSignature\n          Non_repudiation\n          Key_Encipherment\n        ]\n      },\n      {\n        ObjectId: 2.16.840.1.113730.1.1 Criticality=false\n        NetscapeCertType [\n           SSL client\n           S/MIME\n        ]\n      },\n      {\n        ObjectId: 2.5.29.17 Criticality=false\n        SubjectAlternativeName [\n          RFC822Name: postmaster@tls-experts.no\n          RFC822Name: hostmaster@tls-experts.no\n        ]\n      },\n      {\n        ObjectId: 2.5.29.14 Criticality=false\n        SubjectKeyIdentifier [\n        KeyIdentifier [\n        0000: 73 88 04 13 F6 AC 40 D7   AF D6 B3 B1 81 DF 71 99  s.....@.......q.\n        0010: 4A 55 6D 99                                        JUm.\n        ]\n        ]\n      }\n    ]},\n  &quot;certificate&quot; : {\n    &quot;version&quot;            : &quot;v3&quot;,\n    &quot;serial number&quot;      : &quot;5E9375F2B7DC3D06E632BCF5C948D8DDD06021DB&quot;,\n    &quot;signature algorithm&quot;: &quot;SHA256withRSA&quot;,\n    &quot;issuer&quot;             : &quot;CN=Root CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;not before&quot;         : &quot;2025-02-26 07:40:29.000 MSK&quot;,\n    &quot;not  after&quot;         : &quot;2035-02-24 07:40:29.000 MSK&quot;,\n    &quot;subject&quot;            : &quot;CN=Intermediate CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;subject public key&quot; : &quot;RSA&quot;,\n    &quot;extensions&quot;         : [\n      {\n        ObjectId: 2.5.29.35 Criticality=false\n        AuthorityKeyIdentifier [\n        KeyIdentifier [\n        0000: 3C CC BF EA EB 0D 27 D1   F0 9B A2 F2 64 DD DD 2B  &lt;.....'.....d..+\n        0010: 50 5F 76 B3                                        P_v.\n        ]\n        ]\n      },\n      {\n        ObjectId: 2.5.29.19 Criticality=true\n        BasicConstraints:[\n          CA:true\n          PathLen:0\n        ]\n      },\n      {\n        ObjectId: 2.5.29.31 Criticality=false\n        CRLDistributionPoints [\n          [DistributionPoint:\n             [URIName: http://crl.tls-exports.no/root_crl.der]\n        ]]\n      },\n      {\n        ObjectId: 2.5.29.15 Criticality=true\n        KeyUsage [\n          DigitalSignature\n          Key_CertSign\n          Crl_Sign\n        ]\n      },\n      {\n        ObjectId: 2.5.29.14 Criticality=false\n        SubjectKeyIdentifier [\n        KeyIdentifier [\n        0000: 0F 40 2C F8 D4 BA 91 4C   06 8C EB 1A E1 0B 61 CB  .@,....L......a.\n        0010: FF 19 25 07                                        ..%.\n        ]\n        ]\n      }\n    ]},\n  &quot;certificate&quot; : {\n    &quot;version&quot;            : &quot;v3&quot;,\n    &quot;serial number&quot;      : &quot;757F5203FEFF1FE592F0F99C18CB70168B5E4435&quot;,\n    &quot;signature algorithm&quot;: &quot;SHA256withRSA&quot;,\n    &quot;issuer&quot;             : &quot;CN=Root CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;not before&quot;         : &quot;2025-06-06 08:42:35.000 MSK&quot;,\n    &quot;not  after&quot;         : &quot;2035-06-04 08:42:35.000 MSK&quot;,\n    &quot;subject&quot;            : &quot;CN=Root CA, O=TLS Experts, L=Oslo, ST=Oslo, C=NO&quot;,\n    &quot;subject public key&quot; : &quot;RSA&quot;,\n    &quot;extensions&quot;         : [\n      {\n        ObjectId: 2.5.29.35 Criticality=false\n        AuthorityKeyIdentifier [\n        KeyIdentifier [\n        0000: 1C 9F 31 6E 67 D7 CD B3   DA 84 72 AB 9F D8 A7 41  ..1ng.....r....A\n        0010: 20 C2 08 DE                                         ...\n        ]\n        ]\n      },\n      {\n        ObjectId: 2.5.29.19 Criticality=true\n        BasicConstraints:[\n          CA:true\n          PathLen: no limit\n        ]\n      },\n      {\n        ObjectId: 2.5.29.31 Criticality=false\n        CRLDistributionPoints [\n          [DistributionPoint:\n             [URIName: http://crl.tls-exports.no/root_crl.der]\n        ]]\n      },\n      {\n        ObjectId: 2.5.29.15 Criticality=true\n        KeyUsage [\n          DigitalSignature\n          Key_CertSign\n          Crl_Sign\n        ]\n      },\n      {\n        ObjectId: 2.5.29.14 Criticality=false\n        SubjectKeyIdentifier [\n        KeyIdentifier [\n        0000: 1C 9F 31 6E 67 D7 CD B3   DA 84 72 AB 9F D8 A7 41  ..1ng.....r....A\n        0010: 20 C2 08 DE                                         ...\n        ]\n        ]\n      }\n    ]}\n]\n)\n</code></pre>\n<p>So what is wrong here? Why I've got such an error?</p>\n<p>P.S.\nI extended debug mode with -Djava.security.debug=certpath,verbose\nand found such logs:</p>\n<pre><code>certpath: AdaptableX509CertSelector.match: subject key IDs don't match. Expected: [4, 20, 38, 31, 59, 56, 89, -85, -14, 108, -101, 126, -64, -126, -6, -54, -17, 26, -120, -82, 15, -96] Cert's: [4, 20, 28, -97, 49, 110, 103, -41, -51, -77, -38, -124, 114, -85, -97, -40, -89, 65, 32, -62, 8, -34]\ncertpath: NO - don't try this trustedCert\n</code></pre>\n<p>So validator tries to match subject key IDs and they are different...\nI checked my certs and subject key IDs are really different.\nMaybe I &quot;cook&quot; them incorrect?\nI think, that it is enough that client cert was signed by trusted CA. But why java compare subject keys?</p>\n",
    "tags" : [ "java", "ssl", "ssl-certificate" ],
    "owner" : {
      "account_id" : 19522690,
      "reputation" : 187,
      "user_id" : 14284182,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/35eb7fd828d7de3742964433334953ff?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Haster",
      "link" : "https://stackoverflow.com/users/14284182/haster"
    },
    "is_answered" : false,
    "view_count" : 101,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1751351231,
    "creation_date" : 1750351342,
    "link" : "https://stackoverflow.com/questions/79672386/path-does-not-chain-with-any-of-the-trust-anchors",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79685605,
    "question_id" : 79672386,
    "body" : "<p>The problem was in client certificate, that was signed by wrong intermediate certificate.</p>\n<p>To find a problem I used flag</p>\n<pre><code>-Djava.security.debug=certpath,verbose\n</code></pre>\n<p>so in logs I found that authority key identifier of client certificate is not equal to Subject Key Identifier of intermediate certificate</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19522690,
      "reputation" : 187,
      "user_id" : 14284182,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/35eb7fd828d7de3742964433334953ff?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Haster",
      "link" : "https://stackoverflow.com/users/14284182/haster"
    },
    "creation_date" : 1751351231,
    "last_activity_date" : 1751351231,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140528439,
    "post_id" : 79672386,
    "body" : "@PresidentJamesK.Polk, yes, this output is from WireMock",
    "score" : 0,
    "owner" : {
      "account_id" : 19522690,
      "reputation" : 187,
      "user_id" : 14284182,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/35eb7fd828d7de3742964433334953ff?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Haster",
      "link" : "https://stackoverflow.com/users/14284182/haster"
    },
    "creation_date" : 1750391270,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528198,
    "post_id" : 79672386,
    "body" : "Just to clarify, is all the above output coming from the standalone WireMock instance?",
    "score" : 0,
    "owner" : {
      "account_id" : 85671,
      "reputation" : 42272,
      "user_id" : 238704,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VgOZI.png?s=256",
      "display_name" : "President James K. Polk",
      "link" : "https://stackoverflow.com/users/238704/president-james-k-polk"
    },
    "creation_date" : 1750376372,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140527448,
    "post_id" : 79672386,
    "body" : "@PresidentJamesK.Polk, I have also tried with only RooCA in trust store, but nothing have changed",
    "score" : 0,
    "owner" : {
      "account_id" : 19522690,
      "reputation" : 187,
      "user_id" : 14284182,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/35eb7fd828d7de3742964433334953ff?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Haster",
      "link" : "https://stackoverflow.com/users/14284182/haster"
    },
    "creation_date" : 1750352930,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140527445,
    "post_id" : 79672386,
    "body" : "Although I&#39;m sure that this is the cause of the exception, you should not add intermediate CA certificates to the list of trust anchors.",
    "score" : 1,
    "owner" : {
      "account_id" : 85671,
      "reputation" : 42272,
      "user_id" : 238704,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VgOZI.png?s=256",
      "display_name" : "President James K. Polk",
      "link" : "https://stackoverflow.com/users/238704/president-james-k-polk"
    },
    "creation_date" : 1750352804,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}