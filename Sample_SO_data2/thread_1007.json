{
  "question" : {
    "question_id" : 79755826,
    "title" : "Spring boot kafka listener observation enrichment",
    "body" : "<p>I've a kafka based spring boot application (Micrometer + Otel) which consumes a lot of events from a lot of kafka topics and publishes its output on another set of kafka topics.</p>\n<p>I want to enrich the kafka listener observations which are created out of the box by spring boot (my organization has some wrapper libraries over vanilla sb3)</p>\n<p>Requirements :</p>\n<ol>\n<li>Modify Observation name</li>\n<li>Add low and high cardinality values which can be extracted by kafka message itself</li>\n<li>Add some Business logic specific properties which would be available later in application flow</li>\n</ol>\n<p>As of now i've been able to do all of them but am not very proud of the solution :</p>\n<pre><code>@Slf4j\npublic class KafkaConsumerObservationConvention extends KafkaListenerObservation.DefaultKafkaListenerObservationConvention {\n\n@Override\npublic boolean supportsContext(Observation.Context context) {\n    return super.supportsContext(context);\n}\n\n@Override\npublic String getName() {\n    return &quot;consumeKafkaEvent&quot;;\n}\n\n\n@Override\npublic KeyValues getLowCardinalityKeyValues(KafkaRecordReceiverContext context) {\n   ...\n}\n}\n</code></pre>\n<p>The above takes care of Requirements 1 and 2 but not 3 since ObservationConvention is called when the observation is created and i simply don't have those properties as of this instant.</p>\n<p>For Requirements 3 I've had to resort to directly using low level Micrometer APIs which let me play with raw observation objects.</p>\n<pre><code>@Autowired ObservationRegistry observationRegistry;\n\nOptional.ofNullable(observationRegistry.getCurrentObservation())\n                .ifPresent(o-&gt;o.lowCardinalityKeyValue(\n                KeyValue.of(&quot;key&quot;, &quot;value&quot;);\n</code></pre>\n<p>I don't like this approach because</p>\n<p>Problems :</p>\n<ol>\n<li>The logic of observation enrichment is now scattered across the application. Anyone who wants to add some property needs to do this low level thing themselves. Hence the ObservationConvention is not a one-stop solution</li>\n<li>From what i know Observations can also be stacked so if its something like obs1 -&gt; obs2 -&gt; obs3. When i do <code>observationRegistry.getCurrentObservation()</code> it will give me <code>obs3</code> but the original observation created by KafkaListener was obs1. So this poses a risk of data corruption.</li>\n</ol>\n<p>I had thought of another solution to mitigate Problem 1 to some extent :</p>\n<p>Bundle the ObservationRegistry (OR) logic as part of ObservationConvention (OC) itself by providing a separate public method which lets a user update current observation.\nHowever this approach didn't work since my ObservationConvention was not even getting called in this case. One possible reason i could think of for this was that by design an OR is supposed to have references to all OCs and ObservationHandlers and if I make my OC also dependant on the OR it poses a risk of a cyclic dependency and the beans may not be connected properly. Which led me to give up this approach also thinking this might actually be an antipattern.</p>\n<p>Please let me know what is the recommended way of supporting this use case without compromising on code quality</p>\n",
    "tags" : [ "java", "spring-boot", "spring-micrometer" ],
    "owner" : {
      "account_id" : 12510863,
      "reputation" : 165,
      "user_id" : 9106041,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-cvK-SR9xInk/AAAAAAAAAAI/AAAAAAAACxk/hsD_2BbZJO0/s256-rj/photo.jpg",
      "display_name" : "Krittam Kothari",
      "link" : "https://stackoverflow.com/users/9106041/krittam-kothari"
    },
    "is_answered" : false,
    "view_count" : 65,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1756994770,
    "creation_date" : 1756994770,
    "link" : "https://stackoverflow.com/questions/79755826/spring-boot-kafka-listener-observation-enrichment",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}