{
  "question" : {
    "question_id" : 79795561,
    "title" : "Request mapping no longer works with spring-boot-starter-oauth2-resource-server",
    "body" : "<p>I'm developing a service which is used in different contexts, some of which require web security, and others don't.</p>\n<p>I therefore added</p>\n<pre class=\"lang-xml prettyprint-override\"><code>        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-oauth2-resource-server&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;\n            &lt;version&gt;6.5.5&lt;/version&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>to my pom.xml and wrote a configuration class with a <code>SecurityFilterChain</code> @Bean which works as follows:</p>\n<ul>\n<li>CSRF protection is disabled in any case (stateless resource server)</li>\n<li>If web security is enabled, I'm setting up <code>httpSecurity.oauth2ResourceServer</code> and <code>http.authorizeHttpRequests</code> with role validation.</li>\n<li>If web security is disabled, I'm just calling:</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>httpSecurity.authorizeHttpRequests(auth -&gt; auth.anyRequest().permitAll());\n</code></pre>\n<p>Now I've got a unit test for a controller with</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @RequestMapping(\n        method = RequestMethod.POST,\n        value = &quot;/import/{pipeline_name}&quot;,\n        produces = { &quot;application/json&quot; },\n        consumes = { &quot;application/json&quot; }\n    )\n</code></pre>\n<p>where <code>pipeline_name</code> is a @Parameter.</p>\n<p>The Unit Test looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@WebMvcTest(ImportController.class)\nclass ImportControllerTest {\n\n    @Autowired\n    private MockMvc mockMvc;\n\n    // some more beans and an inner @Configuration class which asks for disabled web security\n\n    @Test\n    @WithMockUser\n    void someTest() throws Exception {\n        doNothing().when(someService).doesStuff();\n        this.mockMvc.perform(\n            post(&quot;/import/test&quot;)\n                .with(jwt())\n                .contentType(MediaType.APPLICATION_JSON)\n                .content(someBody)\n        ).andExpect(status().isNoContent());\n    }\n</code></pre>\n<p>This test worked flawlessly before adding the Spring Boot starter for OAuth2 Resource Server.</p>\n<p>However, with that dependency included, no matter if I set up complex request matchers or just <code>anyRequest().permitALl()</code>, I'm getting a 404 status with the following logs:</p>\n<pre class=\"lang-none prettyprint-override\"><code>o.s.w.s.r.ResourceHttpRequestHandler     : Resource not found\n.w.s.m.s.DefaultHandlerExceptionResolver : Resolved [org.springframework.web.servlet.resource.NoResourceFoundException: No static resource import/test.]\n</code></pre>\n<p>Note that the issue only seems to occur in Unit Tests</p>\n<p>Why does the request mapping no longer work in this case?</p>\n",
    "tags" : [ "java", "spring-boot", "spring-boot-security", "spring-webmvc" ],
    "owner" : {
      "account_id" : 426759,
      "reputation" : 12702,
      "user_id" : 808151,
      "user_type" : "registered",
      "accept_rate" : 91,
      "profile_image" : "https://www.gravatar.com/avatar/8a5d431123d4563c74f239c50213bdff?s=256&d=identicon&r=PG",
      "display_name" : "Tim Meyer",
      "link" : "https://stackoverflow.com/users/808151/tim-meyer"
    },
    "is_answered" : true,
    "view_count" : 65,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1761050521,
    "creation_date" : 1761032580,
    "link" : "https://stackoverflow.com/questions/79795561/request-mapping-no-longer-works-with-spring-boot-starter-oauth2-resource-server",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79795607,
    "question_id" : 79795561,
    "body" : "<p>Lets add</p>\n<pre><code>@AutoConfigureMockMvc(addFilters = false)\n</code></pre>\n<p>to ImportControllerTest. By setting addFilters = false in @AutoConfigureMockMvc, you instruct Spring to disable the entire Security Filter Chain for the test. This allows the request to be routed directly to your ImportController, bypassing any potential misconfiguration in the auto-configured OAuth2 resource server setup that is preventing the dispatcher from finding the controller.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 17553626,
      "reputation" : 508,
      "user_id" : 12733532,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-EAww28wDCxk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcgKS9dXdmUh-hOQPlZYZygBUfLwQ/s256-rj/photo.jpg",
      "display_name" : "Max",
      "link" : "https://stackoverflow.com/users/12733532/max"
    },
    "creation_date" : 1761035760,
    "last_activity_date" : 1761035760,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79795824,
    "question_id" : 79795561,
    "body" : "<p>The request mapping is not found because WebMvcTest no longer uses (at least some of) your beans as soon as a test includes an inner @Configuration class.</p>\n<p>The correct way to do it is put that configuration class into its own file and use @TestConfiguration in place of @Configuration, which will also stop other @SpringBootTest classes from using such classes. (I used a static configuration class within the test class since otherwise my spring boot tests would fail)</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 426759,
      "reputation" : 12702,
      "user_id" : 808151,
      "user_type" : "registered",
      "accept_rate" : 91,
      "profile_image" : "https://www.gravatar.com/avatar/8a5d431123d4563c74f239c50213bdff?s=256&d=identicon&r=PG",
      "display_name" : "Tim Meyer",
      "link" : "https://stackoverflow.com/users/808151/tim-meyer"
    },
    "creation_date" : 1761050521,
    "last_activity_date" : 1761050521,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140809940,
    "post_id" : 79795561,
    "body" : "Also, in the test you show, <code>@WithMockUser</code> and <code>.with(jwt())</code> conflict. The 1st populates the test security context with a <code>UsernamePasswordAuthenticationToken</code> instance, and the 2nd with a <code>JwtAuthenticationToken</code>. In the case of an <code>oauth2ResourceServer</code> with the default authentication converter, you probably want to remove the 1st (or remove both and use <code>@WithJwt</code> from &quot;my&quot; lib)",
    "score" : 0,
    "owner" : {
      "account_id" : 308139,
      "reputation" : 13854,
      "user_id" : 619830,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/f4d00b0a82e9307b1d68b29867fee4e5?s=256&d=identicon&r=PG",
      "display_name" : "ch4mp",
      "link" : "https://stackoverflow.com/users/619830/ch4mp"
    },
    "creation_date" : 1761113605,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140809936,
    "post_id" : 79795561,
    "body" : "You should not disable security for tests. Instead, mock the authentication in the security context and cover access control with your tests. I wrote an article for that: <a href=\"https://www.baeldung.com/spring-oauth-testing-access-control\" rel=\"nofollow noreferrer\">baeldung.com/spring-oauth-testing-access-control</a> (I also wrote what is included in <code>spring-security-test</code> for OAuth2, and I maintain <a href=\"https://github.com/ch4mpy/spring-addons/tree/master/spring-addons-oauth2-test\" rel=\"nofollow noreferrer\">an open-source lib</a> with additional test annotations for OAuth2 / OpenID)",
    "score" : 0,
    "owner" : {
      "account_id" : 308139,
      "reputation" : 13854,
      "user_id" : 619830,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/f4d00b0a82e9307b1d68b29867fee4e5?s=256&d=identicon&r=PG",
      "display_name" : "ch4mp",
      "link" : "https://stackoverflow.com/users/619830/ch4mp"
    },
    "creation_date" : 1761113359,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79795607" : [ {
      "comment_id" : 140808157,
      "post_id" : 79795607,
      "body" : "Thanks, that helps with the failing unit tests where I do not care about web security. However, I also want to test things like turning role validation on or off, so I&#39;m still interested in solutions which do make use of filters",
      "score" : 0,
      "owner" : {
        "account_id" : 426759,
        "reputation" : 12702,
        "user_id" : 808151,
        "user_type" : "registered",
        "accept_rate" : 91,
        "profile_image" : "https://www.gravatar.com/avatar/8a5d431123d4563c74f239c50213bdff?s=256&d=identicon&r=PG",
        "display_name" : "Tim Meyer",
        "link" : "https://stackoverflow.com/users/808151/tim-meyer"
      },
      "creation_date" : 1761037903,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}