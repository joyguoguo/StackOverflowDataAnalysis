{
  "question" : {
    "question_id" : 79819132,
    "title" : "How to setup additional CA certificates *on top of* defaults in Java. I can&#39;t change the system wide CA list",
    "body" : "<p>In a rather big application there is the need to connect to various https://... hosts (web services, rest services, html scraping etc).</p>\n<p>Quite a few of the hosts suffers from various ssl problems (self signed cert, broken cert chain) or simply the root cert is not in the system wide trusted CA list.</p>\n<p>Until now the problem was &quot;solved&quot; by setting an &quot;all trusting&quot; X509TrustManager in the appropriate places.</p>\n<p>Now I have to stop this practice ( security audit... ).</p>\n<p>I can not change the environment's CA list.</p>\n<p>I would like to add the few problematic leaf-certs and root-certs centrally. My first thought was to create a JKS keystore with the certs and register it with the following JVM option:</p>\n<pre><code>-Djavax.net.ssl.trustStore=additional_CAs_truststore.jks\n</code></pre>\n<p>However, the result is that the system-wide certs are not considered then, and the application can only connect to the &quot;problematic&quot; sites, and not for example to &quot;https://google.com&quot;.</p>\n<p>Then I saw an example of a &quot;delegating trust manager&quot; which looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class TrustManagerDelegate implements X509TrustManager {\n    private final X509TrustManager mainTrustManager;\n    private final X509TrustManager fallbackTrustManager;\n\n    public TrustManagerDelegate(X509TrustManager mainTrustManager, X509TrustManager fallbackTrustManager) {\n        this.mainTrustManager = mainTrustManager;\n        this.fallbackTrustManager = fallbackTrustManager;\n    }\n\n...\n\n    @Override\n    public void checkServerTrusted(final X509Certificate[] x509Certificates, final String authType) throws CertificateException {\n        try {\n            mainTrustManager.checkServerTrusted(x509Certificates, authType);\n        } catch(CertificateException ignored) {\n            this.fallbackTrustManager.checkServerTrusted(x509Certificates, authType);\n        }\n    }\n\n    @Override\n    public X509Certificate[] getAcceptedIssuers() {\n        return this.fallbackTrustManager.getAcceptedIssuers();\n    }\n}\n</code></pre>\n<p>With that trust manager, my code would look like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    public void run(String... args) throws Exception {\n\n        final TrustManagerFactory javaDefaultTrustManager = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n        javaDefaultTrustManager.init((KeyStore) null);\n\n        final TrustManagerFactory additionalCaTrustManager = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n        KeyStore ks = KeyStore.getInstance(&quot;JKS&quot;);\n        InputStream is = new FileInputStream(&quot;additional_CAs_truststore.jks&quot;);\n        ks.load(is, &quot;changeit&quot;.toCharArray());\n        is.close();\n        additionalCaTrustManager.init(ks);\n\n        for(X509Certificate x509Certificate : ((X509TrustManager)javaDefaultTrustManager.getTrustManagers()[0]).getAcceptedIssuers()) {\n            System.out.println(&quot;Accepted issuer from java default trust manager: &quot; + x509Certificate.getIssuerX500Principal());\n        }\n        for(X509Certificate x509Certificate : ((X509TrustManager)additionalCaTrustManager.getTrustManagers()[0]).getAcceptedIssuers()) {\n            System.out.println(&quot;Accepted issuer from additional trust manages: &quot; + x509Certificate.getIssuerX500Principal());\n        }\n\n        SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);\n        sslContext.init(\n                null,\n                new TrustManager[]{\n                        new TrustManagerDelegate(\n                                (X509TrustManager)additionalCaTrustManager.getTrustManagers()[0],\n                                (X509TrustManager)javaDefaultTrustManager.getTrustManagers()[0]\n                        )\n                },\n                secureRandom\n        );\n        SSLContext.setDefault(sslContext);\n\n        {\n            String content = Request.get(&quot;https://google.com&quot;).execute().returnContent().asString();\n            System.out.println(&quot;google.com content length: &quot;  + content.length());\n        }\n\n        {\n            String content = Request.get(&quot;https://untrusted-root.badssl.com/&quot;).execute().returnContent().asString();\n            System.out.println(&quot;untrusted-root.badssl.com content length: &quot; + content.length());\n        }\n\n        {\n            String content = Request.get(&quot;https://teszt.kv.gov.hu/&quot;).execute().returnContent().asString();\n            System.out.println(&quot;teszt.kv.gov.hu content length: &quot; + content.length());\n        }\n\n    }\n</code></pre>\n<p>The above works, and I rather like it.</p>\n<p>But I would like to know if there is a better / more straightforward way to set up additional trusted CA certs <em><strong>on top of</strong></em> the system wide set of CA certs.</p>\n<p>Here is a working demo:</p>\n<p><a href=\"https://github.com/riskop/merging_trust_manager_demo\" rel=\"nofollow noreferrer\">https://github.com/riskop/merging_trust_manager_demo</a></p>\n<hr />\n<p>After the ideas received I created another demo which shows both the &quot;merging&quot; and the &quot;delegating&quot; strategies:</p>\n<p><a href=\"https://github.com/riskop/merging_or_delagating_trustmanager_demo\" rel=\"nofollow noreferrer\">https://github.com/riskop/merging_or_delagating_trustmanager_demo</a></p>\n",
    "tags" : [ "java", "ssl", "sslcontext", "trustmanager", "x509trustmanager" ],
    "owner" : {
      "account_id" : 4639875,
      "reputation" : 1839,
      "user_id" : 3760049,
      "user_type" : "registered",
      "accept_rate" : 86,
      "profile_image" : "https://www.gravatar.com/avatar/69ed405cd4036cdf27e003ca372c6d1c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "riskop",
      "link" : "https://stackoverflow.com/users/3760049/riskop"
    },
    "is_answered" : true,
    "view_count" : 71,
    "answer_count" : 4,
    "score" : 0,
    "last_activity_date" : 1764950893,
    "creation_date" : 1763050186,
    "link" : "https://stackoverflow.com/questions/79819132/how-to-setup-additional-ca-certificates-on-top-of-defaults-in-java-i-cant-ch",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79819253,
    "question_id" : 79819132,
    "body" : "<p><a href=\"https://www.baeldung.com/java-custom-truststore\" rel=\"nofollow noreferrer\">https://www.baeldung.com/java-custom-truststore</a> article with a very similar code approach. Suggests another simple option: merge the system keystore with yours. (presumably needs to be re-run after system updates)</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19435569,
      "reputation" : 2968,
      "user_id" : 21105992,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKQkV.png?s=256",
      "display_name" : "teapot418",
      "link" : "https://stackoverflow.com/users/21105992/teapot418"
    },
    "creation_date" : 1763055641,
    "last_activity_date" : 1763055641,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79819405,
    "question_id" : 79819132,
    "body" : "<p>What you have is simple and, more importantly, works.  And if the system trust store gets updated, you don't need to refresh any copy.</p>\n<p>Code to create a trust manager with all trusted CAs merged will be a lot more complex as it would have to explicitly copy CA certs from one trust store to another.  So you'd still have to load two trust stores, and instead of simply checking a server's cert against them in sequence using five lines of easy-to-understand code, you'd have to write a lot more code to copy certs.</p>\n<p>A try-catch is a <strong>lot</strong> faster than any TLS negotiation, so any performance difference is going to be negligible, if you can measure it at all.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 6095312,
      "reputation" : 35126,
      "user_id" : 4756299,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6fe43a9d31f2308c4e64a62cf0c310d1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Andrew Henle",
      "link" : "https://stackoverflow.com/users/4756299/andrew-henle"
    },
    "creation_date" : 1763065848,
    "last_activity_date" : 1763065848,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79824882,
    "question_id" : 79819132,
    "body" : "<p>I would load my custon KeyStore as well as the Java system keystore and then merge them at run-time into one KeyStore (copy certs from system keystore into the custom).\nAnd finally use it to initialize a standard TrustManager:</p>\n<pre><code>trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\ntrustManagerFactory.init(myTrustStore);\n</code></pre>\n<p>Do that when your app starts so you only have to do it once and then you can use the TrustManager where ever you want.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 50585,
      "reputation" : 43469,
      "user_id" : 150978,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
      "display_name" : "Robert",
      "link" : "https://stackoverflow.com/users/150978/robert"
    },
    "creation_date" : 1763582758,
    "last_activity_date" : 1763582758,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79839091,
    "question_id" : 79819132,
    "body" : "<p>What you can do is:</p>\n<pre class=\"lang-java prettyprint-override\"><code>SSLFactory sslFactory = SSLFactory.builder()\n        .withDefaultTrustMaterial()\n        .withSystemTrustMaterial()\n        .withTrustMaterial(Paths.get(&quot;/path/to/your/additional_CAs_truststore.jks&quot;), &quot;changeit&quot;.toCharArray(), &quot;JKS&quot;)\n        .build();\n\nSSLContext.setDefault(sslFactory.getSslContext());\n</code></pre>\n<p>The setup above will use the jdk cacert, OS truststore from mac/windows/linux and additionally your own truststore jks file. It uses a similar pattern as your custom trustmanager to combine multiple trustmanagers. The above snippet is available here at my github page as a library: <a href=\"https://github.com/Hakky54/ayza\" rel=\"nofollow noreferrer\">https://github.com/Hakky54/ayza</a> I hope you will like it :)</p>\n<p>You can even use the option <code>withInflatableTrustMaterial</code> to dynamically add additional trusted certificates at runtime without recreating the SSLContext.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 9107988,
      "reputation" : 4087,
      "user_id" : 6777695,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/82120153a9fce415fd4983897d45d441?s=256&d=identicon&r=PG",
      "display_name" : "Hakan54",
      "link" : "https://stackoverflow.com/users/6777695/hakan54"
    },
    "creation_date" : 1764950893,
    "last_activity_date" : 1764950893,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}