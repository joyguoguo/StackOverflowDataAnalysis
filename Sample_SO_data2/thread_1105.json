{
  "question" : {
    "question_id" : 79747115,
    "title" : "Cannot extend Spark UnaryExpression in Java",
    "body" : "<p>I am trying to write a custom decoder function in Java targeting Spark 4.0:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class MyDataToCatalyst extends UnaryExpression implements NonSQLExpression, ExpectsInputTypes, Serializable {\n\n   //...\n\n}\n</code></pre>\n<p>However, I cannot get this to compile, because the class definition of <code>UnaryExpression</code> is invalid according to Java type hierarchy rules: The two final methods implementing its Scala trait <code>UnaryLike[Epression]</code> have an invalid return type:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public abstract class UnaryExpression extends Expression implements UnaryLike&lt;Expression&gt; {\n\n  public final TreeNode mapChildren(Function1);\n  public final TreeNode withNewChildrenInternal(IndexedSeq);\n\n  //...\n}\n\n</code></pre>\n<p><code>UnaryExpression</code> extends <code>Expression</code>, which is a <code>TreeNode&lt;Expression&gt;</code> and hence should have a return type of <code>Expression</code> for these two methods. And the same goes for <code>UnaryLike&lt;Expression&gt;</code>.</p>\n<p>The compiler fails with these errors accordingly:</p>\n<pre><code>'mapChildren(Function1)' in 'org.apache.spark.sql.catalyst.expressions.UnaryExpression' clashes with 'mapChildren(Function1&lt;BaseType, BaseType&gt;)' in 'org.apache.spark.sql.catalyst.trees.TreeNode'; incompatible return type\n'withNewChildrenInternal(IndexedSeq)' in 'org.apache.spark.sql.catalyst.expressions.UnaryExpression' clashes with 'withNewChildrenInternal(IndexedSeq&lt;BaseType&gt;)' in 'org.apache.spark.sql.catalyst.trees.TreeNode'; incompatible return type\n</code></pre>\n<p>This actually looks like a bug in the Scala compiler to me, generating a bad class file.</p>\n<p>If the methods were not final, I could have probably just overridden them in my subclass to fix the issue, but this way, I'm stuck.</p>\n",
    "tags" : [ "java", "apache-spark", "apache-spark-sql" ],
    "owner" : {
      "account_id" : 1181771,
      "reputation" : 1288,
      "user_id" : 1156561,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cfa23205cce07923a8c4e3f4b0824389?s=256&d=identicon&r=PG",
      "display_name" : "Carsten",
      "link" : "https://stackoverflow.com/users/1156561/carsten"
    },
    "is_answered" : false,
    "view_count" : 75,
    "answer_count" : 0,
    "score" : 3,
    "last_activity_date" : 1756227577,
    "creation_date" : 1756227577,
    "link" : "https://stackoverflow.com/questions/79747115/cannot-extend-spark-unaryexpression-in-java",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140695496,
    "post_id" : 79747115,
    "body" : "ah well, I fear it&#39;ll be a far bigger hurdle trying to use Java even if this language mismatch issue didn&#39;t exist, you only need Scala for the bits that directly interact/extend and a lot of that you can copy and paste from other projects e.g. this <a href=\"https://github.com/sparkutils/quality/blob/7d7958c76ba7ba78e385192032540e480c976304/src/main/scala/com/sparkutils/quality/impl/SoftFailExpr.scala\" rel=\"nofollow noreferrer\">simple example</a>. There is nothing stopping those bits of code calling your java code. Best of luck",
    "score" : 0,
    "owner" : {
      "account_id" : 1017255,
      "reputation" : 2980,
      "user_id" : 1028537,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f929a8e1ab37c0667f6991744a3f3ca1?s=256&d=identicon&r=PG",
      "display_name" : "Chris",
      "link" : "https://stackoverflow.com/users/1028537/chris"
    },
    "creation_date" : 1756289148,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140695411,
    "post_id" : 79747115,
    "body" : "The reason is that we&#39;re a Java shop, and having to use Scala will be a big hurdle for the team(s), both in terms of know-how and in terms of willingness. The custom expression has several reasons, one being that it sits in the innermost loop of a structured streaming pipeline, and the other that I&#39;m using a bunch of Spark code that deals with InternalRow.",
    "score" : 0,
    "owner" : {
      "account_id" : 1181771,
      "reputation" : 1288,
      "user_id" : 1156561,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cfa23205cce07923a8c4e3f4b0824389?s=256&d=identicon&r=PG",
      "display_name" : "Carsten",
      "link" : "https://stackoverflow.com/users/1156561/carsten"
    },
    "creation_date" : 1756286660,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140695000,
    "post_id" : 79747115,
    "body" : "Don&#39;t attempt to extend Spark with Java, simply use Scala directly.  Is there a reason why you must use Java?  Also be aware although creating custom expressions is awesome for performance and optimisation options you will hit source (and runtime) compatibility issues for each minor release (and sometimes builds).",
    "score" : 0,
    "owner" : {
      "account_id" : 1017255,
      "reputation" : 2980,
      "user_id" : 1028537,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f929a8e1ab37c0667f6991744a3f3ca1?s=256&d=identicon&r=PG",
      "display_name" : "Chris",
      "link" : "https://stackoverflow.com/users/1028537/chris"
    },
    "creation_date" : 1756273981,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140693894,
    "post_id" : 79747115,
    "body" : "I don&#39;t know my way around Scala enough, but this looks suspiciously like this issue: <a href=\"https://github.com/scala/bug/issues/6103\" rel=\"nofollow noreferrer\">github.com/scala/bug/issues/6103</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 1181771,
      "reputation" : 1288,
      "user_id" : 1156561,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cfa23205cce07923a8c4e3f4b0824389?s=256&d=identicon&r=PG",
      "display_name" : "Carsten",
      "link" : "https://stackoverflow.com/users/1156561/carsten"
    },
    "creation_date" : 1756228976,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}