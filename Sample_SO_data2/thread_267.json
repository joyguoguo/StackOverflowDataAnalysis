{
  "question" : {
    "question_id" : 79825366,
    "title" : "MultiResourceItemWriter does not work with transactional StaxEventItemWriter",
    "body" : "<p>I configured a <code>StaxEventItemWriter</code> like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic StaxEventItemWriter&lt;Foo&gt; fooWriter() {\n    return new StaxEventItemWriterBuilder&lt;Foo&gt;()\n        .name(&quot;fooWriter&quot;)\n        .marshaller(marshaller())\n        .rootTagName(&quot;foos&quot;)\n        .build();\n}\n</code></pre>\n<p>And a <code>MultiResourceItemWriter</code> like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic MultiResourceItemWriter&lt;Foo&gt; multiFooWriter() {\n    return new MultiResourceItemWriterBuilder&lt;Foo&gt;()\n        .name(&quot;multiFooWriter&quot;)\n        .delegate(fooWriter())\n        .itemCountLimitPerResource(100)\n        .resourceSuffixCreator(index -&gt; &quot;-&quot; + index + &quot;.xml&quot;)\n        .resource(new FileSystemResource(&quot;foo&quot;))\n        .build();\n}\n</code></pre>\n<p>However, when I run a batch using these writers, I get the following exception:</p>\n<pre><code>Caused by: java.nio.channels.ClosedChannelException: null\n    at java.base/sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:160) ~[na:na]\n    at java.base/sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:284) ~[na:na]\n    at org.springframework.batch.support.transaction.TransactionAwareBufferedWriter$1.complete(TransactionAwareBufferedWriter.java:121) ~[spring-batch-infrastructure-5.2.4.jar:5.2.4]\n    at org.springframework.batch.support.transaction.TransactionAwareBufferedWriter$1.beforeCommit(TransactionAwareBufferedWriter.java:106) ~[spring-batch-infrastructure-5.2.4.jar:5.2.4]\n    ... 44 common frames omitted\n</code></pre>\n<p>I noticed it seems to have something to do with the transactional flushing, so I tried disabling transactions on the <code>StaxEventItemWriter</code> and then it indeed works:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic StaxEventItemWriter&lt;Foo&gt; fooWriter() {\n    return new StaxEventItemWriterBuilder&lt;Foo&gt;()\n        .name(&quot;fooWriter&quot;)\n        .marshaller(marshaller())\n        .rootTagName(&quot;foos&quot;)\n        .transactional(false) // Adding this works\n        .build();\n}\n</code></pre>\n<p>In addition, if I write to a single large XML file (eg. by using <code>fooWriter()</code> directly in my <code>Step</code> configuration in stead of <code>multiFooWriter()</code>), then the job also succeeds.</p>\n<p>Is there a reason why <code>StaxEventItemWriter</code> combined with <code>MultiResourceItemWriter</code> does not work with transactions?</p>\n<p>For completeness of the example, this is the <code>Foo</code> class I used and the <code>ItemReader</code> (but that's irrelevant to the question as the problem occurs with any reader/JAXB class):</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Getter\n@XmlRootElement(name = &quot;foo&quot;)\n@XmlType(propOrder = { &quot;itemCount&quot; })\n@NoArgsConstructor\npublic class Foo implements ItemCountAware {\n    private int itemCount;\n\n    @Override\n    @XmlElement(name = &quot;count&quot;)\n    public void setItemCount(int count) {\n        this.itemCount = count;\n    }\n}\n</code></pre>\n<p>For the reader I'm using <code>AbstractItemCountingItemStreamItemReader</code> in combination with <code>ItemCountAware</code> to generate some unique <code>Foo</code> POJO's (but it's irrelevant to the problem):</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class FooReader extends AbstractItemCountingItemStreamItemReader&lt;Foo&gt; {\n    public FooReader() {\n        setName(&quot;fooReader&quot;);\n        setMaxItemCount(10000);\n    }\n\n    @Override\n    protected Foo doRead() {\n        return new Foo();\n    }\n\n    @Override\n    protected void doOpen() {\n\n    }\n\n    @Override\n    protected void doClose() {\n\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-batch", "spring-transactions" ],
    "owner" : {
      "account_id" : 2161358,
      "reputation" : 45221,
      "user_id" : 1915448,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/51afb9344f8a44e60916753d37186513?s=256&d=identicon&r=PG",
      "display_name" : "Dimitri Mestdagh",
      "link" : "https://stackoverflow.com/users/1915448/dimitri-mestdagh"
    },
    "is_answered" : false,
    "view_count" : 46,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1763645932,
    "creation_date" : 1763633246,
    "link" : "https://stackoverflow.com/questions/79825366/multiresourceitemwriter-does-not-work-with-transactional-staxeventitemwriter",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140865831,
    "post_id" : 79825366,
    "body" : "I know, I was planning on making an issue/PR as soon as I&#39;m 100% certain it&#39;s a non-compatible scenario so my plan was to add a bounty tomorrow to ask for an authoritative answer and once confirmed I&#39;d make a PR.",
    "score" : 0,
    "owner" : {
      "account_id" : 2161358,
      "reputation" : 45221,
      "user_id" : 1915448,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/51afb9344f8a44e60916753d37186513?s=256&d=identicon&r=PG",
      "display_name" : "Dimitri Mestdagh",
      "link" : "https://stackoverflow.com/users/1915448/dimitri-mestdagh"
    },
    "creation_date" : 1763716249,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140865736,
    "post_id" : 79825366,
    "body" : "The fact that it isn&#39;t documented doesn&#39;t mean it doesn&#39;t apply! So I would suggest opening a ticket to add this to the documentation, probably of the <code>TransactionAwareBufferedWriter</code> and/or the <code>MultiResourceItemWriter</code> as that manages the writing and opening of files itself.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763712374,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140865688,
    "post_id" : 79825366,
    "body" : "I assume that as well, though I can&#39;t find any reference within the documentation that it wouldn&#39;t be supported (maybe I&#39;m looking wrong though).",
    "score" : 0,
    "owner" : {
      "account_id" : 2161358,
      "reputation" : 45221,
      "user_id" : 1915448,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/51afb9344f8a44e60916753d37186513?s=256&d=identicon&r=PG",
      "display_name" : "Dimitri Mestdagh",
      "link" : "https://stackoverflow.com/users/1915448/dimitri-mestdagh"
    },
    "creation_date" : 1763709637,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140864587,
    "post_id" : 79825366,
    "body" : "Well then I suspect  it isn&#39;t compatible. Which sort of makes sense. As the buffer assumes that a file-channel is open, but midway of writing it could be suddenly swapped to a new resource due to the limit being reached (new file, new file channel) so the original one has closed.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763652280,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140864407,
    "post_id" : 79825366,
    "body" : "That didn&#39;t have any effect sadly. I updated my question to include the more specific class names.",
    "score" : 0,
    "owner" : {
      "account_id" : 2161358,
      "reputation" : 45221,
      "user_id" : 1915448,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/51afb9344f8a44e60916753d37186513?s=256&d=identicon&r=PG",
      "display_name" : "Dimitri Mestdagh",
      "link" : "https://stackoverflow.com/users/1915448/dimitri-mestdagh"
    },
    "creation_date" : 1763646000,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140864310,
    "post_id" : 79825366,
    "body" : "Try returning <code>MultiResourceItemWriter</code> instead of <code>ItemWriter</code> as that will also expose additional callbacks methods. Try to be as specific as you can when returning from <code>@Bean</code> methods.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763643065,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}