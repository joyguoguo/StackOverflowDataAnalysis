{
  "question" : {
    "question_id" : 79810911,
    "title" : "Issue with Jakarta Mail - MessageCountAdapter doesn&#39;t seem to work",
    "body" : "<p>I'm encountering an issue while using Jakarta Mail to fetch emails and capture specific keywords. Here's the details:</p>\n<h2>The source code is as follows:</h2>\n<pre class=\"lang-java prettyprint-override\"><code>package org.example.receiver.kit.component;\n\nimport jakarta.mail.Folder;\nimport jakarta.mail.Message;\nimport jakarta.mail.MessagingException;\nimport jakarta.mail.Session;\nimport jakarta.mail.Store;\nimport jakarta.mail.event.MessageCountAdapter;\nimport jakarta.mail.event.MessageCountEvent;\nimport lombok.NonNull;\nimport org.eclipse.angus.mail.imap.IdleManager;\nimport org.springframework.stereotype.Component;\n\nimport java.io.Closeable;\nimport java.io.IOException;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\nimport java.util.function.Consumer;\nimport java.util.logging.Logger;\n\n@Component\npublic class MailReceiver implements Receiver {\n    public static final Logger logger = Logger.getLogger(MailReceiver.class.getName());\n    public static final String INBOX = &quot;INBOX&quot;;\n\n    public static class CustomMessageCountAdapter extends MessageCountAdapter {\n       private final IdleManager idleManager;\n       private final Folder inbox;\n       private final Consumer&lt;Message[]&gt; messageConsumer;\n\n       public CustomMessageCountAdapter(IdleManager idleManager, Folder inbox, Consumer&lt;Message[]&gt; messageConsumer) {\n          this.idleManager = idleManager;\n          this.inbox = inbox;\n          this.messageConsumer = messageConsumer;\n       }\n\n       @Override\n       public void messagesAdded(MessageCountEvent e) {\n          logger.info(&quot;Receive&quot; + e.getMessages().length + &quot;mail(s)&quot;);\n          messageConsumer.accept(e.getMessages());\n\n          try {\n             idleManager.watch(inbox);\n          } catch (MessagingException ex) {\n             throw new RuntimeException(ex);\n          }\n       }\n\n       @Override\n       public void messagesRemoved(MessageCountEvent e) {\n          logger.info(&quot;Delete&quot; + e.getMessages().length + &quot;mail(s)&quot;);\n          messageConsumer.accept(e.getMessages());\n\n          try {\n             idleManager.watch(inbox);\n          } catch (MessagingException ex) {\n             throw new RuntimeException(ex);\n          }\n       }\n    }\n\n    public record MailProcessCleaner(Store mailStore, Folder inbox, ExecutorService es) implements Closeable {\n       public static final Logger logger = Logger.getLogger(MailReceiver.class.getName());\n       @Override\n          public void close() throws IOException {\n             try {\n                if (inbox.isOpen()) {\n                   inbox.close();\n                   logger.info(&quot;Mail server was closed&quot;);\n                }\n                if (mailStore.isConnected()) {\n                   mailStore.close();\n                   logger.info(&quot;Disconnection&quot;);\n                }\n                es.shutdown();\n                logger.info(&quot;Close thread pool&quot;);\n             } catch (MessagingException e) {\n                throw new RuntimeException(e);\n             }\n          }\n       }\n\n    @Override\n    public MailProcessCleaner receive(Consumer&lt;Message[]&gt; messageConsumer, @NonNull MailSessionProvider sessionProvider) throws MessagingException {\n       Session session = sessionProvider.provide();\n       ExecutorService es = Executors.newCachedThreadPool();\n       try {\n          IdleManager idleManager = new IdleManager(session, es);\n\n          Store mailStore = session.getStore();\n          mailStore.connect();\n\n          Folder inbox = mailStore.getFolder(INBOX);\n          inbox.open(Folder.READ_ONLY);\n\n          inbox.addMessageCountListener(getMessageCountAdapter(idleManager, inbox, messageConsumer));\n\n          idleManager.watch(inbox);\n\n          // messageConsumer.accept(inbox.getMessages());\n\n          return new MailProcessCleaner(mailStore, inbox, es);\n\n       } catch (IOException e) {\n          throw new RuntimeException(e);\n       }\n    }\n\n    protected MessageCountAdapter getMessageCountAdapter(IdleManager idleManager, Folder inbox, Consumer&lt;Message[]&gt; messageConsumer) {\n       return new CustomMessageCountAdapter(idleManager, inbox, messageConsumer);\n    }\n\n}\n</code></pre>\n<p><strong>My Configuration:</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>package org.example.receiver.kit.component;\n\nimport jakarta.mail.Authenticator;\nimport jakarta.mail.PasswordAuthentication;\nimport jakarta.mail.Session;\nimport lombok.Getter;\n\nimport java.util.Properties;\nimport java.util.logging.Logger;\n\n@Getter\npublic abstract class MailSessionProvider implements Provider {\n    public static final Logger logger = Logger.getLogger(MailSessionProvider.class.getName());\n    private final String username;\n    private final String protocol;\n    private final String host;\n    private final Integer port;\n    private final boolean sslEnabled;\n    public static final String PASSWORD_ENV_KEY = &quot;__MAIL_PASSWORD&quot;;\n\n    protected Properties defaultProperties = new Properties();\n\n\n    public MailSessionProvider(String username, String protocol, String host, Integer port, boolean sslEnabled) {\n       this.username = username;\n       this.protocol = protocol;\n       this.host = host;\n       this.port = port;\n       this.sslEnabled = sslEnabled;\n       createDefaultProperties();\n    }\n\n\n    private void createDefaultProperties() {\n       // https://jakarta.ee/specifications/mail/2.1/jakarta-mail-spec-2.1#a823\n       defaultProperties.setProperty(&quot;mail.store.protocol&quot;, this.protocol);\n       defaultProperties.setProperty(&quot;mail.imap.host&quot;, this.host);\n       defaultProperties.setProperty(&quot;mail.imap.port&quot;, String.valueOf(this.port));\n       defaultProperties.setProperty(&quot;mail.imap.ssl.enable&quot;, String.valueOf(this.sslEnabled));\n       defaultProperties.setProperty(&quot;mail.imap.starttls.enable&quot;, &quot;false&quot;);\n//     defaultProperties.setProperty(&quot;mail.imap.nio.enable&quot;, &quot;true&quot;);\n       defaultProperties.setProperty(&quot;mail.imap.usesocketchannels&quot;, &quot;true&quot;);\n    }\n\n    @Override\n    public Session provide() {\n       Properties properties = getConnectionProperties();\n\n       if (properties == null) {\n          properties = defaultProperties;\n       }\n\n       return Session.getInstance(\n             properties,\n             new Authenticator() {\n                @Override\n                protected PasswordAuthentication getPasswordAuthentication() {\n                   return new PasswordAuthentication(username, getPassword());\n                }\n             });\n    }\n\n    public final String getPassword() {\n       return System.getenv(PASSWORD_ENV_KEY);\n    }\n\n\n    @Override\n    public Properties getConnectionProperties() {\n       return defaultProperties;\n    }\n\n    protected void setDefaultProperty(String key, String value) {\n       defaultProperties.setProperty(key, value);\n    }\n}\n</code></pre>\n<p><strong>Entry:</strong></p>\n<pre><code>@Autowired\nFeishuMailSessionProvider feishuMailSessionProvider;\n\n@Autowired\nFeishuMailReceiver feishuMailReceiver;\n@Test\npublic void test() throws MessagingException {\n    MailReceiver.MailProcessCleaner cleaner = feishuMailReceiver.receive((messages) -&gt; {\n       try {\n          for (Message message : messages) {\n             System.out.println(&quot;Got&quot; + Arrays.toString(message.getFrom()));\n             System.out.println(message.getSubject());\n             System.out.println(message.getContent());\n\n          }\n       } catch (IOException | MessagingException e) {\n          throw new RuntimeException(e);\n       }\n       System.out.println(messages.length);\n    }, feishuMailSessionProvider);\n\n    for(;;);\n}\n</code></pre>\n<h2>**Environment:**</h2>\n<ul>\n<li><p>JDK 17</p>\n</li>\n<li><p>spring-boot-starter-mail</p>\n</li>\n<li><p>Test email: Feishu Mail (a Chinese email provider)</p>\n</li>\n</ul>\n<h2><strong>Problem Description:</strong></h2>\n<p>The program works well for a period after startup. When I send test emails to the registered email address, it successfully receives them and triggers notifications—I get the message &quot;Receive 1 mail(s)&quot;.</p>\n<p>However, there are two odd behaviors:</p>\n<ol>\n<li><p>It no longer sends notifications when I delete emails. While this doesn't affect my current functionality, I'm curious about the reason.</p>\n</li>\n<li><p>After the program runs for about 30mins, the <code>MessageCountAdapter</code> seems to stop receiving new emails and doesn't invoke my overridden <code>messagesAdded</code> method. However, if I send the email within 1–5 minutes of the program starting, it works fine—running for 6 minutes, 10 minutes, or even longer (I haven’t tested the upper limit yet).</p>\n</li>\n</ol>\n<p>Could someone please explain this behavior?</p>\n",
    "tags" : [ "java", "spring-boot", "jakarta-mail", "imap" ],
    "owner" : {
      "account_id" : 44576597,
      "reputation" : 3,
      "user_id" : 31824503,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9de6e53b25672c8d0e9f29ec9b3f4adf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Wu Jingkai",
      "link" : "https://stackoverflow.com/users/31824503/wu-jingkai"
    },
    "is_answered" : true,
    "view_count" : 71,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762478920,
    "creation_date" : 1762411357,
    "link" : "https://stackoverflow.com/questions/79810911/issue-with-jakarta-mail-messagecountadapter-doesnt-seem-to-work",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79811903,
    "question_id" : 79810911,
    "body" : "<p>The 30 minutes you see is very likely <a href=\"https://datatracker.ietf.org/doc/html/rfc9051#section-5.4\" rel=\"nofollow noreferrer\">the autologout timer</a>: «If a server has an inactivity autologout timer that applies to sessions after authentication, the duration of that timer <strong>MUST</strong> be at least 30 minutes.»</p>\n<p>The next sentence in the RFC hints to a solution: «The receipt of any command from the client during that interval resets the autologout timer.»</p>\n<p>Call <code>((IMAPFolder)inbox).forceCheckExpunged()</code> every ten minutes or so. That'll send a NOOP command, which also has the side effect of telling the server that now's a good time to tell you about expunged (deleted) messages, and the side-side-side effect of telling any NAT middleboxes along the route that the connection is in use.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 458052,
      "reputation" : 9828,
      "user_id" : 857727,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/84bba24809d75c2a17a89538b0ed993b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "arnt",
      "link" : "https://stackoverflow.com/users/857727/arnt"
    },
    "creation_date" : 1762478920,
    "last_activity_date" : 1762478920,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}