{
  "question" : {
    "question_id" : 79704352,
    "title" : "ForegroundServiceDidNotStartInTimeException when using startForegroundService() with FusedLocation API",
    "body" : "<p>I have one issue in foreground service and I am unable to replicate that issue, so if any one found similar issue can you please help me to solve this issue.</p>\n<p>Below is the issue reported in Firebase Crashlytics:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Fatal Exception: android.app.RemoteServiceException$ForegroundServiceDidNotStartInTimeException\nContext.startForegroundService() did not then call Service.startForeground(): \nServiceRecord{91bb8e7 u0 com.londonserenitytherapist/.serviceandbroadcast.BookingTrackingForgroundService \nc:com.londonserenitytherapist}\nCaused by android.app.StackTrace\nLast startServiceCommon() call for this service was made here\n</code></pre>\n<p>Below is my foreground service which I used for sending location to server for location monitoring:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class BookingTrackingForgroundService extends Service {\n    @Nullable\n    @Override\n    public IBinder onBind(Intent intent) {\n        return null;\n    }\n\n    @Override\n    public void onCreate() {\n        super.onCreate();\n        apiHelper = new ApiHelper(getApplicationContext());\n        applicationContext = getApplicationContext();\n        detectBetteryLow();\n    }\n\n    @Override\n    public int onStartCommand(Intent intent, int flags, int startId) {\n        if (intent != null) {\n            String action = intent.getAction();\n\n            assert action != null;\n            switch (action) {\n                case ACTION_START_FOREGROUND_SERVICE:\n                    Log.d(&quot;BookingService&quot;, &quot;onStartCommand received action: &quot; + action);\n                    startTrackingForeground();\n                    break;\n                case ACTION_STOP_FOREGROUND_SERVICE:\n                    stopForegroundService();\n                    break;\n            }\n        }\n        return START_STICKY;\n    }\n private void startTrackingForeground() {\n        Log.d(&quot;BookingService&quot;, &quot;Starting foreground service setup...&quot;);\n\n        context = this;\n        startLocationUpdates();\n        Log.d(&quot;BookingService&quot;, &quot;Location updates started.&quot;);\n        notify_interval1 = Prefs.with(this).readLong(&quot;notify_interval1&quot;, 5000);\n        mTimer = new Timer();\n        mTimer.scheduleAtFixedRate(new TimerTaskToGetLocation(), 20000, notify_interval1);\n        mTimer.scheduleAtFixedRate(new TimerTaskToSendCsvFile(), 60000, 1800000); // Delay 1 min and period is 30 min\n//        mTimer.scheduleAtFixedRate(new TimerTaskToSendCsvFile(), 60000, 600000); // Delay 1 min and period is 10 min\n        prefsPrivate = getSharedPreferences(Constants.prefsKeys.PREFS_PRIVATE, Context.MODE_PRIVATE);\n        internet = new NetConnectionService(context);\n        Log.d(&quot;BookingService&quot;, &quot;Timers scheduled.&quot;);\n\n        Intent notificationIntent = new Intent(this, ActTherapistDashboard.class);\n        notificationIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TASK | Intent.FLAG_ACTIVITY_NEW_TASK);\n        PendingIntent pendingIntent = PendingIntent.getActivity(this, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);\n\n        NotificationCompat.Builder builder = new NotificationCompat.Builder(this, CHANNEL_ID)\n                .setContentTitle(getString(R.string.app_name))\n                .setContentText(&quot;Geolocation is running&quot;)\n                .setTicker(&quot;Geolocation&quot;).setSmallIcon(R.drawable.app_small_icon_white)\n                .setContentIntent(pendingIntent)\n                .setPriority(NotificationCompat.PRIORITY_HIGH) // High priority\n                .setOngoing(true) // Mark as ongoing\n                .setCategory(NotificationCompat.CATEGORY_SERVICE)\n                .setVisibility(NotificationCompat.VISIBILITY_PUBLIC); // Visible on lock screen\n\n\n        Notification notification = builder.build();\n        notification.flags |= Notification.FLAG_ONGOING_EVENT; // Sticky notification\n\n        if (Build.VERSION.SDK_INT &gt;= 26) {\n            NotificationChannel channel = new NotificationChannel(CHANNEL_ID, CHANNEL_NAME, NotificationManager.IMPORTANCE_HIGH);\n            channel.setLockscreenVisibility(Notification.VISIBILITY_PUBLIC);\n            channel.setDescription(CHANNEL_DESCRIPTION);\n            NotificationManager notificationManager = (NotificationManager) getSystemService(Context.NOTIFICATION_SERVICE);\n            notificationManager.createNotificationChannel(channel);\n            Log.d(&quot;BookingService&quot;, &quot;Notification channel created.&quot;);\n        }\n        Log.d(&quot;BookingService&quot;, &quot;Calling startForeground()&quot;);\n        startForeground(SERVICE_ID, notification);\n        Log.d(&quot;BookingService&quot;, &quot;Foreground service started successfully.&quot;);\n    }\n\n private void parsePushLatLong(String result) {\n        response = result;\n        insertIntoDb();\n        try {\n            JSONObject jobj = new JSONObject(result);\n            if (jobj.getString(&quot;FLAG&quot;).equalsIgnoreCase(&quot;true&quot;)) {\n                String IS_FIVE_FLAG = &quot;&quot; + jobj.optString(&quot;IS_FIVE_FLAG&quot;);\n                String IS_TRACKING_ON = &quot;&quot; + jobj.optString(&quot;IS_TRACKING_ON&quot;);\n                long TRACKING_TIME = jobj.optLong(&quot;TRACKING_TIME&quot;);\n\n                if (TRACKING_TIME != 0) {\n                    delayTimeOneMin = TRACKING_TIME * intoMinute;\n                }\n                if (IS_TRACKING_ON.equalsIgnoreCase(&quot;1&quot;)) {\n\n                    if (IS_FIVE_FLAG.equalsIgnoreCase(&quot;0&quot;)) {\n                        if (notify_interval1 != delayTimeOneMin) {\n                            if (isServiceRunningInForeground(context, BookingTrackingForgroundService.class)) {\n                                try {\n                                    stopForegroundService();\n                                    notify_interval1 = delayTimeOneMin;\n                                    Prefs.with(BookingTrackingForgroundService.this).writeLong(&quot;notify_interval1&quot;, notify_interval1);\n                                    Intent intentService = new Intent(context, BookingTrackingForgroundService.class);\n                                    intentService.setAction(BookingTrackingForgroundService.ACTION_START_FOREGROUND_SERVICE);\n                                    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n                                        new Handler(Looper.getMainLooper()).post(new Runnable() {\n                                            @Override\n                                            public void run() {\n                                                if(isAppInForeground(context)) {\n                                                    context.startForegroundService(intentService);\n                                                }\n                                            }\n                                        });\n                                    } else {\n                                        if(isAppInForeground(context)) {\n                                            context.startService(intentService);\n                                        }\n                                    }\n                                } catch (Exception e) {\n                                    e.printStackTrace();\n                                }\n                            }\n\n                        }\n\n\n                    } else if (IS_FIVE_FLAG.equalsIgnoreCase(&quot;1&quot;)) {\n\n                        if (notify_interval1 != delayTimeOneMin) {\n                            if (isServiceRunningInForeground(context, BookingTrackingForgroundService.class)) {\n                                try {\n                                    stopForegroundService();\n                                    notify_interval1 = delayTimeOneMin;\n                                    Prefs.with(BookingTrackingForgroundService.this).writeLong(&quot;notify_interval1&quot;, notify_interval1);\n                                    Intent intentService = new Intent(context, BookingTrackingForgroundService.class);\n                                    intentService.setAction(BookingTrackingForgroundService.ACTION_START_FOREGROUND_SERVICE);\n                                    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n                                        new Handler(Looper.getMainLooper()).post(new Runnable() {\n                                            @Override\n                                            public void run() {\n                                                if(isAppInForeground(context)) {\n                                                context.startForegroundService(intentService);\n                                                }\n                                            }\n                                        });\n                                    } else {\n                                        if(isAppInForeground(context)) {\n                                            context.startService(intentService);\n                                        }\n                                    }\n                                } catch (Exception e) {\n                                    e.printStackTrace();\n                                }\n                            }\n                        }\n                    }\n                } else {\n                    SharedPreferences.Editor preEditor = prefsPrivate.edit();\n                    preEditor.putString(Constants.prefsKeys.LOGIN_USER.OL_TRACKING_STATUS, &quot;false&quot;);\n                    preEditor.apply();\n\n                    stopForegroundService();\n\n                }\n\n            } else {\n            }\n        } catch (JSONException e) {\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n<p>I need to replicate this issue and need a proper solution for this issue.</p>\n",
    "tags" : [ "java", "android", "service", "android-fusedlocation" ],
    "owner" : {
      "account_id" : 39965715,
      "reputation" : 1,
      "user_id" : 29541655,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0878403e829b3c336b916c6a960a265b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Zala Satyarajsinh",
      "link" : "https://stackoverflow.com/users/29541655/zala-satyarajsinh"
    },
    "is_answered" : false,
    "view_count" : 94,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1753447836,
    "creation_date" : 1752732314,
    "link" : "https://stackoverflow.com/questions/79704352/foregroundservicedidnotstartintimeexception-when-using-startforegroundservice",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79714746,
    "question_id" : 79704352,
    "body" : "<blockquote>\n<p>Internal exception: <strong><code>ForegroundServiceDidNotStartInTimeException</code></strong></p>\n<p>When you launch a service by calling <strong><a href=\"https://developer.android.com/reference/android/content/Context#startForegroundService(android.content.Intent)\" rel=\"nofollow noreferrer\"><code>context.startForegroundService()</code></a></strong>, that service has a few seconds to promote itself to a foreground service by calling <strong><a href=\"https://developer.android.com/reference/androidx/core/app/ServiceCompat#startForeground(android.app.Service,int,android.app.Notification,int)\" rel=\"nofollow noreferrer\"><code>ServiceCompat.startForeground()</code></a></strong>. If the service does not do so, the throws an internal <strong><code>ForegroundServiceDidNotStartInTimeException</code></strong>.</p>\n</blockquote>\n<p><strong>Fix</strong>:</p>\n<p>Make sure that all newly-created foreground services call <strong><code>ServiceCompat.startForeground()</code></strong> within a few seconds.</p>\n<p>Reference: <a href=\"https://developer.android.com/develop/background-work/services/fgs/troubleshooting\" rel=\"nofollow noreferrer\">https://developer.android.com/develop/background-work/services/fgs/troubleshooting</a></p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 15100309,
      "reputation" : 1,
      "user_id" : 10897517,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/80d9ab7b56d15b2ef328713163a26f33?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mohsin Shah ",
      "link" : "https://stackoverflow.com/users/10897517/mohsin-shah"
    },
    "creation_date" : 1753447836,
    "last_activity_date" : 1753447836,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}