{
  "question" : {
    "question_id" : 79664261,
    "title" : "When a timeout occurs in Oracle, HikariCP commits instead of rolling back",
    "body" : "<p>When a timeout occurs in the database, HikariCP does not rollback, but commits and terminates abnormally.</p>\n<pre class=\"lang-none prettyprint-override\"><code>@Transactional(rollbackFor = Exception.class)\nmethod{\n  1.delete table11\n  2.delete tablel2  -\\&gt; this point sqltimeout\n}\n</code></pre>\n<p>The delete of table2 caused a timeout and a SQLTimeoutException occurred, but the delete of table1 was committed. The log also outputs:</p>\n<blockquote>\n<p>org.springframework.transaction.TransactionSystemException: JDBC rollback failed.</p>\n</blockquote>\n<h3>Execution source</h3>\n<pre class=\"lang-java prettyprint-override\"><code>@Around(&quot;execution(&quot; + DAO + &quot;)&quot;)\n@Transactional(rollbackFor = Exception.class)\npublic Object daoLog(ProceedingJoinPoint joinpoint) throws Throwable {\n\n    Signature signature = joinpoint.getSignature();\n    \n    // Execution class name \n    String className = &quot;&quot;; \n    // Execution method name \n    String methodName = &quot;&quot;; \n    // Execution function ID \n    String functionId = &quot;&quot;; \n    // DB action \n    String action = &quot;&quot;; \n    // Number of processes \n    int processCount = 0;\n    \n    if (signature instanceof MethodSignature) { \n        // get method name \n        methodName = signature.getName(); \n        // get class name \n        className = joinpoint.getTarget().getClass().getSimpleName();\n    \n        // get DB action \n        action = getDbAction(methodName); \n    }\n    \n    if (CompareUtil.isNotNull(loginInfoDto)) { \n        if (CompareUtil.isNotEmpty(loginInfoDto.getFunctionId())) { \n            // get function ID \n            functionId = loginInfoDto.getFunctionId(); \n        }\n    }\n    \n    try { \n        // execute DAO method \n        Object result = joinpoint.proceed(); \n    \n        // get the number of processes \n        processCount = getProcessCount(result);\n    \n        // output log \n        log.info(String.format(LOG_FORMAT, functionId, className, methodName, String.format(MESSAGE_FORMAT, processCount, action)));\n    \n        return result; \n    \n    } catch (Exception ex) { \n        TransactionAspectSupport.currentTransactionStatus().setRollbackOnly(); \n        log.info(String.format(LOG_FORMAT, functionId, className, methodName, &quot;abnormal end &quot; + ex.getClass().getName())); \n        throw ex; \n    }\n\n}\n</code></pre>\n<h3>Phenomenon</h3>\n<ol>\n<li><code>joinpoint.proceed();</code></li>\n<li>Timeout occurs</li>\n<li><code>catch (Exception ex) {</code></li>\n</ol>\n<pre><code>At this point, the connection has already been committed and the connection has been destroyed.\n\n### HikariCP config\n```yaml\nspring:\n  datasource:\n    url : jdbc:oracle:thin:@XXXX/XX\n    username : XXXX\n    password : XXXX\n    driver-class-name : oracle.jdbc.OracleDriver\n    hikari:\n      connection-timeout: 15000\n      maximum-pool-size: 10 \n      leak-detection-threshold: 60000 \n      autoCommit: false\n</code></pre>\n<h3>Log (excerpt)</h3>\n<pre class=\"lang-none prettyprint-override\"><code>2025/06/11 11:07:08.003 [187] [900000] WARN c.z.h.p.ProxyConnection checkException HikariPool-5 - Connection oracle.jdbc.driver.T4CConnection@71ae8c9f marked as broken because of SQLSTATE(72000), ErrorCode(1013) \njava.sql.SQLTimeoutException: ORA-01013:. Cancel of current operation requested by user\n\n\nCaused by: oracle.jdbc.OracleDatabaseException:. ORA-01013: Cancel of current operation requested by user\n\n    at oracle.jdbc.driver.T4CTTIoer11.processError(T4CTTIoer11.java:530) ~[ojdbc10-19.20.0.0.jar:19.20.0.0.0] \n... 181 more \n2025/06/11 11:07:08.009 [187] [900000] INFO o.s.d.j.UtilLoggingJdbcLogger log [DOMA2222] THROW : CLASS=jp.co.xxxx.db.table.dao.tbikomeisaiexp.xxxxxpDaoImpl, METHOD=deleteTXxxxxxx, EXCEPTION=org.seasar.doma. SqlExecutionException \n2025/06/11 11:07:08.010 [187] [900000] INFO j.c.h.c.i.DaoLogInterceptor daoLog SHMT0320 [Target Table]:TbikoMeisaiExpDaoImpl [SQL to execute]:deleteTbikoMeisaiExp Abnormal end org. QueryTimeoutException \n2025/06/11 11:07:08.011 [187] [900000] INFO j.c.h.c.i.AppLogInterceptor controllerLog SHMT0320 900000 SHMT0320Controller regist abnormal termination org.springframework.transaction. TransactionSystemException \n2025/06/11 11:07:08.012 [187] [900000] ERROR j.c.h.c.h.ControllerExceptionHandler handleException JDBC rollback failed \norg.springframework.transaction. JDBC rollback faile\n\n\n\nCaused by: java.sql.SQLException: Connection is closed\n    at com.zaxxer.hikari.pool.ProxyConnection$ClosedConnection.lambda$getClosedConnection$0(ProxyConnection.java:502) ~[HikariCP-5.0.1.jar:?]\n    at jdk.proxy4.$Proxy117.rollback(Unknown Source) ~[?:?]\n    at com.zaxxer.hikari.pool.ProxyConnection.rollback(ProxyConnection.java:385) ~[HikariCP-5.0.1.jar:?]\n    at com.zaxxer.hikari.pool.HikariProxyConnection.rollback(HikariProxyConnection.java) ~[HikariCP-5.0.1.jar:?]\n    at org.springframework.jdbc.datasource.DataSourceTransactionManager.doRollback(DataSourceTransactionManager.java:352) ~[spring-jdbc-6.0.12.jar:6.0.12]\n    ... 127 more\n2025/06/11 11:07:18.383 [187] [] ERROR o.a.c.c.C.[Tomcat].[localhost].[/xxxxx].[dispatcherServlet] log Servlet.service() for servlet [dispatcherServlet] in context with path [/xxxxx] threw exception [Request processing failed: org.springframework.transaction.TransactionSystemException: JDBC rollback failed] with root cause\njava.sql.SQLException: Connection is closed\n</code></pre>\n<h3>Consideration</h3>\n<ol>\n<li>SQL execution times out (ORA-01013)</li>\n<li>HikariCP (Spring standard connection pool) closes connection as corrupt</li>\n<li>Doma and Spring detect exception</li>\n<li>Spring tries to rollback but fails because connection is already closed</li>\n<li>Propagated to upper layers as TransactionSystemException</li>\n<li>Logged in Tomcat error log</li>\n</ol>\n<h2>Question</h2>\n<p>Does anyone have a timeout occur and still rollback? Or can someone tell me how to make HikariCP roll back when it closes the connection?</p>\n<p>I want to roll back the transaction even if a timeout occurs.</p>\n<h3>What I tried</h3>\n<ol>\n<li>Use <code>@Transactional(rollbackFor = Exception.class)</code>\n<strong>No good</strong></li>\n<li>Use <code>TransactionAspectSupport.currentTransactionStatus().setRollbackOnly();</code> in try-catch\n<strong>No good</strong></li>\n<li>Set <code>autoCommit: false</code> in HikariCP settings\n<strong>No good</strong></li>\n</ol>\n",
    "tags" : [ "java", "spring", "jdbc", "oracle11g", "hikaricp" ],
    "owner" : {
      "account_id" : 42514309,
      "reputation" : 41,
      "user_id" : 30790462,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d9d939e741bbb6f389a09bc40f29890?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "yuki",
      "link" : "https://stackoverflow.com/users/30790462/yuki"
    },
    "is_answered" : true,
    "view_count" : 193,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1753618258,
    "creation_date" : 1749778048,
    "link" : "https://stackoverflow.com/questions/79664261/when-a-timeout-occurs-in-oracle-hikaricp-commits-instead-of-rolling-back",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79664431,
    "question_id" : 79664261,
    "body" : "<p>I solved it myself, it is a HikariCP bug.</p>\n<p>It's been addressed here:</p>\n<ul>\n<li><a href=\"https://github.com/brettwooldridge/HikariCP/issues/1388\" rel=\"nofollow noreferrer\">https://github.com/brettwooldridge/HikariCP/issues/1388</a></li>\n<li><a href=\"https://github.com/brettwooldridge/HikariCP/pull/2238\" rel=\"nofollow noreferrer\">https://github.com/brettwooldridge/HikariCP/pull/2238</a></li>\n</ul>\n<p>The above problem was not fixed in HikariCP version 5.0.1.</p>\n<p>Use the latest HikariCP 6.3.0, the problem has been fixed in that version.</p>\n<p>build.gradle</p>\n<pre><code>dependencies {\n\n    implementation(&quot;com.zaxxer:HikariCP:6.3.0&quot;)\n\n}\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 42514309,
      "reputation" : 41,
      "user_id" : 30790462,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d9d939e741bbb6f389a09bc40f29890?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "yuki",
      "link" : "https://stackoverflow.com/users/30790462/yuki"
    },
    "creation_date" : 1749795792,
    "last_activity_date" : 1753618258,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}