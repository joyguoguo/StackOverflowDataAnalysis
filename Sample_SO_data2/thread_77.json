{
  "question" : {
    "question_id" : 79841090,
    "title" : "Hibernate @oneToOne mapping is unable to use L2 cache when mapping returns no Object",
    "body" : "<p>I have 2 JPA classes with bi-directional onetoOne mapping :</p>\n<pre><code>@Entity\n@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)\npublic class Person {\n\n    @Column(name = &quot;\\&quot;Name\\&quot;&quot;)\n    private String name;\n\n    // bi-directional one-to-one association to CarDetails\n    @OneToOne(cascade = CascadeType.ALL, optional = true, fetch = FetchType.EAGER, orphanRemoval = true, mappedBy = &quot;owner&quot;)\n    private CarDetails carDetails;\n\n    public String getName() {\n        return this.name;\n    }\n\n    public void setName(String name) {\n        return this.name=name;\n    }\n\n    public CarDetails getCarDetails() {\n        return this.carDetails;\n    }\n\n    public CarDetails setCarDetails(CarDetails carDetails) {\n        if (carDetails == null) {\n            if (this.carDetails != null) {\n                this.carDetails.setOwner(null);\n            }\n        }\n        else {\n            carDetails.setOwner(this);\n        }\n        this.carDetails = carDetails;\n        return this;\n    }\n\n}\n\n\n@Entity\n@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)\npublic class CarDetails {\n\n    @Column(name = &quot;\\&quot;RegistrationNumber\\&quot;&quot;)\n    private String registrationNumber;\n\n    // bi-directional one-to-one association to Person\n    @OneToOne(cascade = CascadeType.ALL, optional = false, fetch = FetchType.LAZY)\n    @PrimaryKeyJoinColumn\n    private Person owner;\n\n\n    public String getRegistrationNumber() {\n        return this.registrationNumber;\n    }\n\n    public void setRegistrationNumber(String registrationNumber) {\n        return this.registrationNumber=registrationNumber;\n    }\n\n    public Person getOwner() {\n        return this.owner;\n    }\n\n    public void setOwner(Person owner) {\n        this.owner = owner;\n    }\n\n}\n</code></pre>\n<p>I have enable L2 cache for Hibernate and also enable hibernate sql logs to see what queries are being executed to DB using :</p>\n<pre><code>&lt;property name=&quot;hibernate.generate_statistics&quot; value=&quot;true&quot; /&gt;\n&lt;property name=&quot;hibernate.show_sql&quot; value=&quot;true&quot; /&gt;\n</code></pre>\n<p>I do em.find() for Person and expect that once the person entity is returned, the carDetails is also cached in the L2 cache and no more queries will be produced as we will get cache hits. But in the case where the person doesn't own any cars I am seeing that every time I access the carDetails a new query is fired to DB instead of storing that no carDetails were returned earlier.</p>\n<p>I also read <a href=\"https://docs.hibernate.org/orm/6.4/userguide/html_single/#caching-collection\" rel=\"nofollow noreferrer\">hibernate-docs-collection-cache</a>, since collections are not automatically cached I have also tried :</p>\n<pre><code>    @Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)\n    // bi-directional one-to-one association to CarDetails\n    @OneToOne(cascade = CascadeType.ALL, optional = true, fetch = FetchType.EAGER, orphanRemoval = true, mappedBy = &quot;owner&quot;)\n    private CarDetails carDetails;\n</code></pre>\n<p>Using this the relationship should be cached but I still see that query hits the DB, in hibernate logs. Is there a way to fix this?</p>\n",
    "tags" : [ "java", "hibernate", "caching", "one-to-one" ],
    "owner" : {
      "account_id" : 31474750,
      "reputation" : 31,
      "user_id" : 24297481,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e37e1723e34001cf6d5dd3e2502e2c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kitret",
      "link" : "https://stackoverflow.com/users/24297481/kitret"
    },
    "is_answered" : true,
    "view_count" : 63,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1765360594,
    "creation_date" : 1765205713,
    "link" : "https://stackoverflow.com/questions/79841090/hibernate-onetoone-mapping-is-unable-to-use-l2-cache-when-mapping-returns-no-ob",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79842543,
    "question_id" : 79841090,
    "body" : "<p>It seems to be currently a issue with hibernate JPA. Found this action item for hibernate : <a href=\"https://hibernate.atlassian.net/browse/HHH-15540\" rel=\"nofollow noreferrer\">Hibernate doesn't support caching from mapped by side if association is null</a>.</p>\n<p>I don't know if it will be fixed anytime soon as the last update was in 2022.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 31474750,
      "reputation" : 31,
      "user_id" : 24297481,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e37e1723e34001cf6d5dd3e2502e2c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kitret",
      "link" : "https://stackoverflow.com/users/24297481/kitret"
    },
    "creation_date" : 1765338968,
    "last_activity_date" : 1765360594,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140894380,
    "post_id" : 79841090,
    "body" : "There probably isn&#39;t a solution other that avoids changing how this is mapped (by making <code>Person</code> the owner of the relationship).  That would also involve giving the person table a foreign key referencing the car details.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1765288793,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140894368,
    "post_id" : 79841090,
    "body" : "I agree that the latest link you provided matches your situation.  If you read between the lines, it also explains the nature of the problem: the L2 cache is a DB-like cache, not an entity-like cache (which the L1 cache is).  At the L2 cache level, then, there is no way for Hibernate to distinguish between a <code>Person</code>&#39;s <code>CarDetails</code> not being cached because there are none, and not currently being cached despite being available from the DB. The information about what <code>CarDetails</code> belongs to which person are carried by the <code>CarDetails</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1765288497,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140893670,
    "post_id" : 79841090,
    "body" : "I have also found this article : <a href=\"https://forum.hibernate.org/viewtopic.php?p=2447545\" rel=\"nofollow noreferrer\">link</a>, it is for the same problem but I can&#39;t define a foreign key coloumn so would like to find another solution, it was also asked in the discussion but there was no conclusion for that.",
    "score" : 0,
    "owner" : {
      "account_id" : 31474750,
      "reputation" : 31,
      "user_id" : 24297481,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e37e1723e34001cf6d5dd3e2502e2c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kitret",
      "link" : "https://stackoverflow.com/users/24297481/kitret"
    },
    "creation_date" : 1765261093,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140893597,
    "post_id" : 79841090,
    "body" : "Thanks for the reply Jhon, I have edited the question to convey the original problem. Have a look, do tell if I need to provide something more",
    "score" : 0,
    "owner" : {
      "account_id" : 31474750,
      "reputation" : 31,
      "user_id" : 24297481,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e37e1723e34001cf6d5dd3e2502e2c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kitret",
      "link" : "https://stackoverflow.com/users/24297481/kitret"
    },
    "creation_date" : 1765255624,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140893171,
    "post_id" : 79841090,
    "body" : "It would be helpful if you edited the question to provide code demonstrating the (non-)caching behavior you are asking about.  Without, it&#39;s hard to tell under what circumstances you expect to see the cache being hit, or to evaluate why that might not be happening.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1765221909,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140893100,
    "post_id" : 79841090,
    "body" : "The entity code presented is inconsistent.  The owning side of <code>A.b</code> is annotated as <code>B.btemp</code>, but <code>B</code> does not have such a property.  I&#39;m inclined to think that such a mismatch in your real code would produce a different manifestation, so I don&#39;t think it explains your issue, but please edit the question to present a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, or as close as you can get to that.  Otherwise, it&#39;s very difficult to analyze your issue.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1765218447,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140892771,
    "post_id" : 79841090,
    "body" : "I have read something similar in this blog : <a href=\"https://vladmihalcea.com/jpa-hibernate-cache-non-existing-entity-fetch-results/\" rel=\"nofollow noreferrer\">link</a> , I want something similar with my @oneToOne mapping",
    "score" : 0,
    "owner" : {
      "account_id" : 31474750,
      "reputation" : 31,
      "user_id" : 24297481,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e37e1723e34001cf6d5dd3e2502e2c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kitret",
      "link" : "https://stackoverflow.com/users/24297481/kitret"
    },
    "creation_date" : 1765206126,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}