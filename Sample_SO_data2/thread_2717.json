{
  "question" : {
    "question_id" : 79602955,
    "title" : "File size increases by 40% during multipart upload in Quarkus (images/XLSX only)",
    "body" : "<p>When uploading .xlsx files via multipart form in Quarkus 3.10.2 (Java 17), the saved files becomes corrupted. Excel shows <em>&quot;We found a problem with some content&quot;</em> error when opening them. The files are 30-40% larger than the originals, while other file types work fine.</p>\n<p>Key Symptoms:</p>\n<ul>\n<li>Files appear to upload successfully</li>\n<li>Saved .xlsx files are unreadable in Excel</li>\n<li>File sizes increase by ~40% (e.g., 100KB → 140KB)</li>\n<li>Images also affected, but text/PDF files work normally</li>\n</ul>\n<p>I'm using:</p>\n<ul>\n<li>Quarkus: 3.10.2</li>\n<li>Java: Amazon Corretto 17</li>\n<li>OS: Windows 11 &amp; Linux (both affected)</li>\n<li>Storage: Local filesystem (ext4/NTFS)</li>\n</ul>\n<p>Code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@POST\n@Consumes(MediaType.MULTIPART_FORM_DATA)\npublic Response uploadExcel(@RestForm(&quot;file&quot;) FileUpload file) throws IOException {\n    Path dest = Path.of(&quot;uploads&quot;, file.fileName());\n    \n    // DEBUG: Log file sizes\n    System.out.printf(&quot;Original: %d bytes | Received: %d bytes%n&quot;,\n        file.size(),\n        Files.size(file.uploadedFile()));\n    \n    Files.copy(file.uploadedFile(), dest, StandardCopyOption.REPLACE_EXISTING);\n    \n    return Response.ok().build();\n}\n</code></pre>\n",
    "tags" : [ "java", "file-upload", "quarkus", "quarkus-reactive" ],
    "owner" : {
      "account_id" : 27829697,
      "reputation" : 1,
      "user_id" : 21248349,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6BfLIh2rm8EV6EsiwP4crYOXm2KaPiDyx3WO-T6w=k-s256",
      "display_name" : "Dheeban M",
      "link" : "https://stackoverflow.com/users/21248349/dheeban-m"
    },
    "is_answered" : false,
    "view_count" : 94,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1746171477,
    "creation_date" : 1746170257,
    "link" : "https://stackoverflow.com/questions/79602955/file-size-increases-by-40-during-multipart-upload-in-quarkus-images-xlsx-only",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140403106,
    "post_id" : 79602955,
    "body" : "I think the file is not treated properly in a way that the actual binary content is treated as text. This would explain the bloat in size. Try this: @POST @Consumes(MediaType.MULTIPART_FORM_DATA) public Response uploadExcel(@MultipartForm FileUploadForm form) throws IOException {     FileUpload file = form.file;      Path dest = Path.of(&quot;uploads&quot;, file.fileName());      try (InputStream in = file.uploadedFile().newInputStream()) {         Files.copy(in, dest, StandardCopyOption.REPLACE_EXISTING);     }      return Response.ok().build(); }",
    "score" : 0,
    "owner" : {
      "account_id" : 5316725,
      "reputation" : 259,
      "user_id" : 4241377,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0ae255d91ce1ff9888243f5bd51f77c2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mr__Steel",
      "link" : "https://stackoverflow.com/users/4241377/mr-steel"
    },
    "creation_date" : 1746606255,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140396122,
    "post_id" : 79602955,
    "body" : "OK. But find a file that is as small as possible. Excel &quot;Hello World&quot; in A1 is ~9kb. Pass it through your misbehaving upload procedure and then make the original file and the mangled one available somewhere for us to take a look at. My money is on @g00se suggestion that MIME64 encoding of a binary file has occurred on the upload and not been undone by the receiving platform.",
    "score" : 0,
    "owner" : {
      "account_id" : 29751986,
      "reputation" : 3666,
      "user_id" : 22801686,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0af01d17ee99f1f8ec1f8f788950399a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Martin Brown",
      "link" : "https://stackoverflow.com/users/22801686/martin-brown"
    },
    "creation_date" : 1746432594,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140395837,
    "post_id" : 79602955,
    "body" : "@MartinBrown I believe this is not a cause for AV because I created a simple file-upload API using Spring Boot, which is working fine. The issue only occurs in the Quarkus framework.",
    "score" : 0,
    "owner" : {
      "account_id" : 27829697,
      "reputation" : 1,
      "user_id" : 21248349,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6BfLIh2rm8EV6EsiwP4crYOXm2KaPiDyx3WO-T6w=k-s256",
      "display_name" : "Dheeban M",
      "link" : "https://stackoverflow.com/users/21248349/dheeban-m"
    },
    "creation_date" : 1746421704,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140395805,
    "post_id" : 79602955,
    "body" : "@S&#246;ren The file has been uploaded by the user, via Postman.",
    "score" : 0,
    "owner" : {
      "account_id" : 27829697,
      "reputation" : 1,
      "user_id" : 21248349,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6BfLIh2rm8EV6EsiwP4crYOXm2KaPiDyx3WO-T6w=k-s256",
      "display_name" : "Dheeban M",
      "link" : "https://stackoverflow.com/users/21248349/dheeban-m"
    },
    "creation_date" : 1746419947,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389995,
    "post_id" : 79602955,
    "body" : "Are these files uploaded by another program or by a user? If user, are different forms involved? Nothing in your code explains, why only certain file types are affected.",
    "score" : 1,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1746188302,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389428,
    "post_id" : 79602955,
    "body" : "<i>File sizes increase by ~40% (e.g., 100KB → 140KB)</i> That&#39;s the kind of thing that would happen under Base64 encoding - coincidence?",
    "score" : 5,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1746176789,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389265,
    "post_id" : 79602955,
    "body" : "Can you make a very small example of a file that gets damaged and put the original and the bad one where we can see it? Better still compare them yourself to look for the corruption. Usual causes are when binary mode hasn&#39;t been enabled or some over zealous net nanny AV type code censors obscene words in passing documents. Translation of carriage return into cr,lf is another possible glitch. I&#39;ve seen something like this with a very few correspondents that I cannot send PDFs to without them corrupting in transit (I suspect particular AV software is a factor but can&#39;t be sure).",
    "score" : 2,
    "owner" : {
      "account_id" : 29751986,
      "reputation" : 3666,
      "user_id" : 22801686,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0af01d17ee99f1f8ec1f8f788950399a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Martin Brown",
      "link" : "https://stackoverflow.com/users/22801686/martin-brown"
    },
    "creation_date" : 1746173197,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}