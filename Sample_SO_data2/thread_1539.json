{
  "question" : {
    "question_id" : 79700701,
    "title" : "acquiring an image with GenICam Package Java Reference Implementation from IDS Peak Camera in JAVA SE",
    "body" : "<p>I got IDS Peak (ueye) Camera connected to USB3</p>\n<p>GenICam Package Java Reference Implementation in my case 2024.04 has Java bindings.</p>\n<p>I can not find a way to acquire an image from the IDS Peak camera using GenTL java API</p>\n<p>C++ and C# API reference some RemoteDevice that I do not see in java API.</p>\n<p>I did all the steps from initializing the library</p>\n<p>getting a reference to the device</p>\n<p>opening the DataStream</p>\n<p>but I can not get pass that</p>\n<p>here is my sample test code</p>\n<p>what should i put in <code>acquireImageFromCamera()</code> and <code>changeGain()</code> ??</p>\n<p>Sorry if it looks stupid but I am lost here...</p>\n<pre class=\"lang-java prettyprint-override\"><code>\npackage detector.geicam;\n\nimport java.awt.image.BufferedImage;\nimport java.lang.foreign.Arena;\nimport java.lang.foreign.MemorySegment;\nimport java.nio.ByteBuffer;\nimport java.util.List;\n\nimport org.genicam.genapi.NodeMap;\nimport org.genicam.gentl.*;\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\npublic class MainGenicamTest {\n    private static final Logger l = LoggerFactory.getLogger(MainGenicamTest.class);\n    private GenTLProducer producer;\n    private TransportLayer transportLayer;\n    private List&lt;InterfaceInfo&gt; interfaces;\n    private TLInterface tlInterface;\n    private DeviceInfo deviceInfo;\n    private Device device;\n    private DataStream openDataStream;\n    private Port dataStreamPort;\n    private Port deviceRemotePort;\n    private Port deviceLocalPort;\n\n    public MainGenicamTest() {\n\n        System.loadLibrary(&quot;GenTLJava_MD_VC141_v3_4&quot;);\n        l.info(&quot;GenTLJava_MD_VC141_v3_4 loaded&quot;);\n\n        System.loadLibrary(&quot;GenApiJava_MD_VC141_v3_4&quot;);\n        l.info(&quot;GenApiJava_MD_VC141_v3_4 loaded&quot;);\n\n        producer = GenTLProducer.load(&quot;C:\\\\Work\\\\daich.biz\\\\biz.daich.stains.detector.geicam\\\\ids_ueyegentl.cti&quot;);\n        var r = producer.isOpen();\n        l.info(&quot;GenTLProducer isOpen: {}&quot;, r);\n        r = producer.checkValid();\n        l.info(&quot;GenTLProducer isValid: {}&quot;, r);\n        var name = producer.getDisplayname();\n        l.info(&quot;GenTLProducer name: {}&quot;, name);\n        String tlType = producer.getTLType();\n        l.info(&quot;GenTLProducer TLType: {}&quot;, tlType);\n        String version = producer.getVersion();\n        String model = producer.getModel();\n        String vendor = producer.getVendor();\n        l.info(&quot;GenTLProducer version: {}, model: {}, vendor: {}&quot;, version, model, vendor);\n        transportLayer = producer.openTransportLayer();\n        var res = transportLayer.updateInterfaceList(1000);\n        l.info(&quot;TransportLayer updateInterfaceList result: {}&quot;, res);\n        interfaces = transportLayer.getInterfaces();\n        l.info(&quot;TransportLayer interfaces: {}&quot;, interfaces.size());\n        for (InterfaceInfo interfaceInfo : interfaces) {\n            l.info(&quot;Interface: TransportLayerType: {}, display name: {}, id: {} &quot;, interfaceInfo.getTransportLayerType(), interfaceInfo.getDisplayName(), interfaceInfo.getID());\n            TLInterface tlInterface = interfaceInfo.open();\n            boolean updateDeviceList = tlInterface.updateDeviceList(1000);\n            l.info(&quot;TLInterface updateDeviceList result: {}&quot;, updateDeviceList);\n            List&lt;DeviceInfo&gt; deviceList = tlInterface.getDeviceList();\n            deviceList.stream().forEach(x -&gt; l.info(&quot;DeviceInfo: {}, display name: {}, id: {}&quot;, x.getTransportLayerType(), x.getDisplayName(), x.getID()));\n            tlInterface.close();\n        }\n        tlInterface = interfaces.get(0).open();\n        boolean updateDeviceList = tlInterface.updateDeviceList(1000);\n        l.info(&quot;TLInterface updateDeviceList result: {}&quot;, updateDeviceList);\n        deviceInfo = tlInterface.getDeviceList().get(0);\n        l.info(&quot;DeviceInfo: TransportLayerType: {}, display name: {}, id: {}&quot;, deviceInfo.getTransportLayerType(), deviceInfo.getDisplayName(), deviceInfo.getID());\n        device = deviceInfo.open(DeviceAccessFlags.DEVICE_ACCESS_EXCLUSIVE);\n        l.info(&quot;Device opened: TransportLayerType: {}, display name: {}, id: {}&quot;, device.getTransportLayerType(), device.getDisplayName(), device.getID());\n        List&lt;String&gt; dataStreamIDs = device.getDataStreamIDs();\n        dataStreamIDs.stream().forEach(x -&gt; l.info(&quot;DataStream ID: {}&quot;, x));\n        String dataStreamId = dataStreamIDs.get(0);\n        openDataStream = device.openDataStream(dataStreamId);\n        if (openDataStream.definesPayloadSize()) {\n            long payloadSize = openDataStream.getPayloadSize();\n            l.info(&quot;DataStream payload size: {}&quot;, payloadSize);\n        } else {\n            l.info(&quot;DataStream does not define payload size&quot;);\n        }\n        dataStreamPort = openDataStream.getPort();\n        l.info(&quot;port properties: id={} name={} model={} TLType={} Vendor={}&quot;, dataStreamPort.getID(), dataStreamPort.getName(), dataStreamPort.getModel(), dataStreamPort.getTLType(), dataStreamPort.getVendor());\n        deviceRemotePort = device.getRemotePort();\n        l.info(&quot;Remote port properties: id={} name={} model={} TLType={} Vendor={}&quot;, deviceRemotePort.getID(), deviceRemotePort.getName(), deviceRemotePort.getModel(), deviceRemotePort.getTLType(),\n                deviceRemotePort.getVendor());\n        deviceLocalPort = device.getLocalPort();\n        l.info(&quot;Remote port properties: id={} name={} model={} TLType={} Vendor={}&quot;, deviceLocalPort.getID(), deviceLocalPort.getName(), deviceLocalPort.getModel(), deviceLocalPort.getTLType(),\n                deviceLocalPort.getVendor());\n    }\n\n    public BufferedImage acquireImageFromCamera() {\n\n        // HOW!???\n        throw new RuntimeException(&quot;Not implemented yet&quot;);\n    }\n\n    public void changeGain() {\n        // TODO: how to get reference to the GenApiNodeMap?\n        // how to do FindNode &quot;TLParamsLocked&quot;  &quot;AcquisitionStart&quot; &quot;AcquisitionStart&quot; ???\n    }\n    \n    \n    public static void main(String[] args) {\n        MainGenicamTest x = new MainGenicamTest();\n        x.changeGain();\n        BufferedImage img = x.acquireImageFromCamera();\n    }\n\n}\n\n</code></pre>\n",
    "tags" : [ "java", "ids", "genicam", "gentl" ],
    "owner" : {
      "account_id" : 23842,
      "reputation" : 2431,
      "user_id" : 60114,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/0a1c865148ed2eaecb2608922df5c37e?s=256&d=identicon&r=PG",
      "display_name" : "Boris Daich",
      "link" : "https://stackoverflow.com/users/60114/boris-daich"
    },
    "is_answered" : false,
    "view_count" : 109,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1760965258,
    "creation_date" : 1752486751,
    "link" : "https://stackoverflow.com/questions/79700701/acquiring-an-image-with-genicam-package-java-reference-implementation-from-ids-p",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79794926,
    "question_id" : 79700701,
    "body" : "<p>I got things to work out in the end.</p>\n<p>The main gotcha is to use a port acquired from GenTL to use with GenAPI, as the Java bindings make them incompatible libraries. So we need a simple class to bridge them:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.nio.ByteBuffer;\nimport org.genicam.genapi.EAccessMode;\nimport org.genicam.genapi.IPort;\nimport org.genicam.gentl.Port;\n\n/**\n * Implement a GenAPI port using a GenTL device remote port\n */\npublic class BridgePort extends IPort {\n\n    private final Port port;\n\n    public BridgePort(Port port) {\n        this.port = port;\n    }\n\n    public String getName() {\n        return port.getName();\n    }\n\n    @Override\n    public EAccessMode getAccessMode() {\n        if (port == null) {\n            if (port.isAccessNA()) {\n                return EAccessMode.NA;\n            } else if (port.isAccessNI()) {\n                return EAccessMode.NI;\n            } else if (port.hasReadAccess()) {\n                if (port.hasWriteAccess()) {\n                    return EAccessMode.RW;\n                } else {\n                    return EAccessMode.RO;\n                }\n            } else if (port.hasWriteAccess()) {\n                return EAccessMode.WO;\n            }\n        }\n        return null;\n    }\n\n    @Override\n    public void read(long address, byte[] pBuffer) {\n        final ByteBuffer bb = ByteBuffer.allocateDirect(pBuffer.length);\n        port.read(address, bb);\n        bb.get(pBuffer);\n    }\n\n    @Override\n    public void write(long address, byte[] pBuffer) {\n        final ByteBuffer bb = ByteBuffer.allocateDirect(pBuffer.length);\n        bb.put(pBuffer);\n        port.write(address, bb);\n    }\n}\n</code></pre>\n<p>The port used in the constructor is the device remote port acquired via GenTL (summarized):</p>\n<pre class=\"lang-java prettyprint-override\"><code>GenTLProducer producer = GenTLProducer.load(&quot;/path/to/producer.cti&quot;);\nTransportLayer transportLayer = producer.openTransportLayer();\ntransportLayer.updateInterfaceList(1000);\nList&lt;InterfaceInfo&gt; interfaceInfos = transportLayer.getInterfaces();\nInterfaceInfo interfaceInfo = interfaceInfos.get(0); // adapt as needed\nTLInterface tlInterface = interfaceInfo.open();\ntlInterface.updateDeviceList(1000);\nList&lt;DeviceInfo&gt; deviceInfos = tlInterface.getDeviceList();\nDeviceInfo deviceInfo = deviceInfos.get(0); // adapt as needed\nDevice device = deviceInfo.open(deviceAccess)\nPort port = device.getRemotePort()\n</code></pre>\n<p>Also, we need to initialize the GenAPI node map with the register description XML. You may have the file somewhere, but I believe it's best to retrieve it from the camera itself via GenTL's device:</p>\n<pre><code>    public static String getRegisterDescription(Device device) throws Exception {\n        Port port = device.getRemotePort();\n        int urlIndex = 0;\n        long address = port.getFileRegisterAddress(urlIndex);\n        long fileSize = port.getFileSize(urlIndex);\n\n        // byte buffer must be direct\n        ByteBuffer byteBuffer = ByteBuffer.allocateDirect((int) fileSize);\n        long readByteCount = port.read(address, byteBuffer);\n        if (readByteCount != fileSize) {\n            throw new Exception(&quot;Failed to read full data: &quot; + readByteCount + &quot; / &quot; + fileSize + &quot; bytes&quot;);\n        }\n\n        String filename = port.getFilename(urlIndex);\n        int extensionIndex = filename.lastIndexOf(&quot;.&quot;);\n        if (extensionIndex != -1 &amp;&amp; filename.substring(extensionIndex + 1).equals(&quot;zip&quot;)) {\n            // zip-compressed XML description file\n            String uncompressed = &quot;zip entry not found&quot;;\n            try (ZipInputStream zis = new ZipInputStream(new ByteBufferInputStream(byteBuffer))) {\n                ZipEntry zipEntry = zis.getNextEntry();\n                if (zipEntry != null) {\n                    uncompressed = new BufferedReader(new InputStreamReader(zis, StandardCharsets.UTF_8)).lines().collect(Collectors.joining(&quot;\\n&quot;));\n                }\n                zis.closeEntry();\n            }\n            return uncompressed;\n        } else {\n            // uncompressed XML description file\n            return StandardCharsets.UTF_8.decode(byteBuffer).toString();\n        }\n    }\n</code></pre>\n<p>On the GenAPI side, we can now get a usable node map using the port and the register description:</p>\n<pre class=\"lang-java prettyprint-override\"><code>BridgePort port = new BridgePort(device.getRemotePort());\nNodeMap nodeMap = new NodeMap(device.getSerialNumber());nodeMap.loadXMLFromString(getRegisterDescription(device));\nnodeMap.connect(port, port.getName());\n</code></pre>\n<p>Individual nodes access modes and value types can be queried before read/write.</p>\n<p>To read a value, say Exposure Time:</p>\n<pre class=\"lang-java prettyprint-override\"><code>nodeMap.getFloatNode(&quot;ExposureTime&quot;).getValue(true, false);\n</code></pre>\n<p>To write a value, say Gain:</p>\n<pre><code>nodeMap.getFloatNode(&quot;Gain&quot;).setValue(42, true);\n</code></pre>\n<p>Acquiring images needs some setup:</p>\n<ol>\n<li><p>open data stream</p>\n</li>\n<li><p>announce and queue buffer</p>\n</li>\n<li><p>start acquisition</p>\n</li>\n<li><p>listen to new buffers</p>\n</li>\n</ol>\n<p>Roughly, w/o error handling and summarized:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    private NewBufferEvent newBufferEvent;\n    private Map&lt;Buffer, ByteBuffer&gt; buffers;\n\n    public void startAcquisition() throws Exception {\n        openDataStream();\n        nodeMap.getCommandNode(&quot;AcquisitionStart&quot;).execute(true);\n        new Thread(() -&gt; acquire()).start();\n    }\n\n    private void openDataStream() {\n        String dsId = device.getDataStreamIDs().get(0);\n        DataStream dataStream = device.openDataStream(dsId);\n        queueNewBuffer();\n        dataStream.startAcquisition(AcqStartFlags.ACQ_START_FLAGS_DEFAULT, Long.MAX_VALUE);\n        newBufferEvent = dataStream.registerNewBufferEvent();\n    }\n\n    private void queueNewBuffer() throws Exception {\n        long payloadSize = nodeMap.getIntegerNode(&quot;PayloadSize&quot;).getValue(true, false);\n\n        // `ByteBuffer` must be direct\n        ByteBuffer byteBuffer = ByteBuffer.allocateDirect((int) payloadSize);\n        Buffer buffer = dataStream.announceBuffer(byteBuffer, new UserData(0));\n        buffers.put(buffer, byteBuffer);\n        queueBuffer(buffer);\n    }\n\n    private Buffer getNewEventBuffer(NewBufferEventData eventData) {\n        final long bufferHandle = eventData.getBufferHandle().getHandle();\n        return buffers.keySet().stream().filter(v -&gt; v.getHandle().getHandle() == bufferHandle).findFirst().get();\n    }\n\n    private void acquire() throws Exception {\n        while (true) {\n            final NewBufferEventData eventData = newBufferEvent.getData(1000);\n            final Buffer buffer = getNewEventBuffer(eventData);\n            long format = buffer.getInfoUint64(BufferInfoCommand.BUFFER_INFO_PIXELFORMAT);\n            int width = (int) buffer.getInfoSizet(BufferInfoCommand.BUFFER_INFO_WIDTH);\n            int height = (int) buffer.getInfoSizet(BufferInfoCommand.BUFFER_INFO_HEIGHT);\n\n            // extract image from buffer\n            final ByteBuffer byteBuffer = buffers.get(buffer);\n            byte[] dst = new byte[byteBuffer.capacity()];\n            byteBuffer.get(dst);\n            byteBuffer.position(0);\n\n            notifyNewImage(dst, format, width, height);\n            queueBuffer(buffer);\n        }\n    }\n</code></pre>\n<p>You can have fun in `notifyNewImage`.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 413172,
      "reputation" : 414,
      "user_id" : 786656,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4306c19913e1f81b99f171410e31fa3e?s=256&d=identicon&r=PG",
      "display_name" : "Thibault",
      "link" : "https://stackoverflow.com/users/786656/thibault"
    },
    "creation_date" : 1760965258,
    "last_activity_date" : 1760965258,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140790220,
    "post_id" : 79700701,
    "body" : "yeah went this road. Did not work for me too.",
    "score" : 0,
    "owner" : {
      "account_id" : 23842,
      "reputation" : 2431,
      "user_id" : 60114,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/0a1c865148ed2eaecb2608922df5c37e?s=256&d=identicon&r=PG",
      "display_name" : "Boris Daich",
      "link" : "https://stackoverflow.com/users/60114/boris-daich"
    },
    "creation_date" : 1760196758,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140788019,
    "post_id" : 79700701,
    "body" : "have you found a way to do it? I managed to 1) open the camera device (from GenTL), 2) download its register description XML, 3) create a node map (from GenAPI) loaded with the XML, 3) connect that node map with the GenTL device remote port, 4) list its features. But all the features have default values (0 for ints and enums, empty strings, etc.) As if it wasn&#39;t actually communicating with the camera.",
    "score" : 0,
    "owner" : {
      "account_id" : 413172,
      "reputation" : 414,
      "user_id" : 786656,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4306c19913e1f81b99f171410e31fa3e?s=256&d=identicon&r=PG",
      "display_name" : "Thibault",
      "link" : "https://stackoverflow.com/users/786656/thibault"
    },
    "creation_date" : 1760088525,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}