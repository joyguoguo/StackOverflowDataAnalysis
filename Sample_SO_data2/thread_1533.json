{
  "question" : {
    "question_id" : 79701246,
    "title" : "Set-returning functions are not allowed in WHERE",
    "body" : "<p>I am accessing a PostgreSQL database form Java using JDBC.</p>\n<p>I would like to return rows from a table <code>messages</code> where <code>id</code> matches one of multiple values, which are determined in Java code. The list of IDs to select is not anywhere in the database, and the number of IDs may vary (can be as many as 300).</p>\n<p>I had this working with HSQLDB, where I would run a parametrized query</p>\n<pre><code>select * from message where id in (unnest(?))\n</code></pre>\n<p>and populate the parameter with a <code>java.sql.Array</code> of <code>String</code> values matching the IDs I need.</p>\n<p>With PostgreSQL I get an <code>org.postgresql.util.PSQLException</code> exception saying</p>\n<blockquote>\n<p>ERROR: set-returning functions are not allowed in WHERE</p>\n</blockquote>\n<p>What is the correct way to write this statement so it will work on PostgreSQL, preferably with minimal changes to the surrounding Java code?</p>\n",
    "tags" : [ "java", "sql", "postgresql" ],
    "owner" : {
      "account_id" : 2636263,
      "reputation" : 6299,
      "user_id" : 2703209,
      "user_type" : "registered",
      "accept_rate" : 89,
      "profile_image" : "https://www.gravatar.com/avatar/01cc31c9b124d090aeb3e06f94bb8ed8?s=256&d=identicon&r=PG",
      "display_name" : "user149408",
      "link" : "https://stackoverflow.com/users/2703209/user149408"
    },
    "is_answered" : true,
    "view_count" : 178,
    "answer_count" : 4,
    "score" : 2,
    "last_activity_date" : 1752605625,
    "creation_date" : 1752517577,
    "link" : "https://stackoverflow.com/questions/79701246/set-returning-functions-are-not-allowed-in-where",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79701318,
    "question_id" : 79701246,
    "body" : "<h2><code>any(array)</code></h2>\n<p>You can use <a href=\"https://www.postgresql.org/docs/current/functions-comparisons.html#FUNCTIONS-COMPARISONS-ANY-SOME\" rel=\"nofollow noreferrer\">PostgreSQL's <code>any</code> operator</a> to directly test wether the row's <code>id</code> is in your array:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>select * from message where id = any(array[1,2]);\n</code></pre>\n<p>Or you can pass it a string formatted in a way that PostgreSQL knows to cast to an array:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>select * from message where id = any('{1,2}'::bigint[]);  \n</code></pre>\n<p>(you can even simply write <code>= any('{1,2}')</code>, however expliciting the <code>::bigint[]</code> will make PostgreSQL directly target the right type, instead of (perhaps, I'm not sure about it) casting it to a <code>text[]</code> then comparing each <code>text</code> element to a <code>bigint</code> <code>id</code>)</p>\n<p>(see it <a href=\"https://dbfiddle.uk/7FRqdI2T\" rel=\"nofollow noreferrer\">in a fiddle</a>)</p>\n",
    "score" : 6,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1422459,
      "reputation" : 7512,
      "user_id" : 1346819,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/XWC5vqjc.png?s=256",
      "display_name" : "Guillaume Outters",
      "link" : "https://stackoverflow.com/users/1346819/guillaume-outters"
    },
    "creation_date" : 1752523531,
    "last_activity_date" : 1752598908,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79701247,
    "question_id" : 79701246,
    "body" : "<p>Correct PostgreSQL syntax, and a simple drop-in replacement for the parametrized query above, is:</p>\n<pre><code>select * from message where id in (select * from unnest(?))\n</code></pre>\n",
    "score" : 4,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2636263,
      "reputation" : 6299,
      "user_id" : 2703209,
      "user_type" : "registered",
      "accept_rate" : 89,
      "profile_image" : "https://www.gravatar.com/avatar/01cc31c9b124d090aeb3e06f94bb8ed8?s=256&d=identicon&r=PG",
      "display_name" : "user149408",
      "link" : "https://stackoverflow.com/users/2703209/user149408"
    },
    "creation_date" : 1752517577,
    "last_activity_date" : 1752604968,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79701411,
    "question_id" : 79701246,
    "body" : "<p>While the array contains distinct elements:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT *\nFROM   unnest($1) id  -- use matching column name\nJOIN   message USING (id);\n</code></pre>\n<p>Even a bit cheaper for big arrays as Postgres does not try to merge duplicate entries.</p>\n<ul>\n<li><a href=\"https://dba.stackexchange.com/q/91247/3684\">Optimizing a Postgres query with a large IN</a></li>\n</ul>\n",
    "score" : 4,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 904738,
      "reputation" : 668934,
      "user_id" : 939860,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/ed7cecf2bd835cf5670d271d0d104f51?s=256&d=identicon&r=PG",
      "display_name" : "Erwin Brandstetter",
      "link" : "https://stackoverflow.com/users/939860/erwin-brandstetter"
    },
    "creation_date" : 1752533983,
    "last_activity_date" : 1752533983,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79701410,
    "question_id" : 79701246,
    "body" : "<p>If you're using Spring, use JPA and code like this:</p>\n<pre><code>public interface MessageRepository extends JpaRepository&lt;Message, Integer&gt; {\n    List&lt;Message&gt; findByIdIn(Collection&lt;Integer&gt; ids);\n}\n</code></pre>\n<p>You can read about JPA <a href=\"https://www.baeldung.com/the-persistence-layer-with-spring-data-jpa\" rel=\"nofollow noreferrer\">here</a>.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 93689,
      "reputation" : 427464,
      "user_id" : 256196,
      "user_type" : "moderator",
      "accept_rate" : 77,
      "profile_image" : "https://www.gravatar.com/avatar/d84b558fd67be10d5a718fb94231909d?s=256&d=identicon&r=PG",
      "display_name" : "Bohemian",
      "link" : "https://stackoverflow.com/users/256196/bohemian"
    },
    "creation_date" : 1752533963,
    "last_activity_date" : 1752533963,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140589123,
    "post_id" : 79701246,
    "body" : "I’ve clarified the question. I meant that the list of IDs I want to select are not in the database, but of course they will be matched against <code>message.id</code> in the DB.",
    "score" : 0,
    "owner" : {
      "account_id" : 2636263,
      "reputation" : 6299,
      "user_id" : 2703209,
      "user_type" : "registered",
      "accept_rate" : 89,
      "profile_image" : "https://www.gravatar.com/avatar/01cc31c9b124d090aeb3e06f94bb8ed8?s=256&d=identicon&r=PG",
      "display_name" : "user149408",
      "link" : "https://stackoverflow.com/users/2703209/user149408"
    },
    "creation_date" : 1752521431,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79701318" : [ {
      "comment_id" : 140592168,
      "post_id" : 79701318,
      "body" : "@user149408 Either this SQL, yes, with a <code>statement.setObject(1, idsArray);</code>, or if it doesn&#39;t work <code>statement.setArray(1, connection.createArrayOf(&#39;integer&#39;, idsArray));</code>; or SQL <code>select * from message where id = any(cast(? as bigint[]));</code> (with a <code>cast</code> instead of <code>::</code> to avoid those being mistaken for statement parameters), with a <code>statement.setString(1, idsString);</code> (<code>idsString</code> as defined in my previous comment).",
      "score" : 0,
      "owner" : {
        "account_id" : 1422459,
        "reputation" : 7512,
        "user_id" : 1346819,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/XWC5vqjc.png?s=256",
        "display_name" : "Guillaume Outters",
        "link" : "https://stackoverflow.com/users/1346819/guillaume-outters"
      },
      "creation_date" : 1752612099,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140591974,
      "post_id" : 79701318,
      "body" : "So basically, the answer is <code>select * from message where id = any(?);</code>, correct?",
      "score" : 0,
      "owner" : {
        "account_id" : 2636263,
        "reputation" : 6299,
        "user_id" : 2703209,
        "user_type" : "registered",
        "accept_rate" : 89,
        "profile_image" : "https://www.gravatar.com/avatar/01cc31c9b124d090aeb3e06f94bb8ed8?s=256&d=identicon&r=PG",
        "display_name" : "user149408",
        "link" : "https://stackoverflow.com/users/2703209/user149408"
      },
      "creation_date" : 1752605602,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140589270,
      "post_id" : 79701318,
      "body" : "@user149408 The second form is adapted to passing the array as one string:  <code>select * from message where id = any(?::bigint[]);</code>, that you pass you array of ids preconcatenated by Java (<code>String idsString = &quot;{&quot;+String.join(&quot;,&quot;, idsArray)+&quot;}&quot;;</code>) (… but this is the last resort coming from a non-Java guy, so @Charlieface&#39;s comment is probably cleaner).",
      "score" : 0,
      "owner" : {
        "account_id" : 1422459,
        "reputation" : 7512,
        "user_id" : 1346819,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/XWC5vqjc.png?s=256",
        "display_name" : "Guillaume Outters",
        "link" : "https://stackoverflow.com/users/1346819/guillaume-outters"
      },
      "creation_date" : 1752525707,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140589259,
      "post_id" : 79701318,
      "body" : "@user149408 You should pass it as an array properly, see <a href=\"https://stackoverflow.com/questions/48643892/jdbc-inserting-an-array-variable-into-a-postgresql-table\" title=\"jdbc inserting an array variable into a postgresql table\">stackoverflow.com/questions/48643892/&hellip;</a>",
      "score" : 2,
      "owner" : {
        "account_id" : 20264817,
        "reputation" : 78793,
        "user_id" : 14868997,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/40cbeeb90667c9a8c1830f615a9b2899?s=256&d=identicon&r=PG",
        "display_name" : "Charlieface",
        "link" : "https://stackoverflow.com/users/14868997/charlieface"
      },
      "creation_date" : 1752525371,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140589221,
      "post_id" : 79701318,
      "body" : "The IDs are of type <code>varchar</code>, and to be passed to the query as a parameter. I don’t see from your answer how to do that.",
      "score" : 0,
      "owner" : {
        "account_id" : 2636263,
        "reputation" : 6299,
        "user_id" : 2703209,
        "user_type" : "registered",
        "accept_rate" : 89,
        "profile_image" : "https://www.gravatar.com/avatar/01cc31c9b124d090aeb3e06f94bb8ed8?s=256&d=identicon&r=PG",
        "display_name" : "user149408",
        "link" : "https://stackoverflow.com/users/2703209/user149408"
      },
      "creation_date" : 1752524048,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}