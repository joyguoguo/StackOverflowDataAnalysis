{
  "question" : {
    "question_id" : 79673152,
    "title" : "Using @EmbeddedKafka with kafka-clients 3.9.1",
    "body" : "<p>I'm working on the aplplication using embedded kafka from <code>org.springframework.kafka:spring-kafka-test:3.3.5</code> for testing purposes. Everything worked until I had to change version of <code>org.apache.kafka:kafka-clients</code> from <code>3.8.1</code> to <code>3.9.1</code>. All test fails with <code>NoSuchMethodError</code>:</p>\n<pre><code>Caused by: java.lang.NoSuchMethodError: 'org.apache.kafka.common.network.ChannelBuilder org.apache.kafka.common.network.ChannelBuilders.serverChannelBuilder(org.apache.kafka.common.network.ListenerName, boolean, org.apache.kafka.common.security.auth.SecurityProtocol, org.apache.kafka.common.config.AbstractConfig, org.apache.kafka.common.security.authenticator.CredentialCache, org.apache.kafka.common.security.token.delegation.internals.DelegationTokenCache, org.apache.kafka.common.utils.Time, org.apache.kafka.common.utils.LogContext, java.util.function.Supplier)'\nat kafka.network.Processor.&lt;init&gt;(SocketServer.scala:977)\nat kafka.network.Acceptor.newProcessor(SocketServer.scala:882)\nat kafka.network.Acceptor.$anonfun$addProcessors$1(SocketServer.scala:852)\nat scala.collection.immutable.Range.foreach$mVc$sp(Range.scala:190)\nat kafka.network.Acceptor.addProcessors(SocketServer.scala:851)\nat kafka.network.DataPlaneAcceptor.configure(SocketServer.scala:525)\nat kafka.network.SocketServer.createDataPlaneAcceptorAndProcessors(SocketServer.scala:253)\nat kafka.network.SocketServer.$anonfun$new$31(SocketServer.scala:177)\n</code></pre>\n<p>that is thrown inside of <code>org.apache.kafka:kafka_2.13:3.8.1</code>. My assumption was that bumping all of <code>org.apache.kafka</code> dependencies to <code>3.9.1</code> will help, so I did, and result is:</p>\n<pre><code>java.lang.NoClassDefFoundError: kafka/utils/TestUtils\nat org.springframework.kafka.test.EmbeddedKafkaZKBroker$EmbeddedZookeeper.&lt;init&gt;(EmbeddedKafkaZKBroker.java:800) ~[spring-kafka-test-3.3.5.jar:3.3.5]\nat org.springframework.kafka.test.EmbeddedKafkaZKBroker.afterPropertiesSet(EmbeddedKafkaZKBroker.java:296) ~[spring-kafka-test-3.3.5.jar:3.3.5]\nat org.springframework.kafka.test.EmbeddedKafkaBrokerFactory.create(EmbeddedKafkaBrokerFactory.java:119) ~[spring-kafka-test-3.3.5.jar:3.3.5]\nat org.springframework.kafka.test.context.EmbeddedKafkaContextCustomizer.customizeContext(EmbeddedKafkaContextCustomizer.java:60) ~[spring-kafka-test-3.3.5.jar:3.3.5]\nat org.springframework.boot.test.context.SpringBootContextLoader$ContextCustomizerAdapter.initialize(SpringBootContextLoader.java:453) ~[spring-boot-test-3.4.5.jar:3.4.5]\nat org.springframework.boot.SpringApplication.applyInitializers(SpringApplication.java:612) ~[spring-boot-3.4.5.jar:3.4.5]\nat org.springframework.boot.SpringApplication.prepareContext(SpringApplication.java:383) ~[spring-boot-3.4.5.jar:3.4.5]\nat org.springframework.boot.SpringApplication.run(SpringApplication.java:317) ~[spring-boot-3.4.5.jar:3.4.5]\n</code></pre>\n<p>In fact <code>org.springframework.kafka.test.EmbeddedKafkaZKBroker</code> uses <code>kafka.utils.TestUtils</code> from <code>kafka_2.13</code> that was present in <code>3.8.1.</code> but is not available in <code>3.9.1</code>. I tried bumping <code>spring-kafka-test</code> to <code>3.3.7.</code>, but result is the same. Is there any possible way to make <code>kafka-clients:3.9.1</code> and <code>@EmbeddedKafka</code> work together?</p>\n",
    "tags" : [ "java", "apache-kafka", "spring-kafka-test" ],
    "owner" : {
      "account_id" : 18475910,
      "reputation" : 170,
      "user_id" : 13459462,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-sqG_ko7_f_w/AAAAAAAAAAI/AAAAAAAAAAA/AAKWJJPOqLF4v__7G86j0MEd3q-cSPoe8A/s256-rj/photo.jpg",
      "display_name" : "szczyzanski",
      "link" : "https://stackoverflow.com/users/13459462/szczyzanski"
    },
    "is_answered" : false,
    "view_count" : 733,
    "answer_count" : 3,
    "score" : 2,
    "last_activity_date" : 1757081066,
    "creation_date" : 1750411955,
    "link" : "https://stackoverflow.com/questions/79673152/using-embeddedkafka-with-kafka-clients-3-9-1",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79701473,
    "question_id" : 79673152,
    "body" : "<p>i solved my occurrence by adding a test scope reference to the kafka server:</p>\n<pre><code>    &quot;org.apache.kafka&quot;                  %% &quot;kafka&quot;                    % &quot;3.9.1&quot;            % &quot;test&quot;\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1345799,
      "reputation" : 918,
      "user_id" : 1286583,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/0bbPaGCY.png?s=256",
      "display_name" : "Andrew Norman",
      "link" : "https://stackoverflow.com/users/1286583/andrew-norman"
    },
    "creation_date" : 1752543967,
    "last_activity_date" : 1752543967,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79756867,
    "question_id" : 79673152,
    "body" : "<p>Forcing those dependencies works for me</p>\n<pre><code>&lt;properties&gt;    \n    &lt;kafka-clients.version&gt;3.9.1&lt;/kafka-clients.version&gt;\n&lt;/properties&gt; \n\n&lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n                &lt;artifactId&gt;kafka-server&lt;/artifactId&gt;\n                &lt;version&gt;${kafka-clients.version}&lt;/version&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n                &lt;artifactId&gt;kafka_2.13&lt;/artifactId&gt;\n                &lt;version&gt;${kafka-clients.version}&lt;/version&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n                &lt;artifactId&gt;kafka-server-common&lt;/artifactId&gt;\n                &lt;version&gt;${kafka-clients.version}&lt;/version&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n                &lt;artifactId&gt;kafka-raft&lt;/artifactId&gt;\n                &lt;version&gt;${kafka-clients.version}&lt;/version&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.apache.kafka&lt;/groupId&gt;\n                &lt;artifactId&gt;kafka-storage&lt;/artifactId&gt;\n                &lt;version&gt;${kafka-clients.version}&lt;/version&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 27581157,
      "reputation" : 1,
      "user_id" : 21050340,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f3b478cfd8fa09983e95e856e5721304?s=256&d=identicon&r=PG",
      "display_name" : "Chris-techz",
      "link" : "https://stackoverflow.com/users/21050340/chris-techz"
    },
    "creation_date" : 1757081066,
    "last_activity_date" : 1757081066,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79689956,
    "question_id" : 79673152,
    "body" : "<p>I was facing a similar issue because I was trying to update kafka-clients module to 3.9.1 on it's own.</p>\n<p>I managed to get it working by forcing all modules in group org.apache.kafka to 3.9.1 instead of just kafka-clients module on it's own.</p>\n",
    "score" : -1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 7940278,
      "reputation" : 1,
      "user_id" : 7563305,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/10153477032698660/picture?type=large",
      "display_name" : "Dinul Ahmed",
      "link" : "https://stackoverflow.com/users/7563305/dinul-ahmed"
    },
    "creation_date" : 1751621458,
    "last_activity_date" : 1751621490,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140529759,
    "post_id" : 79673152,
    "body" : "The only way is to use kafka 3.8.1, sadly",
    "score" : 1,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13627,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1750428522,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79701473" : [ {
      "comment_id" : 140745524,
      "post_id" : 79701473,
      "body" : "Hi, which version of java and spring Kafka  you&#39;re using ?  I&#39;m planning to migrate kafka-clients 3.6.1 to 3.9.1 and spring-kafka-test 2.9.5 im using",
      "score" : 0,
      "owner" : {
        "account_id" : 16270764,
        "reputation" : 1,
        "user_id" : 11749422,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/139222c14516e7f8a7bec4c747e25a7c?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "karunakar",
        "link" : "https://stackoverflow.com/users/11749422/karunakar"
      },
      "creation_date" : 1758215373,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79689956" : [ {
      "comment_id" : 140566312,
      "post_id" : 79689956,
      "body" : "You should give an example how you did that",
      "score" : 0,
      "owner" : {
        "account_id" : 2671330,
        "reputation" : 193048,
        "user_id" : 2308683,
        "user_type" : "registered",
        "accept_rate" : 90,
        "profile_image" : "https://www.gravatar.com/avatar/fb8f5877d244f223b4b6d29e0afb3a4e?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "OneCricketeer",
        "link" : "https://stackoverflow.com/users/2308683/onecricketeer"
      },
      "creation_date" : 1751684055,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}