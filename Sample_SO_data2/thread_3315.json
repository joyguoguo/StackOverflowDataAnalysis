{
  "question" : {
    "question_id" : 79559667,
    "title" : "Invalid CSRF token when calling microservices througth my Spring cloud gateway",
    "body" : "<p>I stuck on an issue in my Spring boot microservice application using Spring cloud gateway.\nI have a microservice for authentication base on Keycloak exposing some api like register, login and so on.\nWhen I call my authentication microservice I get a 200 response with the Bearer token in the case of login.\nbut when I call the same endpoint from the gateway I always have a 401 error with a Invalid CSRF token found for http://localhost:8084/api/1.0/auth/login\nI disabled the CORS in my Spring Security configuration for each of my two component (gateway and microservice).\nYou can find bellow some elements regarding the curl query, Spring Security configuration and application yaml configuration.\nI Use an Eureka Serveur to register my microservices.</p>\n<p>So with my auth microservice it's ok, I get a bearer token:</p>\n<pre><code>curl --location 'http://localhost:8083/api/1.0/auth/login' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    &quot;email&quot;: &quot;username&quot;,\n    &quot;password&quot;: &quot;password&quot;\n}'\n</code></pre>\n<p>With the gateway, I get an http 401:</p>\n<pre><code>curl --location 'http://localhost:8084/api/1.0/auth/login' \\\n--header 'Content-Type: application/json' \\\n--data-raw '{\n    &quot;email&quot;: &quot;username&quot;,\n    &quot;password&quot;: &quot;password&quot;\n}'\n</code></pre>\n<p>Gateway Security config :</p>\n<pre><code>package com.omb.ombgateway.configuration;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.web.SecurityFilterChain;\n\npublic class SecurityConfig {\n\n    @Bean\n    public SecurityFilterChain gatewaySecurity(HttpSecurity http) throws Exception {\n        http\n                .csrf(csrf -&gt; csrf.disable())\n                .cors(Customizer.withDefaults())\n                .authorizeHttpRequests(auth -&gt; auth\n                        .requestMatchers(&quot;/api/1.0/auth/**&quot;, &quot;/actuator/**&quot;, &quot;/h2-console/**&quot;).permitAll()\n                        .requestMatchers(&quot;/api/1.0/service1/**&quot;, &quot;/api/1.0/service2/**&quot;)\n                            .hasAnyRole(&quot;USER&quot;, &quot;ADMIN&quot;).anyRequest().authenticated()\n                )\n                .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt(Customizer.withDefaults()));\n        return http.build();\n    }\n}\n</code></pre>\n<p>Gateway application.yaml :</p>\n<pre><code>spring:\n  application:\n    name: omb-gateway\n  cloud:\n    gateway:\n      routes:\n        - id: auth-service\n          uri: lb://auth-service\n          predicates:\n            - Path=/api/v1/auth/**\n        - id: service1\n          uri: lb://service1\n          predicates:\n            - Path=/api/v1/service1/**\n        - id: service2\n          uri: lb://service2\n          predicates:\n            - Path=/api/v1/service2/**\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: http://localhost:8080/realms/My-Realm\nserver:\n  port: 8084\n</code></pre>\n<p>Authentication microservice security confif :</p>\n<pre><code>package com.omb.ombauth.configuration;\n\nimport org.keycloak.adapters.springboot.KeycloakSpringBootConfigResolver;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@Configuration\n@EnableWebSecurity\npublic class SecurityConfig {\n\n    @Bean\n    public KeycloakSpringBootConfigResolver keycloakConfigResolver() {\n        return new KeycloakSpringBootConfigResolver();\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(csrf -&gt; csrf.disable())\n                .cors(Customizer.withDefaults())\n                .authorizeHttpRequests(auth -&gt; auth\n                        .requestMatchers(&quot;/api/1.0/auth/**&quot;, &quot;/actuator/**&quot;, &quot;/h2-console/**&quot;).permitAll()\n                )\n                .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt(Customizer.withDefaults()));\n        http.cors(Customizer.withDefaults());\n\n        return http.build();\n    }\n\n}\n</code></pre>\n<p>Authentication microservice application.yaml</p>\n<pre><code>keycloak:\n  auth-server-url: &quot;http://localhost:8080&quot;\n  realm: &quot;My-Realm&quot;\n  resource: &quot;my-client&quot;\n  public-client: false\n  credentials:\n    secret: &quot;my-secret&quot;\nspring:\n  application:\n    name: &quot;auth-service&quot;\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: &quot;http://localhost:8080/realms/My-Realm&quot;\nserver:\n  port: 8083\n\neureka:\n  client:\n    serviceUrl:\n      defaultZone: http://localhost:8761/eureka/\n</code></pre>\n<p>I try to gat an authentication token througth my Spring Cloud gateway, but I always get an Invalid CORS error :</p>\n<pre><code>2025-04-07 11:00:18,536 DEBUG [http-nio-8084-exec-1] o.s.s.w.c.CsrfFilter: Invalid CSRF token found for http://localhost:8084/api/1.0/auth/login\n2025-04-07 11:00:18,537 DEBUG [http-nio-8084-exec-1] o.s.s.w.a.AccessDeniedHandlerImpl: Responding with 403 status code\n2025-04-07 11:00:18,537 TRACE [http-nio-8084-exec-1] o.s.s.w.h.w.HstsHeaderWriter: Not injecting HSTS header since it did not match request to [Is Secure]\n2025-04-07 11:00:18,537 TRACE [http-nio-8084-exec-1] o.s.w.f.RequestContextFilter: Cleared thread-bound request context: org.apache.catalina.connector.RequestFacade@304513e3\n2025-04-07 11:00:18,540 TRACE [http-nio-8084-exec-1] o.s.w.f.RequestContextFilter: Bound request context to thread: org.apache.catalina.core.ApplicationHttpRequest@39d025a8\n2025-04-07 11:00:18,544 TRACE [http-nio-8084-exec-1] o.s.w.s.h.AbstractHandlerMethodMapping: 2 matching mappings: [{ [/error]}, { [/error], produces [text/html]}]\n2025-04-07 11:00:18,550 TRACE [http-nio-8084-exec-1] o.s.b.f.s.AbstractBeanFactory: Returning cached instance of singleton bean 'basicErrorController'\n2025-04-07 11:00:18,551 TRACE [http-nio-8084-exec-1] o.s.s.w.FilterChainProxy: Trying to match request against DefaultSecurityFilterChain defined as 'jwtSecurityFilterChain' in [class path resource [org/springframework/boot/autoconfigure/security/oauth2/resource/servlet/OAuth2ResourceServerJwtConfiguration$OAuth2SecurityFilterChainConfiguration.class]] matching [any request] and having filters [DisableEncodeUrl, WebAsyncManagerIntegration, SecurityContextHolder, HeaderWriter, Csrf, Logout, BearerTokenAuthentication, RequestCacheAware, SecurityContextHolderAwareRequest, AnonymousAuthentication, ExceptionTranslation, Authorization] (1/1)\n2025-04-07 11:00:18,551 DEBUG [http-nio-8084-exec-1] o.s.s.w.FilterChainProxy: Securing POST /error\n</code></pre>\n<pre><code>2025-04-07 11:00:18,557 TRACE [http-nio-8084-exec-1] o.s.s.w.a.ExceptionTranslationFilter: Sending AnonymousAuthenticationToken [Principal=anonymousUser, Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=447CB86A957451F263AD98C35EBFC79C], Granted Authorities=[ROLE_ANONYMOUS]] to authentication entry point since access is denied\norg.springframework.security.authorization.AuthorizationDeniedException: Access Denied\n    at org.springframework.security.web.access.intercept.AuthorizationFilter.doFilter(AuthorizationFilter.java:99)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:126)\n    at org.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:120)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.authentication.AnonymousAuthenticationFilter.doFilter(AnonymousAuthenticationFilter.java:100)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:179)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.savedrequest.RequestCacheAwareFilter.doFilter(RequestCacheAwareFilter.java:63)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:107)\n    at org.springframework.security.web.authentication.logout.LogoutFilter.doFilter(LogoutFilter.java:93)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:82)\n    at org.springframework.security.web.context.SecurityContextHolderFilter.doFilter(SecurityContextHolderFilter.java:69)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:374)\n    at org.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:233)\n    at org.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:191)\n    at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)\n    at org.springframework.web.servlet.handler.HandlerMappingIntrospector.lambda$createCacheFilter$3(HandlerMappingIntrospector.java:243)\n    at org.springframework.web.filter.CompositeFilter$VirtualFilterChain.doFilter(CompositeFilter.java:113)\n    at org.springframework.web.filter.CompositeFilter.doFilter(CompositeFilter.java:74)\n    at org.springframework.security.config.annotation.web.configuration.WebMvcSecurityConfiguration$CompositeFilterChainProxy.doFilter(WebMvcSecurityConfiguration.java:238)\n    at org.springframework.web.filter.DelegatingFilterProxy.invokeDelegate(DelegatingFilterProxy.java:362)\n    at org.springframework.web.filter.DelegatingFilterProxy.doFilter(DelegatingFilterProxy.java:278)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.RequestContextFilter.doFilterInternal(RequestContextFilter.java:100)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:116)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:101)\n    at org.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:164)\n    at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:140)\n    at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:633)\n    at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:411)\n    at org.apache.catalina.core.ApplicationDispatcher.doForward(ApplicationDispatcher.java:331)\n    at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:268)\n    at org.apache.catalina.core.StandardHostValve.custom(StandardHostValve.java:380)\n    at org.apache.catalina.core.StandardHostValve.status(StandardHostValve.java:208)\n    at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:151)\n    at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\n    at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\n    at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:344)\n    at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)\n    at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\n    at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:905)\n    at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1743)\n    at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1190)\n    at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:659)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n    at java.base/java.lang.Thread.run(Thread.java:1583)\n2025-04-07 11:00:18,561 TRACE [http-nio-8084-exec-1] o.s.s.w.s.HttpSessionRequestCache: Did not save request since it did not match [And [Ant [pattern='/**', GET], Not [Ant [pattern='/**/favicon.*']], Not [MediaTypeRequestMatcher [contentNegotiationStrategy=org.springframework.web.accept.ContentNegotiationManager@39d2f5f2, matchingMediaTypes=[application/json], useEquals=false, ignoredMediaTypes=[*/*]]], Not [RequestHeaderRequestMatcher [expectedHeaderName=X-Requested-With, expectedHeaderValue=XMLHttpRequest]], Not [MediaTypeRequestMatcher [contentNegotiationStrategy=org.springframework.web.accept.ContentNegotiationManager@39d2f5f2, matchingMediaTypes=[multipart/form-data], useEquals=false, ignoredMediaTypes=[*/*]]], Not [MediaTypeRequestMatcher [contentNegotiationStrategy=org.springframework.web.accept.ContentNegotiationManager@39d2f5f2, matchingMediaTypes=[text/event-stream], useEquals=false, ignoredMediaTypes=[*/*]]]]]\n2025-04-07 11:00:18,562 TRACE [http-nio-8084-exec-1] o.s.w.f.RequestContextFilter: Cleared thread-bound request context: org.apache.catalina.core.ApplicationHttpRequest@39d025a8\n\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "spring-security", "csrf", "spring-cloud-gateway" ],
    "owner" : {
      "account_id" : 35382935,
      "reputation" : 17,
      "user_id" : 27171654,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ec5d995a0aae75b61d5e83836ec09dcf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ousmane MBINTE",
      "link" : "https://stackoverflow.com/users/27171654/ousmane-mbinte"
    },
    "is_answered" : false,
    "view_count" : 117,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744127846,
    "creation_date" : 1744022916,
    "link" : "https://stackoverflow.com/questions/79559667/invalid-csrf-token-when-calling-microservices-througth-my-spring-cloud-gateway",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79561742,
    "question_id" : 79559667,
    "body" : "<p>I fix my issue by a simple little correction. I forgot the @Configuration in my gateway Spring Security configuration. So I always had a default security config.\nI did some changes in my security config too by using spring cloud gateway working with webflux.</p>\n<pre><code>package com.omb.ombgateway.configuration;\n\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.web.server.ServerHttpSecurity;\nimport org.springframework.security.web.server.SecurityWebFilterChain;\nimport org.springframework.security.web.server.context.NoOpServerSecurityContextRepository;\n\n@Configuration\npublic class SecurityConfig {\n\n    @Bean\n    public SecurityWebFilterChain gatewaySecurity(ServerHttpSecurity http) throws Exception {\n        http\n                .csrf(csrf -&gt; csrf.disable())\n                .securityContextRepository(NoOpServerSecurityContextRepository.getInstance())\n                .authorizeExchange(exchanges -&gt; exchanges\n                        .pathMatchers(&quot;/api/1.0/auth/**&quot;, &quot;/actuator/**&quot;, &quot;/error&quot;).permitAll()\n                        .anyExchange().authenticated()\n                )\n                .oauth2ResourceServer(oauth2 -&gt; oauth2.jwt(Customizer.withDefaults()));\n        return http.build();\n    }\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 35382935,
      "reputation" : 17,
      "user_id" : 27171654,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ec5d995a0aae75b61d5e83836ec09dcf?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ousmane MBINTE",
      "link" : "https://stackoverflow.com/users/27171654/ousmane-mbinte"
    },
    "creation_date" : 1744107000,
    "last_activity_date" : 1744127846,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140309044,
    "post_id" : 79559667,
    "body" : "It looks like you&#39;re fighting against OAuth2 instead of using it, meaning that you&#39;ll end up with serious security breaches. You should not have any other &quot;login service&quot; than your authorization server (Keycloak), and your front end(s) should not collect user credentials (only your authorization server&#39;s UI should). Read this: <a href=\"https://www.baeldung.com/spring-cloud-gateway-bff-oauth2\" rel=\"nofollow noreferrer\">baeldung.com/spring-cloud-gateway-bff-oauth2</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 308139,
      "reputation" : 13879,
      "user_id" : 619830,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/f4d00b0a82e9307b1d68b29867fee4e5?s=256&d=identicon&r=PG",
      "display_name" : "ch4mp",
      "link" : "https://stackoverflow.com/users/619830/ch4mp"
    },
    "creation_date" : 1744049890,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}