{
  "question" : {
    "question_id" : 79732673,
    "title" : "How to use SnakeYAML to parse an array of maps?",
    "body" : "<p>I am creating a alarm rule engine. This engine takes in an alarm file (written in YAML), and creates a bunch of rules about how to handle alarm. An example of this alarm configuration file is:</p>\n<pre class=\"lang-yaml prettyprint-override\"><code>...\nalarmThreshold: 0\nalarmClearThreshold: 20\nsuppressionAlarms:\n  - source: suppSource\n    name: suppName\n</code></pre>\n<p>So <code>suppressionAlarms</code> should contain a list of maps with source and name keys.</p>\n<p>There is a Java package I am writing which ingests these YAML files and then does stuff with them. I am using SnakeYAML to parse the YAML file into the following Java object:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import lombok.AllArgsConstructor;\nimport lombok.Builder;\nimport lombok.Data;\nimport lombok.EqualsAndHashCode;\nimport lombok.NoArgsConstructor;\n\n@Data\n@EqualsAndHashCode(exclude = {&quot;comment&quot;})\n@NoArgsConstructor\n@AllArgsConstructor\n@Builder(toBuilder = true)\npublic class AlarmRuleFile {\n    private String comment;\n    private BasicRuleSetModel alarmThreshold;\n    private BasicRuleSetModel alarmClearThreshold;\n    private SuppressionRuleSetModel suppressionAlarms;\n    ...\n}\n</code></pre>\n<p>Where <code>BasicRuleSetModel</code> and <code>SuppressionRuleSetModel</code> look as follows and extend the <code>AbstractRuleSetModel</code> class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import java.util.List;\nimport lombok.Data;\nimport lombok.EqualsAndHashCode;\nimport lombok.NoArgsConstructor;\n\n@Data\n@NoArgsConstructor\n@EqualsAndHashCode(callSuper = true)\npublic class BasicRuleSetModel extends AbstractRuleSetModel&lt;BasicRuleModel, String&gt; {\n    public BasicRuleSetModel(String defaultValue) {\n        super(defaultValue);\n    }\n\n    public BasicRuleSetModel(List&lt;BasicRuleModel&gt; rules, String defaultValue) {\n        super(rules, defaultValue);\n    }\n}\n\n---\n\nimport java.util.ArrayList;\nimport java.util.LinkedHashMap;\nimport java.util.LinkedHashSet;\nimport java.util.List;\nimport java.util.Map;\nimport lombok.Data;\nimport lombok.EqualsAndHashCode;\nimport lombok.NoArgsConstructor;\n\n@Data\n@NoArgsConstructor\n@EqualsAndHashCode(callSuper = true)\npublic class SuppressionRuleSetModel extends AbstractRuleSetModel&lt;SuppressionRuleModel, List&lt;SuppressionAlarmModel&gt;&gt; {\n\n    public SuppressionRuleSetModel(List&lt;SuppressionAlarmModel&gt; defaultValue) {\n        super(defaultValue);\n    }\n\n    public SuppressionRuleSetModel(List&lt;SuppressionRuleModel&gt; rules, List&lt;SuppressionAlarmModel&gt; defaultValue) {\n        super(rules, defaultValue);\n    }\n}\n\n---\n\nimport java.util.List;\nimport lombok.AllArgsConstructor;\nimport lombok.Data;\nimport lombok.NoArgsConstructor;\nimport lombok.experimental.SuperBuilder;\n\n\n@Data\n@AllArgsConstructor\n@NoArgsConstructor\n@SuperBuilder(toBuilder = true)\npublic abstract class AbstractRuleSetModel&lt;R extends AbstractRuleModel&lt;?&gt;, D&gt; {\n    private List&lt;R&gt; rules;\n    private D defaultValue;\n\n    // handles rule set with only one value which is the default value\n    public AbstractRuleSetModel(D defaultValue) {\n        this.defaultValue = defaultValue;\n    }\n\n    public List&lt;R&gt; getRules() {\n        return rules;\n    }\n}\n</code></pre>\n<p>Where a <code>RuleModel</code> consists of some pairings of conditions/actions, though this is unrelated to the issue I am having.</p>\n<p>Now, I am writing a test to ensure that a YAML file like the one I gave above gets properly parsed into an Alarm rule file.</p>\n<pre class=\"lang-java prettyprint-override\"><code>    public void testParseAlarmYaml() {\n        String yaml = &quot;alarmThreshold: 0\\n&quot;\n                + &quot;alarmClearThreshold: 20\\n&quot;\n                + &quot;suppressionAlarms: [ { source: suppSource, name: suppName } ]&quot;;\n\n        String category = &quot;category&quot;;\n        String metric = &quot;someMetricName&quot;;\n\n        AlarmData alarmData = obj.readDataFromString(category, metric, yaml, &quot;&quot;);\n...\n}\n</code></pre>\n<p>The test fails on <code>readDataFromString</code>, which fails on the line <code>rule = yaml.loadAs(baos, AlarmRuleFile.class)</code> (<code>yaml</code> is an instance of <code>org.yaml.snakeyaml.Yaml</code>). I also have the following dumper options set:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    private DumperOptions getDumperOptions() {\n        DumperOptions options = new DumperOptions();\n        options.setDefaultFlowStyle(FlowStyle.AUTO);\n        options.setPrettyFlow(false);\n        options.setIndent(4);\n        return options;\n    }\n</code></pre>\n<p>When I try to parse the YAML file, I see the following errors:</p>\n<pre><code>     [java]     =&gt; Cannot create property=suppressionAlarms for JavaBean=AlarmRuleFile(comment=null, alarmThreshold=BasicRuleSetModel(), alarmClearThreshold=BasicRuleSetModel(), suppressionAlarms=null)\n     [java]  in 'reader', line 1, column 1:\n     [java]     alarmThreshold: 0\n     [java]     ^\n     [java] java.lang.IllegalArgumentException: argument type mismatch\n     [java]  in 'reader', line 7, column 20:\n     [java]     suppressionAlarms: [ { source: suppSource, name: su ...\n     [java]                        ^\n     [java]\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructMapping.constructJavaBean2ndStep(Constructor.java:293)\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructMapping.construct(Constructor.java:179)\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructYamlObject.construct(Constructor.java:330)\n     [java]        org.yaml.snakeyaml.constructor.BaseConstructor.constructObjectNoCheck(BaseConstructor.java:265)\n     [java]        org.yaml.snakeyaml.constructor.BaseConstructor.constructObject(BaseConstructor.java:248)\n     [java]        [...]\n     [java]      Caused by: org.yaml.snakeyaml.error.YAMLException: java.lang.IllegalArgumentException: argument type mismatch\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructSequence.construct(Constructor.java:566)\n     [java]        org.yaml.snakeyaml.constructor.BaseConstructor.constructObjectNoCheck(BaseConstructor.java:265)\n     [java]        org.yaml.snakeyaml.constructor.BaseConstructor.constructObject(BaseConstructor.java:248)\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructMapping.constructJavaBean2ndStep(Constructor.java:271)\n     [java]        [...]\n     [java]      Caused by: java.lang.IllegalArgumentException: argument type mismatch\n     [java]        java.base/jdk.internal.reflect.DirectConstructorHandleAccessor.newInstance(DirectConstructorHandleAccessor.java:65)\n     [java]        java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:502)\n     [java]        java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:486)\n     [java]        org.yaml.snakeyaml.constructor.Constructor$ConstructSequence.construct(Constructor.java:564)\n     [java]        [...]\n     [java]      Caused by: java.lang.ClassCastException: Cannot cast java.util.LinkedHashSet to java.util.List\n     [java]        java.base/java.lang.Class.cast(Class.java:4067)\n     [java]        java.base/jdk.internal.reflect.DirectConstructorHandleAccessor.newInstance(DirectConstructorHandleAccessor.java:62)\n     [java]        [...]\n</code></pre>\n<p>I am expecting the Alarm rule file object to be created successfully with a non-null <code>suppressionAlarms</code> field. I have tried using a more regular YAML syntax, e.g.</p>\n<pre class=\"lang-yaml prettyprint-override\"><code>suppressionAlarms:\n    - source: suppressionSource\n      name: suppressionName\n</code></pre>\n<p>I am curious as to why SnakeYAML is interpreting both of these as LinkedHashSets rather than a List. When I use a YAML file with one element as immediately above, if I then add the following one-argument constructor to <code>SuppressionRuleSetModel</code> the test works:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    public SuppressionRuleSetModel(LinkedHashMap&lt;String, String&gt; data) {\n        super();\n\n        // Create a single SuppressionAlarmModel from the map\n        SuppressionAlarmModel alarmModel = new SuppressionAlarmModel(\n            data.get(&quot;source&quot;),\n            data.get(&quot;name&quot;)\n        );\n\n        // Put it in a list for the defaultValue\n        List&lt;SuppressionAlarmModel&gt; alarmModels = List.of(alarmModel);\n        this.setDefaultValue(alarmModels);\n    }\n</code></pre>\n<p>However, if I add a second suppression alarm:</p>\n<pre class=\"lang-yaml prettyprint-override\"><code>suppressionAlarms: [{source: suppSource, name: suppName}, {source: suppSource2, name: suppName2}]\n</code></pre>\n<p>It produces the above &quot;Cannot convert from LinkedHashSet to List&quot; error. I tried adding a single argument constructor as before to map it to the right type:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @SuppressWarnings(&quot;unchecked&quot;)\n    public SuppressionRuleSetModel(LinkedHashSet&lt;?&gt; items) {\n        List&lt;SuppressionAlarmModel&gt; alarmModels = new ArrayList&lt;&gt;();\n\n        items.forEach(item -&gt; {\n            if (item instanceof Map) {\n                Map&lt;String, String&gt; map = (Map&lt;String, String&gt;) item;\n                alarmModels.add(new SuppressionAlarmModel(map.get(&quot;source&quot;), map.get(&quot;name&quot;)));\n            } else if (item instanceof SuppressionAlarmModel) {\n                alarmModels.add((SuppressionAlarmModel) item);\n            }\n        });\n\n        super.setDefaultValue(alarmModels);\n    }\n</code></pre>\n<p>But this does not change the error message.</p>\n",
    "tags" : [ "java", "list", "snakeyaml", "linkedhashset" ],
    "owner" : {
      "account_id" : 24373855,
      "reputation" : 1,
      "user_id" : 31257673,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/BXVom.jpg?s=256",
      "display_name" : "Chumbers",
      "link" : "https://stackoverflow.com/users/31257673/chumbers"
    },
    "is_answered" : false,
    "view_count" : 68,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1754969641,
    "creation_date" : 1754969641,
    "link" : "https://stackoverflow.com/questions/79732673/how-to-use-snakeyaml-to-parse-an-array-of-maps",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}