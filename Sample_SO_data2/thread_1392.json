{
  "question" : {
    "question_id" : 79715250,
    "title" : "AWS Elastic Beanstalk and Tomcat 9 throws FileCountLimitExceededException on Spring Boot App",
    "body" : "<p>I have a Grails 3.1 application that uses Spring Boot version 1.3.7.RELEASE. It's deployed on AWS Elastic Beanstalk using the platform &quot;Tomcat 9 with Corretto 8 running on 64bit Amazon Linux 2/4.9.1&quot;.</p>\n<p>The application has several forms submitting data with multipart/form-data.</p>\n<p>Suddenly, without any changes in the application code or configuration, POST requests from these forms started to fail with the FileCountLimitExceededException.</p>\n<p><strong>My question is:</strong></p>\n<p>How can I properly configure or fix this issue so multipart requests without files or with few files don't trigger this error?</p>\n<p>And why is this error suddenly occurring in production on AWS Elastic Beanstalk?</p>\n<p><strong>StackTrace Error:</strong></p>\n<pre><code>Jul 25 15:39:23 ip-172-31-4-71 server:\norg.springframework.web.multipart.MultipartException: Could not parse\nmultipart servlet request; nested exception is\norg.apache.tomcat.util.http.fileupload.impl.FileCountLimitExceededException:\nattachment Jul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.multipart.support.StandardMultipartHttpServletRequest.parseRequest(StandardMultipartHttpServletRequest.java:111)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.multipart.support.StandardMultipartHttpServletRequest.&lt;init&gt;(StandardMultipartHttpServletRequest.java:85)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.multipart.support.StandardServletMultipartResolver.resolveMultipart(StandardServletMultipartResolver.java:76)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.DefaultUrlMappingInfo.getResolvedRequest(DefaultUrlMappingInfo.java:280)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.DefaultUrlMappingInfo.tryMultipartParams(DefaultUrlMappingInfo.java:270)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.DefaultUrlMappingInfo.checkDispatchAction(DefaultUrlMappingInfo.java:248)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.DefaultUrlMappingInfo.getActionName(DefaultUrlMappingInfo.java:229)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.AbstractUrlMappingInfo.populateParamsForMapping(AbstractUrlMappingInfo.java:98)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.AbstractUrlMappingInfo.configure(AbstractUrlMappingInfo.java:68)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.mvc.AbstractGrailsControllerUrlMappings$_collectControllerMappings_closure1.doCall(AbstractGrailsControllerUrlMappings.groovy:183)\nJul 25 15:39:23 ip-172-31-4-71 server: at\nsun.reflect.GeneratedMethodAccessor351.invoke(Unknown Source) Jul 25\n15:39:23 ip-172-31-4-71 server: at\nsun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\nJul 25 15:39:23 ip-172-31-4-71 server: at\njava.lang.reflect.Method.invoke(Method.java:498) Jul 25 15:39:23\nip-172-31-4-71 server: at\norg.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:93)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngroovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:325) Jul 25\n15:39:23 ip-172-31-4-71 server: at\norg.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:294)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngroovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1024) Jul 25\n15:39:23 ip-172-31-4-71 server: at\ngroovy.lang.Closure.call(Closure.java:414) Jul 25 15:39:23\nip-172-31-4-71 server: at groovy.lang.Closure.call(Closure.java:430)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.codehaus.groovy.runtime.DefaultGroovyMethods.collect(DefaultGroovyMethods.java:3124)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.codehaus.groovy.runtime.DefaultGroovyMethods.collect(DefaultGroovyMethods.java:3095)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.mvc.AbstractGrailsControllerUrlMappings.collectControllerMappings(AbstractGrailsControllerUrlMappings.groovy:178)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.mapping.mvc.GrailsControllerUrlMappings.matchAll(GrailsControllerUrlMappings.java:56)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.web.mapping.UrlMappingsHolder$matchAll.call(Unknown Source) Jul\n25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.ReflectionUtils.matchAllUrlMappings(ReflectionUtils.groovy:210)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.access.intercept.AnnotationFilterInvocationDefinition.determineUrl(AnnotationFilterInvocationDefinition.groovy:109)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.access.intercept.AbstractFilterInvocationDefinition.getAttributes(AbstractFilterInvocationDefinition.groovy:74)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.access.intercept.AbstractSecurityInterceptor.beforeInvocation(AbstractSecurityInterceptor.java:196)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.access.intercept.FilterSecurityInterceptor.invoke(FilterSecurityInterceptor.java:123)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.access.intercept.FilterSecurityInterceptor.doFilter(FilterSecurityInterceptor.java:90)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.access.ExceptionTranslationFilter.doFilter(ExceptionTranslationFilter.java:114)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.UpdateRequestContextHolderExceptionTranslationFilter.doFilter(UpdateRequestContextHolderExceptionTranslationFilter.groovy:64)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.filter.GrailsAnonymousAuthenticationFilter.doFilter(GrailsAnonymousAuthenticationFilter.groovy:53)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.authentication.rememberme.RememberMeAuthenticationFilter.doFilter(RememberMeAuthenticationFilter.java:157)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter.doFilter(SecurityContextHolderAwareRequestFilter.java:169)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\njavax.servlet.FilterChain$doFilter.call(Unknown Source) Jul 25\n15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.rest.RestAuthenticationFilter.doFilter(RestAuthenticationFilter.groovy:143)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.authentication.AbstractAuthenticationProcessingFilter.doFilter(AbstractAuthenticationProcessingFilter.java:205)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.authentication.logout.MutableLogoutFilter.doFilter(MutableLogoutFilter.groovy:62)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.context.SecurityContextPersistenceFilter.doFilter(SecurityContextPersistenceFilter.java:91)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.CorsFilter.doFilterInternal(CorsFilter.java:92)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\ngrails.plugin.springsecurity.web.SecurityRequestHolderFilter.doFilter(SecurityRequestHolderFilter.groovy:58)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy$VirtualFilterChain.doFilter(FilterChainProxy.java:330)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy.doFilterInternal(FilterChainProxy.java:213)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.security.web.FilterChainProxy.doFilter(FilterChainProxy.java:176)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.servlet.mvc.GrailsWebRequestFilter.doFilterInternal(GrailsWebRequestFilter.java:75)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.filters.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:67)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.CharacterEncodingFilter.doFilterInternal(CharacterEncodingFilter.java:121)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.boot.actuate.autoconfigure.MetricsFilter.doFilterInternal(MetricsFilter.java:103)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.boot.context.web.ErrorPageFilter.doFilter(ErrorPageFilter.java:120)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.boot.context.web.ErrorPageFilter.access$000(ErrorPageFilter.java:61)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.boot.context.web.ErrorPageFilter$1.doFilterInternal(ErrorPageFilter.java:95)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.web.filter.OncePerRequestFilter.doFilter(OncePerRequestFilter.java:107)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.springframework.boot.context.web.ErrorPageFilter.doFilter(ErrorPageFilter.java:113)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.internalDoFilter(ApplicationFilterChain.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:144)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:168)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:90)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:482)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:130)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.valves.RemoteIpValve.invoke(RemoteIpValve.java:762)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:656)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:346)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.coyote.http11.Http11Processor.service(Http11Processor.java:397)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:935)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1826)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1189)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:658)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\nJul 25 15:39:23 ip-172-31-4-71 server: at\njava.lang.Thread.run(Thread.java:750) Jul 25 15:39:23 ip-172-31-4-71\nserver: Caused by:\norg.apache.tomcat.util.http.fileupload.impl.FileCountLimitExceededException:\nattachment Jul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.tomcat.util.http.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:459)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.connector.Request.parseParts(Request.java:2691)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.connector.Request.parseParameters(Request.java:3014)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.connector.Request.getParameter(Request.java:1141)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.apache.catalina.connector.RequestFacade.getParameter(RequestFacade.java:309)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.filters.HiddenHttpMethodFilter.getHttpMethodOverride(HiddenHttpMethodFilter.java:71)\nJul 25 15:39:23 ip-172-31-4-71 server: at\norg.grails.web.filters.HiddenHttpMethodFilter.doFilterInternal(HiddenHttpMethodFilter.java:60)\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "amazon-ec2", "grails", "amazon-elastic-beanstalk" ],
    "owner" : {
      "account_id" : 3405565,
      "reputation" : 924,
      "user_id" : 2856694,
      "user_type" : "registered",
      "accept_rate" : 30,
      "profile_image" : "https://i.sstatic.net/UfWHK.jpg?s=256",
      "display_name" : "Victor Soares",
      "link" : "https://stackoverflow.com/users/2856694/victor-soares"
    },
    "is_answered" : true,
    "view_count" : 127,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1753487802,
    "creation_date" : 1753477924,
    "link" : "https://stackoverflow.com/questions/79715250/aws-elastic-beanstalk-and-tomcat-9-throws-filecountlimitexceededexception-on-spr",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79715259,
    "question_id" : 79715250,
    "body" : "<p>AWS Upgrading to Tomcat 9.0.71 or later is what caused this to occur:  <a href=\"https://tomcat.apache.org/security-9.html#Fixed_in_Apache_Tomcat_9.0.71\" rel=\"nofollow noreferrer\">https://tomcat.apache.org/security-9.html#Fixed_in_Apache_Tomcat_9.0.71</a></p>\n<p>You will want to increase these settings in <code>application.yml</code></p>\n<pre><code>spring.servlet.multipart.max-file-size=10MB\nspring.servlet.multipart.max-request-size=100MB\nspring.servlet.multipart.max-parts=50\n</code></pre>\n<p>In Grails 7, which uses Spring Boot 3.5.x the settings are:</p>\n<p><code>server.tomcat.max-part-count</code><br />\n<code>server.tomcat.max-part-header-size</code></p>\n<p>If that does not work due to the older version of Grails and Spring Boot you are using, you will need to adjust the settings in tomcat's <code>$CATALINA_HOME/conf/server.xml</code></p>\n<p><a href=\"https://tomcat.apache.org/tomcat-9.0-doc/config/http.html#Attributes_Common%20Attributes_maxPartCount\" rel=\"nofollow noreferrer\">https://tomcat.apache.org/tomcat-9.0-doc/config/http.html#Attributes_Common%20Attributes_maxPartCount</a></p>\n<pre><code>&lt;Connector port=&quot;8080&quot; protocol=&quot;HTTP/1.1&quot;\n           connectionTimeout=&quot;20000&quot;\n           redirectPort=&quot;8443&quot;\n           maxPartCount=&quot;50&quot; /&gt;\n</code></pre>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 34883231,
      "reputation" : 136,
      "user_id" : 26842213,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/GBICcRQE.png?s=256",
      "display_name" : "James Fredley",
      "link" : "https://stackoverflow.com/users/26842213/james-fredley"
    },
    "creation_date" : 1753478974,
    "last_activity_date" : 1753478974,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79715259" : [ {
      "comment_id" : 140619294,
      "post_id" : 79715259,
      "body" : "The settings solutions didn&#39;t work in my version. However, adding maxPartCount to server.xml did the trick. Thank you so much for that â€” I spent the whole day trying to solve it.",
      "score" : 2,
      "owner" : {
        "account_id" : 3405565,
        "reputation" : 924,
        "user_id" : 2856694,
        "user_type" : "registered",
        "accept_rate" : 30,
        "profile_image" : "https://i.sstatic.net/UfWHK.jpg?s=256",
        "display_name" : "Victor Soares",
        "link" : "https://stackoverflow.com/users/2856694/victor-soares"
      },
      "creation_date" : 1753482915,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}