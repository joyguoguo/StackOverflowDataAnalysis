{
  "question" : {
    "question_id" : 79640648,
    "title" : "How does @KafkaListener in springboot behave when return type is void but internally uses CompletableFuture?",
    "body" : "<pre><code>    @KafkaListener(\n            topics = &quot;${kafka.consumers.foo.schema.topicName}&quot;,\n            groupId = &quot;${spring.kafka.group-id}&quot;,\n            autoStartup = &quot;${kafka.consumers.foo.autoStartup}&quot;,\n            concurrency = &quot;${kafka.consumers.foo.concurrency}&quot;,\n            containerFactory = &quot;kafkaListenerContainerFactory&quot;\n    )\n    public void consumeEvent(final ConsumerRecord&lt;String, SteamBoatEntity&lt;DomainEvents&gt;&gt; events) {\n        final DomainEvents event = events.value().record;\n        final int action = event.getAction();\n\n        CompletionStage&lt;Void&gt; result = switch (action) {\n            case EventAction.CREATE -&gt; onCreate(event);\n            case EventAction.UPDATE -&gt; onUpdate(event);\n            case EventAction.DELETE -&gt; onDelete(event);\n            default -&gt; completedStage(null);\n        };\n\n        result.whenComplete((unused, ex) -&gt; {\n            if (ex != null) {\n                logger.error(&quot;Error handling event: {}&quot;, ex.getMessage(), ex);\n            }\n        });\n    }\n</code></pre>\n<p>In this example, I don't call .join() on the future so internally it's async but the return type is void instead of CompletableFuture which is in springboots documentation here - <a href=\"https://docs.spring.io/spring-kafka/reference/kafka/receiving-messages/async-returns.html\" rel=\"nofollow noreferrer\">https://docs.spring.io/spring-kafka/reference/kafka/receiving-messages/async-returns.html</a></p>\n<p>I want to ensure that I process/ack messages in order. I'm also curious if my current setup makes it so that I'm processing too many events at once because I immediately return (since this is all async) instead of waiting for one event to be processed.</p>\n<p>Follow up question - if an exception is thrown does KafkaListener retry (assuming I add retry logic later)</p>\n",
    "tags" : [ "java", "spring-boot", "spring-kafka" ],
    "owner" : {
      "account_id" : 9143631,
      "reputation" : 165,
      "user_id" : 6800688,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/edec40e49478085f4099e42b88bbafbc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user6800688",
      "link" : "https://stackoverflow.com/users/6800688/user6800688"
    },
    "is_answered" : true,
    "view_count" : 79,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1748356579,
    "creation_date" : 1748354724,
    "link" : "https://stackoverflow.com/questions/79640648/how-does-kafkalistener-in-springboot-behave-when-return-type-is-void-but-intern",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79640690,
    "question_id" : 79640648,
    "body" : "<p>You cannot do that if you'd like to preserve an order of the records from topic. You also suffer from the lost errors situation.</p>\n<p>This behave exactly as you have just explained. The record is consumed from the topic and ack'ed immediately. Just because you shift a hard work to a different thread and don't give any control back to the Kafka listener container. So, the mention retry is also not going to work because errors are not propagated from your code.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 3273937,
      "reputation" : 122596,
      "user_id" : 2756547,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/2158ce6e7c048277890eb64458864c1c?s=256&d=identicon&r=PG",
      "display_name" : "Artem Bilan",
      "link" : "https://stackoverflow.com/users/2756547/artem-bilan"
    },
    "creation_date" : 1748356579,
    "last_activity_date" : 1748356579,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79640690" : [ {
      "comment_id" : 140463164,
      "post_id" : 79640690,
      "body" : "Correct. You shift a real work to different threads and let the Kafka consumer one to bring you more records from the topic.",
      "score" : 0,
      "owner" : {
        "account_id" : 3273937,
        "reputation" : 122596,
        "user_id" : 2756547,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/2158ce6e7c048277890eb64458864c1c?s=256&d=identicon&r=PG",
        "display_name" : "Artem Bilan",
        "link" : "https://stackoverflow.com/users/2756547/artem-bilan"
      },
      "creation_date" : 1748360710,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140462949,
      "post_id" : 79640690,
      "body" : "something I was trying earlier was to set auto.offset.reset=earliest because I wanted to consume all events from kafkas retention period of my topic from the beginning. Which is around 5 million events. When my service boots up initially it instantly crashes from CPU &amp; memory usage. Could that be caused by this async setup I had? I&#39;ll try it out in a bit but my suspicion is this should help.",
      "score" : 0,
      "owner" : {
        "account_id" : 9143631,
        "reputation" : 165,
        "user_id" : 6800688,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/edec40e49478085f4099e42b88bbafbc?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "user6800688",
        "link" : "https://stackoverflow.com/users/6800688/user6800688"
      },
      "creation_date" : 1748356992,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}