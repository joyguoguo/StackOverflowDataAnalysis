{
  "question" : {
    "question_id" : 79620060,
    "title" : "Loading a jar file into a kotlin unit test",
    "body" : "<p>I'm working on a kotlin application to send data to a third party application. The vendor has provided a jar file that we will need to run in order to actually transmit the data to them (for more details see: <a href=\"https://stackoverflow.com/questions/79614715/how-do-i-execute-a-jar-file-as-part-of-a-kotlin-application\">How do I execute a jar file as part of a kotlin application?</a>)</p>\n<p>While I have figured out how to execute the jar using java.lang.ProcessBuilder, I am struggling to implement a unit test. I wanted to create a test of my logic that calls the jar file without having to worry about the contents of the actual jar. To do that I created a simple java class, packaged it into a jar, and then put that jar into src/test/resources.</p>\n<p>In the unit test, I then load the jar as an input stream via a class loader. That input stream then gets written to a tmp file. When I call my function using that tmp file I get an error like this:</p>\n<blockquote>\n<p>java.lang.Exception: Error: Unable to access jarfile\nhello15286565382928855962.jar</p>\n</blockquote>\n<p>After some experimenting, I found that I can get around this by passing the absolute file path and the original (non-tmp) file to my function. The problem is, that will only work on my local machine and I need this test to be compatible with a CI pipeline.</p>\n<p>So then, how to I load a test resource and get the path and file name without needing a hard coded file path?</p>\n<p>My dummy class (HelloTest.jar):</p>\n<pre><code>public class Main {\n    public static void main(String[] args) throws Exception {\n        //TIP Press &lt;shortcut actionId=&quot;ShowIntentionActions&quot;/&gt; with your caret at the highlighted text\n        // to see how IntelliJ IDEA suggests fixing it.\n        System.out.printf(&quot;Hello and welcome!&quot;);\n\n        if( args.length &gt; 1 ) {\n            throw new Exception(&quot;Too many args&quot;);\n        }\n\n        for (int i = 1; i &lt;= 5; i++) {\n            //TIP Press &lt;shortcut actionId=&quot;Debug&quot;/&gt; to start debugging your code. We have set one &lt;icon src=&quot;AllIcons.Debugger.Db_set_breakpoint&quot;/&gt; breakpoint\n            // for you, but you can always add more by pressing &lt;shortcut actionId=&quot;ToggleLineBreakpoint&quot;/&gt;.\n            System.out.println(&quot;i = &quot; + i);\n        }\n    }\n}\n</code></pre>\n<p>My kotlin function to run the jar:</p>\n<pre><code>internal fun executeJavaJar(workingDir:String, jarFile:String, args:List&lt;String&gt;): Either&lt;Throwable, String&gt;\n{\n   return runCatching {\n       val cmdArgs: MutableList&lt;String&gt; = mutableListOf(&quot;java&quot;, &quot;-jar&quot;, jarFile)\n       cmdArgs.addAll(args)\n       ProcessBuilder(cmdArgs).directory(File(workingDir))\n           .redirectOutput(ProcessBuilder.Redirect.PIPE)\n           .redirectError(ProcessBuilder.Redirect.PIPE).start()\n    }.fold({\n        it-&gt;\n        val output = IOUtils.toString( it.inputStream, Charsets.UTF_8)\n        val error = IOUtils.toString( it.errorStream, Charsets.UTF_8)\n       if(error.isNotEmpty())\n       {\n          throw Exception(error)\n       }\n       else {\n           output.right()\n       }\n    }, {\n        error-&gt;\n        error.left()\n    })\n}\n</code></pre>\n<p>My unit test:</p>\n<pre><code>@Test\nfun `test execute java jar`()\n{\n    mockContext(300).value().let { context -&gt;\n        testInt295DependencyProvider(context).let { dp -&gt;\n            javaClass.classLoader.getResourceAsStream(&quot;HelloTest.jar&quot;).use { stream -&gt;                 \n\n                //this works locally but would fail in a CI build\n                executeJavaJar(&quot;/Users/userA/Documents/workspace/app-event-management/lambda-INT295/src/test/resources&quot;,\n                    &quot;HelloTest.jar&quot;, listOf(&quot;abc&quot;)).fold({\n                    fail(&quot;test execute java jar failed with error: ${it.message}&quot;)\n                }, {\n                        output-&gt;\n                    println(output)\n                    assertNotNull(output)\n                    assertThat(output).isNotEmpty\n                })\n            }\n        }\n    }\n}\n\n@Test\nfun `test execute java jar with tmp`()\n{\n    mockContext(300).value().let { context -&gt;\n        testInt295DependencyProvider(context).let { dp -&gt;\n            javaClass.classLoader.getResourceAsStream(&quot;HelloTest.jar&quot;).use { stream -&gt;\n                assertNotNull(stream)\n                val inputFile = createTempFile(prefix = &quot;hello&quot;, suffix = &quot;.jar&quot;).toFile()\n                inputFile.copyInputStreamToFile(stream)\n\n                //this throws an access error\n                executeJavaJar(&quot;.&quot;,\n                    inputFile.name, listOf(&quot;abc&quot;)).fold({\n                    fail(&quot;test execute java jar failed with error: ${it.message}&quot;)\n                }, {\n                        output-&gt;\n                    println(output)\n                    assertNotNull(output)\n                    assertThat(output).isNotEmpty\n                })\n            }\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "kotlin", "unit-testing", "jar" ],
    "owner" : {
      "account_id" : 2090213,
      "reputation" : 1839,
      "user_id" : 1860222,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/dcd9cf0881ee1e7a5f28175308628e25?s=256&d=identicon&r=PG",
      "display_name" : "pbuchheit",
      "link" : "https://stackoverflow.com/users/1860222/pbuchheit"
    },
    "is_answered" : true,
    "view_count" : 65,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1747156947,
    "creation_date" : 1747153256,
    "link" : "https://stackoverflow.com/questions/79620060/loading-a-jar-file-into-a-kotlin-unit-test",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79620124,
    "question_id" : 79620060,
    "body" : "<p><a href=\"https://stackoverflow.com/questions/79620060/loading-a-jar-file-into-a-kotlin-unit-test#comment140422245_79620060\">As k314159 said in the comments</a>, you are running <code>java -jar</code> in the current directory, but you are not passing the whole path of the jar file to <code>java -jar</code>. The temporary jar file is created in a temporary directory, which probably is not the current directory.</p>\n<p>You can pass the <code>absolutePath</code> of the file instead:</p>\n<pre><code>executeJavaJar(&quot;.&quot;, inputFile.absolutePath, listOf(&quot;abc&quot;))\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 6651855,
      "reputation" : 292280,
      "user_id" : 5133585,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/dfqcw.png?s=256",
      "display_name" : "Sweeper",
      "link" : "https://stackoverflow.com/users/5133585/sweeper"
    },
    "creation_date" : 1747156343,
    "last_activity_date" : 1747156343,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79620146,
    "question_id" : 79620060,
    "body" : "<p>Instead of passing <code>inputFile.name</code>, pass <code>inputFile.path</code>. The <code>name</code> is just the name part of the file, which doesn't include the directory. The <code>path</code> is the full path. You need to specify the full path because <code>createTempFile</code> creates the file in the default temporary directory (the exact location is platform-dependent).</p>\n<p>However, I would also advise that you stop using classes from <code>java.io</code> (such as <code>File</code>) and instead directly use classes from <code>java.nio</code> (such as <code>Path</code>).</p>\n<pre><code>    val inputFile = createTempFile(prefix = &quot;hello&quot;, suffix = &quot;.jar&quot;)\n    Files.copy(stream, inputFile)\n\n    executeJavaJar(&quot;.&quot;, inputFile.toString(), listOf(&quot;abc&quot;))\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1747156947,
    "last_activity_date" : 1747156947,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140422290,
    "post_id" : 79620060,
    "body" : "@k314159 Oh I see. I didn&#39;t think of that.",
    "score" : 0,
    "owner" : {
      "account_id" : 6651855,
      "reputation" : 292280,
      "user_id" : 5133585,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/dfqcw.png?s=256",
      "display_name" : "Sweeper",
      "link" : "https://stackoverflow.com/users/5133585/sweeper"
    },
    "creation_date" : 1747154938,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422282,
    "post_id" : 79620060,
    "body" : "But the URL might be an entry inside an enclosing jar file. The path component would be unusable in such a case.",
    "score" : 0,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1747154741,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422274,
    "post_id" : 79620060,
    "body" : "I mean the <i>path</i> component of the URL of course :)",
    "score" : 0,
    "owner" : {
      "account_id" : 6651855,
      "reputation" : 292280,
      "user_id" : 5133585,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/dfqcw.png?s=256",
      "display_name" : "Sweeper",
      "link" : "https://stackoverflow.com/users/5133585/sweeper"
    },
    "creation_date" : 1747154681,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422266,
    "post_id" : 79620060,
    "body" : "@Sweeper really? You can use a URL in a <code>java -jar</code> command? I don&#39;t see that documented at <a href=\"https://docs.oracle.com/en/java/javase/21/docs/specs/man/java.html#standard-options-for-java\" rel=\"nofollow noreferrer\">docs.oracle.com/en/java/javase/21/docs/specs/man/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1747154612,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422245,
    "post_id" : 79620060,
    "body" : "createTempFile creates the file in the temp directory, but you&#39;re passing &quot;.&quot; to executeJavaJar instead.",
    "score" : 0,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12499,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1747154304,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422217,
    "post_id" : 79620060,
    "body" : "Why not just use <code>getResource</code> instead of <code>getResourceAsStream</code>? You&#39;d get a <code>URL</code> to the jar file and you can pass that to the <code>java -jar</code> command.",
    "score" : 0,
    "owner" : {
      "account_id" : 6651855,
      "reputation" : 292280,
      "user_id" : 5133585,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/dfqcw.png?s=256",
      "display_name" : "Sweeper",
      "link" : "https://stackoverflow.com/users/5133585/sweeper"
    },
    "creation_date" : 1747153730,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}