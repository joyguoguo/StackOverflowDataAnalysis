{
  "question" : {
    "question_id" : 79585730,
    "title" : "Spring Security 6 Custom Filter not getting applied to specific url pattern in",
    "body" : "<p>I have a configuration class where I want the custom filter SecFilters to be applied to the specific url patterns only(/api/v1/, /api/* etc).I have a separate bean for login too. But this custom filter is getting applied to all urls including /login and not adhering to only the specified pattern.Below is the code.</p>\n<pre><code>@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity //Required for @PreAuthorize\npublic class SLWebConfig{\n\n    @Bean\n    @Order(1)\n    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception{\n\n        http.csrf(AbstractHttpConfigurer::disable);\n        http.authorizeHttpRequests((authz) -&gt; authz\n\n                .requestMatchers(&quot;/api/v1/&quot;).permitAll() //allowing to accessed with authentication\n                .requestMatchers(&quot;/api/*&quot;).authenticated() //securing only the client APIs\n                .requestMatchers(&quot;*/users/{userId}/**&quot;).access(new WebExpressionAuthorizationManager(&quot;@userSecurity.hasUserId(authentication,#userId)&quot;))\n        );\n        http.sessionManagement(sess -&gt; sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS));\n        http.addFilterBefore(new SecFilters(), UsernamePasswordAuthenticationFilter.class);\n        return http.build();\n    }\n\n\n\n    @Bean\n    @Order(2)\n    public SecurityFilterChain defaultFilterChain(HttpSecurity http) throws Exception{\n        http\n                .authorizeHttpRequests(auth -&gt; auth.anyRequest().permitAll())\n                .formLogin(form -&gt; form\n                        .loginPage(&quot;/login&quot;).permitAll()\n                ).csrf(AbstractHttpConfigurer::disable);\n        return http.build();\n\n    }\n\n\n    @Bean\n    public AuthenticationManager authenticationManager(AuthenticationConfiguration authenticationConfiguration)\n            throws Exception {\n        return authenticationConfiguration.getAuthenticationManager();\n    }\n}\n\n\nBelow is my custom Filter\n\n\n@Component\npublic class SecFilters extends GenericFilterBean{\n\n \n    private static TokenExtractor tokenExtractor = new BearerTokenExtractor();\n\n    private LicenseService licenseService;\n    @Autowired\n    public void setLicenseService(LicenseService licenseService) {\n        this.licenseService = licenseService;\n    }\n\n    private static final ResourceBundle resourceBundle = ResourceBundle.getBundle(&quot;i18n.messages&quot;, new Locale(&quot;en&quot;));\n\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)\n            throws IOException, ServletException {\n\n        try\n        {\n            HttpServletRequest httpServletRequest = (HttpServletRequest) request;\n            HttpServletResponse httpServletResponse = (HttpServletResponse) response;\n\n            //checking the licence of the server\n            if(licenseService.isLicenseExpired()) {\n                httpServletResponse.setStatus(HttpServletResponse.SC_FORBIDDEN);\n                return;\n            }\n\n            String requestURL = httpServletRequest.getRequestURI();\n            if(System.getenv(&quot;SERVER_LOG_LEVEL&quot;).equals(&quot;INFO&quot;)){\n                SLLogger.logInfo(httpServletRequest.getRequestURL().toString());\n            }\n\n\n            //request from UI client : Place holder\n            if (null != httpServletRequest.getHeader(&quot;www-Authorization&quot;)) {\n\n            }\n\n            String header = httpServletRequest.getHeader(&quot;Authorization&quot;);\n\n            // Get the token from the request\n\n\n\n            \n           \n            Authentication authentication = (Authentication) httpServletRequest.getUserPrincipal();\n            String token = null;\n            if(authentication != null)\n                token = authentication.getPrincipal().toString();\n           \n\n                try {\n\n                    \n\n                \n\n            chain.doFilter(request, response);\n\n        }catch (IndexOutOfBoundsException e)\n        {\n            ((HttpServletResponse) response).setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n            throw e;\n        }\n        catch (HttpClientErrorException e) {\n           \n            throw e;\n        } \n    }\n\n   \n    @Bean\n    public FilterRegistrationBean&lt;SecFilters&gt; clientRequestFilterRegistrationBean(SecFilters OAuthRequestFilter1){\n        FilterRegistrationBean&lt;SecFilters&gt; registrationBean = new FilterRegistrationBean&lt;SecFilters&gt;();\n        registrationBean.setFilter(OAuthRequestFilter1);\n        registrationBean.setEnabled(false);\n        return registrationBean;\n    }\n}\n</code></pre>\n<p>Please let me know how I can have separate rules for different urls. This has stopped working after I upgraded to spring 6 and spring boot 3.\nThank you in advance.</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "security" ],
    "owner" : {
      "account_id" : 4110235,
      "reputation" : 65,
      "user_id" : 3373220,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/46b0b420e3962915c9e42cdd333f93f8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "RituV",
      "link" : "https://stackoverflow.com/users/3373220/rituv"
    },
    "is_answered" : true,
    "view_count" : 203,
    "answer_count" : 3,
    "score" : 0,
    "last_activity_date" : 1745903940,
    "creation_date" : 1745298686,
    "link" : "https://stackoverflow.com/questions/79585730/spring-security-6-custom-filter-not-getting-applied-to-specific-url-pattern-in",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79587750,
    "question_id" : 79585730,
    "body" : "<p>To elaborate on Arno's points and to test the paths mentioned in the question, I created my <a href=\"https://github.com/Hdvlp/SpringBootCustomFilterAppliedToPaths\" rel=\"nofollow noreferrer\">example repository</a>.</p>\n<p>To avoid &quot;/login&quot; in <a href=\"https://github.com/Hdvlp/SpringBootCustomFilterAppliedToPaths/blob/main/src/main/java/com/springbootcustomfilterappliedtopaths/demo/config/CustomFilter.java\" rel=\"nofollow noreferrer\">CustomFilter</a>, I used the code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>        HttpServletRequest httpRequest = (HttpServletRequest) request;\n        if (Objects.equals(httpRequest, null)){\n            chain.doFilter(request, response);\n            return;\n        }\n        String requestPath = httpRequest.getRequestURI();\n        if (requestPath.equals(&quot;/login&quot;)) {\n            chain.doFilter(request, response);\n            return;\n        }\n</code></pre>\n<p>To test, after starting Spring Boot by <code>./mvnw spring-boot:run</code>, you might open <code>http://127.0.0.1:8080</code> in the browser and test if paths work for you:</p>\n<pre><code>/api/v1/\n/api/v2\n/api/v2/page/3\n/profile/users/alexander/page/5\n/custom/users/elizabeth/page/7\n/custom/long/path/users/felix/page/9\n/login\n</code></pre>\n<p>In the question</p>\n<pre><code>Please let me know how I can have separate rules for different urls.\n</code></pre>\n<p>I think a different SecurityFilterChain could be used for <a href=\"https://github.com/Hdvlp/SpringBootCustomFilterAppliedToPaths/blob/main/src/main/java/com/springbootcustomfilterappliedtopaths/demo/config/SecurityConfig.java\" rel=\"nofollow noreferrer\">different paths</a>.</p>\n<p>I noticed other issues in the paths in the question.</p>\n<p>This error below told me that this pattern of <code>*/users/{userId}/**</code> will not be supported.</p>\n<pre><code>One of the patterns in [*/users/{userId}/**] is missing a leading slash. This is discouraged; please include the leading slash in all your request matcher patterns. In future versions of Spring Security, leaving out the leading slash will result in an exception.\n</code></pre>\n<p>Then, I tried <code>/*/users/{userId}/**</code> and the error was gone.</p>\n<p>The latest path pattern <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/web/util/pattern/PathPattern.html\" rel=\"nofollow noreferrer\">supports ** or * at the end but not at the beginning</a>.</p>\n<pre><code>In contrast to AntPathMatcher, ** is supported only at the end of a pattern. For example /pages/{**} is valid but /pages/{**}/details is not. The same applies also to the capturing variant {*spring}. The aim is to eliminate ambiguity when comparing patterns for specificity.\n</code></pre>\n<p>I think this incompatible change was designed to eliminate the ambiguity.</p>\n<p>If you just copy the pattern in <code>AntPathMatcher</code> and paste this pattern in <code>requestMatchers</code>, the effect will not always be the same because the path patterns are interpreted differently. That means, to start improving, the paths could be improved by an example pattern <code>/left/prefix/path/**</code>, not <code>/*/asterisk/path/**</code>.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 41072977,
      "reputation" : 96,
      "user_id" : 30106291,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/LRapA3Kd.jpg?s=256",
      "display_name" : "Hdvlp",
      "link" : "https://stackoverflow.com/users/30106291/hdvlp"
    },
    "creation_date" : 1745377818,
    "last_activity_date" : 1745377818,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79586088,
    "question_id" : 79585730,
    "body" : "<p>Filters are always applied independent of the permission settings. If you want to exclude a certain path, you need to check that path in your filter to bypass logic.</p>\n<p>Enable debug mode for filters to see whole bunch of filters walked through.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 11555562,
      "reputation" : 569,
      "user_id" : 8466853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd7f72b426ce3c46739900b8ba014e26?s=256&d=identicon&r=PG",
      "display_name" : "Arno",
      "link" : "https://stackoverflow.com/users/8466853/arno"
    },
    "creation_date" : 1745313642,
    "last_activity_date" : 1745313642,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79597654,
    "question_id" : 79585730,
    "body" : "<p>I think if you want to protect only a particular endpoint As per the documentation we have to use SecurityMatchers (<em>http.securityMatcher()). authorizeHttpRequests is for further specifying for the authorization details.</em> <a href=\"https://docs.spring.io/spring-security/reference/servlet/configuration/java.html#_choosing_securitymatcher_or_requestmatchers\" rel=\"nofollow noreferrer\">https://docs.spring.io/spring-security/reference/servlet/configuration/java.html#_choosing_securitymatcher_or_requestmatchers</a>.</p>\n<p>So as per the documentation I think it should be</p>\n<pre><code>@Bean\n    public SecurityFilterChain securedFilterChain(HttpSecurity http) throws Exception {\n            http.securityMatcher(&quot;/api/v1/**&quot;)                           http.csrf(AbstractHttpConfigurer::disable);\n        http.authorizeHttpRequests((authz) -&gt; authz\n\n                .requestMatchers(&quot;/api/v1/&quot;).permitAll() //allowing to accessed with authentication\n                .requestMatchers(&quot;/api/*&quot;).authenticated() //securing only the client APIs\n                .requestMatchers(&quot;*/users/{userId}/**&quot;).access(new WebExpressionAuthorizationManager(&quot;@userSecurity.hasUserId(authentication,#userId)&quot;))\n        );\n        http.sessionManagement(sess -&gt; sess.sessionCreationPolicy(SessionCreationPolicy.STATELESS));\n        http.addFilterBefore(new SecFilters(), UsernamePasswordAuthenticationFilter.class);\n        return http.build();\n    }\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 34421176,
      "reputation" : 34,
      "user_id" : 26559705,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f8652e75e922e6151083799fe4fa6ecd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sasirekha Kumaran",
      "link" : "https://stackoverflow.com/users/26559705/sasirekha-kumaran"
    },
    "creation_date" : 1745903940,
    "last_activity_date" : 1745903940,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79587750" : [ {
      "comment_id" : 140382277,
      "post_id" : 79587750,
      "body" : "<a href=\"https://docs.spring.io/spring-security/reference/servlet/configuration/java.html#multiple-httpsecurity-instances-java\" rel=\"nofollow noreferrer\">The documentation</a> says, <code>If no filter chain matches a particular request, the request is not protected by Spring Security.</code> Is this your intention?",
      "score" : 0,
      "owner" : {
        "account_id" : 41072977,
        "reputation" : 96,
        "user_id" : 30106291,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/LRapA3Kd.jpg?s=256",
        "display_name" : "Hdvlp",
        "link" : "https://stackoverflow.com/users/30106291/hdvlp"
      },
      "creation_date" : 1745976018,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140382269,
      "post_id" : 79587750,
      "body" : "If you use <code>filterRegistrationBean with addURLPatterns</code>, the <a href=\"https://docs.spring.io/spring-security/reference/servlet/architecture.html#servlet-securityfilterchain\" rel=\"nofollow noreferrer\">SecurityFilterChain</a> is not being used to match the path. (if I understand correctly)",
      "score" : 0,
      "owner" : {
        "account_id" : 41072977,
        "reputation" : 96,
        "user_id" : 30106291,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/LRapA3Kd.jpg?s=256",
        "display_name" : "Hdvlp",
        "link" : "https://stackoverflow.com/users/30106291/hdvlp"
      },
      "creation_date" : 1745975828,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140378983,
      "post_id" : 79587750,
      "body" : "Usage of ** is not supoorted. I changed to * and added the url to be matched in filterRegistrationBean with addURLPatterns.",
      "score" : 0,
      "owner" : {
        "account_id" : 4110235,
        "reputation" : 65,
        "user_id" : 3373220,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/46b0b420e3962915c9e42cdd333f93f8?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "RituV",
        "link" : "https://stackoverflow.com/users/3373220/rituv"
      },
      "creation_date" : 1745910159,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}