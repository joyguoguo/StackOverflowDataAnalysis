{
  "question" : {
    "question_id" : 79663237,
    "title" : "Spring - JPA Apparent connection leak detected",
    "body" : "<pre><code>java.lang.Exception: Apparent connection leak detected\n    at com.zaxxer.hikari.HikariDataSource.getConnection(HikariDataSource.java:128) ~[HikariCP-5.0.1.jar:na]\n    at org.hibernate.engine.jdbc.connections.internal.DatasourceConnectionProviderImpl.getConnection(DatasourceConnectionProviderImpl.java:122) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.internal.NonContextualJdbcConnectionAccess.obtainConnection(NonContextualJdbcConnectionAccess.java:46) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.acquireConnectionIfNeeded(LogicalConnectionManagedImpl.java:113) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.resource.jdbc.internal.LogicalConnectionManagedImpl.getPhysicalConnection(LogicalConnectionManagedImpl.java:143) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.engine.jdbc.internal.StatementPreparerImpl.connection(StatementPreparerImpl.java:54) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$5.doPrepare(StatementPreparerImpl.java:153) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.engine.jdbc.internal.StatementPreparerImpl$StatementPreparationTemplate.prepareStatement(StatementPreparerImpl.java:183) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.engine.jdbc.internal.StatementPreparerImpl.prepareQueryStatement(StatementPreparerImpl.java:155) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n    at org.hibernate.sql.exec.spi.JdbcSelectExecutor.lambda$list$0(JdbcSelectExecutor.java:85) ~[hibernate-core-6.4.4.Final.jar:6.4.4.Final]\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@GetMapping\npublic ResponseEntity&lt;?&gt; getImComponentsList()  {\n    List&lt;ComponentMaterial&gt; all;\n\n    try {\n        componentAddmaterialRepository.findAllProjectedBy(); //&lt;-- SQL &lt; 1 sec\n        Thread.sleep(10_000); // some heavy load...\n        \n    } catch (Exception ex) {\n        logger.error(ex);\n        throw ex;\n    }\n}\n</code></pre>\n<pre><code>@RepositoryRestResource(exported = false)\npublic interface ComponentAddmaterialRepository extends \nJpaRepository&lt;ComponentAddmaterial, Integer&gt; {\nList&lt;MaterialNrDto&gt; findAllProjectedBy();\n\n   interface MaterialNrDto {\n       String getMaterialnr();\n   }\n}\n</code></pre>\n<p>Why i got here a Connection leak?\nI thought its because of entities but same error with projection.\nI got a request with some heavy load after some small jpa-request.</p>\n<p>Hope question is understandable.</p>\n",
    "tags" : [ "java", "spring", "jpa", "hikaricp" ],
    "owner" : {
      "account_id" : 9598629,
      "reputation" : 506,
      "user_id" : 7126967,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/07e0748a3a810f05ec56298cf54e5832?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Raw",
      "link" : "https://stackoverflow.com/users/7126967/raw"
    },
    "is_answered" : false,
    "view_count" : 115,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749722286,
    "creation_date" : 1749720020,
    "link" : "https://stackoverflow.com/questions/79663237/spring-jpa-apparent-connection-leak-detected",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140508157,
    "post_id" : 79663237,
    "body" : "As stated disable the the open-in-view. That is what is keeping the connection open.",
    "score" : 1,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1749723672,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140508154,
    "post_id" : 79663237,
    "body" : "its just a sqlrequest and after a connection in sap which makes the problem/time. For sure would be possible to split it. But i&#180;m searching for the answer to handle request like this.",
    "score" : 0,
    "owner" : {
      "account_id" : 9598629,
      "reputation" : 506,
      "user_id" : 7126967,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/07e0748a3a810f05ec56298cf54e5832?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Raw",
      "link" : "https://stackoverflow.com/users/7126967/raw"
    },
    "creation_date" : 1749723642,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140508131,
    "post_id" : 79663237,
    "body" : "Which is what I hinted at as you probably relied on that (which you shouldn&#39;t). You should write proper queries that retrieve what you need in one go. You don&#39;t and thus have a problem.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1749723255,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140508097,
    "post_id" : 79663237,
    "body" : "So i want that the connection shouldn&#180;t be reserved by the incoming request, but only for the <code>findall()</code>. My problem is when i change <code>open-in-view=false</code> , that <code>lazy-loading</code> is a problem in hole programm",
    "score" : 0,
    "owner" : {
      "account_id" : 9598629,
      "reputation" : 506,
      "user_id" : 7126967,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/07e0748a3a810f05ec56298cf54e5832?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Raw",
      "link" : "https://stackoverflow.com/users/7126967/raw"
    },
    "creation_date" : 1749722454,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140508077,
    "post_id" : 79663237,
    "body" : "Spring by default enables <code>spring.jpa.open-in-view</code> which will get a connection very early (as soon as the request comes in). When you do a <code>Thread.sleep</code> that connection is out of the pool longer then you have configured it can be and thus Hikari flags it as a connection leak. Set <code>spring.jpa.open-in-view</code> to <code>false</code> (which will probably introduce some other issues as you probably relied on automatic retrievel for things).",
    "score" : 1,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1749722144,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}