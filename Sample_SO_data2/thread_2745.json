{
  "question" : {
    "question_id" : 79600098,
    "title" : "Reactive endpoints in Quarkus returning swapped results",
    "body" : "<p>I'm pretty new to the whole reactive/mutiny/vert.x world and I have the following issue I can't quite figure out:</p>\n<p>I've got two REST endpoints, they both retrieve some data (a count) for a certain device (or list of devices) the only difference between the two endpoints is the postgres (timescaleDB) table from which the count is fetched. Now, when I call the two endpoints concurrently, sometimes I get swapped results.</p>\n<p>I've tried a few tweaks like using different types in the <code>Uni&lt;List&lt;T&gt;&gt;</code> returns or using blocking calls but nothing seems to work. I am out of ideas and most of all I do not understand how this can happen.</p>\n<p>Here's the code from the REST to the Repository layer:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Path(&quot;/api/prefix/foo&quot;)\npublic class DeviceCountResource {\n\n    private static final Logger logger = Logger.getLogger(DeviceCountResource.class);\n\n    @Inject\n    DeviceEventService deviceEventService;\n\n    @GET\n    @Produces(MediaType.APPLICATION_JSON)\n    @Path(&quot;{agent_id}/device/status-change-count&quot;)\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getDeviceStatusChangeCount(\n            @PathParam(&quot;agent_id&quot;) Long agentId,\n            @QueryParam(&quot;device_ids&quot;) @Separator(&quot;,&quot;) List&lt;Long&gt; deviceIds\n    ) {\n        return deviceEventService.getStatusChangeCount(agentId, deviceIds)\n                .invoke(counters -&gt;\n                logger.debugf(\n                        &quot;Retrieved counters status change: %s&quot;,\n                        counters\n                ));\n    }\n\n    @GET\n    @Produces(MediaType.APPLICATION_JSON)\n    @Path(&quot;{agent_id}/device/heartbeat-count&quot;)\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getHeartbeatCount(\n            @PathParam(&quot;agent_id&quot;) Long agentId,\n            @QueryParam(&quot;device_ids&quot;) @Separator(&quot;,&quot;) List&lt;Long&gt; deviceIds\n    ) {\n        return deviceEventService.getHeartbeatCount(agentId, deviceIds)\n                .invoke(counters -&gt;\n                logger.debugf(\n                        &quot;Retrieved counters heartbeat: %s&quot;,\n                        counters\n                )\n        );\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@ApplicationScoped\npublic class DeviceEventService {\n\n    private static final Logger logger = Logger.getLogger(\n        DeviceEventService.class\n    );\n\n    @Inject\n    DeviceEventRepository deviceEventRepository;\n\n    @Inject\n    DeviceStatusCountRepository deviceStatusCountRepository;\n\n\n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getStatusChangeCount(\n        Long agentId, List&lt;Long&gt; deviceIds\n    ) {\n        return deviceStatusCountRepository.getStatusChangeCount(agentId, deviceIds);\n\n    }\n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getHeartbeatCount(\n        Long agentId, List&lt;Long&gt; deviceIds\n    ) {\n        return deviceStatusCountRepository.getHeartbeatCount(agentId,\n                deviceIds);\n\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@ApplicationScoped\npublic class DeviceEventService {\n\n    private static final Logger logger = Logger.getLogger(\n        DeviceEventService.class\n    );\n\n    @Inject\n    DeviceEventRepository deviceEventRepository;\n\n    @Inject\n    DeviceStatusCountRepository deviceStatusCountRepository;\n\n    \n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getStatusChangeCount(\n        Long agentId, List&lt;Long&gt; deviceIds\n    ) {\n        return deviceStatusCountRepository.getStatusChangeCount(agentId, deviceIds);\n\n    }\n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getHeartbeatCount(\n        Long agentId, List&lt;Long&gt; deviceIds\n    ) {\n        return deviceStatusCountRepository.getHeartbeatCount(agentId,\n                deviceIds);\n\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@ApplicationScoped\npublic class DeviceStatusCountRepository {\n\n    private static final Logger logger = Logger.getLogger(\n            DeviceStatusCountRepository.class\n    );\n\n    @Inject\n    @ReactiveDataSource(&quot;timescale&quot;)\n    private Pool client;\n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getStatusChangeCount(long agentId, List&lt;Long&gt; deviceIds) {\n        StringBuilder queryBuilder = new StringBuilder(&quot;SELECT device_id, up_down_count FROM table_1_with_count WHERE agent_id = $1&quot;);\n        List&lt;Object&gt; params = new ArrayList&lt;&gt;();\n        params.add(agentId);\n\n        if (deviceIds != null &amp;&amp; !deviceIds.isEmpty()) {\n            queryBuilder.append(&quot; AND device_id IN (&quot;);\n            for (int i = 0, j = 2; i &lt; deviceIds.size(); i++, j++) {\n                if (i &gt; 0) queryBuilder.append(&quot;,&quot;);\n                queryBuilder.append(&quot;$&quot;);\n                queryBuilder.append(j);\n            }\n            queryBuilder.append(&quot;)&quot;);\n            params.addAll(deviceIds);\n        }\n\n        String query = queryBuilder.toString();\n        logger.debugf(&quot;Query: %s&quot;, query);\n\n\n        return client.withConnection( connection -&gt; connection\n        .preparedQuery(query)\n        .execute(Tuple.from(params))\n        .map(rows -&gt; {\n            logger.debugf(&quot;Query field up_down_count&quot;);\n            List&lt;DeviceCountOutDto&gt; events = new ArrayList&lt;&gt;();\n            for (Row row : rows) {\n                DeviceCountOutDto event = new DeviceCountOutDto(\n                        row.getLong(&quot;device_id&quot;),\n                        row.getInteger(&quot;up_down_count&quot;)\n                );\n                events.add(event);\n            }\n            return events;\n        })\n        );\n    }\n\n    @WithSpan\n    public Uni&lt;List&lt;DeviceCountOutDto&gt;&gt; getHeartbeatCount(long agentId,\n                                                                   List&lt;Long&gt; deviceIds) {\n        StringBuilder queryBuilder = new StringBuilder(&quot;SELECT device_id, heartbeat_count FROM table_2_with_count WHERE agent_id = $1&quot;);\n        List&lt;Object&gt; params = new ArrayList&lt;&gt;();\n        params.add(agentId);\n\n        if (deviceIds != null &amp;&amp; !deviceIds.isEmpty()) {\n            queryBuilder.append(&quot; AND device_id IN (&quot;);\n            for (int i = 0, j = 2; i &lt; deviceIds.size(); i++, j++) {\n                if (i &gt; 0) queryBuilder.append(&quot;,&quot;);\n                queryBuilder.append(&quot;$&quot;);\n                queryBuilder.append(j);\n            }\n            queryBuilder.append(&quot;)&quot;);\n            params.addAll(deviceIds);\n        }\n\n        String query = queryBuilder.toString();\n        logger.debugf(&quot;Query: %s&quot;, query);\n\n        return client.withConnection( connection -&gt; connection\n            .preparedQuery(query)\n            .execute(Tuple.from(params))\n            .map(rows -&gt; {\n                logger.debugf(&quot;Query field heartbeat_count&quot;);\n                List&lt;DeviceCountOutDto&gt; events = new ArrayList&lt;&gt;();\n                for (Row row : rows) {\n                    DeviceCountOutDto event = new DeviceCountOutDto(\n                            row.getLong(&quot;device_id&quot;),\n                            row.getInteger(&quot;heartbeat_count&quot;)\n                    );\n                    events.add(event);\n                }\n                return events;\n            })\n        );\n    }\n}\n</code></pre>\n<p>pom.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;com.company.name&lt;/groupId&gt;\n    &lt;artifactId&gt;name&lt;/artifactId&gt;\n    &lt;version&gt;1.1.0-SNAPSHOT&lt;/version&gt;\n\n    &lt;properties&gt;\n        &lt;compiler-plugin.version&gt;3.13.0&lt;/compiler-plugin.version&gt;\n        &lt;maven.compiler.release&gt;21&lt;/maven.compiler.release&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;\n        &lt;quarkus.platform.artifact-id&gt;quarkus-bom&lt;/quarkus.platform.artifact-id&gt;\n        &lt;quarkus.platform.group-id&gt;io.quarkus.platform&lt;/quarkus.platform.group-id&gt;\n        &lt;quarkus.platform.version&gt;3.21.3&lt;/quarkus.platform.version&gt;\n        &lt;skipITs&gt;true&lt;/skipITs&gt;\n        &lt;surefire-plugin.version&gt;3.5.2&lt;/surefire-plugin.version&gt;\n        &lt;org.mapstruct.version&gt;1.6.3&lt;/org.mapstruct.version&gt;\n    &lt;/properties&gt;\n\n    &lt;scm&gt;\n        &lt;developerConnection&gt;scm:git:https://bitbucket.org/company/name.git&lt;/developerConnection&gt;\n      &lt;tag&gt;HEAD&lt;/tag&gt;\n  &lt;/scm&gt;\n\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;${quarkus.platform.group-id}&lt;/groupId&gt;\n                &lt;artifactId&gt;${quarkus.platform.artifact-id}&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;${quarkus.platform.group-id}&lt;/groupId&gt;\n                &lt;artifactId&gt;quarkus-cassandra-bom&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-rest&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-arc&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-hibernate-validator&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-rest-jackson&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-smallrye-health&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-smallrye-openapi&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-jacoco&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-messaging-rabbitmq&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-jdbc-postgresql&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-container-image-docker&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-opentelemetry&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-junit5&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.datastax.oss.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;cassandra-quarkus-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkiverse.loggingsentry&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-logging-sentry&lt;/artifactId&gt;\n            &lt;version&gt;2.1.3&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.rest-assured&lt;/groupId&gt;\n            &lt;artifactId&gt;rest-assured&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;\n            &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;\n            &lt;version&gt;${org.mapstruct.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;de.siegmar&lt;/groupId&gt;\n            &lt;artifactId&gt;fastcsv&lt;/artifactId&gt;\n            &lt;version&gt;3.4.0&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.awaitility&lt;/groupId&gt;\n            &lt;artifactId&gt;awaitility&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;io.quarkus.platform&lt;/groupId&gt;\n                &lt;artifactId&gt;quarkus-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;extensions&gt;true&lt;/extensions&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;build&lt;/goal&gt;\n                            &lt;goal&gt;generate-code&lt;/goal&gt;\n                            &lt;goal&gt;generate-code-tests&lt;/goal&gt;\n                            &lt;goal&gt;native-image-agent&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;parameters&gt;true&lt;/parameters&gt;\n                    &lt;release&gt;${maven.compiler.release}&lt;/release&gt;\n                    &lt;annotationProcessorPaths&gt;\n                        &lt;path&gt;\n                            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;\n                            &lt;artifactId&gt;mapstruct-processor&lt;/artifactId&gt;\n                            &lt;version&gt;${org.mapstruct.version}&lt;/version&gt;\n                        &lt;/path&gt;\n                    &lt;/annotationProcessorPaths&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;configuration&gt;\n                        &lt;excludeTags&gt;containers&lt;/excludeTags&gt;\n                    &lt;/configuration&gt;\n                    &lt;systemPropertyVariables&gt;\n                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                    &lt;/systemPropertyVariables&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;integration-test&lt;/goal&gt;\n                            &lt;goal&gt;verify&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n                &lt;configuration&gt;\n                    &lt;systemPropertyVariables&gt;\n                        &lt;native.image.path&gt;\n                            ${project.build.directory}/${project.build.finalName}-runner&lt;/native.image.path&gt;\n                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                    &lt;/systemPropertyVariables&gt;\n                    &lt;configuration&gt;\n                        &lt;excludeTags&gt;containers&lt;/excludeTags&gt;\n                    &lt;/configuration&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-pmd-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.22.0&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;maxAllowedViolations&gt;150&lt;/maxAllowedViolations&gt;\n                    &lt;rulesets&gt;\n                        &lt;ruleset&gt;/rulesets/java/quickstart.xml&lt;/ruleset&gt;\n                    &lt;/rulesets&gt;\n                &lt;/configuration&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;phase&gt;verify&lt;/phase&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;check&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-release-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.1.1&lt;/version&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;\n                &lt;artifactId&gt;versions-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;2.18.0&lt;/version&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.codehaus.mojo&lt;/groupId&gt;\n                &lt;artifactId&gt;build-helper-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.6.0&lt;/version&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;id&gt;parse-version&lt;/id&gt;\n                        &lt;phase&gt;initialize&lt;/phase&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;parse-version&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.cyclonedx&lt;/groupId&gt;\n                &lt;artifactId&gt;cyclonedx-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;2.9.1&lt;/version&gt;  &lt;!-- Use the latest version --&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;phase&gt;package&lt;/phase&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;makeAggregateBom&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n    &lt;profiles&gt;\n        &lt;profile&gt;\n            &lt;id&gt;native&lt;/id&gt;\n            &lt;activation&gt;\n                &lt;property&gt;\n                    &lt;name&gt;native&lt;/name&gt;\n                &lt;/property&gt;\n            &lt;/activation&gt;\n            &lt;properties&gt;\n                &lt;skipITs&gt;false&lt;/skipITs&gt;\n                &lt;quarkus.native.enabled&gt;true&lt;/quarkus.native.enabled&gt;\n            &lt;/properties&gt;\n        &lt;/profile&gt;\n    &lt;/profiles&gt;\n&lt;/project&gt;\n\n</code></pre>\n<p>Here's the dependency list:</p>\n<p><a href=\"https://i.sstatic.net/YCSpsqx7.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/YCSpsqx7.png\" alt=\"dependencies\" /></a></p>\n",
    "tags" : [ "java", "reactive-programming", "quarkus", "vert.x", "mutiny" ],
    "owner" : {
      "account_id" : 24759080,
      "reputation" : 21,
      "user_id" : 18643690,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/6SyoruBM.jpg?s=256",
      "display_name" : "Eduardo Schiavo",
      "link" : "https://stackoverflow.com/users/18643690/eduardo-schiavo"
    },
    "is_answered" : true,
    "view_count" : 130,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1746454825,
    "creation_date" : 1746007884,
    "link" : "https://stackoverflow.com/questions/79600098/reactive-endpoints-in-quarkus-returning-swapped-results",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79607107,
    "question_id" : 79600098,
    "body" : "<p>We have finally understood the issue! A piece of the puzzle was missing, as in our testing environment there is a connection pooler (PgBouncer) in front of the database. Since PgBouncer was configured with “Transaction Pooling” some PostgreSQL features (like PREPARE) were broken (see <a href=\"https://stackoverflow.com\">https://www.pgbouncer.org/features.html</a>).</p>\n<p>My understanding is that the connection pooler was in some cases swapping the connections on which the queries (SELECT) were being performed after the queries were prepared.</p>\n<p>I can see two working solutions:</p>\n<h3>Solution 1</h3>\n<p>Just swap PgBouncer to &quot;Session Pooling&quot;. In this way the above code just works, as the connection pool is handled by the library in the same way as it would be if there was no PgBouncer in between and it was handling a pool of connections to postrgres</p>\n<h3>Solution 2</h3>\n<p>Do everything in a single transaction, that is use:</p>\n<pre class=\"lang-java prettyprint-override\"><code>return client.withTransaction(trans -&gt; trans.preparedQuery(query)\n            .execute(Tuple.from(params))\n            .map(rows -&gt; {\n                logger.debugf(&quot;Query field heartbeat_count&quot;);\n                List&lt;DeviceCountOutDto&gt; events = new ArrayList&lt;&gt;();\n                for (Row row : rows) {\n                    DeviceCountOutDto event = new DeviceCountOutDto(\n                            row.getLong(&quot;device_id&quot;),\n                            row.getInteger(&quot;heartbeat_count&quot;)\n                    );\n                    events.add(event);\n                }\n                return events;\n            })\n        );\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 24759080,
      "reputation" : 21,
      "user_id" : 18643690,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/6SyoruBM.jpg?s=256",
      "display_name" : "Eduardo Schiavo",
      "link" : "https://stackoverflow.com/users/18643690/eduardo-schiavo"
    },
    "creation_date" : 1746454825,
    "last_activity_date" : 1746454825,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140384129,
    "post_id" : 79600098,
    "body" : "The service calling the endpoints (i.e. the client or the script I am using to replicate the issue) also receives the wrong results.",
    "score" : 0,
    "owner" : {
      "account_id" : 24759080,
      "reputation" : 21,
      "user_id" : 18643690,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/6SyoruBM.jpg?s=256",
      "display_name" : "Eduardo Schiavo",
      "link" : "https://stackoverflow.com/users/18643690/eduardo-schiavo"
    },
    "creation_date" : 1746017647,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140384108,
    "post_id" : 79600098,
    "body" : "Do you see the mixup only in the log-messages or is it also visible somewhere else, where you are using these values? (Just to rule out that this is a logging issue, as it is not visible what Logger you are using)",
    "score" : 0,
    "owner" : {
      "account_id" : 5316725,
      "reputation" : 259,
      "user_id" : 4241377,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0ae255d91ce1ff9888243f5bd51f77c2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mr__Steel",
      "link" : "https://stackoverflow.com/users/4241377/mr-steel"
    },
    "creation_date" : 1746017365,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}