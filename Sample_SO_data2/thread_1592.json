{
  "question" : {
    "question_id" : 79695806,
    "title" : "Why are some Android APKs JAR archives and some are ZIP?",
    "body" : "<p>I am trying to modify Settings.apk of an Android 11 device to get rid of embedded suspicious likely malware URL in the code in order to disable potential control server communication.</p>\n<p>The original unmodified Settings.apk file identifies like this:</p>\n<blockquote>\n<p>Settings.apk: Java archive data (JAR)</p>\n</blockquote>\n<p>This can be decompiled in JADX with no errors.</p>\n<p>I can change it to .zip and unzip it, change the code, fix dex checksum and hash and re-zip it. The re-zipped file can still be decompiled in JADX without errors to inspect code changes, but the file now identifies like this:</p>\n<blockquote>\n<p>Settings.apk: Android package (APK), with AndroidManifest.xml</p>\n</blockquote>\n<p>And it's size after zipping is about half of the original.</p>\n<p>The re-zipped and re-signed file does not work when loaded into the device.<br />\nIf I re-sign the original APK without re-zipping it, it does run even signed with my own certificate.</p>\n<p>Does anyone know how to repackage the APK into the JAR archive or what is wrong here?</p>\n",
    "tags" : [ "java", "android", "apk", "decompiling" ],
    "owner" : {
      "account_id" : 8053223,
      "reputation" : 70,
      "user_id" : 6071138,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Athwale",
      "link" : "https://stackoverflow.com/users/6071138/athwale"
    },
    "is_answered" : true,
    "view_count" : 115,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1752666603,
    "creation_date" : 1752071442,
    "link" : "https://stackoverflow.com/questions/79695806/why-are-some-android-apks-jar-archives-and-some-are-zip",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79695830,
    "question_id" : 79695806,
    "body" : "<p>APK files are always ZIP files. Before Android 7 the only signature system was the same that was used for JAR files (today called &quot;APK signature v1&quot;), therefore some file identifier tools my detect APK files as JAR files. But nowadays this old signature format is only used if compatibility with such old Android versions is required.</p>\n<p>Regarding repackaging: You already observed one of the reasons: Your newly created zip files is too small.</p>\n<p>Check the original APK file in 7-Zip Gui and you will see that a lot of files are stored without compression. That is because Android has always used some files from within the APK file by directly from the ZIP file without decompression.</p>\n<p>In the last years Google has made Android to use more and more files that way.</p>\n<p>Most of those files used directly from within the APK have are used by mapping the whole APK into memory. Because of the memory mapping another problem may be present in your re-zipped APK: For being able to load something directly from a memory-mapped file it is required to save the file aligned to certain boundaries. Originally those files used from via memory mapping had to be aligned to 4K boundaries (default page size). Now Google want's to change the default memory page size to 16KB as this increases the overall performance of Android.</p>\n<p>Conclusion:</p>\n<ol>\n<li><p>Don't try to manipulate an APK directly with just (un)zip tools. Instead better use specialized tools like <a href=\"https://apktool.org\" rel=\"nofollow noreferrer\">apktool</a> which record which files are stored uncompressed and apply that after when rebuilding the APK. If apktool fails you can disable resource or source code decompilation and rebuilding. Then it will mainly decompress and rebuild the APK file.</p>\n</li>\n<li><p>Use <code>zipalign</code> tool from Android SDK after building the APK and before resigning it. Nowadays I would directly recommend to use <code>zipalign -v 4 input.apk output.apk</code>.</p>\n</li>\n</ol>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 50585,
      "reputation" : 43469,
      "user_id" : 150978,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
      "display_name" : "Robert",
      "link" : "https://stackoverflow.com/users/150978/robert"
    },
    "creation_date" : 1752072468,
    "last_activity_date" : 1752666603,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79695830" : [ {
      "comment_id" : 140579573,
      "post_id" : 79695830,
      "body" : "@Athwale Signing should always be the last step. APK Signature v2/v3 will be destroyed by zipalign.",
      "score" : 0,
      "owner" : {
        "account_id" : 50585,
        "reputation" : 43469,
        "user_id" : 150978,
        "user_type" : "registered",
        "accept_rate" : 78,
        "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
        "display_name" : "Robert",
        "link" : "https://stackoverflow.com/users/150978/robert"
      },
      "creation_date" : 1752146164,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140579421,
      "post_id" : 79695830,
      "body" : "Does it have to be zipaligned before or after signing?  I have a self signed apk in the priv-app folder that I wrote myself and that one launches normally.",
      "score" : 0,
      "owner" : {
        "account_id" : 8053223,
        "reputation" : 70,
        "user_id" : 6071138,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Athwale",
        "link" : "https://stackoverflow.com/users/6071138/athwale"
      },
      "creation_date" : 1752142925,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140579219,
      "post_id" : 79695830,
      "body" : "@Athwale I never tried to modify system apps, but a signature with the manufacturer key seams reasonable. The manufacturer key is usually specified when compiling an Android system. I am not sure if it supports multiple keys. As your phone seems to be rooted it may be easier to modify the app at run-time using an XPosed/LSPosed module or a frida-script. As these techniques doesn&#39;t need to modify the APK the may be easier to apply.",
      "score" : 0,
      "owner" : {
        "account_id" : 50585,
        "reputation" : 43469,
        "user_id" : 150978,
        "user_type" : "registered",
        "accept_rate" : 78,
        "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
        "display_name" : "Robert",
        "link" : "https://stackoverflow.com/users/150978/robert"
      },
      "creation_date" : 1752138510,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140579186,
      "post_id" : 79695830,
      "body" : "It looks like resigning the original unmodified APK does not actually work. I do not know why I thought it did. I thought I tested it, but I maybe made a mistake somewhere.  I think if this does not work, it might be explaining why decompiling, compiling, aligning and signing the new one also does not work.    Settings.apk is in priv-app in system_ext.img   Do these files have to be signed with the manufacturer certificate or just signed in general?  If they have to be signed by the manufacturer&#39;s cert, can I add my own somewhere to make it work?",
      "score" : 0,
      "owner" : {
        "account_id" : 8053223,
        "reputation" : 70,
        "user_id" : 6071138,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Athwale",
        "link" : "https://stackoverflow.com/users/6071138/athwale"
      },
      "creation_date" : 1752137792,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140577841,
      "post_id" : 79695830,
      "body" : "@Athwale In general there is no difference between ZIP JAR and APK files. They are all zip files, just the contained files are different. However considering the APKv2 and v3 signature there is one difference: signed ZIP files have the signature in an enlareged region that is not used in normal ZIP files. That is the only difference.",
      "score" : 0,
      "owner" : {
        "account_id" : 50585,
        "reputation" : 43469,
        "user_id" : 150978,
        "user_type" : "registered",
        "accept_rate" : 78,
        "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
        "display_name" : "Robert",
        "link" : "https://stackoverflow.com/users/150978/robert"
      },
      "creation_date" : 1752086921,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140577678,
      "post_id" : 79695830,
      "body" : "So far it looks promising. Decompiling with apktool -r -s and recompiling it with no changes make a file that differs in 0.4MB in size and the signature fails. Which is expected from your first answer.",
      "score" : 0,
      "owner" : {
        "account_id" : 8053223,
        "reputation" : 70,
        "user_id" : 6071138,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Athwale",
        "link" : "https://stackoverflow.com/users/6071138/athwale"
      },
      "creation_date" : 1752082513,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140577435,
      "post_id" : 79695830,
      "body" : "I did not know I can do that. Thanks, I will give it a shot.  If that fails, is it maybe possible to use 7zip to put it back together with just hex edited dex files?    What I still do not understand is the difference between the JAR and ZIP/APK in the files.  Something tells me this will end up as the second one and I do not know if that is a problem.",
      "score" : 0,
      "owner" : {
        "account_id" : 8053223,
        "reputation" : 70,
        "user_id" : 6071138,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Athwale",
        "link" : "https://stackoverflow.com/users/6071138/athwale"
      },
      "creation_date" : 1752077071,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140577399,
      "post_id" : 79695830,
      "body" : "@Athwale apktool can still be helpful. Just disable resource and source code decompilation. Usually that should skip all the operations that can go wrong.",
      "score" : 0,
      "owner" : {
        "account_id" : 50585,
        "reputation" : 43469,
        "user_id" : 150978,
        "user_type" : "registered",
        "accept_rate" : 78,
        "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
        "display_name" : "Robert",
        "link" : "https://stackoverflow.com/users/150978/robert"
      },
      "creation_date" : 1752076457,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140577361,
      "post_id" : 79695830,
      "body" : "Thank you. That is interesting. Unfortunately apktool is not helpful here. I have already tried it and it runs into a lot of problems with things being private.  <a href=\"https://github.com/iBotPeaches/Apktool/issues/3022\" rel=\"nofollow noreferrer\">github.com/iBotPeaches/Apktool/issues/3022</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 8053223,
        "reputation" : 70,
        "user_id" : 6071138,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e632f90e3eef0eb28ec428775ac5d1a9?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Athwale",
        "link" : "https://stackoverflow.com/users/6071138/athwale"
      },
      "creation_date" : 1752075527,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}