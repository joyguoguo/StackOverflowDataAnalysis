{
  "question" : {
    "question_id" : 79693927,
    "title" : "Kotlin Script Execution Not Working in OSGI Environment",
    "body" : "<p>I’m working on integrating Kotlin scripting support into an OSGi environment. The project is Maven-based, and I’ve included all the necessary dependencies for .kts script execution. Currently, I’m using a shaded (fat) JAR to package everything, though ideally I’d prefer a more modular or lightweight setup if available.</p>\n<p>Here’s the current list of dependencies:</p>\n<pre><code>&lt;!-- Kotlin dependencies for .kts execution --&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-osgi-bundle&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-script-runtime&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-scripting-common&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-scripting-jvm&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-scripting-jvm-host&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-compiler-embeddable&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-scripting-compiler-embeddable&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.jetbrains.kotlin&lt;/groupId&gt;\n  &lt;artifactId&gt;kotlin-scripting-jsr223&lt;/artifactId&gt;\n  &lt;version&gt;${kotlin.version}&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>To execute scripts, I’m using the following logic to initialize the Kotlin script engine:</p>\n<pre><code>ClassLoader originalClassLoader = Thread.currentThread().getContextClassLoader();\ntry {\n    Thread.currentThread().setContextClassLoader(this.getClass().getClassLoader());\n    ScriptEngineManager manager = new ScriptEngineManager();\n    this.kotlinEngine = manager.getEngineByName(&quot;kotlin&quot;);\n\n    if (this.kotlinEngine != null) {\n        LOG.info(&quot;OK: Kotlin ScriptingHost activated successfully using standard ScriptEngineManager.&quot;);\n    } else {\n        LOG.error(&quot;CRITICAL: Kotlin script engine not found. The embeddable dependency may be missing.&quot;);\n    }\n} catch (Throwable t) {\n    LOG.error(&quot;CRITICAL: A fatal error occurred during ScriptingHost activation.&quot;, t);\n} finally {\n    Thread.currentThread().setContextClassLoader(originalClassLoader);\n}\n</code></pre>\n<p>However, when executing a Kotlin script</p>\n<pre><code>this.engine.eval(this.scriptText, context);\n</code></pre>\n<p>, I get the following error:</p>\n<blockquote>\n<p>javax.script.ScriptException: ERROR Unable to initialize repl\ncompiler:</p>\n<p>DEBUG Using JDK home inferred from java.home:\n/Library/Java/JavaVirtualMachines/jdk-11.jdk/Contents/Home</p>\n<p>ERROR Unable to find kotlin stdlib, please specify it explicitly via\n“kotlin.java.stdlib.jar” property: java.lang.Exception: Unable to find\nkotlin stdlib, please specify it explicitly via\n“kotlin.java.stdlib.jar” property: java.lang.IllegalStateException:\nUnable to initialize repl compiler:</p>\n<p>…</p>\n<p>This is confusing, as the kotlin-stdlib is already included and\ncorrectly listed in the bundle’s classpath. The runtime shouldn’t need\nto be told explicitly where the kotlin-stdlib.jar is located if it’s\nalready part of the embedded bundle.</p>\n</blockquote>\n<p>Any guidance on how to address this? Specifically:</p>\n<ul>\n<li>Is there a way to declaratively satisfy the <code>kotlin.java.stdlib.jar</code> requirement within an OSGi bundle?</li>\n<li>Is this a class loader visibility issue inside the scripting engine?</li>\n<li>Are there lighter alternatives to bundling the full compiler?</li>\n</ul>\n<p>Thanks in advance for your help!</p>\n",
    "tags" : [ "java", "kotlin", "maven-3", "kotlin-multiplatform", "kotlin-maven-plugin" ],
    "owner" : {
      "account_id" : 7635537,
      "reputation" : 58,
      "user_id" : 5789205,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-QHW5AwhotNQ/AAAAAAAAAAI/AAAAAAAAAC0/U2gmUFYJP-g/s256-rj/photo.jpg",
      "display_name" : "HIMANSHU SINGHAL",
      "link" : "https://stackoverflow.com/users/5789205/himanshu-singhal"
    },
    "is_answered" : false,
    "view_count" : 88,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1751966183,
    "creation_date" : 1751963812,
    "link" : "https://stackoverflow.com/questions/79693927/kotlin-script-execution-not-working-in-osgi-environment",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}