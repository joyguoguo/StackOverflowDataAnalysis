{
  "question" : {
    "question_id" : 79618712,
    "title" : "Hibernate/JPA Not Throwing Error on Delete with Foreign Key Constraint",
    "body" : "<p>I'm trying to write some unit tests for a many to many relationship with an association table with a couple extra columns. Realistically if I try to delete an ingredient and then flush the db it should throw an exception bc of the foreign key constraint. The test IS NOT THROWING.  When I try to do this manually in my Postgres db, it does fail. My tests cases are using H2. Uncertain if that might be why.  The bizarre thing is that even though it's not throwing, I checker the count after delete is called and it doesn't seem like anything is deleted either? Hibernate seems to be silently ignoring it.</p>\n<p>Main question: why is this there no exception thrown in the unit test?</p>\n<pre><code>@Entity\n@Data\n@NoArgsConstructor\n@AllArgsConstructor\n@Builder\n@Table(uniqueConstraints = @UniqueConstraint(columnNames = { &quot;recipe_id&quot;, &quot;ingredient_id&quot; }))\npublic class RecipeIngredient {\n\n  public static enum Unit {\n    KILOGRAM, GRAM, MILLIGRAM, OUNCE, POUND, MILLILITER, LITER,\n    TEASPOON, TABLESPOON, FLUID_OUNCE, CUP, PINT, QUART, GALLON,\n    PIECE, SLICE, CLOVE, STICK, CAN, UNSPECIFIED,\n    BOTTLE, PACK, DASH, PINCH, DROP;\n  }\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\n  private Long recipeIngredientId;\n\n  @ToString.Exclude\n  @ManyToOne(optional = false)\n  @JoinColumn(\n    name = &quot;recipe_id&quot;,\n    referencedColumnName = &quot;recipeId&quot;,\n    nullable = false,\n    foreignKey = @ForeignKey(name = &quot;recipe_id_fkey&quot;)\n  )\n  private Recipe recipe;\n\n  @ToString.Exclude\n  @ManyToOne(optional = false, cascade = { CascadeType.PERSIST, CascadeType.MERGE })\n  @JoinColumn(\n    name = &quot;ingredient_id&quot;,\n    referencedColumnName = &quot;ingredientId&quot;,\n    nullable = false,\n    foreignKey = @ForeignKey(name = &quot;ingredient_id_fkey&quot;)\n  )\n  private Ingredient ingredient;\n\n  @Enumerated(EnumType.STRING)\n  private Unit unit;\n\n  @NotNull\n  @Positive\n  @Column(nullable = false)\n  private Double quantity;\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>  @Test\n  public void shouldFailToDeleteIngredient(){\n    Recipe recipe = getRecipe();\n    testEntityManager.persist(recipe);\n    testEntityManager.flush();\n    \n    assertThrows(PersistenceException.class, () -&gt; {\n        ingredientRepository.deleteAll();\n        ingredientRepository.flush();\n        testEntityManager.flush();  // Forces DB constraint to be evaluated\n    });\n  }\n</code></pre>\n<ul>\n<li>Tried deleting manually in the postgres db, it does error out there.</li>\n<li>Checking the count instead of trying to assert that an exception returns doesn't show any evidence of any records being deleted by ingredientRepository.deletAll();</li>\n<li>I was expecting this test to assert that an exception was in fact thrown.</li>\n<li>there are foreign key constraints on my posgres table when I run the server itself- so i'd assume it'd be the same for H2? Uncertain.</li>\n</ul>\n",
    "tags" : [ "java", "hibernate", "junit" ],
    "owner" : {
      "account_id" : 41939984,
      "reputation" : 1,
      "user_id" : 30519520,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2dab6915d78375a0a86bd760b0472044?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "kirsten",
      "link" : "https://stackoverflow.com/users/30519520/kirsten"
    },
    "is_answered" : false,
    "view_count" : 43,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747089500,
    "creation_date" : 1747089500,
    "link" : "https://stackoverflow.com/questions/79618712/hibernate-jpa-not-throwing-error-on-delete-with-foreign-key-constraint",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140426137,
    "post_id" : 79618712,
    "body" : "Yes- it is not throwing. My question more is WHY is it not throwing? It should be given the foreign key constraints",
    "score" : 0,
    "owner" : {
      "account_id" : 41939984,
      "reputation" : 1,
      "user_id" : 30519520,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2dab6915d78375a0a86bd760b0472044?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "kirsten",
      "link" : "https://stackoverflow.com/users/30519520/kirsten"
    },
    "creation_date" : 1747246198,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}