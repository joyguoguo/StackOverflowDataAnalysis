{
  "question" : {
    "question_id" : 79581772,
    "title" : "AndroidRuntime: java.lang.NoSuchMethodError: No static method of(Ljava/lang/Object;)Lcom/google/common/base/Optional; in class Lcom/google/common/base",
    "body" : "<h3>Problem Description</h3>\n<p>I'm new to the Android framework and trying to use the <code>external/grpc-grpc-java/</code> libraries in the framework code. However, I keep encountering crashes with <code>java.lang.NoSuchMethodError</code> related to Guava library methods. Sometimes the method names vary, but they all belong to the Guava packages.</p>\n<h3>Attempted Solutions</h3>\n<ol>\n<li><strong>Changing Library Inclusion</strong>: I tried moving <code>grpc-java-lite-static</code> from <code>static_libs</code> to <code>libs</code>, but the compilation failed because the grpc-related APIs couldn't be found now.</li>\n<li><strong>Using Prebuilt JAR</strong>: I attempted to use a prebuilt <code>guava.jar</code>, but the error persisted.</li>\n<li><strong>Library Removal</strong>: When I removed the self - defined <code>grpc-java-lite-static</code>, the error disappeared. So, the error seems to be caused by the introduction of Guava in the framework.</li>\n</ol>\n<h3>Related Android.bp Files</h3>\n<h4><code>external/grpc-grpc-java/Android.bp</code></h4>\n<pre><code>java_library {\n    name: &quot;grpc-java-lite-static&quot;,\n    host_supported: true,\n    sdk_version: &quot;current&quot;,\n    static_libs: [\n        &quot;guava&quot;,\n        &quot;jsr305&quot;,\n        &quot;grpc-java-context&quot;,\n        &quot;grpc-java-core&quot;,\n        &quot;grpc-java-core-inprocess&quot;,\n        &quot;grpc-java-core-internal&quot;,\n        &quot;grpc-java-core-util&quot;,\n        &quot;grpc-java-protobuf-lite&quot;,\n        &quot;grpc-java-stub&quot;,\n        &quot;libprotobuf-java-lite&quot;,\n    ],\n    java_version: &quot;11&quot;,\n    visibility: [&quot;//frameworks/base&quot;],\n    apex_available: [\n        &quot;//apex_available:platform&quot;,\n        &quot;//apex_available:anyapex&quot;,\n    ],\n}\n</code></pre>\n<h4><code>external/guava/Android.bp</code> (not modified)</h4>\n<pre><code>java_library {\n    name: &quot;guava&quot;,\n    host_supported: true,\n    hostdex: true,\n    sdk_version: &quot;core_current&quot;,\n    target: {\n        android: {\n            static_libs: [&quot;guava-android&quot;],\n        },\n        host: {\n            static_libs: [&quot;guava-jre&quot;],\n        },\n    },\n    apex_available: [\n        &quot;//apex_available:platform&quot;,\n        &quot;//apex_available:anyapex&quot;,\n    ],\n}\n</code></pre>\n<h4><code>frameworks/base/Android.bp</code></h4>\n<pre><code>java_library {\n    name: &quot;framework-minus-apex&quot;,\n    defaults: [&quot;framework-minus-apex-defaults&quot;],\n    installable: true,\n    // For backwards compatibility.\n    stem: &quot;framework&quot;,\n    apex_available: [&quot;//apex_available:platform&quot;],\n    visibility: [\n        &quot;//frameworks/base&quot;,\n        // TODO(b/147128803) remove the below lines\n        &quot;//frameworks/base/apex/blobstore/framework&quot;,\n        &quot;//frameworks/base/apex/jobscheduler/framework&quot;,\n        &quot;//frameworks/base/packages/Tethering/tests/unit&quot;,\n        &quot;//packages/modules/Connectivity/Tethering/tests/unit&quot;,\n    ],\n    lint: {\n        extra_check_modules: [&quot;AndroidFrameworkLintChecker&quot;],\n        disabled_checks: [&quot;ApiMightLeakAppVisibility&quot;],\n        error_checks: [\n            &quot;ClearIdentityCallNotFollowedByTryFinally&quot;,\n            &quot;NestedClearCallingIdentityCalls&quot;,\n            &quot;NonFinalTokenOfOriginalCallingIdentity&quot;,\n            &quot;RestoreIdentityCallNotInFinallyBlock&quot;,\n            &quot;ResultOfClearIdentityCallNotStoredInVariable&quot;,\n            &quot;UnusedTokenOfOriginalCallingIdentity&quot;,\n            &quot;UseOfCallerAwareMethodsWithClearedIdentity&quot;,\n        ],\n    },\n    static_libs: [ // my modification\n        &quot;grpc-java-lite-static&quot;,\n        &quot;annotation-api&quot;,\n    ],\n    errorprone: {\n        javacflags: [\n            &quot;-Xep:AndroidFrameworkCompatChange:ERROR&quot;,\n            &quot;-Xep:AndroidFrameworkUid:ERROR&quot;,\n        ],\n    },\n}\n</code></pre>\n<h3>Compilation and Crash Issues</h3>\n<p>The code compiles successfully, but all apps using Guava libraries crash. Here are some sample error messages from different apps:</p>\n<h4>Error 1</h4>\n<pre><code>04-19 01:50:01.422  4901  4901 E AndroidRuntime: java.lang.NoSuchMethodError: No direct method &lt;init&gt;()V in class Lcom/google/common/util/concurrent/AbstractFuture; or its super classes (declaration of 'com.google.common.util.concurrent.AbstractFuture' appears in /system/framework/framework.jar!classes5.dex)\n04-19 01:50:01.422  4901  4901 E AndroidRuntime:    at com.android.google.gce.gceservice.GceFuture.&lt;init&gt;(GceFuture.java:32)\n04-19 01:50:01.422  4901  4901 E AndroidRuntime:    at com.android.google.gce.gceservice.ConnectivityChecker.&lt;init&gt;(ConnectivityChecker.java:36)\n04-19 01:50:01.422  4901  4901 E AndroidRuntime:    at com.android.google.gce.gceservice.GceService.onCreate(GceService.java:78)\n</code></pre>\n<h4>Error 2</h4>\n<pre><code>04-19 01:50:00.311  4616  4616 E AndroidRuntime: java.lang.NoSuchMethodError: No direct method &lt;init&gt;()V in class Lcom/google/common/util/concurrent/AbstractFuture; or its super classes (declaration of 'com.google.common.util.concurrent.AbstractFuture' appears in /system/framework/framework.jar!classes5.dex)\n04-19 01:50:00.311  4616  4616 E AndroidRuntime:    at com.android.google.gce.gceservice.GceFuture.&lt;init&gt;(GceFuture.java:32)\n04-19 01:50:00.311  4616  4616 E AndroidRuntime:    at com.android.google.gce.gceservice.ConnectivityChecker.&lt;init&gt;(ConnectivityChecker.java:36)\n04-19 01:50:00.311  4616  4616 E AndroidRuntime:    at com.android.google.gce.gceservice.GceService.onCreate(GceService.java:78)\n</code></pre>\n<h4>Error 3</h4>\n<pre><code>04-17 20:14:17.447  3539  3539 E AndroidRuntime: Process: com.android.camera2, PID: 3539\n04-17 20:14:17.447  3539  3539 E AndroidRuntime: java.lang.NoSuchMethodError: No static method of(Ljava/lang/Object;)Lcom/google/common/base/Optional; in class Lcom/google/common/base/Optional; or its super classes (declaration of 'com.google.common.base.Optional' appears in /system/framework/framework.jar!classes5.dex)\n04-17 20:14:17.447  3539  3539 E AndroidRuntime:    at com.android.camera.one.v2.Camera2OneCameraOpenerImpl.create(Camera2OneCameraOpenerImpl.java:82)\n04-17 20:14:17.447  3539  3539 E AndroidRuntime:    at com.android.camera.one.OneCameraModule.provideOneCameraOpener(OneCameraModule.java:48)\n04-17 20:14:17.447  3539  3539 E AndroidRuntime:    at com.android.camera.CameraActivity.onCreateTasks(CameraActivity.java:1436)\n</code></pre>\n<h3>Other Apps Using Guava</h3>\n<h4><code>AOSP/packages/apps/Contacts/Android.bp</code></h4>\n<pre><code>android_app {\n    name: &quot;Contacts&quot;,\n    srcs: [\n        &quot;src/**/*.java&quot;,\n        &quot;src-bind/**/*.java&quot;,\n    ],\n    static_libs: [\n        &quot;com.android.phone.common-lib&quot;,\n        &quot;guava&quot;,\n        &quot;com.google.android.material_material&quot;,\n        &quot;androidx.transition_transition&quot;,\n        &quot;androidx.legacy_legacy-support-v13&quot;,\n        &quot;androidx.appcompat_appcompat&quot;,\n        &quot;androidx.cardview_cardview&quot;,\n        &quot;androidx.recyclerview_recyclerview&quot;,\n        &quot;androidx.palette_palette&quot;,\n        &quot;androidx.legacy_legacy-support-v4&quot;,\n        &quot;android-common&quot;,\n        &quot;com.android.vcard&quot;,\n        &quot;libphonenumber&quot;,\n    ],\n    certificate: &quot;shared&quot;,\n    product_specific: true,\n    privileged: true,\n    required: [&quot;privapp_whitelist_com.android.contacts&quot;],\n    optimize: {\n        proguard_flags_files: [&quot;proguard.flags&quot;],\n    },\n    sdk_version: &quot;system_current&quot;,\n    min_sdk_version: &quot;30&quot;,\n}\n</code></pre>\n<h4><code>AOSP/packages/apps/Camera2/Android.bp</code></h4>\n<pre><code>android_app {\n    name: &quot;Camera2&quot;,\n    static_libs: [\n        &quot;androidx.legacy_legacy-support-v13&quot;,\n        &quot;androidx.legacy_legacy-support-v4&quot;,\n        &quot;androidx.core_core&quot;,\n        &quot;android-ex-camera2-portability&quot;,\n        &quot;xmp_toolkit&quot;,\n        &quot;glide&quot;,\n        &quot;guava&quot;,\n        &quot;jsr305&quot;,\n    ],\n    optional_uses_libs: [&quot;org.apache.http.legacy&quot;],\n    srcs: [\n        &quot;src/**/*.java&quot;,\n        &quot;src_pd/**/*.java&quot;,\n        &quot;src_pd_gcam/**/*.java&quot;,\n    ],\n    resource_dirs: [\n        &quot;res&quot;,\n        &quot;res_p&quot;,\n    ],\n    //...\n}\n</code></pre>\n<h3>Request for Help</h3>\n<p>I'm seeking assistance in resolving this issue. Thanks in advance!</p>\n",
    "tags" : [ "java", "android", "ninja", "android-soong" ],
    "owner" : {
      "account_id" : 41482263,
      "reputation" : 11,
      "user_id" : 30310839,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e0be264e5867abbc3e6ddc78bef308a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tian Jianwen",
      "link" : "https://stackoverflow.com/users/30310839/tian-jianwen"
    },
    "is_answered" : false,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1746450417,
    "creation_date" : 1745012548,
    "link" : "https://stackoverflow.com/questions/79581772/androidruntime-java-lang-nosuchmethoderror-no-static-method-ofljava-lang-obje",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79606973,
    "question_id" : 79581772,
    "body" : "<p>This problem is solved since there are multiple guava in the system, all I need to do is using the jarjar to change the function names. For example,</p>\n<pre class=\"lang-none prettyprint-override\"><code>rule com.google.common.** com.google.shaded.common.@1\nrule io.grpc.** io.grpc.shaded.@1\nrule com.google.protobuf.** com.google.shaded.protobuf.@1\nrule kotlin.** kotlin.shaded.@1\nrule io.perfmark.** io.shaded.perfmark.@1\nrule okio.** okio.k.@1\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 41482263,
      "reputation" : 11,
      "user_id" : 30310839,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e0be264e5867abbc3e6ddc78bef308a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tian Jianwen",
      "link" : "https://stackoverflow.com/users/30310839/tian-jianwen"
    },
    "creation_date" : 1746450417,
    "last_activity_date" : 1746450417,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}