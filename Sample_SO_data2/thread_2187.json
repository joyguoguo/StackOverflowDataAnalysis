{
  "question" : {
    "question_id" : 79642549,
    "title" : "Spring JPA / Hibernate performance loading for Nested Collections",
    "body" : "<p>For sake of simplicity, consider the following entities and do assume that they are declared correctly as</p>\n<p>Here are my entities</p>\n<pre><code>class EntityA {\n\n    private String id;\n\n    @OneToMany\n    List&lt;EntityB&gt; entityBList;\n\n    @OneToMany\n    List&lt;EntityC&gt; entityCList;\n}\n\nclass EntityB {\n    private String idB;\n\n    @ManyToOne\n    EntityA entityA;\n}\n\nclass EntityC {\n\n    private String idC;\n\n    @OneToMany\n    List&lt;EntityD&gt; entityDList;\n\n    @ManyToOne\n    EntityA entityA;\n}\n\nclass EntityD {\n\n    private String idD;\n\n    @ManyToOne\n    private EntityC entityC;\n}\n</code></pre>\n<p>Notice that above has nested collections</p>\n<p>Suppose i want to get a 1000 EntityA (complete with all the collections and collections of its children and i wanted them to be loaded already, when i do, say a repo call <code>Optional&lt;List&lt;EntityA&gt;&gt; findEntityAById(String id);</code></p>\n<p>Expected result of the above repo call would be</p>\n<p><code>EntityA</code> would have a list of both <code>EntityB</code> and <code>EntityC</code> BUT i wanted also to have <code>EntityD</code> list already loaded in <code>EntityC</code></p>\n<p>Basically performing only some query in building the result set (including collections and its nested collections) at the start and when processing of those collections there would be no N+1 query that will be executed, ultimately minimizing calls to DB</p>\n<p>Here is what i know currently,</p>\n<ol>\n<li>Was able to do <code>EntityGraph</code> however, i cannot load the nested collection of <code>EntityD</code> in <code>EntityC</code>, still result into N+1 issue</li>\n<li>Subgraph does not seem to work as it will result into MuiltipleBagException, Subgraph Definition below, called them into 2 separate repo call.</li>\n</ol>\n<p><strong>Subgraph Definition</strong></p>\n<pre><code>@NamedEntityGraph(\n        name = &quot;EntityAPlusEntityB&quot;,\n        attributeNodes = {\n                @NamedAttributeNode(&quot;entityBList&quot;)\n        }\n)\n@NamedEntityGraph(\n        name = &quot;EntityAPlusEntityC&quot;,\n        attributeNodes = {\n                @NamedAttributeNode( value = &quot;entityCList&quot;, subgraph = &quot;EntityCPlusEntityD&quot;)\n        },\n        subgraphs = {\n                @NamedSubgraph(\n                        name = &quot;EntityCPlusEntityD&quot;,\n                        attributeNodes = {\n                                @NamedAttributeNode(&quot;entityDList&quot;)\n                        }\n                )\n        }\n)\nclass EntityA {}\n\n@EntityGraph(value = &quot;EntityAPlusEntityB&quot;, type = EntityGraph.EntityGraphType.FETCH)\nOptional&lt;List&lt;EntityA&gt;&gt; findEntityAById_LoadEntityB(String id);\n\n@EntityGraph(value = &quot;EntityAPlusEntityC&quot;, type = EntityGraph.EntityGraphType.FETCH)\nOptional&lt;List&lt;EntityA&gt;&gt; findEntityAById_LoadEntityC(String id);\n</code></pre>\n<p><strong>The Problem</strong></p>\n<p>Currently, i still can't get the loaded list of EntityD in EntityC, will always results into a separate SQL executed by hibernate whenever i do entityC.getEntityDList(). As i expect that everything is loaded at the start, there should be no other SQL query executed as it will be an N+1 issue.</p>\n<p><em><strong>Anyone knows another elegant, performant, fast, way of doing this?</strong></em></p>\n<p><strong>Additional Information</strong></p>\n<p>below are configured in prop file</p>\n<pre><code>spring.jpa.show-sql=true\nspring.jpa.properties.hibernate.format_sql=true\n</code></pre>\n",
    "tags" : [ "java", "spring", "hibernate", "jpa", "spring-data-jpa" ],
    "owner" : {
      "account_id" : 1681527,
      "reputation" : 2421,
      "user_id" : 1545664,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/2ff2ece582b904e59012f55bd5a91926?s=256&d=identicon&r=PG",
      "display_name" : "lemoncodes",
      "link" : "https://stackoverflow.com/users/1545664/lemoncodes"
    },
    "is_answered" : false,
    "view_count" : 79,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1748446941,
    "creation_date" : 1748446083,
    "link" : "https://stackoverflow.com/questions/79642549/spring-jpa-hibernate-performance-loading-for-nested-collections",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140467789,
    "post_id" : 79642549,
    "body" : "@YasinAhmed yeah my problem is on the nested collections, it wont load the way i expected it to be, maybe i missed something, specially on the subgraph",
    "score" : 0,
    "owner" : {
      "account_id" : 1681527,
      "reputation" : 2421,
      "user_id" : 1545664,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/2ff2ece582b904e59012f55bd5a91926?s=256&d=identicon&r=PG",
      "display_name" : "lemoncodes",
      "link" : "https://stackoverflow.com/users/1545664/lemoncodes"
    },
    "creation_date" : 1748472926,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140466797,
    "post_id" : 79642549,
    "body" : "You are already half way there as EntityGraph is already an elegant and efficient way. Check this to resolve MuiltipleBagException <a href=\"https://stackoverflow.com/questions/10769656/how-to-use-jpa-2-0-manytomany-without-issues/10769858#10769858\" title=\"how to use jpa 2 0 manytomany without issues\">stackoverflow.com/questions/10769656/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 16860149,
      "reputation" : 181,
      "user_id" : 12191150,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fec9a6154254eb5fd901f4a0045c0b1f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Yasin Ahmed",
      "link" : "https://stackoverflow.com/users/12191150/yasin-ahmed"
    },
    "creation_date" : 1748448815,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}