{
  "question" : {
    "question_id" : 79642579,
    "title" : "How can I avoid IllegalStateException: Duplicate key in Java Streams?",
    "body" : "<p>I'm trying to convert a list of objects to a <code>Map</code> using Java Streams:</p>\n<pre class=\"lang-java prettyprint-override\"><code>List&lt;String&gt; list = List.of(&quot;a&quot;, &quot;b&quot;, &quot;a&quot;);\nMap&lt;String, Integer&gt; map = list.stream()\n    .collect(Collectors.toMap(s -&gt; s, String::length));\n</code></pre>\n<p>This throws:</p>\n<pre><code>java.lang.IllegalStateException: Duplicate key a (attempted merging values 1 and 1)\n</code></pre>\n<p>I expected it to just create a map with unique keys, but I forgot that my list has duplicates. What's the correct way to handle this if duplicates may occur? Is there a way to merge them, or just keep the first one?</p>\n",
    "tags" : [ "java", "java-stream", "collectors" ],
    "owner" : {
      "account_id" : 15297821,
      "reputation" : 61,
      "user_id" : 11037282,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CUr30.jpg?s=256",
      "display_name" : "Vitalii",
      "link" : "https://stackoverflow.com/users/11037282/vitalii"
    },
    "is_answered" : true,
    "view_count" : 191,
    "closed_date" : 1748608368,
    "answer_count" : 2,
    "score" : 6,
    "last_activity_date" : 1748608480,
    "creation_date" : 1748447043,
    "link" : "https://stackoverflow.com/questions/79642579/how-can-i-avoid-illegalstateexception-duplicate-key-in-java-streams",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79642591,
    "question_id" : 79642579,
    "body" : "<p>Make sure you have 'distinct' values:</p>\n<pre><code>Map&lt;String, Integer&gt; map = list.stream()\n    .distinct()\n    .collect(Collectors.toMap(s -&gt; s, String::length));\n</code></pre>\n",
    "score" : 12,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 18182,
      "reputation" : 34581,
      "user_id" : 41423,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/Z3ixY.jpg?s=256",
      "display_name" : "Nick Holt",
      "link" : "https://stackoverflow.com/users/41423/nick-holt"
    },
    "creation_date" : 1748447497,
    "last_activity_date" : 1748447497,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79642599,
    "question_id" : 79642579,
    "body" : "<p>It throws the exception because the Collector does not know what to do with the duplicates in the merge operation. In its internal it will use:</p>\n<pre><code>    /**\n     * {@code BiConsumer&lt;Map, T&gt;} that accumulates (key, value) pairs\n     * extracted from elements into the map, throwing {@code IllegalStateException}\n     * if duplicate keys are encountered.\n     *\n     * @param keyMapper a function that maps an element into a key\n     * @param valueMapper a function that maps an element into a value\n     * @param &lt;T&gt; type of elements\n     * @param &lt;K&gt; type of map keys\n     * @param &lt;V&gt; type of map values\n     * @return an accumulating consumer\n     */\n    private static &lt;T, K, V&gt;\n    BiConsumer&lt;Map&lt;K, V&gt;, T&gt; uniqKeysMapAccumulator(Function&lt;? super T, ? extends K&gt; keyMapper,\n                                                    Function&lt;? super T, ? extends V&gt; valueMapper) {\n        return (map, element) -&gt; {\n            K k = keyMapper.apply(element);\n            V v = Objects.requireNonNull(valueMapper.apply(element));\n            V u = map.putIfAbsent(k, v);\n            if (u != null) throw duplicateKeyException(k, u, v);\n        };\n    }\n</code></pre>\n<p>Hence the exception you are seeing. To handle it you can just tell it with a merge function what to do in case of a duplicate:</p>\n<pre><code>Map&lt;String, Integer&gt; map = \n     list.stream()\n         .collect(Collectors.toMap(\n                s -&gt; s,\n                String::length,\n                (a1, a2) -&gt; a1\n            ));\n</code></pre>\n<p>This uses the implementation from its [Java Doc](<a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html#toMap-java.util.function.Function-java.util.function.Function-java.util.function.BinaryOperator-\" rel=\"noreferrer\">https://docs.oracle.com/javase/8/docs/api/java/util/stream/Collectors.html#toMap-java.util.function.Function-java.util.function.Function-java.util.function.BinaryOperator-</a>)</p>\n<pre><code>public static &lt;T,K,U&gt; Collector&lt;T,?,Map&lt;K,U&gt;&gt; toMap(Function&lt;? super T,? extends K&gt; keyMapper,\n                                                    Function&lt;? super T,? extends U&gt; valueMapper,\n                                                    BinaryOperator&lt;U&gt; mergeFunction)\n</code></pre>\n",
    "score" : 11,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1748447677,
    "last_activity_date" : 1748447677,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79642591" : [ {
      "comment_id" : 140475597,
      "post_id" : 79642591,
      "body" : "It&#39;s worth adding that <code>distinct()</code> only makes sense here because of the nature of the question. The method <code>toMap()</code> takes in a key mapper and a value mapper. If 2 instances into the key mapper produce matching keys, then the constraint has been violated, resulting in the exception seen in the question. And using <code>distinct()</code> might very well be one way to prevent that from happening. However, you may have 2 instances of <code>T</code> that return <code>true</code> for <code>t1.equals(t2)</code>, but <code>false</code> for <code>keyMapper.apply(t1).equals(keyMapper.apply(t2))</code>. It&#39;s a complex distinction, and easy to mess up, so be careful.",
      "score" : 0,
      "owner" : {
        "account_id" : 14010051,
        "reputation" : 260,
        "user_id" : 10118965,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/61afd55894624ae8f6e4189b68db1f30?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "davidalayachew",
        "link" : "https://stackoverflow.com/users/10118965/davidalayachew"
      },
      "creation_date" : 1748717914,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}