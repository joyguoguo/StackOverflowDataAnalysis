{
  "question" : {
    "question_id" : 79555127,
    "title" : "VectorStore implementation throws type &quot;vector&quot; does not exist error with custom schema and table",
    "body" : "<p>I am trying to implementing RAG using pgvector/Postgres and stuck on a strange problem where RAG search fails when running programmatically. The raw query works fine on PostgresDB though.</p>\n<p>We have two different issues:</p>\n<ol>\n<li><p>When using the <a href=\"https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html\" rel=\"nofollow noreferrer\">standard textbook implementation</a> we get:</p>\n<pre><code> processing failed: org.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar [SELECT *, embedding &lt;=&gt; ? AS distance FROM DEV_GENAI_DATA_OWNER.temp_rag_tbl WHERE embedding &lt;=&gt; ? &lt; ?  ORDER BY distance LIMIT ? ]] with root cause\n\norg.postgresql.util.PSQLException: ERROR: operator does not exist: public.vector &lt;=&gt; public.vector\n  Hint: No operator matches the given name and argument types. You might need to add explicit type casts.\n  Position: 21\n</code></pre>\n</li>\n<li><p>When running the same RAG search query as a native query via Spring JPA, we get this error:</p>\n<pre><code>.springframework.jdbc.BadSqlGrammarException: PreparedStatementCallback; bad SQL grammar [SELECT *, embedding &lt;=&gt; ?::vector AS distance FROM temp_rag_tbl ORDER BY embedding &lt;=&gt; ?::vector LIMIT ?]] with root cause\norg.postgresql.util.PSQLException: ERROR: type &quot;vector&quot; does not exist\n  Position: 29\n</code></pre>\n<p>Clearly, the vector extension does exist:\n<code>SELECT * FROM pg_extension WHERE extname = 'vector';</code> -&gt; shows result</p>\n</li>\n</ol>\n<p>Here is the complete pgvector configurations:</p>\n<pre><code># Pgvector configs\nspring.ai.vectorstore.pgvector.index-type=HNSW\nspring.ai.vectorstore.pgvector.distance-type=COSINE_DISTANCE\nspring.ai.vectorstore.pgvector.table-name=&lt;my-embedding-table&gt;\nspring.ai.vectorstore.pgvector.schema-name=&lt;my-schema&gt;\nspring.ai.vectorstore.pgvector.dimensions=1536\nspring.ai.vectorstore.pgvector.batching-strategy=TOKEN_COUNT\n</code></pre>\n<p>Spring AI version: M5 (Milestone 5)</p>\n",
    "tags" : [ "java", "postgresql", "spring-boot", "spring-ai" ],
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "is_answered" : true,
    "view_count" : 527,
    "answer_count" : 2,
    "score" : 2,
    "last_activity_date" : 1758811101,
    "creation_date" : 1743764521,
    "link" : "https://stackoverflow.com/questions/79555127/vectorstore-implementation-throws-type-vector-does-not-exist-error-with-custom",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79572896,
    "question_id" : 79555127,
    "body" : "<p>The problem seems to be related to using the custom pgvector store dependency</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-ai-pgvector-store&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>As opposed to using PgVectorStore boot starter dependency:</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-ai-starter-vector-store-pgvector&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>Switching to starter dependency made it work flawlessly.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "creation_date" : 1744625739,
    "last_activity_date" : 1744625739,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79774890,
    "question_id" : 79555127,
    "body" : "<p>The <a href=\"https://github.com/pgvector/pgvector\" rel=\"nofollow noreferrer\">pgvector</a> extension needs to be installed for each database.</p>\n<p>One way to solve this problem is to connect manually to your database with psql.\nYou can then list extensions with:</p>\n<pre><code>\\dx\n</code></pre>\n<p>And install the vector extension on your database with:</p>\n<pre><code>CREATE EXTENSION vector;\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2021629,
      "reputation" : 63581,
      "user_id" : 1807667,
      "user_type" : "registered",
      "accept_rate" : 60,
      "profile_image" : "https://www.gravatar.com/avatar/976dc9df3ea3d05a18e90f0cd9c29b7a?s=256&d=identicon&r=PG",
      "display_name" : "Ortomala Lokni",
      "link" : "https://stackoverflow.com/users/1807667/ortomala-lokni"
    },
    "creation_date" : 1758806678,
    "last_activity_date" : 1758811101,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140319459,
    "post_id" : 79555127,
    "body" : "Usually the db client library or the pool offer a way to configure session-level settings or a connection startup script that gets injected into each session opened by the pool - you could try setting it there. You could also <code>alter role app_role set search_path=...</code>, or even <code>alter database yourdb set search_path=...</code>. Note that transaction-level setting overrides session-level, session overrides role, role overrides the db, db overrides system/cluster-level default. If you set it like that, make sure it doesn&#39;t override later. <a href=\"https://www.postgresql.org/docs/current/config-setting.html\" rel=\"nofollow noreferrer\">postgresql.org/docs/current/config-setting.html</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 6897470,
      "reputation" : 30116,
      "user_id" : 5298879,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Qv2LD.png?s=256",
      "display_name" : "Zegarek",
      "link" : "https://stackoverflow.com/users/5298879/zegarek"
    },
    "creation_date" : 1744273548,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140319404,
    "post_id" : 79555127,
    "body" : "i&#39;m running the exact same query which is generated programatically on pgadmin by setting search path of the session to my schema and not providing any schema qualifier in the query. It works fine. But via vector store configs, it&#39;s not picking up vector extension.",
    "score" : 0,
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "creation_date" : 1744272511,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140316079,
    "post_id" : 79555127,
    "body" : "It&#39;s accessible and usable, yes, but not immediately visible. See <a href=\"https://dbfiddle.uk/jO7k86DL\" rel=\"nofollow noreferrer\">this demo</a> and the <a href=\"https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH\" rel=\"nofollow noreferrer\">doc about <code>search_path</code></a> I linked above. All <a href=\"https://www.postgresql.org/docs/current/sql-createextension.html\" rel=\"nofollow noreferrer\">extensions</a> are installed <i>on database level</i> but if you enclose their elements in a schema, you need schema-qualified references or changed/extended <code>search_path</code> that lets clients consider its contents automatically whenever they can&#39;t find something in <code>pg_catalog</code>, <code>public</code> or <code>$user</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 6897470,
      "reputation" : 30116,
      "user_id" : 5298879,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Qv2LD.png?s=256",
      "display_name" : "Zegarek",
      "link" : "https://stackoverflow.com/users/5298879/zegarek"
    },
    "creation_date" : 1744203084,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140315906,
    "post_id" : 79555127,
    "body" : "pgvector is installed on a database level and all schemas within it should have access to use it. That&#39;s what my understanding is.",
    "score" : 0,
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "creation_date" : 1744200599,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140315495,
    "post_id" : 79555127,
    "body" : "If you&#39;re installing <code>pgvector</code> in a custom schema, do you also add that schema to the clients&#39; <a href=\"https://www.postgresql.org/docs/current/ddl-schemas.html#DDL-SCHEMAS-PATH\" rel=\"nofollow noreferrer\"><code>search_path</code></a>? Unless you do that, there&#39;s no way for them to know where <code>vector</code> type is. It&#39;s that, or schema-qualify all references to the extension.",
    "score" : 0,
    "owner" : {
      "account_id" : 6897470,
      "reputation" : 30116,
      "user_id" : 5298879,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Qv2LD.png?s=256",
      "display_name" : "Zegarek",
      "link" : "https://stackoverflow.com/users/5298879/zegarek"
    },
    "creation_date" : 1744193815,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140314423,
    "post_id" : 79555127,
    "body" : "It&#39;s connected to the same DB. If i set the schema as &quot;public&quot; everything works but that&#39;s not practical.",
    "score" : 1,
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "creation_date" : 1744173060,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140299311,
    "post_id" : 79555127,
    "body" : "It&#39;s a guess but you might&#39;ve created and verified the extension on one db, while your app connects to another db on the same instance/cluster/server, or the same name db but on a different cluster altogether. Check your occupied ports, open tunnels, running containers&amp;VMs and what connection params your clients and apps use.",
    "score" : 1,
    "owner" : {
      "account_id" : 6897470,
      "reputation" : 30116,
      "user_id" : 5298879,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Qv2LD.png?s=256",
      "display_name" : "Zegarek",
      "link" : "https://stackoverflow.com/users/5298879/zegarek"
    },
    "creation_date" : 1743770671,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}