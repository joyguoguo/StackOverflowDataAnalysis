{
  "question" : {
    "question_id" : 79567031,
    "title" : "Lettuce Redis: Does Command Timeout Include Connection Pool Wait Time?",
    "body" : "<p>I'm using LettuceConnection with a connection pool to connect my application to a Redis server. However, during load testing, I encountered a significant number of command timeout errors. Initially, I suspected that the Redis server might be struggling to handle the high traffic, but after checking, I found that there were still plenty of available resources — CPU usage was around 5%, and memory usage was only about 10%.</p>\n<p>This made me wonder: when exactly does the command timeout start? Does it include the time spent waiting for a connection from the pool to become available (in that case increasing connection pool size may help), or does it begin only after the request is sent to the Redis server? I reviewed the Lettuce documentation, but it’s unclear how the command timeout is measured. Please help me understand.</p>\n<p>Here's the configuration I used.</p>\n<pre><code>RedisStandaloneConfiguration configuration = new RedisStandaloneConfiguration(&quot;host&quot;);\n\nGenericObjectPoolConfig&lt;?&gt; poolConfig = new GenericObjectPoolConfig&lt;&gt;();\npoolConfig.setMaxWaitMillis(50);\npoolConfig.setMinIdle(2);\npoolConfig.setMaxIdle(2);\npoolConfig.setMaxTotal(4);\n\nLettuceClientConfiguration client = LettucePoolingClientConfiguration.builder()\n    .poolConfig(poolConfig)\n    .commandTimeout(Duration.ofMillis(50))\n    .build();\n\nreturn new LettuceConnectionFactory(configuration, client);\n</code></pre>\n",
    "tags" : [ "java", "redis", "spring-data-redis", "lettuce" ],
    "owner" : {
      "account_id" : 27848495,
      "reputation" : 19,
      "user_id" : 27062673,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AGNmyxZ4TYvZZgn74jaVBS4Zn9us3SzLk8HZEIIES9QjCg=k-s256",
      "display_name" : "Thanyares Permpongpaiboon",
      "link" : "https://stackoverflow.com/users/27062673/thanyares-permpongpaiboon"
    },
    "is_answered" : false,
    "view_count" : 631,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1744362033,
    "creation_date" : 1744298013,
    "link" : "https://stackoverflow.com/questions/79567031/lettuce-redis-does-command-timeout-include-connection-pool-wait-time",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79568434,
    "question_id" : 79567031,
    "body" : "<p>The topic of command timeouts is - by far - the most complicated one, when it comes to the Lettuce driver specifically, but also in general.</p>\n<h3>TL;DR</h3>\n<p>Typically<sup>*1</sup> command timeout starts from the moment a given command is written - by the Lettuce driver logic - to the Netty channel and would be stopped either when the timeout is reached (causing an <code>ExecutionException</code> with cause  <code>RedisCommandTimeoutException</code>) or the command is completed (either successfully or not).</p>\n<p><sup>*1</sup> <em>if no other command timeout conditions are met and depending on the usage of the driver</em></p>\n<h3>Long and boring story</h3>\n<p>In the reality there are many different reasons that could cause a command to timeout:</p>\n<ul>\n<li>if the channel (socket) is disconnected and the policy the driver is configured with is <a href=\"https://redis.github.io/lettuce/advanced-usage/#command-execution-reliability\" rel=\"nofollow noreferrer\">at-least-once reliability</a> the command could time out in the disconnected buffer, before even being written on the actual socket</li>\n<li>the <code>async</code> API relies on the <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/CompletableFuture.html\" rel=\"nofollow noreferrer\">CompletableFuture</a> contract underneath and if you specify a timeout it would follow the rules of the underlying Executor</li>\n<li>when working with clusters the actual writing of the command might be preceded with some other events such as - initialize the node connection (as connections to all nodes are <a href=\"https://redis.github.io/lettuce/ha-sharding/#connection-count-for-a-redis-cluster-connection-object\" rel=\"nofollow noreferrer\">initialized on demand</a>) or follow up a <code>MOVED</code> / <code>ASK</code> reply from the server</li>\n<li>in scenarios where a different <a href=\"https://redis.github.io/lettuce/ha-sharding/#readfrom-settings\" rel=\"nofollow noreferrer\">ReadFrom policy</a> is set the logic to calculate the correct node to route the command to is also included in the command timeout</li>\n<li>... and other cases</li>\n</ul>\n<p>So the full answer is - one needs to provide a much more complete explanation of how the driver is used to know exactly how the timeout is calculated.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 435843,
      "reputation" : 334,
      "user_id" : 822655,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/705cba900acbeffb3799d2c42ae6659c?s=256&d=identicon&r=PG",
      "display_name" : "Tihomir Mateev",
      "link" : "https://stackoverflow.com/users/822655/tihomir-mateev"
    },
    "creation_date" : 1744362033,
    "last_activity_date" : 1744362033,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}