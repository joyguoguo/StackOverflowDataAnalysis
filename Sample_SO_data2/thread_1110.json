{
  "question" : {
    "question_id" : 79746524,
    "title" : "How to reuse Specification&lt;T&gt; inside another Specification&lt;F&gt; with subquery?",
    "body" : "<p>Iâ€™m struggling with reusing a <code>Specification&lt;T&gt;</code> inside another one.</p>\n<p><strong>Entities</strong>:</p>\n<ul>\n<li><p><code>Group</code> has a list of <code>StudentGroupInfo</code>.</p>\n</li>\n<li><p>I already have a <code>Specification&lt;Group&gt;</code> that can filter <code>Group</code> by various conditions (joins, group by, having, etc.).</p>\n</li>\n<li><p>Now I need to count all <code>StudentGroupInfo</code> for the groups that are matched by this <code>Specification&lt;Group&gt;</code>.</p>\n</li>\n</ul>\n<p><strong>Repository</strong>:</p>\n<pre><code>public interface StudentGroupInfoRepository extends JpaRepository&lt;StudentGroupInfo, Long&gt; {\n    long count(Specification&lt;StudentGroupInfo&gt; specification);\n}\n</code></pre>\n<p><strong>Attempt to reuse the group specification via subquery</strong>:</p>\n<pre><code>private Specification&lt;StudentGroupInfo&gt; buildSpecificationByGroupSpecification(\n        Specification&lt;Group&gt; groupSpecification) {\n    return (root, query, builder) -&gt; {\n        var subquery = query.subquery(Long.class);\n        var groupRoot = subquery.from(Group.class);\n\n        // how to apply the groupSpecification here?\n        var groupPredicate = groupSpecification.toPredicate(groupRoot, query /* ??? */, builder);\n\n        subquery.select(groupRoot.get(BaseEntity.Fields.id))\n                .where(groupPredicate);\n        return root.get(StudentGroupInfo.Fields.group).in(subquery);\n    };\n}\n</code></pre>\n<p><strong>Problem</strong>:</p>\n<p>If the groupSpecification is simple, it works.\nBut if it contains joins, <code>group by</code> or <code>having</code>, Hibernate throws:</p>\n<pre><code>Caused by: org.hibernate.sql.ast.SqlTreeCreationException: Could not locate TableGroup - com.sdx.rootservice.model.group.Group(...)\n</code></pre>\n<p>I assume it happens because I pass the outer <code>query</code> into <code>groupSpecification.toPredicate(...)</code>, while that <code>Specification</code> expects a root from the main query, not from a subquery.</p>\n<p><strong>Question</strong>:</p>\n<p>How can I properly reuse an existing <code>Specification&lt;Group&gt;</code> inside a subquery in another specification, or do I need a different approach for it (e.g. refactor to join instead of subquery)?</p>\n",
    "tags" : [ "java", "spring", "hibernate", "spring-data-jpa", "criteria-api" ],
    "owner" : {
      "account_id" : 16949602,
      "reputation" : 66,
      "user_id" : 12771746,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-DYgakxGZrHY/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdDIACrhlYbQMSQCBnJ9d9XldCzhw/s256-rj/photo.jpg",
      "display_name" : "Maksym Gaiduchek",
      "link" : "https://stackoverflow.com/users/12771746/maksym-gaiduchek"
    },
    "is_answered" : false,
    "view_count" : 117,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1756405846,
    "creation_date" : 1756192632,
    "link" : "https://stackoverflow.com/questions/79746524/how-to-reuse-specificationt-inside-another-specificationf-with-subquery",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140699525,
    "post_id" : 79746524,
    "body" : "@MarkRotteveel, thank you, I didn&#39;t know that. I asked ChatGPT only about a structure of the question and to edit my English text because unfortunately I have some problems with that and I am a bit happier when my text is clear for you all :). And yes, I will edit it to one question somehow, because I thought those question are touching each other. Thank you for your comments",
    "score" : 0,
    "owner" : {
      "account_id" : 16949602,
      "reputation" : 66,
      "user_id" : 12771746,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-DYgakxGZrHY/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rdDIACrhlYbQMSQCBnJ9d9XldCzhw/s256-rj/photo.jpg",
      "display_name" : "Maksym Gaiduchek",
      "link" : "https://stackoverflow.com/users/12771746/maksym-gaiduchek"
    },
    "creation_date" : 1756405675,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140693208,
    "post_id" : 79746524,
    "body" : "Also, please ask only <b>one</b> question per question.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110280,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1756213021,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140693206,
    "post_id" : 79746524,
    "body" : "This question seems to have been generated or &quot;improved&quot; with help of ChatGPT or another AI. Please be aware that using LLMs or other AIs to generate content is <a href=\"https://meta.stackoverflow.com/questions/421831/temporary-policy-generative-ai-e-g-chatgpt-is-banned\">not allowed</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110280,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1756212979,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}