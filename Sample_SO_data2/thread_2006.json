{
  "question" : {
    "question_id" : 79659465,
    "title" : "Apache Camel Processor - OAuth 1.0 returns 401 despite correct credentials",
    "body" : "<p>I'm working on a Processor class in Apache Camel (Java) to authenticate with an external system using OAuth 1.0. The main issue is that the destination system is returning a 401 Unauthorized error.</p>\n<p>I'm sure the credentials are correct because the request works fine in Postman. Therefore, I suspect the issue is related to the oauth_signature, but I haven't been able to identify the problem.</p>\n<p>Iâ€™ve reviewed the OAuth 1.0 documentation and included all the required parameters. I'm sharing my code below in case someone can spot what might be wrong.</p>\n<p>Thanks in advance for reading and for any help you can provide.</p>\n<pre><code>public class OAuth1Processor implements Processor {\nprivate static final String CHARSET = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;;\nprivate static final SecureRandom RANDOM = new SecureRandom();\n\n@Override\npublic void process(Exchange exchange) throws Exception {\n    IntegrationInterface integrationInterface = exchange.getProperty(&quot;integrationInterface&quot;, IntegrationInterface.class);\n    String consumerKey = &quot;customer_key&quot;;\n    String consumerSecret = &quot;customer_secret&quot;;\n    String accessToken = &quot;access_token&quot;;\n    String tokenSecret = &quot;token_secret&quot;;\n    String signatureMethod = &quot;HMAC-SHA256&quot;;\n    String realm = &quot;realm&quot;;\n\n    String httpMethod = &quot;POST&quot;;\n    String url = &quot;https://url-example.com&quot;;\n\n    Map&lt;String, String&gt; oauthParams  = new TreeMap&lt;&gt;();\n    oauthParams.put(&quot;oauth_consumer_key&quot;, consumerKey);\n    oauthParams.put(&quot;oauth_token&quot;, accessToken);\n    oauthParams.put(&quot;oauth_signature_method&quot;, signatureMethod);\n    oauthParams.put(&quot;oauth_timestamp&quot;, String.valueOf(System.currentTimeMillis() / 1000));\n    oauthParams.put(&quot;oauth_nonce&quot;, generateNonce(11));\n    oauthParams.put(&quot;oauth_version&quot;, &quot;1.0&quot;);\n\n    String baseSignatureString = generateSignatureBaseString(httpMethod, url, oauthParams);\n\n    String rawSignature = generateRawSignature(baseSignatureString, consumerSecret, tokenSecret);\n\n    String encodedSignature = encode(rawSignature);\n\n    oauthParams .put(&quot;oauth_signature&quot;, encodedSignature);\n    oauthParams.put(&quot;realm&quot;, realm);\n\n    String authHeader = buildAuthorizationHeader(oauthParams);\n    exchange.getIn().getHeaders().clear();\n    exchange.getIn().setHeader(&quot;Authorization&quot;, authHeader);\n}\n\nprivate String buildAuthorizationHeader(Map&lt;String, String&gt; oauthParams) {\n    StringBuilder header = new StringBuilder(&quot;OAuth &quot;);\n\n    for (Map.Entry&lt;String, String&gt; entry : oauthParams.entrySet()) {\n        String key = entry.getKey();\n        String value = key.equals(&quot;oauth_signature&quot;) ? entry.getValue() : encode(entry.getValue());\n        header.append(encode(key)).append(&quot;=\\&quot;&quot;).append(value).append(&quot;\\&quot;,&quot;);\n    }\n    header.setLength(header.length() - 1);\n    return header.toString();\n}\n\npublic static String generateNonce(int length) {\n    StringBuilder newNonce = new StringBuilder();\n\n    for (int i = 0; i &lt; length; i++) {\n        newNonce.append(CHARSET.charAt(RANDOM.nextInt(CHARSET.length())));\n    }\n\n    return newNonce.toString();\n}\n\nprivate static String encode(String value) {\n    return URLEncoder\n        .encode(value, StandardCharsets.UTF_8)\n        .replace(&quot;+&quot;, &quot;%20&quot;)\n        .replace(&quot;*&quot;, &quot;%2A&quot;)\n        .replace(&quot;%7E&quot;, &quot;~&quot;);\n}\n\nprivate String generateRawSignature(String baseSignature, String consumerSecret, String tokenSecret) throws Exception {\n    String secret = encode(consumerSecret) + &quot;&amp;&quot; + encode(tokenSecret);\n    byte[] keyBytes = secret.getBytes(StandardCharsets.UTF_8);\n    SecretKey key = new SecretKeySpec(keyBytes, &quot;HmacSHA256&quot;);\n\n    Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);\n    mac.init(key);\n\n    byte[] signatureBytes = mac.doFinal(baseSignature.getBytes(StandardCharsets.UTF_8));\n    return Base64.getEncoder().encodeToString(signatureBytes);\n}\n\nprivate String generateSignatureBaseString(String httpMethod, String url, Map&lt;String, String&gt; requestParams) {\n    Map&lt;String, String&gt; sortedParams = requestParams.entrySet().stream()\n        .sorted(Map.Entry.comparingByKey())\n        .collect(Collectors.toMap(\n            Map.Entry::getKey,\n            Map.Entry::getValue,\n            (oldVal, newVal) -&gt; oldVal,\n            LinkedHashMap::new\n        ));\n\n    StringBuilder base = new StringBuilder();\n    sortedParams.forEach((key, value) -&gt; {\n        base.append(encode(key)).append(&quot;=&quot;).append(encode(value)).append(&quot;&amp;&quot;);\n    });\n    base.setLength(base.length() - 1);\n\n    return httpMethod.toUpperCase() + &quot;&amp;&quot; + encode(url) + &quot;&amp;&quot; + encode(base.toString());\n}\n</code></pre>\n<p>}</p>\n",
    "tags" : [ "java", "oauth", "apache-camel", "twitter-oauth" ],
    "owner" : {
      "account_id" : 17767218,
      "reputation" : 23,
      "user_id" : 12901785,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mClSVf98o4OwYnXVpMadOaHCBS2HjPJdyjP8z1t=k-s256",
      "display_name" : "OB_G",
      "link" : "https://stackoverflow.com/users/12901785/ob-g"
    },
    "is_answered" : false,
    "view_count" : 42,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749499307,
    "creation_date" : 1749499307,
    "link" : "https://stackoverflow.com/questions/79659465/apache-camel-processor-oauth-1-0-returns-401-despite-correct-credentials",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}