{
  "question" : {
    "question_id" : 79717924,
    "title" : "How do I prevent duplicate messages in context window, when using rag and memory?",
    "body" : "<p>When using rag and memory, multiple identical copies of the same information is sent to the ai, when asking related questions.</p>\n<p>I have</p>\n<pre><code>import java.util.ArrayList;\nimport java.util.List;\n\nimport dev.langchain4j.data.message.ChatMessage;\nimport dev.langchain4j.memory.ChatMemory;\nimport dev.langchain4j.memory.chat.MessageWindowChatMemory;\nimport dev.langchain4j.model.openai.OpenAiChatModel;\nimport dev.langchain4j.model.openai.OpenAiChatModelName;\nimport dev.langchain4j.rag.content.Content;\nimport dev.langchain4j.rag.content.retriever.ContentRetriever;\nimport dev.langchain4j.rag.query.Query;\nimport dev.langchain4j.service.AiServices;\nimport dev.langchain4j.service.MemoryId;\nimport dev.langchain4j.service.UserMessage;\nimport dev.langchain4j.service.memory.ChatMemoryAccess;\n\ninterface ChatInterface extends ChatMemoryAccess {\nString chat(@memoryid int memoryId, @Usermessage String userMessage);\n}\n\npublic class RagHistoryBug {\npublic static void main(String args[]) throws Exception {\nString apiKey=&quot;Can't provide my key, but I am sure this bug also shows up with local run ai&quot;;\nOpenAiChatModel chatModel=OpenAiChatModel.builder()\n.apiKey(apiKey)\n.modelName(OpenAiChatModelName.GPT_4_O_MINI)\n.build();\n\n    AiServices&lt;ChatInterface&gt; builder=AiServices.builder(ChatInterface.class)\n            .chatModel(chatModel)\n            .chatMemoryProvider(memoryId -&gt; MessageWindowChatMemory.withMaxMessages(11));\n    \n    ContentRetriever contentRetriever=new ContentRetriever() {\n        @Override public List&lt;Content&gt; retrieve(Query q) {\n            List&lt;Content&gt; list = new ArrayList&lt;&gt;();\n            list.add(Content.from(&quot;I have a cat called Pulasy. It likes mice very much&quot;));\n            return list;\n        }\n    };\n    builder=builder.contentRetriever(contentRetriever);\n    ChatInterface assistant=builder.build();\n\n    System.out.println(assistant.chat(1,&quot;What is the name of my cat?&quot;));\n    System.out.println(assistant.chat(1,&quot;Do my cat like mice?&quot;));\n    System.out.println(assistant.chat(1,&quot;Is Pulasy a lion?&quot;));\n    \n    ChatMemory mem = assistant.getChatMemory(1);\n    List&lt;ChatMessage&gt; messages = mem.messages();\n    for(ChatMessage msg: messages) {\n        System.out.println(&quot;Msg:&quot; + msg);\n    }\n}\n\n}\n\n\n\nIf I run this program, the output is:\n\nYour cat's name is Pulasy.\nYes, your cat Pulasy likes mice very much.\nNo, Pulasy is not a lion; Pulasy is a cat.\nMsg:UserMessage { name = null contents = [TextContent { text = &quot;What is the name of my cat?\n\nAnswer using the following information:\nI have a cat called Pulasy. It likes mice very much&quot; }] }\nMsg:AiMessage { text = &quot;Your cat's name is Pulasy.&quot; toolExecutionRequests = [] }\nMsg:UserMessage { name = null contents = [TextContent { text = &quot;Do my cat like mice?\n\nAnswer using the following information:\nI have a cat called Pulasy. It likes mice very much&quot; }] }\nMsg:AiMessage { text = &quot;Yes, your cat Pulasy likes mice very much.&quot; toolExecutionRequests = [] }\nMsg:UserMessage { name = null contents = [TextContent { text = &quot;Is Pulasy a lion?\n\nAnswer using the following information:\nI have a cat called Pulasy. It likes mice very much&quot; }] }\nMsg:AiMessage { text = &quot;No, Pulasy is not a lion; Pulasy is a cat.&quot; toolExecutionRequests = [] }\n\n</code></pre>\n<p>Note that:</p>\n<pre><code>Answer using the following information:\nI have a cat called Pulasy. It likes mice very much&quot; }] }\nMsg:AiMessage { text = &quot;No, Pulasy is not a lion; Pulasy is a cat.&quot; toolExecutionRequests = [] }\n\nis included 3 times. (And I checked the used input tokens. It really is included 3 times. How do I prevent that?\n\n</code></pre>\n",
    "tags" : [ "java", "rag", "langchain4j" ],
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "is_answered" : false,
    "view_count" : 131,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1756482404,
    "creation_date" : 1753739989,
    "link" : "https://stackoverflow.com/questions/79717924/how-do-i-prevent-duplicate-messages-in-context-window-when-using-rag-and-memory",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79750513,
    "question_id" : 79717924,
    "body" : "<p>Yeah, this is a common issue when you mix RAG and chat memory. The retriever keeps adding the same info every turn, and the memory just stores it blindly so you end up with repeated chunks bloating the prompt.</p>\n<p>Quick fix: either dedupe the content before adding it, or use something like <a href=\"https://docs.mem0.ai/introduction\" rel=\"nofollow noreferrer\">mem0</a> or <a href=\"https://www.flumes.ai/\" rel=\"nofollow noreferrer\">flumes ai</a> that tracks memory as structured facts and avoids repeating stuff across turns.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43713646,
      "reputation" : 1,
      "user_id" : 31380083,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd6f7ac635667581f5c8ccebbe1c49cb?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Alex Lund",
      "link" : "https://stackoverflow.com/users/31380083/alex-lund"
    },
    "creation_date" : 1756482404,
    "last_activity_date" : 1756482404,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140627677,
    "post_id" : 79717924,
    "body" : "@JayC667 The problem is: my ContentRetriever have no way to know what is already in the context window. So maybe it should be included, and maybe it is already in the content context. Who knows?",
    "score" : 0,
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "creation_date" : 1753810628,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627475,
    "post_id" : 79717924,
    "body" : "The way I understand your problem: You do not want <code>I have a cat called Pulasy. It likes mice very much</code> to be sent to the AI three times. But that&#39;s how you&#39;re creating the <code>ContentRetriever</code>. Depending on how its builder works, you could create the <code>List&lt;Content&gt; list</code> on <code>main()</code> method level. And after your first call to <code>assistant.chat(</code> you could clear that list: <code>list.clear()</code>. If that alone does not work, you&#39;ll also have to call <code>assistant=builder.build();</code> each time before you call <code>assistant.chat(</code> again.",
    "score" : 0,
    "owner" : {
      "account_id" : 2182934,
      "reputation" : 2660,
      "user_id" : 1932011,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://www.gravatar.com/avatar/612163480a1ccb4785fd647a003eefbb?s=256&d=identicon&r=PG",
      "display_name" : "JayC667",
      "link" : "https://stackoverflow.com/users/1932011/jayc667"
    },
    "creation_date" : 1753806129,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627361,
    "post_id" : 79717924,
    "body" : "@JayC667 I don&#39;t see how a HashSet would solve anything. The core issue is that any call to chat MAY push out any content returned from the rag, depending on the result context site and memory strategy. And I am unable to find any class which manages lifetime for resources fetched  from rag. (It is not ChatMemory as far i can see, which surprised me). And for the output: The first 3 lines are from the calls to System.out.println(assistant.chat. The rest is from the msg:",
    "score" : 0,
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "creation_date" : 1753803570,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627194,
    "post_id" : 79717924,
    "body" : "1) Please format your source code properly. 2) Please prefix ALL the outputs (like you did with <code>Msg:</code>) so we can better understand how the system responds. 3) Please properly format the output (I know, SO&#39;s ML editor is a pain sometimes, but editor has a preview frame below) 4) It looks like a simple <code>HashSet&lt;String&gt; knownAnswers</code> suffices.",
    "score" : 0,
    "owner" : {
      "account_id" : 2182934,
      "reputation" : 2660,
      "user_id" : 1932011,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://www.gravatar.com/avatar/612163480a1ccb4785fd647a003eefbb?s=256&d=identicon&r=PG",
      "display_name" : "JayC667",
      "link" : "https://stackoverflow.com/users/1932011/jayc667"
    },
    "creation_date" : 1753799956,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627173,
    "post_id" : 79717924,
    "body" : "@JayC667 I just updated with a complete question, showing the issue.",
    "score" : 0,
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "creation_date" : 1753799412,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140626763,
    "post_id" : 79717924,
    "body" : "@JayC667 The problem is how do I know if content is redundant? ContentRetriever have no way to know, because redundant depend on exactly what is in the ChatMemoryProvider for the given MemoryId. And ContentRetriever don&#39;t have access to that(It don&#39;t have a memory id). So I guess I will have to implement my own ChatMemoryProvider which filters out old duplicates.",
    "score" : 0,
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "creation_date" : 1753792787,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140626603,
    "post_id" : 79717924,
    "body" : "@nabulator But I do want the same document for similar cases. I just don&#39;t want to send in 8 copies to chat gpt. 1 is enough and there is no purpose to send the same document multiple times.",
    "score" : 0,
    "owner" : {
      "account_id" : 200481,
      "reputation" : 5535,
      "user_id" : 446357,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/2374e43485f6caeb3302e66c327608e2?s=256&d=identicon&r=PG",
      "display_name" : "MTilsted",
      "link" : "https://stackoverflow.com/users/446357/mtilsted"
    },
    "creation_date" : 1753789734,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140626198,
    "post_id" : 79717924,
    "body" : "I don&#39;t know the surroundings of your code; For that, you did not provide enough. If you have one process that covers all queries, find a location that has access to where your <code>CodeRetriever</code> returns the result. Use a <code>HashSet&lt;TheResultClass&gt;</code>. If the process is more abstract (like a WebServer), use a <code>WeakHashMap&lt;UserInfos, TheResultClass&gt;</code>. (<code>UserInfos</code> is a class with data regarding the user, the current process, result etc,  to identify the exact case where you want to prevent duplicates. Make sure <code>equals()</code> and <code>hashCode()</code> exist). With this, register answers and identify duplicates.",
    "score" : 0,
    "owner" : {
      "account_id" : 2182934,
      "reputation" : 2660,
      "user_id" : 1932011,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://www.gravatar.com/avatar/612163480a1ccb4785fd647a003eefbb?s=256&d=identicon&r=PG",
      "display_name" : "JayC667",
      "link" : "https://stackoverflow.com/users/1932011/jayc667"
    },
    "creation_date" : 1753779429,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140625480,
    "post_id" : 79717924,
    "body" : "I only understand python langchain so this may be wrong but checking for duplicates is usually on you, the developer, to implement. How should langchain know you don&#39;t want the same document for similar queries? RAG has no memory itself and it&#39;s possible you DO want the same document for related queries.",
    "score" : 0,
    "owner" : {
      "account_id" : 8772448,
      "reputation" : 451,
      "user_id" : 6558745,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d0fdcdd736e7a6b0148049a77d17c5e1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "nabulator",
      "link" : "https://stackoverflow.com/users/6558745/nabulator"
    },
    "creation_date" : 1753751806,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79750513" : [ {
      "comment_id" : 140702165,
      "post_id" : 79750513,
      "body" : "Your answer could be improved with additional supporting information. Please <a href=\"https://stackoverflow.com/posts/79750513/edit\">edit</a> to add further details, such as citations or documentation, so that others can confirm that your answer is correct. You can find more information on how to write good answers <a href=\"/help/how-to-answer\">in the help center</a>.",
      "score" : 1,
      "owner" : {
        "account_id" : -1,
        "reputation" : 1,
        "user_id" : -1,
        "user_type" : "moderator",
        "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
        "display_name" : "Community",
        "link" : "https://stackoverflow.com/users/-1/community"
      },
      "creation_date" : 1756485280,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}