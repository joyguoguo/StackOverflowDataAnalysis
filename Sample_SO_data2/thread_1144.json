{
  "question" : {
    "question_id" : 79742798,
    "title" : "403 Forbidden returned in spring boot",
    "body" : "<p>I have a spring boot application that uses rest to communicate with clients, this application has 2 types of users: <code>visitors</code> and <code>employees</code>.</p>\n<p>These 2 users have different authentication methods but they both generate <code>jwt</code> tokens, so to manage that i created 3 separate <code>SecurityFilterChains</code> through <code>XML</code> config, one for <code>employees</code>, one for <code>visitors</code> and another for the rest of the apis where authentication happens via <code>jwt</code> tokens, i did not implement any authorization yet and went directly with <code>spring-security</code>'s default setup.</p>\n<p>My problem lies when i try authenticating via the employee endpoint <code>/employees/token</code> a <code>403 Forbidden</code> is returned.\nI tried debugging the problem and found out that the authentication succeeds with the <code>Authentication</code> object created inside the <code>SecurityContextHolder</code> but after that the request is directed in the <code>filterChain</code> through 3 <code>AuthorizationFilter</code>s, one for each <code>SecurityFilterChain</code>, the strange thing is that even though the request is successfully authorized 3 times by the 1st <code>AuthorizationFilter</code> which has the mapping <code>/employees/token</code> it keeps going to the next <code>AuthorizationFilter</code> which has the mapping of <code>/visitors/token</code> and here is where it fails the authorization and <code>throws</code> an <code>AccessDeniedException</code> redirecting to <code>/error</code>.</p>\n<p>Another weird thing i discovered is that the <code>ApplicationFilterChain</code> which i assume is <code>tomcat</code>'s default <code>filterChain</code> contains those same 3 <code>AuthorizationFilter</code>'s at the end of the chain, plus they also reside inside <code>spring</code>'s <code>FilterChainProxy</code> in each <code>DefaultSecurityFilterChain</code> below is my setup.</p>\n<p>Environment:</p>\n<ul>\n<li>java version --&gt; <code>amazone corretto 17</code></li>\n<li>Spring boot version --&gt; <code>3.5.3</code></li>\n<li>Security dependencies --&gt; <code>spring-boot-starter-oauth2-resource-server</code></li>\n</ul>\n<p>security config:</p>\n<pre><code>&lt;!-- ####################### Spring Security Beans ####################### --&gt;\n&lt;bean id=&quot;visitorDetailsService&quot;\n    class=&quot;com.zum.vms.service.VisitorService&quot; /&gt;\n\n&lt;bean id=&quot;passwordEncoder&quot;\n    class=&quot;org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder&quot; /&gt;\n\n&lt;bean name=&quot;publicKey&quot; class=&quot;com.zum.vms.util.SecurityUtils&quot;\n    factory-method=&quot;loadPublicKey&quot;&gt;\n    &lt;constructor-arg value=&quot;${vms.security.auth.jwt.key.public}&quot; /&gt;\n&lt;/bean&gt;\n\n&lt;bean name=&quot;privateKey&quot; class=&quot;com.zum.vms.util.SecurityUtils&quot;\n    factory-method=&quot;loadPrivateKey&quot;&gt;\n    &lt;constructor-arg value=&quot;${vms.security.auth.jwt.key.private}&quot; /&gt;\n&lt;/bean&gt;\n\n&lt;bean name=&quot;jwtEncoder&quot; class=&quot;com.zum.vms.util.SecurityUtils&quot;\n    factory-method=&quot;jwtEncoder&quot;&gt;\n    &lt;constructor-arg ref=&quot;publicKey&quot; /&gt;\n    &lt;constructor-arg ref=&quot;privateKey&quot; /&gt;\n&lt;/bean&gt;\n\n&lt;bean name=&quot;jwtDecoder&quot; class=&quot;com.zum.vms.util.SecurityUtils&quot;\n    factory-method=&quot;jwtDecoder&quot;&gt;\n    &lt;constructor-arg ref=&quot;publicKey&quot; /&gt;\n&lt;/bean&gt;\n\n&lt;bean id=&quot;totpAuthenticationProvider&quot; \n    class=&quot;com.zum.vms.security.auth.TotpAuthenticationProvider&quot;/&gt;\n\n\n&lt;security:authentication-manager id=&quot;employeeAuthenticationManager&quot;&gt;\n    &lt;security:authentication-provider user-service-ref=&quot;employeeService&quot;&gt;\n        &lt;security:password-encoder\n            ref=&quot;passwordEncoder&quot; /&gt;\n    &lt;/security:authentication-provider&gt;\n    \n&lt;/security:authentication-manager&gt;\n\n&lt;security:authentication-manager id=&quot;visitorAuthenticationManager&quot;&gt;\n    &lt;security:authentication-provider ref=&quot;totpAuthenticationProvider&quot;/&gt;\n&lt;/security:authentication-manager&gt;\n\n\n&lt;!-- to enable regex matching add request-matcher=&quot;regex&quot; attribute --&gt;\n&lt;security:http name=&quot;employeeSecurityChain&quot; \n    pattern=&quot;/employees/token&quot;\n    authentication-manager-ref=&quot;employeeAuthenticationManager&quot;\n    create-session=&quot;stateless&quot;\n    use-expressions=&quot;true&quot;&gt;\n\n    &lt;!-- Run url trailing slash checks before authentication logic --&gt;\n    &lt;security:custom-filter ref=&quot;trailingSlashRedirectFilter&quot; before=&quot;BASIC_AUTH_FILTER&quot;/&gt;\n\n    &lt;!-- Disabling Cross site request forgery protection--&gt;\n    &lt;security:csrf disabled=&quot;true&quot; /&gt;\n    &lt;!-- Require authentication for generating jwt token  /employees/token --&gt;\n    &lt;security:intercept-url pattern=&quot;/employees/token&quot; access=&quot;isAuthenticated()&quot; /&gt;\n    &lt;security:http-basic /&gt;\n&lt;/security:http&gt;\n\n&lt;security:http name=&quot;visitorSecurityChain&quot; \n    pattern=&quot;/visitors/token&quot;\n    authentication-manager-ref=&quot;visitorAuthenticationManager&quot;\n    create-session=&quot;stateless&quot;\n    use-expressions=&quot;true&quot;&gt;\n\n    &lt;!-- Run url trailing slash checks before authentication logic --&gt;\n    &lt;security:custom-filter ref=&quot;trailingSlashRedirectFilter&quot; before=&quot;BASIC_AUTH_FILTER&quot;/&gt;\n\n    &lt;!-- Disabling Cross site request forgery protection--&gt;\n    &lt;security:csrf disabled=&quot;true&quot; /&gt;\n    &lt;!-- Require authentication for generating jwt token  /visitors/token --&gt;\n    &lt;security:intercept-url pattern=&quot;/visitors/token&quot; access=&quot;isAuthenticated()&quot; /&gt;\n    &lt;security:http-basic /&gt;\n&lt;/security:http&gt;\n\n&lt;security:http name=&quot;apis&quot; \n    pattern=&quot;/**&quot;\n    create-session=&quot;stateless&quot; \n    use-expressions=&quot;true&quot;&gt;\n\n    &lt;!-- Run url trailing slash checks before authentication logic --&gt;\n    &lt;security:custom-filter ref=&quot;trailingSlashRedirectFilter&quot; before=&quot;BEARER_TOKEN_AUTH_FILTER&quot;/&gt;\n\n    &lt;!-- Disabling Cross site request forgery protection--&gt;\n    &lt;security:csrf disabled=&quot;true&quot;/&gt;\n    &lt;!-- Allow public access to /visitors/secret --&gt;\n    &lt;security:intercept-url pattern=&quot;/visitors/secret&quot; access=&quot;permitAll()&quot; /&gt;\n    &lt;!-- Allow public access to /visitors/checkin --&gt;\n    &lt;security:intercept-url pattern=&quot;/visitors/checkin&quot; access=&quot;permitAll()&quot; /&gt;\n    &lt;!-- links is public --&gt;\n    &lt;security:intercept-url pattern=&quot;/links/**&quot; access=&quot;permitAll()&quot; /&gt;\n    &lt;!-- everything else need authentication --&gt;\n    &lt;security:intercept-url pattern=&quot;/**&quot; access=&quot;isAuthenticated()&quot; /&gt;\n    &lt;!-- Jwt basic configuration --&gt;\n    &lt;security:oauth2-resource-server&gt;\n        &lt;security:jwt decoder-ref=&quot;jwtDecoder&quot; /&gt;\n    &lt;/security:oauth2-resource-server&gt;\n&lt;/security:http&gt;\n</code></pre>\n<p>and this is the log i'm getting during the request:</p>\n<pre><code>2025-08-21T22:20:10.704+01:00  WARN 28100 --- [vms] [nio-8080-exec-3] o.s.w.s.h.HandlerMappingIntrospector     : Cache miss for REQUEST dispatch to '/vms/employees/token/' (previous null). Performing MatchableHandlerMapping lookup. This is logged once only at WARN level, and every time at TRACE.\n2025-08-21T22:20:10.724+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-3] o.s.security.web.FilterChainProxy        : Securing POST /employees/token/\n2025-08-21T22:20:10.756+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing POST /employees/token\n2025-08-21T22:20:11.153+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.s.a.dao.DaoAuthenticationProvider    : Authenticated user\n2025-08-21T22:20:11.157+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.s.w.a.www.BasicAuthenticationFilter  : Set SecurityContextHolder to UsernamePasswordAuthenticationToken [Principal=Employee(username=admin, email=null, password=$2a$12$rhtf5U7jC39Isq8ZGa5zH.NnkQOb98glGkRDEFErIIW55FilRbWwm, position=null, profilePic=null, admin=true), Credentials=[PROTECTED], Authenticated=true, Details=WebAuthenticationDetails [RemoteIpAddress=0:0:0:0:0:0:0:1, SessionId=null], Granted Authorities=[admin, employee]]\n2025-08-21T22:20:11.178+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Secured POST /employees/token\n2025-08-21T22:20:11.185+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing POST /employees/token\n2025-08-21T22:20:11.187+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Secured POST /employees/token\n2025-08-21T22:20:11.188+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.s.w.access.AccessDeniedHandlerImpl   : Responding with 403 status code\n2025-08-21T22:20:11.209+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Securing POST /error\n2025-08-21T22:20:11.209+01:00 DEBUG 28100 --- [vms] [nio-8080-exec-2] o.s.security.web.FilterChainProxy        : Secured POST /error\n</code></pre>\n<p>Any help would be much appreciated, thank you!</p>\n",
    "tags" : [ "java", "spring-boot", "spring-security", "corretto" ],
    "owner" : {
      "account_id" : 29209243,
      "reputation" : 3,
      "user_id" : 22377591,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1c81c9764c1e6cc5e121919407756939?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "hamdi",
      "link" : "https://stackoverflow.com/users/22377591/hamdi"
    },
    "is_answered" : false,
    "view_count" : 153,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1755857070,
    "creation_date" : 1755813815,
    "link" : "https://stackoverflow.com/questions/79742798/403-forbidden-returned-in-spring-boot",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79743254,
    "question_id" : 79742798,
    "body" : "<pre><code>&lt;security:http name=&quot;apis&quot; \n    pattern=&quot;/**&quot;\n</code></pre>\n<p>is also matched?<br />\ntry commenting out this part...</p>\n<p>maybe ..change your request path  or  exclude these two paths when verifying the token?</p>\n<pre><code>&lt;security:http name=&quot;employeeSecurityChain&quot; \n    pattern=&quot;/auth/employees/token&quot;\n</code></pre>\n<pre><code>&lt;security:http name=&quot;visitorSecurityChain&quot; \n    pattern=&quot;/auth/visitors/token&quot;\n</code></pre>\n<pre><code>&lt;security:http name=&quot;apis&quot; \n    pattern=&quot;/api/**&quot;\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 27008168,
      "reputation" : 1,
      "user_id" : 20568273,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/82eef244413827d2c13a122db5acd97c?s=256&d=identicon&r=PG",
      "display_name" : "Pandamkk",
      "link" : "https://stackoverflow.com/users/20568273/pandamkk"
    },
    "creation_date" : 1755857070,
    "last_activity_date" : 1755857070,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140684289,
    "post_id" : 79742798,
    "body" : "it&#39;s goes to the token generation endpoint <code>&#47;employees&#47;token</code> to generate the <code>jwt</code> token, but during the journey it passes the <code>AuthorizaitonFilter</code> of the endpoint <code>&#47;visitors&#47;token</code> and throws an <code>AccessDeniedException</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 29209243,
      "reputation" : 3,
      "user_id" : 22377591,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1c81c9764c1e6cc5e121919407756939?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "hamdi",
      "link" : "https://stackoverflow.com/users/22377591/hamdi"
    },
    "creation_date" : 1755856498,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140684207,
    "post_id" : 79742798,
    "body" : "After successful authentication, where is the user redirected to? What&#39;s the success url?",
    "score" : 0,
    "owner" : {
      "account_id" : 55989,
      "reputation" : 19067,
      "user_id" : 167745,
      "user_type" : "registered",
      "accept_rate" : 76,
      "profile_image" : "https://i.sstatic.net/wBebv.jpg?s=256",
      "display_name" : "Stewart",
      "link" : "https://stackoverflow.com/users/167745/stewart"
    },
    "creation_date" : 1755853862,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}