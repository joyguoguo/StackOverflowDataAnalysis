{
  "question" : {
    "question_id" : 79749981,
    "title" : "Karate 1.5.1 custom HttpClientFactory (PSK-TLS) works in IntelliJ but fails with SSLHandshakeException from command line",
    "body" : "<p>`I recently upgraded a test automation project from Karate 0.9.6 to Karate 1.5.1.</p>\n<p>In 0.9.6, I was using karate-apache for my custom HTTP client implementation. Since karate-apache is no longer available in 1.5.x, I had to explicitly implement my own HttpClientFactory to support PSK-TLS communication.</p>\n<p>My implementation uses a ConditionalPskHttpClientFactory that switches between:\na PSK-TLS client (PskTlsHttpClient) when a special header (X-Admin-From) is present, and\nthe standard ApacheHttpClient otherwise.</p>\n<ul>\n<li><strong>The Problem</strong>\nWhen I run tests from IntelliJ, everything works fine and all test cases pass.\nWhen I package the project (jar) and run the test suites via command line, I get an SSL handshake failure:</li>\n</ul>\n<pre><code>http call failed after 4 milliseconds for url: https://192.168.99.100:30058/Iotss\njavax.net.ssl.SSLHandshakeException: Received fatal alert: handshake_failure\nkarate/tests/core/revoke-certificate-api.feature:158\n</code></pre>\n<ul>\n<li><strong>Command Iâ€™m Using (fails with SSLHandshakeException)</strong></li>\n</ul>\n<pre><code>java -cp &quot;.;lib/test-automation-1.3.1-SNAPSHOT.jar;lib/karate-1.5.1.jar;lib/lib-signed/bcprov-jdk15on.jar;lib/lib-signed/bcpg-jdk15on.jar;lib/lib-signed/bcpkix-jdk15on.jar;lib/lib-signed/bctls-jdk15on.jar&quot; \\\n     -Dkarate.env=minikube \\\n     -Dkarate.http.client.factory=com.thales.mcs.iot.ss.applet.ConditionalPskHttpClientFactory \\\n     com.intuit.karate.Main \\\n     --tags ~@draft,~@common,~@ignore,~@perf \\\n     --output target \\\n     karate/tests/core/\n</code></pre>\n<ul>\n<li><strong>IntelliJ Runner (works fine)</strong></li>\n</ul>\n<pre><code>@Test\nvoid testParallel() {\n    System.setProperty(&quot;karate.env&quot;, &quot;minikube&quot;);\n    Results results = Runner.path(&quot;classpath:karate/tests/core/&quot;)\n            .tags(&quot;~@draft&quot;, &quot;~@ignore&quot;)\n            .clientFactory(new ConditionalPskHttpClientFactory())\n            .parallel(2);\n    Assertions.assertEquals(0, results.getFailCount(), results.getErrorMessages());\n}\n\n</code></pre>\n<p>*Why would PSK-TLS handshakes succeed in IntelliJ but fail with SSLHandshakeException when running the exact same feature files from command line?</p>\n<p>Is there a specific configuration required in Karate 1.5.1 or JVM command line to ensure a custom HttpClientFactory (with BouncyCastle PSK provider) works properly?</p>\n<p>Am I missing something in how the classpath or karate.http.client.factory property should be set when running from the CLI?*</p>\n<p><strong>Additional Info</strong></p>\n<p>JDK: 21\nKarate: 1.5.1\nDependencies: BouncyCastle (bcprov-jdk15on, bcpkix-jdk15on, bctls-jdk15on) are on classpath\nWorks fine inside IntelliJ with .clientFactory(new ConditionalPskHttpClientFactory())\nFails with javax.net.ssl.SSLHandshakeException: handshake_failure when running with com.intuit.karate.Main from CLI</p>\n<ol>\n<li><p>Added karate.configure('clientFactory', ...) in karate-config.js (but clientFactory is no longer supported in Karate 1.5.1).</p>\n</li>\n<li><p>Added the property in a static block:</p>\n</li>\n</ol>\n<pre><code>static {\nSystem.setProperty(&quot;karate.http.client.factory&quot;,\n-         &quot;com.thales.mcs.iot.ss.applet.ConditionalPskHttpClientFactory&quot;);\n- }\n</code></pre>\n<ol start=\"3\">\n<li>Tried setting -Dkarate.http.client.factory=... via command line.`</li>\n</ol>\n",
    "tags" : [ "java", "ssl", "httpclient", "karate", "tls-psk" ],
    "owner" : {
      "account_id" : 43708016,
      "reputation" : 11,
      "user_id" : 31376942,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b3ae33260bc486cb173999fc9d89a1b2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "RMP",
      "link" : "https://stackoverflow.com/users/31376942/rmp"
    },
    "is_answered" : false,
    "view_count" : 77,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1756454789,
    "creation_date" : 1756454789,
    "link" : "https://stackoverflow.com/questions/79749981/karate-1-5-1-custom-httpclientfactory-psk-tls-works-in-intellij-but-fails-with",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140717100,
    "post_id" : 79749981,
    "body" : "And second possibility is to add <code>* configure ssl = true</code> to the <code>.feature</code> file right before you make SSH call",
    "score" : 0,
    "owner" : {
      "account_id" : 456728,
      "reputation" : 14834,
      "user_id" : 855636,
      "user_type" : "registered",
      "accept_rate" : 94,
      "profile_image" : "https://www.gravatar.com/avatar/9ccd3a2c422f40ad6c7c2f93d3afe5b6?s=256&d=identicon&r=PG",
      "display_name" : "Pavel Janicek",
      "link" : "https://stackoverflow.com/users/855636/pavel-janicek"
    },
    "creation_date" : 1757075324,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140717095,
    "post_id" : 79749981,
    "body" : "I have two possibilities for you to try. First one is to try to add flags as suggested in this answer: <a href=\"https://stackoverflow.com/a/57607812/855636\">stackoverflow.com/a/57607812/855636</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 456728,
      "reputation" : 14834,
      "user_id" : 855636,
      "user_type" : "registered",
      "accept_rate" : 94,
      "profile_image" : "https://www.gravatar.com/avatar/9ccd3a2c422f40ad6c7c2f93d3afe5b6?s=256&d=identicon&r=PG",
      "display_name" : "Pavel Janicek",
      "link" : "https://stackoverflow.com/users/855636/pavel-janicek"
    },
    "creation_date" : 1757075269,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}