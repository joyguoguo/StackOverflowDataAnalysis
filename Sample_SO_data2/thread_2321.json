{
  "question" : {
    "question_id" : 79632707,
    "title" : "Making MapStruct put @Component on its implementations – while allowing for Spring-less initialization",
    "body" : "<p>Imagine I want my MapStruct mappers to be Spring-managed <code>@Component</code>s (for production).</p>\n<p>Also imagine I want to test those mappers. However, I don't want to bootstrap the entire Spring context to do that. Or even a tiny context that has the mappers only. I want to unit-test the mappers and keep Spring completely unaware of that.</p>\n<p>As far as I know, the only way to make MapStruct annotate its generated mapper implementations with <code>@Component</code> is to set <code>componentModel</code> to <code>&quot;spring&quot;</code>.</p>\n<p>However, that means that any mappers created with the <code>Mappers</code> factory (which I want to do in my unit-test) would not be initialized.</p>\n<p>So it seems I'm between a rock and a hard place: I either manually create mapper <code>@Bean</code>s or abandon the idea of testing MapStruct mappers without Spring's involvement. Or am I wrong?</p>\n<pre class=\"lang-java prettyprint-override\"><code>import lombok.Getter;\nimport lombok.Setter;\n\nimport java.util.List;\n\n@Getter\n@Setter\npublic class UserRequestDto {\n\n    private Long id;\n    private String name;\n    private List&lt;String&gt; emailData;\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>import jakarta.persistence.Column;\nimport jakarta.persistence.Entity;\nimport jakarta.persistence.GeneratedValue;\nimport jakarta.persistence.GenerationType;\nimport jakarta.persistence.Id;\nimport jakarta.persistence.OneToMany;\nimport jakarta.persistence.Table;\nimport lombok.Getter;\nimport lombok.Setter;\n\nimport java.util.List;\n\n@Entity\n@Getter\n@Setter\n@Table(name = &quot;\\&quot;user\\&quot;&quot;)\npublic class User {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n    private String name;\n    @OneToMany\n    private List&lt;EmailData&gt; emailData;\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>import jakarta.persistence.Entity;\nimport jakarta.persistence.GeneratedValue;\nimport jakarta.persistence.GenerationType;\nimport jakarta.persistence.Id;\nimport jakarta.persistence.Table;\nimport lombok.Getter;\nimport lombok.Setter;\n\n@Entity\n@Getter\n@Setter\n@Table(name = &quot;email_data&quot;)\npublic class EmailData {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n    // a back reference to user is omitted for irrelevance\n    private String email;\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>import org.mapstruct.Mapper;\n\n@Mapper(uses = EmailMapper.class, componentModel=&quot;spring&quot;)\npublic interface UserMapper {\n    User toUser(UserRequestDto userRequestDto);\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>import org.mapstruct.Mapper;\nimport org.mapstruct.Mapping;\n\n@Mapper\npublic interface EmailMapper {\n    @Mapping(source = &quot;.&quot;, target = &quot;email&quot;)\n    EmailData toEmailData(String email);\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>import com.example.pixel_user_api.data.dto.request.UserRequestDto;\nimport com.example.pixel_user_api.data.entity.User;\nimport org.junit.jupiter.api.Test;\nimport org.mapstruct.factory.Mappers;\n\nimport java.util.List;\n\nimport static org.assertj.core.api.Assertions.assertThat;\n\nclass UserMapperTest {\n    @Test\n    void testMapper() {\n        UserRequestDto userDto = new UserRequestDto();\n        userDto.setId(123L);\n        userDto.setName(&quot;Steve123&quot;);\n        String email = &quot;steve@gmail.com&quot;;\n        userDto.setEmailData(List.of(email));\n\n        UserMapper mapper = Mappers.getMapper(UserMapper.class);\n        User user = mapper.toUser(userDto); // throws NPE\n    }\n}\n</code></pre>\n<pre><code>java.lang.NullPointerException: Cannot invoke &quot;com.example.pixel_user_api.mapper.EmailMapper.toEmailData(String)&quot; because &quot;this.emailMapper&quot; is null\n</code></pre>\n",
    "tags" : [ "java", "spring", "mapstruct" ],
    "owner" : {
      "account_id" : 10187542,
      "reputation" : 2683,
      "user_id" : 20692967,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
      "display_name" : "Sergey Zolotarev",
      "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
    },
    "is_answered" : true,
    "view_count" : 121,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1747926984,
    "creation_date" : 1747858781,
    "link" : "https://stackoverflow.com/questions/79632707/making-mapstruct-put-component-on-its-implementations-while-allowing-for-spri",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79634061,
    "question_id" : 79632707,
    "body" : "<p>You can always use constructor injection and just instantiate it in your tests.</p>\n<p>e.g.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Mapper(\n    uses = EmailMapper.class,\n    componentModel = &quot;spring&quot;,\n   injectionStrategy = InjectionStrategy.CONSTRUCTOR\n)\n\npublic interface UserMapper {\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1128956,
      "reputation" : 21901,
      "user_id" : 1115491,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c9531b4a4ce89f5e793bfb91916318bb?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Filip",
      "link" : "https://stackoverflow.com/users/1115491/filip"
    },
    "creation_date" : 1747926984,
    "last_activity_date" : 1747926984,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79633198,
    "question_id" : 79632707,
    "body" : "<p>It turns out I can simply do this</p>\n<pre class=\"lang-java prettyprint-override\"><code>import org.springframework.stereotype.Component;\n\n@Mapper(uses = EmailMapper.class)\n@AnnotateWith(Component.class)\n//@Mapper(uses = EmailMapper.class, componentModel = &quot;spring&quot;)\npublic interface UserMapper {\n</code></pre>\n<p>Available since 1.6 (see this <a href=\"https://github.com/mapstruct/mapstruct/pull/2792\" rel=\"nofollow noreferrer\">PR</a>)</p>\n",
    "score" : -1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 10187542,
      "reputation" : 2683,
      "user_id" : 20692967,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
      "display_name" : "Sergey Zolotarev",
      "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
    },
    "creation_date" : 1747895584,
    "last_activity_date" : 1747895584,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140454001,
    "post_id" : 79632707,
    "body" : "Also the solution would be simple to use <code>UserMapper mapper = new UserMapperImpl(new EmailMapperImpl())</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 18586978,
      "reputation" : 3850,
      "user_id" : 15000097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/yFl4M.jpg?s=256",
      "display_name" : "Georgii Lvov",
      "link" : "https://stackoverflow.com/users/15000097/georgii-lvov"
    },
    "creation_date" : 1748031700,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140448122,
    "post_id" : 79632707,
    "body" : "@萝莉w <code>UserMapper</code> did (since it <code>uses</code> <code>EmailMapper</code>)",
    "score" : 0,
    "owner" : {
      "account_id" : 10187542,
      "reputation" : 2683,
      "user_id" : 20692967,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
      "display_name" : "Sergey Zolotarev",
      "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
    },
    "creation_date" : 1747891438,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140447770,
    "post_id" : 79632707,
    "body" : "Where did you call <code>EmailMapper.toEmailData</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 14331879,
      "reputation" : 346,
      "user_id" : 10352428,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/619aa63a0625944a2aa2fd0fdacb95cb?s=256&d=identicon&r=PG",
      "display_name" : "萝莉w",
      "link" : "https://stackoverflow.com/users/10352428/%e8%90%9d%e8%8e%89w"
    },
    "creation_date" : 1747873265,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79633198" : [ {
      "comment_id" : 140450921,
      "post_id" : 79633198,
      "body" : "In my opinion it is an anti-pattern to mix and match component models, that&#39;s what I am saying that it is not the right solution. Yes you can do it, but I would highly discourage people of doing it like that",
      "score" : 1,
      "owner" : {
        "account_id" : 1128956,
        "reputation" : 21901,
        "user_id" : 1115491,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/c9531b4a4ce89f5e793bfb91916318bb?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Filip",
        "link" : "https://stackoverflow.com/users/1115491/filip"
      },
      "creation_date" : 1747949401,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140449893,
      "post_id" : 79633198,
      "body" : "@Filip I don&#39;t need to inject <code>EmailMapper</code>. I only inject <code>UserMapper</code>, and it&#39;s initialized alright (I&#39;ve run it). In other words, when it comes to the problem in question, it <i>is</i> a solution",
      "score" : 0,
      "owner" : {
        "account_id" : 10187542,
        "reputation" : 2683,
        "user_id" : 20692967,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
        "display_name" : "Sergey Zolotarev",
        "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
      },
      "creation_date" : 1747927230,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140449864,
      "post_id" : 79633198,
      "body" : "This is not a solution, because the <code>EmailMapper</code> will not be injected using spring injection.",
      "score" : 0,
      "owner" : {
        "account_id" : 1128956,
        "reputation" : 21901,
        "user_id" : 1115491,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/c9531b4a4ce89f5e793bfb91916318bb?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Filip",
        "link" : "https://stackoverflow.com/users/1115491/filip"
      },
      "creation_date" : 1747926875,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79634061" : [ {
      "comment_id" : 140505488,
      "post_id" : 79634061,
      "body" : "But I can&#39;t be sure what name MapStruct will choose for its implementation. It can easily change between releases. I would argue it would make my tests brittle",
      "score" : 0,
      "owner" : {
        "account_id" : 10187542,
        "reputation" : 2683,
        "user_id" : 20692967,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
        "display_name" : "Sergey Zolotarev",
        "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
      },
      "creation_date" : 1749646690,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140505448,
      "post_id" : 79634061,
      "body" : "You can always instantiate the generate <code>UserMapperImpl</code>. In the end MapStruct is an annotation processor which generates Java code and you have access to this Java code",
      "score" : 0,
      "owner" : {
        "account_id" : 1128956,
        "reputation" : 21901,
        "user_id" : 1115491,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/c9531b4a4ce89f5e793bfb91916318bb?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Filip",
        "link" : "https://stackoverflow.com/users/1115491/filip"
      },
      "creation_date" : 1749645990,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140484421,
      "post_id" : 79634061,
      "body" : "Wait. <i>How</i> do I instantiate it in my tests?",
      "score" : 0,
      "owner" : {
        "account_id" : 10187542,
        "reputation" : 2683,
        "user_id" : 20692967,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
        "display_name" : "Sergey Zolotarev",
        "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
      },
      "creation_date" : 1748974536,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}