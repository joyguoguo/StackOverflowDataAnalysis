{
  "question" : {
    "question_id" : 79729323,
    "title" : "A User Defined Aggregated Function fails to shape a Map&lt;K, C&gt; field, where C is an object coming from many rows",
    "body" : "<p>Edit: Progressing into this problem analysis, the management of the dataset nested values with tools that Spark offers since <code>3.1.x</code> seems required.<br />\n→ It's my manner of filling nested objects hold by objects carried by a <code>Dataset</code> that is currently wrong.</p>\n<p>I have a clumsy workaround, and there's a theoretically solution through\n<a href=\"https://stackoverflow.com/questions/65229416/how-to-transform-rows-with-spark-to-a-row-with-a-map-column\">How to transform rows with Spark to a row with a map Column</a> leading me to something starting like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Dataset&lt;Row&gt; datasetRowPerimetres = [...]\n\nreturn groupBy(datasetRowPerimetres)\n.agg(collect_list(&quot;nomCommuneMembre&quot;).alias(&quot;nomCommuneMembre&quot;))\n.withColumn(&quot;mG&quot;, map(new Column(&quot;sirenGroupement&quot;), new Column(&quot;nomCommuneMembre&quot;)))\n.drop(&quot;nomCommuneMembre&quot;);\n</code></pre>\n<p>that shows me a map <code>mG</code> like that:</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>sirenGroupement</th>\n<th>mG</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>200000198</td>\n<td>{200000198 -&gt; [Beaumont, Ceyrat, Saint-Genès-Champanelle]}</td>\n</tr>\n</tbody>\n</table></div>\n<ul>\n<li>the map key should be replaced by another one</li>\n<li>and cities names by their cities objects.</li>\n</ul>\n<p>Code would become clumsy, with drawbacks. I'm abandoning this and return to separate Datasets having objects without array, set or map. At the cost their users will join them by their keys if needed.</p>\n<hr />\n<p>I often have the problem to dispatch a list or a set of children objects <code>C</code> into their <code>P</code> parent, and return a list of <code>P</code> objects where each <code>P</code> is filled with its <code>C</code> objects.<br />\nBut it's harder to return <code>Dataset&lt;P&gt;</code> having these ones.</p>\n<p>I've tried to solve this problem through a custom user aggregation function (Spark 3.5.6).</p>\n<p>I'm starting from an open data source CSV, that contains records for French local authorities completed by the cities that are their members:</p>\n<pre><code>L1, C1\nL1, C2\nL1, C3\nL2, C4\nL2, C5\n[...]\n</code></pre>\n<p>From the CSV file, I've extracted primitives fields and composed few business objects. Each record depicts what is called a <code>Perimeter</code>: a working/DTO object that is a the description of a member of a local authority.</p>\n<p>In example, <code>Perimeter</code> objects are for the &quot;Communauté Intercommunale des Villes Solidaires (CA)&quot; local authority, that has six cities, these ones:</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>categorieMembresGroupement</th>\n<th>communeMembreGroupement</th>\n<th>competencesExercees</th>\n<th>densiteDemographiqueHabitantsAuKilometreCarre</th>\n<th>etablissementPublicTerritorialDeBassin</th>\n<th>fiscaliteFinancement</th>\n<th>fiscalitePropre</th>\n<th>gestionDesEaux</th>\n<th>interdepartemental</th>\n<th>membreAdherentSyndicatMixte</th>\n<th>natureJuridique</th>\n<th>nomGroupement</th>\n<th>nombreDeCommunesMmebres</th>\n<th>organigramme</th>\n<th>population</th>\n<th>redevanceEnlevementOrduresMenageres</th>\n<th>siege</th>\n<th>siren</th>\n<th>taxeEnlevementOrduresMenageres</th>\n<th>zoneDeMontagne</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>commune</td>\n<td>{97401, {974}, {04}, Les Avirons, 218, 11445, 11663, 219740016}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{Ile De La Réunion Mobilités, 891190, 200045276}</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n<tr>\n<td>commune</td>\n<td>{97404, {974}, {04}, L'Étang-Salé, 211, 14329, 14540, 219740040}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{SM de Pierrefonds, 356662, 259741007}</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n<tr>\n<td>commune</td>\n<td>{97405, {974}, {04}, Petite-Île, 171, 12920, 13091, 219740057}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{SAEP des Hirondelles, 320612, 200101079}</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n<tr>\n<td>commune</td>\n<td>{97414, {974}, {04}, Saint-Louis, 676, 54478, 55154, 219740149}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{SM d'études et de programmation du SCOT du Grand Sud, 320612, 259741080}</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n<tr>\n<td>commune</td>\n<td>{97416, {974}, {04}, Saint-Pierre, 886, 85254, 86140, 219740164}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{SM de traitement des déchets des microrégions Sud et Ouest de La Réunion dénommé ILEVA, 542144, 200045342}</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n<tr>\n<td>commune</td>\n<td>{97424, {974}, {04}, Cilaos, 45, 5215, 5260, 219740248}</td>\n<td>{NULL, {C1020 -&gt; {C1020, false, false, NULL}, C1505 -&gt; {C1505, false, false, NULL}, [...]</td>\n<td>491.7</td>\n<td>NULL</td>\n<td>{NULL, 4108814, NULL, 9325112, 5216298, FPU, NULL, NULL, NULL, NULL, NULL, NULL}</td>\n<td>true</td>\n<td>NULL</td>\n<td>false</td>\n<td>{ , NULL,  }</td>\n<td>COMMUNAUTE_AGGLOMERATION</td>\n<td>CA CIVIS (Communauté Intercommunale des Villes Solidaires)</td>\n<td>6</td>\n<td>{M., RDC,  , LORION, 70, David, NULL}</td>\n<td>185848</td>\n<td>false</td>\n<td>{{ , NULL, NULL, NULL, 97410,[...] [...]</td>\n<td>249740077</td>\n<td>true</td>\n<td>false</td>\n</tr>\n</tbody>\n</table></div>\n<p><code>communeMembreGroupement</code> and <code>membreAdherentSyndicatMixte</code> being the business objects varying for each <code>Perimeter</code> owned by the same local authority.</p>\n<p>And here, I need to start creating objects of <code>Groupement</code> class, depicting these local authorities, each <code>Groupement</code> having for variable member an object <code>MembresGroupement</code> listing its member cities.</p>\n<p>A <code>Groupement</code> has for structure:</p>\n<pre class=\"lang-none prettyprint-override\"><code>root\n |-- competencesExercees: struct\n |    |-- competenceConservee: boolean\n |    |-- competences: map\n |    |    |-- key: string\n |    |    |-- value: struct (valueContainsNull = true)\n |    |    |    |-- code: string\n |    |    |    |-- deleguee: boolean\n |    |    |    |-- interetCommunautaire: boolean\n |    |    |    |-- obligatoire: boolean\n |    |-- nombreDeCompetencesExercees: integer\n |    |-- syndicatALaCarte: boolean\n |-- densiteDemographiqueHabitantsAuKilometreCarre: double\n |-- etablissementPublicTerritorialDeBassin: boolean\n |-- fiscaliteFinancement: struct\n |    |-- dgfParHabitant: double\n |    |-- dotationDeCompensation: integer\n |    |-- dotationDesGroupementsTouristiques: integer\n |    |-- dotationGlobale: integer\n |    |-- dotationIntercommunalite: integer\n |    |-- modeDeFinancement: string\n |    |-- obsoleteAutreRedevance: integer\n |    |-- obsoleteAutreTaxe: integer\n |    |-- obsoleteDGFBonifiee: integer\n |    |-- obsoleteDSC: integer\n |    |-- populationDGF: integer\n |    |-- potentielFiscal: integer\n |-- fiscalitePropre: boolean (nullable = false)\n |-- gestionDesEaux: boolean\n |-- interdepartemental: boolean\n |-- membresGroupement: map\n |    |-- key: string\n |    |-- value: struct (valueContainsNull = true)\n |    |    |-- categorieMembresGroupement: string\n |    |    |-- communeMembreGroupement: struct\n |    |    |    |-- codeCommune: string\n |    |    |    |-- codeDepartementCommune: struct\n |    |    |    |    |-- id: string\n |    |    |    |-- codeRegionCommune: struct\n |    |    |    |    |-- id: string\n |    |    |    |-- nomCommune: string\n |    |    |    |-- populationCommuneCompteAPart: integer\n |    |    |    |-- populationCommuneMunicipale: integer\n |    |    |    |-- populationCommuneTotale: integer\n |    |    |    |-- sirenCommune: string\n |    |    |-- membreAdherentSyndicatMixte: struct\n |    |    |    |-- nomAdherent: string\n |    |    |    |-- populationAdherente: integer\n |    |    |    |-- sirenAdherent: string\n |    |    |-- sirenGroupement: string\n |-- natureJuridique: string\n |-- nomGroupement: string\n |-- nombreDeCommunesMmebres: integer\n |-- organigramme: struct\n |    |-- civilite: string\n |    |-- modeDeRepartitionDesSieges: string\n |    |-- modeDeRepartitionDesSiegesAutre: string\n |    |-- nomPresident: string\n |    |-- nombreDeDelegues: integer\n |    |-- prenomPresident: string\n |    |-- representationSubstitution: string\n |-- population: integer\n |-- redevanceEnlevementOrduresMenageres: boolean\n |-- siege: struct\n |    |-- adresseAdministrative: struct\n |    |    |-- bureauDistributeur: string\n |    |    |-- cedex: string\n |    |    |-- codeCommune: struct\n |    |    |    |-- id: string\n |    |    |-- codePaysEtranger: string\n |    |    |-- codePostal: string\n |    |    |-- commentaire: string\n |    |    |-- complementNom: string\n |    |    |-- complementVoie: string\n |    |    |-- libelleCedex: string\n |    |    |-- nom: string\n |    |    |-- nomPaysEtranger: string\n |    |    |-- numeroVoie: string\n |    |    |-- repetitionNumeroDansVoie: string\n |    |    |-- typeVoie: string\n |    |    |-- ville: string\n |    |    |-- voie: string\n |    |-- adresseSiege: struct\n |    |    |-- bureauDistributeur: string\n |    |    |-- cedex: string\n |    |    |-- codeCommune: struct\n |    |    |    |-- id: string\n |    |    |-- codePaysEtranger: string\n |    |    |-- codePostal: string\n |    |    |-- commentaire: string\n |    |    |-- complementNom: string\n |    |    |-- complementVoie: string\n |    |    |-- libelleCedex: string\n |    |    |-- nom: string\n |    |    |-- nomPaysEtranger: string\n |    |    |-- numeroVoie: string\n |    |    |-- repetitionNumeroDansVoie: string\n |    |    |-- typeVoie: string\n |    |    |-- ville: string\n |    |    |-- voie: string\n |    |-- codeCommune: string\n |    |-- codeDepartementCommune: struct\n |    |    |-- id: string\n |    |-- codeRegionCommune: struct\n |    |    |-- id: string\n |    |-- communeSiege: struct\n |    |    |-- arrondissement: string\n |    |    |-- codeCommune: string\n |    |    |-- codeDepartementCommune: struct\n |    |    |    |-- id: string\n |    |    |-- codeRegionCommune: struct\n |    |    |    |-- id: string\n |    |    |-- commune: struct\n |    |    |    |-- arrondissement: string\n |    |    |    |-- codeCanton: string\n |    |    |    |-- codeCommune: string\n |    |    |    |-- codeCommuneParente: string\n |    |    |    |-- codeDepartement: string\n |    |    |    |-- codeEPCI: string\n |    |    |    |-- codeRegion: string\n |    |    |    |-- latitude: double\n |    |    |    |-- longitude: double\n |    |    |    |-- natureJuridiqueEPCI: string\n |    |    |    |-- nomCommune: string\n |    |    |    |-- nomDepartement: string\n |    |    |    |-- nomEPCI: string\n |    |    |    |-- nomMajuscules: string\n |    |    |    |-- population: integer\n |    |    |    |-- sirenCommune: string\n |    |    |    |-- strateCommune: integer\n |    |    |    |-- surface: double\n |    |    |    |-- typeCommune: string\n |    |    |    |-- typeNomEtCharniere: string\n |    |    |-- nomCommune: string\n |    |    |-- populationCommuneCompteAPart: integer\n |    |    |-- populationCommuneMunicipale: integer\n |    |    |-- populationCommuneTotale: integer\n |    |    |-- sirenCommune: string\n |    |-- dateCreation: date\n |    |-- dateEffet: date\n |    |-- email: string\n |    |-- faxAdministratif: string\n |    |-- faxSiege: string\n |    |-- siteInternet: string\n |    |-- telephoneAdministratif: string\n |    |-- telephoneSiege: string\n |-- siren: string\n |-- taxeEnlevementOrduresMenageres: boolean\n |-- zoneDeMontagne: boolean\n</code></pre>\n<p>I've created an <code>Aggregator</code> class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>/**\n * Agrégateur de {@link Perimetre} en {@link Groupement}\n * @author Marc Le Bihan\n */\npublic class GroupementAggregator extends Aggregator&lt;Perimetre, Groupement, Groupement&gt; {\n   @Serial\n   private static final long serialVersionUID = 1861686194387336535L;\n\n   /**\n    * Renvoyer une valeur neutre pour cette aggrégation\n    * @return groupement vide\n    */\n   @Override\n   public Groupement zero() {\n      Groupement zero = new Groupement();\n      zero.setNatureJuridique(NatureJuridiqueGroupement.METROPOLE_LYON);\n      zero.setMembresGroupement(new MembresGroupement());\n      return zero;\n   }\n\n   /**\n    * Combine deux valeurs pour en créer une autre (il est possible qu'elle modifie l'objet {@link Groupement} soumis plutôt que d'en créer un autre.\n    * @param groupement Groupement à réduire (cumuler dedans)\n    * @param perimetre Périmètre à considérer\n    * @return Groupement réduit\n    */\n   @Override\n   public Groupement reduce(Groupement groupement, Perimetre perimetre) {\n      // Si le groupement que l'on nous soumet est vide, il s'agit de celui créé par la fonction zero.\n      // Mais il ne nous intéresse pas, et nous préférons recréer un vrai groupement, une première fois, d'après le périmètre reçu.\n      Groupement groupementReduit = groupement.getSiren() == null ? new Groupement(perimetre) : new Groupement(groupement);\n\n      if (groupementReduit.getMembresGroupement() == null) {\n         groupementReduit.setMembresGroupement(new MembresGroupement());\n      }\n\n      MembreGroupement membre = new MembreGroupement(perimetre);\n\n      groupementReduit.getMembresGroupement().add(membre);\n      return groupementReduit;\n   }\n\n   /**\n    * Fusionner deux valeurs intermédiaires\n    * @param a Premier {@link Groupement}\n    * @param b Deuxième {@link Groupement}\n    * @return Groupement déduit\n    */\n   @Override\n   public Groupement merge(Groupement a, Groupement b) {\n      // Si l'un des groupements est le zéro, retourner l'autre\n      if (a.getSiren() == null) {\n         return b;\n      }\n\n      if (b.getSiren() == null) {\n         return a;\n      }\n\n      // FIXME : Fait un aggregate ici, mais sans tenir compte d'un group by qu'il faudrait faire avant\n      a.getMembresGroupement().addAll(b.getMembresGroupement());\n      return a;\n   }\n\n   /**\n    * Transformer la sortie après réduction\n    * @param reduction Contenu réduit\n    * @return {@link Groupement} final\n    */\n   @Override\n   public Groupement finish(Groupement reduction) {\n      // Pas de modification à apporter à l'objet final\n      return reduction;\n   }\n\n   /**\n    * Renvoyer l'encodeur du type intermédiaire\n    * @return Encodeur de {@link Groupement}\n    */\n   @Override\n   public Encoder&lt;Groupement&gt; bufferEncoder() {\n      return Encoders.bean(Groupement.class);\n   }\n\n   /**\n    * Renvoyer l'encodeur du type final\n    * @return Encodeur de {@link Groupement}\n    */\n   @Override\n   public Encoder&lt;Groupement&gt; outputEncoder() {\n      return Encoders.bean(Groupement.class);\n   }\n}\n</code></pre>\n<p>And I'm using it this way:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public Dataset&lt;Groupement&gt; datasetGroupementsAvecMembres(Dataset&lt;Perimetre&gt; datasetPerimetre) {\n   GroupementAggregator agreggateurGroupement = new GroupementAggregator();\n   TypedColumn&lt;Perimetre, Groupement&gt; groupements = agreggateurGroupement.toColumn().name(&quot;mG&quot;);\n   return datasetPerimetre.select(groupements);\n}\n</code></pre>\n<p>You can see that it is lacking a <code>groupBy(...)</code> call that I can't yet find how to introduce. But my current problem is its behavior. When I'm debugging it:</p>\n<ol>\n<li><p>It calls a lot of times the <code>zero()</code> method of the <code>Aggregator</code>.</p>\n</li>\n<li><p>Its reduce function looks working the way I like: the <code>membreGroupements</code> variable (should be renamed <code>membresGroupement</code> to be more correct) of the <code>groupement</code> object being reduced is well filled:</p>\n<p><a href=\"https://i.sstatic.net/Dd3XyT04.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/Dd3XyT04.png\" alt=\"enter image description here\" /></a></p>\n</li>\n<li><p>My <code>merge(...)</code> method, however, is always receiving one <code>zero</code> object one side, each time it is called. So it isn't merging anything in fact, I think.</p>\n<p><a href=\"https://i.sstatic.net/82qpNwDT.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/82qpNwDT.png\" alt=\"enter image description here\" /></a></p>\n</li>\n<li><p>Eventually, my <code>finish(...)</code> method received a <code>groupement</code> object that has no cities members.</p>\n<p><a href=\"https://i.sstatic.net/nSLXnNpP.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/nSLXnNpP.png\" alt=\"enter image description here\" /></a></p>\n</li>\n</ol>\n<p>As a workaround, I've succeeded in creating such <code>P</code> having a <code>Map&lt;P.key, C&gt;</code> member, another way.<br />\nBut not perfectly. It was creating the objects, but not really a <code>Dataset&lt;P&gt;</code> having its <code>C</code> children inside:</p>\n<p>I'm filling a <code>Groupements</code> that is a <code>LinkedHashSet</code> of <code>Groupement</code> by <code>SIREN</code> (<code>String</code>) key, using this method:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public Groupements groupementsAvecMembres(Dataset&lt;Row&gt; datasetRowPerimetres, int anneeCOG) {\n   Dataset&lt;Perimetre&gt; datasetPerimetres = this.datasetPerimetre.datasetPerimetres(datasetRowPerimetres, anneeCOG);\n   Dataset&lt;Groupement&gt; datasetGroupements = datasetGroupementsSansMembres(datasetRowPerimetres, anneeCOG);\n   Dataset&lt;MembreGroupement&gt; datasetMembresGroupements = this.datasetPerimetre.datasetMembresGroupements(datasetPerimetres);\n\n   return super.declinaison(new Groupements(),\n      datasetGroupements, datasetGroupements.col(&quot;siren&quot;), Groupement::getSiren,\n      datasetMembresGroupements, datasetMembresGroupements.col(&quot;siren&quot;), m -&gt; m.getCommuneMembreGroupement().getSirenCommune(),\n      Groupement::getMembresGroupement);\n}\n</code></pre>\n<p>with:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public &lt;P extends Serializable, KP, E extends Serializable, KE, C extends Map&lt;KP, P&gt;&gt; C declinaison(C ensemble,\n   Dataset&lt;P&gt; parents, Column columnJoinP, Function&lt;P, KP&gt; obtenirClefDuParent,\n   Dataset&lt;E&gt; enfants, Column columnJoinE, Function&lt;E, KE&gt; obtenirClefEnfant,\n   Function&lt;P, Map&lt;KE, E&gt;&gt; obtenirMapEnfants) {\n\n   Dataset&lt;Tuple2&lt;P, E&gt;&gt; ds = parents.joinWith(enfants, columnJoinP.equalTo(columnJoinE), &quot;inner&quot;);\n\n   for(Tuple2&lt;P, E&gt; tuple : ds.collectAsList()) {\n      // Rechercher l'objet parent par KP, et l'ajouter à l'ensemble C, vide, s'il n'existe  pas.\n      P source = tuple._1();\n      KP clefSourceParent = obtenirClefDuParent.apply(source);\n      P parent = ensemble.computeIfAbsent(clefSourceParent, clef -&gt; tuple._1());\n\n      // Dans cet objet parent P, rechercher la liste des enfants E, indexée par KE, et y ajouter notre instance de E.\n      Map&lt;KE, E&gt; ensembleEnfants = obtenirMapEnfants.apply(parent);\n      E nouvelEnfant = tuple._2();\n      KE clefEnfant = obtenirClefEnfant.apply(nouvelEnfant);\n      ensembleEnfants.put(clefEnfant, nouvelEnfant);\n   }\n\n   return ensemble;\n}\n</code></pre>\n<p>and this test shows that it works:</p>\n<pre class=\"lang-java prettyprint-override\"><code>// Parametrized by annotation\nString condition = String.format(&quot;sirenGroupement = %s&quot;, sirenGroupement);\n\nDataset&lt;Row&gt; rowPerimetres = datasetRowPerimetres(annee).where(condition);\nGroupements groupements = this.groupementsDataset.groupementsAvecMembres(rowPerimetres, annee);\n\nLOGGER.info(&quot;Groupements avec membres :&quot;);\nassertNotEquals(0, groupements.size(), &quot;Au moins un groupement avec membres aurait dû être trouvé pour &quot; + nom);\nLOGGER.info(&quot;{}&quot;, groupements);\n</code></pre>\n<p>shows:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Groupements avec membres :\n2025-08-08 14:39:40.192  INFO 233869 --- [           main] f.e.a.o.s.d.g.GroupementsITCase          : \nnom : CA CIVIS (Communauté Intercommunale des Villes Solidaires), siren : 249740077, nature : Communauté d''agglomération, \nsiège : {commune siège : nom : Saint-Pierre, code commune : 97416, siren : 219740164, département : 974, code région : 04, population totale : 84950, municipale : 84077, comptée à part : 873, arrondissement : 2, \ncommune : {{Code commune : 97416, Nom : Saint-Pierre, Type : null, EPCI : null (null) - null, Nom en majuscules : null, Code département : null - null, Code région : null, Commune parente (d'arrondissement, déléguée, associée) : null, Type article et charnière : null, SIREN de la commune : 219740164, SIREN de l'intercommunalité dont elle est membre : null, arrondissement : 2, code canton : null, population : 84950 (strate : null), surface (en hectares) : null, longitude: null, latitude : null}} (code commune : {13}), département : 974, code région : 04, date de création : 2002-12-26, date d'effet : 2002-12-31, \nadresse du siège : Adresse {nom : null, complément de nom : null, complément de voie : 29 Route de l'Entre-Deux, type de voie : null, numéro dans la voie : null, répétition dans la voie : null, voie : null, code postal : 97410, commune : 97410 SAINT-PIERRE, commentaire : null, code commune: null, bureau distributeur : null, code cedex : null, libellé cedex : null, code pays étranger : null, nom pays étranger : null}, téléphone :     , fax siège : null, e-mail : info.civis@wanadoo.fr, site internet : www.civis.re, \nadresse administrative : Adresse {nom : null, complément de nom : null, complément de voie : null, type de voie : null, numéro dans la voie : null, répétition dans la voie : null, voie : 29, route de l'Entre-Deux, code postal : 97410, commune : 97410 SAINT-PIERRE, commentaire : null, code commune: null, bureau distributeur : null, code cedex : null, libellé cedex : null, code pays étranger : null, nom pays étranger : null}, téléphone administratif :     , fax administratif : null}, \npopulation : 183407, \norganigramme : {mode de répartition des sièges : RDC, autre mode : null, président(e) : (civilité : M., prénom : Michel, nom : FONTAINE), nombre de délégués : null, représentation/substitution (obsolète après 2024) : 0}, \ncompétences : {nombre de compétences exercées (déclarées) : 43, compétences exercées : {C1533=code : C1533, obligatoire : null, déléguée : null, intérêt communautaire : null, C1510=code : C1510, obligatoire : null, déléguée : null, intérêt communautaire : null, C1532=code : C1532, obligatoire : null, déléguée : null, intérêt communautaire : null, [...]}, syndicat à la carte : null, compétence conservée : false}, nombre de communes du groupement: 6, densité démographique au km²: null, interdépartemental : false, zone de montagne : null, établissement public territorial de bassin : null, gestion des eaux : null, \nfiscalité et financement : {Dotation globale : null, dotation de compensation : null, dotation de l'intercommunalité : null, dotation des groupements touristiques : null, population dotation globale de financement : null, DGF par habitant : null, potentiel fiscal : null, DGF bonifiée : 0, DSC : 0, autre taxe : null, autre redevance : null}, ordures ménagères : (redevance false, taxe : true), \nmembres : {\n219740057=siren : 249740077, catégorie membres : Commune, commune membre : {nom : Petite-Île, code commune : 97405, siren : 219740057, département : 974, code région : 04, population totale : 12772, municipale : 12617, comptée à part : 155}, membre adhérent à un syndicat mixte : {nom : SM d'études et de programmation du SCOT du Grand Sud, siren : 259741080, population : 317956}, \n219740016=siren : 249740077, catégorie membres : Commune, commune membre : {nom : Les Avirons, code commune : 97401, siren : 219740016, département : 974, code région : 04, population totale : 11661, municipale : 11434, comptée à part : 227}, membre adhérent à un syndicat mixte : {nom : Ile De La Réunion Mobilités, siren : 200045276, population : 880875}, \n219740248=siren : 249740077, catégorie membres : Commune, commune membre : {nom : Cilaos, code commune : 97424, siren : 219740248, département : 974, code région : 04, population totale : 5437, municipale : 5390, comptée à part : 47}, membre adhérent à un syndicat mixte : {nom : SM de Pierrefonds, siren : 259741007, population : 353322}, \n219740149=siren : 249740077, catégorie membres : Commune, commune membre : {nom : Saint-Louis, code commune : 97414, siren : 219740149, département : 974, code région : 04, population totale : 54557, municipale : 53935, comptée à part : 622}, membre adhérent à un syndicat mixte : {nom : SAEP des Hirondelles, siren : 200101079, population : 317956}, \n219740040=siren : 249740077, catégorie membres : Commune, commune membre : {nom : L'Étang-Salé, code commune : 97404, siren : 219740040, département : 974, code région : 04, population totale : 14030, municipale : 13836, comptée à part : 194}, membre adhérent à un syndicat mixte : {nom : SM de traitement des déchets des microrégions Sud et Ouest de La Réunion dénommé ILEVA, siren : 200045342, population : 536140}, \n219740164=siren : 249740077, catégorie membres : Commune, commune membre : {nom : Saint-Pierre, code commune : 97416, siren : 219740164, département : 974, code région : 04, population totale : 84950, municipale : 84077, comptée à part : 873}, membre adhérent à un syndicat mixte : {nom : null, siren : null, population : null}\n}\n</code></pre>\n<p>But it breaks Spark flow (no <code>Dataset&lt;Groupement&gt;</code> with items properly filled with cities exists). And it can cause a memory overflow.</p>\n",
    "tags" : [ "java", "apache-spark", "aggregate-functions" ],
    "owner" : {
      "account_id" : 3366819,
      "reputation" : 3591,
      "user_id" : 2827181,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/WJK16.jpg?s=256",
      "display_name" : "Marc Le Bihan",
      "link" : "https://stackoverflow.com/users/2827181/marc-le-bihan"
    },
    "is_answered" : false,
    "view_count" : 112,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1754887274,
    "creation_date" : 1754628441,
    "link" : "https://stackoverflow.com/questions/79729323/a-user-defined-aggregated-function-fails-to-shape-a-mapk-c-field-where-c-is",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}