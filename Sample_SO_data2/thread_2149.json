{
  "question" : {
    "question_id" : 79645423,
    "title" : "Google Cloud KSM Error: Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: com/google/protobuf/MapFieldReflectionAccessor",
    "body" : "<p>\uD83D\uDCBB Environment:</p>\n<p>Java Version: Corretto 17.0.8</p>\n<p>Google Cloud KMS library: google-cloud-kms:2.38.0</p>\n<p>Build Tool: Maven</p>\n<p>IDE: IntelliJ IDEA Community Edition</p>\n<p>\uD83D\uDCE6 Dependencies (pom.xml):</p>\n<pre><code>&lt;dependencies&gt;\n &lt;dependency&gt;\n    &lt;groupId&gt;com.google.cloud&lt;/groupId&gt;\n    &lt;artifactId&gt;google-cloud-kms&lt;/artifactId&gt;\n    &lt;version&gt;2.38.0&lt;/version&gt;\n&lt;/dependency&gt;\n\n &lt;dependency&gt;\n    &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;\n    &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;\n    &lt;version&gt;4.0.0-rc-2&lt;/version&gt;\n &lt;/dependency&gt;\n\n &lt;dependency&gt;\n    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;\n    &lt;artifactId&gt;slf4j-simple&lt;/artifactId&gt;\n    &lt;version&gt;2.0.9&lt;/version&gt;\n &lt;/dependency&gt;\n&lt;/dependencies&gt;\n</code></pre>\n<p>Code Sample:</p>\n<pre><code>import com.google.cloud.kms.v1.*;\nimport com.google.protobuf.ByteString;\n\nimport java.io.IOException;\nimport java.util.Base64;\n\npublic class KmsExample {\n    public static void main(String[] args) throws IOException {\n        final var projectId = &quot;my-project&quot;;\n        final var locationId = &quot;global&quot;;\n        final var keyRingId = &quot;my-keyring&quot;;\n        final var keyId = &quot;my-key&quot;;\n\n        CryptoKeyName keyName = CryptoKeyName.of(projectId, locationId, keyRingId, keyId);\n\n        String plaintext = &quot;&quot;&quot;\n            {\n                &quot;pan&quot;: &quot;1234567890123456&quot;,\n                &quot;cvv&quot;: &quot;123&quot;,\n                &quot;expiry&quot;: &quot;12/30&quot;\n            }\n            &quot;&quot;&quot;;\n\n        try (KeyManagementServiceClient client = KeyManagementServiceClient.create()) {\n            EncryptResponse encryptResponse = client.encrypt(keyName, ByteString.copyFromUtf8(plaintext));\n            String encryptedBase64 = Base64.getEncoder().encodeToString(encryptResponse.getCiphertext().toByteArray());\n            System.out.println(&quot;Encrypted (Base64): &quot; + encryptedBase64);\n\n            DecryptResponse decryptResponse = client.decrypt(keyName, encryptResponse.getCiphertext());\n            String decrypted = decryptResponse.getPlaintext().toStringUtf8();\n            System.out.println(&quot;Decrypted: &quot; + decrypted);\n        }\n    }\n}\n</code></pre>\n<p>Error Stack Trace:</p>\n<pre><code>Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: com/google/protobuf/MapFieldReflectionAccessor\n    at com.google.cloud.kms.v1.stub.GrpcKeyManagementServiceStub.&lt;clinit&gt;(GrpcKeyManagementServiceStub.java:159)\n    at com.google.cloud.kms.v1.stub.KeyManagementServiceStubSettings.createStub(KeyManagementServiceStubSettings.java:687)\n    at com.google.cloud.kms.v1.KeyManagementServiceClient.&lt;init&gt;(KeyManagementServiceClient.java:783)\n    at com.google.cloud.kms.v1.KeyManagementServiceClient.create(KeyManagementServiceClient.java:765)\n    at com.example.KmsExample.main(KmsExample.java:31)\nCaused by: java.lang.ClassNotFoundException: com.google.protobuf.MapFieldReflectionAccessor\n    at java.base/jdk.internal.loader.BuiltinClassLoader.loadClass(BuiltinClassLoader.java:641)\n    at java.base/jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(ClassLoaders.java:188)\n    at java.base/java.lang.ClassLoader.loadClass(ClassLoader.java:525)\n    ... 6 more\n</code></pre>\n<p>Any guidance on how to resolve this class loading issue would be appreciated!</p>\n",
    "tags" : [ "java", "maven", "google-cloud-platform", "protocol-buffers", "hardware-security-module" ],
    "owner" : {
      "account_id" : 14853653,
      "reputation" : 451,
      "user_id" : 10726803,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/H3cwGSrO.jpg?s=256",
      "display_name" : "keemsisi",
      "link" : "https://stackoverflow.com/users/10726803/keemsisi"
    },
    "is_answered" : false,
    "view_count" : 131,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1748606825,
    "creation_date" : 1748606487,
    "link" : "https://stackoverflow.com/questions/79645423/google-cloud-ksm-error-exception-in-thread-main-java-lang-noclassdeffounderro",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140472756,
    "post_id" : 79645423,
    "body" : "Don&#39;t use <code>4.0.0-rc-2</code> (see <a href=\"https://github.com/protocolbuffers/protobuf/issues/8062#issuecomment-953288508\" rel=\"nofollow noreferrer\">comment</a>). Use either <a href=\"https://mvnrepository.com/artifact/com.google.protobuf/protobuf-java/4.31.1\" rel=\"nofollow noreferrer\">4.31.1</a> latest release or <a href=\"https://mvnrepository.com/artifact/com.google.protobuf/protobuf-java/3.25.8\" rel=\"nofollow noreferrer\">3.25.8</a> if you need a release prior to the abandoned 4.0.0",
    "score" : 1,
    "owner" : {
      "account_id" : 301516,
      "reputation" : 41692,
      "user_id" : 609290,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://i.sstatic.net/WUBht.jpg?s=256",
      "display_name" : "DazWilkin",
      "link" : "https://stackoverflow.com/users/609290/dazwilkin"
    },
    "creation_date" : 1748613874,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}