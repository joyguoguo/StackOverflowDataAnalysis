{
  "question" : {
    "question_id" : 79826409,
    "title" : "How to route messages from a single JMS producer to one of multiple MDBs based on conditions?",
    "body" : "<p>I have a JMS-based application setup where one application(3rd party component with no code level access, but configurable) acts as the only message producer. This producer sends messages to the broker (ActiveMQ Artemis), and I have multiple Message-Driven Beans (MDBs) that should consume these messages â€” but only one MDB should receive a given message, depending on some criteria (looking at a property of the message which the producer sent).</p>\n<p>My idea is to implement a custom ActiveMQ Artemis server plugin in <code>Java</code> to handle the routing logic.</p>\n<p>Producer always sends messages into a single parent queue (e.g., <code>ParentQ</code>). I have multiple MDB consumers, each listening on their own child queues (<code>ChildQ1</code>, <code>ChildQ2</code>, ...). The actual routing should happen inside the broker using <code>Artemis diverts</code> defined in the <code>broker.xml</code>.</p>\n<p>used <code>org.apache.activemq.artemis.core.server.plugin.ActiveMQServerPlugin</code> interface to write the plugin,</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic void beforeSend(ServerSession serverSession,\n                       Transaction transaction,\n                       Message message,\n                       boolean direct,\n                       boolean noAutoCreateQueue) throws ActiveMQException {\n\n    final String messageAddress =\n            (message.getAddressSimpleString() != null)\n                    ? message.getAddressSimpleString().toString()\n                    : &quot;&quot;;\n\n    logger.info(&quot;[RoutingPlugin] beforeSend: direct={} address={}&quot;, direct, messageAddress);\n\n    // Apply routing only for configured addresses\n    if (!monitoredAddresses.contains(messageAddress)) {\n        return;\n    }\n\n    // Skip if routing property is already set\n    if (message.containsProperty(destinationPropertyName)) {\n        return;\n    }\n\n    // Decode message body (UTF-16LE)\n    final String body = decodeBodyAsUtf16(message);\n    if (body.isEmpty()) {\n        logger.error(&quot;[RoutingPlugin] Message body is empty for msgId={}&quot;, message.getMessageID());\n        message.putStringProperty(&quot;ROUTING_ERROR&quot;, &quot;EMPTY_BODY&quot;);\n        return;\n    }\n\n    // Extract required metadata\n    final String sessionId   = extractSimpleField(body, &quot;SessionID&quot;);\n    final String msgType     = extractSimpleField(body, &quot;MessageType&quot;);\n    final String clientMsgId = extractSimpleField(body, &quot;ClientMsgID&quot;);\n    final String payload     = extractPayload(body);\n\n    // These logs reflect the real observed values during runtime\n    logger.info(&quot;[RoutingPlugin] Decoded from body: SessionID={}, MsgType={}, ClientMsgID={}&quot;,\n            sessionId, msgType, clientMsgId);\n\n    if (sessionId == null || payload == null) {\n        logger.error(&quot;[RoutingPlugin] DECODE_ERROR:SESSION_OR_PAYLOAD_MISSING for messageID={}&quot;,\n                message.getMessageID());\n        message.putStringProperty(&quot;ROUTING_ERROR&quot;, &quot;DECODE_ERROR:SESSION_OR_PAYLOAD_MISSING&quot;);\n        return;\n    }\n\n    // Parse business-level content\n    try {\n        ParsedMessage parsed = messageParser.parse(payload, sessionId);\n\n        String orderId = parsed.clientOrderId();\n        String type    = parsed.messageTypeCode();\n\n        // Determine routing target\n        String target = determineTarget(orderId, type, sessionId);\n\n        // Store routing indicator\n        message.putStringProperty(destinationPropertyName, target);\n        logger.info(&quot;[RoutingPlugin] Set {} = {}&quot;, destinationPropertyName, target);\n\n        // Optional message grouping\n        switch (groupByMode) {\n            case &quot;id&quot; -&gt; {\n                if (orderId != null) {\n                    message.putStringProperty(JMS_GROUP_PROPERTY, orderId);\n                }\n            }\n            case &quot;dest&quot; -&gt; message.putStringProperty(JMS_GROUP_PROPERTY, target);\n            default -&gt; { /* no grouping */ }\n        }\n\n    } catch (Exception ex) {\n        logger.error(&quot;[RoutingPlugin] Message parse failure for msgId={}&quot;, message.getMessageID(), ex);\n        message.putStringProperty(&quot;ROUTING_ERROR&quot;, &quot;PARSE_FAILURE&quot;);\n    }\n}\n</code></pre>\n<p>Supplementary methods:</p>\n<pre class=\"lang-java prettyprint-override\"><code>/** Reads the message body buffer using UTF-16LE encoding. */\nprivate static String decodeBodyAsUtf16(Message message) {\n    ActiveMQBuffer buffer = message.getBodyBuffer();\n    if (buffer.readableBytes() == 0) {\n        return &quot;&quot;;\n    }\n\n    byte[] bytes = new byte[buffer.readableBytes()];\n    buffer.getBytes(buffer.readerIndex(), bytes);\n    return new String(bytes, StandardCharsets.UTF_16LE);\n}\n\n/**\n * Extracts a simple ASCII field that appears in the format:\n *\n *   key &lt;control chars&gt; value &lt;control chars&gt;\n *\n * Control chars are trimmed. Used for fields like:\n *   SessionID\n *   MessageType\n *   ClientMsgID\n */\nprivate static String extractSimpleField(String text, String key) {\n    int idx = text.indexOf(key);\n    if (idx &lt; 0) return null;\n\n    int i = idx + key.length();\n    while (i &lt; text.length() &amp;&amp; text.charAt(i) &lt;= 0x20) i++;\n\n    int start = i;\n    while (i &lt; text.length() &amp;&amp; text.charAt(i) &gt; 0x20) i++;\n\n    return (start &lt; i) ? text.substring(start, i) : null;\n}\n\n/**\n * Extracts business payload following an STX (0x02) control character\n * that appears after the &quot;EventData&quot; marker.\n */\nprivate static String extractPayload(String text) {\n    int marker = text.indexOf(&quot;EventData&quot;);\n    if (marker &lt; 0) return null;\n\n    int stx = text.indexOf('\\u0002', marker);\n    if (stx &lt; 0 || stx + 1 &gt;= text.length()) return null;\n\n    int start = stx + 1;\n    int end = text.length();\n\n    while (end &gt; start &amp;&amp; text.charAt(end - 1) == '\\u0000') {\n        end--;\n    }\n\n    return text.substring(start, end);\n}\n\n/**\n * Determines routing target based on business identifiers.\n * Actual logic is environment-specific.\n */\nprivate String determineTarget(String orderId, String type, String sessionId) {\n\n    // Production-grade placeholder routing logic\n    if (orderId != null &amp;&amp; orderId.startsWith(&quot;A&quot;)) {\n        return &quot;DEST_A&quot;;\n    }\n\n    if (&quot;SESSION_X&quot;.equals(sessionId)) {\n        return &quot;DEST_B&quot;;\n    }\n\n    return &quot;DEST_DEFAULT&quot;;\n}\n</code></pre>\n<p>but my problem is, I could not parse the message properly, as below logs says, it fetchs null values;</p>\n<pre class=\"lang-bash prettyprint-override\"><code>[RoutingPlugin] beforeSend: direct=true address=FromSellSide\n[RoutingPlugin] Decoded from body: SessionID=null, MsgType=null, ClientMsgID=\n[RoutingPlugin] DECODE_ERROR:SESSION_OR_FIX_MISSING for messageID=0\n</code></pre>\n<p>How to properly parse those message body of <code>org.apache.activemq.artemis.api.core.Message</code>?</p>\n<p>example message appears in <code>ParentQ</code>:</p>\n<pre><code>bytes:\n01 00 00 00 08 00 00 00 12 53 00 65 00 73 00 73 00 69 00 6f 00 6e 00 49 00 44 00 0a 00 00 00 12 43 00 4f 00 4d 00 4d 00 4f 00 4e 00 45 00 58 00 45 00 00 00 00 12 45 00 76 00 65 00 6e 00 74 00 44 00 61 00 74 00 61 00 0a 00 00 02 4c 38 00 3d 00 46 00 49 00 58 00 2e 00 34 00 2e 00 32 00 01 00 39 00 3d 00 32 00 37 00 31 00 01 00 33 00 35 00 3d 00 44 00 01 00 33 00 34 00 3d 00 31 00 39 00 01 00 34 00 33 00 3d 00 59 00 01 00 34 00 39 00 3d 00 53 00 49 00 4d 00 55 00 4c 00 41 00 54 00 4f 00 52 00 01 00 35 00 30 00 3d 00 35 00 32 00 34 00 33 00 33 00 34 00 65 00 66 00 72 00 01 00 35 00 32 00 3d 00 32 00 30 00 32 00 35 00 31 00 31 00 32 00 31 00 2d 00 30 00 34 00 3a 00 32 00 33 00 3a 00 33 00 34 00 2e 00 32 00 35 00 36 00 01 00 35 00 36 00 3d 00 4f 00 4d 00 53 00 5f\n\ntext:\nSessionID\nCOMMONEXEEventData\nL8=FIX.4.29=27135=D34=1943=Y49=SIMULATOR50=524334efr52=20251121-04:23:34.25656=OMS_\n</code></pre>\n",
    "tags" : [ "java", "jms", "activemq-artemis" ],
    "owner" : {
      "account_id" : 24984725,
      "reputation" : 23,
      "user_id" : 18846655,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c84edcd0d71fe08eba0170beca384121?s=256&d=identicon&r=PG",
      "display_name" : "Pasindu",
      "link" : "https://stackoverflow.com/users/18846655/pasindu"
    },
    "is_answered" : false,
    "view_count" : 47,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1763958262,
    "creation_date" : 1763721744,
    "link" : "https://stackoverflow.com/questions/79826409/how-to-route-messages-from-a-single-jms-producer-to-one-of-multiple-mdbs-based-o",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140866310,
    "post_id" : 79826409,
    "body" : "Why don&#39;t you  use the <i>messageSelector</i> activationConfigProperty on your MDBs to listen only to the messages with the proper property value ?",
    "score" : 2,
    "owner" : {
      "account_id" : 1491171,
      "reputation" : 3617,
      "user_id" : 1398228,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gX5hy.png?s=256",
      "display_name" : "ehsavoie",
      "link" : "https://stackoverflow.com/users/1398228/ehsavoie"
    },
    "creation_date" : 1763733386,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140866062,
    "post_id" : 79826409,
    "body" : "Hi, thanks for the response, Can you give me some tips?",
    "score" : 0,
    "owner" : {
      "account_id" : 24984725,
      "reputation" : 23,
      "user_id" : 18846655,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c84edcd0d71fe08eba0170beca384121?s=256&d=identicon&r=PG",
      "display_name" : "Pasindu",
      "link" : "https://stackoverflow.com/users/18846655/pasindu"
    },
    "creation_date" : 1763723401,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140866040,
    "post_id" : 79826409,
    "body" : "Depending on what your control char is, I would say your <code>extractSimpleField</code> is wrong.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763722575,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}