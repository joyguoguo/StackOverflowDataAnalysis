{
  "question" : {
    "question_id" : 79650937,
    "title" : "How to remove @（Implicit intersection operator） while writing Excel formula by Java poi",
    "body" : "<p>Many <code>@</code> symbols will be generated in the formula, causing errors in the formula and failure to calculate normally.</p>\n<pre class=\"lang-java prettyprint-override\"><code>String formula = getDosFormula(row, column, ctx.getFlatDynamicHeaderList());\n    \nwriteCell(excelWriter, column, row, new FormulaCellValue(formula), headCellStyle);\n\npublic static String getDosFormula(int row, int column, List&lt;String&gt; flatDynamicHeaderList) {\n        \n        String[] sRefs = new String[13];\n        String[] daysRefs = new String[13];\n       \n        int addJumpMonthLength = 0;\n        for (int i = 0; i &lt; 13; i++) {\n           \n            int sCol = column + 1 + 2 + i * 5 + addJumpMonthLength;\n            int daysCol = column + 1 + 5 + i * 5 + addJumpMonthLength;\n            if (flatDynamicHeaderList.get(sCol).contains(PsiMajorApplianceHeaderEnum.DEMAND_S.getName())) {\n                addJumpMonthLength += 5;\n                sCol = sCol + 5;\n                daysCol = daysCol + 5;\n            }\n\n            sRefs[i] = getExcelCol(sCol) + (row + 1);\n            daysRefs[i] = getExcelCol(daysCol) + (row + 1);\n        }\n\n      \n        String sList = &quot;CHOOSE({1,2,3,4,5,6,7,8,9,10,11,12,13},&quot; + String.join(&quot;,&quot;, sRefs) + &quot;)&quot;;\n        String daysList = &quot;CHOOSE({1,2,3,4,5,6,7,8,9,10,11,12,13},&quot; + String.join(&quot;,&quot;, daysRefs) + &quot;)&quot;;\n        String sumS = &quot;SUM(&quot; + String.join(&quot;,&quot;, sRefs) + &quot;)&quot;;\n        String sumDays = &quot;SUM(&quot; + String.join(&quot;,&quot;, daysRefs) + &quot;)&quot;;\n        String curCell = getExcelCol(column - 1) + (row + 1);\n        int numberOfWeeks = sRefs.length;\n\n        String letFormula = String.format(\n                &quot;LET(&quot; +\n                        &quot;s_list,%s,&quot; +\n                        &quot;days_list,%s,&quot; +\n                        &quot;cumulative_S,SCAN(0,s_list,LAMBDA(a,v,a+v)),&quot; +\n                        &quot;total_days,SUM(days_list),&quot; + \n                      \n                        &quot;break_week_idx,IFERROR(MATCH(TRUE, cumulative_S &gt;= %s, 0), %d),&quot; + \n\n                      \n                        &quot;IF(break_week_idx &gt; %d,&quot; + \n                        &quot;ROUNDUP(total_days,0),&quot; +\n                      \n                        &quot;LET(&quot; +\n                     \n                        &quot;days_before_break, IF(break_week_idx = 1, 0, SUM(INDEX(days_list, SEQUENCE(break_week_idx - 1)))),&quot; +\n\n                     \n                        &quot;inv_start_of_break_week, %s - IF(break_week_idx &gt; 1, INDEX(cumulative_S, break_week_idx - 1), 0),&quot; + // %s 是 initialInvRef\n\n                    \n                        &quot;sales_in_break_week, INDEX(s_list, break_week_idx),&quot; +\n                        &quot;days_in_break_week, INDEX(days_list, break_week_idx),&quot; +\n\n                     \n                        &quot;partial_days_in_break, IFERROR(IF(sales_in_break_week = 0, 0, inv_start_of_break_week / sales_in_break_week * days_in_break_week), 0),&quot; +\n\n                      \n                        &quot;ROUNDUP(days_before_break + partial_days_in_break,0)&quot; +\n                        &quot;)&quot; +\n                        &quot;)&quot; +\n                        &quot;)&quot;,\n                sList, daysList, curCell, numberOfWeeks + 1, numberOfWeeks, curCell\n        );\n\n        String formula = String.format(\n                &quot;IF(%s &gt; %s,ROUNDUP(%s/(%s/%s),0),%s)&quot;,\n                curCell, sumS, curCell, sumS, sumDays, letFormula\n        );\n\n        return &quot;=&quot; + formula;\n    }\n</code></pre>\n<p><strong>final formula:</strong></p>\n<pre><code>=@IF(BA4 &gt; SUM(BE4,BJ4,BO4,BY4,CD4,CI4,CN4,CS4,DC4,DH4,DM4,DR4,DW4),ROUNDUP(BA4/(SUM(BE4,BJ4,BO4,BY4,CD4,CI4,CN4,CS4,DC4,DH4,DM4,DR4,DW4)/SUM(BH4,BM4,BR4,CB4,CG4,CL4,CQ4,CV4,DF4,DK4,DP4,DU4,DZ4)),0),LET(s_list,CHOOSE({1,2,3,4,5,6,7,8,9,10,11,12,13},BE4,BJ4,BO4,BY4,CD4,CI4,CN4,CS4,DC4,DH4,DM4,DR4,DW4),days_list,CHOOSE({1,2,3,4,5,6,7,8,9,10,11,12,13},BH4,BM4,BR4,CB4,CG4,CL4,CQ4,CV4,DF4,DK4,DP4,DU4,DZ4),cumulative_S,SCAN(0,s_list,LAMBDA(a,v,@a+@v)),total_days,SUM(days_list),break_week_idx,IFERROR(MATCH(TRUE,@ cumulative_S &gt;= BA4, 0), 14),IF(@break_week_idx &gt; 13,ROUNDUP(@total_days,0),LET(days_before_break, IF(@break_week_idx = 1, 0, SUM(INDEX(days_list,@ SEQUENCE(@break_week_idx - 1)))),inv_start_of_break_week, BA4 -@ IF(@break_week_idx &gt; 1, INDEX(cumulative_S,@ break_week_idx - 1), 0),sales_in_break_week, INDEX(s_list,@ break_week_idx),days_in_break_week, INDEX(days_list,@ break_week_idx),partial_days_in_break, IFERROR(IF(@sales_in_break_week = 0, 0,@ inv_start_of_break_week /@ sales_in_break_week *@ days_in_break_week), 0),ROUNDUP(@days_before_break +@ partial_days_in_break,0)))))\n</code></pre>\n<p>I wonder why some single items ​​are also added with @ symbol(Implicit intersection operator)</p>\n<p>Is it because the formula is too complicated that causes excel to parse incorrectly?</p>\n",
    "tags" : [ "java", "excel", "apache-poi" ],
    "owner" : {
      "account_id" : 16296270,
      "reputation" : 1,
      "user_id" : 11768431,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-sET4w7cPGiQ/AAAAAAAAAAI/AAAAAAAAAAg/oW0LenQA4DE/s256-rj/photo.jpg",
      "display_name" : "dodot jam",
      "link" : "https://stackoverflow.com/users/11768431/dodot-jam"
    },
    "is_answered" : false,
    "view_count" : 104,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1748941583,
    "creation_date" : 1748941583,
    "link" : "https://stackoverflow.com/questions/79650937/how-to-remove-implicit-intersection-operator-while-writing-excel-formula-by-j",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140485598,
    "post_id" : 79650937,
    "body" : "You are not programming in VBA, but in a language unknown to me. You must look at the documentation of that language/the Excel bibrary you are using.",
    "score" : 0,
    "owner" : {
      "account_id" : 7642490,
      "reputation" : 3059,
      "user_id" : 5794172,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/60c23e257dc881d0f7c10ae459b3ef87?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jkpieterse",
      "link" : "https://stackoverflow.com/users/5794172/jkpieterse"
    },
    "creation_date" : 1749020876,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140485581,
    "post_id" : 79650937,
    "body" : "@jkpieterse  How do I use Range.Formula2? Is there any corresponding example?",
    "score" : 0,
    "owner" : {
      "account_id" : 16296270,
      "reputation" : 1,
      "user_id" : 11768431,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-sET4w7cPGiQ/AAAAAAAAAAI/AAAAAAAAAAg/oW0LenQA4DE/s256-rj/photo.jpg",
      "display_name" : "dodot jam",
      "link" : "https://stackoverflow.com/users/11768431/dodot-jam"
    },
    "creation_date" : 1749020423,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140483270,
    "post_id" : 79650937,
    "body" : "In VBA there are two properties to read/write formulas: Range.Formula and Range.Formula2. You would need the latter in VBA if you do not want the @ characters in the formula. Check your Excel library to see if there is such a different property or method, or if it has an argument related to implicit intersection (which is what the @ denotes).",
    "score" : 0,
    "owner" : {
      "account_id" : 7642490,
      "reputation" : 3059,
      "user_id" : 5794172,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/60c23e257dc881d0f7c10ae459b3ef87?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jkpieterse",
      "link" : "https://stackoverflow.com/users/5794172/jkpieterse"
    },
    "creation_date" : 1748953756,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140483088,
    "post_id" : 79650937,
    "body" : "There is no @ symbol when generating a formula. It only appears when opening it with Excel. The @ symbol is also different when opening it with different tools (WPS or Excel)",
    "score" : 0,
    "owner" : {
      "account_id" : 16296270,
      "reputation" : 1,
      "user_id" : 11768431,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-sET4w7cPGiQ/AAAAAAAAAAI/AAAAAAAAAAg/oW0LenQA4DE/s256-rj/photo.jpg",
      "display_name" : "dodot jam",
      "link" : "https://stackoverflow.com/users/11768431/dodot-jam"
    },
    "creation_date" : 1748950405,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}