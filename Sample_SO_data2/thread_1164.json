{
  "question" : {
    "question_id" : 79740361,
    "title" : "DOCX file generated by JAX-RS API shows compatibility error in Word",
    "body" : "<p>I am generating a .docx file in a JAX-RS API.\nWhen I save it directly to disk like this:</p>\n<pre><code>try (FileOutputStream fos = new FileOutputStream(&quot;localSavedFile.docx&quot;)) {\noutputDocument(fos);\n</code></pre>\n<p>}</p>\n<p>the file opens fine in MS Word.</p>\n<p>But when I try to return it from the API using StreamingOutput:</p>\n<pre><code>StreamingOutput stream = output -&gt; {\ntry {\n    outputDocument(output);\n} catch (Exception e) {\n    throw new RuntimeException(e);\n}\n};\n\nreturn Response.ok(stream)\n        .header(&quot;Content-Disposition&quot;, &quot;attachment; filename=\\&quot;file.docx\\&quot;&quot;)\n        .type(&quot;application/vnd.openxmlformats-officedocument.wordprocessingml.document&quot;)\n        .build();\n</code></pre>\n<p>Word shows a compatibility error (something like “The file is corrupt or cannot be opened properly”) when opening the downloaded file.</p>\n<p>How I generate the DOCX</p>\n<pre><code>public void outputDocument(final OutputStream outputStream) throws Exception {             \nWordprocessingMLPackage wordPackage = WordprocessingMLPackage.createPackage();\nMainDocumentPart mainDocumentPart = wordPackage.getMainDocumentPart();\n\n\n//other code where docx is generated\n\n// finally write the package to the provided stream\nwordPackage.save(outputStream);\n</code></pre>\n<p>}</p>\n<p>What I’ve tried:</p>\n<p>Saving with FileOutputStream works fine (so the document itself is valid).</p>\n<p>Setting explicit Content-Type and Content-Disposition.</p>\n<p>Adding Content-Length.</p>\n<p>Why does the same document open fine when written to a local file, but shows a compatibility error when streamed in a JAX-RS response?\nDo I need to flush/close the stream differently, or are there extra headers required for Office files?</p>\n",
    "tags" : [ "java", "jax-rs", "docx" ],
    "owner" : {
      "account_id" : 39241929,
      "reputation" : 21,
      "user_id" : 29177314,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1d09c5596d3d7891019fa8453a744b8d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Gopika Ravikumar",
      "link" : "https://stackoverflow.com/users/29177314/gopika-ravikumar"
    },
    "is_answered" : false,
    "view_count" : 78,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1755735935,
    "creation_date" : 1755633972,
    "link" : "https://stackoverflow.com/questions/79740361/docx-file-generated-by-jax-rs-api-shows-compatibility-error-in-word",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79741718,
    "question_id" : 79740361,
    "body" : "<p>You've said in the comments that</p>\n<blockquote>\n<p>I could see some extra bytes added in the corrupted file.</p>\n</blockquote>\n<p>... well there's your problem, rather than &quot;flushing/closing&quot;.</p>\n<p>What extra bytes? I wonder if it is the &quot;Byte Order Mark&quot;.  Read about it here <a href=\"https://stackoverflow.com/a/48749396/1847378\">https://stackoverflow.com/a/48749396/1847378</a> - this article is about how to overcome a file/input stream with a BOM that you don't want.  That's the opposite problem, though.</p>\n<p>Maybe the use of <code>stream</code> is unhelpfully messing around with the stream.  Just for a test at least, how about passing <code>ByteArrayOutputStream()</code> to the the <code>outputDocument(..)</code> and then passing <code>byte[]</code> (from <code>ByteArrayOutputStream.toByteArray()</code>) to the JAX RS <code>Response</code> ?</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2073393,
      "reputation" : 3675,
      "user_id" : 1847378,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8990d3c34829910b2318ed16b09544d?s=256&d=identicon&r=PG",
      "display_name" : "AndrewL",
      "link" : "https://stackoverflow.com/users/1847378/andrewl"
    },
    "creation_date" : 1755735935,
    "last_activity_date" : 1755735935,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140681148,
    "post_id" : 79740361,
    "body" : "The doc generation is certainly correct. Here probably also other code adds to the response&#39;s front or back. Best debugable by sending a plain text file of the same size, so you can see the spurious bytes sent.",
    "score" : 1,
    "owner" : {
      "account_id" : 960307,
      "reputation" : 110397,
      "user_id" : 984823,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Z2KYN.jpg?s=256",
      "display_name" : "Joop Eggen",
      "link" : "https://stackoverflow.com/users/984823/joop-eggen"
    },
    "creation_date" : 1755759228,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140679075,
    "post_id" : 79740361,
    "body" : "Which Jakarta REST implementation are you using?",
    "score" : 0,
    "owner" : {
      "account_id" : 51161,
      "reputation" : 17960,
      "user_id" : 152794,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/eX5Ms.jpg?s=256",
      "display_name" : "James R. Perkins",
      "link" : "https://stackoverflow.com/users/152794/james-r-perkins"
    },
    "creation_date" : 1755693786,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140678474,
    "post_id" : 79740361,
    "body" : "I could see some extra bytes added in the corrupted file. Not sure how to fix it tho.",
    "score" : 0,
    "owner" : {
      "account_id" : 39241929,
      "reputation" : 21,
      "user_id" : 29177314,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1d09c5596d3d7891019fa8453a744b8d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Gopika Ravikumar",
      "link" : "https://stackoverflow.com/users/29177314/gopika-ravikumar"
    },
    "creation_date" : 1755676670,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140677880,
    "post_id" : 79740361,
    "body" : "Did you try saving the JAX-RS to a file and then comparing the first ~10 bytes of that with the direct file method? My guess is that you&#39;ll spot quickly what is the problem from that.  <a href=\"https://en.wikipedia.org/wiki/List_of_file_signatures\" rel=\"nofollow noreferrer\">en.wikipedia.org/wiki/List_of_file_signatures</a> will tell show you what the first bytes of a valid docx should be.  Also docx is really just a zip file, so try unzipping it.",
    "score" : 1,
    "owner" : {
      "account_id" : 2073393,
      "reputation" : 3675,
      "user_id" : 1847378,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8990d3c34829910b2318ed16b09544d?s=256&d=identicon&r=PG",
      "display_name" : "AndrewL",
      "link" : "https://stackoverflow.com/users/1847378/andrewl"
    },
    "creation_date" : 1755651245,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79741718" : [ {
      "comment_id" : 140686444,
      "post_id" : 79741718,
      "body" : "Could also be &quot;random&quot; garbage bytes added because of a miscomputation of buffer size / length / something.",
      "score" : 0,
      "owner" : {
        "account_id" : 47283,
        "reputation" : 723470,
        "user_id" : 139985,
        "user_type" : "registered",
        "accept_rate" : 69,
        "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
        "display_name" : "Stephen C",
        "link" : "https://stackoverflow.com/users/139985/stephen-c"
      },
      "creation_date" : 1755934527,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}