{
  "question" : {
    "question_id" : 79638287,
    "title" : "Query regarding ML-KEM support with Bouncy Castle 1.80 in Maven Spring Boot Application",
    "body" : "<p>I have a query regarding the use of the Bouncy Castle library for post-quantum cryptography (PQC) in my Spring Boot application. I am using Java version 21, Bouncy Castle version 1.80, which supports ML-KEM, and I have included the corresponding bctls version 1.80 in my Maven dependencies. I can confirm that the JAR file includes classes related to ML-KEM.</p>\n<p>For configuration, I have added the following to my application:</p>\n<p><strong>pom.xml</strong></p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;properties&gt;\n    &lt;java.version&gt;21&lt;/java.version&gt;\n&lt;/properties&gt;\n&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-devtools&lt;/artifactId&gt;\n        &lt;scope&gt;runtime&lt;/scope&gt;\n        &lt;optional&gt;true&lt;/optional&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n        &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n        &lt;optional&gt;true&lt;/optional&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n        &lt;scope&gt;test&lt;/scope&gt;\n    &lt;/dependency&gt;\n\n    &lt;!-- https://mvnrepository.com/artifact/org.bouncycastle/bcprov-jdk18on --&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;\n        &lt;artifactId&gt;bcprov-jdk18on&lt;/artifactId&gt;\n        &lt;version&gt;1.80&lt;/version&gt;\n    &lt;/dependency&gt;\n\n    &lt;!-- Below is Bouncy Castle JSSE provider       --&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt;\n        &lt;artifactId&gt;bctls-jdk18on&lt;/artifactId&gt;\n        &lt;version&gt;1.80&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;!-- https://mvnrepository.com/artifact/org.apache.tomcat/tomcat-catalina --&gt;\n&lt;!--        &lt;dependency&gt;--&gt;\n&lt;!--            &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt;--&gt;\n&lt;!--            &lt;artifactId&gt;tomcat-catalina&lt;/artifactId&gt;--&gt;\n&lt;!--            &lt;version&gt;11.0.6&lt;/version&gt;--&gt;\n&lt;!--        &lt;/dependency&gt;--&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.conscrypt&lt;/groupId&gt;\n        &lt;artifactId&gt;conscrypt-openjdk-uber&lt;/artifactId&gt;\n        &lt;version&gt;2.5.2&lt;/version&gt;\n    &lt;/dependency&gt;\n&lt;/dependencies&gt;\n\n&lt;build&gt;\n    &lt;plugins&gt;\n        &lt;plugin&gt;\n            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n            &lt;configuration&gt;\n                &lt;annotationProcessorPaths&gt;\n                    &lt;path&gt;\n                        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n                        &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n                    &lt;/path&gt;\n                &lt;/annotationProcessorPaths&gt;\n            &lt;/configuration&gt;\n        &lt;/plugin&gt;\n        &lt;plugin&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;configuration&gt;\n                &lt;excludes&gt;\n                    &lt;exclude&gt;\n                        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n                        &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n                    &lt;/exclude&gt;\n                &lt;/excludes&gt;\n            &lt;/configuration&gt;\n        &lt;/plugin&gt;\n    &lt;/plugins&gt;\n&lt;/build&gt;\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\n@RequiredArgsConstructor\npublic class CustomTlsConfig {\n\n    @PostConstruct\n    public void init() {\n        // Register the Bouncy Castle JSSE provider\n        changeDefaultJSSEProvider();\n    }\n\n    private static void changeDefaultJSSEProvider() {\n        Security.insertProviderAt(new BouncyCastleProvider(), 1);\n        Security.insertProviderAt(new BouncyCastleJsseProvider(), 2);\n        SSLContext context = null;\n        try {\n            context = SSLContext.getDefault();\n        } catch (NoSuchAlgorithmException e) {\n            throw new RuntimeException(e);\n        }\n        System.out.println(&quot;SSLContext provider: &quot; + context.getProvider().getName());\n    }\n}\n</code></pre>\n<p>Additionally, I have set the SSL properties in my <code>application.properties</code> as follows:</p>\n<pre class=\"lang-ini prettyprint-override\"><code>server.ssl.enabled=true\nserver.ssl.key-store-type=PKCS12\nserver.ssl.key-store=path-to-my-keystore\nserver.ssl.key-alias=some-alias\nserver.ssl.key-store-password=some-pwd\n</code></pre>\n<p>My Spring Boot application starts successfully.</p>\n<p>When I connect to the server using OpenSSL 3.5 (which supports PQC) with the command:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>openssl s_client -connect localhost:8081 -groups X25519\n</code></pre>\n<p>It works perfectly, but when I attempt to use the ML-KEM group with the command:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>openssl s_client -connect localhost:8081 -groups mlkem768\n</code></pre>\n<p>The connection fails. See the below error logs from my Spring Boot app:</p>\n<pre class=\"lang-none prettyprint-override\"><code>javax.net.ssl|ERROR|03|reactor-http-epoll-3|2025-05-26 10:30:49.541 SGT|TransportContext.java:375|Fatal (UNEXPECTED_MESSAGE): Unexpected key_share extension in HelloRetryRequest (\n&quot;throwable&quot; : {\n  javax.net.ssl.SSLProtocolException: Unexpected key_share extension in HelloRetryRequest\n    at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:128)\n    at java.base/sun.security.ssl.Alert.createSSLException(Alert.java:117)\n    at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:370)\n    at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:326)\n    at java.base/sun.security.ssl.TransportContext.fatal(TransportContext.java:317)\n    at java.base/sun.security.ssl.KeyShareExtension$HRRKeyShareProducer.produce(KeyShareExtension.java:796)\n    at java.base/sun.security.ssl.SSLExtension.produce(SSLExtension.java:599)\n    at java.base/sun.security.ssl.SSLExtensions.produce(SSLExtensions.java:265)\n    at java.base/sun.security.ssl.ServerHello$T13HelloRetryRequestProducer.produce(ServerHello.java:787)\n    at java.base/sun.security.ssl.SSLHandshake.produce(SSLHandshake.java:437)\n    at java.base/sun.security.ssl.ClientHello$T13ClientHelloConsumer.goHelloRetryRequest(ClientHello.java:1189)\n    at java.base/sun.security.ssl.ClientHello$T13ClientHelloConsumer.consume(ClientHello.java:1177)\n    at java.base/sun.security.ssl.ClientHello$ClientHelloConsumer.onClientHello(ClientHello.java:837)\n    at java.base/sun.security.ssl.ClientHello$ClientHelloConsumer.consume(ClientHello.java:798)\n    at java.base/sun.security.ssl.SSLHandshake.consume(SSLHandshake.java:393)\n    at java.base/sun.security.ssl.HandshakeContext.dispatch(HandshakeContext.java:476)\n    at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1273)\n    at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask$DelegatedAction.run(SSLEngineImpl.java:1260)\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:714)\n    at java.base/sun.security.ssl.SSLEngineImpl$DelegatedTask.run(SSLEngineImpl.java:1205)\n    at io.netty.handler.ssl.SslHandler.runDelegatedTasks(SslHandler.java:1695)\n    at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1541)\n    at io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1377)\n    at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1428)\n    at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:530)\n    at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n    at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n    at io.netty.handler.codec.ByteToMessageDecoder.handlerRemoved(ByteToMessageDecoder.java:266)\n    at io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:537)\n    at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:469)\n    at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:290)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412)\n    at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1357)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440)\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420)\n    at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:868)\n    at io.netty.channel.epoll.AbstractEpollStreamChannel$EpollStreamUnsafe.epollInReady(AbstractEpollStreamChannel.java:799)\n    at io.netty.channel.epoll.EpollEventLoop.processReady(EpollEventLoop.java:501)\n    at io.netty.channel.epoll.EpollEventLoop.run(EpollEventLoop.java:399)\n    at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:998)\n    at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74)\n    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n    at java.base/java.lang.Thread.run(Thread.java:1583)}\n\n)\n</code></pre>\n<p>Based on the logs, I can see that the sun.security.ssl library is being used. However, when I executed the following code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>SSLContext context = null;\ntry {\n    context = SSLContext.getDefault();\n} catch (NoSuchAlgorithmException e) {\n    throw new RuntimeException(e);\n}\nSystem.out.println(&quot;SSLContext provider: &quot; + context.getProvider().getName());\n</code></pre>\n<p>It prints BCJSSE as the provider.</p>\n<p>I would like to know if there are any additional configuration properties or setup steps required to ensure Bouncy Castle TLS uses ML-KEM for key exchange in my Spring Boot application. How can I enable ML-KEM support?</p>\n",
    "tags" : [ "java", "spring-boot", "ssl", "bouncycastle" ],
    "owner" : {
      "account_id" : 13786235,
      "reputation" : 51,
      "user_id" : 9950061,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-F-E6Be-VKjk/AAAAAAAAAAI/AAAAAAAAAF8/ZgcILffn10o/s256-rj/photo.jpg",
      "display_name" : "harish balaji",
      "link" : "https://stackoverflow.com/users/9950061/harish-balaji"
    },
    "is_answered" : true,
    "view_count" : 295,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1752600734,
    "creation_date" : 1748231754,
    "link" : "https://stackoverflow.com/questions/79638287/query-regarding-ml-kem-support-with-bouncy-castle-1-80-in-maven-spring-boot-appl",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79702467,
    "question_id" : 79638287,
    "body" : "<p>I believe the issue you're seeing is an interoperability issue caused by differing codepoints. I've ran into something similar trying to connect an OpenSSL 3.5 client to a BCJSSE 1.80 server.</p>\n<p>More specifically, Bouncy Castle 1.80 implements draft-connolly-tls-mlkem-key-agreement-03. The codepoint for specifying ML-KEM-768 in this draft is 0x0768.</p>\n<p>On the other hand, OpenSSL 3.5 implements the updated draft-connolly-tls-mlkem-key-agreement-05, which has been replaced by draft-ietf-tls-mlkem. The codepoint for ML-KEM-768 for these drafts is 0x0201. You should be able to validate this with a packet capture.</p>\n<p>According to Bouncy Castle release notes, 1.81 should implement the appropriate draft. Upgrading to 1.81 should let your application interoperate with OpenSSL.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43049240,
      "reputation" : 11,
      "user_id" : 31048704,
      "user_type" : "unregistered",
      "profile_image" : "https://www.gravatar.com/avatar/3bcc9e35957d53f2b3cf0587473a986a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user31048704",
      "link" : "https://stackoverflow.com/users/31048704/user31048704"
    },
    "creation_date" : 1752600734,
    "last_activity_date" : 1752600734,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}