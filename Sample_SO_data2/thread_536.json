{
  "question" : {
    "question_id" : 79799789,
    "title" : "Migrate Elasticsearch Builder classes to latest Java API 9.x",
    "body" : "<p>I have this elasticsearch Java code to connect and get data:</p>\n<p>Gradle dependencies:</p>\n<pre class=\"lang-none prettyprint-override\"><code>    implementation 'org.elasticsearch:elasticsearch:5.6.16'\n    implementation 'org.elasticsearch.client:transport:5.6.16'\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>    import org.elasticsearch.ElasticsearchException;\n    import org.elasticsearch.action.ActionListener;\n    import org.elasticsearch.action.DocWriteResponse.Result;\n    import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n    import org.elasticsearch.action.admin.indices.create.CreateIndexResponse;\n    import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\n    import org.elasticsearch.action.bulk.BackoffPolicy;\n    import org.elasticsearch.action.bulk.BulkItemResponse;\n    import org.elasticsearch.action.bulk.BulkRequestBuilder;\n    import org.elasticsearch.action.bulk.BulkResponse;\n    import org.elasticsearch.action.bulk.Retry;\n    import org.elasticsearch.action.delete.DeleteResponse;\n    import org.elasticsearch.action.get.GetResponse;\n    import org.elasticsearch.action.get.MultiGetItemResponse;\n    import org.elasticsearch.action.get.MultiGetRequestBuilder;\n    import org.elasticsearch.action.get.MultiGetResponse;\n    import org.elasticsearch.action.index.IndexRequest;\n    import org.elasticsearch.action.index.IndexRequestBuilder;\n    import org.elasticsearch.action.index.IndexResponse;\n    import org.elasticsearch.action.search.ClearScrollRequest;\n    import org.elasticsearch.action.search.ClearScrollResponse;\n    import org.elasticsearch.action.search.MultiSearchRequestBuilder;\n    import org.elasticsearch.action.search.MultiSearchResponse;\n    import org.elasticsearch.action.search.SearchRequestBuilder;\n    import org.elasticsearch.action.search.SearchResponse;\n    import org.elasticsearch.action.search.SearchScrollRequestBuilder;\n    import org.elasticsearch.action.support.master.AcknowledgedResponse;\n    import org.elasticsearch.action.update.UpdateRequest;\n    import org.elasticsearch.action.update.UpdateResponse;\n    import org.elasticsearch.client.transport.TransportClient;\n    import org.elasticsearch.common.settings.Settings;\n    import org.elasticsearch.common.transport.InetSocketTransportAddress;\n    import org.elasticsearch.common.unit.TimeValue;\n    import org.elasticsearch.index.engine.DocumentMissingException;\n    import org.elasticsearch.index.reindex.BulkByScrollResponse;\n    import org.elasticsearch.index.reindex.DeleteByQueryAction;\n    import org.elasticsearch.index.reindex.DeleteByQueryRequestBuilder;\n    import org.elasticsearch.script.mustache.SearchTemplateRequestBuilder;\n    import org.elasticsearch.transport.client.PreBuiltTransportClient;\n    \n    \n    public class ESRepository {\n        \n      private TransportClient client;\n    \n     //.. java method to initialize client connection object\n    \n    \n      protected SearchRequestBuilder getSearchRequestBuilder() {\n        try {\n          return client.prepareSearch();\n        } catch (Exception exception) {\n          throw Exception();\n        }\n      }\n    \n    \n      public SearchResponse search(SearchRequestBuilder builder) {\n        try {\n          return builder.get();\n        } catch (Exception exception) {\n          throw Exception();\n        }\n      }\n    \n      public SearchScrollRequestBuilder getSearchScrollRequestBuilder(String scrollId) {\n        try {\n          return client.prepareSearchScroll(scrollId);\n        } catch (Exception exception) {\n          throw Exception();\n        }\n      }\n    \n      public SearchResponse searchScroll(SearchScrollRequestBuilder builder) {\n        try {\n          return builder.get();\n        } catch (Exception exception) {\n          throw Exception();\n        }\n      }\n    }\n</code></pre>\n<hr />\n<pre class=\"lang-java prettyprint-override\"><code>    import org.elasticsearch.action.search.SearchRequest;\n    import org.elasticsearch.action.search.SearchRequestBuilder;\n    import org.elasticsearch.action.search.SearchResponse;\n    import org.elasticsearch.index.query.BoolQueryBuilder;\n    import org.elasticsearch.script.ScriptType;\n    import org.elasticsearch.script.mustache.SearchTemplateRequestBuilder;\n    import org.elasticsearch.script.mustache.SearchTemplateResponse;\n    import org.elasticsearch.search.aggregations.AggregationBuilders;\n    import org.elasticsearch.search.aggregations.bucket.nested.NestedAggregationBuilder;\n    import org.elasticsearch.search.sort.SortBuilder;\n    \n    public class Search extends ESRepository {\n    \n    \n    \n    public SearchResponse searchScript(Map&lt;String, Object&gt; parameters, String scriptName) {\n        SearchTemplateRequestBuilder searchTemplateRequestBuilder = getSearchTemplateRequestBuilder();\n        SearchTemplateResponse response = searchTemplateRequestBuilder.setScript(scriptName)\n            .setScriptType(ScriptType.STORED).setScriptParams(parameters)\n                            .setRequest(new SearchRequest(this.readIndex)).get();\n        return response.getResponse();\n      }\n    }\n    \n    \n    Map&lt;String, Object&gt; parameters = new HashMap&lt;&gt;();\n        parameters.put(&quot;offset&quot;, offset);\n        parameters.put(&quot;limit&quot;, limit);\n        parameters.put(&quot;users&quot;, searchQuery);\n    \n    SearchResponse response = ESRepository.searchScript(parameters, &quot;search_template&quot;);\n</code></pre>\n<p>For latest version:</p>\n<pre class=\"lang-none prettyprint-override\"><code>    implementation 'co.elastic.clients:elasticsearch-java:9.2.0'\n        implementation 'org.elasticsearch.client:elasticsearch-rest-client:9.2.0'\n</code></pre>\n<p>I can't find a replacement for above builder classes. Do you know how I can migrate the code and keep the same structure/logic if possible?</p>\n",
    "tags" : [ "java", "elasticsearch", "elasticsearch-5" ],
    "owner" : {
      "account_id" : 965625,
      "reputation" : 940,
      "user_id" : 1103606,
      "user_type" : "registered",
      "accept_rate" : 51,
      "profile_image" : "https://www.gravatar.com/avatar/0d93cc650b93939ea91066fcb5aefae0?s=256&d=identicon&r=PG",
      "display_name" : "Peter Penzov",
      "link" : "https://stackoverflow.com/users/1103606/peter-penzov"
    },
    "is_answered" : true,
    "view_count" : 274,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1762184619,
    "creation_date" : 1761434616,
    "link" : "https://stackoverflow.com/questions/79799789/migrate-elasticsearch-builder-classes-to-latest-java-api-9-x",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79808033,
    "question_id" : 79799789,
    "body" : "<p>Builder classes like TransportClient, SearchRequestBuilder, and SearchScrollRequestBuilder are deprecated and replaced with new APIs in the latest client versions. It's recommended to use ElasticSearchClient (from co.elastic.clients:elasticsearch-java) and build requests with POJOs rather than chaining builder classesâ€‹</p>\n<p><strong>Initialization and Connection</strong></p>\n<p>TransportClient/PreBuiltTransportClient have been replaced with RestClient/ElasticsearchClient which is initialized by:</p>\n<pre class=\"lang-java prettyprint-override\"><code>RestClient restClient = RestClient.builder(new HttpHost(&quot;localhost&quot;, 9200)).build();\nElasticsearchTransport transport = new RestClientTransport(restClient, new JacksonJsonpMapper());\nElasticsearchClient client = new ElasticsearchClient(transport);\n</code></pre>\n<p><strong>Search Operations</strong></p>\n<p>Instead of builder chaining, construct request objects:</p>\n<pre class=\"lang-java prettyprint-override\"><code>SearchRequest searchRequest = new SearchRequest.Builder()\n    .index(&quot;your_index&quot;)\n    .query(q -&gt; q\n        .match(m -&gt; m.field(&quot;your_field&quot;).query(&quot;your_query&quot;))\n    )\n    .from(offset)\n    .size(limit)\n    .build();\n\nSearchResponse&lt;MyDocument&gt; response = client.search(searchRequest, MyDocument.class);\n</code></pre>\n<p>You work with SearchRequest.Builder and supply query/aggregation parameters directly.</p>\n<p><strong>Scroll/Search After</strong></p>\n<p>For pagination, scrolls are discouraged (the API shifted to search-after). If you need scroll:</p>\n<pre class=\"lang-java prettyprint-override\"><code>ScrollRequest scrollRequest = new ScrollRequest.Builder()\n    .scroll(&quot;1m&quot;)\n    .scrollId(previousScrollId)\n    .build();\nSearchResponse&lt;MyDocument&gt; scrollResponse = client.scroll(scrollRequest, MyDocument.class);\n</code></pre>\n<p><strong>Stored Scripts / Templates</strong></p>\n<p>Replace SearchTemplateRequestBuilder with SearchTemplateRequest:</p>\n<pre class=\"lang-java prettyprint-override\"><code>SearchTemplateRequest searchTemplateRequest = new SearchTemplateRequest.Builder()\n    .index(&quot;your_index&quot;)\n    .source(&quot;{ \\&quot;query\\&quot;: { \\&quot;match\\&quot;: { \\&quot;your_field\\&quot;: \\&quot;{{your_variable}}\\&quot; } } }&quot;)\n    .params(Map.of(&quot;your_variable&quot;, value))\n    .build();\n\nSearchTemplateResponse&lt;MyDocument&gt; response = client.searchTemplate(searchTemplateRequest, MyDocument.class);\n</code></pre>\n<p>Note: For stored scripts, adjust using id() instead of source() and set parameters accordingly.</p>\n<p><strong>Code Structure Advice</strong></p>\n<p>You can preserve a repository/service structure (ESRepository) but each method should now create and send the request object rather than building and chaining.</p>\n<p>Error handling is more explicit; wrap each operation in try/catch, but use the types from the new client.</p>\n<p><strong>Comparison Table</strong></p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>Elasticsearch 5.6 (TransportClient)</th>\n<th>Elasticsearch 9.x (Rest Client)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TransportClient + builder chains</td>\n<td>RestClient + ElasticsearchClient + POJOs</td>\n</tr>\n<tr>\n<td>prepareSearch, prepareSearchScroll, SearchRequestBuilder</td>\n<td>SearchRequest.Builder, ScrollRequest.Builder</td>\n</tr>\n<tr>\n<td>SearchTemplateRequestBuilder</td>\n<td>SearchTemplateRequest.Builder</td>\n</tr>\n<tr>\n<td>Chained method calls to build requests</td>\n<td>Build request objects directly</td>\n</tr>\n</tbody>\n</table></div>\n<p>In summary: migration involves swapping TransportClient for RestClient/ElasticsearchClient, using request builder objects, explicitly using request/response POJOs, and rewriting builder-chained methods as request builders. The repository pattern can be preserved by updating each method to the new way of constructing requests and handling responses</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1096470,
      "reputation" : 29424,
      "user_id" : 1089967,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
      "display_name" : "lance-java",
      "link" : "https://stackoverflow.com/users/1089967/lance-java"
    },
    "creation_date" : 1762184315,
    "last_activity_date" : 1762184619,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}