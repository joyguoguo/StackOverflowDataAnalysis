{
  "question" : {
    "question_id" : 79563581,
    "title" : "mcp Failed to send message to session",
    "body" : "<p>there is mcp service code:</p>\n<pre><code>@Service\npublic class McpWeatherService {\n\n    @Tool(description = &quot;根据城市名称获取天气预报&quot;)\n    public String getWeatherByCity(String city) {\n        Map&lt;String, String&gt; mockData = Map.of(\n                &quot;西安&quot;, &quot;晴天&quot;,\n                &quot;北京&quot;, &quot;小雨&quot;,\n                &quot;上海&quot;, &quot;大雨&quot;\n        );\n        return mockData.getOrDefault(city, &quot;抱歉：未查询到对应城市！&quot;);\n    }\n\n}\n</code></pre>\n<p>mcp server config:</p>\n<pre><code>@Configuration\npublic class McpServerConfig {\n\n\n    @Bean\n    public ToolCallbackProvider weatherTools(McpWeatherService weatherService) {\n        return MethodToolCallbackProvider.builder().toolObjects(weatherService).build();\n    }\n\n    @Bean\n    public WebClient.Builder webClientBuilder() {\n        return WebClient.builder();\n    }\n\n}\n</code></pre>\n<p>server dependency:</p>\n<pre><code>&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;exclusions&gt;\n            &lt;exclusion&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-starter-tomcat&lt;/artifactId&gt;\n            &lt;/exclusion&gt;\n        &lt;/exclusions&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-undertow&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n\n&lt;!--        &lt;dependency&gt;--&gt;\n&lt;!--            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;--&gt;\n&lt;!--            &lt;artifactId&gt;spring-ai-mcp-client-webflux-spring-boot-starter&lt;/artifactId&gt;--&gt;\n&lt;!--        &lt;/dependency&gt;--&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-mcp-server-webmvc-spring-boot-starter&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-openai-spring-boot-starter&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-ollama-spring-boot-starter&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n&lt;!--        &lt;dependency&gt;--&gt;\n&lt;!--            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;--&gt;\n&lt;!--            &lt;artifactId&gt;spring-ai-pgvector-store-spring-boot-starter&lt;/artifactId&gt;--&gt;\n&lt;!--        &lt;/dependency&gt;--&gt;\n&lt;!--        &lt;dependency&gt;--&gt;\n&lt;!--            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;--&gt;\n&lt;!--            &lt;artifactId&gt;spring-ai-weaviate-store-spring-boot-starter&lt;/artifactId&gt;--&gt;\n&lt;!--        &lt;/dependency&gt;--&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-tika-document-reader&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.alibaba.cloud.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-ai-alibaba-starter&lt;/artifactId&gt;\n        &lt;version&gt;${spring-ai-alibaba.version}&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.knuddels&lt;/groupId&gt;\n        &lt;artifactId&gt;jtokkit&lt;/artifactId&gt;\n        &lt;version&gt;1.1.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;!-- https://mvnrepository.com/artifact/io.github.pig-mesh.ai/deepseek4j --&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.github.pig-mesh.ai&lt;/groupId&gt;\n        &lt;artifactId&gt;deepseek-spring-boot-starter&lt;/artifactId&gt;\n        &lt;version&gt;1.4.3&lt;/version&gt;\n    &lt;/dependency&gt;\n&lt;/dependencies&gt;\n</code></pre>\n<p>&lt;spring-ai.version&gt;1.0.0-M6&lt;/spring-ai.version&gt;\nmay be i should use spring-ai-mcp-server-webflux-spring-boot-starter?</p>\n<p>I start the client,then call the generate request,success first time,after about 20seconds, it failed when I call second time, server log:</p>\n<pre><code>2025-04-09T11:55:01.101+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.web.servlet.DispatcherServlet        : POST &quot;/mcp/message&quot;, parameters={}\n2025-04-09T11:55:01.102+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.w.s.f.support.RouterFunctionMapping  : Mapped to io.modelcontextprotocol.server.transport.WebMvcSseServerTransport$$Lambda$863/0x000000080109d548@7d01533b\n2025-04-09T11:55:01.104+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.web.servlet.DispatcherServlet        : Completed 200 OK\n2025-04-09T11:55:01.104+08:00 DEBUG 33552 --- [bao-ai-mcp] [oundedElastic-1] i.m.s.t.WebMvcSseServerTransport         : Attempting to broadcast message to 1 active sessions\n2025-04-09T11:55:03.555+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.w.c.request.async.WebAsyncManager    : Servlet container timeout notification for &quot;/sse&quot;\n2025-04-09T11:55:03.555+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.w.c.request.async.WebAsyncManager    : Async result set for &quot;/sse&quot;\n2025-04-09T11:55:03.555+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-2] o.s.w.c.request.async.WebAsyncManager    : Performing async dispatch for &quot;/sse&quot;\n2025-04-09T11:55:03.557+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.web.servlet.DispatcherServlet        : &quot;ASYNC&quot; dispatch for GET &quot;/sse&quot;, parameters={}\n2025-04-09T11:55:03.558+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.w.s.f.s.HandlerFunctionAdapter       : Resume with async result [org.springframework.web.context.request.async.AsyncRequestTimeoutException]\n2025-04-09T11:55:03.560+08:00  WARN 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] .w.s.m.s.DefaultHandlerExceptionResolver : Ignoring exception, response committed already: org.springframework.web.context.request.async.AsyncRequestTimeoutException\n2025-04-09T11:55:03.560+08:00  WARN 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] .w.s.m.s.DefaultHandlerExceptionResolver : Resolved [org.springframework.web.context.request.async.AsyncRequestTimeoutException]\n2025-04-09T11:55:03.562+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.web.servlet.DispatcherServlet        : Exiting from &quot;ASYNC&quot; dispatch, status 200\n2025-04-09T11:55:17.928+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.web.servlet.DispatcherServlet        : POST &quot;/mcp/message&quot;, parameters={}\n2025-04-09T11:55:17.928+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.w.s.f.support.RouterFunctionMapping  : Mapped to io.modelcontextprotocol.server.transport.WebMvcSseServerTransport$$Lambda$863/0x000000080109d548@7d01533b\n2025-04-09T11:55:17.928+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] i.m.s.t.WebMvcSseServerTransport         : Attempting to broadcast message to 1 active sessions\n2025-04-09T11:55:17.930+08:00 ERROR 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] i.m.s.t.WebMvcSseServerTransport         : Failed to send message to session b6531a60-1d18-472f-a1f9-c54ce74cfb55: ServletOutputStream failed to write: UT010029: Stream is closed\n2025-04-09T11:55:17.930+08:00 DEBUG 33552 --- [bao-ai-mcp] [  XNIO-1 task-3] o.s.web.servlet.DispatcherServlet        : Completed 200 OK\n</code></pre>\n<p>client execute exception log:</p>\n<pre><code>Caused by: java.util.concurrent.TimeoutException: Did not observe any item or terminal signal within 20000ms in 'Mono.create ⇢ at io.modelcontextprotocol.spec.DefaultMcpSession.sendRequest(DefaultMcpSession.java:228)' (and no fallback has been configured)\n    at reactor.core.publisher.FluxTimeout$TimeoutMainSubscriber.handleTimeout(FluxTimeout.java:296)\n    Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: \nAssembly trace from producer [reactor.core.publisher.MonoTimeout] :\n    reactor.core.publisher.Mono.timeout(Mono.java:5008)\n    io.modelcontextprotocol.spec.DefaultMcpSession.sendRequest(DefaultMcpSession.java:239)\nError has been observed at the following site(s):\n    *__Mono.timeout ⇢ at io.modelcontextprotocol.spec.DefaultMcpSession.sendRequest(DefaultMcpSession.java:239)\n    |_  Mono.handle ⇢ at io.modelcontextprotocol.spec.DefaultMcpSession.sendRequest(DefaultMcpSession.java:239)\nOriginal Stack Trace:\n        at reactor.core.publisher.FluxTimeout$TimeoutMainSubscriber.handleTimeout(FluxTimeout.java:296)\n        at reactor.core.publisher.FluxTimeout$TimeoutMainSubscriber.doTimeout(FluxTimeout.java:281)\n        at reactor.core.publisher.FluxTimeout$TimeoutTimeoutSubscriber.onNext(FluxTimeout.java:420)\n        at reactor.core.publisher.FluxOnErrorReturn$ReturnSubscriber.onNext(FluxOnErrorReturn.java:162)\n        at reactor.core.publisher.MonoDelay$MonoDelayRunnable.propagateDelay(MonoDelay.java:270)\n        at reactor.core.publisher.MonoDelay$MonoDelayRunnable.run(MonoDelay.java:285)\n        at reactor.core.scheduler.SchedulerTask.call(SchedulerTask.java:68)\n        at reactor.core.scheduler.SchedulerTask.call(SchedulerTask.java:28)\n        at java.base/java.util.concurrent.FutureTask.run$$$capture(FutureTask.java:264)\n        at java.base/java.util.concurrent.FutureTask.run(FutureTask.java)\n        at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n        at java.base/java.lang.Thread.run(Thread.java:833)\nCreating a new SqlSession\n</code></pre>\n<p>client log shows a time out error we can also see in server log.</p>\n<p>does mcp server session close auto in 20seconds after connected?</p>\n<p>client connect the server when started, after about 20seconds, call mcp &quot;tool/list&quot; method and it shows time out</p>\n<p>expect to execute success second time call.</p>\n",
    "tags" : [ "java", "spring-ai", "model-context-protocol" ],
    "owner" : {
      "account_id" : 31561621,
      "reputation" : 19,
      "user_id" : 24382262,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bebc441b4fadc71f0edc91f1970432c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Lnstark",
      "link" : "https://stackoverflow.com/users/24382262/lnstark"
    },
    "is_answered" : false,
    "view_count" : 651,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1744961492,
    "creation_date" : 1744178883,
    "link" : "https://stackoverflow.com/questions/79563581/mcp-failed-to-send-message-to-session",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79580606,
    "question_id" : 79563581,
    "body" : "<pre><code>&lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-bootstrap&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-ai-starter-mcp-server-webflux&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-ai-starter-model-openai&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-config&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n</code></pre>\n<p>After I modifying the dependency, it was successful</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 31561621,
      "reputation" : 19,
      "user_id" : 24382262,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bebc441b4fadc71f0edc91f1970432c3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Lnstark",
      "link" : "https://stackoverflow.com/users/24382262/lnstark"
    },
    "creation_date" : 1744961492,
    "last_activity_date" : 1744961492,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79580606" : [ {
      "comment_id" : 140349265,
      "post_id" : 79580606,
      "body" : "Your answer could be improved with additional supporting information. Please <a href=\"https://stackoverflow.com/posts/79580606/edit\">edit</a> to add further details, such as citations or documentation, so that others can confirm that your answer is correct. You can find more information on how to write good answers <a href=\"/help/how-to-answer\">in the help center</a>.",
      "score" : 0,
      "owner" : {
        "account_id" : -1,
        "reputation" : 1,
        "user_id" : -1,
        "user_type" : "moderator",
        "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
        "display_name" : "Community",
        "link" : "https://stackoverflow.com/users/-1/community"
      },
      "creation_date" : 1745013079,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}