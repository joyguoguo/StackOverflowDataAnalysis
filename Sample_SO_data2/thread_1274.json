{
  "question" : {
    "question_id" : 79728142,
    "title" : "XML document XAdES with Apache Santuario XML Security - ReferenceNotInitializedException",
    "body" : "<p>I want to build an XAdES signer in Java by using Apache Santuario XML security but when trying to sing the document I get the following excpetion:</p>\n<pre><code>Exception in thread &quot;main&quot; org.apache.xml.security.signature.ReferenceNotInitializedException: Cannot resolve element with ID IHEManifest\nOriginal Exception was org.apache.xml.security.signature.ReferenceNotInitializedException: Cannot resolve element with ID IHEManifest\nOriginal Exception was org.apache.xml.security.signature.ReferenceNotInitializedException: Cannot resolve element with ID IHEManifest\nOriginal Exception was org.apache.xml.security.utils.resolver.ResourceResolverException: Cannot resolve element with ID IHEManifest\n</code></pre>\n<p>What I already check:</p>\n<ol>\n<li>manifestElem.setIdAttribute(&quot;Id&quot;, true);</li>\n<li>The element #IHEManifest is in the DOM before signing</li>\n</ol>\n<p>pom.xml dependency:</p>\n<pre><code>        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.santuario&lt;/groupId&gt;\n            &lt;artifactId&gt;xmlsec&lt;/artifactId&gt;\n            &lt;version&gt;1.5.3&lt;/version&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p>The build XML and sign method:</p>\n<pre><code>    public static Document sign(byte[] bytes, String signatureId, String documentId, String keystorePath, String keystorePassword) throws Exception {\n        // Compute SHA1 digest of the document\n        MessageDigest sha1 = MessageDigest.getInstance(&quot;SHA-1&quot;);\n        byte[] hashBytes = sha1.digest(bytes);\n        StringBuilder hashHex = new StringBuilder();\n        for (byte b : hashBytes) hashHex.append(String.format(&quot;%02x&quot;, b));\n        String base64Hash = Base64.getEncoder().encodeToString(hashHex.toString().getBytes(&quot;UTF-8&quot;));\n\n        // Load KeyStore and get PrivateKey and Certificate\n        KeyStore ks = KeyStore.getInstance(&quot;PKCS12&quot;);\n        ks.load(new java.io.FileInputStream(keystorePath), keystorePassword.toCharArray());\n        String alias = ks.aliases().nextElement();\n        PrivateKey privateKey = (PrivateKey) ks.getKey(alias, keystorePassword.toCharArray());\n        X509Certificate cert = (X509Certificate) ks.getCertificate(alias);\n        \n        // Create empty XML document\n        Document doc = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();\n\n        // Create Signature element\n        XMLSignature sig = new XMLSignature(doc, null, XMLSignature.ALGO_ID_SIGNATURE_RSA_SHA1);\n        sig.getElement().setAttribute(&quot;Id&quot;, signatureId);\n\n        // Manifest element (inside ds:Object)\n        Element manifestElem = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:Manifest&quot;);\n        manifestElem.setAttribute(&quot;Id&quot;, &quot;IHEManifest&quot;);\n        manifestElem.setIdAttribute(&quot;Id&quot;, true);\n        \n        // Reference inside Manifest\n        Element manifestRef = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:Reference&quot;);\n        manifestRef.setAttribute(&quot;URI&quot;, documentId);\n\n        Element digestMethod = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestMethod&quot;);\n        digestMethod.setAttribute(&quot;Algorithm&quot;, org.apache.xml.security.utils.Constants.ALGO_ID_DIGEST_SHA1);\n\n        Element digestValue = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestValue&quot;);\n        digestValue.setTextContent(base64Hash);\n\n        manifestRef.appendChild(digestMethod);\n        manifestRef.appendChild(digestValue);\n        manifestElem.appendChild(manifestRef);\n\n        // KeyInfo: X509Data and KeyValue\n        KeyInfo ki = sig.getKeyInfo();\n        X509Data x509Data = new X509Data(doc);\n        x509Data.addCertificate(cert);\n        ki.add(x509Data);\n        KeyValue keyValue = new KeyValue(doc, cert.getPublicKey());\n        ki.add(keyValue);\n\n        // ds:Object with XAdES properties\n        Element objectElem = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:Object&quot;);\n        objectElem.setAttribute(&quot;Id&quot;, &quot;object&quot;);\n\n        // XAdES QualifyingProperties\n        Element qualifyingProperties = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;QualifyingProperties&quot;);\n        qualifyingProperties.setAttribute(&quot;Target&quot;, &quot;#&quot; + signatureId);\n\n        // SignedProperties\n        Element signedProperties = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SignedProperties&quot;);\n        signedProperties.setAttribute(&quot;Id&quot;, &quot;SignedPropertiesId&quot;);\n        \n        // SignedSignatureProperties\n        Element signedSignatureProperties = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SignedSignatureProperties&quot;);\n\n        // SigningTime\n        Element signingTime = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SigningTime&quot;);\n        signingTime.setTextContent(java.time.Instant.now().toString());\n        signedSignatureProperties.appendChild(signingTime);\n\n        // SigningCertificate\n        Element signingCertificate = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SigningCertificate&quot;);\n        Element certElem = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;Cert&quot;);\n\n        // CertDigest\n        Element certDigest = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;CertDigest&quot;);\n        Element digestMethodCert = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestMethod&quot;);\n        digestMethodCert.setAttribute(&quot;Algorithm&quot;, org.apache.xml.security.utils.Constants.ALGO_ID_DIGEST_SHA1);\n        Element digestValueCert = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestValue&quot;);\n        digestValueCert.setTextContent(Base64.getEncoder().encodeToString(cert.getEncoded()));\n        certDigest.appendChild(digestMethodCert);\n        certDigest.appendChild(digestValueCert);\n\n        // IssuerSerial\n        Element issuerSerial = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;IssuerSerial&quot;);\n        Element x509IssuerName = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:X509IssuerName&quot;);\n        x509IssuerName.setTextContent(cert.getIssuerX500Principal().getName());\n        Element x509SerialNumber = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:X509SerialNumber&quot;);\n        x509SerialNumber.setTextContent(new BigInteger(cert.getSerialNumber().toString()).toString());\n        issuerSerial.appendChild(x509IssuerName);\n        issuerSerial.appendChild(x509SerialNumber);\n\n        certElem.appendChild(certDigest);\n        certElem.appendChild(issuerSerial);\n        signingCertificate.appendChild(certElem);\n        signedSignatureProperties.appendChild(signingCertificate);\n\n        // SignaturePolicyIdentifier\n        Element signaturePolicyIdentifier = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SignaturePolicyIdentifier&quot;);\n        Element signaturePolicyId = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SignaturePolicyId&quot;);\n        Element sigPolicyId = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SigPolicyId&quot;);\n        Element identifier = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;Identifier&quot;);\n        identifier.setTextContent(documentId);\n        sigPolicyId.appendChild(identifier);\n        signaturePolicyId.appendChild(sigPolicyId);\n\n        Element sigPolicyHash = doc.createElementNS(&quot;http://uri.etsi.org/01903/v1.1.1#&quot;, &quot;SigPolicyHash&quot;);\n        Element digestMethodPolicy = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestMethod&quot;);\n        digestMethodPolicy.setAttribute(&quot;Algorithm&quot;, org.apache.xml.security.utils.Constants.ALGO_ID_DIGEST_SHA1);\n        Element digestValuePolicy = doc.createElementNS(org.apache.xml.security.utils.Constants.SignatureSpecNS, &quot;ds:DigestValue&quot;);\n        byte[] policyHash = new byte[] {/*...*/};\n        digestValuePolicy.setTextContent(Base64.getEncoder().encodeToString(policyHash));\n        sigPolicyHash.appendChild(digestMethodPolicy);\n        sigPolicyHash.appendChild(digestValuePolicy);\n        signaturePolicyId.appendChild(sigPolicyHash);\n\n        signaturePolicyIdentifier.appendChild(signaturePolicyId);\n        signedSignatureProperties.appendChild(signaturePolicyIdentifier);\n\n        signedProperties.appendChild(signedSignatureProperties);\n        qualifyingProperties.appendChild(signedProperties);\n        objectElem.appendChild(qualifyingProperties);\n\n        \n        Element signatureProperties = doc.createElement(&quot;ds:SignatureProperties&quot;);\n        Element signatureProperty = doc.createElement(&quot;ds:SignatureProperty&quot;);\n        signatureProperty.setAttribute(&quot;Id&quot;, &quot;purposeOfSignature&quot;);\n        signatureProperty.setAttribute(&quot;Target&quot;, &quot;oid:&quot; + documentId);\n        signatureProperty.setTextContent(&quot;Source&quot;);\n        \n        signatureProperties.appendChild(signatureProperty);\n        objectElem.appendChild(signatureProperties);\n        objectElem.appendChild(manifestElem);\n        \n        \n        \n        // Add XAdES Object to Signature\n        sig.getElement().appendChild(objectElem);\n  \n\n        // Reference to Manifest in SignedInfo\n        sig.addDocument(&quot;#IHEManifest&quot;, null,  org.apache.xml.security.utils.Constants.ALGO_ID_DIGEST_SHA1, null, &quot;http://www.w3.org/2000/09/xmldsig#Manifest&quot;);\n       \n        // Sign\n        sig.sign(privateKey);\n        \n        // Add XML declaration\n        doc.setXmlStandalone(false);\n\n        // Add Signature to document root\n        doc.appendChild(sig.getElement());\n\n        // Register the Id attribute on the document root (Signature element)\n        doc.getDocumentElement().setIdAttribute(&quot;Id&quot;, true);\n      \n        return doc;\n    }\n\n</code></pre>\n<p>I can't use other libraries like <code>xades4j</code> or <code>digidoc4j</code>.</p>\n",
    "tags" : [ "java", "xml", "xmlsec", "xades" ],
    "owner" : {
      "account_id" : 13917263,
      "reputation" : 1780,
      "user_id" : 10048703,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/g4Etl.png?s=256",
      "display_name" : "davidm",
      "link" : "https://stackoverflow.com/users/10048703/davidm"
    },
    "is_answered" : false,
    "view_count" : 55,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1754548450,
    "creation_date" : 1754548450,
    "link" : "https://stackoverflow.com/questions/79728142/xml-document-xades-with-apache-santuario-xml-security-referencenotinitializede",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140648592,
    "post_id" : 79728142,
    "body" : "Your xml does not have a ds namespace : &quot;ds:Manifest&quot;  See <a href=\"https://santuario.apache.org/Java/api/org/apache/xml/security/signature/package-summary.html\" rel=\"nofollow noreferrer\">santuario.apache.org/Java/api/org/apache/xml/security/signat&zwnj;&#8203;ure/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 6156307,
      "reputation" : 34503,
      "user_id" : 5015238,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f8790f8091d3c6c58fd45664a165117a?s=256&d=identicon&r=PG",
      "display_name" : "jdweng",
      "link" : "https://stackoverflow.com/users/5015238/jdweng"
    },
    "creation_date" : 1754560077,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}