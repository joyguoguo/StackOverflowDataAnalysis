{
  "question" : {
    "question_id" : 79664967,
    "title" : "Messages not removed from Gmail inbox despite using expunge in jakarata mail Java code",
    "body" : "<p>After loading my application's client secrets</p>\n<pre><code>GoogleClientSecrets clientSecrets = GoogleClientSecrets.load(JSON_FACTORY, isr);\n</code></pre>\n<p>I am able to successfully authenticate using <code>XAOATH2</code> and get an IMAP based <code>Session</code>, <code>jakarta.mail.Store</code>, <code>jakarta.mail.Folder</code> for the inbox, and a list of messages</p>\n<pre><code>Store store = session.getStore(&quot;imaps&quot;);\nFolder folder = store.getFolder(&quot;inbox&quot;);\nMessage[] msgs = folder.getMessages();\n</code></pre>\n<p>This all works perfectly, and I'm not inclined to change over to using Google API.</p>\n<p>If I selectively decide I want to remove a message, I set the deleted flag</p>\n<pre><code>msgs[i].setFlag(Flag.DELETED, true);\n</code></pre>\n<p>if I don't set the delete flag, I set the seen flag to false</p>\n<pre><code>msgs[i].setFlag(Flag.SEEN, false);\n</code></pre>\n<p>In the <code>finally</code> code block, I call the following, which I thought should manage any messages where the delete flag was set</p>\n<pre><code>folder.expunge();  // I tried with and without this line with no apparent difference in behavior\nfolder.close(true);\nstore.close(); \n</code></pre>\n<p><strong>Unexpected: Messages where the delete flag is set are still in the inbox.</strong></p>\n<p>The logging does not appear to contain anything indicating a problem, but I thought someone who has experience with this might see something in the log that indicates why the messages I am trying to delete are not deleted.</p>\n<pre><code>A3 OK [READ-WRITE] inbox selected. (Success)\n1 messages found.\n--------------------------\nA4 FETCH 1 (ENVELOPE INTERNALDATE RFC822.SIZE)\n* 1 FETCH (RFC822.SIZE 10309 INTERNALDATE &quot;11-Jun-2025 17:03:48 +0000&quot; ENVELOPE (&quot;Wed, 11 Jun 2025 17:03:46 +0000&quot; &quot;message subject here&quot; ((&quot;message sender here&quot; NIL &quot;message recipeient here&quot; &quot;sender domain here&quot;))(snip)\nA4 OK Success\nMESSAGE #1:message subject here (snip)\nsubject now [shortened subjec there (snip)]\nA5 FETCH 1 (BODYSTRUCTURE)\n* 1 FETCH (BODYSTRUCTURE ((&quot;TEXT&quot; &quot;PLAIN&quot; (&quot;CHARSET&quot; &quot;UTF-8&quot; &quot;DELSP&quot; &quot;yes&quot; &quot;FORMAT&quot; &quot;flowed&quot;) NIL NIL &quot;BASE64&quot; 910 19 NIL NIL NIL)(&quot;TEXT&quot; &quot;HTML&quot; (&quot;CHARSET&quot; &quot;UTF-8&quot;) NIL NIL &quot;QUOTED-PRINTABLE&quot; 3094 62 NIL NIL NIL) &quot;ALTERNATIVE&quot; (&quot;BOUNDARY&quot; &quot;000000000000cff8c806374ecbeb&quot;) NIL NIL))\nA5 OK Success\nA6 FETCH 1 (BODY[2]&lt;0.3094&gt;)\n* 1 FETCH (FLAGS (\\Seen) BODY[2]&lt;0&gt; {3094}\n&lt;table border=3D&quot;0&quot;(snip)&lt;/tr&gt;&lt;/table&gt;)\nA6 OK Success\nbodyText\nEmail message here (snip)\nA7 STORE 1 +FLAGS (\\Deleted)\n* 1 FETCH (FLAGS (\\Seen \\Deleted))\nA7 OK Success\nremoved email message with the code. &lt;&lt; My Logging from Java\nA8 EXPUNGE\n* 1 EXPUNGE\n* 0 EXISTS\nA8 OK Success\nA9 CLOSE\nA9 OK Returned to authenticated state. (Success)\nDEBUG IMAPS: added an Authenticated connection -- size: 1\nFolder closed. &lt;&lt; My Logging from Java\nDEBUG IMAPS: IMAPStore cleanup, force false\nA10 LOGOUT\n* BYE LOGOUT Requested\nA10 OK 73 good day (Success)\nDEBUG IMAPS: IMAPStore cleanup done\nStore closed. &lt;&lt; My Logging from Java\n</code></pre>\n<p><strong>Question: What do I need to change in my code, short of switching to Gmail API, to get the messages to actually be removed from the inbox?</strong></p>\n",
    "tags" : [ "java", "jakarta-mail", "gmail-imap" ],
    "owner" : {
      "account_id" : 482547,
      "reputation" : 6007,
      "user_id" : 897007,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://www.gravatar.com/avatar/3db84802a7ea6df4e925635d6c3df00c?s=256&d=identicon&r=PG",
      "display_name" : "Dale",
      "link" : "https://stackoverflow.com/users/897007/dale"
    },
    "is_answered" : true,
    "view_count" : 72,
    "closed_date" : 1749992281,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1749922233,
    "creation_date" : 1749823387,
    "link" : "https://stackoverflow.com/questions/79664967/messages-not-removed-from-gmail-inbox-despite-using-expunge-in-jakarata-mail-jav",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79666027,
    "question_id" : 79664967,
    "body" : "<p>Gmail wants you to move things to the trash instead of deleting them.  So you can't delete right from the inbox.  You must first move messages to trash.  Then it will auto-delete after Google has 30 days to scrape emails in your trash folder.  But you can delete once the message is in the trash, and it will be gone immediately.</p>\n<p>This answer has an example <a href=\"https://stackoverflow.com/a/53945146/897007\">https://stackoverflow.com/a/53945146/897007</a></p>\n<p>In addition to the code in the original question, you need</p>\n<pre><code>Folder trashFolder = store.getFolder(&quot;[Gmail]/Trash&quot;);\ntrashFolder.open(Folder.READ_WRITE);\n</code></pre>\n<p>and, for example, if you had just one message to delete, in your loop you'd need</p>\n<pre class=\"lang-java prettyprint-override\"><code>Message[] deleteMsgs = new Message[1];\ndeleteMsgs[0] = msgs[i];\ninboxFolder.copyMessages(deleteMsgs, trashFolder);\n</code></pre>\n<p>That would get it to the trash, where it would persist for 30 days.</p>\n<p>If you want to finish the job (along with clearing out other trash), you could do this</p>\n<pre class=\"lang-java prettyprint-override\"><code>// Clear ALL trash, not just the one I moved there\nMessage[] trashArray = trashFolder.getMessages();\nfor (Message message : trashArray) {\n    message.setFlag(Flags.Flag.DELETED, true);\n}\n</code></pre>\n<p>And close the trash folder with expunge as well as the inbox folder</p>\n<pre class=\"lang-java prettyprint-override\"><code>boolean expunge = true;\ninboxFolder.close(expunge);\ntrashFolder.close(expunge);\n</code></pre>\n",
    "score" : 3,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 482547,
      "reputation" : 6007,
      "user_id" : 897007,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://www.gravatar.com/avatar/3db84802a7ea6df4e925635d6c3df00c?s=256&d=identicon&r=PG",
      "display_name" : "Dale",
      "link" : "https://stackoverflow.com/users/897007/dale"
    },
    "creation_date" : 1749922233,
    "last_activity_date" : 1749922233,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140513283,
    "post_id" : 79664967,
    "body" : "Maybe move to Trash first? See <a href=\"https://stackoverflow.com/a/3201496/3080094\">this answer</a>",
    "score" : 1,
    "owner" : {
      "account_id" : 3700031,
      "reputation" : 6623,
      "user_id" : 3080094,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VDtbQ.jpg?s=256",
      "display_name" : "vanOekel",
      "link" : "https://stackoverflow.com/users/3080094/vanoekel"
    },
    "creation_date" : 1749897724,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}