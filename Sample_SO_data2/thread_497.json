{
  "question" : {
    "question_id" : 79804226,
    "title" : "Blocking endpoint with blocks other endpoints on the same resource",
    "body" : "<p>I'm encountering unexpected blocking behavior in a Quarkus application using RESTEasy Reactive and virtual threads - Just threw those in to see if they'd help but they did not. I have a resource with two @POST endpoints, both annotated with @RunOnVirtualThread and @Blocking (to see if it would fix the issue but it did not..)</p>\n<p>The application code is structured like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>// Endpoint 1: Simulates a long-running, blocking task\n@POST\n@Path(&quot;/{deviceId}/test&quot;) \n@RunOnVirtualThread\n@Blocking\npublic RestResponse&lt;SimpleResponse&gt; testDevice(String deviceId) throws InterruptedException {\n    // deviceId is a placeholder for the path parameter or header injection\n    log.info(&quot;Testing digital signage device: {}&quot;, deviceId); \n    Thread.sleep(20_000); // 20-second simulated block\n    return RestResponse.noContent();\n}\n\n// Endpoint 2: A quick, non-blocking task\n@POST\n@Path(&quot;/{deviceId}/test-other&quot;) \npublic RestResponse&lt;SimpleResponse&gt; testOtherDevice(String deviceId) throws InterruptedException {\n   log.info(&quot;Request received for quick operation.&quot;); \n   // This method returns almost immediately\n   return RestResponse.noContent();\n}\n</code></pre>\n<h2>The Issue</h2>\n<p>When I initiate a request from a ReactJS client to the <strong>long-running endpoint</strong> (<code>.../{deviceId}/test</code>), it correctly enters a pending state for the expected 20 seconds.</p>\n<p>However, while the first request is still processing, if I immediately send a second request to the <strong>quick endpoint</strong> (<code>.../{deviceId}/test-other</code>) for the <strong>same device</strong>, the second request also goes into a <strong>PENDING</strong> state and is not resolved until the first, long-running request finishes. But If I request this endpoint with Postman for example and not the same client - everything seems to work.</p>\n<p>The logs indicate that the <strong>same thread</strong> (and therefore, I suspect, the same thread) is handling both requests sequentially for a given device ID:</p>\n<h2>My Question</h2>\n<ol>\n<li><p>Why is the second request blocked by the first one?</p>\n</li>\n<li><p>What mechanism in RESTEasy Reactive/Quarkus is causing the serialization of requests for this resource or device?</p>\n</li>\n<li><p>How can I configure this resource/endpoints to allow the second, quick request to execute immediately without waiting for the first one to finish?</p>\n</li>\n<li><p>I have tried removing the <code>@Blocking</code> annotation (which had no effect) and ensured both use <code>@RunOnVirtualThread</code>. What specific annotation or configuration is needed to prevent this cross-endpoint blocking behavior?</p>\n</li>\n</ol>\n",
    "tags" : [ "java", "quarkus", "vert.x", "reactive", "quarkus-rest-client" ],
    "owner" : {
      "account_id" : 24575087,
      "reputation" : 21,
      "user_id" : 18480986,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GjA011Py0gzVwvjGe5XjBm2sVqD0Z_yJMTBKWkzpw=k-s256",
      "display_name" : "Neo Geo4",
      "link" : "https://stackoverflow.com/users/18480986/neo-geo4"
    },
    "is_answered" : false,
    "view_count" : 95,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1761828797,
    "creation_date" : 1761772046,
    "link" : "https://stackoverflow.com/questions/79804226/blocking-endpoint-with-blocks-other-endpoints-on-the-same-resource",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79804774,
    "question_id" : 79804226,
    "body" : "<p>To me this sounds like a pinning Problem.<br />\nQuarkus has documentation on this here <a href=\"https://quarkus.io/guides/virtual-threads\" rel=\"nofollow noreferrer\">https://quarkus.io/guides/virtual-threads</a> and there they write:<br />\n&quot;<em>Also, there are situations where the virtual thread cannot be unmounted from the carrier thread. This is called <strong>pinning</strong>.</em>&quot; (virtual thread snatches main thread, making the programm block).<br />\nIn the same documentation, they explicitly advise against annotating long-running tasks with <code>@RunOnVirtualThread</code>, as this can lead to thread monopolization, which means the executing thread takes up too much CPU time (&quot;<em>One could be tempted to use virtual threads to perform long computations (CPU-bound workload). It is useless and counterproductive. CPU-bound doesn’t consist of quickly swapping threads while they need to wait for the completion of an I/O, but in leaving them attached to a CPU core to compute something. In this scenario, it is worse than useless to have thousands of threads if we have tens of CPU cores, virtual threads won’t enhance the performance of CPU-bound workloads. Even worse, when running a CPU-bound workload on a virtual thread, the virtual thread monopolizes the carrier thread on which it is mounted.</em>&quot;.</p>\n<p>Quarkus handles REST connections with the tools the Vert.x enviroment provides (assuming you use RESTEasy Reactive). Annotating the handler with <code>@RunOnVirtualThread</code> tells quarkus to handle this not by Vert.x, but by Loom. Somewhere in this some form of pinning/cpu hogging might appear.</p>\n<p>Also better not mix <code>@Blocking</code> =&gt; run on worker thread provided by thread pool, <code>@RunOnVirtualThread</code> =&gt; run on virtual thread. I dont know which one will be the one doing the actual work but mixing both makes no sense.</p>\n<p>If you intend to have a long running task on the same connection try setting the property:<br />\nquarkus.http.http2=true</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 6862306,
      "reputation" : 545,
      "user_id" : 5276170,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://i.sstatic.net/nmkZo.png?s=256",
      "display_name" : "JaB",
      "link" : "https://stackoverflow.com/users/5276170/jab"
    },
    "creation_date" : 1761828268,
    "last_activity_date" : 1761828797,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140825836,
    "post_id" : 79804226,
    "body" : "I have also tried to return Uni&lt;RestResponse&gt; or CompletionStage but it also did not help",
    "score" : 1,
    "owner" : {
      "account_id" : 24575087,
      "reputation" : 21,
      "user_id" : 18480986,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GjA011Py0gzVwvjGe5XjBm2sVqD0Z_yJMTBKWkzpw=k-s256",
      "display_name" : "Neo Geo4",
      "link" : "https://stackoverflow.com/users/18480986/neo-geo4"
    },
    "creation_date" : 1761772070,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79804774" : [ {
      "comment_id" : 140827077,
      "post_id" : 79804774,
      "body" : "Neither worked separately, nor together :) I know it does not make sense to put both together",
      "score" : 0,
      "owner" : {
        "account_id" : 24575087,
        "reputation" : 21,
        "user_id" : 18480986,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GjA011Py0gzVwvjGe5XjBm2sVqD0Z_yJMTBKWkzpw=k-s256",
        "display_name" : "Neo Geo4",
        "link" : "https://stackoverflow.com/users/18480986/neo-geo4"
      },
      "creation_date" : 1761829796,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}