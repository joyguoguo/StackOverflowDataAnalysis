{
  "question" : {
    "question_id" : 79789276,
    "title" : "GraalVM Native Image: Why Spring Native plugin does not add @JsonSubTypes implementations to reflect-config?",
    "body" : "<p>Iâ€™m using Spring Boot 3.5.3 with GraalVM Native Image via <code>'org.graalvm.buildtools.native' version '0.11.1'</code> plugin.</p>\n<p>I also use Jackson for polymorphic deserialization using <code>@JsonSubTypes</code>.</p>\n<p>Example setup:</p>\n<pre><code>@JsonTypeInfo(use = JsonTypeInfo.Id.NAME, include = JsonTypeInfo.As.PROPERTY, property = &quot;@type&quot;)\n@JsonSubTypes({\n    @JsonSubTypes.Type(value = Dog.class, name = &quot;Dog&quot;),\n    @JsonSubTypes.Type(value = Cat.class, name = &quot;Cat&quot;)\n})\npublic interface Animal {\n    String getName();\n}\n\n@Getter\n@Setter\npublic class Dog implements Animal {\n    private String name;\n}\n\n@Getter\n@Setter\npublic class Cat implements Animal {\n    private String name;\n}\n\n@Getter\n@Setter\npublic class Zoo {\n    private Animal animal;\n}\n</code></pre>\n<p>And a simple Spring REST controller:</p>\n<pre><code>@RestController\npublic class ZooController {\n    @PostMapping(&quot;/zoo&quot;)\n    public void createZoo(@RequestBody Zoo zoo) {\n        System.out.println(zoo.getAnimal().getName());\n    }\n}\n</code></pre>\n<p>When I build a native image via <code>gradle clean nativeCompile</code>, I see that subtypes <code>Dog</code> and <code>Cat</code> are not included in the <code>build/generated/aotResources/META-INF/native-image/project-path/reflect-config.json</code>, whereas <code>Zoo</code> and <code>Animal</code> are included.</p>\n<p>And If I try to call the <code>/zoo</code> endpoint with this request body:</p>\n<pre><code>{\n  &quot;animal&quot;: {\n    &quot;@type&quot;: &quot;Dog&quot;,\n    &quot;name&quot;: &quot;dog_name&quot;\n  }\n}\n</code></pre>\n<p>the following exception naturally occurs:</p>\n<blockquote>\n<p>Caused by:\ncom.fasterxml.jackson.databind.exc.InvalidDefinitionException: Cannot\nconstruct instance of com.example.model.Dog: cannot deserialize from\nObject value (no delegate- or property-based Creator): this appears to\nbe a native image, in which case you may need to configure reflection\nfor the class that is to be deserialized</p>\n</blockquote>\n<p>Question:</p>\n<p>Is it possible to set up the <code>org.graalvm.buildtools.native</code> plugin to automatically add <code>@JsonSubTypes</code> implementations to <code>reflect-config.json</code>?</p>\n<p>Or should I really add manually each subtype to reflection-config.json (or via <code>RuntimeHintsRegistrar</code>)?</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "graalvm" ],
    "owner" : {
      "account_id" : 18586978,
      "reputation" : 3850,
      "user_id" : 15000097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/yFl4M.jpg?s=256",
      "display_name" : "Georgii Lvov",
      "link" : "https://stackoverflow.com/users/15000097/georgii-lvov"
    },
    "is_answered" : true,
    "view_count" : 89,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1760421287,
    "creation_date" : 1760358835,
    "link" : "https://stackoverflow.com/questions/79789276/graalvm-native-image-why-spring-native-plugin-does-not-add-jsonsubtypes-implem",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79789856,
    "question_id" : 79789276,
    "body" : "<p>The part that is responsible for exporting the reflection configuration for GraalVM is the <a href=\"https://github.com/spring-projects/spring-framework/blob/main/spring-core/src/main/java/org/springframework/aot/hint/BindingReflectionHintsRegistrar.java#L190\" rel=\"nofollow noreferrer\"><code>BindingReflectionHintsRegistrar</code></a>.</p>\n<p>If you look at the implementation there is a section that iterates the annotations from Jackson.</p>\n<pre class=\"lang-java prettyprint-override\"><code>private void registerHintsForClassAttributes(ReflectionHints hints, MergedAnnotation&lt;Annotation&gt; annotation) {\n  annotation.getRoot().asMap().forEach((attributeName, value) -&gt; {\n  if (value instanceof Class&lt;?&gt; classValue &amp;&amp; value != Void.class) {\n    if (attributeName.equals(&quot;builder&quot;)) {\n      hints.registerType(classValue, MemberCategory.INVOKE_DECLARED_CONSTRUCTORS,\n                        MemberCategory.INVOKE_DECLARED_METHODS);\n    }\n    else {\n      hints.registerType(classValue, MemberCategory.INVOKE_DECLARED_CONSTRUCTORS);\n    }\n  }});\n}\n</code></pre>\n<p>It will by default export the information of the <code>value</code> attribute and there is special handling of the <code>builder</code> attribute for the <code>@JsonDeserialize</code> annotation. However as <code>@JsonSubTypes</code> has its <code>value</code> attribute reference another annotation it doesn't loop back into the <code>@JsonSubTypes.Type</code> annotation and hence appears not to include the specific types (or binding).</p>\n<p>To fix you could add your own <code>RuntieHintsRegistrar</code> for these cases but I would also register an issue with the Spring Framework to fix this, what I think is an, omission.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1760421287,
    "last_activity_date" : 1760421287,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140793064,
    "post_id" : 79789276,
    "body" : "I think it is an oversight in the <a href=\"https://github.com/spring-projects/spring-framework/blob/main/spring-core/src/main/java/org/springframework/aot/hint/BindingReflectionHintsRegistrar.java#L190\" rel=\"nofollow noreferrer\"><code>BindingReflectionHintsRegistrar</code></a>. It doesn&#39;t go into the <code>value</code> of <code>@JsonSubTypes</code> but tries to export the <code>value</code> as is and is thus effectivly ignored.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126826,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1760364953,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}