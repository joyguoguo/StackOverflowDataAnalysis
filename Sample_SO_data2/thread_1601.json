{
  "question" : {
    "question_id" : 79695420,
    "title" : "h2 db is empty on testing",
    "body" : "<p>I want to run tests on my app using h2 as a database but every time I attempt to run a test it shows me an exception saying that h2 db is empty. None of the related questions I`ve read helped me.</p>\n<p>This is the method I am trying to test:</p>\n<pre class=\"lang-java prettyprint-override\"><code>/// I know is pointless to test this, but I am learning to implement tests\npublic interface ConocimientoRepository extends JpaRepository&lt;Conocimiento,Long&gt;{\n    @Modifying \n    @Transactional \n    @Query(value = &quot;DELETE FROM conocimiento WHERE busca_id = :buscaId&quot;, nativeQuery = true) \n    void deleteAllConocimientoFromBuscaId(@Param(&quot;buscaId&quot;) Long buscaId);\n}\n</code></pre>\n<p>The test itself:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@DataJpaTest\n@AutoConfigureTestDatabase(connection = EmbeddedDatabaseConnection.H2)\n@ActiveProfiles(&quot;test&quot;)\npublic class ConocimientoRepositoryTests {\n\n    @Autowired\n    BuscaRepository buscaRepository;\n    \n    @Autowired\n    ConocimientoRepository conocimientoRepository;\n\n    private Busca b1, b2;\n    private List&lt;Conocimiento&gt; listConocimientos;\n\n    @BeforeEach\n    public void initData() {\n\n        b1 = new Busca(&quot;Ana&quot;, &quot;ana@mail.com&quot;, &quot;Sevilla&quot;, &quot;612345678&quot;, &quot;Password1!&quot;);\n        b2 = new Busca(&quot;Luis&quot;, &quot;luis@mail.com&quot;, &quot;Madrid&quot;, &quot;712345678&quot;, &quot;SecurePwd2@&quot;);\n\n        listConocimientos = List.of(\n            Conocimiento.builder()\n                .centroEducativo(&quot;Centro 1&quot;)\n                .titulo(&quot;Título 1&quot;)\n                .inicioPeriodoConocimiento(LocalDate.of(2020, 1, 1))\n                .finPeriodoConocimiento(LocalDate.of(2021, 1, 1))\n                .busca(b1)\n                .build(),\n            Conocimiento.builder()\n                .centroEducativo(&quot;Centro 2&quot;)\n                .titulo(&quot;Título 2&quot;)\n                .inicioPeriodoConocimiento(LocalDate.of(2019, 1, 1))\n                .finPeriodoConocimiento(LocalDate.of(2020, 1, 1))\n                .busca(b1)\n                .build(),\n            Conocimiento.builder()\n                .centroEducativo(&quot;Centro 3&quot;)\n                .titulo(&quot;Título 3&quot;)\n                .inicioPeriodoConocimiento(LocalDate.of(2018, 1, 1))\n                .finPeriodoConocimiento(LocalDate.of(2019, 1, 1))\n                .busca(b2)\n                .build()\n        );\n\n        b1.setListaConocimientos(listConocimientos.subList(0, 1));\n        b2.setListaConocimientos(List.of(listConocimientos.get(2)));\n\n        buscaRepository.saveAll(List.of(b1,b2));\n    }\n\n    @Test\n    public void ConocimientoRepository_DeleteAllConocimientoFromBuscaId_RemoveAllConocimientoFromBuscaId() {\n        buscaRepository.delete(b1);\n\n        Assertions.assertThat(listConocimientos.stream().allMatch(con -&gt; con.getBusca().getId() != b1.getId()));\n    }\n}\n</code></pre>\n<p>Entities affected by test:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@EqualsAndHashCode(of = &quot;id&quot;)\n@Data\n@ToString(exclude = &quot;busca&quot;)\n@Builder\n@NoArgsConstructor\n@AllArgsConstructor\n@Entity\npublic class Conocimiento {\n    @GeneratedValue(strategy = GenerationType.AUTO)\n    @Id\n    private Long id;\n\n    @NotNull\n    @Size(max = 40, message = &quot;Máximo 40 carácteres&quot;)\n    private String centroEducativo;\n\n    @NotNull\n    @Size(max = 40, message = &quot;Máximo 40 carácteres&quot;)\n    private String titulo;\n\n    @NotNull\n    private LocalDate inicioPeriodoConocimiento;\n    \n    @NotNull\n    private LocalDate finPeriodoConocimiento;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;busca_id&quot;)\n    @JsonBackReference(value = &quot;busca-conocimiento&quot;)\n    private Busca busca;\n\n    public Conocimiento(@NotNull @Size(max = 40, message = &quot;Máximo 40 carácteres&quot;) String centroEducativo,\n        @NotNull @Size(max = 40, message = &quot;Máximo 40 carácteres&quot;) String titulo, LocalDate fechaInicio, LocalDate fechaFin) {\n        this.centroEducativo = centroEducativo;\n        this.titulo = titulo;      \n        this.inicioPeriodoConocimiento = fechaInicio;\n        this.finPeriodoConocimiento = fechaFin;  \n    }\n    \n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Data\n@ToString(exclude = {&quot;listaOfertas&quot;})\n@NoArgsConstructor\n@AllArgsConstructor\n@EqualsAndHashCode(of = &quot;id&quot;)\n@Builder\n@Entity\n@Table(name = &quot;Busca&quot;)\npublic class Busca extends Usuario {\n    \n    @OneToMany(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = &quot;busca&quot;)\n    private List&lt;Experiencia&gt; listaExperiencias;\n\n    @OneToMany(fetch = FetchType.EAGER, cascade = CascadeType.ALL, mappedBy = &quot;busca&quot;)\n    private List&lt;Conocimiento&gt; listaConocimientos;\n \n    @JsonBackReference(&quot;busca-oferta&quot;) \n    @ManyToMany(cascade = CascadeType.ALL, fetch = FetchType.EAGER) \n    @JoinTable(name = &quot;busca_oferta&quot;, joinColumns = @JoinColumn(name = &quot;busca_id&quot;), inverseJoinColumns = @JoinColumn(name = &quot;oferta_id&quot;)) \n    @JsonIgnoreProperties(&quot;busca_id&quot;) \n    private List&lt;Oferta&gt; listaOfertas;\n\n    public Busca(String nombre, String email, String ciudad, String telefono, String password) {\n        super(nombre, email, ciudad, telefono, password, Rol.BUSCA);\n    }\n}\n</code></pre>\n<p>This is the content of application-test.properties:</p>\n<pre class=\"lang-toml prettyprint-override\"><code>spring.h2.console.enabled=true\nspring.sql.init.platform=h2\nspring.jpa.defer-datasource-initialization=true\n\nspring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE\nspring.datasource.driverClassName=org.h2.Driver\nspring.datasource.username=sa\nspring.datasource.password=\nspring.jpa.hibernate.ddl-auto=create-drop\n</code></pre>\n<p>And finally, the stack error from the test:</p>\n<pre class=\"lang-none prettyprint-override\"><code>org.springframework.dao.InvalidDataAccessResourceUsageException: could not prepare statement [Table &quot;BUSCA&quot; not found (this database is empty); SQL statement:\ninsert into busca (ciudad,email,nombre,password,rol,telefono) values (?,?,?,?,?,?) [42104-214]] [insert into busca (ciudad,email,nombre,password,rol,telefono) values (?,?,?,?,?,?)]; SQL [insert into busca (ciudad,email,nombre,password,rol,telefono) values (?,?,?,?,?,?)]\n at org.springframework.orm.jpa.vendor.HibernateJpaDialect.convertHibernateAccessException(HibernateJpaDialect.java:277)\n at org.springframework.orm.jpa.vendor.HibernateJpaDialect.translateExceptionIfPossible(HibernateJpaDialect.java:241)\n at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.translateExceptionIfPossible(AbstractEntityManagerFactoryBean.java:550)\n at org.springframework.dao.support.ChainedPersistenceExceptionTranslator.translateExceptionIfPossible(ChainedPersistenceExceptionTranslator.java:61)\n at org.springframework.dao.support.DataAccessUtils.translateIfNecessary(DataAccessUtils.java:335)\n at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:152)\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:164)\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n at org.springframework.aop.interceptor.ExposeInvocationInterceptor.invoke(ExposeInvocationInterceptor.java:97)\n at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184)\n at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:220)\n at jdk.proxy2/jdk.proxy2.$Proxy142.saveAll(Unknown Source)\n at com.example.demo.repositories.ConocimientoRepositoryTests.initData(ConocimientoRepositoryTests.java:67)\n at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n at java.base/java.util.ArrayList.forEach(ArrayList.java:1596)\n</code></pre>\n<p>What could it be?</p>\n<p>EDIT: Reopened issue because the question used to mark this problem as duplicated has a solution that <strong>I ALREADY TRIED</strong>.\nThe question that I was redirected states that to fix the issue all I have to do is set this on my application-test.properties:</p>\n<pre class=\"lang-none prettyprint-override\"><code>jdbc:h2:mem:test;DB_CLOSE_DELAY=-1\n</code></pre>\n<p>Which I already did:</p>\n<pre class=\"lang-toml prettyprint-override\"><code>spring.h2.console.enabled=true\nspring.sql.init.platform=h2\nspring.jpa.defer-datasource-initialization=true\n\nspring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1;DB_CLOSE_ON_EXIT=FALSE\nspring.datasource.driverClassName=org.h2.Driver\nspring.datasource.username=sa\nspring.datasource.password=\nspring.jpa.hibernate.ddl-auto=create-drop\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "junit", "h2" ],
    "owner" : {
      "account_id" : 41223391,
      "reputation" : 50,
      "user_id" : 30183592,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8c81589f93343dece0cdbf4413bd577?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Horacio Garc&#237;a Magallanes",
      "link" : "https://stackoverflow.com/users/30183592/horacio-garc%c3%ada-magallanes"
    },
    "is_answered" : true,
    "view_count" : 161,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1755417938,
    "creation_date" : 1752054482,
    "link" : "https://stackoverflow.com/questions/79695420/h2-db-is-empty-on-testing",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79737702,
    "question_id" : 79695420,
    "body" : "<p>I managed to fix my tests by adding a <code>application-test.properties</code> on my project:</p>\n<pre><code>spring.datasource.url=jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1\nspring.datasource.driver-class-name=org.h2.Driver\nspring.datasource.username=sa\nspring.datasource.password=\n\nspring.jpa.database-platform=org.hibernate.dialect.H2Dialect\nspring.jpa.hibernate.ddl-auto=create-drop\nspring.jpa.show-sql=true\nspring.h2.console.enabled=true\n</code></pre>\n<p>And setting it up on my test:</p>\n<pre><code>@DataJpaTest\n@AutoConfigureTestDatabase(connection = EmbeddedDatabaseConnection.H2)\n@ActiveProfiles(&quot;test&quot;)\npublic class ExperienciaRepositoryTests {\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 41223391,
      "reputation" : 50,
      "user_id" : 30183592,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8c81589f93343dece0cdbf4413bd577?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Horacio Garc&#237;a Magallanes",
      "link" : "https://stackoverflow.com/users/30183592/horacio-garc%c3%ada-magallanes"
    },
    "creation_date" : 1755417062,
    "last_activity_date" : 1755417938,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140576370,
    "post_id" : 79695420,
    "body" : "@MappedSuperclass",
    "score" : 0,
    "owner" : {
      "account_id" : 41223391,
      "reputation" : 50,
      "user_id" : 30183592,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8c81589f93343dece0cdbf4413bd577?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Horacio Garc&#237;a Magallanes",
      "link" : "https://stackoverflow.com/users/30183592/horacio-garc%c3%ada-magallanes"
    },
    "creation_date" : 1752056492,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140576316,
    "post_id" : 79695420,
    "body" : "Is  Usuario marked with @MappedSuperclass or @Entity?",
    "score" : 1,
    "owner" : {
      "account_id" : 20270357,
      "reputation" : 106,
      "user_id" : 14866668,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f5179abe3f6496020d7487a5a2b43fb4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "suppaGonzalo",
      "link" : "https://stackoverflow.com/users/14866668/suppagonzalo"
    },
    "creation_date" : 1752055215,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}