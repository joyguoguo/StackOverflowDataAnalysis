{
  "question" : {
    "question_id" : 79845091,
    "title" : "spring webflux does not catch exception",
    "body" : "<p>I’m trying to catch a thrown exception in a Spring WebFlux controller. When <code>i[0]</code> reaches 3, it enters the handler method and executes the handler, but the returned value is not shown in the output, and it behaves as though the exception is not thrown anywhere in the app. How can I resolve this problem?</p>\n<p>controller:</p>\n<pre><code>@GetMapping(&quot;all&quot;)\npublic ResponseEntity&lt;Flux&lt;CustomerDTO&gt;&gt; findAll(@RequestParam(defaultValue = &quot;0&quot;) Integer page,\n                                                 @RequestParam(defaultValue = &quot;10&quot;) Integer pageSize) {\n    int[] i = {0};\n    return ResponseEntity.ok(customerService.findAll(Paginator.of(page, pageSize))\n            .flatMap(dto -&gt; {\n                if (i[0] == 3)\n                    return Mono.error(new RuntimeException(&quot;ERROR&quot;));\n                i[0]++;\n                return Mono.just(dto);\n            }));\n}\n</code></pre>\n<p>exception handler</p>\n<pre><code>@RestControllerAdvice\npublic class GlobalExceptionHandler {\n    @ExceptionHandler(Exception.class)\n    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; handleException(Exception ex) {\n        Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();\n        response.put(&quot;message&quot;, ex.getMessage());\n        response.put(&quot;status&quot;, HttpStatus.BAD_REQUEST.value());\n        return new ResponseEntity&lt;&gt;(response, HttpStatus.BAD_REQUEST);\n    }\n}\n</code></pre>\n<p>postman output:</p>\n<pre><code>Connected to http://localhost:8080/customer/all\n{&quot;id&quot;:8,&quot;name&quot;:&quot;eisa&quot;,&quot;email&quot;:&quot;aaa@gmail.com&quot;}\n{&quot;id&quot;:1,&quot;name&quot;:&quot;sam&quot;,&quot;email&quot;:&quot;vvv@yahoo.com&quot;}\n{&quot;id&quot;:9,&quot;name&quot;:&quot;yunos&quot;,&quot;email&quot;:&quot;zzz@gmail.com&quot;}\nConnection closed\n</code></pre>\n<p>console output:</p>\n<pre><code>java.lang.UnsupportedOperationException: null\n    at org.springframework.http.ReadOnlyHttpHeaders.set(ReadOnlyHttpHeaders.java:112) ~[spring-web-6.2.12.jar:6.2.12]\n    Suppressed: reactor.core.publisher.FluxOnAssembly$OnAssemblyException: \nAssembly trace from producer [reactor.core.publisher.MonoFlatMap] :\n    reactor.core.publisher.Mono.flatMap(Mono.java:3179)\n    org.springframework.web.reactive.result.method.annotation.ResponseEntityResultHandler.handleResult(ResponseEntityResultHandler.java:151)\nError has been observed at the following site(s):\n    *__________Mono.flatMap ⇢ at org.springframework.web.reactive.result.method.annotation.ResponseEntityResultHandler.handleResult(ResponseEntityResultHandler.java:151)\n    |_           checkpoint ⇢ Exception handler org.isoft.webflux.exception.GlobalExceptionHandler#handleResponseStatusException(Exception), error=&quot;ERRORRRRR&quot; [DispatcherHandler]\n    *__________Mono.flatMap ⇢ at org.springframework.web.reactive.DispatcherHandler.lambda$handleResultMono$6(DispatcherHandler.java:177)\n    *____Mono.onErrorResume ⇢ at org.springframework.web.reactive.DispatcherHandler.lambda$handleResultMono$7(DispatcherHandler.java:176)\n    *__________Mono.flatMap ⇢ at org.springframework.web.reactive.DispatcherHandler.handleResultMono(DispatcherHandler.java:172)\n    *__________Mono.flatMap ⇢ at org.springframework.web.reactive.DispatcherHandler.handle(DispatcherHandler.java:154)\n    *____________Mono.defer ⇢ at org.springframework.web.server.handler.DefaultWebFilterChain.filter(DefaultWebFilterChain.java:106)\n    |_       Mono.doOnError ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:84)\n    |_   Mono.onErrorResume ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:85)\n    |_       Mono.doOnError ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:84)\n    |_   Mono.onErrorResume ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:85)\n    |_       Mono.doOnError ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:84)\n    |_   Mono.onErrorResume ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler.handle(ExceptionHandlingWebHandler.java:85)\n    |_     Mono.doOnSuccess ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handle(HttpWebHandlerAdapter.java:299)\n    |_   Mono.onErrorResume ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handle(HttpWebHandlerAdapter.java:300)\n    |_             Mono.tap ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handle(HttpWebHandlerAdapter.java:301)\n    *____________Mono.error ⇢ at org.springframework.web.server.handler.ExceptionHandlingWebHandler$CheckpointInsertingHandler.handle(ExceptionHandlingWebHandler.java:106)\n    |_           checkpoint ⇢ HTTP GET &quot;/customer/all&quot; [ExceptionHandlingWebHandler]\n    *____________Mono.error ⇢ at org.springframework.boot.autoconfigure.web.reactive.error.AbstractErrorWebExceptionHandler.handle(AbstractErrorWebExceptionHandler.java:293)\n    *____________Mono.error ⇢ at org.springframework.web.server.handler.ResponseStatusExceptionHandler.handle(ResponseStatusExceptionHandler.java:68)\n    *____________Mono.error ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handleUnresolvedError(HttpWebHandlerAdapter.java:358)\n    *_____________Mono.then ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handle(HttpWebHandlerAdapter.java:302)\n    *_____________Mono.then ⇢ at org.springframework.web.server.adapter.HttpWebHandlerAdapter.handle(HttpWebHandlerAdapter.java:303)\n    |_       Mono.doOnError ⇢ at org.springframework.http.server.reactive.ReactorHttpHandlerAdapter.apply(ReactorHttpHandlerAdapter.java:66)\n    |_     Mono.doOnSuccess ⇢ at org.springframework.http.server.reactive.ReactorHttpHandlerAdapter.apply(ReactorHttpHandlerAdapter.java:67)\n    *__Mono.deferContextual ⇢ at reactor.netty.http.server.HttpServer$HttpServerHandle.onStateChange(HttpServer.java:1317)\nOriginal Stack Trace:\n        at org.springframework.http.ReadOnlyHttpHeaders.set(ReadOnlyHttpHeaders.java:112) ~[spring-web-6.2.12.jar:6.2.12]\n        at org.springframework.http.HttpHeaders.setContentType(HttpHeaders.java:1032) ~[spring-web-6.2.12.jar:6.2.12]\n        at org.springframework.http.codec.ServerSentEventHttpMessageWriter.write(ServerSentEventHttpMessageWriter.java:111) ~[spring-web-6.2.12.jar:6.2.12]\n        at org.springframework.http.codec.ServerSentEventHttpMessageWriter.write(ServerSentEventHttpMessageWriter.java:176) ~[spring-web-6.2.12.jar:6.2.12]\n        at org.springframework.web.reactive.result.method.annotation.AbstractMessageWriterResultHandler.writeBody(AbstractMessageWriterResultHandler.java:233) ~[spring-webflux-6.2.12.jar:6.2.12]\n        at org.springframework.web.reactive.result.method.annotation.ResponseEntityResultHandler.lambda$handleResult$1(ResponseEntityResultHandler.java:205) ~[spring-webflux-6.2.12.jar:6.2.12]\n        at reactor.core.publisher.FluxFlatMap.trySubscribeScalarMap(FluxFlatMap.java:153) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoFlatMap.subscribeOrReturn(MonoFlatMap.java:53) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.InternalMonoOperator.subscribe(InternalMonoOperator.java:63) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoFlatMap$FlatMapMain.onNext(MonoFlatMap.java:165) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.FluxOnErrorResume$ResumeSubscriber.onNext(FluxOnErrorResume.java:79) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoFlatMap$FlatMapMain.onNext(MonoFlatMap.java:158) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoZip$ZipCoordinator.signal(MonoZip.java:297) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoZip$ZipInner.onNext(MonoZip.java:478) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.Operators$ScalarSubscription.request(Operators.java:2570) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoZip$ZipInner.onSubscribe(MonoZip.java:470) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoJust.subscribe(MonoJust.java:55) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.InternalMonoOperator.subscribe(InternalMonoOperator.java:76) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoZip$ZipCoordinator.request(MonoZip.java:220) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoFlatMap$FlatMapMain.request(MonoFlatMap.java:194) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.Operators$MultiSubscriptionSubscriber.set(Operators.java:2366) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.FluxOnErrorResume$ResumeSubscriber.onSubscribe(FluxOnErrorResume.java:74) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoFlatMap$FlatMapMain.onSubscribe(MonoFlatMap.java:117) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoZip.subscribe(MonoZip.java:129) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.Mono.subscribe(Mono.java:4576) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.FluxOnErrorResume$ResumeSubscriber.onError(FluxOnErrorResume.java:103) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoPeekTerminal$MonoTerminalPeekSubscriber.onError(MonoPeekTerminal.java:258) ~[reactor-core-3.7.12.jar:3.7.12]\n        at org.springframework.http.server.reactive.ChannelSendOperator$WriteCompletionBarrier.onError(ChannelSendOperator.java:419) ~[spring-web-6.2.12.jar:6.2.12]\n        at reactor.core.publisher.MonoIgnoreElements$IgnoreElementsSubscriber.onError(MonoIgnoreElements.java:84) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.FluxConcatArray$ConcatArraySubscriber.onError(FluxConcatArray.java:186) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.core.publisher.MonoIgnoreThen$ThenIgnoreMain.onError(MonoIgnoreThen.java:280) ~[reactor-core-3.7.12.jar:3.7.12]\n        at reactor.netty.channel.MonoSendMany$SendManyInner.run(MonoSendMany.java:352) ~[reactor-netty-core-1.2.11.jar:1.2.11]\n        at io.netty.util.concurrent.AbstractEventExecutor.runTask(AbstractEventExecutor.java:173) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.concurrent.AbstractEventExecutor.safeExecute$$$capture(AbstractEventExecutor.java:166) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.concurrent.AbstractEventExecutor.safeExecute(AbstractEventExecutor.java) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.concurrent.SingleThreadEventExecutor.runAllTasks(SingleThreadEventExecutor.java:472) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:569) ~[netty-transport-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:998) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30) ~[netty-common-4.1.128.Final.jar:4.1.128.Final]\n        at java.base/java.lang.Thread.run(Thread.java:1583) ~[na:na]\n</code></pre>\n",
    "tags" : [ "java", "spring-webflux", "project-reactor" ],
    "owner" : {
      "account_id" : 23624871,
      "reputation" : 450,
      "user_id" : 17657568,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dca1bff50a3af1c3421aae288870e281?s=256&d=identicon&r=PG",
      "display_name" : "AMZ",
      "link" : "https://stackoverflow.com/users/17657568/amz"
    },
    "is_answered" : true,
    "view_count" : 53,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1765564227,
    "creation_date" : 1765559358,
    "link" : "https://stackoverflow.com/questions/79845091/spring-webflux-does-not-catch-exception",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79845150,
    "question_id" : 79845091,
    "body" : "<p>this is expected behavior since you are returning a stream of T objects (a Flux). Which means that if your stream throws an exception it will disconnect, and it will log the exception. You cant do anything about it.</p>\n<p>A ControllerAdvice can not catch exceptions that are in a Flux stream. Only Before or After the Stream, because once the Headers are sent the response is committed, the ControllerAdvice does not have access to the Flux sink.</p>\n<p>If you insist on that you suddenly want to change what you are emitting you need to use the onErrorResume operator after the flux and return your error object.</p>\n<pre><code>@GetMapping(value = &quot;/stream&quot;, produces = MediaType.APPLICATION_NDJSON_VALUE)\npublic Flux&lt;ResponseMessage&gt; stream() {\n    return service.getFlux()\n        .map(data -&gt; new ResponseMessage(&quot;data&quot;, data))\n        .onErrorResume(e -&gt; Flux.just(\n            new ResponseMessage(&quot;error&quot;, Map.of(\n                &quot;message&quot;, e.getMessage(),\n                &quot;type&quot;, e.getClass().getSimpleName()\n            ))\n        ));\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2064278,
      "reputation" : 15107,
      "user_id" : 1840146,
      "user_type" : "registered",
      "accept_rate" : 86,
      "profile_image" : "https://i.sstatic.net/JXdxm.png?s=256",
      "display_name" : "Toerktumlare",
      "link" : "https://stackoverflow.com/users/1840146/toerktumlare"
    },
    "creation_date" : 1765564227,
    "last_activity_date" : 1765564227,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79845150" : [ {
      "comment_id" : 140902754,
      "post_id" : 79845150,
      "body" : "@AMZ workflow? i dont understand what you mean. if you feel something is missing in the answer, you edit your question and update it with a more elaborate question, that specificially goes into detail of what information it is you seek. Im not going to have a conversation in the comments.",
      "score" : 0,
      "owner" : {
        "account_id" : 2064278,
        "reputation" : 15107,
        "user_id" : 1840146,
        "user_type" : "registered",
        "accept_rate" : 86,
        "profile_image" : "https://i.sstatic.net/JXdxm.png?s=256",
        "display_name" : "Toerktumlare",
        "link" : "https://stackoverflow.com/users/1840146/toerktumlare"
      },
      "creation_date" : 1765706772,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}