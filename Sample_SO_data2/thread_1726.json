{
  "question" : {
    "question_id" : 79683897,
    "title" : "Flink FlatMap &quot;Could not forward element to next operator&quot;",
    "body" : "<p>I'm working on a Flink batch job that reads JSON strings from Kafka, converts them into Avro <code>GenericRecords</code>, and writes them to Parquet using <code>AvroParquetWriters</code>.</p>\n<p>The JSON messages look like this:</p>\n<p><code>{&quot;user_id&quot;:914,&quot;message&quot;:&quot;User login&quot;,&quot;timestamp&quot;:&quot;2025-06-29&quot;}</code></p>\n<p>My Avro schema file <code>log_schema.avsc</code> contains:</p>\n<pre><code>{\n  &quot;type&quot;: &quot;record&quot;,\n  &quot;name&quot;: &quot;UserLog&quot;,\n  &quot;namespace&quot;: &quot;com.example&quot;,\n  &quot;fields&quot;: [\n    { &quot;name&quot;: &quot;user_id&quot;, &quot;type&quot;: &quot;int&quot; },\n    { &quot;name&quot;: &quot;message&quot;, &quot;type&quot;: &quot;string&quot; },\n    { &quot;name&quot;: &quot;timestamp&quot;, &quot;type&quot;: &quot;string&quot; }\n  ]\n}\n</code></pre>\n<p>In the code, I use a <code>FlatMapFunction</code> to parse JSON and emit <code>GenericRecord</code> objects:</p>\n<pre><code>    .flatMap(new FlatMapFunction&lt;String, GenericRecord&gt;() {\n    private final ObjectMapper mapper = new ObjectMapper();\n\n    @Override\n    public void flatMap(String json, Collector&lt;GenericRecord&gt; out) {\n        try {\n            JsonNode node = mapper.readTree(json);\n            GenericRecord record = new GenericData.Record(schema);\n            record.put(&quot;user_id&quot;, node.get(&quot;user_id&quot;).asInt());\n            record.put(&quot;message&quot;, node.get(&quot;message&quot;).asText());\n            record.put(&quot;timestamp&quot;, node.get(&quot;timestamp&quot;).asText());\n            out.collect(record);\n        } catch (Exception e) {\n            System.err.println(&quot;Invalid JSON: &quot; + json + &quot; → &quot; + e.getMessage());\n        }\n    }\n})\n.returns(TypeInformation.of(GenericRecord.class));\n</code></pre>\n<p>Then I write the parsed stream to a Parquet file sink:</p>\n<pre><code>FileSink&lt;GenericRecord&gt; sink = FileSink\n    .forBulkFormat(new Path(&quot;file:///output/&quot;), AvroParquetWriters.forGenericRecord(schema))\n    .build();\n\nparsedStream.sinkTo(sink);\n</code></pre>\n<p>Although the JSON string is valid and matches the Avro schema, I get the following error:</p>\n<pre><code>Invalid JSON: {&quot;user_id&quot;:914,&quot;message&quot;:&quot;User login&quot;,&quot;timestamp&quot;:&quot;2025-06-29&quot;} → Could not forward element to next operator\n</code></pre>\n",
    "tags" : [ "java", "apache-kafka", "apache-flink", "avro", "flink-streaming" ],
    "owner" : {
      "account_id" : 21965267,
      "reputation" : 41,
      "user_id" : 16242616,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/76e02cbbd7f1b6548d7445a2abcc6f81?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tuan Duy",
      "link" : "https://stackoverflow.com/users/16242616/tuan-duy"
    },
    "is_answered" : false,
    "view_count" : 148,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1751311489,
    "creation_date" : 1751215771,
    "link" : "https://stackoverflow.com/questions/79683897/flink-flatmap-could-not-forward-element-to-next-operator",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140554071,
    "post_id" : 79683897,
    "body" : "The &quot;Invalid JSON&quot; is your own error message... Never catch plain Exception. The Avro functions don&#39;t need to be in the same try block. Add unit tests around your JSON reader and expected inputs",
    "score" : 0,
    "owner" : {
      "account_id" : 2671330,
      "reputation" : 193048,
      "user_id" : 2308683,
      "user_type" : "registered",
      "accept_rate" : 90,
      "profile_image" : "https://www.gravatar.com/avatar/fb8f5877d244f223b4b6d29e0afb3a4e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "OneCricketeer",
      "link" : "https://stackoverflow.com/users/2308683/onecricketeer"
    },
    "creation_date" : 1751311763,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}