{
  "question" : {
    "question_id" : 79689706,
    "title" : "Query regarding event persistence and projection completion status check",
    "body" : "<p>Is there a way I can check the status of projection for a Pekko/Spring Boot app somehow, as I want to trigger next event only after one projection gives status OK.</p>\n<pre class=\"lang-java prettyprint-override\"><code>private CommandHandlerWithReplyBuilderByState&lt;Command, Event, State, State&gt; onEmpty() {\n    return newCommandHandlerWithReplyBuilder()\n            .forState(State::isEmpty)\n            .onCommand(Create.class, (state, cmd) -&gt; {\n              if(cmd.isInitialAutoStart()) {\n                List&lt;Event&gt; events = new ArrayList&lt;&gt;();\n                events.add(new CampaignCreated(cmd.getCampaignId(),\n                        OffsetDateTime.now(ZoneOffset.UTC), cmd.getName(),\n                        cmd.getDomainGroupId(), cmd.getDomainIdWithCount(), cmd.getContactListId(),\n                        cmd.getContactSegmentId(), cmd.getRouteId(),\n                        cmd.getOfferId(), cmd.getVertical(),\n                        cmd.getContactSkipOffset(), cmd.getSendSpeed(),\n                        cmd.getCampaignOptimization(), cmd.getDataTriggers(),\n                        cmd.getDegreeOfParallelism(), cmd.getContactFilter(),\n                        cmd.getMessageTemplate(), cmd.getMessageTemplateId(),\n                        cmd.getSaveProgressEvery(), cmd.isInitialAutoStart(), cmd.getCampaignScheduledTime(), cmd.getStartOption(),\n                        cmd.getScheduleChronExpression(),\n                        cmd.getWebHooks(), cmd.getSliceSize(), cmd.getNetworkCarrierFilter()));\n                events.add(new CampaignResuming(cmd.getCampaignId(), OffsetDateTime.now(ZoneOffset.UTC), 0));\n                return Effect()\n                        .persist(events)\n                        .thenRun(newState -&gt; {\n                          this.campaignRunner = spawnCampaignRunner(newState, this.context,\n                                  this.campaignService, this.outboundCampaignMessageService, this.contactService, this.suppressedContactService,\n                                  this.leadService, this.domainGroupService, this.domainService, this.offerService,\n                                  this.routeService, this.clickService, this.webClientBuilder);\n                        })\n                        .thenReply(cmd.getReplyTo(), newState -&gt; StatusReply.ack());\n              }\n              return Effect().persist(new CampaignCreated(cmd.getCampaignId(),\n                              OffsetDateTime.now(ZoneOffset.UTC), cmd.getName(),\n                              cmd.getDomainGroupId(),cmd.getDomainIdWithCount(), cmd.getContactListId(),\n                              cmd.getContactSegmentId(), cmd.getRouteId(),\n                              cmd.getOfferId(), cmd.getVertical(),\n                              cmd.getContactSkipOffset(), cmd.getSendSpeed(),\n                              cmd.getCampaignOptimization(), cmd.getDataTriggers(),\n                              cmd.getDegreeOfParallelism(), cmd.getContactFilter(),\n                              cmd.getMessageTemplate(), cmd.getMessageTemplateId(),\n                              cmd.getSaveProgressEvery(), false, cmd.getCampaignScheduledTime(), cmd.getStartOption(),\n                              cmd.getScheduleChronExpression(),\n                              cmd.getWebHooks(), cmd.getSliceSize(), cmd.getNetworkCarrierFilter()))\n                      .thenReply(cmd.getReplyTo(), newState -&gt; StatusReply.ack());\n            })\n            .onCommand(Edit.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(Pause.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(ProcessCompleted.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(ProcessFailed.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(Resume.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(ProcessSaveProgress.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)))\n            .onCommand(ProcessRunning.class, (state, cmd) -&gt; Effect().none().thenNoReply())\n            .onCommand(ProcessPaused.class, (state, cmd) -&gt; Effect().none().thenNoReply())\n            .onCommand(AddCustomRevenue.class, (state, cmd) -&gt; Effect().reply(cmd.getReplyTo(), StatusReply.error(&quot;Campaign doesn't exists.&quot;)));\n}\n</code></pre>\n<p>Here I want to wait for campaignCreated to be persisted and projection to get completed, only then I want to resume the campaign and spawn campaignRunner.</p>\n<p>Please let me know if there are any way for this.</p>\n",
    "tags" : [ "java", "spring-boot", "akka", "pekko" ],
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "is_answered" : false,
    "view_count" : 86,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1751864675,
    "creation_date" : 1751607260,
    "link" : "https://stackoverflow.com/questions/79689706/query-regarding-event-persistence-and-projection-completion-status-check",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79692332,
    "question_id" : 79689706,
    "body" : "<p>Problem was race condition where insert was taking 3 to 4 seconds and before that update command was triggered. I changed toe flow by enforcing insertion in db first and then going for actor creation of the specific type.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "creation_date" : 1751864675,
    "last_activity_date" : 1751864675,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140569633,
    "post_id" : 79689706,
    "body" : "Yes sir It was race condition and now we have strong proof for that as well It was indeed due to slow insert operation in prod db thanks for all of your insights.",
    "score" : 0,
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "creation_date" : 1751864586,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565330,
    "post_id" : 79689706,
    "body" : "Sounds like you are having some kind of race condition. The solution depends how your system is design. Events for the same entity ID are processed in the order they were persisted. Depends on your journal how you can achieve strong consistency",
    "score" : 0,
    "owner" : {
      "account_id" : 9727861,
      "reputation" : 3851,
      "user_id" : 7214091,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-xe-rKubDCeg/AAAAAAAAAAI/AAAAAAAAALQ/OmUxxZwJndU/s256-rj/photo.jpg",
      "display_name" : "Gast&#243;n Schabas",
      "link" : "https://stackoverflow.com/users/7214091/gast%c3%b3n-schabas"
    },
    "creation_date" : 1751640990,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565093,
    "post_id" : 79689706,
    "body" : "Also can i add 10s retry check for update that update should check for campaign table to wait for 10s before applying update? Like will it affect my app performance ?",
    "score" : 0,
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "creation_date" : 1751635381,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565026,
    "post_id" : 79689706,
    "body" : "Thanks for replying sir but for saving cost on AWS we have downgraded resources which is causing delay in create commit operation and update projection is triggered before create projection is written to db . Is there any work around to bypass this as devops team is not ready for changes Also I am adding snippets for my Actor class to help you.",
    "score" : 0,
    "owner" : {
      "account_id" : 42801925,
      "reputation" : 1,
      "user_id" : 30929853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4215736b5c2debe8177eb292ef3d11c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Aryan Dwivedi",
      "link" : "https://stackoverflow.com/users/30929853/aryan-dwivedi"
    },
    "creation_date" : 1751633661,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140564000,
    "post_id" : 79689706,
    "body" : "What do you mean with query the status? Sounds like you want to ask to the projection if something happened. The idea of the projection is to do something when a event is persisted. You can do a CRUD on a database, send a message to a message queue, send a http request to an endpoint, etc. Instead of checking for a value, you can react to events",
    "score" : 1,
    "owner" : {
      "account_id" : 9727861,
      "reputation" : 3851,
      "user_id" : 7214091,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-xe-rKubDCeg/AAAAAAAAAAI/AAAAAAAAALQ/OmUxxZwJndU/s256-rj/photo.jpg",
      "display_name" : "Gast&#243;n Schabas",
      "link" : "https://stackoverflow.com/users/7214091/gast%c3%b3n-schabas"
    },
    "creation_date" : 1751608210,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}