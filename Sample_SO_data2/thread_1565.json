{
  "question" : {
    "question_id" : 79697873,
    "title" : "iText XMLWorker: PDF generation fails with &quot;Invalid nested tag tr found, expected closing tag td&quot; when data contains special characters",
    "body" : "<p>I know this issue has come up before, but I haven't found any solutions that work.</p>\n<p>I'm using iText's XMLWorker to <strong>generate PDFs from HTML templates in a Java backend</strong>.\nRecently, I started getting this error:</p>\n<blockquote>\n<p>Invalid nested tag tr found, expected closing tag td</p>\n</blockquote>\n<p>But when i validate the html file using this <code>https://html.onlineviewer.net/</code>, it seems fine.</p>\n<p>Upon further debugging, I found that if any variable contains special characters (like &amp;), it breaks.\nFor example, passing &quot;T&amp;T&quot; in <code>$data.var1$</code> produces the error above. While, If I write &quot;T&amp;T TEST&quot;, it works fine.</p>\n<p>My questions:</p>\n<ol>\n<li>Is there a way to automatically escape all variables in the template, or do I need to manually escape every value before passing it to the template?</li>\n<li>Is there a setting in XMLWorker, StringTemplate, or elsewhere that can handle this automatically?</li>\n<li>What is the best practice for handling this, especially when there are many variables and it's hard to know which ones might contain special characters?</li>\n</ol>\n<p><strong>Error</strong></p>\n<pre><code>com.itextpdf.tool.xml.exceptions.RuntimeWorkerException: Invalid nested tag tr found, expected closing tag td.\n    at com.itextpdf.tool.xml.XMLWorker.endElement(XMLWorker.java:134)\n    at com.itextpdf.tool.xml.parser.XMLParser.endElement(XMLParser.java:403)\n    at com.itextpdf.tool.xml.parser.state.ClosingTagState.process(ClosingTagState.java:70)\n    at com.itextpdf.tool.xml.parser.XMLParser.parseWithReader(XMLParser.java:238)\n    at com.itextpdf.tool.xml.parser.XMLParser.parse(XMLParser.java:216)\n    at com.itextpdf.tool.xml.parser.XMLParser.parse(XMLParser.java:177)\n    at com.itextpdf.tool.xml.XMLWorkerHelper.parseXHtml(XMLWorkerHelper.java:238)\n    at com.itextpdf.tool.xml.XMLWorkerHelper.parseXHtml(XMLWorkerHelper.java:210)\n    at com.itextpdf.tool.xml.XMLWorkerHelper.parseXHtml(XMLWorkerHelper.java:183)\n    at com.ekart.citylogistics.docsvc.PDFGenerator.generatePdfDocumentFromStringTemplate(PDFGenerator.java:80)\n    at com.ekart.citylogistics.docsvc.PDFGenerator.generateFile(PDFGenerator.java:39)\n    at com.ekl.bifrost.hub.utils.FileUtil.generateFile(FileUtil.java:53)\n</code></pre>\n<p><strong>This is the code which generates the pdf</strong></p>\n<pre><code>    public static InputStream generateFile(Object data) {\n        DocumentGenerator documentGenerator = DocumentGeneratorFactory.getDocumentGenerator(DocumentType.PDF);\n        byte[] bytes = documentGenerator.generateFile(data, Constants.POD_TEMPLATE_ROOT_DIR,\n                Constants.POD_TEMPLATE_FILE_NAME, TemplateType.STRINGTEMPLATE);\n        InputStream inputStream = new ByteArrayInputStream(bytes);\n        return inputStream;\n    }\n</code></pre>\n<p><strong>And we're using this string template file</strong></p>\n<pre><code>&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;\n&lt;head&gt;\n    &lt;title&gt;File needs to be shared&lt;/title&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/reset.css' %}&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/margin.css' %}&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/padding.css' %}&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/fkl_base.css' %}&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot;  type=&quot;text/css&quot; /&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/utils.css' %}&quot; media=&quot;all&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n    &lt;link href=&quot;{% get_service_url 'doc','stylesheets/print.css' %}&quot; media=&quot;print&quot; rel=&quot;stylesheet&quot; type=&quot;text/css&quot; /&gt;\n\n&lt;/head&gt;\n\n&lt;body&gt;\n&lt;div&gt;\n\n    &lt;div class=&quot;fk-text-center&quot; align=&quot;center&quot;&gt;&lt;b&gt;XYZ Private Limited&lt;/b&gt;&lt;/div&gt;\n    &lt;br /&gt;\n    &lt;div class=&quot;fk-text-center&quot; align=&quot;center&quot;&gt;Heading 1&lt;/div&gt;\n    &lt;br /&gt;\n    &lt;div class=&quot;fk-text-center&quot; align=&quot;center&quot;&gt;Heading 2&lt;/div&gt;\n    &lt;br /&gt;\n    &lt;div class=&quot;fk-text-center&quot; align=&quot;center&quot;&gt;Heading 3&lt;/div&gt;\n    &lt;br /&gt;&lt;br /&gt;\n\n    &lt;table border=&quot;0&quot;&gt;\n        &lt;tr&gt;\n            &lt;td&gt;&lt;b&gt;Var1:&lt;/b&gt;&lt;/td&gt;\n            &lt;td&gt;&lt;pre&gt;      &lt;/pre&gt;$data.var1$&lt;/td&gt;\n        &lt;/tr&gt;\n    &lt;/table&gt;\n    &lt;br /&gt;&lt;br /&gt;\n\n&lt;/div&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>\n",
    "tags" : [ "java", "itext", "pdf-generation", "html-to-pdf", "xmlworker" ],
    "owner" : {
      "account_id" : 16979778,
      "reputation" : 9,
      "user_id" : 12282078,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fc36f66aabb604bf177fc6d12339d114?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ansh Bargoti",
      "link" : "https://stackoverflow.com/users/12282078/ansh-bargoti"
    },
    "is_answered" : false,
    "view_count" : 110,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1752421346,
    "creation_date" : 1752212173,
    "link" : "https://stackoverflow.com/questions/79697873/itext-xmlworker-pdf-generation-fails-with-invalid-nested-tag-tr-found-expecte",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140586837,
    "post_id" : 79697873,
    "body" : "<i>&quot;So, I just have to blindly use escapeHtml for all the string text?&quot;</i> - no, not blindly. You have to do so knowingly. E.g. you have to be aware that you can include tags for bold or italics only in element content, not in attribute content etc.",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97023,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1752447513,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140582016,
    "post_id" : 79697873,
    "body" : "So, I just have to blindly use escapeHtml for all the string text?",
    "score" : 0,
    "owner" : {
      "account_id" : 16979778,
      "reputation" : 9,
      "user_id" : 12282078,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fc36f66aabb604bf177fc6d12339d114?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ansh Bargoti",
      "link" : "https://stackoverflow.com/users/12282078/ansh-bargoti"
    },
    "creation_date" : 1752228215,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140582012,
    "post_id" : 79697873,
    "body" : "@S&#246;ren Yes we&#39;re using a internal library which has just a template code to call the parseXhtml of itextpdf jar",
    "score" : 0,
    "owner" : {
      "account_id" : 16979778,
      "reputation" : 9,
      "user_id" : 12282078,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fc36f66aabb604bf177fc6d12339d114?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ansh Bargoti",
      "link" : "https://stackoverflow.com/users/12282078/ansh-bargoti"
    },
    "creation_date" : 1752228177,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581799,
    "post_id" : 79697873,
    "body" : "@mkl oh, thanks.",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1752222192,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581788,
    "post_id" : 79697873,
    "body" : "@S&#246;ren the iText XMLWorker merely is a html-to-pdf converter, it is not a template engine and doesn&#39;t support variables. So apparently the op does string replacement in the html to support variables. Thus, the op also is responsible for html escaping their variable replacements.",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97023,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1752221925,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581771,
    "post_id" : 79697873,
    "body" : "@goose I&#39;d expect a templating engine to handle the markup.",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1752221578,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581770,
    "post_id" : 79697873,
    "body" : "Indeed, just as @g00se said, when doing text replacement in html, you have to take care to keep the html valid!",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97023,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1752221558,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581768,
    "post_id" : 79697873,
    "body" : "What is <code>com.ekart.citylogistics.docsvc.PDFGenerator</code>? Is that a library you use, or is that your code?",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1752221544,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140581726,
    "post_id" : 79697873,
    "body" : "Isn&#39;t the problem that you&#39;ve got invalid markup? Eg that should have been <code>T&amp;amp;T</code>",
    "score" : 2,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1752219976,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}