{
  "question" : {
    "question_id" : 79669107,
    "title" : "Non-Blocking ncurses getch() in Java FFM",
    "body" : "<p>I have a Rust function named <code>init</code> that calls the following ncurses functions (in the following order): <code>initscr()</code>, <code>cbreak()</code>, <code>keypad(stdscr, TRUE)</code>, <code>getch()</code> followed by <code>endwin()</code>.</p>\n<p>The <code>init</code> function looks something like this:</p>\n<pre><code>#[unsafe(no_mangle)]\npub extern &quot;C&quot; fn init() {\n    unsafe {\n        _init();\n    }\n}\n</code></pre>\n<p>Where <code>_init</code> is an ffi function declared as so:</p>\n<pre><code>#[link(...)]\nunsafe extern &quot;C&quot; {\n    pub fn _init();\n}\n</code></pre>\n<p>This function is implemented in C as such:</p>\n<pre><code>void _init() {\n    initscr();\n    cbreak();\n    keypad(stdscr, TRUE);\n    getch();\n    endwin();\n}\n</code></pre>\n<p>This rust library is compiled as a dynamic C library (.so)</p>\n<p>My Java code looks like this:</p>\n<pre><code>public class Init {\n  public void init() throws RuntimeException {\n    Linker linker = Linker.nativeLinker();\n\n    try(Arena arena = Arena.ofConfined()) {\n      SymbolLookup lookup = SymbolLookup.libraryLookup(Path.of(...), arena);\n\n      Optional&lt;MemorySegment&gt; optionalInitAddress = lookup.find(&quot;init&quot;);\n\n      if(optionalInitAddress.isPresent()) {\n        MemorySegment initAddr = optionalInitAddress.get();\n        FunctionDescriptor initDesc = FunctionDescriptor.ofVoid();\n        MethodHandle init = linker.downcallHandle(initAddr, initDesc);\n\n        init.invoke();\n      } else {\n        throw new NoSuchElementException();\n      }\n    } catch(Throwable e) {\n      throw new RuntimeException(e);\n    }\n  }\n}\n</code></pre>\n<p>When I call this function from Java using the FFM API, my terminal just flickers and the program ends without waiting for <code>getch()</code>.</p>\n<p>On further inspection, the <code>getch</code> and <code>cbreak</code> functions are giving an error code of -1 (only when executed from Java), and the other functions are giving an error code of 0.</p>\n<p>I'm not sure why Java is exhibiting this weird behaviour.</p>\n<p>I am compiling and running this Java program via gradle.</p>\n<p>Some insight on this would be helpful.</p>\n",
    "tags" : [ "java", "rust", "interop", "ncurses", "java-ffm" ],
    "owner" : {
      "account_id" : 37849865,
      "reputation" : 117,
      "user_id" : 28460288,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/IMpM9BWk.jpg?s=256",
      "display_name" : "Radon",
      "link" : "https://stackoverflow.com/users/28460288/radon"
    },
    "is_answered" : true,
    "view_count" : 234,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1751264200,
    "creation_date" : 1750164598,
    "link" : "https://stackoverflow.com/questions/79669107/non-blocking-ncurses-getch-in-java-ffm",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79684310,
    "question_id" : 79669107,
    "body" : "<p>This issue was happening because the application was run using gradle with the <code>run</code> task defined by the <code>application</code> plugin.</p>\n<p>The issue was fixed when I ran the program (executable jar) directly via the terminal, without using gradle.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 37849865,
      "reputation" : 117,
      "user_id" : 28460288,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/IMpM9BWk.jpg?s=256",
      "display_name" : "Radon",
      "link" : "https://stackoverflow.com/users/28460288/radon"
    },
    "creation_date" : 1751264200,
    "last_activity_date" : 1751264200,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140528490,
    "post_id" : 79669107,
    "body" : "@Slaw, Yes, I am using the <code>application</code> plugin and the <code>run</code> task to execute the application and yes.... Gradle is the cause of this problem. I did manage to fix it by running the application directly without using gradle. Thanks for the SO post.",
    "score" : 0,
    "owner" : {
      "account_id" : 37849865,
      "reputation" : 117,
      "user_id" : 28460288,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/IMpM9BWk.jpg?s=256",
      "display_name" : "Radon",
      "link" : "https://stackoverflow.com/users/28460288/radon"
    },
    "creation_date" : 1750395334,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140527452,
    "post_id" : 79669107,
    "body" : "You mention Gradle. Are you using the <code>application</code> plugin, specifically the <code>run</code> task provided by that plugin, to execute your application? If you are then my guess is that your Java application has no standard input/terminal, and so ncurses fails. See <a href=\"https://stackoverflow.com/q/13172137/6395627\">Console application with Java and gradle</a> for a potential solution.",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1750353014,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140524272,
    "post_id" : 79669107,
    "body" : "What do you mean by &#39;assign&#39; stdscr?",
    "score" : 0,
    "owner" : {
      "account_id" : 37849865,
      "reputation" : 117,
      "user_id" : 28460288,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/IMpM9BWk.jpg?s=256",
      "display_name" : "Radon",
      "link" : "https://stackoverflow.com/users/28460288/radon"
    },
    "creation_date" : 1750261839,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140524120,
    "post_id" : 79669107,
    "body" : "You don&#39;t appear to have checked return values, and not assigned stdscr. Adding print msgs in Java and Rust code will tell you how far it ran, and print out return values.",
    "score" : 0,
    "owner" : {
      "account_id" : 5998820,
      "reputation" : 16284,
      "user_id" : 4712734,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6e922a2cb7e2da59286f27b162aaca5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "DuncG",
      "link" : "https://stackoverflow.com/users/4712734/duncg"
    },
    "creation_date" : 1750259463,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140522339,
    "post_id" : 79669107,
    "body" : "@DuncG There are no errors involved. The program runs without any errors",
    "score" : 0,
    "owner" : {
      "account_id" : 37849865,
      "reputation" : 117,
      "user_id" : 28460288,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/IMpM9BWk.jpg?s=256",
      "display_name" : "Radon",
      "link" : "https://stackoverflow.com/users/28460288/radon"
    },
    "creation_date" : 1750216516,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140521120,
    "post_id" : 79669107,
    "body" : "As well as <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, add error code, error messages and stack trace, if any apply.",
    "score" : 1,
    "owner" : {
      "account_id" : 5998820,
      "reputation" : 16284,
      "user_id" : 4712734,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6e922a2cb7e2da59286f27b162aaca5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "DuncG",
      "link" : "https://stackoverflow.com/users/4712734/duncg"
    },
    "creation_date" : 1750176922,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140520693,
    "post_id" : 79669107,
    "body" : "Include the Java <i>and Rust</i> code in your <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>.",
    "score" : 2,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49904,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1750170164,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140520655,
    "post_id" : 79669107,
    "body" : "How did you implemented the call from Java? Share a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>.",
    "score" : 2,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1750169633,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}