{
  "question" : {
    "question_id" : 79842502,
    "title" : "is @Transactional(isolation = Isolation.REPEATABLE_READ) enough for safe incrementing?",
    "body" : "<p>Is it possible to lost increment here? If not, is it possible in case of read_commited level?</p>\n<pre><code>@Transactional\npublic updateProductStatistics(Long productId) {\n        ProductStats stats = productStatsRepository.findByProductId(productId);\n        stats.setTotalSold(stats.getTotalSold() + 1); // lost increment?\n        productStatsRepository.save(stats);\n    }\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-data-jpa", "transactions" ],
    "owner" : {
      "account_id" : 15096004,
      "reputation" : 3191,
      "user_id" : 10894456,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/088b89cc035266c3d62b8578c7c4d9fa?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "J.J. Beam",
      "link" : "https://stackoverflow.com/users/10894456/j-j-beam"
    },
    "is_answered" : true,
    "view_count" : 78,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1765431824,
    "creation_date" : 1765332229,
    "link" : "https://stackoverflow.com/questions/79842502/is-transactionalisolation-isolation-repeatable-read-enough-for-safe-increme",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79843632,
    "question_id" : 79842502,
    "body" : "<p>Lost increment is impossible with REPEATABLE_READ isolation level (at least in PostgreSQL)</p>\n<p>There are solutions for READ_COMMITTED:</p>\n<ol>\n<li>You can use <strong>select for update</strong> for locking data</li>\n</ol>\n<pre class=\"lang-sql prettyprint-override\"><code>select * from product_stats where id = ? for update\n</code></pre>\n<p>See @Lock annotation In Spring Data</p>\n<ol>\n<li>Or you can increment value in one query</li>\n</ol>\n<pre class=\"lang-sql prettyprint-override\"><code>update product_stats set total_sold=total_sold + 1 where id = ?\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1068934,
      "reputation" : 570,
      "user_id" : 1068672,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/43d68d73604ff2a435f38a8a9fd76caa?s=256&d=identicon&r=PG",
      "display_name" : "Sergey Raishin",
      "link" : "https://stackoverflow.com/users/1068672/sergey-raishin"
    },
    "creation_date" : 1765431824,
    "last_activity_date" : 1765431824,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140896396,
    "post_id" : 79842502,
    "body" : "what db engine are you on?",
    "score" : 0,
    "owner" : {
      "account_id" : 4181375,
      "reputation" : 6263,
      "user_id" : 3426309,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/v58O6.jpg?s=256",
      "display_name" : "Andrey B. Panfilov",
      "link" : "https://stackoverflow.com/users/3426309/andrey-b-panfilov"
    },
    "creation_date" : 1765377781,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79843632" : [ {
      "comment_id" : 140897663,
      "post_id" : 79843632,
      "body" : "@J It seems that using a &#39;for share&#39; can throw a deadlock.  t1: select .. for share  -&gt;ok  t2: select .. for share -&gt; ok    next update operation will be blocked in t1 and t2.",
      "score" : 0,
      "owner" : {
        "account_id" : 1068934,
        "reputation" : 570,
        "user_id" : 1068672,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/43d68d73604ff2a435f38a8a9fd76caa?s=256&d=identicon&r=PG",
        "display_name" : "Sergey Raishin",
        "link" : "https://stackoverflow.com/users/1068672/sergey-raishin"
      },
      "creation_date" : 1765444768,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140897531,
      "post_id" : 79843632,
      "body" : "how about   select * from product_stats where id = ? for share    ?",
      "score" : 0,
      "owner" : {
        "account_id" : 15096004,
        "reputation" : 3191,
        "user_id" : 10894456,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/088b89cc035266c3d62b8578c7c4d9fa?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "J.J. Beam",
        "link" : "https://stackoverflow.com/users/10894456/j-j-beam"
      },
      "creation_date" : 1765437593,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}