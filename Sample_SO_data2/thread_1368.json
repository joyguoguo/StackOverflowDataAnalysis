{
  "question" : {
    "question_id" : 79718269,
    "title" : "Uploading a file (PutObject) using aws-sdk with an InputStream received from a Mutlipart request",
    "body" : "<p>I am using aws-sdk to work with corporate S3 compatible storage. My S3 client configuration looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic S3Client s3Client() {\n    return S3Client.builder()\n            .endpointOverride(URI.create(properties.getS3().getEndpoint()))\n            .region(Region.of(properties.getS3().getRegion()))\n            .credentialsProvider(StaticCredentialsProvider.create(\n                    AwsBasicCredentials.create(\n                            properties.getS3().getAccessKey(),\n                            properties.getS3().getSecretKey()\n                    )\n            ))\n            .serviceConfiguration(builder -&gt;\n                    builder.chunkedEncodingEnabled(properties.getS3().getChunkedEncodingEnabled()))\n            .forcePathStyle(properties.getS3().getPathStyle())\n            .build();\n}\n</code></pre>\n<p><em>the chunked upload setting is intentional, because my storage provider does not fully support it (i.e. I have it disabled).</em></p>\n<p>I am trying to upload a file to S3 by receiving it from the user in the API as a multipart request (the file is passed to the application API as a multipart request). But when uploading, I get an error like:</p>\n<blockquote>\n<p>The request content has fewer bytes than the specified content-length: N bytes.</p>\n</blockquote>\n<p>I tried wrapping the original <code>InputStream</code> in <code>BufferedInputStream</code> as suggested <a href=\"https://github.com/aws/aws-sdk-java-v2/issues/6174\" rel=\"nofollow noreferrer\">here</a> (even though the javadoc of <code>RequestBody.fromInputStream</code> says that automatic wrapping occurs if the original stream does not support mark/reset, then I get an error when trying to create <code>BufferedInputStream</code>:</p>\n<blockquote>\n<p>Caused by: java.io.IOException: Resetting to invalid mark</p>\n</blockquote>\n<p>My upload code looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    try (InputStream is = resource.getInputStream()){\n        PutObjectResponse putObjectResponse = s3Client.putObject(PutObjectRequest.builder()\n                .bucket(properties.getS3().getBucketName())\n                .key(resource.getFilename())\n                .build(), RequestBody.fromInputStream(is, resource.contentLength()));\n        return S3SavedFile.builder()\n                .key(resource.getFilename())\n                .size(putObjectResponse.size())\n                .build();\n    } catch (Exception e) {\n        throw e;\n    }\n</code></pre>\n<p><em>where <code>resource</code> is <code>MultipartFileResource</code> and <code>resource.getInputStream()</code> returns <code>ChannelInputStream</code>.</em></p>\n<p>Please tell me if it is possible to somehow upload a file to S3 using <code>InputStream</code> from the original multipart request?</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "amazon-s3", "aws-sdk" ],
    "owner" : {
      "account_id" : 19581210,
      "reputation" : 95,
      "user_id" : 14330235,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dbf569be554f23aacc692cfc77531d97?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "morohon",
      "link" : "https://stackoverflow.com/users/14330235/morohon"
    },
    "is_answered" : false,
    "view_count" : 178,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1753775196,
    "creation_date" : 1753775196,
    "link" : "https://stackoverflow.com/questions/79718269/uploading-a-file-putobject-using-aws-sdk-with-an-inputstream-received-from-a-m",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}