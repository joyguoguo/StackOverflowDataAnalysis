{
  "question" : {
    "question_id" : 79677621,
    "title" : "StatelessKieSession doesn&#39;t appear thread safe",
    "body" : "<p>I'm trying to optimize a section of the app by switching the single processing of a collection into running parallel under a lambda function.</p>\n<p>I am building my KieContainer once as follows:</p>\n<pre><code>/**\n * From a decision table, create a rule base.\n * @param is the input stream to read\n * @return a rule container\n */\npublic KieContainer getKieContainerFromStream(InputStream is) throws IOException {\n    SpreadsheetCompiler spreadsheetCompiler = new SpreadsheetCompiler();\n    String rules = spreadsheetCompiler.compile(is, InputType.CSV);\n    log.info(&quot;rules:&quot; + rules);\n    File rulesFile = FileUtil.stringToFile(rules, &quot;rule&quot;, &quot;.drl&quot;);\n\n    KieFileSystem kieFileSystem = kieServices.newKieFileSystem();\n    Resource resource = ResourceFactory.newFileResource(rulesFile);\n    kieFileSystem.write(resource);\n    KieBuilder kieBuilder = kieServices.newKieBuilder(kieFileSystem);\n    kieBuilder.buildAll();\n    KieModule kieModule = kieBuilder.getKieModule();\n    KieContainer result = kieServices.newKieContainer(kieModule.getReleaseId());\n\n    return result;\n}\n</code></pre>\n<p>As you can see, I'm using a CSV decision table.</p>\n<p>Now I inject that container into my object and run the following code inside my lambda.</p>\n<pre><code>protected void checkTheRules(PostponementRequest request) {\n    StatelessKieSession kieSession = getPostponementRulesContainer().newStatelessKieSession();\n\n    //apply the data\n    PoolInfo pool = request.getPart().getActivePool();\n\n    _log.debug(&quot;validating date for: courtLocation=&quot; + pool.getCourtLocation() +\n            &quot;, daysBeforeSummons=&quot; + pool.getDaysBeforeSummons() +\n            &quot;, requestDaysAfterSummons=&quot; + request.getRequestDaysAfterSummons() +\n            &quot;, requestDaysAfterOrigSummons=&quot; + request.getRequestDaysAfterOrigSummons() +\n            &quot;, requestedDayOfWeek=&quot; + request.getRequestedDayOfWeek() +\n            &quot;, requestedDayOfMonth=&quot; + request.getRequestedDayOfMonth()\n    );\n\n    List&lt;String&gt; list = new LinkedList&lt;&gt;();\n    List&lt;Object&gt; parms = Arrays.asList(pool, request, list);\n    kieSession.execute(parms);\n}\n</code></pre>\n<p>Now let's say my loop contains 50 items that I'm looping through. That's 50 separate StatelessKieSession in 50 different threads. Every once in a while they will all work, but usually, I get the following one time:</p>\n<pre><code>jakarta.servlet.ServletException: Handler dispatch failed: java.lang.ExceptionInInitializerError\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1104) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:622) ~[servlet-api.jar:6.1]\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:710) ~[servlet-api.jar:6.1]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:130) ~[catalina.jar:11.0.8-dev]\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53) ~[tomcat-websocket.jar:11.0.8-dev]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:109) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.ApplicationDispatcher.invoke(ApplicationDispatcher.java:514) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.ApplicationDispatcher.processRequest(ApplicationDispatcher.java:334) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.ApplicationDispatcher.forward(ApplicationDispatcher.java:263) ~[catalina.jar:11.0.8-dev]\n        at org.springframework.web.servlet.view.InternalResourceView.renderMergedOutputModel(InternalResourceView.java:171) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.view.AbstractView.render(AbstractView.java:314) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.render(DispatcherServlet.java:1437) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.processDispatchResult(DispatcherServlet.java:1168) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1106) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.doService(DispatcherServlet.java:979) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.FrameworkServlet.processRequest(FrameworkServlet.java:1014) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.FrameworkServlet.doGet(FrameworkServlet.java:903) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:622) ~[servlet-api.jar:6.1]\n        at org.springframework.web.servlet.FrameworkServlet.service(FrameworkServlet.java:885) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at jakarta.servlet.http.HttpServlet.service(HttpServlet.java:710) ~[servlet-api.jar:6.1]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:130) ~[catalina.jar:11.0.8-dev]\n        at org.apache.tomcat.websocket.server.WsFilter.doFilter(WsFilter.java:53) ~[tomcat-websocket.jar:11.0.8-dev]\n        at org.apache.catalina.core.ApplicationFilterChain.doFilter(ApplicationFilterChain.java:109) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.StandardWrapperValve.invoke(StandardWrapperValve.java:167) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.StandardContextValve.invoke(StandardContextValve.java:79) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.authenticator.AuthenticatorBase.invoke(AuthenticatorBase.java:483) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.StandardHostValve.invoke(StandardHostValve.java:116) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.valves.ErrorReportValve.invoke(ErrorReportValve.java:93) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.valves.AbstractAccessLogValve.invoke(AbstractAccessLogValve.java:666) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.core.StandardEngineValve.invoke(StandardEngineValve.java:74) ~[catalina.jar:11.0.8-dev]\n        at org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:343) ~[catalina.jar:11.0.8-dev]\n        at org.apache.coyote.http11.Http11Processor.service(Http11Processor.java:396) ~[tomcat-coyote.jar:11.0.8-dev]\n        at org.apache.coyote.AbstractProcessorLight.process(AbstractProcessorLight.java:63) ~[tomcat-coyote.jar:11.0.8-dev]\n        at org.apache.coyote.AbstractProtocol$ConnectionHandler.process(AbstractProtocol.java:903) ~[tomcat-coyote.jar:11.0.8-dev]\n        at org.apache.tomcat.util.net.NioEndpoint$SocketProcessor.doRun(NioEndpoint.java:1773) ~[tomcat-coyote.jar:11.0.8-dev]\n        at org.apache.tomcat.util.net.SocketProcessorBase.run(SocketProcessorBase.java:52) ~[tomcat-coyote.jar:11.0.8-dev]\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[tomcat-util.jar:11.0.8-dev]\n        at org.apache.tomcat.util.threads.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:637) ~[tomcat-util.jar:11.0.8-dev]\n        at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:59) ~[tomcat-util.jar:11.0.8-dev]\n        at java.base/java.lang.Thread.run(Thread.java:1583) [?:?]\nCaused by: java.lang.ExceptionInInitializerError\n        at java.base/jdk.internal.reflect.DirectConstructorHandleAccessor.newInstance(DirectConstructorHandleAccessor.java:62) ~[?:?]\n        at java.base/java.lang.reflect.Constructor.newInstanceWithCaller(Constructor.java:502) ~[?:?]\n        at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:486) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinTask.getThrowableException(ForkJoinTask.java:540) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinTask.reportException(ForkJoinTask.java:567) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinTask.invoke(ForkJoinTask.java:670) ~[?:?]\n        at java.base/java.util.stream.ForEachOps$ForEachOp.evaluateParallel(ForEachOps.java:160) ~[?:?]\n        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateParallel(ForEachOps.java:174) ~[?:?]\n        at java.base/java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:233) ~[?:?]\n        at java.base/java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:596) ~[?:?]\n        at java.base/java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:765) ~[?:?]\n        at com.gs.juror.bizstrategy.PostponementStrategy.testDates(PostponementStrategy.java:219) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.juror.bizstrategy.PostponementStrategy.getValidDates(PostponementStrategy.java:208) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.util.CalendarSupport.makeCSB(CalendarSupport.java:43) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.web.controllers.PostponeController.setupView(PostponeController.java:553) ~[eJurorWeb-2.17.4.jar:2.17.4]\n        at com.gs.jxx.web.controllers.PostponeController.setupForm(PostponeController.java:417) ~[eJurorWeb-2.17.4.jar:2.17.4]\n        at com.gs.jxx.web.controllers.PostponeController.showForm(PostponeController.java:392) ~[eJurorWeb-2.17.4.jar:2.17.4]\n        at com.gs.jxx.web.controllers.PostponeController.handleRequestInternal(PostponeController.java:103) ~[eJurorWeb-2.17.4.jar:2.17.4]\n        at org.springframework.web.servlet.mvc.AbstractController.handleRequest(AbstractController.java:178) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.mvc.SimpleControllerHandlerAdapter.handle(SimpleControllerHandlerAdapter.java:51) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        at org.springframework.web.servlet.DispatcherServlet.doDispatch(DispatcherServlet.java:1089) ~[spring-webmvc-6.2.7.jar:6.2.7]\n        ... 43 more\nCaused by: java.lang.ExceptionInInitializerError\n        at org.drools.mvel.MVELConstraint.jitEvaluator(MVELConstraint.java:329) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.mvel.MVELConstraint.evaluate(MVELConstraint.java:293) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.mvel.MVELConstraint.isAllowed(MVELConstraint.java:247) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.AlphaNode.assertObject(AlphaNode.java:124) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.doPropagateAssertObject(CompositeObjectSinkAdapter.java:747) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.propagateAssertObject(CompositeObjectSinkAdapter.java:580) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.propagateAssertObject(CompositeObjectSinkAdapter.java:558) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.ObjectTypeNode.propagateAssert(ObjectTypeNode.java:217) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry$Insert.propagate(PropagationEntry.java:237) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry$Insert.internalExecute(PropagationEntry.java:250) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry.execute(PropagationEntry.java:56) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.SynchronizedPropagationList.flush(SynchronizedPropagationList.java:105) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.SynchronizedPropagationList.flush(SynchronizedPropagationList.java:100) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.fireLoop(DefaultAgenda.java:610) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.internalFireAllRules(DefaultAgenda.java:573) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.fireAllRules(DefaultAgenda.java:565) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.internalFireAllRules(StatefulKnowledgeSessionImpl.java:1093) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.fireAllRules(StatefulKnowledgeSessionImpl.java:1084) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.fireAllRules(StatefulKnowledgeSessionImpl.java:1068) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatelessKnowledgeSessionImpl.execute(StatelessKnowledgeSessionImpl.java:284) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.checkTheRules(PostponementStrategy.java:822) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.validateRequest(PostponementStrategy.java:793) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.lambda$testDates$0(PostponementStrategy.java:225) ~[juror-common-2.17.4.jar:2.17.4]\n        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184) ~[?:?]\n        at java.base/java.util.TreeMap$KeySpliterator.forEachRemaining(TreeMap.java:3099) ~[?:?]\n        at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509) ~[?:?]\n        at java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:291) ~[?:?]\n        at java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:754) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1310) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1841) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1806) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188) ~[?:?]\nCaused by: java.lang.NullPointerException: Cannot invoke &quot;org.kie.api.concurrent.KieExecutors.getExecutor()&quot; because the return value of &quot;org.kie.internal.concurrent.ExecutorProviderFactory.getExecutorProvider()&quot; is null\n        at org.drools.mvel.MVELConstraint$ExecutorHolder.&lt;clinit&gt;(MVELConstraint.java:355) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.mvel.MVELConstraint.jitEvaluator(MVELConstraint.java:329) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.mvel.MVELConstraint.evaluate(MVELConstraint.java:293) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.mvel.MVELConstraint.isAllowed(MVELConstraint.java:247) ~[drools-mvel-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.AlphaNode.assertObject(AlphaNode.java:124) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.doPropagateAssertObject(CompositeObjectSinkAdapter.java:747) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.propagateAssertObject(CompositeObjectSinkAdapter.java:580) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.CompositeObjectSinkAdapter.propagateAssertObject(CompositeObjectSinkAdapter.java:558) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.reteoo.ObjectTypeNode.propagateAssert(ObjectTypeNode.java:217) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry$Insert.propagate(PropagationEntry.java:237) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry$Insert.internalExecute(PropagationEntry.java:250) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.PropagationEntry.execute(PropagationEntry.java:56) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.SynchronizedPropagationList.flush(SynchronizedPropagationList.java:105) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.core.phreak.SynchronizedPropagationList.flush(SynchronizedPropagationList.java:100) ~[drools-core-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.fireLoop(DefaultAgenda.java:610) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.internalFireAllRules(DefaultAgenda.java:573) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.agenda.DefaultAgenda.fireAllRules(DefaultAgenda.java:565) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.internalFireAllRules(StatefulKnowledgeSessionImpl.java:1093) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.fireAllRules(StatefulKnowledgeSessionImpl.java:1084) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatefulKnowledgeSessionImpl.fireAllRules(StatefulKnowledgeSessionImpl.java:1068) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at org.drools.kiesession.session.StatelessKnowledgeSessionImpl.execute(StatelessKnowledgeSessionImpl.java:284) ~[drools-kiesession-10.0.0.jar:10.0.0]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.checkTheRules(PostponementStrategy.java:822) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.validateRequest(PostponementStrategy.java:793) ~[juror-common-2.17.4.jar:2.17.4]\n        at com.gs.jxx.bizstrategy.PostponementStrategy.lambda$testDates$0(PostponementStrategy.java:225) ~[juror-common-2.17.4.jar:2.17.4]\n        at java.base/java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:184) ~[?:?]\n        at java.base/java.util.TreeMap$KeySpliterator.forEachRemaining(TreeMap.java:3099) ~[?:?]\n        at java.base/java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:509) ~[?:?]\n        at java.base/java.util.stream.ForEachOps$ForEachTask.compute(ForEachOps.java:291) ~[?:?]\n        at java.base/java.util.concurrent.CountedCompleter.exec(CountedCompleter.java:754) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinTask.doExec(ForkJoinTask.java:387) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool$WorkQueue.topLevelExec(ForkJoinPool.java:1310) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool.scan(ForkJoinPool.java:1841) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinPool.runWorker(ForkJoinPool.java:1806) ~[?:?]\n        at java.base/java.util.concurrent.ForkJoinWorkerThread.run(ForkJoinWorkerThread.java:188) ~[?:?]\n</code></pre>\n<p>Now, according to my research, the kie session is thread safe and I could actually share amongst threads, but I'm not doing that and I'm still getting a thread error.</p>\n<p>The fact that it works fine single threaded and sometimes works multi-threaded I think means the problem is in drools.</p>\n",
    "tags" : [ "java", "multithreading", "drools", "drools-decisiontables" ],
    "owner" : {
      "account_id" : 938881,
      "reputation" : 15320,
      "user_id" : 967330,
      "user_type" : "registered",
      "accept_rate" : 90,
      "profile_image" : "https://www.gravatar.com/avatar/b731ee0bd2400959e9d13737e42c6418?s=256&d=identicon&r=PG",
      "display_name" : "Thom",
      "link" : "https://stackoverflow.com/users/967330/thom"
    },
    "is_answered" : true,
    "view_count" : 88,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1750773470,
    "creation_date" : 1750770180,
    "link" : "https://stackoverflow.com/questions/79677621/statelesskiesession-doesnt-appear-thread-safe",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79677668,
    "question_id" : 79677621,
    "body" : "<p>Different threads are calling parts of Drools' internal logic (most likely <code>JIT</code> compiler) at the same time, which causes the internal state to become corrupted.</p>\n<p>Even though <code>KieContainer</code> is thread-safe, <code>Drools</code> internals, especially those involving dynamic compilation (like <code>JIT</code>), are often not fully thread-safe during <strong>initial loading</strong>.</p>\n<pre><code>at org.drools.mvel.MVELConstraint$ExecutorHolder.&lt;clinit&gt;(MVELConstraint.java:355)\n</code></pre>\n<p>This line indicates a <strong>race condition during the static initialization</strong> of <code>MVELConstraint.ExecutorHolder</code>, which is a static nested class used to manage JIT evaluation.</p>\n<p>The class is not properly synchronized, and under concurrent access (from your parallel <code>.forEach()</code>), it can be initialized in an invalid state.</p>\n<p><em>Thatâ€™s why it sometimes works: if one thread finishes initializing everything first</em></p>\n<p><em>And sometimes fails: if threads collide while it's still loading.</em></p>\n<p><a href=\"https://stackoverflow.com/questions/33074146/disable-jit-in-drools-6-2-with-java-8\">Disable JIT in Drools 6.2 with Java 8</a></p>\n<p>One of the options is to disable <code>JIT</code> compiler in drools, as stated in this other question.</p>\n<p>In drools 10 you can (<em>discovered by @Thom</em>):</p>\n<pre><code>System.setProperty(&quot;drools.jittingThreshold&quot;, &quot;-1&quot;);\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13627,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1750771896,
    "last_activity_date" : 1750773470,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79677668" : [ {
      "comment_id" : 140538471,
      "post_id" : 79677668,
      "body" : "@Thom Rolled back to your edit as it seems drools.jittingThreshold -1 works? Seems like you made it by yourself, nothing to thank about ; )  Glad to help anyway!",
      "score" : 0,
      "owner" : {
        "account_id" : 2465829,
        "reputation" : 13627,
        "user_id" : 2148953,
        "user_type" : "registered",
        "accept_rate" : 96,
        "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
        "display_name" : "aran",
        "link" : "https://stackoverflow.com/users/2148953/aran"
      },
      "creation_date" : 1750773313,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140538425,
      "post_id" : 79677668,
      "body" : "Thanks, you seem very knowledgeable. MVELDialectConfiguration.ConfigurationOption.DISABLE_JIT does not appear to work in drools 10. Do you have a suggestion?",
      "score" : 1,
      "owner" : {
        "account_id" : 938881,
        "reputation" : 15320,
        "user_id" : 967330,
        "user_type" : "registered",
        "accept_rate" : 90,
        "profile_image" : "https://www.gravatar.com/avatar/b731ee0bd2400959e9d13737e42c6418?s=256&d=identicon&r=PG",
        "display_name" : "Thom",
        "link" : "https://stackoverflow.com/users/967330/thom"
      },
      "creation_date" : 1750772715,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}