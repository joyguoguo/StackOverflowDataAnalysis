{
  "question" : {
    "question_id" : 79664000,
    "title" : "spring-boot-oauth2 workflow with exchanging code for jwt",
    "body" : "<p>I've an existing spring boot bff where the authentication workflow is somewhat cumbersome and I thought about upgrading it.\nThe workflow is as follows:</p>\n<p>A user access the application, if the user is not authorised (no jwt available, or it is expired) he is redirected to some auth server. After login there the user is redirect back to the application with a code. The code is exchanged by the application for a jwt.</p>\n<p>It kind of reads like oauth2, so I tried my hand at it, but all it does right now is blocking me from accessing any of the restricted endpoints, which is what I want, but it is also not redirecting me to the auth server.</p>\n<p>pom entries:\nspring-boot-parent - 3.5.0\nspring-boot-starter-web\nspring-boot-starter-security\nspring-security-oauth2-client\nlombok</p>\n<p>as for the code, I've a controller:</p>\n<pre><code>@RestController\n@Slf4j\npublic class TestController {\n    @GetMapping(&quot;/home&quot;)\n    public String home() {\n        return &quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;greetings&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;;\n    }\n\n    @GetMapping(&quot;/liveness&quot;)\n    public ResponseEntity&lt;Object&gt; liveness() {\n        return ResponseEntity.ok().build();\n    }\n</code></pre>\n<p>some security config:</p>\n<pre><code>@configuration\npublic class TestConfig {\n    @Bean\n    public SecurityFilterChan(HttpSecurity httpSecurity) {\n        return httpSecurity\n            .authorizeHttpRequests(e -&gt; e.requestMatchers(&quot;/liveness&quot;).permitAll())\n            .authorizeHttpRequests(e -&gt; e.anyRequest().authenticated())\n            .build();\n    }\n}\n</code></pre>\n<p>as for the application yaml</p>\n<pre><code>spring:\n  security:    \n    oauth2:\n      client:\n        registration:\n          client-id: ${client-id}\n          client-secret: ${client-secret}\n          provider: auth-server\n          authorization-grant-type: authorization_grant\n          redirect-uri: ${redirect-uri}\n        provider:\n          auth-server:\n            issuer-uri: ${issuer-uri}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot" ],
    "owner" : {
      "account_id" : 14840982,
      "reputation" : 39,
      "user_id" : 10717742,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/47416b8ea15265d0c440de08fb22599a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user10717742",
      "link" : "https://stackoverflow.com/users/10717742/user10717742"
    },
    "is_answered" : true,
    "view_count" : 71,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1749841445,
    "creation_date" : 1749755136,
    "link" : "https://stackoverflow.com/questions/79664000/spring-boot-oauth2-workflow-with-exchanging-code-for-jwt",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79664250,
    "question_id" : 79664000,
    "body" : "<p><code>authorization-grant-type</code> should be <code>authorization_code</code>, not <code>authorization_grant</code> (or omit the property as it is the default value).</p>\n<p>The Security filter-chain should be configured with <code>oauth2Login(client -&gt; {})</code>.</p>\n<p>Note that with <code>oauth2Login</code>, requests are authorized with a session cookie, not with a JWT in a <code>Bearer</code> authorization header. And this is precisely what OAuth2 BFFs are about: authorize browser requests with regular sessions (with protection against CSRF) and replace the session cookie with an access token saved in session when routing these requests to downstream resource servers (an <code>oauth2ResourceServer</code> expects a <code>Bearer</code> authorization header containing an access token). There is a Spring Cloud Gateway filter called <code>TokenRelay=</code> to do that.</p>\n<p>It is generally a good practice to always display a home page and to adapt its content depending on the user being anonymous or an authenticated user (add <code>/home</code> to the request matchers with <code>.permitAll()</code>, change the 1st controller method to <code>public String home(Authentication auth)</code>, and adapt the HTML to the <code>auth</code> status).</p>\n<p>For a complete OAuth2 BFF tutorial, see this article I wrote: <a href=\"https://www.baeldung.com/spring-cloud-gateway-bff-oauth2\" rel=\"nofollow noreferrer\">https://www.baeldung.com/spring-cloud-gateway-bff-oauth2</a></p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 308139,
      "reputation" : 13879,
      "user_id" : 619830,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/f4d00b0a82e9307b1d68b29867fee4e5?s=256&d=identicon&r=PG",
      "display_name" : "ch4mp",
      "link" : "https://stackoverflow.com/users/619830/ch4mp"
    },
    "creation_date" : 1749776444,
    "last_activity_date" : 1749841445,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79664250" : [ {
      "comment_id" : 140513005,
      "post_id" : 79664250,
      "body" : "Hello, thank you, the oauth2Login(client -&gt; {}) part was what I was missing and now it works for the part I was most interested in (retrieving the code from the auth server).    As for the home page part, since basically everything is behind this auth server, we normally adjust what you can see based on the actual token, the code is exchange for this, and its content.    Thanks again, I hope this comment is enough to mark it as solved.",
      "score" : 0,
      "owner" : {
        "account_id" : 14840982,
        "reputation" : 39,
        "user_id" : 10717742,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/47416b8ea15265d0c440de08fb22599a?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "user10717742",
        "link" : "https://stackoverflow.com/users/10717742/user10717742"
      },
      "creation_date" : 1749883047,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}