{
  "question" : {
    "question_id" : 79809742,
    "title" : "Connection pool issue with Quarkus Panache Reactive and MySQL",
    "body" : "<p>I'm using Quarkus + Panache Reactive + MySQL for my project. Since it's reactive, my connection pool uses Vertx SQL Pool. I've also enabled metrics to monitor the system status.</p>\n<p>I have a scheduled task like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@WithTransaction\n@Scheduled(cron = &quot;0 * * * * ?&quot;)\npublic Uni&lt;Void&gt; saveData() {\n    return xxxxClient.getData(appId, appSecret).onItem()\n        .transform(CommonResponse::data).onItem()\n        .transform(i -&gt; {\n            List&lt;xxx&gt; list = new ArrayList&lt;&gt;();\n            for (xxxxVo item : i) {\n                list.add(voToXxx(item));\n            }\n            return list;\n        }).onItem().transformToUni(\n            list -&gt; xxxRepository.persist(list)\n        ).replaceWithVoid();\n}\n</code></pre>\n<p>Where <code>xxxxClient.getData</code> requests an external API and saves the returned data to the database. It has been running stably for a long time.</p>\n<h3>Problem</h3>\n<p>However, recently this external API encountered an issue where a single request returned nearly 100,000 records, causing my database table to accumulate over 30 million records, resulting in severe performance problems.</p>\n<p>At this point, Quarkus keeps outputting logs:</p>\n<blockquote>\n<p>io.vertx.sqlclient.ClosedConnectionException: Failed to read any response from the server,\nthe underlying connection may have been lost unexpectedly.</p>\n</blockquote>\n<p>When I checked the monitoring data on Prometheus, I found:</p>\n<ul>\n<li>sql_pool_active: 20 (my configured max)</li>\n<li>sql_pool_waiting: 0</li>\n<li>sql_pool_idle: 20</li>\n<li>sql_pool_ratio: 0%</li>\n<li>sql_pool_queue_size: continuously rising since the API issue started, reaching 60,000+ Even after clearing the corresponding database table, the problem persists.</li>\n</ul>\n<h3>Analysis</h3>\n<p>My leader told me the issue is that the database request packet is too large, exceeding MySQL's default max_allowed_packet configuration. When MySQL receives half the data, it resets the connection. However, Quarkus's connection pool is unaware of this, and subsequent connections continue using the already-reset MySQL connections.</p>\n<p>I thought of using the validation.query configuration available in Spring + Hibernate, which executes an SQL statement before querying to verify the connection is valid. I checked the documentation and found that JDBC drivers support this, but the reactive driver doesn't seem to have this configuration.</p>\n<p>How can I validate the connection before executing queries in the reactive driver? Or is my problem not caused by this?</p>\n",
    "tags" : [ "java", "quarkus", "quarkus-panache" ],
    "owner" : {
      "account_id" : 13054950,
      "reputation" : 28,
      "user_id" : 9434106,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1a2feebcf58281b3f431cb7099a2485c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ULRAMAN TIGA",
      "link" : "https://stackoverflow.com/users/9434106/ulraman-tiga"
    },
    "is_answered" : false,
    "view_count" : 75,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1762338088,
    "creation_date" : 1762328043,
    "link" : "https://stackoverflow.com/questions/79809742/connection-pool-issue-with-quarkus-panache-reactive-and-mysql",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140846443,
    "post_id" : 79809742,
    "body" : "Thanks. So what happens, I think, is that Hibernate Reactive persists all these items, one by one. This would explain why there are so many events in the queue. Would you be able to share a small reproducer on GitHub or somewhere else? Or at least snippets of the entity and table SQL definition.",
    "score" : 0,
    "owner" : {
      "account_id" : 2446461,
      "reputation" : 9283,
      "user_id" : 2133695,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6ba99aebb0acd409215e7cdbfb561b7f?s=256&d=identicon&r=PG",
      "display_name" : "tsegismont",
      "link" : "https://stackoverflow.com/users/2133695/tsegismont"
    },
    "creation_date" : 1762766640,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140845985,
    "post_id" : 79809742,
    "body" : "It is once per minute, xxxRepository.persist() is the default implementation that comes with Panache:  <code>public class xxxRepository implements PanacheRepository&lt;xxx&gt; {}</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 13054950,
      "reputation" : 28,
      "user_id" : 9434106,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1a2feebcf58281b3f431cb7099a2485c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ULRAMAN TIGA",
      "link" : "https://stackoverflow.com/users/9434106/ulraman-tiga"
    },
    "creation_date" : 1762740009,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837937,
    "post_id" : 79809742,
    "body" : "IIUC the method is invoked every second ? On each invocation there will be 100 000 events inserted? Is the the <code>xxxRepository.persist(List)</code> the default implementation that comes with Panache repository?",
    "score" : 0,
    "owner" : {
      "account_id" : 2446461,
      "reputation" : 9283,
      "user_id" : 2133695,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6ba99aebb0acd409215e7cdbfb561b7f?s=256&d=identicon&r=PG",
      "display_name" : "tsegismont",
      "link" : "https://stackoverflow.com/users/2133695/tsegismont"
    },
    "creation_date" : 1762351405,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}