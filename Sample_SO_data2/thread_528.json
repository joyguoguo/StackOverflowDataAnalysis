{
  "question" : {
    "question_id" : 79801550,
    "title" : "Add custom media notifcation actions",
    "body" : "<p>I started building a Material 3 Expressive music player app built mainly on Java (~85%).</p>\n<p>To prevent confusion, I'll provide a direct link to the entire thing just in case: <a href=\"https://github.com/Yamenher/XMusic/blob/main/app/src/main/java/com/xapps/media/xmusic/service/PlayerService.java\" rel=\"nofollow noreferrer\">Main Player Service</a> | <a href=\"https://github.com/Yamenher/XMusic/blob/main/app/src/main/java/com/xapps/media/xmusic/service/CustomNotificationProvider.java\" rel=\"nofollow noreferrer\">CustomNotificationProvider</a></p>\n<p>My main setup parts:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override \npublic void onCreate() {  \n    super.onCreate();  \n    fallbackUri = Uri.parse(&quot;android.resource://&quot; + this.getPackageName() + &quot;/&quot; + resId);\n    handlerThread.start();\n    Looper backgroundLooper = handlerThread.getLooper();\n    ExoPlayerHandler = new Handler(backgroundLooper);\n    DefaultRenderersFactory renderersFactory = new DefaultRenderersFactory(this).setExtensionRendererMode(DefaultRenderersFactory.EXTENSION_RENDERER_MODE_ON);\n    player = new ExoPlayer.Builder(this, renderersFactory).setLooper(backgroundLooper).build();\n    androidx.media3.common.AudioAttributes attrs = new androidx.media3.common.AudioAttributes.Builder()\n    .setUsage(C.USAGE_MEDIA)\n    .setContentType(C.AUDIO_CONTENT_TYPE_MUSIC)\n    .build();\n    ExoPlayerHandler.post(() -&gt; {\n        player.setAudioAttributes(attrs, true);\n    });\n    handler = new Handler(Looper.getMainLooper());  \n    if (!isBuilt) {\n        setupMediaSession();\n        isBuilt = true;\n    }\n    isNotifDead = false;\n    createNotificationChannel();  \n    audioManager = (AudioManager) getSystemService(Context.AUDIO_SERVICE);\n    setupAudioFocusRequest();\n    setMediaNotificationProvider(new CustomNotificationProvider(this));\n    if (Build.VERSION.SDK_INT &gt;= 33) {  \n        startForeground(NOTIFICATION_ID, buildNotification(&quot;XMusic&quot;, &quot;No song is playing&quot;, &quot;&quot;) , ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PLAYBACK);  \n    } else {  \n        startForeground(NOTIFICATION_ID, buildNotification(&quot;XMusic&quot;, &quot;No song is playing&quot;, &quot;&quot;));  \n    }  \n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>private Notification buildNotification(String title, String artist, String cover) {\n    if (mediaSession == null) {\n        setupMediaSession();\n    }\n    MediaStyleNotificationHelper.MediaStyle mediaStyle = new MediaStyleNotificationHelper.MediaStyle(mediaSession).setShowCancelButton(true);\n    Intent resumeIntent = c.getPackageManager().getLaunchIntentForPackage(c.getPackageName());\n    PendingIntent contentIntent = PendingIntent.getActivity(c, 0, resumeIntent, PendingIntent.FLAG_IMMUTABLE);\n    return new NotificationCompat.Builder(this, CHANNEL_ID)\n    .setSmallIcon(R.mipmap.ic_launcher_foreground)\n    .setContentTitle(title)\n    .setContentText(artist)\n    .setLargeIcon(current)\n    .setStyle(mediaStyle)\n    .setOngoing(true)\n    .setContentIntent(contentIntent)\n    .setVisibility(NotificationCompat.VISIBILITY_PUBLIC)\n    .build();\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>private void setupMediaSession() {\n    if (mediaSession != null) {\n        return;\n    }\n    mediaSession = new androidx.media3.session.MediaSession.Builder(this, player).setId(&quot;XMusicMediaSessionPrivate&quot;).setCallback(new CustomCallback()).build();\n}\n\npublic class CustomCallback implements MediaSession.Callback {\n    \n    final SessionCommand TEST = new SessionCommand(&quot;TEST_ACTION&quot;, Bundle.EMPTY);\n    final CommandButton TEST_BUTTON = new CommandButton.Builder(R.drawable.ic_shuffle).setDisplayName(&quot;shuffle&quot;).setSessionCommand(TEST).setSlots(CommandButton.SLOT_FORWARD_SECONDARY).build();\n    List&lt;CommandButton&gt; list = ImmutableList.of(TEST_BUTTON);\n    Player.Commands pcs = new Player.Commands.Builder().addAllCommands().add(Player.COMMAND_SET_SHUFFLE_MODE).build();\n    private SessionCommands sc = SessionCommands.EMPTY.buildUpon().add(TEST).build();\n\n    @Override\n    public ConnectionResult onConnect(MediaSession mediaSession, ControllerInfo controllerInfo) {\n        //return new ConnectionResult.AcceptedResultBuilder(mediaSession).setCustomLayout(list).setAvailableSessionCommands(sc).setMediaButtonPreferences(ImmutableList.of(TEST_BUTTON)).build();\n        return ConnectionResult.accept(sc, pcs);\n    }\n    \n    @Override\n    public void onPostConnect(MediaSession mediaSession, ControllerInfo controllerInfo) {\n        mediaSession.setAvailableCommands(controllerInfo, sc, pcs);\n        mediaSession.setCustomLayout(controllerInfo, list);\n    }\n    \n    @Override\n    public ListenableFuture&lt;SessionResult&gt; onCustomCommand(MediaSession mediaSession, ControllerInfo controllerInfo, SessionCommand sessionCommand, Bundle bundle) {\n        return Futures.immediateFuture(new SessionResult(-6));\n    }\n\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class CustomNotificationProvider extends DefaultMediaNotificationProvider {\n\n    private Context c;\n    public CustomNotificationProvider(Context context) {\n        super(context);\n        c = context;\n    }\n    \n    @Override\n    public int[] addNotificationActions(MediaSession mediaSession, ImmutableList&lt;CommandButton&gt; mediaButtons, NotificationCompat.Builder builder, MediaNotification.ActionFactory actionFactory) {\n        CommandButton cb = new CommandButton.Builder(R.drawable.ic_shuffle).setDisplayName(&quot;negro&quot;).setSessionCommand(new SessionCommand(&quot;action_nigga&quot;, Bundle.EMPTY)).setSlots(CommandButton.SLOT_BACK_SECONDARY).build();\n        ImmutableList&lt;CommandButton&gt; l = ImmutableList.of(cb);\n        NotificationCompat.Action action = actionFactory.createCustomAction(mediaSession, IconCompat.createWithResource(c, R.drawable.ic_shuffle), &quot;test&quot;, &quot;test&quot;, Bundle.EMPTY);\n        builder.addAction(action);\n        int[] i = super.addNotificationActions(mediaSession, l, builder, actionFactory);\n        return i;\n    } \n    \n    @Override\n    public ImmutableList&lt;CommandButton&gt; getMediaButtons(MediaSession mediaSession, Player.Commands commands, ImmutableList&lt;CommandButton&gt; mediaButtonPreferences, boolean z) {\n        CommandButton cb = new CommandButton.Builder(R.drawable.ic_shuffle).setDisplayName(&quot;negro&quot;).setSessionCommand(new SessionCommand(&quot;action_nigga&quot;, Bundle.EMPTY)).setSlots(CommandButton.SLOT_BACK_SECONDARY).build();\n        ImmutableList&lt;CommandButton&gt; l = ImmutableList.of(cb);\n        return l;\n    }\n\n    private PendingIntent getSessionActivityPendingIntent(MediaSession session) {\n        return session.getSessionActivity();\n    }\n}\n</code></pre>\n<p>I've been trying to add custom notification actions to my media notification, but no matter what I tried, only default notification actions (seek buttons, seek bar and play/pause toggle) keep showing like this:</p>\n<p><img src=\"https://i.sstatic.net/IxhptqeW.png\" alt=\"\" /></p>\n",
    "tags" : [ "java", "android", "android-notifications", "android-media3" ],
    "owner" : {
      "account_id" : 30754845,
      "reputation" : 1,
      "user_id" : 23584824,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocIIuAlrSKEU5fWxHyl1A3MF5F2OGrYuKoS3arvLa7FsWpI=k-s256",
      "display_name" : "Yamen",
      "link" : "https://stackoverflow.com/users/23584824/yamen"
    },
    "is_answered" : false,
    "view_count" : 60,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1761553809,
    "creation_date" : 1761550664,
    "link" : "https://stackoverflow.com/questions/79801550/add-custom-media-notifcation-actions",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}