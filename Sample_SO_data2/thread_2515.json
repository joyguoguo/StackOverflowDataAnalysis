{
  "question" : {
    "question_id" : 79617965,
    "title" : "Can not reproduce experiment about RA mode of J9mm",
    "body" : "<p>I attempted to replicate the experiment about &quot;Release/acquire&quot; from Doug Lea‘s blog on j9mm (<a href=\"https://gee.cs.oswego.edu/dl/html/j9mm.html#summarysec\" rel=\"nofollow noreferrer\">https://gee.cs.oswego.edu/dl/html/j9mm.html#summarysec</a>) :</p>\n<pre class=\"lang-java prettyprint-override\"><code>volatile int ready; // Initially 0, with VarHandle READY\n int dinner;         // mode does not matter here\n\n Thread 1                   |  Thread 2\n dinner = 17;               |  if (READY.getAcquire(this) == 1)\n READY.setRelease(this, 1); |    int d = dinner; // sees 17\n\n</code></pre>\n<p>However, I was not successful in reproducing the original results :</p>\n<pre class=\"lang-bash prettyprint-override\"><code>Java Concurrency Stress Tests\n---------------------------------------------------------------------------------\n...\n\n  RESULT     SAMPLES     FREQ       EXPECT  DESCRIPTION\n       0     462,012    1.69%  Interesting\n      17  26,856,279   98.31%  Interesting                                                                                                          \n...\n\n  RESULT        SAMPLES     FREQ       EXPECT  DESCRIPTION\n       0  1,027,953,599   44.29%  Interesting\n      17  1,292,906,829   55.71%  Interesting\n...\n\n\n</code></pre>\n<p>The correct situation should not result in 0.</p>\n<p>I had post the full output infomation on pastebin (<a href=\"https://pastebin.com/FEif5XPg\" rel=\"nofollow noreferrer\">https://pastebin.com/FEif5XPg</a>)</p>\n<p>My code is as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@JCStressTest\n@State\n@Outcome(id = {&quot;17&quot;}, expect = ACCEPTABLE_INTERESTING)\n@Outcome(id = {&quot;0&quot;}, expect = ACCEPTABLE_INTERESTING)\npublic class TestRA {\n\n    volatile int ready;\n    int dinner;\n    static final VarHandle READY;\n    static {\n        try {\n            READY = MethodHandles.lookup()\n                    .findVarHandle(TestRA.class, &quot;ready&quot;, int.class);\n        } catch (NoSuchFieldException | IllegalAccessException e) {\n            throw new RuntimeException(e);\n        }\n    }\n    @Actor\n    public void actor1(I_Result result) {\n        final int i = (int) READY.getAcquire(this);\n        if (i == 1) {\n            result.r1 = dinner;\n        }\n    }\n    @Actor\n    public void actor2() {\n        dinner = 17;\n        READY.setRelease(this, 1);\n    }\n}\n\n</code></pre>\n<p>env:</p>\n<ul>\n<li>OS: Windows 11</li>\n<li>cpu platform: x86_64</li>\n<li>jdk: graalvm-17 (17.0.7)</li>\n</ul>\n<hr />\n<p>Thanks to @pveentjer ,  I refered to his answer, modified my code.\nThe result is correct.</p>\n<p>The modified code is as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@JCStressTest\n@State\n@Outcome(id = {&quot;-1&quot;}, expect = ACCEPTABLE_INTERESTING,desc = &quot;setRelease may not executed yet&quot;)\n@Outcome(id = {&quot;17&quot;}, expect = ACCEPTABLE_INTERESTING,desc = &quot;see 17 correctly&quot;)\n@Outcome(id = {&quot;0&quot;}, expect = FORBIDDEN,desc = &quot;should not appear&quot;)\npublic class TestRA {\n\n    volatile int ready;\n    int dinner;\n    static final VarHandle READY;\n    static {\n        try {\n            READY = MethodHandles.lookup()\n                    .findVarHandle(TestRA.class, &quot;ready&quot;, int.class);\n        } catch (NoSuchFieldException | IllegalAccessException e) {\n            throw new RuntimeException(e);\n        }\n    }\n    @Actor\n    public void actor1(I_Result result) {\n        final int i = (int) READY.getAcquire(this);\n        if (i == 1) {\n            result.r1 = dinner;\n        }else {\n            result.r1 = -1;\n        }\n    }\n    @Actor\n    public void actor2() {\n        dinner = 17;\n        READY.setRelease(this, 1);\n    }\n}\n\n</code></pre>\n<p>The test results are as follows:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>\n  Results across all configurations:\n\n  RESULT        SAMPLES     FREQ       EXPECT  DESCRIPTION\n      -1  1,040,257,363   41.48%  Interesting  setRelease may not executed yet\n       0              0    0.00%    Forbidden  should not appear\n      17  1,467,462,585   58.52%  Interesting  see 17 correctly\n\n...\n\n  RESULT     SAMPLES     FREQ       EXPECT  DESCRIPTION\n      -1   2,459,157    9.99%  Interesting  setRelease may not executed yet\n       0           0    0.00%    Forbidden  should not appear\n      17  22,155,774   90.01%  Interesting  see 17 correctly\n\n...\n\n\n  RESULT     SAMPLES     FREQ       EXPECT  DESCRIPTION\n      -1  19,598,608   58.46%  Interesting  setRelease may not executed yet\n       0           0    0.00%    Forbidden  should not appear\n      17  13,925,123   41.54%  Interesting  see 17 correctly\n\n\n</code></pre>\n",
    "tags" : [ "java", "java.util.concurrent" ],
    "owner" : {
      "account_id" : 24017768,
      "reputation" : 41,
      "user_id" : 18000509,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJwBSNbstE2prBB8_2p_ULQaCd4Z48DvptNyPIO5=k-s256",
      "display_name" : "SemgHH",
      "link" : "https://stackoverflow.com/users/18000509/semghh"
    },
    "is_answered" : true,
    "view_count" : 90,
    "answer_count" : 1,
    "score" : 3,
    "last_activity_date" : 1747702870,
    "creation_date" : 1747057076,
    "link" : "https://stackoverflow.com/questions/79617965/can-not-reproduce-experiment-about-ra-mode-of-j9mm",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79626186,
    "question_id" : 79617965,
    "body" : "<p>Use an II_Result and write both READY and dinner to the II_Result and update your @Outcome. The one that should be forbidden is that you see ready=1, but dinner=0.</p>\n<p>And you can make another experiment where instead of using a release-store and acquire-load on dinner, make it plain store and load, and it is likely you will see the case that ready=1 and dinner=0.</p>\n<p>The current results don't show a violation of causality; it is perfectly fine to see dinner 0 and dinner 17.</p>\n<p>For more information, see: <a href=\"https://github.com/openjdk/jcstress/blob/master/jcstress-samples/src/main/java/org/openjdk/jcstress/samples/jmm/basic/BasicJMM_06_Causality.java\" rel=\"nofollow noreferrer\">BasicJMM_06_Causality</a> and look for the AcquireReleaseGuard example.</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 292208,
      "reputation" : 11569,
      "user_id" : 2245707,
      "user_type" : "registered",
      "accept_rate" : 17,
      "profile_image" : "https://i.sstatic.net/Klcqr.gif?s=256",
      "display_name" : "pveentjer",
      "link" : "https://stackoverflow.com/users/2245707/pveentjer"
    },
    "creation_date" : 1747456401,
    "last_activity_date" : 1747456734,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140418600,
    "post_id" : 79617965,
    "body" : "Maybe use pastebin?",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1747065258,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418140,
    "post_id" : 79617965,
    "body" : "I would provide the full output information. Is there a more effective way to display this lengthy message?",
    "score" : 0,
    "owner" : {
      "account_id" : 24017768,
      "reputation" : 41,
      "user_id" : 18000509,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJwBSNbstE2prBB8_2p_ULQaCd4Z48DvptNyPIO5=k-s256",
      "display_name" : "SemgHH",
      "link" : "https://stackoverflow.com/users/18000509/semghh"
    },
    "creation_date" : 1747057902,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79626186" : [ {
      "comment_id" : 140441116,
      "post_id" : 79626186,
      "body" : "You are correct. Using II_Result to store both the DINNER and READY state values can make the results clearer. I copied the example code from BasicJMM_06_Causality and successfully reproduced the results. Then, I made minimal modify to my code to verify RA. Thank you again for your answers and suggestions！",
      "score" : 0,
      "owner" : {
        "account_id" : 24017768,
        "reputation" : 41,
        "user_id" : 18000509,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJwBSNbstE2prBB8_2p_ULQaCd4Z48DvptNyPIO5=k-s256",
        "display_name" : "SemgHH",
        "link" : "https://stackoverflow.com/users/18000509/semghh"
      },
      "creation_date" : 1747703683,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140438988,
      "post_id" : 79626186,
      "body" : "@SemgHH can you update your post to include the new code? To determine if there is a violation, you really need to store both dinner and READY in the II_Result. Otherwise you will only be validating dinner and then you either will see the dinner or won&#39;t see it and both results are perfectly fine (so you won&#39;t determine if there is a violation of the memory ordering).",
      "score" : 0,
      "owner" : {
        "account_id" : 292208,
        "reputation" : 11569,
        "user_id" : 2245707,
        "user_type" : "registered",
        "accept_rate" : 17,
        "profile_image" : "https://i.sstatic.net/Klcqr.gif?s=256",
        "display_name" : "pveentjer",
        "link" : "https://stackoverflow.com/users/2245707/pveentjer"
      },
      "creation_date" : 1747654532,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140438542,
      "post_id" : 79626186,
      "body" : "Happy to hear that it is working correctly.",
      "score" : 0,
      "owner" : {
        "account_id" : 292208,
        "reputation" : 11569,
        "user_id" : 2245707,
        "user_type" : "registered",
        "accept_rate" : 17,
        "profile_image" : "https://i.sstatic.net/Klcqr.gif?s=256",
        "display_name" : "pveentjer",
        "link" : "https://stackoverflow.com/users/2245707/pveentjer"
      },
      "creation_date" : 1747645112,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140438295,
      "post_id" : 79626186,
      "body" : "Thanks,I referred to this example and modify my code follow: <code>if (i == 1) {result.r1 = dinner;}else {result.r1 = -1;} </code>.   The result is correct.",
      "score" : 1,
      "owner" : {
        "account_id" : 24017768,
        "reputation" : 41,
        "user_id" : 18000509,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJwBSNbstE2prBB8_2p_ULQaCd4Z48DvptNyPIO5=k-s256",
        "display_name" : "SemgHH",
        "link" : "https://stackoverflow.com/users/18000509/semghh"
      },
      "creation_date" : 1747639761,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}