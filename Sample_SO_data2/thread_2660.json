{
  "question" : {
    "question_id" : 79608148,
    "title" : "AWS Open Search Not updating complete chain of events using updatebyQuery",
    "body" : "<p>I have a java microservice that consumes messages from Kafka topic. After performing business logic, I am persisting the messages in aws open search.In the code flow, I process the incoming batch of payloads and insert those documents in open search.</p>\n<p>Now here is the catch. The incoming messages contains state of the event like -&gt;  started, in_progress, halt, ended. There will be multiple incoming messages with different states for an unique Id.</p>\n<p>My use case is, I want to update a flag say &quot;evicted&quot;  = true to all the documents associated with the id if I receive an event with ended state. As a part of solution, I am maintaining a queue, adding all the unique ids having ended state.</p>\n<p>And then I have a scheduler that runs after 2 minutes and I perform &quot;update by query&quot; of open search by passing ids in batch of 1000. I am using terms and passing ids in the form of an array</p>\n<p>The issue here is I see not all the ids have updated the complete chain of events. Some times, if an id is associated with 6 events only 3 events have value for the flag evicted = true. Sometimes, even not all the events for an id are updated with the flag.</p>\n<p>Incoming message rate is high, in couple of minutes, you can expect 100k records. One of the solution is to refresh the index before update query but that is really expensive operation as there will be millions of documents in the index.</p>\n<p>Also, there will be 20 instances of my consumer microserservice running. So if the microservice stops and restarts then my local queue will vanish before performing update(solution for this would be to have redis cache and store id, but again I will have to take care of concurrency as multiple instances of microservices are running).</p>\n<p>In addition to this logic, I have developed a aws lambda that performs reindexing. The purpose for this is to free up the memory from open search. It is a scheduled  at the midnight.Reindexing begins with the criteria that only evicted=false documents will be rolled over to the new index, and once reindexing is completed, old index gets deleted.</p>\n<p>So to conclude,</p>\n<ol>\n<li>How can we handle partial update chain and make sure all the events gets updated.</li>\n<li>How can we handle events those have updated in the last schedule but before that at reindexing has started.</li>\n<li>In case of service going down, how to preserve unique ids stored in local queue (This can be done using redis or dynamo db but since there will be multiple instances updating it, I am suspecting this would create any concurrency issues. Looking for reliable approach)</li>\n</ol>\n",
    "tags" : [ "java", "spring-boot", "elasticsearch", "opensearch" ],
    "owner" : {
      "account_id" : 5619182,
      "reputation" : 19,
      "user_id" : 4449592,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6019d19b8583e3f3689cb1b642ed41ab?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Gourav",
      "link" : "https://stackoverflow.com/users/4449592/gourav"
    },
    "is_answered" : false,
    "view_count" : 30,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1746525105,
    "creation_date" : 1746514947,
    "link" : "https://stackoverflow.com/questions/79608148/aws-open-search-not-updating-complete-chain-of-events-using-updatebyquery",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140400073,
    "post_id" : 79608148,
    "body" : "Please edit the question to limit it to a specific problem with enough detail to identify an adequate answer.",
    "score" : 0,
    "owner" : {
      "account_id" : -1,
      "reputation" : 1,
      "user_id" : -1,
      "user_type" : "moderator",
      "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
      "display_name" : "Community",
      "link" : "https://stackoverflow.com/users/-1/community"
    },
    "creation_date" : 1746530735,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}