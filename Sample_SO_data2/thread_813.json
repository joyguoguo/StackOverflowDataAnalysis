{
  "question" : {
    "question_id" : 79773489,
    "title" : "How to add Signature Policy and Signer Role to XAdES-B Signature with DSS Java Library?",
    "body" : "<p>I'm integrating the XAdES electronic signature class in Java to send a signed XML invoice to an e-invoicing platform.\nI found a Java class that almost fits my needs:</p>\n<pre><code>package eu.europa.esig.dss.cookbook.example.sign;\n\nimport eu.europa.esig.dss.enumerations.DigestAlgorithm;\nimport eu.europa.esig.dss.enumerations.SignatureLevel;\nimport eu.europa.esig.dss.enumerations.SignaturePackaging;\nimport eu.europa.esig.dss.model.DSSDocument;\nimport eu.europa.esig.dss.model.FileDocument;\nimport eu.europa.esig.dss.model.SignatureValue;\nimport eu.europa.esig.dss.model.ToBeSigned;\nimport eu.europa.esig.dss.token.DSSPrivateKeyEntry;\nimport eu.europa.esig.dss.token.MSCAPISignatureToken;\nimport eu.europa.esig.dss.spi.validation.CommonCertificateVerifier;\nimport eu.europa.esig.dss.xades.XAdESSignatureParameters;\nimport eu.europa.esig.dss.xades.signature.XAdESService;\n\nimport java.util.List;\n\n/**\n * How to sign using MS-CAPI.\n */\npublic class SignXmlXadesBWithMSCAPI {\n\n    /**\n     * Executable application\n     */\n    private SignXmlXadesBWithMSCAPI() {\n    }\n\n    /**\n     * Main method\n     *\n     * @param args not applicable\n     * @throws Exception if an exception occurs\n     */\n    public static void main(String[] args) throws Exception {\n        // GET document to be signed -\n        // Return DSSDocument toSignDocument\n        DSSDocument toSignDocument = new FileDocument(&quot;src/main/resources/xml_example.xml&quot;);\n\n        // Creation of MS-CAPI signature token\n        try (MSCAPISignatureToken signingToken = new MSCAPISignatureToken()) {\n\n            List&lt;DSSPrivateKeyEntry&gt; list = signingToken.getKeys();\n            // Choose the right private key entry from store.\n            // The index will depend of the number of the certificates on your card.\n            System.out.println(list.size());\n            DSSPrivateKeyEntry privateKey = list.get(0);\n\n            // Preparing parameters for the PAdES signature\n            XAdESSignatureParameters parameters = new XAdESSignatureParameters();\n            // We choose the level of the signature (-B, -T, -LT, -LTA).\n            parameters.setSignatureLevel(SignatureLevel.XAdES_BASELINE_B);\n            // We choose the type of the signature packaging (ENVELOPING, DETACHED).\n            parameters.setSignaturePackaging(SignaturePackaging.ENVELOPED);\n            // We set the digest algorithm to use with the signature algorithm. You must use the\n            // same parameter when you invoke the method sign on the token.\n            parameters.setDigestAlgorithm(DigestAlgorithm.SHA256);\n\n            // We set the signing certificate\n            parameters.setSigningCertificate(privateKey.getCertificate());\n            // We set the certificate chain\n            parameters.setCertificateChain(privateKey.getCertificateChain());\n\n            // Create common certificate verifier\n            CommonCertificateVerifier commonCertificateVerifier = new CommonCertificateVerifier();\n            // Create CAdES xadesService for signature\n            XAdESService xadesService = new XAdESService(commonCertificateVerifier);\n\n            // Get the SignedInfo segment that need to be signed.\n            ToBeSigned dataToSign = xadesService.getDataToSign(toSignDocument, parameters);\n\n            // This function obtains the signature value for signed information using the\n            // private key and specified algorithm\n            DigestAlgorithm digestAlgorithm = parameters.getDigestAlgorithm();\n            SignatureValue signatureValue = signingToken.sign(dataToSign, digestAlgorithm, privateKey);\n\n            // We invoke the xadesService to sign the document with the signature value obtained in\n            // the previous step.\n            DSSDocument signedDocument = xadesService.signDocument(toSignDocument, parameters, signatureValue);\n\n            // save the signed document on the filesystem\n            signedDocument.save(&quot;target/signedXmlXadesMSCapi.xml&quot;);\n        }\n    }\n\n}\n</code></pre>\n<p>However, I need to add the signature policy and signer role elements so that the signed file is accepted by the platform.\nHere is an example of the required XML fragment that is missing in my signature:</p>\n<pre><code>&lt;ds:Object&gt;\n   &lt;xades:QualifyingProperties xmlns:xades=&quot;http://uri.etsi.org/01903/v1.3.2#&quot; Target=&quot;#SigFrs&quot;&gt;\n      &lt;xades:SignedProperties Id=&quot;xades-SigFrs&quot;&gt;\n         &lt;xades:SignedSignatureProperties&gt;\n            &lt;xades:SigningTime&gt;2018-06-21T13:53:18Z&lt;/xades:SigningTime&gt;\n            &lt;xades:SigningCertificateV2&gt;\n               &lt;xades:Cert&gt;\n                  &lt;xades:CertDigest&gt;\n                     &lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot; /&gt;\n                     &lt;ds:DigestValue&gt;Fi3/GHSQt+Xo6xqgSkTzVn96AIM=&lt;/ds:DigestValue&gt;\n                  &lt;/xades:CertDigest&gt;\n                  &lt;xades:IssuerSerialV2&gt;\n                     MIGAMHSkcjBwMQswCQYDVQQGEwJUTjEOMAwGA1UEBwwFVHVuaXMxLjAsBgNVBAoMJU5hdGlvbmFsIERpZ2l0YWwgQ2VydGlmaWN\n                     hdGlvbiBBZ2VuY3kxITAfBgNVBAMMGFRuVHJ1c3QgUXVhbGlmaWVkIEdvdiBDQQIIRZLo6uoLbQ4=\n                  &lt;/xades:IssuerSerialV2&gt;\n               &lt;/xades:Cert&gt;\n            &lt;/xades:SigningCertificateV2&gt;\n            &lt;xades:SignaturePolicyIdentifier&gt;\n               &lt;xades:SignaturePolicyId&gt;\n                  &lt;xades:SigPolicyId&gt;\n                     &lt;xades:Identifier Qualifier=&quot;OIDasURN&quot;&gt;urn:2.16.788.1.2.1&lt;/xades:Identifier&gt;\n                     &lt;xades:Description&gt;Politique de signature de la facture electronique&lt;/xades:Description&gt;\n                  &lt;/xades:SigPolicyId&gt;\n                  &lt;xades:SigPolicyHash&gt;\n                     &lt;ds:DigestMethod Algorithm=&quot;http://www.w3.org/2001/04/xmlenc#sha256&quot; /&gt;\n                     &lt;ds:DigestValue&gt;dJfuvjtlkeBfLBKUf142staW57x6LpSKGIfzWvohY3E=&lt;/ds:DigestValue&gt;\n                  &lt;/xades:SigPolicyHash&gt;\n                  &lt;xades:SigPolicyQualifiers&gt;\n                     &lt;xades:SigPolicyQualifier&gt;\n                        &lt;xades:SPURI&gt;\n                           http://www.tradenet.com.tn/portal/telechargerTelechargement?lien=Politique_de_Signature_de_la_facture_electronique.pdf\n                        &lt;/xades:SPURI&gt;\n                     &lt;/xades:SigPolicyQualifier&gt;\n                  &lt;/xades:SigPolicyQualifiers&gt;\n               &lt;/xades:SignaturePolicyId&gt;\n            &lt;/xades:SignaturePolicyIdentifier&gt;\n            &lt;xades:SignerRoleV2&gt;\n               &lt;xades:ClaimedRoles&gt;\n                  &lt;xades:ClaimedRole&gt;Fournisseur&lt;/xades:ClaimedRole&gt;\n               &lt;/xades:ClaimedRoles&gt;\n            &lt;/xades:SignerRoleV2&gt;\n         &lt;/xades:SignedSignatureProperties&gt;\n         &lt;xades:SignedDataObjectProperties&gt;\n            &lt;xades:DataObjectFormat ObjectReference=&quot;#r-id-frs&quot;&gt;\n               &lt;xades:MimeType&gt;application/octet-stream&lt;/xades:MimeType&gt;\n            &lt;/xades:DataObjectFormat&gt;\n         &lt;/xades:SignedDataObjectProperties&gt;\n      &lt;/xades:SignedProperties&gt;\n   &lt;/xades:QualifyingProperties&gt;\n&lt;/ds:Object&gt;\n</code></pre>\n<p>How can I add the signature policy and signer role to the XAdES-B signature using the DSS Java library?\nAny code example or guidance would be greatly appreciated!</p>\n<p>I tried to integrate the balises about policy and role to generate XML file that respects the XSD requirements of the host Webservice. But there is no further examples.</p>\n",
    "tags" : [ "java", "xml", "digital-signature", "xades" ],
    "owner" : {
      "account_id" : 44057868,
      "reputation" : 1,
      "user_id" : 31554587,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b583710b32bfef540670ece7b43c3708?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "FennecTN",
      "link" : "https://stackoverflow.com/users/31554587/fennectn"
    },
    "is_answered" : false,
    "view_count" : 92,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1758704440,
    "creation_date" : 1758704440,
    "link" : "https://stackoverflow.com/questions/79773489/how-to-add-signature-policy-and-signer-role-to-xades-b-signature-with-dss-java-l",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}