{
  "question" : {
    "question_id" : 79834647,
    "title" : "Why does RestTemplate, starting from Java 21, run on a different thread even without virtual threads and without @Async, and why does MDC get lost?",
    "body" : "<p>i recently migrated from java17 to 21. I use logback MDC to log http request and response. each http request may lead to execute several resttemplate sync call. i use mdc to generate UUID as traceId in jakarta servlet filter and get MDC befre and after resttemplate call to log traceId and resttemolate request and response. after migrate to java 21 the resttemolate executes in different thread and mdc values missed. even if virtual thread is not enabled.</p>\n",
    "tags" : [ "java", "spring", "jvm", "resttemplate", "mdc" ],
    "owner" : {
      "account_id" : 8944604,
      "reputation" : 160,
      "user_id" : 6672520,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-7-72q4R60E8/AAAAAAAAAAI/AAAAAAAAAEI/kZt7aHz43vM/s256-rj/photo.jpg",
      "display_name" : "Bashir Zamani",
      "link" : "https://stackoverflow.com/users/6672520/bashir-zamani"
    },
    "is_answered" : false,
    "view_count" : 45,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1764584031,
    "creation_date" : 1764584031,
    "link" : "https://stackoverflow.com/questions/79834647/why-does-resttemplate-starting-from-java-21-run-on-a-different-thread-even-wit",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140883139,
    "post_id" : 79834647,
    "body" : "@Gimby Offtopic, but was there a way to close a <code>HttpClient</code> in Java 17 and before? You are sure right, there never existed any guarantee that <code>finalize()</code> would ever be called. Making the class <code>Autocloseable</code> is a good design choice, with its compatibility issues.",
    "score" : 0,
    "owner" : {
      "account_id" : 7612423,
      "reputation" : 87400,
      "user_id" : 5772882,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8283c64511fa80afed5259d10850168f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Anonymous",
      "link" : "https://stackoverflow.com/users/5772882/anonymous"
    },
    "creation_date" : 1764676085,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140883022,
    "post_id" : 79834647,
    "body" : "@Anonymous when upgrading, you always learn new ways in which you were always doing it wrong. Relying on the garbage collector to close connections is... quite optimistic.",
    "score" : 0,
    "owner" : {
      "account_id" : 187094,
      "reputation" : 5301,
      "user_id" : 424903,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
      "display_name" : "Gimby",
      "link" : "https://stackoverflow.com/users/424903/gimby"
    },
    "creation_date" : 1764671823,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881155,
    "post_id" : 79834647,
    "body" : "We had a similar observation with <code>HttpClient</code>. Until Java 17 it relied on the garbage collector to close the thread it had started (if any). In Java 21 it is instead auto-closeable, which we needed to handle in order to close the thread. We discovered since when running our code on Java 21, it crashed because of too many threads.",
    "score" : 0,
    "owner" : {
      "account_id" : 7612423,
      "reputation" : 87400,
      "user_id" : 5772882,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8283c64511fa80afed5259d10850168f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Anonymous",
      "link" : "https://stackoverflow.com/users/5772882/anonymous"
    },
    "creation_date" : 1764585394,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881135,
    "post_id" : 79834647,
    "body" : "Got any code and/or log sample?",
    "score" : 0,
    "owner" : {
      "account_id" : 2563377,
      "reputation" : 7627,
      "user_id" : 2224047,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/UZ83S.jpg?s=256",
      "display_name" : "Nikolai  Shevchenko",
      "link" : "https://stackoverflow.com/users/2224047/nikolai-shevchenko"
    },
    "creation_date" : 1764584402,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881131,
    "post_id" : 79834647,
    "body" : "I am in spring webMvc and dont want to use reactive clients like webClient",
    "score" : 0,
    "owner" : {
      "account_id" : 8944604,
      "reputation" : 160,
      "user_id" : 6672520,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-7-72q4R60E8/AAAAAAAAAAI/AAAAAAAAAEI/kZt7aHz43vM/s256-rj/photo.jpg",
      "display_name" : "Bashir Zamani",
      "link" : "https://stackoverflow.com/users/6672520/bashir-zamani"
    },
    "creation_date" : 1764584210,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}