{
  "question" : {
    "question_id" : 79594093,
    "title" : "How to prevent a socket error connecting with RabbitMQ",
    "body" : "<p>I am getting this error on my processor side:</p>\n<pre class=\"lang-none prettyprint-override\"><code>2025-04-26 14:27:04,630 INFO  [io.sma.rea.mes.rabbitmq] (main) SRMSG17036: RabbitMQ broker configured to [localhost:5672] for channel reportsqueue\n2025-04-26 14:27:04,631 INFO  [io.sma.rea.mes.rabbitmq] (main) SRMSG17036: RabbitMQ broker configured to [localhost:5672] for channel order-response\n2025-04-26 14:27:04,632 INFO  [io.sma.rea.mes.rabbitmq] (main) SRMSG17007: Connection with RabbitMQ broker established for channel `reportsqueue`\n2025-04-26 14:27:04,632 INFO  [io.ver.rab.imp.RabbitMQClientImpl] (main) Starting rabbitmq client\n2025-04-26 14:27:04,632 ERROR [io.ver.rab.imp.RabbitMQClientImpl] (executor-thread-1) Could not connect to rabbitmq: java.net.ConnectException: Connection refused\n    at java.base@21.0.6/sun.nio.ch.Net.pollConnect(Native Method)\n    at java.base@21.0.6/sun.nio.ch.Net.pollConnectNow(Net.java:682)\n    at java.base@21.0.6/sun.nio.ch.NioSocketImpl.timedFinishConnect(NioSocketImpl.java:542)\n    at java.base@21.0.6/sun.nio.ch.NioSocketImpl.connect(NioSocketImpl.java:592)\n    at java.base@21.0.6/java.net.SocksSocketImpl.connect(SocksSocketImpl.java:327)\n    at java.base@21.0.6/java.net.Socket.connect(Socket.java:751)\n    at com.rabbitmq.client.impl.SocketFrameHandlerFactory.create(SocketFrameHandlerFactory.java:61)\n    at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:1249)\n    at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:1198)\n    at com.rabbitmq.client.ConnectionFactory.newConnection(ConnectionFactory.java:1096)\n    at io.vertx.rabbitmq.impl.RabbitMQClientImpl.newConnection(RabbitMQClientImpl.java:160)\n    at io.vertx.rabbitmq.impl.RabbitMQClientImpl.connect(RabbitMQClientImpl.java:843)\n    at io.vertx.rabbitmq.impl.RabbitMQClientImpl.lambda$tryConnect$36(RabbitMQClientImpl.java:763)\n    at io.vertx.core.impl.ContextImpl.lambda$executeBlocking$5(ContextImpl.java:205)\n    at io.vertx.core.impl.ContextInternal.dispatch(ContextInternal.java:270)\n    at io.vertx.core.impl.ContextImpl$1.execute(ContextImpl.java:221)\n    at io.vertx.core.impl.WorkerTask.run(WorkerTask.java:56)\n    at io.vertx.core.impl.TaskQueue.run(TaskQueue.java:81)\n    at io.quarkus.vertx.core.runtime.VertxCoreRecorder$15.runWith(VertxCoreRecorder.java:643)\n    at org.jboss.threads.EnhancedQueueExecutor$Task.doRunWith(EnhancedQueueExecutor.java:2675)\n    at org.jboss.threads.EnhancedQueueExecutor$Task.run(EnhancedQueueExecutor.java:2654)\n    at org.jboss.threads.EnhancedQueueExecutor.runThreadBody(EnhancedQueueExecutor.java:1627)\n    at org.jboss.threads.EnhancedQueueExecutor$ThreadBody.run(EnhancedQueueExecutor.java:1594)\n    at org.jboss.threads.DelegatingRunnable.run(DelegatingRunnable.java:11)\n    at org.jboss.threads.ThreadLocalResettingRunnable.run(ThreadLocalResettingRunnable.java:11)\n    at io.netty.util.concurrent.FastThreadLocalRunnable.run(FastThreadLocalRunnable.java:30)\n    at java.base@21.0.6/java.lang.Thread.runWith(Thread.java:1596)\n    at java.base@21.0.6/java.lang.Thread.run(Thread.java:1583)\n    at org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:896)\n    at org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:872)\n</code></pre>\n<p>I have a RabbitMQ manager server running on port localhost:8085:15672 for the UI and the amqp port at 5672. with my application.properties set as:</p>\n<pre class=\"lang-ini prettyprint-override\"><code>rabbitmq.host=rabbitmq.rabbitmq.svc.cluster.local\nrabbitmq.port=5672\nrabbitmq.username=team1\nrabbitmq.password=team1\nmp.messaging.outgoing.order-response.rabbitmq.host=rabbitmq.rabbitmq.svc.cluster.local\nmp.messaging.outgoing.order-response.rabbitmq.port=5672\nmp.messaging.outgoing.order-response.rabbitmq.username=team1\nmp.messaging.outgoing.order-response.rabbitmq.password=team1\nmp.messaging.incoming.reportsqueue.rabbitmq.host=rabbitmq.rabbitmq.svc.cluster.local\nmp.messaging.incoming.reportsqueue.rabbitmq.port=5672\nmp.messaging.incoming.reportsqueue.rabbitmq.username=team1\nmp.messaging.incoming.reportsqueue.rabbitmq.password=team1\n</code></pre>\n<p>My producer is set up similarly on application.properties, but I'm not getting any errors as shown above:</p>\n<pre class=\"lang-none prettyprint-override\"><code>2025-04-26 03:01:09,439 INFO  [io.sma.rea.mes.rabbitmq] (main) SRMSG17036: RabbitMQ broker configured to [localhost:5672] for channel order-response\n2025-04-26 03:01:09,440 INFO  [io.sma.rea.mes.rabbitmq] (main) SRMSG17036: RabbitMQ broker configured to [localhost:5672] for channel order-requests\n2025-04-26 03:01:09,442 INFO  [io.quarkus] (main) team1-purchase-api 1.0.3 native (powered by Quarkus 3.20.0) started in 0.025s. Listening on: http://0.0.0.0:8080\n2025-04-26 03:01:09,442 INFO  [io.quarkus] (main) Profile prod activated. \n2025-04-26 03:01:09,442 INFO  [io.quarkus] (main) Installed features: [cdi, grpc-client, hibernate-orm, hibernate-reactive, hibernate-reactive-panache, hibernate-validator, kubernetes, messaging, messaging-rabbitmq, reactive-pg-client, rest, rest-jackson, smallrye-context-propagation, smallrye-openapi, swagger-ui, vertx]\n</code></pre>\n<p>This is my code on the processor side:</p>\n<pre><code>package team1_report;\n\nimport java.time.LocalDateTime;\n\nimport org.eclipse.microprofile.reactive.messaging.Incoming;\nimport org.eclipse.microprofile.reactive.messaging.Outgoing;\n\nimport io.quarkus.hibernate.reactive.panache.common.WithTransaction;\nimport io.smallrye.mutiny.Uni;\n\nimport org.jboss.logging.Logger;\n\nimport io.vertx.core.json.JsonObject;\n\nimport jakarta.enterprise.context.ApplicationScoped;\n\n@ApplicationScoped\npublic class ReportProcessor {\n\n    private static final Logger LOG = Logger.getLogger( ReportProcessor.class );\n\n    @Incoming(&quot;reportsqueue&quot;)\n    @Outgoing(&quot;order-response&quot;)\n    public String handleOrderRequest(String msg) {\n        LOG.info(&quot;Received order-request: &quot; + msg);\n        try {\n            JsonObject json = new JsonObject(msg);\n            String orderId = json.getString(&quot;order_id&quot;);\n            Long customerId = json.getLong(&quot;customer_id&quot;);\n            Long productId = json.getLong(&quot;product_id&quot;);\n            Long quantity = json.getLong(&quot;quantity&quot;);\n            Double totalAmount = json.getDouble(&quot;total_amount&quot;);\n            String timestamp = LocalDateTime.now().toString();\n\n            Orders order = new Orders();\n            order.id = orderId;\n            order.customerId = customerId;\n            order.productId = productId;\n            order.quantity = quantity;\n            order.totalAmount = totalAmount;\n            order.timestamp = timestamp;\n\n            return persistOrder(order)\n                .onItem().transform(unused -&gt; {\n                    JsonObject response = new JsonObject();\n                    response.put(&quot;orderID&quot;, orderId);\n                    response.put(&quot;customerID&quot;, customerId);\n                    response.put(&quot;productID&quot;, productId);\n                    response.put(&quot;quantity&quot;, quantity);\n                    response.put(&quot;totalAmount&quot;, totalAmount);\n\n                    LOG.info(&quot;Saved order and emitted order-response: &quot; + response.encodePrettily());\n\n                    return response.encode();\n                })\n                .await().indefinitely();\n\n        } catch (Exception e) {\n            LOG.error(&quot;Error processing order-request&quot;, e);\n            return &quot;NULL - ERROR&quot;;\n        }\n    }\n\n    @WithTransaction\n    public Uni&lt;Void&gt; persistOrder(Orders order){\n        return order.persist().replaceWithVoid();\n    }\n}\n</code></pre>\n<p>Here are my running pods:</p>\n<pre class=\"lang-none prettyprint-override\"><code>shubh@Mac Report-Microservice-Processor % kubectl get pods -n rabbitmq\nNAME         READY   STATUS    RESTARTS   AGE\nrabbitmq-0   1/1     Running   0          13h\nshubh@Mac Report-Microservice-Processor % kubectl get pods\nNAME                                      READY   STATUS    RESTARTS       AGE\nteam1-customer-68dcb85d4b-rqrbv           1/1     Running   8 (13h ago)    30h\nteam1-customer-client-665b678cd7-d79l7    1/1     Running   10 (22h ago)   2d15h\nteam1-customer-database-postgresql-0      1/1     Running   14 (22h ago)   4d22h\nteam1-purchase-api-94f4676cf-7pw48        1/1     Running   0              12h\nteam1-report-database-postgresql-0        1/1     Running   3 (22h ago)    29h\nteam1-report-processor-8696f4c5b4-c6vws   1/1     Running   0              3m13s\nshubh@Mac Report-Microservice-Processor % \n</code></pre>\n<p>Edits:</p>\n<p>The rabbitmq server yaml file description.</p>\n<pre><code>shubh@Mac ~ % kubectl get svc team1-rabbitmq -o yaml\n\napiVersion: v1\nkind: Service\nmetadata:\n  creationTimestamp: &quot;2025-04-26T16:10:49Z&quot;\n  labels:\n    app.kubernetes.io/component: rabbitmq\n    app.kubernetes.io/name: team1-rabbitmq\n    app.kubernetes.io/part-of: rabbitmq\n  name: team1-rabbitmq\n  namespace: default\n  ownerReferences:\n  - apiVersion: rabbitmq.com/v1beta1\n    blockOwnerDeletion: true\n    controller: true\n    kind: RabbitmqCluster\n    name: team1-rabbitmq\n    uid: 68cd3769-1bde-4967-91ab-4ef548cf9f7f\n  resourceVersion: &quot;88607&quot;\n  uid: 7a471fb6-8507-46fa-b40d-868aff3d0ccb\nspec:\n  clusterIP: 10.43.136.31\n  clusterIPs:\n  - 10.43.136.31\n  internalTrafficPolicy: Cluster\n  ipFamilies:\n  - IPv4\n  ipFamilyPolicy: SingleStack\n  ports:\n  - appProtocol: amqp\n    name: amqp\n    port: 5672\n    protocol: TCP\n    targetPort: 5672\n  - appProtocol: http\n    name: management\n    port: 15672\n    protocol: TCP\n    targetPort: 15672\n  - appProtocol: prometheus.io/metrics\n    name: prometheus\n    port: 15692\n    protocol: TCP\n    targetPort: 15692\n  selector:\n    app.kubernetes.io/name: team1-rabbitmq\n  sessionAffinity: None\n  type: ClusterIP\nstatus:\n  loadBalancer: {}\nshubh@Mac ~ % \n</code></pre>\n<p>My updated pod info.</p>\n<pre><code>shubh@Mac ~ % kubectl get all\nNAME                                          READY   STATUS    RESTARTS        AGE\npod/team1-customer-68dcb85d4b-rqrbv           1/1     Running   18 (118s ago)   2d23h\npod/team1-customer-client-665b678cd7-d79l7    1/1     Running   15 (12m ago)    4d8h\npod/team1-customer-database-postgresql-0      1/1     Running   19 (12m ago)    6d15h\npod/team1-purchase-api-94f4676cf-7pw48        1/1     Running   5 (12m ago)     2d5h\npod/team1-rabbitmq-server-0                   1/1     Running   4 (12m ago)     40h\npod/team1-report-database-postgresql-0        1/1     Running   8 (12m ago)     2d22h\npod/team1-report-processor-769d55cdb6-j2756   1/1     Running   4 (2m ago)      31h\n\nNAME                                            TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                        AGE\nservice/kubernetes                              ClusterIP   10.43.0.1       &lt;none&gt;        443/TCP                        53d\nservice/team1-customer                          ClusterIP   10.43.46.195    &lt;none&gt;        80/TCP,9000/TCP                6d15h\nservice/team1-customer-client                   ClusterIP   10.43.181.133   &lt;none&gt;        8081/TCP                       7d4h\nservice/team1-customer-database-postgresql      ClusterIP   10.43.172.107   &lt;none&gt;        5432/TCP                       6d15h\nservice/team1-customer-database-postgresql-hl   ClusterIP   None            &lt;none&gt;        5432/TCP                       6d15h\nservice/team1-purchase-api                      ClusterIP   10.43.46.133    &lt;none&gt;        80/TCP                         3d\nservice/team1-rabbitmq                          ClusterIP   10.43.136.31    &lt;none&gt;        5672/TCP,15672/TCP,15692/TCP   40h\nservice/team1-rabbitmq-nodes                    ClusterIP   None            &lt;none&gt;        4369/TCP,25672/TCP             40h\nservice/team1-report-database-postgresql        ClusterIP   10.43.229.14    &lt;none&gt;        5432/TCP                       2d22h\nservice/team1-report-database-postgresql-hl     ClusterIP   None            &lt;none&gt;        5432/TCP                       2d22h\nservice/team1-report-processor                  ClusterIP   10.43.213.152   &lt;none&gt;        80/TCP                         2d22h\n\nNAME                                     READY   UP-TO-DATE   AVAILABLE   AGE\ndeployment.apps/team1-customer           1/1     1            1           6d15h\ndeployment.apps/team1-customer-client    1/1     1            1           7d4h\ndeployment.apps/team1-purchase-api       1/1     1            1           3d\ndeployment.apps/team1-report-processor   1/1     1            1           2d22h\n\nNAME                                                DESIRED   CURRENT   READY   AGE\nreplicaset.apps/team1-customer-55645666f7           0         0         0       4d7h\nreplicaset.apps/team1-customer-5769fcfb96           0         0         0       4d7h\nreplicaset.apps/team1-customer-5cb7894dd4           0         0         0       4d10h\nreplicaset.apps/team1-customer-5d4ccd8dd7           0         0         0       6d15h\nreplicaset.apps/team1-customer-6497d7b6f5           0         0         0       2d23h\nreplicaset.apps/team1-customer-68dcb85d4b           1         1         1       2d23h\nreplicaset.apps/team1-customer-6d74989c86           0         0         0       2d23h\nreplicaset.apps/team1-customer-7d9c58c994           0         0         0       6d15h\nreplicaset.apps/team1-customer-b75fbd57f            0         0         0       4d8h\nreplicaset.apps/team1-customer-client-5cd49cd966    0         0         0       4d8h\nreplicaset.apps/team1-customer-client-65ccf985b7    0         0         0       7d4h\nreplicaset.apps/team1-customer-client-665b678cd7    1         1         1       4d8h\nreplicaset.apps/team1-customer-client-6cf54cfb4d    0         0         0       7d3h\nreplicaset.apps/team1-purchase-api-5649cdcdf6       0         0         0       2d5h\nreplicaset.apps/team1-purchase-api-5dff7cb498       0         0         0       2d5h\nreplicaset.apps/team1-purchase-api-65bcd55fb8       0         0         0       2d15h\nreplicaset.apps/team1-purchase-api-65d8d5d4bc       0         0         0       2d15h\nreplicaset.apps/team1-purchase-api-6977b8564        0         0         0       2d19h\nreplicaset.apps/team1-purchase-api-78d85db5f7       0         0         0       2d19h\nreplicaset.apps/team1-purchase-api-796dcdcd7b       0         0         0       2d19h\nreplicaset.apps/team1-purchase-api-94f4676cf        1         1         1       2d5h\nreplicaset.apps/team1-purchase-api-c5dbfdb55        0         0         0       2d19h\nreplicaset.apps/team1-purchase-api-f4d7658c7        0         0         0       2d15h\nreplicaset.apps/team1-purchase-api-fcf98cfb8        0         0         0       2d19h\nreplicaset.apps/team1-report-processor-59d98d58fd   0         0         0       41h\nreplicaset.apps/team1-report-processor-667c5df867   0         0         0       41h\nreplicaset.apps/team1-report-processor-699445b644   0         0         0       41h\nreplicaset.apps/team1-report-processor-6bb7d46856   0         0         0       40h\nreplicaset.apps/team1-report-processor-769d55cdb6   1         1         1       31h\nreplicaset.apps/team1-report-processor-78b8c986c5   0         0         0       41h\nreplicaset.apps/team1-report-processor-796f4cbb56   0         0         0       31h\nreplicaset.apps/team1-report-processor-79869d9986   0         0         0       41h\nreplicaset.apps/team1-report-processor-858d85d77d   0         0         0       31h\nreplicaset.apps/team1-report-processor-8696f4c5b4   0         0         0       40h\nreplicaset.apps/team1-report-processor-8d74849d     0         0         0       40h\n\nNAME                                                  READY   AGE\nstatefulset.apps/team1-customer-database-postgresql   1/1     6d15h\nstatefulset.apps/team1-rabbitmq-server                1/1     40h\nstatefulset.apps/team1-report-database-postgresql     1/1     2d22h\n\nNAME                                          ALLREPLICASREADY   RECONCILESUCCESS   AGE\nrabbitmqcluster.rabbitmq.com/team1-rabbitmq   True               True               40h\n</code></pre>\n",
    "tags" : [ "java", "kubernetes", "quarkus", "rancher" ],
    "owner" : {
      "account_id" : 40066284,
      "reputation" : 11,
      "user_id" : 30370718,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/tOMi5tyf.jpg?s=256",
      "display_name" : "ASingh",
      "link" : "https://stackoverflow.com/users/30370718/asingh"
    },
    "is_answered" : false,
    "view_count" : 101,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1745869140,
    "creation_date" : 1745681287,
    "link" : "https://stackoverflow.com/questions/79594093/how-to-prevent-a-socket-error-connecting-with-rabbitmq",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79597172,
    "question_id" : 79594093,
    "body" : "<p>Hi <a href=\"https://stackoverflow.com/users/30370718/arihant-singh\">Arihant Singh</a>,</p>\n<p>Your rabbit hostname must be something like : <code>rabbitmq.host=&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</code></p>\n<p>So ,in your properties file, replace <code>rabbitmq.host=rabbitmq.rabbitmq.svc.cluster.local </code>by  <code>rabbitmq.host=team1-rabbitmq.default.svc.cluster.local </code>as defined in your kube service config.</p>\n<p>Don't forget to do the same for other hostnames or use variables references to avoid reapeating config :</p>\n<pre><code>rabbitmq.host=team1-rabbitmq.default.svc.cluster.local\nrabbitmq.port=5672\nrabbitmq.username=team1\nrabbitmq.password=team1\nmp.messaging.outgoing.order-response.rabbitmq.host=${rabbitmq.host}\nmp.messaging.outgoing.order-response.rabbitmq.port=${rabbitmq.port}\nmp.messaging.outgoing.order-response.rabbitmq.username=${rabbitmq.username}\nmp.messaging.outgoing.order-response.rabbitmq.password=${rabbitmq.password}\nmp.messaging.incoming.reportsqueue.rabbitmq.host=${rabbitmq.host}\nmp.messaging.incoming.reportsqueue.rabbitmq.port=${rabbitmq.port}\nmp.messaging.incoming.reportsqueue.rabbitmq.username=${rabbitmq.username}\nmp.messaging.incoming.reportsqueue.rabbitmq.password=${rabbitmq.password}\n\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1238505,
      "reputation" : 2200,
      "user_id" : 1201612,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f5c051d353c604cdd015ae8135dcad56?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "S&#233;bastien Helbert",
      "link" : "https://stackoverflow.com/users/1201612/s%c3%a9bastien-helbert"
    },
    "creation_date" : 1745868745,
    "last_activity_date" : 1745869140,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140375659,
    "post_id" : 79594093,
    "body" : "Yup I&#39;ll add an edited section with it @MarkusWMahlberg",
    "score" : 0,
    "owner" : {
      "account_id" : 40066284,
      "reputation" : 11,
      "user_id" : 30370718,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/tOMi5tyf.jpg?s=256",
      "display_name" : "ASingh",
      "link" : "https://stackoverflow.com/users/30370718/asingh"
    },
    "creation_date" : 1745828693,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140375137,
    "post_id" : 79594093,
    "body" : "can you add the output of <code>kubectl -n rabbitmq get svc rabbitmq -o yaml</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 1358954,
      "reputation" : 21002,
      "user_id" : 1296707,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/cc4319dbdd4adbb6d25f1eb2309eec20?s=256&d=identicon&r=PG",
      "display_name" : "Markus W Mahlberg",
      "link" : "https://stackoverflow.com/users/1296707/markus-w-mahlberg"
    },
    "creation_date" : 1745815126,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79597172" : [ {
      "comment_id" : 140378962,
      "post_id" : 79597172,
      "body" : "if so please update your question, or check your properties file. You may also need to refactor your RabbitMQClientImpl to log errors properly with details about connection parameters used.",
      "score" : 0,
      "owner" : {
        "account_id" : 1238505,
        "reputation" : 2200,
        "user_id" : 1201612,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/f5c051d353c604cdd015ae8135dcad56?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "S&#233;bastien Helbert",
        "link" : "https://stackoverflow.com/users/1201612/s%c3%a9bastien-helbert"
      },
      "creation_date" : 1745909769,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140378380,
      "post_id" : 79597172,
      "body" : "I do have that in my application.properties but am still getting the error unfortunately",
      "score" : 0,
      "owner" : {
        "account_id" : 40066284,
        "reputation" : 11,
        "user_id" : 30370718,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/tOMi5tyf.jpg?s=256",
        "display_name" : "ASingh",
        "link" : "https://stackoverflow.com/users/30370718/asingh"
      },
      "creation_date" : 1745888264,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}