{
  "question" : {
    "question_id" : 79794732,
    "title" : "Normalize URLs which might be encoded or not",
    "body" : "<p>I have an app where users enter WebDav URLs. In some cases, these URLs are properly encoded, but in some cases they are not.</p>\n<pre><code>    String[] testUrls = {\n                // Plain, unencoded\n                &quot;https://exämple.com/földer/file 1.txt&quot;,\n                // Properly encoded\n                &quot;https://example.com/f%C3%B6lder/file%201.txt&quot;,\n                // Partially encoded\n                &quot;https://example.com/f%C3%B6lder/file 1.txt&quot;,\n                // Invalid percent sequence\n                &quot;https://example.com/100%done.txt&quot;,\n                // Percent at end\n                &quot;https://example.com/file%&quot;,\n                // Space and umlaut unencoded\n                &quot;https://example.com/ä ö ü.txt&quot;,\n                // Nested folders with mixed encoding\n                &quot;https://example.com/a%20b/c d/e%20f.txt&quot;\n        };\n</code></pre>\n<p>With</p>\n<pre><code>public static String normalizeUrl(String url) {\n        if (url == null) return null;\n        try {\n            // Step 1: sanitize invalid % sequences\n            String safe = url.replaceAll(&quot;%(?![0-9A-Fa-f]{2})&quot;, &quot;%25&quot;);\n\n            // Step 2: decode and re-encode safely (UTF-8)\n            String decoded = URLDecoder.decode(safe, &quot;UTF-8&quot;);\n            String encoded = URLEncoder.encode(decoded, &quot;UTF-8&quot;);\n\n            // Step 3: URLEncoder encodes spaces as '+', but URLs use '%20'\n            encoded = encoded.replace(&quot;+&quot;, &quot;%20&quot;);\n\n            // Step 4: URLEncoder encodes '/' and : — undo that\n            encoded = encoded.replace(&quot;%2F&quot;, &quot;/&quot;);\n            encoded = encoded.replace(&quot;%3A&quot;, &quot;:&quot;);\n\n            return encoded;\n        } catch (IllegalArgumentException | UnsupportedEncodingException e) {\n            // fallback: return original URL unchanged\n            return url;\n        }\n</code></pre>\n<p>I get expected results:</p>\n<pre><code>Original:   https://exämple.com/földer/file 1.txt\nNormalized: https://ex%C3%A4mple.com/f%C3%B6lder/file%201.txt\n-------------------------------\nOriginal:   https://example.com/f%C3%B6lder/file%201.txt\nNormalized: https://example.com/f%C3%B6lder/file%201.txt\n-------------------------------\nOriginal:   https://example.com/f%C3%B6lder/file 1.txt\nNormalized: https://example.com/f%C3%B6lder/file%201.txt\n-------------------------------\nOriginal:   https://example.com/100%done.txt\nNormalized: https://example.com/100%25done.txt\n-------------------------------\nOriginal:   https://example.com/file%\nNormalized: https://example.com/file%25\n-------------------------------\nOriginal:   https://example.com/ä ö ü.txt\nNormalized: https://example.com/%C3%A4%20%C3%B6%20%C3%BC.txt\n-------------------------------\nOriginal:   https://example.com/a%20b/c d/e%20f.txt\nNormalized: https://example.com/a%20b/c%20d/e%20f.txt\n</code></pre>\n<p>but this implementation feels fragile and weird, as it encodes everything and then replaces some characters back (but probably should also replace back other reserved characters?).</p>\n<p>I like the general idea of decoding first such that I have &quot;normalized to unencoded&quot; and then encoding again, but it seems suprisingly difficult to come up with a robust implementation. Is there a standard solution to this problem?</p>\n",
    "tags" : [ "java", "urlencode" ],
    "owner" : {
      "account_id" : 110440,
      "reputation" : 11659,
      "user_id" : 292233,
      "user_type" : "registered",
      "accept_rate" : 65,
      "profile_image" : "https://www.gravatar.com/avatar/f019e9eda50ab50b72bafa7b2f9f03e1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Philipp",
      "link" : "https://stackoverflow.com/users/292233/philipp"
    },
    "is_answered" : false,
    "view_count" : 85,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1760950571,
    "creation_date" : 1760950571,
    "link" : "https://stackoverflow.com/questions/79794732/normalize-urls-which-might-be-encoded-or-not",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140808869,
    "post_id" : 79794732,
    "body" : "There is no API that can handle your “Partially encoded” case.  You’ll have to write that yourself.  I just hope no input consists of something like <code>https:&#47;&#47;example.com&#47;books%about%education</code>, because that requires human intelligence to interpret properly.",
    "score" : 1,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44991,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1761059808,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140806613,
    "post_id" : 79794732,
    "body" : "I found that in .net: <code>new System.Uri(url).AbsoluteUri</code> gives exactly the desired values. As my project can do the normalization either in Java or C#, it seems like I can simply use that.",
    "score" : 0,
    "owner" : {
      "account_id" : 110440,
      "reputation" : 11659,
      "user_id" : 292233,
      "user_type" : "registered",
      "accept_rate" : 65,
      "profile_image" : "https://www.gravatar.com/avatar/f019e9eda50ab50b72bafa7b2f9f03e1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Philipp",
      "link" : "https://stackoverflow.com/users/292233/philipp"
    },
    "creation_date" : 1760972630,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140806546,
    "post_id" : 79794732,
    "body" : "Thanks for the hints. From researching further, I think &quot;URL normalization&quot; (as done by browsers) according to WHATWG is what I&#39;m looking for and comes with a definition of ho to make these decisions, right?",
    "score" : 0,
    "owner" : {
      "account_id" : 110440,
      "reputation" : 11659,
      "user_id" : 292233,
      "user_type" : "registered",
      "accept_rate" : 65,
      "profile_image" : "https://www.gravatar.com/avatar/f019e9eda50ab50b72bafa7b2f9f03e1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Philipp",
      "link" : "https://stackoverflow.com/users/292233/philipp"
    },
    "creation_date" : 1760971026,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140806062,
    "post_id" : 79794732,
    "body" : "<code>URLDecoder</code> and <code>URLEncoder</code> may have the term “URL” in their names but are not related to what you’re doing here; that’s why you have to do so many fixes. Since sloppily encoded URIs can be ambiguous, you have to do the decision of which parts belong to 1) the scheme, 2) the scheme specific part, and 3) the fragment, if any. Then, you can use the constructor <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/net/URI.html#%3Cinit%3E(java.lang.String,java.lang.String,java.lang.String)\" rel=\"nofollow noreferrer\"><code>URI(String scheme, String ssp, String fragment)</code></a> (and <code>toASCIIString()</code> if you need to)",
    "score" : 4,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 301001,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1760954910,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}