{
  "question" : {
    "question_id" : 79697051,
    "title" : "Send PCFMessage with JMS",
    "body" : "<p>I'm trying to write an application to query the statistics of the IBM MQ queues in Spring Boot.</p>\n<p>To do so, I'm using</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependency&gt;\n    &lt;groupId&gt;com.ibm.mq&lt;/groupId&gt;\n    &lt;artifactId&gt;mq-jms-spring-boot-starter&lt;/artifactId&gt;\n    &lt;version&gt;3.5.3&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>and, by following this documentation <a href=\"https://www.ibm.com/docs/en/ibm-mq/9.4.x?topic=package-using-mq-classes-jms\" rel=\"nofollow noreferrer\">https://www.ibm.com/docs/en/ibm-mq/9.4.x?topic=package-using-mq-classes-jms</a>, I wrote the following demo code</p>\n<pre class=\"lang-java prettyprint-override\"><code>Queue inputQueue = jmsTemplate.execute(session -&gt; {\n    var queue = session.createQueue(&quot;SYSTEM.ADMIN.COMMAND.QUEUE&quot;);\n    ((MQQueue) queue).setIntProperty(WMQConstants.WMQ_MESSAGE_BODY, WMQConstants.WMQ_MESSAGE_BODY_MQ);\n    ((MQQueue) queue).setMQMDWriteEnabled(true);\n\n    return queue;\n});\ntry {\n    BytesMessage msg = (BytesMessage) jmsTemplate.sendAndReceive(inputQueue, ActuatorExtConfig::build);\n\n    var bytes = new byte[(int) msg.getBodyLength()];\n    var bais = new ByteArrayInputStream(bytes);\n    var dis = new DataInputStream(bais);\n    var out = new PCFMessage(dis);\n    out.getParameterValue(CMQCFC.MQCACF_Q_NAMES);\n    System.out.println(out);\n} catch (Exception ex) {\n    ex.printStackTrace();\n}\n\nprivate static Message build(Session session) {\n    PCFMessage request = new PCFMessage(CMQCFC.MQCMD_INQUIRE_Q_NAMES);\n    request.addParameter(CMQC.MQCA_Q_NAME, &quot;*&quot;);\n\n    var baos = new ByteArrayOutputStream();\n    try (baos; var das = new DataOutputStream(baos)) {\n        request.write(das);\n        baos.flush();\n    } catch (IOException e) {\n        throw new RuntimeException(e);\n    }\n\n    try {\n        var m = session.createBytesMessage();\n        m.setJMSPriority(-1);\n        m.setJMSDeliveryMode(DeliveryMode.NON_PERSISTENT);\n        m.writeBytes(baos.toByteArray());\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_MSGTYPE, 1);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_FEEDBACK, 0);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_PERSISTENCE, CMQC.MQPER_NOT_PERSISTENT);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_EXPIRY, 300);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_REPORT, CMQC.MQRO_PASS_CORREL_ID);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_ENCODING, CMQC.MQENC_NATIVE);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_CODEDCHARSETID, 1208);\n        m.setIntProperty(WMQConstants.JMS_IBM_MQMD_PRIORITY, -1);\n        m.setStringProperty(WMQConstants.JMS_IBM_MQMD_FORMAT, CMQC.MQFMT_ADMIN);\n\n        return m;\n    } catch (Exception ex) {\n        throw new RuntimeException(ex);\n    }\n}\n</code></pre>\n<p>but the response I get back is basically empty</p>\n<pre><code>PCFMessage: \nMQCFH (com.ibm.mq.headers.internal.store.ByteStore [encoding: 0x00000111, ccsid: 0, size: 36] @56757931)\n    MQLONG Type: 0 (0x00000000)\n    MQLONG StrucLength: 0 (0x00000000)\n    MQLONG Version: 0 (0x00000000)\n    MQLONG Command: 0 (0x00000000)\n    MQLONG MsgSeqNumber: 0 (0x00000000)\n    MQLONG Control: 0 (0x00000000)\n    MQLONG CompCode: 0 (0x00000000)\n    MQLONG Reason: 0 (0x00000000)\n    MQLONG ParameterCount: 0 (0x00000000)\n</code></pre>\n<p>while the same query, executed with the <code>PCFMessageAgent</code> like below</p>\n<pre class=\"lang-java prettyprint-override\"><code>System.setProperty(&quot;java.library.path&quot;, &quot;/opt/mqm/java/lib64&quot;);\nSystem.setProperty(&quot;javax.net.ssl.trustStore&quot;, props.getJks().getTrustStore());\nSystem.setProperty(&quot;com.ibm.mq.cfg.useIBMCipherMappings&quot;, Boolean.FALSE.toString());\n\nMQEnvironment.hostname = &quot;my-host&quot;;\nMQEnvironment.port = 15003;\nMQEnvironment.channel = props.getChannel();\nMQEnvironment.sslCipherSuite = props.getSslCipherSpec();\nMQEnvironment.userID = props.getUser();\nMQEnvironment.password = props.getPassword();\ntry {\n    var queueManager = new MQQueueManager(props.getQueueManager());\n\n    PCFMessageAgent agent = new PCFMessageAgent(queueManager);\n    PCFMessage request = new PCFMessage(CMQCFC.MQCMD_INQUIRE_Q_NAMES);\n    request.addParameter(CMQC.MQCA_Q_NAME, &quot;*&quot;);\n\n    PCFMessage[] responses = agent.send(request);\n    System.out.println(responses[0]);\n    queueManager.close();\n} catch (Exception e) {\n    e.printStackTrace();\n}\n</code></pre>\n<p>returns the correct response (the list of the available queues in this case).</p>\n<p>What am I missing so that it could work also with JMS?</p>\n",
    "tags" : [ "java", "spring-boot", "ibm-mq" ],
    "owner" : {
      "account_id" : 7816784,
      "reputation" : 99,
      "user_id" : 5911228,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "cdprete",
      "link" : "https://stackoverflow.com/users/5911228/cdprete"
    },
    "is_answered" : true,
    "view_count" : 75,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1752153178,
    "creation_date" : 1752150221,
    "link" : "https://stackoverflow.com/questions/79697051/send-pcfmessage-with-jms",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79697116,
    "question_id" : 79697051,
    "body" : "<p>In the end, the issue was caused by an encoding and/or format mismatch between the IBM MQ server and the JMS client machine.</p>\n<p>Changing the parsing of the response as follows fixed the issue:</p>\n<pre class=\"lang-java prettyprint-override\"><code>BytesMessage msg = (BytesMessage) jmsTemplate.sendAndReceive(inputQueue, ActuatorExtConfig::build);\nbyte[] bytes = new byte[(int) msg.getBodyLength()];\nmsg.readBytes(bytes);\nMQMessage mqMsg = new MQMessage();\nmqMsg.write(bytes);\nmqMsg.encoding = msg.getIntProperty(WMQConstants.JMS_IBM_ENCODING);\nmqMsg.format = msg.getStringProperty(WMQConstants.JMS_IBM_FORMAT);\nmqMsg.seek(0);\nvar out = new PCFMessage(mqMsg);\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 7816784,
      "reputation" : 99,
      "user_id" : 5911228,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "cdprete",
      "link" : "https://stackoverflow.com/users/5911228/cdprete"
    },
    "creation_date" : 1752153178,
    "last_activity_date" : 1752153178,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140579890,
    "post_id" : 79697051,
    "body" : "See my answer below :)",
    "score" : 0,
    "owner" : {
      "account_id" : 7816784,
      "reputation" : 99,
      "user_id" : 5911228,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "cdprete",
      "link" : "https://stackoverflow.com/users/5911228/cdprete"
    },
    "creation_date" : 1752153215,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140579799,
    "post_id" : 79697051,
    "body" : "If you put your message to a side queue instead of the command queue, just so you can look at it, and then browse it using the amqsbcg sample application, what does it show as your input message?",
    "score" : 0,
    "owner" : {
      "account_id" : 5032228,
      "reputation" : 7534,
      "user_id" : 4042083,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/65742aa944f8372503bd71d44023ba96?s=256&d=identicon&r=PG",
      "display_name" : "Morag Hughson",
      "link" : "https://stackoverflow.com/users/4042083/morag-hughson"
    },
    "creation_date" : 1752151093,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79697116" : [ {
      "comment_id" : 140748092,
      "post_id" : 79697116,
      "body" : "This is the link to the IBM MQ docs: <a href=\"https://www.ibm.com/docs/en/ibm-mq/9.4.x?topic=problems-pcf-processing-in-jms\" rel=\"nofollow noreferrer\">ibm.com/docs/en/ibm-mq/&hellip;</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 320241,
        "reputation" : 2217,
        "user_id" : 638413,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/5a3a38ff26bd38771d4f943ead8ba722?s=256&d=identicon&r=PG",
        "display_name" : "Daniel Steinmann",
        "link" : "https://stackoverflow.com/users/638413/daniel-steinmann"
      },
      "creation_date" : 1758311730,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140581915,
      "post_id" : 79697116,
      "body" : "@cdprete Morag Hughson I&#39;m replying here since I can&#39;t add a reply under you comment somehow.  I would love as well to find that page again, to be honest :)",
      "score" : 1,
      "owner" : {
        "account_id" : 7816784,
        "reputation" : 99,
        "user_id" : 5911228,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "cdprete",
        "link" : "https://stackoverflow.com/users/5911228/cdprete"
      },
      "creation_date" : 1752225966,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140581623,
      "post_id" : 79697116,
      "body" : "Setting them both for a get or setting them both for a put? For put it makes sense, nay, is essential. For get I don&#39;t think it does anything. If you can point me to the page, I would love to review it.",
      "score" : 1,
      "owner" : {
        "account_id" : 5032228,
        "reputation" : 7534,
        "user_id" : 4042083,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/65742aa944f8372503bd71d44023ba96?s=256&d=identicon&r=PG",
        "display_name" : "Morag Hughson",
        "link" : "https://stackoverflow.com/users/4042083/morag-hughson"
      },
      "creation_date" : 1752217236,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140581481,
      "post_id" : 79697116,
      "body" : "@MoragHughson Yeah, I doubt as well the format is of any help here, but I remember I found a page in the IBM MQ docs were it was setting them both.",
      "score" : 0,
      "owner" : {
        "account_id" : 7816784,
        "reputation" : 99,
        "user_id" : 5911228,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "cdprete",
        "link" : "https://stackoverflow.com/users/5911228/cdprete"
      },
      "creation_date" : 1752212152,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140581068,
      "post_id" : 79697116,
      "body" : "I don&#39;t know what a format mismatch is, but certainly if your message was in a different encoding, you would certainly need to ask for it to be converted (which I assume is what this does). Perhaps you should also add the <code>CODEDCHARSETID</code> you want it in too in case you ever need to run it on a non-ASCII machine? I&#39;m not certain that setting the format is doing anything for you though.",
      "score" : 0,
      "owner" : {
        "account_id" : 5032228,
        "reputation" : 7534,
        "user_id" : 4042083,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/65742aa944f8372503bd71d44023ba96?s=256&d=identicon&r=PG",
        "display_name" : "Morag Hughson",
        "link" : "https://stackoverflow.com/users/4042083/morag-hughson"
      },
      "creation_date" : 1752184816,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}