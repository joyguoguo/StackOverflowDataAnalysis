{
  "question" : {
    "question_id" : 79800345,
    "title" : "Expanding Spring Modulith tracing tags",
    "body" : "<p>I am using Spring Modulith 2.0.0-M3 with Spring Boot 4.0.0-RC1. I have enabled zipkin tracing export and I can see that Spring Modulith adds a <code>module.key</code> and <code>module.method</code> tags to the trace.</p>\n<p>I would like to expand this with two more high-cardinality tags: bean name and class name of the invoked methods. I can see that Modulith has a package-private implementation: <code>DefaultModulithObservationConvention</code> which seems like something I want to extend to add these 2 new tags.</p>\n<p>I can copy/paste the default implementation and add these 2 tags, but that seems like a bad way to go and I cannot find any documentation for this.</p>\n<p>Is there a better way to add these 2 tags?</p>\n",
    "tags" : [ "java", "spring-boot", "spring-modulith" ],
    "owner" : {
      "account_id" : 6886800,
      "reputation" : 1129,
      "user_id" : 5291611,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/21e356690b1071eb3f81ce47cc14c84b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "alturkovic",
      "link" : "https://stackoverflow.com/users/5291611/alturkovic"
    },
    "is_answered" : true,
    "view_count" : 206,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1762521568,
    "creation_date" : 1761517883,
    "link" : "https://stackoverflow.com/questions/79800345/expanding-spring-modulith-tracing-tags",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79812086,
    "question_id" : 79800345,
    "body" : "<p>Perhaps you use reflection to avoid copy/pasta?</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\nModulithObservationConvention modulithObservationConvention() throws Exception {\n    Class&lt;?&gt; type = Class.forName(&quot;org.springframework.modulith.observability.support.DefaultModulithObservationConvention&quot;);\n    type.setAccessible(true);\n    Constructor constructor = type.getDeclaredConstructor();\n    constructor.setAccessible(true);\n    ModulithObservationConvention delegate = (ModulithObservationConvention) constructor.newInstance();\n    return new ModulithObservationConvention {\n        @Override\n        public boolean supportsContext(Observation.Context context) {\n            return delegate.supportsContext(context);\n        }\n\n        @Override\n        public String getName() {\n            return delegate.getName();\n        }\n\n        @Override\n        public KeyValues getLowCardinalityKeyValues(ModulithObservationContext context) {\n            return delegate.getLowCardinalityKeyValues(context);\n        }\n\n        @Override\n        public KeyValues getHighCardinalityKeyValues(ModulithObservationContext context) {\n            KeyValues delegateKvs = delegate.getHighCardinalityKeyValues(context);\n            KeyValues customKvs = KeyValues.of(\n                &quot;bean.name&quot;, &quot;sample&quot;,\n                &quot;class.name&quot;, &quot;foo.bar.Sample&quot;\n            );\n            return KeyValues.concat(delegateKvs, customKvs); \n        }\n    };\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1096470,
      "reputation" : 29424,
      "user_id" : 1089967,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
      "display_name" : "lance-java",
      "link" : "https://stackoverflow.com/users/1089967/lance-java"
    },
    "creation_date" : 1762504502,
    "last_activity_date" : 1762521568,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79810171,
    "question_id" : 79800345,
    "body" : "<p>You can’t extend <code>DefaultModulithObservationConvention</code>, it’s <strong>package-private</strong> by design.\nThe proper way is to define your own <code>ObservationConvention&lt;ModulithObservationContext&gt;</code> bean.\nSpring Modulith will automatically use it instead of the internal default.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\nObservationConvention&lt;ModulithObservationContext&gt; modulithObservationConvention() {\n    return new ObservationConvention&lt;&gt;() {\n        @Override\n        public boolean supportsContext(Observation.Context context) {\n            return context instanceof ModulithObservationContext;\n        }\n\n        @Override\n        public String getName() {\n            return &quot;modulith.observation&quot;;\n        }\n\n        @Override\n        public KeyValues getLowCardinalityKeyValues(ModulithObservationContext context) {\n            return KeyValues.of(\n                &quot;module.key&quot;, context.getModule().getName(),\n                &quot;module.method&quot;, context.getMethod().getName()\n            );\n        }\n\n        @Override\n        public KeyValues getHighCardinalityKeyValues(ModulithObservationContext context) {\n            return KeyValues.of(\n                &quot;bean.name&quot;, context.getBean().getClass().getSimpleName(),\n                &quot;class.name&quot;, context.getMethod().getDeclaringClass().getName()\n            );\n        }\n    };\n}\n</code></pre>\n<p>This replaces the built-in convention and lets you add any extra tags (<code>bean.name</code>, <code>class.name</code>, etc.)\nNo internal classes need to be copied or modified.</p>\n<p><strong>In short:</strong> register your own <code>ObservationConvention&lt;ModulithObservationContext&gt;</code> bean : it safely overrides the default and gives you full control over trace tags.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 12972904,
      "reputation" : 1113,
      "user_id" : 9377995,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Hl13jffO.png?s=256",
      "display_name" : "gdoura mohamed",
      "link" : "https://stackoverflow.com/users/9377995/gdoura-mohamed"
    },
    "creation_date" : 1762351650,
    "last_activity_date" : 1762351650,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79812086" : [ {
      "comment_id" : 140841691,
      "post_id" : 79812086,
      "body" : "@alturkovic Its&#39; a dirty hack for sure.... I won&#39;t tell if you don&#39;t :)",
      "score" : 0,
      "owner" : {
        "account_id" : 1096470,
        "reputation" : 29424,
        "user_id" : 1089967,
        "user_type" : "registered",
        "accept_rate" : 59,
        "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
        "display_name" : "lance-java",
        "link" : "https://stackoverflow.com/users/1089967/lance-java"
      },
      "creation_date" : 1762514663,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140841675,
      "post_id" : 79812086,
      "body" : "That would work, but... :D I was hoping for a better support in the framework itself, but thanks for the suggestion, will keep it in mind",
      "score" : 0,
      "owner" : {
        "account_id" : 6886800,
        "reputation" : 1129,
        "user_id" : 5291611,
        "user_type" : "registered",
        "accept_rate" : 96,
        "profile_image" : "https://www.gravatar.com/avatar/21e356690b1071eb3f81ce47cc14c84b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "alturkovic",
        "link" : "https://stackoverflow.com/users/5291611/alturkovic"
      },
      "creation_date" : 1762514082,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79810171" : [ {
      "comment_id" : 140840727,
      "post_id" : 79810171,
      "body" : "This does not match the default implementation at all. There is no support for <code>EventListener</code> or the <code>module.invocation-type</code> tag and the <code>module.method</code> is a high-cardinality tag in that implementation. Of course I could do it like this and that is exactly what I said I DO NOT want to do in my question. I want to add 2 more tags without compromising on the default behavior.",
      "score" : 0,
      "owner" : {
        "account_id" : 6886800,
        "reputation" : 1129,
        "user_id" : 5291611,
        "user_type" : "registered",
        "accept_rate" : 96,
        "profile_image" : "https://www.gravatar.com/avatar/21e356690b1071eb3f81ce47cc14c84b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "alturkovic",
        "link" : "https://stackoverflow.com/users/5291611/alturkovic"
      },
      "creation_date" : 1762459656,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140839379,
      "post_id" : 79810171,
      "body" : "Did you generate this answer?",
      "score" : 2,
      "owner" : {
        "account_id" : 17592368,
        "reputation" : 19777,
        "user_id" : 12763954,
        "user_type" : "registered",
        "profile_image" : "https://lh6.googleusercontent.com/-uYTsiw1bQ_o/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rev-nenZRronqGEJxeFQWww3ShBnQ/s256-rj/photo.jpg",
        "display_name" : "Olivier",
        "link" : "https://stackoverflow.com/users/12763954/olivier"
      },
      "creation_date" : 1762414892,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}