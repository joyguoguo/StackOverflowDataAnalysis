{
  "question" : {
    "question_id" : 79687132,
    "title" : "hibernate 6.6 no longer throws PessimisticLockingFailureException",
    "body" : "<p>After upgrading spring boot to 3.4, which includes hibernate 6.6 (per <a href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.4-Release-Notes\" rel=\"nofollow noreferrer\">https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.4-Release-Notes</a>), the following method :</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\n  @Lock(LockModeType.PESSIMISTIC_WRITE)\n  @Nonnull\n  Optional&lt;DossierDb&gt; findById(@Nonnull UUID id);\n</code></pre>\n<p>in a CrudRepository (defined by</p>\n<pre><code>@Repository\npublic interface DossierDbRepository\n    extends CrudRepository&lt;DossierDb, UUID&gt;\n</code></pre>\n<p>has stopped throwing PessimisticLockingFailureException (in a test method using retryable).</p>\n<p>I still see the log</p>\n<p><code>ERROR: current transaction is aborted, commands ignored until end of transaction block</code>, but I now get an optional empty when in spring boot 3.3 I got the log AND the error. I looked in <a href=\"https://github.com/spring-projects/spring-data-jpa/releases\" rel=\"nofollow noreferrer\">spring data jpa</a>, <a href=\"https://github.com/spring-projects/spring-boot/wiki/Spring-Boot-3.4-Release-Notes\" rel=\"nofollow noreferrer\">spring boot release</a> and hibernate <a href=\"https://docs.jboss.org/hibernate/orm/6.5/migration-guide/migration-guide.html\" rel=\"nofollow noreferrer\">6.5</a> and <a href=\"https://docs.jboss.org/hibernate/orm/6.6/migration-guide/migration-guide.html\" rel=\"nofollow noreferrer\">6.6</a> migration guide but didn't see anything mentioning clearly this change of behaviour.</p>\n<p>Given the log appears in hibernate I assume the change occured there, and their <a href=\"https://hibernate.org/community/\" rel=\"nofollow noreferrer\">community page</a> mentions SO as the place to ask questions.</p>\n<p>I can give additional details on the context and the test triggering this but I think the given code is the strict minimum to understand the existing problem.</p>\n<p><strong>edit to include tried hacks and their results</strong></p>\n<ol>\n<li>adding a @query annotation</li>\n</ol>\n<p>When adding the following annotation to my findById method :</p>\n<p><code>@Query(&quot;select d from DossierDb d where d.id = :id&quot;)</code>\nI get a different exception :\n<code>JpaSystemException: JDBC exception executing SQL [select {list of dossierDb columns} where id= for no key update][ERROR: current transaction is aborted, commands ignored until end of transaction block]</code>, that correctly triggers my Retryable</p>\n<ol start=\"2\">\n<li>using @Transactional(noRollbackFor = PessimisticLockException.class)</li>\n</ol>\n<p>Adding that annotation to my findById method, or modifying my existing transactional <code>isolation = Isolation.REPEATABLE_READ</code> annotation to add the noRollbackFor information, made no change in my logs whatsoever.</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "hibernate", "jpa" ],
    "owner" : {
      "account_id" : 9497270,
      "reputation" : 695,
      "user_id" : 7059810,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-VapuBpohUJQ/AAAAAAAAAAI/AAAAAAAAACc/nmnZdjFY1qI/s256-rj/photo.jpg",
      "display_name" : "Jonathan Simonney",
      "link" : "https://stackoverflow.com/users/7059810/jonathan-simonney"
    },
    "is_answered" : false,
    "view_count" : 178,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1751537031,
    "creation_date" : 1751446526,
    "link" : "https://stackoverflow.com/questions/79687132/hibernate-6-6-no-longer-throws-pessimisticlockingfailureexception",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140561512,
    "post_id" : 79687132,
    "body" : "tried it, didn&#39;t help. Thanks for the proposal however !",
    "score" : 0,
    "owner" : {
      "account_id" : 9497270,
      "reputation" : 695,
      "user_id" : 7059810,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-VapuBpohUJQ/AAAAAAAAAAI/AAAAAAAAACc/nmnZdjFY1qI/s256-rj/photo.jpg",
      "display_name" : "Jonathan Simonney",
      "link" : "https://stackoverflow.com/users/7059810/jonathan-simonney"
    },
    "creation_date" : 1751537100,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140561343,
    "post_id" : 79687132,
    "body" : "try using @Transactional(noRollbackFor = PessimisticLockException.class) and see if that helps",
    "score" : 0,
    "owner" : {
      "account_id" : 1512934,
      "reputation" : 765,
      "user_id" : 1414594,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/791eca52586bec514a8f92f463bbe464?s=256&d=identicon&r=PG",
      "display_name" : "Hendra",
      "link" : "https://stackoverflow.com/users/1414594/hendra"
    },
    "creation_date" : 1751533868,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}