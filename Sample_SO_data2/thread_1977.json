{
  "question" : {
    "question_id" : 79662266,
    "title" : "How to lock database fields for all containers with Java",
    "body" : "<p><strong>Concurrent Access to Database Records in Quarkus</strong></p>\n<p>I have a Quarkus application with two containers that are accessing the same database records on a schedule. The records have a field that is marked as <code>YES</code> initially, and after processing, the containers update the field to <code>NO</code>. However, since the containers are running concurrently, they are accessing the same records and overwriting each other's updates.</p>\n<p><strong>Problem Statement</strong></p>\n<p>How can I ensure that the containers access the database records in a way that prevents concurrent updates and read and ensures that each record is processed only once?</p>\n<p><strong>Observations</strong></p>\n<ul>\n<li>I can't change the schedule time for the containers and it shouldn't be the solution, because more containers are going to be added.</li>\n<li>Already tried adding <code>PESSIMISTIC_WRITE</code> lock, but didn't worked, it still read the field that was already being processed</li>\n</ul>\n",
    "tags" : [ "java", "database", "transactions", "locking", "quarkus" ],
    "owner" : {
      "account_id" : 30321380,
      "reputation" : 1378,
      "user_id" : 23237053,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/3GrS5.jpg?s=256",
      "display_name" : "Kobra",
      "link" : "https://stackoverflow.com/users/23237053/kobra"
    },
    "is_answered" : false,
    "view_count" : 128,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1749713277,
    "creation_date" : 1749655811,
    "link" : "https://stackoverflow.com/questions/79662266/how-to-lock-database-fields-for-all-containers-with-java",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79662526,
    "question_id" : 79662266,
    "body" : "<p>You will need <strong>Distributed Locking</strong> for this scenario</p>\n<ul>\n<li><p>Container 1 opens a page for updating some record.</p>\n</li>\n<li><p>Container 2 opens page for updating same record as container 1.</p>\n</li>\n<li><p>Now if container 1 updates something it will be overwritten if something is updated by container 2. Similarly container 1 will overwrite container 2 update.</p>\n</li>\n</ul>\n<p>You can not implement <code>PESSIMISTIC LOCK</code> without acquiring a lock in a distributed environment like yours.</p>\n<p><strong>WHAT IS DISTRIBUTED LOCKING?</strong></p>\n<p>It is mechanism to avoid conflicting/concurrent updates on a shared resource which may potentially cause corruption.</p>\n<p><strong>HOW IT WORKS?</strong></p>\n<p>Distributed locking ensures mutual exclusion across multiple nodes by allowing only one process to access a shared resource at a time, usually by acquiring a lock with a defined time-to-live (TTL).</p>\n<p><strong>TOOLS YOU CAN USE FOR DISTRIBUTED LOCKING</strong></p>\n<ul>\n<li><p>Apache ZooKeeper</p>\n</li>\n<li><p>Etcd</p>\n</li>\n<li><p>Redis</p>\n</li>\n</ul>\n<p><strong>SOME HELPFUL ARTICLES AND STACKOVERFLOW QUESTIONS</strong></p>\n<p><a href=\"https://www.architecture-weekly.com/p/distributed-locking-a-practical-guide\" rel=\"nofollow noreferrer\">Distributed Locking Article</a></p>\n<p><a href=\"https://manib.hashnode.dev/distributed-locking-mechanism\" rel=\"nofollow noreferrer\">Distributed Locking Mechanism</a></p>\n<p><a href=\"https://saxenasanket.medium.com/database-part-three-b46568d282bb\" rel=\"nofollow noreferrer\">Detailed Overview of Distributed Locking</a></p>\n<p><a href=\"https://stackoverflow.com/questions/11999324/whats-a-distributed-lock-and-why-use-it\">What is Distributed Locking</a></p>\n<p><a href=\"https://stackoverflow.com/questions/78940127/is-my-understanding-of-a-distributed-lock-correct\">Understanding Distributed Locking</a></p>\n<p><a href=\"https://stackoverflow.com/questions/72210246/distributed-lock-with-ttl\">Distributed Locking with TTL</a></p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 16860149,
      "reputation" : 181,
      "user_id" : 12191150,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fec9a6154254eb5fd901f4a0045c0b1f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Yasin Ahmed",
      "link" : "https://stackoverflow.com/users/12191150/yasin-ahmed"
    },
    "creation_date" : 1749668622,
    "last_activity_date" : 1749669116,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79663094,
    "question_id" : 79662266,
    "body" : "<p>You can use <a href=\"https://docs.oracle.com/javase/8/docs/api/java/sql/Connection.html#TRANSACTION_SERIALIZABLE\" rel=\"nofollow noreferrer\">serializable transactions</a>. In a serializable transaction a client of the database will see the data as if that client is the only one reading from and writing to the database. This means that once a client read <code>YES</code> for a record no other client can change that from the perspective of the reading client until the reading client ends that transaction (possibly writing another value to that column).</p>\n<p>This might have some performance implications. If your clients are going through the records in the same order they will block each other often. But this would also happen if you are going to use distributed locking as described in another answer.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1580843,
      "reputation" : 13706,
      "user_id" : 1466267,
      "user_type" : "registered",
      "accept_rate" : 91,
      "profile_image" : "https://www.gravatar.com/avatar/c47d1f7544a8c4a1bb7a41d511f53604?s=256&d=identicon&r=PG",
      "display_name" : "SpaceTrucker",
      "link" : "https://stackoverflow.com/users/1466267/spacetrucker"
    },
    "creation_date" : 1749713277,
    "last_activity_date" : 1749713277,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140506627,
    "post_id" : 79662266,
    "body" : "I think instead you need to run a job only once, you might solve that issue with optimistic or pessimistic locks, but it doesn&#39;t make sense in your case. You can just run a job only on one machine/container, to do that, you can use locking <a href=\"https://www.baeldung.com/shedlock-spring\" rel=\"nofollow noreferrer\">baeldung.com/shedlock-spring</a> like this, so when the job runs it will acquire a lock, and when another one started it will see that lock is acquired and do nothing",
    "score" : 0,
    "owner" : {
      "account_id" : 4641735,
      "reputation" : 9,
      "user_id" : 3761376,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3dd05df8e4f407915019e2298ff62c06?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Vitalii Samofal",
      "link" : "https://stackoverflow.com/users/3761376/vitalii-samofal"
    },
    "creation_date" : 1749668374,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140506481,
    "post_id" : 79662266,
    "body" : "How do you want it to behave? Should the other clients block until the lock is released, or return an error? The answer also depends in part on the database that youâ€™re using. Please edit the question and add this information to it.",
    "score" : 1,
    "owner" : {
      "account_id" : 14357,
      "reputation" : 9557,
      "user_id" : 29470,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/65d747d7ca1ea7c6fae309cce663236c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tim Moore",
      "link" : "https://stackoverflow.com/users/29470/tim-moore"
    },
    "creation_date" : 1749664363,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140506186,
    "post_id" : 79662266,
    "body" : "I want to say that I am not a database expert. I am just bouncing ideas. Can you use a connection pool with one connection and make other clients who want to use the connection wait? <a href=\"https://www.baeldung.com/java-connection-pooling\" rel=\"nofollow noreferrer\">baeldung.com/java-connection-pooling</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 2819940,
      "reputation" : 14002,
      "user_id" : 2423906,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/rkpYv.jpg?s=256",
      "display_name" : "SedJ601",
      "link" : "https://stackoverflow.com/users/2423906/sedj601"
    },
    "creation_date" : 1749658968,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140506154,
    "post_id" : 79662266,
    "body" : "@SedJ601 the code itself makes a query to the database and only gets the fields with <code>YES</code>, but the problem is that it only changes to <code>NO</code> after the processing is made and, even changing to <code>NO</code> in the start of the process, the other container already queried the same field, because its too fast",
    "score" : 1,
    "owner" : {
      "account_id" : 30321380,
      "reputation" : 1378,
      "user_id" : 23237053,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/3GrS5.jpg?s=256",
      "display_name" : "Kobra",
      "link" : "https://stackoverflow.com/users/23237053/kobra"
    },
    "creation_date" : 1749658393,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140506144,
    "post_id" : 79662266,
    "body" : "Does the code logic need to say don&#39;t do anything with a record if the field has <code>NO</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 2819940,
      "reputation" : 14002,
      "user_id" : 2423906,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/rkpYv.jpg?s=256",
      "display_name" : "SedJ601",
      "link" : "https://stackoverflow.com/users/2423906/sedj601"
    },
    "creation_date" : 1749658178,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}