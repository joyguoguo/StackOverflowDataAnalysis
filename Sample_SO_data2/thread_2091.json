{
  "question" : {
    "question_id" : 79652575,
    "title" : "Using a custom DNS resolver not resolving for Type.ANY",
    "body" : "<p>When I try to use a custom DNS server (either a single server using <code>SimpleResolver</code> or multiple servers using <code>ExtendedResolver</code>) and want to do a lookup for <code>ANY</code> records relating to a domain, I am getting differing results to the system default settings. Why does this happen? Have I missed something that would allow for more consistent results?</p>\n<p>Here is the code I am looking at:</p>\n<pre class=\"lang-java prettyprint-override\"><code>package za.co.dns;\n\nimport lombok.CustomLog;\nimport org.xbill.DNS.*;\n\nimport java.net.InetSocketAddress;\n\n@CustomLog\npublic class LookupIssue {\n\n    public static void main(String[] args) throws TextParseException {\n        SimpleResolver resolver = new SimpleResolver(new InetSocketAddress(&quot;1.1.1.1&quot;, 53));\n\n        final String domainName = &quot;www.google.com&quot;;\n\n        Lookup lookup;\n\n        log.debug(&quot; ########## Doing first lookup ########## &quot;);\n        lookup = getLookup(domainName, resolver);\n        doLookup(lookup);\n\n        log.debug(&quot; ########## Doing second lookup ########## &quot;);\n        lookup = getLookup(domainName);\n        doLookup(lookup);\n    }\n\n    private static void doLookup(final Lookup lookup) {\n        final Record[] records = lookup.run();\n\n        if (records == null) {\n            log.debug(&quot;NULL Returned for records lookup&quot;);\n        } else {\n            for (Record record : records) {\n                log.debug(record.toString());\n            }\n        }\n    }\n\n    private static Lookup getLookup(final String domain) throws TextParseException {\n        final Name name = Name.fromString(domain);\n        final Lookup lookup = new Lookup(name, Type.ANY, DClass.IN);\n\n        return lookup;\n    }\n\n    private static Lookup getLookup(final String domain, final Resolver resolver) throws TextParseException {\n        final Lookup lookup = getLookup(domain);\n\n        lookup.setResolver(resolver);\n\n        return lookup;\n    }\n}\n</code></pre>\n<p>Here are the logs:</p>\n<pre class=\"lang-none prettyprint-override\"><code>DEBUG za.co.dns.LookupIssue -  ########## Doing first lookup ##########\nDEBUG org.xbill.DNS.config.JndiContextResolverConfigProvider$InnerJndiContextResolverConfigProvider - JNDI class: javax.naming.directory.DirContext\nDEBUG org.xbill.DNS.config.ResolvConfResolverConfigProvider - Added /127.0.0.53:53 to nameservers\nDEBUG org.xbill.DNS.Lookup - Lookup for www.google.com./ANY, cache answer: UNKNOWN\nDEBUG org.xbill.DNS.SimpleResolver - Sending www.google.com./ANY, id=50170 to udp/1.1.1.1:53\nDEBUG org.xbill.DNS.NioClient - Starting dnsjava NIO selector thread\nDEBUG org.xbill.DNS.Lookup - Lookup for www.google.com./ANY, cache answer: UNKNOWN\nDEBUG org.xbill.DNS.SimpleResolver - Sending www.google.com./ANY, id=29107 to udp/1.1.1.1:53\n\nDEBUG za.co.dns.LookupIssue - NULL Returned for records lookup\n\nDEBUG za.co.dns.LookupIssue -  ########## Doing second lookup ##########\nDEBUG org.xbill.DNS.Lookup - Lookup for www.google.com./ANY, cache answer: UNKNOWN\nDEBUG org.xbill.DNS.ExtendedResolver - Sending www.google.com./ANY, id=36672 to resolver 0 (SimpleResolver [/127.0.0.53:53]), attempt 1 of 3\nDEBUG org.xbill.DNS.SimpleResolver - Sending www.google.com./ANY, id=36672 to udp/127.0.0.53:53\nDEBUG org.xbill.DNS.Cache - Caching SUCCESSFUL for www.google.com./ANY\nDEBUG org.xbill.DNS.Lookup - Queried www.google.com./ANY, id=36672: SUCCESSFUL\nDEBUG za.co.dns.LookupIssue - www.google.com.       19  IN  A   142.251.216.68\nDEBUG za.co.dns.LookupIssue - www.google.com.       19  IN  AAAA    2c0f:fb50:4002:80c:0:0:0:2004\nDEBUG org.xbill.DNS.NioClient - dnsjava NIO selector thread stopped\n\nProcess finished with exit code 0\n</code></pre>\n",
    "tags" : [ "java", "dns", "ip", "dnsjava" ],
    "owner" : {
      "account_id" : 42364317,
      "reputation" : 1,
      "user_id" : 30717907,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dd0393fcaadd5c9d6266c14898e77a11?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Chase Haasbroek",
      "link" : "https://stackoverflow.com/users/30717907/chase-haasbroek"
    },
    "is_answered" : false,
    "view_count" : 171,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1749037270,
    "creation_date" : 1749032483,
    "link" : "https://stackoverflow.com/questions/79652575/using-a-custom-dns-resolver-not-resolving-for-type-any",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79652662,
    "question_id" : 79652575,
    "body" : "<p>You're sending the query to a DNS server that does not support ANY queries.</p>\n<p>If you make such a query using a different DNS client such as <code>dig</code>, you'll see it returning a <code>NotImplemented</code> error code:</p>\n<pre class=\"lang-none prettyprint-override\"><code>$ dig www.google.com any @1.1.1.1\n\n; &lt;&lt;&gt;&gt; DiG 9.20.9 &lt;&lt;&gt;&gt; www.google.com any @1.1.1.1\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOTIMP, id: 46309\n;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1\n</code></pre>\n<p>Cloudflare – the operator of 1.1.1.1 – started specifically disabling ANY several years ago. Primarily because ANY responses can return a lot of data, secondarily because these DNS servers cache only the individual record types they'd seen, so querying ANY at a cache server is likely to give an incomplete result anyway. Basically it was more commonly used for DDoS amplification attacks than anything serious.</p>\n<ul>\n<li><a href=\"https://blog.cloudflare.com/deprecating-dns-any-meta-query-type/\" rel=\"nofollow noreferrer\">https://blog.cloudflare.com/deprecating-dns-any-meta-query-type/</a></li>\n<li><a href=\"https://blog.cloudflare.com/what-happened-next-the-deprecation-of-any/\" rel=\"nofollow noreferrer\">https://blog.cloudflare.com/what-happened-next-the-deprecation-of-any/</a></li>\n<li><a href=\"https://blog.cloudflare.com/rfc8482-saying-goodbye-to-any/\" rel=\"nofollow noreferrer\">https://blog.cloudflare.com/rfc8482-saying-goodbye-to-any/</a></li>\n</ul>\n<p>Many other public resolvers do still support ANY queries (e.g. 8.8.8.8 generally does, and whatever your system is configured to use via <code>resolvectl</code> apparently also does).</p>\n<p>However, you <strong>really shouldn't</strong> use ANY queries if your goal is merely to resolve A+AAAA – the response can be 10x–20x larger than just making two separate queries for A and AAAA (which is what every normal program does), while at the same time it is not guaranteed to <em>contain</em> all record types, e.g. it may be missing AAAA results if a normal query hasn't caused them to be cached previously.</p>\n<p>Even some authoritative servers don't answer ANY queries, either. For example, anything hosted on Azure DNS won't support it:</p>\n<pre class=\"lang-none prettyprint-override\"><code>$ dig microsoft.com any @8.8.8.8\n\n; &lt;&lt;&gt;&gt; DiG 9.20.9 &lt;&lt;&gt;&gt; microsoft.com any @8.8.8.8\n;; global options: +cmd\n;; Got answer:\n;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 18460\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; ANSWER SECTION:\nmicrosoft.com.      300 IN  HINFO   &quot;RFC8482&quot; &quot;&quot;\n</code></pre>\n<p>This time it's not the cache DNS server blocking it, on the contrary – here 8.8.8.8 tries to avoid the aforementioned caching issue by forwarding the whole ANY query to a domain's authoritative server, and all it gets is a fake HINFO in response; same as if you were querying <code>@ns2-39.azure-dns.net</code> directly.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 20740,
      "reputation" : 20159,
      "user_id" : 49849,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e10f1fb3760601f575b7b359d5618166?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "grawity",
      "link" : "https://stackoverflow.com/users/49849/grawity"
    },
    "creation_date" : 1749036673,
    "last_activity_date" : 1749037075,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79652676,
    "question_id" : 79652575,
    "body" : "<p>After having posted a bug with the original developer, they got back to me about why this is happening. A more detailed explanation could be found here:\n<a href=\"https://github.com/dnsjava/dnsjava/issues/378\" rel=\"nofollow noreferrer\">https://github.com/dnsjava/dnsjava/issues/378</a></p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 42364317,
      "reputation" : 1,
      "user_id" : 30717907,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/dd0393fcaadd5c9d6266c14898e77a11?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Chase Haasbroek",
      "link" : "https://stackoverflow.com/users/30717907/chase-haasbroek"
    },
    "creation_date" : 1749037270,
    "last_activity_date" : 1749037270,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79652662" : [ {
      "comment_id" : 140727484,
      "post_id" : 79652662,
      "body" : "For A and AAAA queries please also do take into account the &quot;happy eyeballs&quot; algorithm that gives guidance for applications, trying to prefer modern IPv6 over legacy IPv4 but still trying to offer a pleasurable experience to end users no matter which cases they are in.",
      "score" : 0,
      "owner" : {
        "account_id" : 8493198,
        "reputation" : 12923,
        "user_id" : 6368697,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/yq4cG.jpg?s=256",
        "display_name" : "Patrick Mevzek",
        "link" : "https://stackoverflow.com/users/6368697/patrick-mevzek"
      },
      "creation_date" : 1757529088,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79652676" : [ {
      "comment_id" : 140727481,
      "post_id" : 79652676,
      "body" : "The above response from @grawity is FAR MORE detailed than the GitHub ticket. Especially the advice about NOT USING ANY, because it was NEVER meaning ALL and people just confused ANY and ALL",
      "score" : 0,
      "owner" : {
        "account_id" : 8493198,
        "reputation" : 12923,
        "user_id" : 6368697,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/yq4cG.jpg?s=256",
        "display_name" : "Patrick Mevzek",
        "link" : "https://stackoverflow.com/users/6368697/patrick-mevzek"
      },
      "creation_date" : 1757529010,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140486449,
      "post_id" : 79652676,
      "body" : "Your answer could be improved with additional supporting information. Please <a href=\"https://stackoverflow.com/posts/79652676/edit\">edit</a> to add further details, such as citations or documentation, so that others can confirm that your answer is correct. You can find more information on how to write good answers <a href=\"/help/how-to-answer\">in the help center</a>.",
      "score" : 1,
      "owner" : {
        "account_id" : -1,
        "reputation" : 1,
        "user_id" : -1,
        "user_type" : "moderator",
        "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
        "display_name" : "Community",
        "link" : "https://stackoverflow.com/users/-1/community"
      },
      "creation_date" : 1749038276,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}