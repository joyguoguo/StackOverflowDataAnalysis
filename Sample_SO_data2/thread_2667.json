{
  "question" : {
    "question_id" : 79607523,
    "title" : "micrometer-registry-prometheus not showing exemplars",
    "body" : "<p>I would like to send metrics with exemplars using Spring Boot and Micrometer.</p>\n<p>Part of the <code>pom.xml</code>:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;3.4.5&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;com.example&lt;/groupId&gt;\n    &lt;artifactId&gt;app&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1&lt;/version&gt;\n    &lt;name&gt;app&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot Observability&lt;/description&gt;\n    &lt;properties&gt;\n        &lt;java.version&gt;24&lt;/java.version&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.micrometer&lt;/groupId&gt;\n            &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n &lt;dependency&gt;\n            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n            &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.micrometer&lt;/groupId&gt;\n            &lt;artifactId&gt;micrometer-tracing-bridge-otel&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>\n@RestController\n@SpringBootApplication\npublic class AppApplication {\n\n    Logger logger = LoggerFactory.getLogger(AppApplication.class);\n\n    public static void main(String[] args) {\n        SpringApplication.run(AppApplication.class, args);\n    }\n\n    @GetMapping(&quot;/&quot;)\n    public String root(@RequestParam(value = &quot;name&quot;, defaultValue = &quot;World&quot;) String name, @RequestHeader HttpHeaders headers) {\n        logger.error(headers.toString());\n        logger.error(String.format(&quot;Hello %s!!&quot;, name));\n        logger.debug(&quot;Debugging log&quot;);\n        logger.info(&quot;Info log&quot;);\n        logger.warn(&quot;Hey, This is a warning!&quot;);\n        logger.error(&quot;Oops! We have an Error. OK&quot;);\n        return String.format(&quot;Hello %s!!&quot;, name);\n    }\n\n    @GetMapping(&quot;/io_task&quot;)\n    public String io_task() throws InterruptedException {\n        Thread.sleep(1000);\n        logger.info(&quot;io_task&quot;);\n        return &quot;io_task&quot;;\n    }\n\n    @GetMapping(&quot;/peanuts/{id}&quot;)\n    public Peanuts getPeanutsById(@PathVariable Long id) {\n        logger.info(&quot;Get Peanuts Character by id&quot;);\n        return new Peanuts(id, &quot;Snoopy&quot;, &quot;Charlie Brown's pet beagle&quot;);\n    }\n    \n    record Peanuts(Long id, String name, String description) {}\n\n}\n</code></pre>\n<p>With the code above and <code>otelcol_0.121.0_X</code>, I am able to scrape the actuator endpoint, which contains the metrics.</p>\n<p>I am also able to see the metrics in Grafana.</p>\n<p>I am also able to see traces in Grafana (sending traces to tempo)</p>\n<p>However, there are no exemplars.</p>\n<p>I am not able to link, jump between the metrics and the traces, for Spring Boot default metrics, nor any custom metrics</p>\n<p>From the <a href=\"https://docs.micrometer.io/micrometer/reference/implementations/prometheus.html#_exemplars\" rel=\"nofollow noreferrer\">Micrometer docs</a> I tried adding a custom <code>PrometheusMeterRegistry</code> bean. With or without, same issue.</p>\n<p>How to send metrics with exemplars, not just regular metrics, and have the link working between metrics and traces?</p>\n",
    "tags" : [ "java", "prometheus", "spring-boot-actuator", "spring-micrometer" ],
    "owner" : {
      "account_id" : 14482834,
      "reputation" : 5478,
      "user_id" : 10461625,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/fgo5D.jpg?s=256",
      "display_name" : "PatPanda",
      "link" : "https://stackoverflow.com/users/10461625/patpanda"
    },
    "is_answered" : false,
    "view_count" : 213,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1749460858,
    "creation_date" : 1746473306,
    "link" : "https://stackoverflow.com/questions/79607523/micrometer-registry-prometheus-not-showing-exemplars",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79617923,
    "question_id" : 79607523,
    "body" : "<p>As my knowledge you don't need to configure PrometheusMeterRegistry if you are using spring boot 3.x. You just need dependencies for metrics which you already have.</p>\n<p>Make sure that you have enabled exemplars in prometheus <a href=\"https://prometheus.io/docs/prometheus/latest/feature_flags/#exemplars-storage\" rel=\"nofollow noreferrer\">https://prometheus.io/docs/prometheus/latest/feature_flags/#exemplars-storage</a></p>\n<p>And in the promql in grafana you will have toggle to enable exemplars for specific query (see picture).<br />\n<a href=\"https://i.sstatic.net/65kswaNB.png\" rel=\"nofollow noreferrer\">picture</a></p>\n<p>Make sure that you have configured connections in Grafana: Home -&gt; Connections -&gt; Data Sources -&gt; Prometheus/Tempo/Loki (If you cannot edit connections, then you need to make it editable in grafana deploy configs).</p>\n<p>Finally enable traces in application.yaml:</p>\n<pre><code>management:\n  tracing:\n    enabled: true\n    sampling:\n      probability: 1.0\n    propagation:\n      type: W3C,B3\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19320945,
      "reputation" : 49,
      "user_id" : 14124649,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0dbf82326719dafc0004eb969f1da509?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ilyas Sarsenbaev",
      "link" : "https://stackoverflow.com/users/14124649/ilyas-sarsenbaev"
    },
    "creation_date" : 1747056245,
    "last_activity_date" : 1749460858,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}