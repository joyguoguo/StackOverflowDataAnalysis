{
  "question" : {
    "question_id" : 79570825,
    "title" : "ByteBuddy agent passing wrong data to ClassReader when using custom class loader",
    "body" : "<p>I'm using a Java agent with ByteBuddy to instrument class files. The application I'm instrumenting uses a custom class loader to decrypt classes. I noticed I was hitting <a href=\"https://gitlab.ow2.org/asm/asm/-/blob/master/asm/src/main/java/org/objectweb/asm/ClassReader.java?ref_type=heads#L263\" rel=\"nofollow noreferrer\">this</a> exception when ByteBuddy was attempting to transform classes. After adding some debug prints it seems that the buffer being passed to the ClassReader is the encrypted class file. Is there a way I can make ByteBuddy use the buffer after it has been decrypted by the class loader?</p>\n<p>Stack trace:</p>\n<pre><code>java.lang.IllegalArgumentException\n  at net.bytebuddy.jar.asm.ClassReader.&lt;init&gt;(ClassReader.java:263)\n  at net.bytebuddy.jar.asm.ClassReader.&lt;init&gt;(ClassReader.java:180)\n  at net.bytebuddy.jar.asm.ClassReader.&lt;init&gt;(ClassReader.java:166)\n  at net.bytebuddy.utility.OpenedClassReader.of(OpenedClassReader.java:130)\n  at net.bytebuddy.utility.AsmClassReader$Factory$Default$4.make(AsmClassReader.java:134)\n  at net.bytebuddy.utility.AsmClassReader$Factory$Default$2.make(AsmClassReader.java:108)\n  at net.bytebuddy.utility.AsmClassReader$Factory$Default$1.make(AsmClassReader.java:94)\n  at net.bytebuddy.utility.AsmClassReader$Factory$Default.make(AsmClassReader.java:187)\n  at net.bytebuddy.pool.TypePool$Default.parse(TypePool.java:911)\n  at net.bytebuddy.pool.TypePool$Default.doDescribe(TypePool.java:897)\n  at net.bytebuddy.pool.TypePool$Default$WithLazyResolution.access$001(TypePool.java:977)\n  at net.bytebuddy.pool.TypePool$Default$WithLazyResolution.doResolve(TypePool.java:1100)\n  at net.bytebuddy.pool.TypePool$Default$WithLazyResolution$LazyTypeDescription.delegate(TypePool.java:1169)\n  at net.bytebuddy.description.type.TypeDescription$AbstractBase$OfSimpleType$WithDelegation.getTypeVariables(TypeDescription.java:8594)\n  at net.bytebuddy.description.type.TypeDescription$AbstractBase.isGenerified(TypeDescription.java:8200)\n  at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Reifying.onNonGenericType(TypeDescription.java:1796)\n  at net.bytebuddy.description.type.TypeDescription$Generic$Visitor$Reifying$1.onNonGenericType(TypeDescription.java:1752)\n  at net.bytebuddy.description.type.TypeDescription$Generic$OfNonGenericType.accept(TypeDescription.java:3811)\n  at net.bytebuddy.description.type.TypeDescription$Generic$LazyProjection.accept(TypeDescription.java:6363)\n  at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.analyzeNullable(MethodGraph.java:729)\n  at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.doAnalyze(MethodGraph.java:743)\n  at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$Default.compile(MethodGraph.java:668)\n  at net.bytebuddy.dynamic.scaffold.MethodGraph$Compiler$AbstractBase.compile(MethodGraph.java:519)\n  at net.bytebuddy.dynamic.scaffold.MethodRegistry$Default.prepare(MethodRegistry.java:472)\n  at net.bytebuddy.dynamic.scaffold.inline.RebaseDynamicTypeBuilder.toTypeWriter(RebaseDynamicTypeBuilder.java:230)\n  at net.bytebuddy.dynamic.DynamicType$Builder$AbstractBase$UsingTypeWriter.make(DynamicType.java:4092)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer.doTransform(AgentBuilder.java:12725)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer.transform(AgentBuilder.java:12660)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer.access$1800(AgentBuilder.java:12369)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer$Java9CapableVmDispatcher.run(AgentBuilder.java:13151)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer$Java9CapableVmDispatcher.run(AgentBuilder.java:13081)\n  at java.base/java.security.AccessController.doPrivileged(Native Method)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer.doPrivileged(AgentBuilder.java)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer.transform(AgentBuilder.java:12603)\n  at net.bytebuddy.agent.builder.AgentBuilder$Default$ExecutingTransformer$ByteBuddy$ModuleSupport.transform(Unknown Source)\n  at java.instrument/sun.instrument.TransformerManager.transform(Unknown Source)\n  at java.instrument/sun.instrument.InstrumentationImpl.transform(Unknown Source)\n  at java.base/java.lang.ClassLoader.defineClass1(Native Method)\n  at java.base/java.lang.ClassLoader.defineClass(Unknown Source)\n  at java.base/java.lang.ClassLoader.defineClass(Unknown Source)\n  at net.zk.CustomClassLoader.findClass(CustomClassLoader.java:19)\n  at java.base/java.lang.ClassLoader.loadClass(Unknown Source)\n  at java.base/java.lang.ClassLoader.loadClass(Unknown Source)\n  at net.zk.Loader.main(Loader.java:9)\n  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n  at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\n  at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\n  at java.base/java.lang.reflect.Method.invoke(Unknown Source)\n  at net.zk.Injector.inject(Injector.java:16)\n  at java.base/java.lang.Thread.run(Unknown Source)\n</code></pre>\n",
    "tags" : [ "java", "byte-buddy" ],
    "owner" : {
      "account_id" : 41363717,
      "reputation" : 3,
      "user_id" : 30254631,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/694121e9651eb2fa8f8f37f23146c240?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user30254631",
      "link" : "https://stackoverflow.com/users/30254631/user30254631"
    },
    "is_answered" : true,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744613136,
    "creation_date" : 1744484015,
    "link" : "https://stackoverflow.com/questions/79570825/bytebuddy-agent-passing-wrong-data-to-classreader-when-using-custom-class-loader",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79572509,
    "question_id" : 79570825,
    "body" : "<p>Byte Buddy loads class files from jars using a ClassFileLocator. You can pass a custom locator to AgentBuilder that implements the decryption.</p>\n<p>The JVM only passes the currently instrumented class file to the agent. If you can limit your instrumentation to not needing other class files, this would also work.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1284143,
      "reputation" : 44402,
      "user_id" : 1237575,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/bc96521f79789d75fa63cfa5c2758765?s=256&d=identicon&r=PG",
      "display_name" : "Rafael Winterhalter",
      "link" : "https://stackoverflow.com/users/1237575/rafael-winterhalter"
    },
    "creation_date" : 1744613136,
    "last_activity_date" : 1744613136,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140328597,
    "post_id" : 79570825,
    "body" : "@IvanYonkov I don&#39;t have access to the source of the target program. However, at this point I did get it working by modifying the ByteBuddy source code to decrypt before passing it into the ClassReader. Kind of a hacky fix though and I&#39;d love to see a nicer way of doing this.",
    "score" : 0,
    "owner" : {
      "account_id" : 41363717,
      "reputation" : 3,
      "user_id" : 30254631,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/694121e9651eb2fa8f8f37f23146c240?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user30254631",
      "link" : "https://stackoverflow.com/users/30254631/user30254631"
    },
    "creation_date" : 1744491837,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328429,
    "post_id" : 79570825,
    "body" : "Not sure the java agent can help here. Are you able to change the code of you custom class loader?",
    "score" : 0,
    "owner" : {
      "account_id" : 2553962,
      "reputation" : 7029,
      "user_id" : 2216380,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gwdaXSeI.png?s=256",
      "display_name" : "Ivan Yonkov",
      "link" : "https://stackoverflow.com/users/2216380/ivan-yonkov"
    },
    "creation_date" : 1744485566,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}