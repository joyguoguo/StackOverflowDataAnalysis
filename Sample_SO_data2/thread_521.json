{
  "question" : {
    "question_id" : 79802352,
    "title" : "PDFBox 3.0.5 external sign causes &quot;Signature is invalid&quot;",
    "body" : "<p>I tried to find many solution in the web but not working. I need to sign a PDF by extract the hash from the PDF and send it to other server service to signed the hash and put back it to the PDF signature. Please give me a hand! The following is my code, where the DataSigner is a third party service api to calling the server to sign the hash:</p>\n<pre><code>            // create ContentSigner that signs by calling the external endpoint\n            ContentSigner contentSigner = new ContentSigner() {\n                private MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);\n                private OutputStream stream = OutputStreamFactory.createStream(digest);\n\n                @Override\n                public byte[] getSignature() {\n                    try {\n                        byte[] hash = digest.digest();\n                        //byte[] signedHash = serverSignature.sign(Base64.getEncoder().encodeToString(hash));\n                        \n                        List&lt;byte[]&gt; hashes = Arrays.asList(hash); \n                        \n                        List&lt;byte[]&gt; signedHash = signer.sign(hashes);\n                        \n                        return signedHash.get(0);\n                    } catch (Exception e) {\n                        throw new RuntimeException(&quot;Exception while signing&quot;, e);\n                    }\n                }\n\n                @Override\n                public OutputStream getOutputStream() {\n                    return stream;\n                }\n\n                @Override\n                public AlgorithmIdentifier getAlgorithmIdentifier() {\n                    return new AlgorithmIdentifier(new ASN1ObjectIdentifier(&quot;1.2.840.113549.1.1.11&quot;));\n                }\n            };\n</code></pre>\n",
    "tags" : [ "java", "pdfbox" ],
    "owner" : {
      "account_id" : 3804005,
      "reputation" : 171,
      "user_id" : 3156889,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3bd83a018ab9a63d571ee503793c102b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "EricMacau",
      "link" : "https://stackoverflow.com/users/3156889/ericmacau"
    },
    "is_answered" : true,
    "view_count" : 113,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1761787438,
    "creation_date" : 1761613703,
    "link" : "https://stackoverflow.com/questions/79802352/pdfbox-3-0-5-external-sign-causes-signature-is-invalid",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79802605,
    "question_id" : 79802352,
    "body" : "<p>The signature bytes in your signature don't contain the <em>hash</em> of the signed attributes (as they should) but the <em>hash of the hash</em> of the signed attributes. Apparently the <code>signer.sign</code> method you use does not expect a pre-calculated hash but the original data. So your process hashes once too many.</p>\n<p>You can fix that</p>\n<ul>\n<li>either by checking whether your third-party signing service api contains another method for pre-calculated hashes and using that method instead,</li>\n<li>or by not hashing yourself, i.e. replacing\n<pre><code>private MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);\nprivate OutputStream stream = OutputStreamFactory.createStream(digest);\n</code></pre>\nby\n<pre><code>private ByteArrayOutputStream stream = new ByteArrayOutputStream();\n</code></pre>\nand sending <code>stream.toByteArray()</code> instead of <code>digest.digest()</code> to <code>signer.sign</code> in your <code>ContentSigner</code> implementation.</li>\n</ul>\n<hr />\n<p>As you asked for &quot;the code&quot; in a comment, your full <code>ContentSigner</code> implementation including the described changes would look like this:</p>\n<pre><code>ContentSigner contentSigner = new ContentSigner() {\n    private ByteArrayOutputStream stream = new ByteArrayOutputStream();\n\n    @Override\n    public byte[] getSignature() {\n        try {\n            byte[] datum = stream.toByteArray()\n                        \n            List&lt;byte[]&gt; data = Arrays.asList(datum); \n                        \n            List&lt;byte[]&gt; signedHash = signer.sign(data);\n                        \n            return signedHash.get(0);\n        } catch (Exception e) {\n            throw new RuntimeException(&quot;Exception while signing&quot;, e);\n        }\n    }\n\n    @Override\n    public OutputStream getOutputStream() {\n        return stream;\n    }\n\n    @Override\n    public AlgorithmIdentifier getAlgorithmIdentifier() {\n        return new AlgorithmIdentifier(new ASN1ObjectIdentifier(&quot;1.2.840.113549.1.1.11&quot;));\n    }\n};\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97023,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1761643590,
    "last_activity_date" : 1761734224,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140822115,
    "post_id" : 79802352,
    "body" : "Please view the signed PDF: <a href=\"https://drive.google.com/file/d/1cyMetOqlT6_sNQv86a6JIG-qF-TalGi9/view?usp=sharing\" rel=\"nofollow noreferrer\">drive.google.com/file/d/1cyMetOqlT6_sNQv86a6JIG-qF-TalGi9/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 3804005,
      "reputation" : 171,
      "user_id" : 3156889,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3bd83a018ab9a63d571ee503793c102b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "EricMacau",
      "link" : "https://stackoverflow.com/users/3156889/ericmacau"
    },
    "creation_date" : 1761641587,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140821818,
    "post_id" : 79802352,
    "body" : "Please share an example PDF signed by your code for analysis.",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97023,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1761630438,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79802605" : [ {
      "comment_id" : 140826342,
      "post_id" : 79802605,
      "body" : "@EricMacau That&#39;s great! Please remember to mark this answer as accepted answer.",
      "score" : 0,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97023,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1761805017,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140826082,
      "post_id" : 79802605,
      "body" : "Thank you very much. It works fine! Thank you again!",
      "score" : 0,
      "owner" : {
        "account_id" : 3804005,
        "reputation" : 171,
        "user_id" : 3156889,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3bd83a018ab9a63d571ee503793c102b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "EricMacau",
        "link" : "https://stackoverflow.com/users/3156889/ericmacau"
      },
      "creation_date" : 1761784159,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140824011,
      "post_id" : 79802605,
      "body" : "thanks for your opinion, can you show me ghe code?",
      "score" : 0,
      "owner" : {
        "account_id" : 3804005,
        "reputation" : 171,
        "user_id" : 3156889,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3bd83a018ab9a63d571ee503793c102b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "EricMacau",
        "link" : "https://stackoverflow.com/users/3156889/ericmacau"
      },
      "creation_date" : 1761704439,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140822554,
      "post_id" : 79802605,
      "body" : "@EricMacau <i>&quot;In fact, if I use iText5.5.x, it works fine.&quot;</i> - Yes, for one simple reason: you don&#39;t hash the signed attributes there: <code>byte[] hashForSign = sign.getAuthenticatedAttributeBytes(digestHash, ocsp, crlBytes, SIGN_TYPE);</code> here you put the plain, unhashed attributes into a variable you call <code>hashForSign</code> and, therefore, may mistake for being a hash. Thus, please also try for PDFBox without hashing the signed attributes, just like you did for iText.",
      "score" : 0,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97023,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1761654848,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140822233,
      "post_id" : 79802605,
      "body" : "In fact, if I use iText5.5.x, it works fine. The following is the hash calculation in iText5.5.x. :     ExternalDigest externalDigest = new BouncyCastleDigest();  PdfPKCS7 sign = new PdfPKCS7(null, chain, &quot;SHA256&quot;, null, externalDigest, false);  InputStream data = appearance.getRangeStream();  byte[] digestHash = DigestAlgorithms.digest(data, externalDigest.getMessageDigest(&quot;SHA256&quot;));  OcspClient ocsp = null;  CryptoStandard SIGN_TYPE = CryptoStandard.CADES;\t\t\t\t\t  byte[] hashForSign = sign.getAuthenticatedAttributeBytes(digestHash, ocsp, crlBytes, SIGN_TYPE);",
      "score" : 0,
      "owner" : {
        "account_id" : 3804005,
        "reputation" : 171,
        "user_id" : 3156889,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3bd83a018ab9a63d571ee503793c102b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "EricMacau",
        "link" : "https://stackoverflow.com/users/3156889/ericmacau"
      },
      "creation_date" : 1761644863,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}