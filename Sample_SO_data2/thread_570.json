{
  "question" : {
    "question_id" : 79795650,
    "title" : "jpql statement to involve multiple conditions",
    "body" : "<p>I use scheduler to pick up tasks from database based on the status of associated document. I have one task to many documents relationship, and each Document entity has its own status value.\nI need to pick one distinct task with the following criteria from Document:</p>\n<ul>\n<li>status 101: get max version of the document</li>\n<li>status 102: get any, no matter what version it is (and prefer 102 over 101)</li>\n</ul>\n<p>To this end, I use this JPQL:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>select task, document.id from Task task\njoin Document document on task.uuid = document.taskUuid\n    where (\n                document.status = 102\n            or (document.status = 101\n                and document.wersjaNumer =\n                            (select max(sub.wersjaNumer) from Document sub\n                                        where sub.numerUuid = document.numerUuid)\n                )\n            )\n        order by case when document.status=102 then 1 else 2 end\n</code></pre>\n<p>As far as I understand, this should retreive only one instance of Task with given uuid.\nSo here:</p>\n<pre><code>Task(uuid = &quot;xxx&quot;)\nDocument(taskUuid = &quot;xxx&quot;, status=101)\nDocument(taskUuid = &quot;xxx&quot;, status=102)\n</code></pre>\n<p>I expect only one Task and document.id associated with status=102, but I get both results. I suspect, I got something wrong with\n<code>order by case when document.status=102 then 1 else 2 end</code> part. Any ideas how to fix it?</p>\n",
    "tags" : [ "java", "hibernate", "jpql" ],
    "owner" : {
      "account_id" : 5376331,
      "reputation" : 450,
      "user_id" : 4283100,
      "user_type" : "registered",
      "accept_rate" : 60,
      "profile_image" : "https://www.gravatar.com/avatar/3a0e0b4a915bc664f53652bc99df2fb5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Maverick",
      "link" : "https://stackoverflow.com/users/4283100/maverick"
    },
    "is_answered" : true,
    "view_count" : 82,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1761045551,
    "creation_date" : 1761038531,
    "link" : "https://stackoverflow.com/questions/79795650/jpql-statement-to-involve-multiple-conditions",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79795749,
    "question_id" : 79795650,
    "body" : "<p>Below is the JPQL statement for the conditions you have specified:</p>\n<pre class=\"lang-none prettyprint-override\"><code>SELECT t, d\nFROM Task t\nJOIN t.documents d\nWHERE\n    -- Case 1: The task has a document with status '102'.\n    -- The document returned will be any one with status '102'\n    (d.status = '102' AND EXISTS (\n        SELECT 1 FROM Document d1 WHERE d1.task = t AND d1.status = '102'\n    ))\n    OR\n    -- Case 2: The task does NOT have any document with status '102' AND\n    -- the document has a status of '101' and the maximum version.\n    (d.status = '101' AND NOT EXISTS (\n        SELECT 1 FROM Document d2 WHERE d2.task = t AND d2.status = '102'\n    ) AND d.versionId = (\n        SELECT MAX(d3.versionId) FROM Document d3\n        WHERE d3.task = t AND d3.status = '101'\n    ))\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 25020912,
      "reputation" : 11,
      "user_id" : 18879613,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a214579fa8a934cd0bd1a95e62a01a75?s=256&d=identicon&r=PG",
      "display_name" : "Srivathsa",
      "link" : "https://stackoverflow.com/users/18879613/srivathsa"
    },
    "creation_date" : 1761045551,
    "last_activity_date" : 1761045551,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140808783,
    "post_id" : 79795650,
    "body" : "Does &quot;I need to pick one distinct task&quot; mean that it would make sense to just take the first overall result and discard all others?",
    "score" : 1,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1761057304,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140808756,
    "post_id" : 79795650,
    "body" : "Are there other document statuses (that you are apparently excluding)? Do I understand correctly that you want to avoid multiple results having the same task UUID? And are task UUIDs unique with respect to your Task entities?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1761056532,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140808745,
    "post_id" : 79795650,
    "body" : "If you want only one version of each document having status 102, but it doesn&#39;t matter which, then why not just choose the max version, same as you do for status 101?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1761056234,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140808737,
    "post_id" : 79795650,
    "body" : "The <code>order by</code> clause does what it says: it <i>orders</i> the results.  It does not <i>filter</i> the results.  The given query can select <i>many</i> (task, document) pairs having the same task.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1761055933,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}