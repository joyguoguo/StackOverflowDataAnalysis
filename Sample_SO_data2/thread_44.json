{
  "question" : {
    "question_id" : 79843538,
    "title" : "Logout does not return Principal after Spring boot upgrade to 3.1.9 or 3.5.8",
    "body" : "<p>I have my application in spring boot 3.1.4 and using okta for authentication.</p>\n<p>I want to upgrade to spring-boot to 3.5.8. I am able to launch the application for the first time. During first logout, request returns null for getPrincipal(). Hence logout is happening properly.</p>\n<pre><code>private void oktaLogout(HttpServletRequest request) {\n    OidcUser oidcUser = getOidcUser(request);\n    if (oidcUser == null) return;\n    Map&lt;String, Object&gt; claims = oidcUser.getClaims();\n    if(claims.keySet().contains(&quot;iss&quot;) &amp;&amp; claims.get(&quot;iss&quot;) != null) {\n        String issuer = claims.get(&quot;iss&quot;).toString();\n        String logoutUrl = issuer + &quot;/v1/logout?id_token_hint=&quot; + oidcUser.getIdToken().getTokenValue() + &quot;&amp;post_logout_redirect_uri=&quot; + appSettings.getLogoutUrl();\n        request.getSession().invalidate();\n        request.getSession().setAttribute(&quot;logoutUrl&quot;, logoutUrl);\n    }\n}\n\n\npublic OidcUser getOidcUser(HttpServletRequest request) {\n    Principal principal = request.getUserPrincipal();\n\n    if (principal == null) return null; //Here it returns null during logout\n    OAuth2AuthenticationToken token = (OAuth2AuthenticationToken) principal;\n\n    return (OidcUser) token.getPrincipal();\n}\n</code></pre>\n<pre><code>SecurityConfig.java\n\n@Configuration\n@EnableWebSecurity\npublic class SecurityConfig {\n@Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http.csrf((csrf) -&gt; csrf.disable())\n            .authorizeHttpRequests( (authorize) -&gt; authorize\n                .requestMatchers(&quot;/**&quot;, &quot;/app/**&quot;, &quot;/signout/**&quot;, &quot;/error/**&quot;)\n                    .authenticated())\n            .oauth2Login(Customizer.withDefaults())\n            .oauth2Client(Customizer.withDefaults())\n            ;\n        return http.build();\n    }\n}\n</code></pre>\n<p>if (principal == null) return null; //returning null here, so if block in oktaLogout is not executing.</p>\n<p>Because of this, I could not launch  my application from second time from okta dashboard and getting &quot;Access to xxxx was denied. You dont have the user rights to view this page&quot;.</p>\n<p>This issue comes from spring boot version 3.1.9, until 3.1.8 it works fine.</p>\n<p>No error in the application log, re-login request is not reaching okta. I checked okta System log.</p>\n<p>Can someone help me please?</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "spring-security", "okta" ],
    "owner" : {
      "account_id" : 7788252,
      "reputation" : 49,
      "user_id" : 5892233,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9e6e8f635a9938037ccecf07758abd45?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "AAPJ",
      "link" : "https://stackoverflow.com/users/5892233/aapj"
    },
    "is_answered" : false,
    "view_count" : 59,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1765475974,
    "creation_date" : 1765415047,
    "link" : "https://stackoverflow.com/questions/79843538/logout-does-not-return-principal-after-spring-boot-upgrade-to-3-1-9-or-3-5-8",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79844242,
    "question_id" : 79843538,
    "body" : "<p>Found the solution.</p>\n<p>The method which is calling oktalogout method had authentication set to false.</p>\n<pre><code>Principal principal = request.getUserPrincipal();\nif (principal == null) return;\nOAuth2AuthenticationToken token = (OAuth2AuthenticationToken) principal;\ntoken.setAuthenticated(false); // Moved this line to after oktaLogout method call.\noktaLogout(request);\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 7788252,
      "reputation" : 49,
      "user_id" : 5892233,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9e6e8f635a9938037ccecf07758abd45?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "AAPJ",
      "link" : "https://stackoverflow.com/users/5892233/aapj"
    },
    "creation_date" : 1765475974,
    "last_activity_date" : 1765475974,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}