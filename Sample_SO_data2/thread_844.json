{
  "question" : {
    "question_id" : 79761178,
    "title" : "Hibernate Child Collection unique constraint exception",
    "body" : "<p>I have Employee entity with pk emp_id. Employee has child collection as EmployeeLeaves (table emp_leaves). It has id, emp_id, leave_date, comment field.</p>\n<p>I have @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;employee&quot;, orphanRemoval = true) on collection of employeeLeaves.</p>\n<p>I also have unique constraint applied in DB on emp_leaves for emp_id and leave_date.</p>\n<p>When i save the Employee, i do following</p>\n<ol>\n<li>Clear the collection.</li>\n<li>Add new EmployeeLeave created from EmployeeLeaveDto using mapstruct (with null id)</li>\n<li>Save the Employee</li>\n</ol>\n<p>Hibernate is doing the insert first and since the row exists in DB it throws unique constraint exception.</p>\n<pre><code>public interface EmployeeMapper {\n        \n    static class EmployeeContext {\n        Map&lt;Integer, EmployeeLeave&gt; leaveMap;\n    }   \n    \n    @ObjectFactory\n    default EmployeeLeave createLeave(LeaveDto leaveDto, @Context EmployeeContext context) {\n        return Objects.requireNonNullElseGet(context.leaveMap.get(leaveDto.getId()), EmployeeLeave::new);\n    }\n    \n    void map(EmpployeeDto empDto, @MappingTarget Employee emp, @Context EmployeeContext context);\n    \n    default Employee mapDtoToEntity(EmployeeDto empDto, Employee emp) {     \n        EmployeeContext context = new EmployeeContext();                \n        context.leaveMap = emp.employeeLeaves().stream().collect(Collectors.toMap(EmployeeLeave::getId, Function.identity()));      \n        map(empDto, emp, context);\n        emp.getEmployeeLeaves().foreach(l -&gt; l.setEmployee(emp));//assign parent\n        return emp;\n    }\n}\n</code></pre>\n<p>I call mapDtoToEntity with managed entity. It adds any newly created leaves or already existing leaves. I then calls merge on entity manager.</p>\n<p>If employee has leave on 1 May 2025 persisted in DB. Now when in UI this leave date is changed to 2 May 2025 and new leave row of 1 May 2025 is added. When employee is saved, hibeernate will first try to insert the leave without id i.e. 1 May 2025. But there already exist a row in DB and it throws exception</p>\n",
    "tags" : [ "java", "hibernate", "mapstruct" ],
    "owner" : {
      "account_id" : 2448724,
      "reputation" : 39,
      "user_id" : 2135483,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/7e37c3da985184aa80f43ef51ff0fd49?s=256&d=identicon&r=PG",
      "display_name" : "pingo_bingo",
      "link" : "https://stackoverflow.com/users/2135483/pingo-bingo"
    },
    "is_answered" : false,
    "view_count" : 59,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1757559332,
    "creation_date" : 1757528897,
    "link" : "https://stackoverflow.com/questions/79761178/hibernate-child-collection-unique-constraint-exception",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140730258,
    "post_id" : 79761178,
    "body" : "However, if you are trying to persist changes <i>only</i> to the employee, not the leaves, then you probably can clear the relationship collection <i>and leave it empty</i>, because the leaf side is the owner of that particular relationship.  Do test before relying on that.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1757621079,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140730256,
    "post_id" : 79761178,
    "body" : "The details of how to do this correctly depend on a number of factors that are (still) not clear from the code posted, but since you&#39;re moving data into and out of DTOs, you probably have more work to do than if you were working with entities only.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1757620981,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140730250,
    "post_id" : 79761178,
    "body" : "The main thing you must avoid is replacing leaf entities that have persistent identities with corresponding ones that don&#39;t (in other words, exactly what you say you are doing).  When you do that, Hibernate tries to create new persistent entities for all of the leaves, and fails because they duplicate entities that are already persistent.  Without the uniqueness constraint getting in the way, you would instead double the leaves with each save.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1757620675,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140729149,
    "post_id" : 79761178,
    "body" : "Are you saying to not clear leaves and only add new ones? Will hibernate not fire insert first, which will again throw unique constraint exception?",
    "score" : 0,
    "owner" : {
      "account_id" : 2448724,
      "reputation" : 39,
      "user_id" : 2135483,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/7e37c3da985184aa80f43ef51ff0fd49?s=256&d=identicon&r=PG",
      "display_name" : "pingo_bingo",
      "link" : "https://stackoverflow.com/users/2135483/pingo-bingo"
    },
    "creation_date" : 1757596039,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140728684,
    "post_id" : 79761178,
    "body" : "don&#39;t clear collection of leaves juste modify them and it&#39;ll work.",
    "score" : 0,
    "owner" : {
      "account_id" : 4739993,
      "reputation" : 2062,
      "user_id" : 3833111,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/kL1Bd.png?s=256",
      "display_name" : "Mr_Thorynque",
      "link" : "https://stackoverflow.com/users/3833111/mr-thorynque"
    },
    "creation_date" : 1757583320,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140728130,
    "post_id" : 79761178,
    "body" : "more details added",
    "score" : 0,
    "owner" : {
      "account_id" : 2448724,
      "reputation" : 39,
      "user_id" : 2135483,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/7e37c3da985184aa80f43ef51ff0fd49?s=256&d=identicon&r=PG",
      "display_name" : "pingo_bingo",
      "link" : "https://stackoverflow.com/users/2135483/pingo-bingo"
    },
    "creation_date" : 1757559418,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140727591,
    "post_id" : 79761178,
    "body" : "This needs some code to demonstrate the problematic save procedure in detail.  However, the bit about clearing the leaves association and then refilling it with new, identity-less entities sounds highly suspect.  For an <code>Employee</code> already associated with one or more <code>EmployeeLeave</code>s, you can&#39;t just ignore the existing leaves.  Or not without consequences, at any rate.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190712,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1757532323,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}