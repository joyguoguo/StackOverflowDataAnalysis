{
  "question" : {
    "question_id" : 79790891,
    "title" : "Why the method allOf() in CompletableFuture.java is implemented by using something like balanced tree?",
    "body" : "<p>I find that the method allOf() in CompletableFuture.java is implemented by using something like balanced tree.\nI'm curious why it's implemented like that?\nCan it be implemented by using something else, such as ConcurrentHashMap and AutomicInteger?</p>\n<p>I checked the source code of that class.</p>\n<pre><code>/** Recursively constructs a tree of completions. */\nstatic CompletableFuture&lt;Void&gt; andTree(CompletableFuture&lt;?&gt;[] cfs, int lo, int hi) {\n    CompletableFuture&lt;Void&gt; d = new CompletableFuture&lt;Void&gt;();\n\n    if (lo &gt; hi) // empty\n        d.result = NIL;\n    else {\n        CompletableFuture&lt;?&gt; a, b;\n        int mid = (lo + hi) &gt;&gt;&gt; 1;\n\n        if ((a = (lo == mid ? cfs[lo] :\n                  andTree(cfs, lo, mid))) == null ||\n            (b = (lo == hi ? a : (hi == mid+1) ? cfs[hi] :\n                  andTree(cfs, mid+1, hi)))  == null)\n            throw new NullPointerException();\n\n        if (!d.biRelay(a, b)) {\n            BiRelay&lt;?,?&gt; c = new BiRelay&lt;&gt;(d, a, b);\n            a.bipush(b, c);\n            c.tryFire(SYNC);\n        }\n    }\n    return d;\n}\n</code></pre>\n",
    "tags" : [ "java", "completable-future" ],
    "owner" : {
      "account_id" : 44318710,
      "reputation" : 41,
      "user_id" : 31691468,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/430ba9a3db506e5470966ffb64d14219?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Chris Hou",
      "link" : "https://stackoverflow.com/users/31691468/chris-hou"
    },
    "is_answered" : true,
    "view_count" : 116,
    "closed_date" : 1760740265,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1760519883,
    "creation_date" : 1760513274,
    "link" : "https://stackoverflow.com/questions/79790891/why-the-method-allof-in-completablefuture-java-is-implemented-by-using-somethi",
    "closed_reason" : "Needs more focus"
  },
  "answers" : [ {
    "answer_id" : 79790985,
    "question_id" : 79790891,
    "body" : "<p>Of course, there are plenty of alternative implementations possible (I once implemented a similar functionality with a <code>Phaser</code>). But they all involve new data structures while this balanced tree settles on the same data structure used to implement all other <code>then…</code> operations.</p>\n<p>So it’s</p>\n<ol>\n<li>very simple to implement and test (most of it already covered by existing test cases)</li>\n<li>very efficient for the expected majority of cases of having a rather small number of incoming futures while still providing good performance for larger numbers as well</li>\n</ol>\n",
    "score" : 5,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 301001,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1760519839,
    "last_activity_date" : 1760519839,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140798554,
    "post_id" : 79790891,
    "body" : "What would the advantage of another implementation be?",
    "score" : 0,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1760587370,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}