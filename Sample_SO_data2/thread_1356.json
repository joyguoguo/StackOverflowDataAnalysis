{
  "question" : {
    "question_id" : 79719076,
    "title" : "Using Saxon-EE, is it possible to stream the input source for a transformation",
    "body" : "<p>We are streaming the content of a (rather large) XML file. Before we process the content downstream, we want to transform it using Saxon.</p>\n<p>Using the following Akka flow:</p>\n<pre><code>public Flow&lt;ByteString, ByteString, NotUsed&gt; transformFlow(@NonNull final String xslt) {\n    try {\n        Processor processor = new Processor(false);      \n        XsltCompiler compiler = processor.newXsltCompiler();\n        XsltExecutable executable = compiler.compile(new StreamSource(new StringReader(xslt)));\n\n        return Flow\n            .of(ByteString.class)\n            .mapAsync(1, xmlChunk -&gt; CompletableFuture.supplyAsync(() -&gt; {\n                try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream()) {\n                    Xslt30Transformer transformer = executable.load30();\n                    StreamSource xmlSource = new StreamSource(new ByteArrayInputStream(xmlChunk.toArray()));\n                    Serializer serializer = processor.newSerializer(outputStream);\n                    // serializer.setOutputProperty(... omit config\n                    transformer.applyTemplates(xmlSource, serializer);\n                    return ByteString.fromArray(outputStream.toByteArray());\n                } catch (SaxonApiException | IOException e) {\n                    throw new RuntimeException(e);\n                }\n            }))\n            .mapError(SaxonApiException.class,\n                saxonException -&gt; new RuntimeException(saxonException);\n    } catch (SaxonApiException e) {\n        throw new RuntimeException(e);\n    }\n}\n</code></pre>\n<p>Most notably, the mapped <code>xmlChunk</code> is not &quot;the entire XML document&quot;, but rather just a part of it. Eventually, the entire XML will be propagated. The transformer is expecting a <code>StreamSource</code>, so we were under the impression that this should be possible.</p>\n<p>However, Saxon seems to require the entire XML document to be available when calling <code>applyTemplate</code>. We could collect the content of the flow first, by calling (for example)</p>\n<pre><code>Flow.of(ByteString.class).fold(ByteString.emptyByteString(), ByteString::concat) \n</code></pre>\n<p>However, this would load the entire document into memory. We want to avoid that. Is it even possible for Saxon to consume &quot;chunks of XML&quot;? Are we missing something obvious?</p>\n",
    "tags" : [ "java", "stream", "akka", "saxon" ],
    "owner" : {
      "account_id" : 9069472,
      "reputation" : 2550,
      "user_id" : 6753238,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9f7cfd2519b4afdce861f3631552b3fc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Nikolas",
      "link" : "https://stackoverflow.com/users/6753238/nikolas"
    },
    "is_answered" : false,
    "view_count" : 88,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1753823625,
    "creation_date" : 1753813509,
    "link" : "https://stackoverflow.com/questions/79719076/using-saxon-ee-is-it-possible-to-stream-the-input-source-for-a-transformation",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79719216,
    "question_id" : 79719076,
    "body" : "<p>Saxon will execute a transformation in streamed mode provided that your XSLT code is streamable, and is declared to be streamable. The rules for exactly what is streamable are rather complex; the most important rule is that from any given node, you are only allowed to make one downward selection.</p>\n<p>The fact that you haven't shown us any XSLT code suggests you haven't begun to understand these rules, and perhaps, you're not even aware of their existence. I would suggest not starting from the spec (which is tough reading), but from Abel Braaksma's excellent introduction at <a href=\"https://www.xfront.com/Transcript-of-Abel-Braaksma-talk-on-XSLT-Streaming-at-XML-Prague-2014.pdf\" rel=\"nofollow noreferrer\">https://www.xfront.com/Transcript-of-Abel-Braaksma-talk-on-XSLT-Streaming-at-XML-Prague-2014.pdf</a></p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 529122,
      "reputation" : 164983,
      "user_id" : 415448,
      "user_type" : "registered",
      "accept_rate" : 33,
      "profile_image" : "https://i.sstatic.net/P2vVZ.png?s=256",
      "display_name" : "Michael Kay",
      "link" : "https://stackoverflow.com/users/415448/michael-kay"
    },
    "creation_date" : 1753823625,
    "last_activity_date" : 1753823625,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140628168,
    "post_id" : 79719076,
    "body" : "Certainly, using <code>new Processor(true)</code> is a first essential step to get streaming capability. But it&#39;s only the first step on an adventure through the jungle...",
    "score" : 0,
    "owner" : {
      "account_id" : 529122,
      "reputation" : 164983,
      "user_id" : 415448,
      "user_type" : "registered",
      "accept_rate" : 33,
      "profile_image" : "https://i.sstatic.net/P2vVZ.png?s=256",
      "display_name" : "Michael Kay",
      "link" : "https://stackoverflow.com/users/415448/michael-kay"
    },
    "creation_date" : 1753824045,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627916,
    "post_id" : 79719076,
    "body" : "If you want to use XSLT 3.0 streaming with Saxon EE see <a href=\"https://www.saxonica.com/documentation12/index.html#!streaming\" rel=\"nofollow noreferrer\">saxonica.com/documentation12/index.html#!streaming</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 91947,
      "reputation" : 168833,
      "user_id" : 252228,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/3ea75023c3c487f36257090d420b7c50?s=256&d=identicon&r=PG",
      "display_name" : "Martin Honnen",
      "link" : "https://stackoverflow.com/users/252228/martin-honnen"
    },
    "creation_date" : 1753816995,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140627912,
    "post_id" : 79719076,
    "body" : "What kind of chunks do you expect to be able to feed to Saxon, well-formed fragments/external entities or just byte chunks that might be just fragments of the original XML that are not well-formed fragments? Also, the subject says Saxon EE, the code uses <code>new Processor(false)</code>. Saxon EE can process an XML document with XSLT 3.0 streaming but it will do so in my understanding by processing the File or StreamSource of a complete document with a SAX parser and the Saxon EE code doing the necessary steps to do forwards only, node by node streamable processing.",
    "score" : 0,
    "owner" : {
      "account_id" : 91947,
      "reputation" : 168833,
      "user_id" : 252228,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/3ea75023c3c487f36257090d420b7c50?s=256&d=identicon&r=PG",
      "display_name" : "Martin Honnen",
      "link" : "https://stackoverflow.com/users/252228/martin-honnen"
    },
    "creation_date" : 1753816924,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}