{
  "question" : {
    "question_id" : 79761089,
    "title" : "How to set a local file to be the output of a gradle task?",
    "body" : "<p><strong>Context</strong></p>\n<p>We have a large amount of legacy COBOL code that gets built (as a gradle build, outputting jars containing dlls and exes and other artifacts) on different infrastructure to the rest of our Java application. To take load off this infrastructure, I want to, if there's been no changes to this code, skip the build by downloading the latest jars from nexus and republishing them with the new version.</p>\n<p><strong>What I've tried so far</strong></p>\n<p>I've implemented a variable to control if the build should go through or not, and written some code to download the jar from nexus and set it as the output of the task. Here's the code I've written to do that, with company-specific and irrelevant info removed:</p>\n<pre><code>task jcbServer(type: Jar) {\n    if(shouldBuild == 'false')\n    {\n        outputs.file(downloadJar('pathToJarOnNexus', 'nameOfArtifactOnNexus', 'latestPublishedVersionOnNexus'))\n    }\n    else\n    {\n        //run the build - ommitted for brevity as this is existing code I don't want to touch\n    }\n\n}\ntask conversions(type: Jar) {\n    if (shouldBuild == 'false')\n    {\n        outputs.file(downloadJar('pathToJarOnNexus', 'nameOfArtifactOnNexus', 'latestPublishedVersionOnNexus'))\n    }\n    else\n    {\n        //run the build - ommitted for brevity as this is existing code I don't want to touch\n    }\n}\n\ndef downloadJar(def groupPath, def artifactName, def versionToDownload) {\n    def fullVersionedName = &quot;${artifactName}-${versionToDownload}&quot;\n    def serviceJar = new File(&quot;build/${fullVersionedName}.jar&quot;)\n    def sourceUrl = project.buildConfiguration.qaUrl\n    def baseUrlForArtifacts = &quot;${sourceUrl}/${groupPath}/${artifactName}/${versionToDownload}/${fullVersionedName}&quot;\n    def downloadedFile = doDownload(serviceJar, baseUrlForArtifacts)\n    return downloadedFile\n}\n\ndef doDownload(def downloadFile, def baseUrlForArtifacts) {\n    if (!downloadFile.exists()) {\n        downloadFile.parentFile.mkdirs()\n        new URL(&quot;${baseUrlForArtifacts}.jar&quot;)\n                .withInputStream { i -&gt; downloadFile.withOutputStream { it &lt;&lt; i } }\n    }\n    return downloadFile\n}\n</code></pre>\n<p>This downloads the jar from nexus and puts it into the build directory of my local project - that part works.</p>\n<p><strong>The Problem</strong></p>\n<p>When I debug into the outputs.file(...) line, the first line of each respective task, outputs.files already has a jar file present, that is empty. The code that creates this file is not in this build.gradle, and I assume it's specific to my company's gradle setup, other tasks running as a prerequisite to this one, for instance, as the omitted code - when we run the build proper - uses from, include and into statements clearly intended to move files created from that build into the jar.</p>\n<p>This empty jar is the one that is being published by a later task (using the maven-publish plugin). The one I've downloaded is ignored.</p>\n<p><strong>Attempting to fix the problem</strong></p>\n<p>So, I have an empty jar that's being published that I can't do anything about, and a downloaded jar with all the necessary files in. I thought to extract the contents of the downloaded jar to a new folder and bundle those files into the jar, like so:</p>\n<pre><code>import java.util.zip.ZipFile\n\ntask jcbServer(type: Jar) {\n    if(shouldBuild == 'false') {\n        File jarFile = downloadJar('pathToJarOnNexus', 'nameOfArtifactOnNexus', 'latestPublishedVersionOnNexus')\n        extractFilesFromJar(jarFile, 'jcb-server')\n        from('build/jcb-server')\n    }\n    else {\n        //omitted\n    }\n}\n\ntask conversions(type: Jar) {\n    if (shouldBuild == 'false') {\n        File jarFile = downloadJar('pathToJarOnNexus', 'nameOfArtifactOnNexus', 'latestPublishedVersionOnNexus')\n        extractFilesFromJar(jarFile, 'Conversions')\n        from('build/Conversions')\n        jarFile.delete()\n    }\n    else {\n        //omitted\n    }\n}\n\ndef downloadJar(def groupPath, def artifactName, def versionToDownload) {\n    def fullVersionedName = &quot;${artifactName}-${versionToDownload}&quot;\n    def serviceJar = new File(&quot;build/${fullVersionedName}.jar&quot;)\n    def sourceUrl = project.buildConfiguration.qaUrl\n    def baseUrlForArtifacts = &quot;${sourceUrl}/${groupPath}/${artifactName}/${versionToDownload}/${fullVersionedName}&quot;\n    def downloadedFile = doDownload(serviceJar, baseUrlForArtifacts)\n    return downloadedFile\n}\n\ndef extractFilesFromJar(File jarFile, def artifactName)\n{\n    if(jarFile.exists()) {\n        ZipFile jar = new ZipFile(jarFile)\n        //jar extraction code omitted for brevity\n        jar.close()\n    }\n}\n</code></pre>\n<p>However, when I run this, I get a NoSuchFileException when trying to create the ZipFile. On closer inspection, I can see the path of the file I've downloaded is C:\\Users\\sbrown.gradle\\daemon\\7.6.4\\build, which is not where it was actually downloaded to. It was downloaded to the build folder of my local project, in C:\\Projects\\Git. The file has this path both before and after the download, and yet is not downloaded to that path.</p>\n<p>It's at this time I wonder if I'm even doing the right thing by extracting the jar files, or if there's a better, more idiomatic way.</p>\n<p><strong>My Questions</strong></p>\n<p>Assuming I can't change the fact that this empty jar file is being created and published, what's the best way to move the files from the jar I've downloaded into it? Can I remove that jar from the outputs of the task and replace it with my own downloaded one?</p>\n<p>Why is gradle downloading my file to one location, then looking somewhere utterly different for it in the very next executed line?</p>\n<p>How can I get the file I've downloaded into a state where it can be accessed?</p>\n",
    "tags" : [ "java", "gradle", "file-io" ],
    "owner" : {
      "account_id" : 29531006,
      "reputation" : 3,
      "user_id" : 22631626,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6c49ef0d7cd2f9eff648314da972c6ea?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sophie Brown",
      "link" : "https://stackoverflow.com/users/22631626/sophie-brown"
    },
    "is_answered" : false,
    "view_count" : 54,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1757522384,
    "creation_date" : 1757522072,
    "link" : "https://stackoverflow.com/questions/79761089/how-to-set-a-local-file-to-be-the-output-of-a-gradle-task",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}