{
  "question" : {
    "question_id" : 79634160,
    "title" : "StructuredTaskScope, ScopedValue, and daemon threads",
    "body" : "<p>Looking for a solution to the problem of Java daemon threads that require access to <code>ScopedValues</code> as they were bound at the time the daemon thread is created. In order for child threads to inherit <code>ScopedValues</code> it is required to use the <code>StructuredTaskScope</code> fork/join protocol. However, that protocol does not work for daemon threads because it is impossible to create a scope for them that never terminates. Even if the entire main thread is enclosed in such a scope, the daemon thread can continue executing after main() ends and any scope created in main() will, by definition, be terminated.</p>\n<p>Use case: a set of public static <code>ScopedValue</code> hold references to a series of framework services (e.g. logging, DB services, alerting/monitoring services, etc). The daemon threads may call library code that use those services, and that may happen during JVM shutdown after main() ends. The set of services may change over time (e.g. maintenance, new features, etc) so the solution should be robust in the face of a changing list of services.</p>\n<p>I cannot find any way to create the sort of inheritance that <code>StructuredTaskScope</code> does where all bound <code>ScopedValues</code> are automatically bound in the child thread. My solution (below) feels like a hack and is OK for one or two values, but it requires several code changes any time another <code>ScopedValue</code> might be needed in the daemon thread and is prone to errors of omission when some code called many levels deep in the daemon thread uses a scoped value. E.g. it is not obvious which <code>ScopedValues</code> might be referenced by the daemon thread, hence the preference for automatic inheritance such as done by <code>StructureTaskScope</code>.</p>\n<p>Note in the code below that there is no perpetual scope in main(). It creates the daemon thread and immediately exits the <code>ScopedValue.run()</code> block. By that time the <code>ForeverThread</code> has already captured the values it needs to create it's own scope. The big downside to this is having to explicitly list all the values that may be needed by the daemon thread (and all code that it may call).</p>\n<p>Question: Is there a clean way to do this that would not explicit lists of <code>ScopedValues</code> needed in the daemon thread (and all code it may call)?</p>\n<pre><code>static ScopedValue&lt;String&gt; sv1 = ScopedValue.newInstance();\nstatic ScopedValue&lt;String&gt; sv2 = ScopedValue.newInstance();\n\npublic static void main(String args[]) {\n    \n    ScopedValue.where(sv1,  &quot;My value 1&quot;).where(sv2, &quot;My value 2&quot;).run(() -&gt; {\n        System.out.println(&quot;In main thread, sv1.isBound()=&quot;+sv1.isBound());\n        System.out.println(&quot;In main thread, sv2.isBound()=&quot;+sv2.isBound());\n        \n        new ForeverThread(sv1.get(), sv2.get()).start();\n    });\n    \n    try {Thread.sleep(1000);} catch (InterruptedException never) {}\n    System.out.println(&quot;Done&quot;);\n    \n}\n\npublic static class ForeverThread extends Thread {\n    String v1, v2;\n    public ForeverThread(String v1, String v2) {\n        this.setDaemon(true); \n        this.v1 = v1;\n        this.v2 = v2;\n    }\n    @Override\n    public void run() {\n        ScopedValue.where(sv1,  v1).where(sv2,  v2).run(() -&gt; {\n            System.out.println(&quot;In child thread, sv1.isBound()=&quot;+sv1.isBound());\n            System.out.println(&quot;In child thread, sv2.isBound()=&quot;+sv2.isBound());\n        });\n    }\n}\n</code></pre>\n<p>Output, as expected:</p>\n<pre><code>In main thread, sv1.isBound()=true\nIn main thread, sv2.isBound()=true\nIn child thread, sv1.isBound()=true\nIn child thread, sv2.isBound()=true\nDone\n</code></pre>\n",
    "tags" : [ "java", "multithreading", "structured-task-scope", "scoped-value" ],
    "owner" : {
      "account_id" : 3850987,
      "reputation" : 321,
      "user_id" : 3191192,
      "user_type" : "registered",
      "accept_rate" : 57,
      "profile_image" : "https://www.gravatar.com/avatar/74afd7c5199cca16956076fd22c5dd76?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user3191192",
      "link" : "https://stackoverflow.com/users/3191192/user3191192"
    },
    "is_answered" : true,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1747957577,
    "creation_date" : 1747930826,
    "link" : "https://stackoverflow.com/questions/79634160/structuredtaskscope-scopedvalue-and-daemon-threads",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79634668,
    "question_id" : 79634160,
    "body" : "<p>The scope is safely hidden in a private field of <code>Thread</code> class. You are out of luck.</p>\n<p>I vaguely remember Nicolai Parlog mentioning, that support for executor customization may be reintroduced later.</p>\n<p><a href=\"https://github.com/openjdk/jdk/blob/796ec5e7cfcfb20d76a3b48c0b369dc73250f7e4/src/java.base/share/classes/java/lang/Thread.java#L2580\" rel=\"nofollow noreferrer\">https://github.com/openjdk/jdk/blob/796ec5e7cfcfb20d76a3b48c0b369dc73250f7e4/src/java.base/share/classes/java/lang/Thread.java#L2580</a></p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43022,
      "reputation" : 24626,
      "user_id" : 125562,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://i.sstatic.net/SdIqA.png?s=256",
      "display_name" : "Basilevs",
      "link" : "https://stackoverflow.com/users/125562/basilevs"
    },
    "creation_date" : 1747957577,
    "last_activity_date" : 1747957577,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140450167,
    "post_id" : 79634160,
    "body" : "Heh, this means they are working. After all, the main design goal was to prevent access to unrelated values.",
    "score" : 1,
    "owner" : {
      "account_id" : 43022,
      "reputation" : 24626,
      "user_id" : 125562,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://i.sstatic.net/SdIqA.png?s=256",
      "display_name" : "Basilevs",
      "link" : "https://stackoverflow.com/users/125562/basilevs"
    },
    "creation_date" : 1747932301,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}