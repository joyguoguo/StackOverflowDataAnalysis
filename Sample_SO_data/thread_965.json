{
  "question" : {
    "question_id" : 79750163,
    "title" : "Apache HttpClient 5 cache not removing expired resources from disk",
    "body" : "<p>My application needs to fetch resources (images, CSS, fonts, etc.) from given URLs and cache them locally based on the <code>Cache-Control</code>/<code>ETag</code> headers returned with the resource.</p>\n<p>I’m using Apache HttpClient 5 with the cache module:</p>\n<pre><code>&lt;dependency&gt;\n  &lt;groupId&gt;org.apache.httpcomponents.client5&lt;/groupId&gt;\n  &lt;artifactId&gt;httpclient5&lt;/artifactId&gt;\n  &lt;version&gt;5.3.1&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;org.apache.httpcomponents.client5&lt;/groupId&gt;\n  &lt;artifactId&gt;httpclient5-cache&lt;/artifactId&gt;\n  &lt;version&gt;5.3.1&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>Apache HttpClient successfully caches resources locally and fetches a new version once the old one has expired.\nHowever, <strong>old versions of the resources are not removed automatically</strong> from the local cache.</p>\n<p>Here’s my test implementation:</p>\n<pre><code>@Component\npublic class ResourceCache {\n\n  private final CloseableHttpClient client;\n\n  public ResourceCache() {\n        CacheConfig cacheConfig = CacheConfig.custom()\n        .setMaxCacheEntries(2)\n        .setMaxObjectSize(10 * 1024 * 1024)\n        .setSharedCache(false)\n        .setHeuristicCachingEnabled(true)\n        .setHeuristicDefaultLifetime(TimeValue.ofMinutes(2))\n        .build();\n    ManagedHttpCacheStorage storage = new ManagedHttpCacheStorage(cacheConfig);\n\n    client = CachingHttpClients.custom()\n        .setCacheDir(new File(&quot;/my_cache&quot;))\n        .setCacheConfig(cacheConfig)\n        .setHttpCacheStorage(storage)\n        .build();\n\n    ScheduledExecutorService ses = Executors.newSingleThreadScheduledExecutor();\n    ses.scheduleAtFixedRate(storage::cleanResources, 30, 30, TimeUnit.SECONDS);\n  }\n\n  public void fetchAndCache() {\n      List&lt;String&gt; resources = List.of(\n          &quot;https://img.shields.io/npm/v/react.svg&quot;,   // cache-control: max-age=300, s-maxage=300; no ETag\n          &quot;https://jpeg.org/images/jpeg-home.jpg&quot;,   // ETag only\n          &quot;http://httpbin.org/image/png&quot;             // no cache-control, no ETag\n      );\n\n    for (String resource : resources) {\n        HttpGet request = new HttpGet(resource);\n        HttpClientResponseHandler&lt;byte[]&gt; handler = response -&gt; {\n          if (response.getEntity() != null) {\n            return response.getEntity().getContent().readAllBytes();\n          }\n          return new byte[0];\n        };\n\n        try {\n          byte[] data = client.execute(request, handler);\n        } catch (IOException e) {\n          e.printStackTrace();\n        }\n    }\n  }\n}\n</code></pre>\n<p>Observed behavior:</p>\n<ul>\n<li><code>https://img.shields.io/npm/v/react.svg</code> → Has <code>Cache-Control: max-age=300</code>. After it expires, a new version is fetched, but the <strong>old one still exists</strong>. (Also, for some reason, this specific resource seems to be fetched twice each time.)</li>\n<li><code>https://jpeg.org/images/jpeg-home.jpg</code> → Has an <code>ETag</code>. A new version is not fetched (since the ETag hasn’t changed). Expected.</li>\n<li><code>http://httpbin.org/image/png</code> → No cache-control/ETag. Apache client applies heuristic caching. After expiration, a new version is fetched, but again, the <strong>old version remains</strong> in the cache.</li>\n</ul>\n<p>I’m creating my own <code>ManagedHttpCacheStorage</code> so I can call <code>cleanResources()</code> on it periodically from a scheduled job.However, <code>cleanResources()</code> does not remove files from the cache folder.</p>\n<p>The <a href=\"https://hc.apache.org/httpcomponents-client-5.5.x/current/httpclient5-cache/apidocs/org/apache/hc/client5/http/impl/cache/ManagedHttpCacheStorage.html\" rel=\"nofollow noreferrer\">Documentation</a> says that this type of storage can deallocate resources.\nDoes this mean it only removes references from memory but leaves the files on disk?</p>\n<p>Is there a way to automatically clean expired resources from disk with Apache HttpClient 5?\nOr do I need to implement my own cleanup logic?</p>\n<p>Additionally, I noticed that if I manually delete the cache folder while the application is still running, resources are no longer cached and are fetched from the web each time.</p>\n<p><a href=\"https://i.sstatic.net/wc61wCY8.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/wc61wCY8.png\" alt=\"Cache folder content\" /></a></p>\n",
    "tags" : [ "java", "caching", "apache-httpcomponents", "apache-httpclient-5.x" ],
    "owner" : {
      "account_id" : 11778017,
      "reputation" : 232,
      "user_id" : 8618703,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/304cc3f273baeeea8d40e0d9ac9f4d48?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Teodor Mysko",
      "link" : "https://stackoverflow.com/users/8618703/teodor-mysko"
    },
    "is_answered" : false,
    "view_count" : 69,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1756468131,
    "creation_date" : 1756464226,
    "link" : "https://stackoverflow.com/questions/79750163/apache-httpclient-5-cache-not-removing-expired-resources-from-disk",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140702251,
    "post_id" : 79750163,
    "body" : "Upgrade to HttpClient 5.5 and re-test. If the problem persists report the issue to the project <a href=\"https://issues.apache.org/jira/browse/HTTPCLIENT\" rel=\"nofollow noreferrer\">issues.apache.org/jira/browse/HTTPCLIENT</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 133909,
      "reputation" : 27881,
      "user_id" : 335638,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a0176e178f8f08da2ac4524454b4184e?s=256&d=identicon&r=PG",
      "display_name" : "ok2c",
      "link" : "https://stackoverflow.com/users/335638/ok2c"
    },
    "creation_date" : 1756487678,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}