{
  "question" : {
    "question_id" : 79658685,
    "title" : "Apache Camel not shutting down gracefully when an processor task within the route is still in progress",
    "body" : "<p>I'm using Apache Camel with Spring Boot to consume and process large XML files from an SFTP location. The route uses <code>.split().parallelProcessing()</code> to handle thousands of  elements in parallel:</p>\n<p>Here’s a simplified version of the route:</p>\n<pre><code>from(&quot;sftp://my-server/path?options...&quot;)\n    .split()\n        .tokenizeXML(&quot;&lt;record&gt;&quot;, &quot;&lt;/record&gt;&quot;)\n        .streaming()\n        .parallelProcessing()\n        .process(myRecordProcessor)\n    .end();\n</code></pre>\n<p><strong>Shutdown Configuration</strong>:<br />\nWe are using the default shutdown settings from Apache Camel 4.x:<br />\nTimeout: 45 seconds<br />\nShutdown Now On Timeout: true<br />\nLog Inflight Exchanges On Timeout: true<br />\nShutdown Routes In Reverse Order: true<br />\nThe inflight message tracking works as expected — the Camel context shuts down cleanly after 45 seconds if the message isn’t finished.\nHowever, the problem is that when a large file is being processed, and the <code>.split().parallelProcessing()</code> is still running (processing thousands of parts within a single inflight message), the shutdown cuts off the remaining split records. That means the file is only partially processed, and the rest of the records are lost.</p>\n<p><strong>Question</strong>:<br />\nIs there a way to make Camel wait for internal parallel tasks inside a <code>.split().parallelProcessing()</code> to finish before treating the inflight exchange as done, or delay shutdown until all those tasks complete?</p>\n<p>Any insights or recommended approaches are highly appreciated!</p>\n",
    "tags" : [ "java", "spring-boot", "apache-camel" ],
    "owner" : {
      "account_id" : 42440424,
      "reputation" : 1,
      "user_id" : 30753184,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd99e8a16ab989c94091749c2e44fb9f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Rahul Dravid",
      "link" : "https://stackoverflow.com/users/30753184/rahul-dravid"
    },
    "is_answered" : false,
    "view_count" : 92,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1750774735,
    "creation_date" : 1749463600,
    "link" : "https://stackoverflow.com/questions/79658685/apache-camel-not-shutting-down-gracefully-when-an-processor-task-within-the-rout",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79677744,
    "question_id" : 79658685,
    "body" : "<p>Increase the timeout to a higher value</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 176018,
      "reputation" : 55665,
      "user_id" : 406429,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/62d4ca92192b41f45829db7b7020ee0e?s=256&d=identicon&r=PG",
      "display_name" : "Claus Ibsen",
      "link" : "https://stackoverflow.com/users/406429/claus-ibsen"
    },
    "creation_date" : 1750774735,
    "last_activity_date" : 1750774735,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140503982,
    "post_id" : 79658685,
    "body" : "Look at the MainListenerSupport class. You can extend and add your beforeStop method. You can check if your route is infligh using InflightRepository from context and then see how much time you need to wait. Look at the MainShutdownStrategy as well.",
    "score" : 0,
    "owner" : {
      "account_id" : 8567346,
      "reputation" : 153,
      "user_id" : 6419447,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-SHt3TOdpsSg/AAAAAAAAAAI/AAAAAAAAAZc/67vOWlRDzPQ/s256-rj/photo.jpg",
      "display_name" : "Jawad Ahmad",
      "link" : "https://stackoverflow.com/users/6419447/jawad-ahmad"
    },
    "creation_date" : 1749596144,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}