{
  "question" : {
    "question_id" : 79569813,
    "title" : "NATS communication issue between NestJS (gateway) and Spring Boot (microservice) using request-reply pattern",
    "body" : "<p>I'm implementing a microservices system where a NestJS gateway communicates with a Spring Boot microservice using NATS as the message broker.</p>\n<p>The issue is that when I send a message from my NestJS gateway to the Spring Boot microservice, the microservice seems to receive the message correctly (verified through logs), processes the information, and sends back a response, but NestJS never receives this response.</p>\n<h1>NestJS Gateway</h1>\n<pre><code>import { Body, Controller, Inject, Post } from &quot;@nestjs/common&quot;;\nimport { ClientProxy, RpcException } from &quot;@nestjs/microservices&quot;;\n\nimport { SERVICES } from &quot;src/config&quot;;\nimport { LoginUserRequestDto } from &quot;./dtos/LoginUser.dto&quot;;\nimport { catchError, lastValueFrom, timeout } from &quot;rxjs&quot;;\n\nexport class LoginUserRequestDto {\n    username: string;\n    password: string;\n}\n\nexport enum SERVICES {\n    NATS_SERVICE = &quot;NATS_SERVICE&quot;,\n}\n\n\n@Controller(&quot;auth&quot;)\nexport class AuthController {\n    constructor(\n        @Inject(SERVICES.NATS_SERVICE) private readonly client: ClientProxy,\n    ) {}\n\n    @Post(&quot;/login&quot;)\n    async login(@Body() loginUserRequestDto: LoginUserRequestDto) {\n        console.log(loginUserRequestDto);\n\n        const msResponse = await lastValueFrom(\n            this.client.send(&quot;login.crud.ms&quot;, loginUserRequestDto).pipe(\n                timeout(10000),\n                catchError((error) =&gt; {\n                    throw new RpcException(error);\n                }),\n            ),\n        );\n\n        console.log(msResponse);\n        return msResponse;\n\n        // return this.client.send(&quot;login.crud.ms&quot;, loginUserRequestDto).pipe(\n        //  timeout(5000),\n        //  catchError((error) =&gt; {\n        //      throw new RpcException(error);\n        //  }),\n        // );\n    }\n}\n</code></pre>\n<h1>NATS Client Configuration in NestJS</h1>\n<pre><code>import { Module } from &quot;@nestjs/common&quot;;\nimport { ClientsModule, Transport } from &quot;@nestjs/microservices&quot;;\n\nimport { enviromentVariables, SERVICES } from &quot;src/config&quot;;\n\n@Module({\n    imports: [\n        ClientsModule.register([\n            {\n                name: SERVICES.NATS_SERVICE,\n                transport: Transport.NATS,\n                options: {\n                    servers: enviromentVariables.natsSever,\n                },\n            },\n        ]),\n    ],\n    exports: [\n        ClientsModule.register([\n            {\n                name: SERVICES.NATS_SERVICE,\n                transport: Transport.NATS,\n                options: {\n                    servers: enviromentVariables.natsSever,\n                },\n            },\n        ]),\n    ],\n})\nexport class TransportsModule {}\n</code></pre>\n<h1>Spring Boot Microservice</h1>\n<pre><code>@RestController\n@Validated\n@RequestMapping(&quot;/users&quot;)\npublic class UserController {\n\n    private UserService userService;\n    private final Connection natsConnection;\n    private final ObjectMapper objectMapper;\n\n    UserController(UserService userService, Connection natsConnection, ObjectMapper objectMapper) {\n        this.userService = userService;\n        this.natsConnection = natsConnection;\n        this.objectMapper = objectMapper;\n    }\n\n    @PostConstruct\n    public void subscriberTopic() {\n        loginUserMS();\n    }\n\n    public void loginUserMS() {\n        natsConnection.createDispatcher(msg -&gt; {\n            try {\n                String rawJSON = new String(msg.getData(), StandardCharsets.UTF_8);\n                System.out.println(rawJSON); // IN CONSOLE: {&quot;pattern&quot;:&quot;login.crud.ms&quot;,&quot;data&quot;:{&quot;username&quot;:&quot;pedro123&quot;,&quot;password&quot;:&quot;1234&quot;},&quot;id&quot;:&quot;23f2bd6f679cc394c433d&quot;}\n\n                \n                JsonNode rootNode = objectMapper.readTree(rawJSON);\n\n                JsonNode dataNode = rootNode.get(&quot;data&quot;);\n                String correlationId = rootNode.get(&quot;id&quot;).asText();\n\n                \n                LoginUserRequestDto loginUserRequestDto = objectMapper.treeToValue(dataNode,\n                        LoginUserRequestDto.class);\n\n               \n\n                // LLAMO A MI SERVICIO NORMAL\n                UserDto loggedUser = userService.login(loginUserRequestDto);\n\n\n                System.out.println(loggedUser.toString());\n\n                Map&lt;String, Object&gt; replyWrapper = new HashMap&lt;&gt;();\n                replyWrapper.put(&quot;id&quot;, correlationId);\n                replyWrapper.put(&quot;err&quot;, null);\n                replyWrapper.put(&quot;response&quot;, loggedUser);\n\n                // SERIALIZO LA RESPUESTA\n                String response = objectMapper.writeValueAsString(loggedUser);\n                // String response = objectMapper.writeValueAsString(replyWrapper);\n\n\n                System.out.println(response); // In console: {&quot;id&quot;:&quot;98e54e58-af64-417d-97ba-637e6be6e4b3&quot;,&quot;name&quot;:&quot;Enrique&quot;,&quot;username&quot;:&quot;pedro123&quot;,&quot;email&quot;:&quot;pepe123@gmail.com&quot;}\n\n                // natsConnection.publish(msg.getReplyTo(),\n                // response.getBytes(StandardCharsets.UTF_8));\n                natsConnection.publish(msg.getReplyTo(), response.getBytes(StandardCharsets.UTF_8));\n            } catch (Exception e) {\n                e.printStackTrace();\n                if (msg.getReplyTo() != null) {\n                    String errorResponse = &quot;{\\&quot;error\\&quot;: \\&quot;&quot; + e.getMessage() + &quot;\\&quot;}&quot;;\n                    natsConnection.publish(msg.getReplyTo(), errorResponse.getBytes(StandardCharsets.UTF_8));\n                }\n                throw new Error(e.getMessage());\n            }\n        }\n\n        ).subscribe(&quot;login.crud.ms&quot;);\n    }\n</code></pre>\n<p>The logs show that Spring Boot is receiving the message, processing it, and publishing the response to the correct replyTo, but NestJS never receives this response and the timeout is triggered.</p>\n<p>Can anyone help me identify what's failing in this communication?\n<a href=\"https://i.sstatic.net/QawekenZ.png\" rel=\"nofollow noreferrer\">Postman output</a></p>\n",
    "tags" : [ "java", "spring", "nestjs", "microservices", "nats.io" ],
    "owner" : {
      "account_id" : 41179844,
      "reputation" : 33,
      "user_id" : 30161771,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/44d6df46931e88f2000677e3f4a155bc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "H&#233;ctor Romero",
      "link" : "https://stackoverflow.com/users/30161771/h%c3%a9ctor-romero"
    },
    "is_answered" : false,
    "view_count" : 71,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1744412253,
    "creation_date" : 1744412253,
    "link" : "https://stackoverflow.com/questions/79569813/nats-communication-issue-between-nestjs-gateway-and-spring-boot-microservice",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}