{
  "question" : {
    "question_id" : 79599173,
    "title" : "PriorityQueue Comparator weird behavior when sort order is fetched from hashmap",
    "body" : "<p>While working in <a href=\"https://leetcode.com/problems/cut-off-trees-for-golf-event/description/\" rel=\"nofollow noreferrer\">LeetCode 675</a>, I came across a weird behavior with <code>PriorityQueue</code> <code>Comparator</code> that I can't explain.</p>\n<p>For brevity, I'll state the gist of the problem statement; interested parties can read it on LeetCode in full detail.</p>\n<blockquote>\n<p>Given a mxn matrix called <code>forest</code>, some cells are designated as <code>tree</code>s. The ask is to find the minimum number of steps to visit (cut off) all tree cells, in ascending order of tree heights.</p>\n</blockquote>\n<p>To solve this, I find all the trees, and sort them in ascending order of height. Then I calculate the minimum distance from each tree to its next by running an A* search using the heuristic function: <code>distance from source + Manhattan distance from the goal</code></p>\n<p>The minimum number of steps to cut off all the trees is the sum of all the A* distances.\nIf at any point the A* search fails to return a path, I abort.</p>\n<pre class=\"lang-java prettyprint-override\"><code>class Solution {\n  private final int[][] dx = new int[][] {{-1, 0}, {1, 0}, {0, -1}, {0, 1}};\n\n  public int cutOffTree(List&lt;List&lt;Integer&gt;&gt; forest) {\n    int[] curr = new int[] {0, 0};\n    int dist = 0;\n\n    for (int[] next : getTreesSortedByHeight(forest)) {\n      int d = minDist(forest, curr, next);\n      if (d &lt; 0) {\n        return -1;\n      }\n      curr = next;\n      dist += d;\n    }\n\n    return dist;\n  }\n\n  private List&lt;int[]&gt; getTreesSortedByHeight(List&lt;List&lt;Integer&gt;&gt; forest) {\n    List&lt;int[]&gt; trees = new ArrayList&lt;&gt;();\n    for (int row = 0; row &lt; forest.size(); row++) {\n      for (int col = 0; col &lt; forest.get(0).size(); col++) {\n        if (forest.get(row).get(col) &gt; 1) {\n          trees.add(new int[] {row, col});\n        }\n      }\n    }\n    trees.sort(Comparator.comparingInt(a -&gt; forest.get(a[0]).get(a[1])));\n    return trees;\n  }\n\n  int minDist(List&lt;List&lt;Integer&gt;&gt; forest, int[] start, int[] goal) {\n    int m = forest.size();\n    int n = forest.get(0).size();\n    Map&lt;Integer, Integer&gt; costs = new HashMap&lt;&gt;();\n    costs.put(start[0] * n + start[1], manhattanDist(start[0], start[1], goal));\n    // GOTCHA: Fetching the distance from the cost map using the coordinates doesn't work!\n    Queue&lt;int[]&gt; heap = new PriorityQueue&lt;&gt;(Comparator.comparingInt(a -&gt; a[0]));\n    heap.offer(new int[] {0, 0, start[0], start[1]}); // [cost, distance, row, column]\n\n    while (!heap.isEmpty()) {\n      int[] curr = heap.poll();\n      int dist = curr[1];\n      int row = curr[2];\n      int col = curr[3];\n\n      if (row == goal[0] &amp;&amp; col == goal[1]) {\n        return dist;\n      }\n      for (int[] d : dx) {\n        int r = row + d[0];\n        int c = col + d[1];\n        if (r &gt;= 0 &amp;&amp; r &lt; m &amp;&amp; c &gt;= 0 &amp;&amp; c &lt; n &amp;&amp; forest.get(r).get(c) &gt; 0) {\n          int cost = dist + 1 + manhattanDist(r, c, goal);\n          if (cost &lt; costs.getOrDefault(r * n + c, Integer.MAX_VALUE)) {\n            costs.put(r * n + c, cost);\n            heap.offer(new int[] {cost, dist + 1, r, c});\n          }\n        }\n      }\n    }\n    return -1;\n  }\n\n  private int manhattanDist(int row, int col, int[] goal) {\n    return Math.abs(goal[0] - row) + Math.abs(goal[1] - col);\n  }\n}\n</code></pre>\n<p>Note that <strong>each heap entry contains the heuristic cost</strong>. Logically, this is <strong>unnecessary</strong>, because the entry also contains the cell coordinates (row and column), using which <strong>we can fetch the distance</strong> from the <code>costs</code> map as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Queue&lt;int[]&gt; heap = new PriorityQueue&lt;&gt;(Comparator.comparingInt(a -&gt; costs.get(a[1] * n + a[2]);\n</code></pre>\n<ul>\n<li>In absence of the cost, the heap entry consists of [distance, row, column].</li>\n</ul>\n<p>But this <strong>doesn't work</strong>, and fails one of the test cases. The test case is huge, so, I see no point in pasting it here, as it is unlikely anyone would have the time to debug it.</p>\n<p><strong>What I'd like to know is why this weirdness.</strong></p>\n<p><strong>Edit:</strong>\nAdded complete code as requested in a comment.</p>\n",
    "tags" : [ "java", "hashmap", "priority-queue", "shortest-path", "a-star" ],
    "owner" : {
      "account_id" : 446597,
      "reputation" : 25249,
      "user_id" : 839733,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
      "display_name" : "Abhijit Sarkar",
      "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
    },
    "is_answered" : true,
    "view_count" : 123,
    "answer_count" : 1,
    "score" : -3,
    "last_activity_date" : 1746039450,
    "creation_date" : 1745958861,
    "link" : "https://stackoverflow.com/questions/79599173/priorityqueue-comparator-weird-behavior-when-sort-order-is-fetched-from-hashmap",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79599273,
    "question_id" : 79599173,
    "body" : "<p><code>PriorityQueue</code> cannot handle it if the ordering of its elements changes while they are still in the queue, and its behavior is undefined in that scenario.  Very weird things are likely to happen, since the heap property of the elements is silently broken with no way for <code>PriorityQueue</code> to know that that has happened.  It seems pretty clear that that can happen, since multiple paths to the same node can result in the same element being in the queue in multiple places.</p>\n<p>Your original code is, in fact, the best way to do it.</p>\n",
    "score" : 7,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1745965085,
    "last_activity_date" : 1745965085,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140389202,
    "post_id" : 79599173,
    "body" : "quoting: &quot;<i>it’s not similar</i>&quot; - maybe not, but could have helped solving the problem (&quot;<i>it’s the root cause of the problem</i>&quot;) -- &quot;<i>I couldn’t care less about downvotes</i>&quot; but your first comment can be interpreted differently: &quot;<i>someone with no idea of the problem has downvoted</i>&quot;",
    "score" : 0,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1746171716,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140386599,
    "post_id" : 79599173,
    "body" : "I understand that, no need to explain - It was one of many guesses WHY the question was downvoted; and just because it is not possible doesn&#39;t make the question better",
    "score" : 0,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1746092860,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140386118,
    "post_id" : 79599173,
    "body" : "@user85421 As for the minimum reproducible code, it was stated in the question that due to the nature of the test case, it wasn’t practical to include it. Not every problem can be easily reproduced; it’s just the way software works.",
    "score" : 0,
    "owner" : {
      "account_id" : 446597,
      "reputation" : 25249,
      "user_id" : 839733,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
      "display_name" : "Abhijit Sarkar",
      "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
    },
    "creation_date" : 1746069825,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140386110,
    "post_id" : 79599173,
    "body" : "@user85421 Except it’s not similar.  The block of text you posted all specifically ask about changing the  priority of an element on the queue, which is precisely what the accepted answer explains. That’s not what I asked in the question, it’s the root cause of the problem. And I couldn’t care less about downvotes",
    "score" : 0,
    "owner" : {
      "account_id" : 446597,
      "reputation" : 25249,
      "user_id" : 839733,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
      "display_name" : "Abhijit Sarkar",
      "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
    },
    "creation_date" : 1746069444,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140385849,
    "post_id" : 79599173,
    "body" : "<a href=\"https://stackoverflow.com/q/76202133/85421\">java - Max heap property not obeyed by PriorityQueue</a> , <a href=\"https://stackoverflow.com/q/1871253/85421\">Updating Java PriorityQueue when its elements change priority</a> , <a href=\"https://stackoverflow.com/q/25679191/85421\">priority queue cannot sort automatically when its value has been changed</a> , <a href=\"https://stackoverflow.com/q/8067924/85421\">Does a PriorityQueue allow elements already within the queue to be reordered?</a> , <a href=\"https://stackoverflow.com/q/29166363/85421\">Changing the priority of an element in a PriorityQueue</a> , ...",
    "score" : 3,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1746055715,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140385842,
    "post_id" : 79599173,
    "body" : "&quot;<i>someone with no idea ...</i>&quot; - maybe you should search the <i>problem</i> at your question before blaming someone else (4 downvotes and a close vote indicates that more readers see some problem with the question ... btw I did not downvote - maybe it is because similar problem was asked before or just missing code/<a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> ...)",
    "score" : 3,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1746055512,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140382051,
    "post_id" : 79599173,
    "body" : "@DuncG The reason for using 1&amp;2, not 2&amp;3, is stated right on the next line. I honestly don&#39;t know how I can be any clearer. &quot;<i>In absence of the cost, the heap entry consists of [distance, row, column].</i> I&#39;ve updated the code to show the complete solution, but as stated already, the test case that fails the code is so large, it&#39;s practically impossible to put it in the question. I add a link to some file share.",
    "score" : 2,
    "owner" : {
      "account_id" : 446597,
      "reputation" : 25249,
      "user_id" : 839733,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
      "display_name" : "Abhijit Sarkar",
      "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
    },
    "creation_date" : 1745966085,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140381968,
    "post_id" : 79599173,
    "body" : "A <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> would be helpful. In the code you show r&amp;c are indexes 2&amp;3 not 1&amp;2 used in the modification",
    "score" : 2,
    "owner" : {
      "account_id" : 5998820,
      "reputation" : 16283,
      "user_id" : 4712734,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6e922a2cb7e2da59286f27b162aaca5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "DuncG",
      "link" : "https://stackoverflow.com/users/4712734/duncg"
    },
    "creation_date" : 1745964252,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140381966,
    "post_id" : 79599173,
    "body" : "If the two approaches do not produce the same result, then the logical conclusion is that reading the costs from the entries does not always produce the same values as reading them from the <code>costs</code> map.  I don&#39;t see how that can be so unless sometimes the same cell is enqueued more than once.  And it&#39;s not clear to me why that couldn&#39;t happen.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1745964228,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140381850,
    "post_id" : 79599173,
    "body" : "I see that someone with no idea of the problem has downvoted and voted to close the post already :)",
    "score" : 0,
    "owner" : {
      "account_id" : 446597,
      "reputation" : 25249,
      "user_id" : 839733,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
      "display_name" : "Abhijit Sarkar",
      "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
    },
    "creation_date" : 1745961136,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79599273" : [ {
      "comment_id" : 140382065,
      "post_id" : 79599273,
      "body" : "In other words, the cost for a node in the map may get updated without the PQ knowing about it. This makes complete sense to me.",
      "score" : 0,
      "owner" : {
        "account_id" : 446597,
        "reputation" : 25249,
        "user_id" : 839733,
        "user_type" : "registered",
        "accept_rate" : 69,
        "profile_image" : "https://i.sstatic.net/2s6lO.jpg?s=256",
        "display_name" : "Abhijit Sarkar",
        "link" : "https://stackoverflow.com/users/839733/abhijit-sarkar"
      },
      "creation_date" : 1745966472,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}