{
  "question" : {
    "question_id" : 79756825,
    "title" : "How to properly parallelise JFreeChart&#39;s PNG generation?",
    "body" : "<p>I use JFreeChart to create various kinds of charts en masse, based on huge amounts of data. Those charts are only meant to be written to PNG files on the hard drive; no JavaFX, Swing, AWT or other GUI is involved at all.</p>\n<p>In order to speed up the generation of those charts, I decided to implement parallelisation with one thread per processor core:</p>\n<pre class=\"lang-java prettyprint-override\"><code>final int cores = Runtime.getRuntime().availableProcessors();\n\ntry (final ExecutorService threadPool = Executors.newFixedThreadPool(cores)) {\n    for (final YearMonth yearMonth : dataset.keySet()) {\n        final Runnable task = () -&gt; {\n            // Call JFreeChart …\n        };\n\n        threadPool.submit(task);\n    }\n\n    threadPool.shutdown();\n    threadPool.awaitTermination(Long.MAX_VALUE, java.util.concurrent.TimeUnit.NANOSECONDS);\n}\n</code></pre>\n<p>When looking at the timeline in order to verify optimal throughput (i.e. CPU usage as high as possible), I noticed something odd: Between two parallelised phases (with one thread per core running) there was a long phase where only one thread was running and all others sleeping.</p>\n<p>In order to check that I didn't accidentally break my own multi-threading, I created the following MRE:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Test\n    public void testMultiThreadingClassic() throws InterruptedException {\n        final int cores = Runtime.getRuntime().availableProcessors();\n        final CountDownLatch latch = new CountDownLatch(cores);\n\n        for (int i = 0; i &lt; cores; i++) {\n            final int index = i;\n            new Thread(() -&gt; {\n                try {\n                    this.createFakeChart(\n                        &quot;Fake Chart &quot; + index,\n                        new File(&quot;fake-chart-%s.png&quot;.formatted(index))\n                    );\n                } catch (final IOException e) {\n                    LOG.error(&quot;Could not create fake chart&quot;, e);\n                    System.exit(1);\n                } finally {\n                    latch.countDown();\n                }\n            }).start();\n        }\n\n        latch.await();\n    }\n\n    private void createFakeChart(String title, File outputFile) throws IOException {\n        final TimeSeries timeSeries = new TimeSeries(&quot;Test Series&quot;);\n\n        final LocalDateTime startDate = LocalDateTime.of(2020, 1, 1, 0, 0);\n        final LocalDateTime endDate = LocalDateTime.of(2024, 1, 1, 0, 0);\n        LocalDateTime currentDate = startDate;\n\n        while (!currentDate.isAfter(endDate)) {\n            timeSeries.add(\n                new org.jfree.data.time.Day(\n                    currentDate.getDayOfMonth(),\n                    currentDate.getMonthValue(),\n                    currentDate.getYear()\n                ),\n                Math.random() * 100\n            );\n\n            currentDate = currentDate.plusDays(1);\n        }\n\n        final TimeSeriesCollection dataset = new TimeSeriesCollection();\n        dataset.addSeries(timeSeries);\n        final IntervalXYDataset xyBarDataset = new XYBarDataset(dataset, 24 * 60 * 60 * 1000L);\n\n        final JFreeChart chart = ChartFactory.createXYBarChart(\n            title,\n            &quot;Day&quot;,\n            true,\n            &quot;Random number&quot;,\n            xyBarDataset\n        );\n\n        final DateAxis dateAxis = new DateAxis();\n        dateAxis.setDateFormatOverride(new SimpleDateFormat(&quot;yyyy-MM-dd&quot;));\n        dateAxis.setTickUnit(new DateTickUnit(DateTickUnitType.YEAR, 1));\n        chart.getXYPlot().setDomainAxis(dateAxis);\n\n        ChartUtils.saveChartAsPNG(\n            outputFile,\n            chart,\n            1000,\n            500\n        );\n    }\n</code></pre>\n<p>Here's the timeline at two points in time:</p>\n<p><a href=\"https://i.sstatic.net/JfWakjh2.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/JfWakjh2.png\" alt=\"enter image description here\" /></a></p>\n<p><a href=\"https://i.sstatic.net/oJKJdY6A.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/oJKJdY6A.png\" alt=\"enter image description here\" /></a></p>\n<p>Here's the first stack trace (Thread-0, 00:00:05.565):</p>\n<pre><code>createFontConfiguration:690, X11FontManager (sun.awt)\n&lt;init&gt;:341, SunFontManager (sun.font)\n&lt;init&gt;:35, FcFontManager (sun.awt)\n&lt;init&gt;:55, X11FontManager (sun.awt)\ncreateFontManager:37, PlatformFontInfo (sun.font)\ngetInstance:51, FontManagerFactory (sun.font)\ngetInstance:240, SunFontManager (sun.font)\ngetMetrics:260, FontDesignMetrics (sun.font)\ngetFontMetrics:862, SunGraphics2D (sun.java2d)\ngetStringWidth:64, G2TextMeasurer (org.jfree.chart.text)\nnextLineBreak:227, TextUtils (org.jfree.chart.text)\ncreateTextBlock:168, TextUtils (org.jfree.chart.text)\narrangeRR:569, TextTitle (org.jfree.chart.title)\narrange:443, TextTitle (org.jfree.chart.title)\ndrawTitle:1233, JFreeChart (org.jfree.chart)\ndraw:1149, JFreeChart (org.jfree.chart)\ncreateBufferedImage:1316, JFreeChart (org.jfree.chart)\ncreateBufferedImage:1297, JFreeChart (org.jfree.chart)\nwriteChartAsPNG:146, ChartUtils (org.jfree.chart)\nsaveChartAsPNG:272, ChartUtils (org.jfree.chart)\nsaveChartAsPNG:247, ChartUtils (org.jfree.chart)\ncreateFakeChart:215, JFreeChartTest (com.example.jfreechart)\nlambda$testMultiThreadingClassic$0:191, JFreeChartTest (com.example.jfreechart)\nrunWith:1460, Thread (java.lang)\nrun:1447, Thread (java.lang)\n</code></pre>\n<p>Here's the second stack trace (Thread-4, 00:00:06.455):</p>\n<pre><code>getFontPathNative:-1, FcFontManager (sun.awt)\ngetFontPath:710, X11FontManager (sun.awt)\ngetPlatformFontPath:2878, SunFontManager (sun.font)\nloadFonts:2904, SunFontManager (sun.font)\nloadFonts:423, X11FontManager (sun.awt)\nfindFont2D:2059, SunFontManager (sun.font)\ngetFont2D:526, Font (java.awt)\ngetFont2D:262, Font$FontAccessImpl (java.awt)\ngetFont2D:141, FontUtilities (sun.font)\ninitMatrixAndMetrics:353, FontDesignMetrics (sun.font)\n&lt;init&gt;:346, FontDesignMetrics (sun.font)\ngetMetrics:298, FontDesignMetrics (sun.font)\ngetFontMetrics:862, SunGraphics2D (sun.java2d)\ngetStringWidth:63, G2TextMeasurer (org.jfree.chart.text)\nnextLineBreak:227, TextUtils (org.jfree.chart.text)\ncreateTextBlock:168, TextUtils (org.jfree.chart.text)\narrangeRR:569, TextTitle (org.jfree.chart.title)\narrange:443, TextTitle (org.jfree.chart.title)\ndrawTitle:1233, JFreeChart (org.jfree.chart)\ndraw:1149, JFreeChart (org.jfree.chart)\ncreateBufferedImage:1316, JFreeChart (org.jfree.chart)\ncreateBufferedImage:1297, JFreeChart (org.jfree.chart)\nwriteChartAsPNG:146, ChartUtils (org.jfree.chart)\nsaveChartAsPNG:272, ChartUtils (org.jfree.chart)\nsaveChartAsPNG:247, ChartUtils (org.jfree.chart)\ncreateFakeChart:244, JFreeChartTest (com.example.jfreechart)\nlambda$testMultiThreadingClassic$0:191, JFreeChartTest (com.example.jfreechart)\nrunWith:1460, Thread (java.lang)\nrun:1447, Thread (java.lang)\n</code></pre>\n<p>As you can see in the stack trace, <code>SunFontManager#loadFonts:2904</code> is called, and that line is inside a giant <code>synchronized</code> block:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    protected void loadFonts() {\n        if (discoveredAllFonts) {\n            return;\n        }\n        /* Use lock specific to the font system */\n        synchronized (this) {\n            // …\n            if (fontPath != null) {\n                if (! gotFontsFromPlatform()) {\n                    registerFontsOnPath(fontPath, false,\n                                        Font2D.UNKNOWN_RANK,\n                                        false, true);\n                    // …\n                }\n            }\n            // …\n        }\n    }\n</code></pre>\n<p>It's very frustrating to see that my parallelisation of the charts' generation is bottle-necked by font-related I/O.</p>\n<p>Can I speed up that process of discovering and loading the system's fonts somehow? For example by bringing a custom font? Or did I overlook something in the first place?</p>\n",
    "tags" : [ "java", "multithreading", "parallel-processing", "jfreechart" ],
    "owner" : {
      "account_id" : 14267796,
      "reputation" : 440,
      "user_id" : 10306323,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/7vHNh.png?s=256",
      "display_name" : "Pixelcode",
      "link" : "https://stackoverflow.com/users/10306323/pixelcode"
    },
    "is_answered" : false,
    "view_count" : 70,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1757092368,
    "creation_date" : 1757078440,
    "link" : "https://stackoverflow.com/questions/79756825/how-to-properly-parallelise-jfreecharts-png-generation",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140717332,
    "post_id" : 79756825,
    "body" : "By the way, you should remember to leave a CPU core for the JVM itself to use.",
    "score" : 1,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44936,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1757081150,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140717329,
    "post_id" : 79756825,
    "body" : "I would give <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.desktop/java/awt/EventQueue.html#invokeAndWait(java.lang.Runnable)\" rel=\"nofollow noreferrer\">EventQueue.invokeAndWait</a>(() -&gt; <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.desktop/java/awt/GraphicsEnvironment.html#getAllFonts()\" rel=\"nofollow noreferrer\">GraphicsEnvironment.getLocalGraphicsEnvironment().getAllFont&zwnj;&#8203;s()</a>) a try.",
    "score" : 1,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44936,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1757080958,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140717287,
    "post_id" : 79756825,
    "body" : "Please add a stack trace in text.",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1757080209,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}