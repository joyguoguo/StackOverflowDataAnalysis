{
  "question" : {
    "question_id" : 79695875,
    "title" : "CharsetDecoder used within InputStream in release Java 8 onwards doesn&#39;t seem to honor CodingErrorAction.Replace",
    "body" : "<p>Issue can be found in version Java8 onwards. A CharsetDecoder is explicitly configured with <strong>CodingErrorAction.REPLACE</strong> ;  I would expect the replacement character \\uFFFD to be applied when decoding malformed input .</p>\n<p>On using CharsetDecoder with the InputStream the replacement Character is not applied on malformed input, especially when it is towards the end of the byte stream.</p>\n<p>Is this the expected outcome on using REPLACE with CharsetDecoder</p>\n<pre><code>final String z = &quot;髙&quot;;\nCharset charset = Charset.forName(&quot;x-windows-iso2022jp&quot;);\n\nCharsetDecoder charsetDecoderForStr = charset.newDecoder()\n        .onMalformedInput(CodingErrorAction.REPLACE)\n        .onUnmappableCharacter(CodingErrorAction.REPLACE);\n\nCharsetDecoder charsetDecoderForStrm = charset.newDecoder()\n        .onMalformedInput(CodingErrorAction.REPLACE)\n        .onUnmappableCharacter(CodingErrorAction.REPLACE);\n\nByteBuffer buffer = ByteBuffer.allocate(21);\nbyte[] bytes = {27, 36, 66, 124, 98, 27, 40, 66, 27};\nbuffer.put(bytes);\n\nSystem.out.println(&quot;Using new String without Decoder&quot;+new String(bytes, charset).trim());\nSystem.out.println(&quot;Using Decoder &quot;+charsetDecoderForStr.decode((ByteBuffer) buffer.flip()).toString().trim());\n\nReader reader = new InputStreamReader(new ByteArrayInputStream(bytes), charsetDecoderForStrm);\nchar[] chars = new char[10];\nreader.read(chars);\nSystem.out.println(&quot;Using StreamDecoder &quot;+new String(chars).trim());\n\n\n</code></pre>\n<pre><code>Using new String without Decoder髙�  //uses default decoder\nUsing Decoder 髙�               // uses decoder with codingErrorAction.REPLACE\nUsing StreamDecoder 髙    //uses decoder with codingErrorAction.REPLACE\n</code></pre>\n<p>StreamDecoder has no replacement character &quot;\\uFFFD&quot;</p>\n",
    "tags" : [ "java", "string", "java-8" ],
    "owner" : {
      "account_id" : 975767,
      "reputation" : 521,
      "user_id" : 997044,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
      "display_name" : "George",
      "link" : "https://stackoverflow.com/users/997044/george"
    },
    "is_answered" : true,
    "view_count" : 157,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1752138321,
    "creation_date" : 1752074031,
    "link" : "https://stackoverflow.com/questions/79695875/charsetdecoder-used-within-inputstream-in-release-java-8-onwards-doesnt-seem-to",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79696097,
    "question_id" : 79695875,
    "body" : "<blockquote>\n<p>On using CharsetDecoder with the InputStream the replacement Character is not applied on malformed input, especially when it is towards the end of the byte stream.</p>\n</blockquote>\n<p>Your example does not demonstrate that.  What it shows is that the replacement character is not read from the reader <em>on the first read</em>.  But neither <code>Reader</code> in general nor <code>InputStreamReader</code> in particular makes any promises about how much data is transferred on any given invocation of <code>read(char[])</code>, other than that (for an argument with length greater than 0), it will block until at least one character is transferred, the end of the data is reached, or an error occurs.</p>\n<p>You observe one character being transferred on the first <code>read()</code>, which is consistent with the specifications.  You do nothing further to check the state of the reader, but I expect that you would find, as I do, that if you perform <em>another</em> read then the first and only character it will transfer is the replacement character you expected.  That is, <strong>you will get exactly the same data from your <code>InputStreamReader</code> / <code>CharsetDecoder</code> combo as you do by other methods if you make sure to read all the data it provides.</strong></p>\n<p>It is not safe to interpret <code>Reader.read(char[])</code> reading fewer characters than the length of the array as an indication that the end of the character stream has been reached.  There are particular cases where that is a reliable test, but also plenty of cases where it isn't.  The best and safest way to now you've reached the end of the data is to observe one of the <code>Reader.read()</code> methods telling you so by returning -1.</p>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1752085737,
    "last_activity_date" : 1752085737,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140577745,
    "post_id" : 79695875,
    "body" : "In a sense, you were right in the first place as the code <i>does</i> use <code>StreamDecoder</code> under the covers",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4243,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1752084323,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577709,
    "post_id" : 79695875,
    "body" : "In that case, the question would be much improved by editing it to remove all the references to <code>StreamDecoder</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1752083314,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577701,
    "post_id" : 79695875,
    "body" : "I&#39;m questioning the behavior of CharsetDecoder when used directly and within a Stream; I guess CharsetDecoder is documented. There is no direct reference to StreamDecoder in the code snippet provided.",
    "score" : 0,
    "owner" : {
      "account_id" : 975767,
      "reputation" : 521,
      "user_id" : 997044,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
      "display_name" : "George",
      "link" : "https://stackoverflow.com/users/997044/george"
    },
    "creation_date" : 1752083155,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577483,
    "post_id" : 79695875,
    "body" : "One should not put expectations on undocumented internal implementations. What are you trying to use this method for?",
    "score" : 1,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1752078031,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577458,
    "post_id" : 79695875,
    "body" : "That actually proves my theory, 69 is a valid character the StreamDecoder considers the byte sequence as complete but invalid hence the replacement happens.",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1752077478,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577405,
    "post_id" : 79695875,
    "body" : "@JorgeCampos it is bit strange , if I replace the last byte with 69 then it has the replacement char. However there is an inconsistency in decoding .",
    "score" : 0,
    "owner" : {
      "account_id" : 975767,
      "reputation" : 521,
      "user_id" : 997044,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
      "display_name" : "George",
      "link" : "https://stackoverflow.com/users/997044/george"
    },
    "creation_date" : 1752076700,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577387,
    "post_id" : 79695875,
    "body" : "<i>I would expect the replacement character \\uFFFD to be applied ...</i> Out of interest, <i>why</i> would you have any expectation of an undocumented class (<code>StreamDecoder</code>)?",
    "score" : 1,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4243,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1752076127,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577376,
    "post_id" : 79695875,
    "body" : "I suspect that this has to do with the StreamDecoder deferring decoding waiting for more bytes (which never come) in that situation it might suppress the replacement because the invalid byte sequence might be considered incomplete",
    "score" : 1,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1752075900,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577356,
    "post_id" : 79695875,
    "body" : "it does throw exception on REPORT..  depending on position of the byte..",
    "score" : 0,
    "owner" : {
      "account_id" : 975767,
      "reputation" : 521,
      "user_id" : 997044,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
      "display_name" : "George",
      "link" : "https://stackoverflow.com/users/997044/george"
    },
    "creation_date" : 1752075435,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140577351,
    "post_id" : 79695875,
    "body" : "Check what happens using: <code>CharsetDecoder charsetDecoderForStrm = charset.newDecoder().onMalformedInput(CodingErrorAction.REPO&zwnj;&#8203;RT).onUnmappableChar&zwnj;&#8203;acter(CodingErrorAct&zwnj;&#8203;ion.REPORT);</code> and check the exceptions if any",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1752075283,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79696097" : [ {
      "comment_id" : 140580922,
      "post_id" : 79696097,
      "body" : "@Holger <i>The description</i> of that bug does not make it clear that it is responsible for the issue described in the earlier comment, but my experimentation and code analysis leads me to think that it is.  But inasmuch as the issue was apparently fixed in or before OpenJDK 21, it&#39;s more or less moot exactly which bug report it corresponds to.",
      "score" : 0,
      "owner" : {
        "account_id" : 2792262,
        "reputation" : 190832,
        "user_id" : 2402272,
        "user_type" : "registered",
        "accept_rate" : 85,
        "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
        "display_name" : "John Bollinger",
        "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
      },
      "creation_date" : 1752179693,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140580018,
      "post_id" : 79696097,
      "body" : "OT somewhat but of the variants of ISO2022JP available to <code>iconv</code> (x-windows-iso2022jp isn&#39;t one of them), it seems to fall over at the third byte",
      "score" : 0,
      "owner" : {
        "account_id" : 22124137,
        "reputation" : 4243,
        "user_id" : 16376827,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
        "display_name" : "g00se",
        "link" : "https://stackoverflow.com/users/16376827/g00se"
      },
      "creation_date" : 1752155933,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140579851,
      "post_id" : 79696097,
      "body" : "@George But that bug is not the problem described in the question",
      "score" : 1,
      "owner" : {
        "account_id" : 3211603,
        "reputation" : 300981,
        "user_id" : 2711488,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name" : "Holger",
        "link" : "https://stackoverflow.com/users/2711488/holger"
      },
      "creation_date" : 1752152354,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140578231,
      "post_id" : 79696097,
      "body" : "@George I would be inclined to agree.  I was about to suggest filing a bug report around your alternative example, but given how old the issue is, it&#39;s not surprising that it was a known one.",
      "score" : 1,
      "owner" : {
        "account_id" : 2792262,
        "reputation" : 190832,
        "user_id" : 2402272,
        "user_type" : "registered",
        "accept_rate" : 85,
        "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
        "display_name" : "John Bollinger",
        "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
      },
      "creation_date" : 1752099186,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140578224,
      "post_id" : 79696097,
      "body" : "I think the reason read() is not working in version prior to Java21 could be due  <a href=\"https://bugs.openjdk.org/browse/JDK-8292043\" rel=\"nofollow noreferrer\">bugs.openjdk.org/browse/JDK-8292043</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 975767,
        "reputation" : 521,
        "user_id" : 997044,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
        "display_name" : "George",
        "link" : "https://stackoverflow.com/users/997044/george"
      },
      "creation_date" : 1752098718,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140578198,
      "post_id" : 79696097,
      "body" : "the result matches CharsetDecoder from Java21 onwards.. any version below it will have a null char instead of replacement char on using read()",
      "score" : 0,
      "owner" : {
        "account_id" : 975767,
        "reputation" : 521,
        "user_id" : 997044,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
        "display_name" : "George",
        "link" : "https://stackoverflow.com/users/997044/george"
      },
      "creation_date" : 1752096892,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140578171,
      "post_id" : 79696097,
      "body" : "try changing the bytes = {27,36,66,124,98,27,40,69,69,69,127,69,127} and use read() with java8.",
      "score" : 0,
      "owner" : {
        "account_id" : 975767,
        "reputation" : 521,
        "user_id" : 997044,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://www.gravatar.com/avatar/bdafb7fe6bbafa401412d5982c7529b8?s=256&d=identicon&r=PG",
        "display_name" : "George",
        "link" : "https://stackoverflow.com/users/997044/george"
      },
      "creation_date" : 1752095965,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}