{
  "question" : {
    "question_id" : 79539930,
    "title" : "Are operations to ImmutableCollection saved to non-final field thread-safe",
    "body" : "<p>If in my class I have a field of type <code>ImmutableMap</code> like:</p>\n<pre class=\"lang-java prettyprint-override\"><code>private ImmutableMap&lt;String, State&gt; states = ImmutableMap.of();\n</code></pre>\n<p>And there is 1 reader thread and 1 writer thread</p>\n<p>Reader reads by calling methods like <code>get</code> on <code>states</code> with no <code>synchronized</code> or any kinds of barriers.</p>\n<p>Writer thread  writes by reassigning <code>states</code> to new variables like <code>states = ImmutableMap.of(...)</code> in a <code>synchronized</code> method (which, as far as I know, provides no guarantee of visibility in the other threads if they have no read memory barriers).</p>\n<p>So the whole thing looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>State read(String key) {\n    return states.get(key);\n}\n\nsynchronized void write(String key, State value) {\n    var hashMap = new HashMap&lt;String, State&gt;();\n    states.forEach(hashMap::put);\n    hashMap.put(key, value);\n    states = ImmutableMap.of(hashMap);\n}\n</code></pre>\n<p>Is it true, that reader, when reading from a field <code>states</code> gets a valid value of <code>states</code>, that existed at one point of the time (linearizability is present)? Can reader thread read some nonsense when reading value of <code>states</code> due to compiler reordering?</p>\n",
    "tags" : [ "java", "immutability", "java-memory-model" ],
    "owner" : {
      "account_id" : 13548667,
      "reputation" : 531,
      "user_id" : 9774145,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-7MuOG6QlKeU/AAAAAAAAAAI/AAAAAAAAAAo/BwiFNcFSBJQ/s256-rj/photo.jpg",
      "display_name" : "blonded04",
      "link" : "https://stackoverflow.com/users/9774145/blonded04"
    },
    "is_answered" : true,
    "view_count" : 75,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743150258,
    "creation_date" : 1743106136,
    "link" : "https://stackoverflow.com/questions/79539930/are-operations-to-immutablecollection-saved-to-non-final-field-thread-safe",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79540878,
    "question_id" : 79539930,
    "body" : "<blockquote>\n<p>Is it true, that reader, when reading from a field states gets a valid value of states, that existed at one point of the time (linearizability is present)? Can reader thread read some nonsense when reading value of states due to compiler reordering?</p>\n</blockquote>\n<p>In your example each read of <code>states</code> has no happens-before ordering with writes to <code>states</code>.<br />\nAccording to the JMM that means every read is allowed to return any of the writes to <code>states</code> that happen anytime during the program execution.<br />\nThis includes writes to <code>states</code> that happen later (in wall-clock time) in the same execution.<br />\nThis also includes <code>null</code> - the default initialization value for <code>states</code>.</p>\n<p>Here's the quote from <a href=\"https://docs.oracle.com/javase/specs/jls/se17/html/jls-17.html#jls-17.4.5\" rel=\"nofollow noreferrer\">the JLS</a>:</p>\n<blockquote>\n<p>Informally, a read r is allowed to see the result of a write w if there is no happens-before ordering to prevent that read.</p>\n</blockquote>\n<p>To sum up:</p>\n<ul>\n<li>linearizability isn't present</li>\n<li>regarding &quot;nonsense&quot; I'd call it limited:\n<ul>\n<li>on the one hand, you don't get undefined behavior like in C\\C++</li>\n<li>on the other hand, the fact that a read is allowed to return any (including future) write to the variable - that alone causes huge amount of weird concurrency bugs in practice.</li>\n</ul>\n</li>\n</ul>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 41040795,
      "reputation" : 36,
      "user_id" : 30090288,
      "user_type" : "unregistered",
      "profile_image" : "https://www.gravatar.com/avatar/6957aab4a6595f5ec94031c2a5b55281?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Андрей",
      "link" : "https://stackoverflow.com/users/30090288/%d0%90%d0%bd%d0%b4%d1%80%d0%b5%d0%b9"
    },
    "creation_date" : 1743150258,
    "last_activity_date" : 1743150258,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140272712,
    "post_id" : 79539930,
    "body" : "With the code as given, there is no guarantee whatsoever that other threads will see the modification of <code>state</code> itself (ever or in a timely fashion).",
    "score" : 1,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1743148366,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271887,
    "post_id" : 79539930,
    "body" : "One solution is to declare <code>state</code> to be <code>volatile</code>.",
    "score" : 1,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1743119940,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271873,
    "post_id" : 79539930,
    "body" : "I think that the short answer is that <code>read</code> will always see a &quot;valid&quot; state snapshot, but that it could be stale.  Nothing in the code (that you showed us) guarantees that the update to the <code>state</code> field in <code>write</code> will be visible in <code>read</code>.",
    "score" : 2,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1743119399,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271734,
    "post_id" : 79539930,
    "body" : "@blonded04 It is still not clear what you are asking or what the problem is. You have to explain what a &quot;valid object&quot; is and what an &quot;invalid object&quot; is (in this/your context).",
    "score" : 0,
    "owner" : {
      "account_id" : 108033,
      "reputation" : 20099,
      "user_id" : 286934,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f16a184d26b72795ff243464d715cffe?s=256&d=identicon&r=PG",
      "display_name" : "Progman",
      "link" : "https://stackoverflow.com/users/286934/progman"
    },
    "creation_date" : 1743114797,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271698,
    "post_id" : 79539930,
    "body" : "@blonded04 read answers",
    "score" : 0,
    "owner" : {
      "account_id" : 3415144,
      "reputation" : 24355,
      "user_id" : 2864275,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f1f73deb5983ac46af2a74732752292e?s=256&d=identicon&r=PG",
      "display_name" : "Iłya Bursov",
      "link" : "https://stackoverflow.com/users/2864275/i%c5%82ya-bursov"
    },
    "creation_date" : 1743113894,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271696,
    "post_id" : 79539930,
    "body" : "@IłyaBursov I&#39;m asking about not atomicity (because afaik it&#39;s present always), but about visibility guarantees",
    "score" : 1,
    "owner" : {
      "account_id" : 13548667,
      "reputation" : 531,
      "user_id" : 9774145,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-7MuOG6QlKeU/AAAAAAAAAAI/AAAAAAAAAAo/BwiFNcFSBJQ/s256-rj/photo.jpg",
      "display_name" : "blonded04",
      "link" : "https://stackoverflow.com/users/9774145/blonded04"
    },
    "creation_date" : 1743113833,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271695,
    "post_id" : 79539930,
    "body" : "I&#39;ve added a code sample, and clarified my question (what am I wondering about), I don&#39;t understand what else can I add to it :(",
    "score" : 0,
    "owner" : {
      "account_id" : 13548667,
      "reputation" : 531,
      "user_id" : 9774145,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-7MuOG6QlKeU/AAAAAAAAAAI/AAAAAAAAAAo/BwiFNcFSBJQ/s256-rj/photo.jpg",
      "display_name" : "blonded04",
      "link" : "https://stackoverflow.com/users/9774145/blonded04"
    },
    "creation_date" : 1743113768,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271693,
    "post_id" : 79539930,
    "body" : "This question is similar to: <a href=\"https://stackoverflow.com/questions/44283378/why-is-reference-assignment-atomic-in-java\">Why is reference assignment atomic in Java?</a>. If you believe it’s different, please <a href=\"https://stackoverflow.com/posts/79539930/edit\">edit</a> the question, make it clear how it’s different and/or how the answers on that question are not helpful for your problem.",
    "score" : 1,
    "owner" : {
      "account_id" : 3415144,
      "reputation" : 24355,
      "user_id" : 2864275,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f1f73deb5983ac46af2a74732752292e?s=256&d=identicon&r=PG",
      "display_name" : "Iłya Bursov",
      "link" : "https://stackoverflow.com/users/2864275/i%c5%82ya-bursov"
    },
    "creation_date" : 1743113727,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271681,
    "post_id" : 79539930,
    "body" : "You might want to check other questions like <a href=\"https://stackoverflow.com/questions/4976668/creating-a-dangling-pointer-in-java\" title=\"creating a dangling pointer in java\">stackoverflow.com/questions/4976668/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 108033,
      "reputation" : 20099,
      "user_id" : 286934,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f16a184d26b72795ff243464d715cffe?s=256&d=identicon&r=PG",
      "display_name" : "Progman",
      "link" : "https://stackoverflow.com/users/286934/progman"
    },
    "creation_date" : 1743113394,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271636,
    "post_id" : 79539930,
    "body" : "It is unclear what you mean or what the problem is. Please <a href=\"https://stackoverflow.com/posts/79539930/edit\">edit</a> your question to include a more detailed description of the problem you have. Also explain what you mean by &quot;valid value&quot; in this context. Specially, what an &quot;<b>invalid</b> value&quot; is in this context (and why it is).",
    "score" : 1,
    "owner" : {
      "account_id" : 108033,
      "reputation" : 20099,
      "user_id" : 286934,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f16a184d26b72795ff243464d715cffe?s=256&d=identicon&r=PG",
      "display_name" : "Progman",
      "link" : "https://stackoverflow.com/users/286934/progman"
    },
    "creation_date" : 1743112027,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}