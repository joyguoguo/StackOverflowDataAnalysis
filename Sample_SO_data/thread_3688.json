{
  "question" : {
    "question_id" : 79531447,
    "title" : "Spring Redis Reactive Implementation with Time To Live TTL set by `spring.cache.redis.time-to-live` property",
    "body" : "<p>I am working on a reactive Spring Boot project using the <code>spring-boot-starter-data-redis-reactive</code> library to integrate Redis as a caching mechanism.</p>\n<p>Before I used <code>org.springframework.cache.CacheManager</code>, but as I use this within a <code>spring-cloud-gateway</code> project and this should be always non-blocking I try to switch to a reactive implementation of redis.</p>\n<p>I want to configure a default Time-to-Live (TTL) for cache entries in Redis, but it seems that the property spring.cache.redis.time-to-live does not work with the reactive Redis configuration (which worked before).</p>\n<p>Here are some details about my setup:</p>\n<ul>\n<li><p>Spring Boot version: 3.4.3</p>\n</li>\n<li><p>Redis library: spring-boot-starter-data-redis-reactive</p>\n</li>\n</ul>\n<p>I tried the following steps:</p>\n<p>Set the TTL property in <code>application.yaml</code>:</p>\n<pre><code>spring:\n cache:\n   redis:\n     time-to-live: 60000 # TTL in milliseconds\n</code></pre>\n<p>and write some key, value like:</p>\n<pre><code>@Component\n@Slf4j\npublic class UserContextReactiveRedisCacheClient implements UserContextCachePort {\n\n    public static final String CACHE_PREFIX = &quot;core-gateway::cacheUserContext::&quot;;\n\n    private final ReactiveRedisOperations&lt;String, String&gt; userContextOperations;\n    \n    public UserContextReactiveRedisCacheClient(\n            final ReactiveRedisOperations&lt;String, String&gt; userContextOperations\n    ) {\n        this.userContextOperations = userContextOperations;\n    }\n\n    /**\n     * Load a context of a user.\n     *\n     * @param ciamId Load user context based on provided ciamId.\n     * @return The User Context.\n     */\n    public Mono&lt;String&gt; loadUserContext(final String ciamId) {\n        log.debug(&quot;Loading from cache user context for ciamId {}.&quot;, ciamId);\n        return userContextOperations.opsForValue().get(CACHE_PREFIX + ciamId);\n    }\n\n    /**\n     * Puts as encoded user context as String in cache if absent.\n     *\n     * @param ciamId The ciamId for the user.\n     * @param encodedUserContext The context as a String to put.\n     * @return A Mono of Boolean representing success of the operation.\n     */\n    public Mono&lt;Boolean&gt; putUserContextIfAbsent(\n            final String ciamId,\n            final String encodedUserContext\n    ) {\n        return userContextOperations.keys(CACHE_PREFIX + ciamId)\n                .collectList()\n                .flatMap(keys -&gt; {\n                    if (keys.isEmpty()) {\n                        log.debug(&quot;Putting into cache user context for ciamId {}.&quot;, ciamId);\n                        return userContextOperations.opsForValue().set(\n                                CACHE_PREFIX + ciamId,\n                                encodedUserContext\n                        );\n                    }\n                    return Mono.just(false);\n                });\n    }\n}\n</code></pre>\n<p>This will provide in a key entry in redis:</p>\n<pre><code>127.0.0.1:6379&gt; TTL &quot;core-gateway::cacheUserContext::f3ac883e-f73f-40d7-b4a0-cd900755ed7d&quot;\n(integer) -1\n</code></pre>\n<p>So the configuration is not working properly which was before.</p>\n<p>I need to set the expiration manually each time I write a key with value to take TTL into account like:</p>\n<pre><code>\n@Component\n@Slf4j\npublic class UserContextReactiveRedisCacheClient implements UserContextCachePort {\n\n    public static final String CACHE_PREFIX = &quot;core-gateway::cacheUserContext::&quot;;\n\n    private final ReactiveRedisOperations&lt;String, String&gt; userContextOperations;\n\n    private Duration expiration;\n\n    public UserContextReactiveRedisCacheClient(\n            final ReactiveRedisOperations&lt;String, String&gt; userContextOperations,\n            @Value(&quot;${spring.cache.redis.time-to-live}&quot;) final Duration expiration\n    ) {\n        this.userContextOperations = userContextOperations;\n        this.expiration = expiration;\n    }\n\n    /**\n     * Load a context of a user.\n     *\n     * @param ciamId Load user context based on provided ciamId.\n     * @return The User Context.\n     */\n    public Mono&lt;String&gt; loadUserContext(final String ciamId) {\n        log.debug(&quot;Loading from cache user context for ciamId {}.&quot;, ciamId);\n        return userContextOperations.opsForValue().get(CACHE_PREFIX + ciamId);\n    }\n\n    /**\n     * Puts as encoded user context as String in cache if absent.\n     *\n     * @param ciamId The ciamId for the user.\n     * @param encodedUserContext The context as a String to put.\n     * @return A Mono of Boolean representing success of the operation.\n     */\n    public Mono&lt;Boolean&gt; putUserContextIfAbsent(\n            final String ciamId,\n            final String encodedUserContext\n    ) {\n        return userContextOperations.keys(CACHE_PREFIX + ciamId)\n                .collectList()\n                .flatMap(keys -&gt; {\n                    if (keys.isEmpty()) {\n                        log.debug(&quot;Putting into cache user context for ciamId {}.&quot;, ciamId);\n                        return userContextOperations.opsForValue().set(\n                                CACHE_PREFIX + ciamId,\n                                encodedUserContext,\n                                expiration\n                        );\n                    }\n                    return Mono.just(false);\n                });\n    }\n}\n\n</code></pre>\n<p>Is there a way to configure this so it only works with the <code>application.yaml</code> configuration?</p>\n<p>Thanks in advance for your help</p>\n",
    "tags" : [ "java", "spring-boot", "redis" ],
    "owner" : {
      "account_id" : 3649667,
      "reputation" : 1369,
      "user_id" : 3042145,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/96e73fa77e0321a0e79fb58e17626bf9?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "kism3t",
      "link" : "https://stackoverflow.com/users/3042145/kism3t"
    },
    "is_answered" : false,
    "view_count" : 127,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1742843813,
    "creation_date" : 1742829358,
    "link" : "https://stackoverflow.com/questions/79531447/spring-redis-reactive-implementation-with-time-to-live-ttl-set-by-spring-cache",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}