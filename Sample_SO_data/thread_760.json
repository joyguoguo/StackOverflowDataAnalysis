{
  "question" : {
    "question_id" : 79774753,
    "title" : "How to make an android app detect on bike activity, calculates total distance in that mode and then stops when on foot is detected?",
    "body" : "<p>I am trying to build a simple Android application that uses activity recognition to detect if the user is riding a bike, it then calculates the total distance covered until it detects if the user is on foot. I have a simple activity with a button labeled &quot;Start&quot; which when clicked toggles to &quot;Stop&quot;, and a TextView control for displaying the total distance covered while in on bicycle mode when user hits stop. I click on Start, hop on my bike and then ride for like 600 meters, I stop and then hit stop, it shows &quot;0.0m covered. I have shared the entire logic of my application below.</p>\n<p><strong>MainActivity.java</strong></p>\n<pre><code> @Override\n    protected void onCreate(@Nullable Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.mainactivity);\n        ensurePermissionsGranted();\n        textView = findViewById(R.id.textView1);\n        button1 = findViewById(R.id.button1);\n        activityRecognitionClient = ActivityRecognition.getClient(this);\n        //prepare the PendingIntent\n        Intent intent = new Intent(this, BikeReceiver.class);\n        activityPendingIntent = PendingIntent.getBroadcast(\n                this,\n                0,\n                intent,\n                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE\n        );\n        button1.setOnClickListener(v -&gt; {\n            String text = button1.getText().toString();\n            if (text.equals(&quot;Start&quot;)) {\n                startTracking();\n                button1.setText(&quot;Stop&quot;);\n            } else {\n                //stop tracking\n                stopTracking();\n                button1.setText(&quot;Start&quot;);\n            }\n        });\n\n\n    }\n</code></pre>\n<p><strong>StartTracking method</strong></p>\n<pre><code>  private void startTracking() {\n        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACTIVITY_RECOGNITION) != PackageManager.PERMISSION_GRANTED) {\n            // TODO: Consider calling\n            //    ActivityCompat#requestPermissions\n            // here to request the missing permissions, and then overriding\n            //   public void onRequestPermissionsResult(int requestCode, String[] permissions,\n            //                                          int[] grantResults)\n            // to handle the case where the user grants the permission. See the documentation\n            // for ActivityCompat#requestPermissions for more details.\n            Toast.makeText(this, &quot;permission to track activity changes is required&quot;, Toast.LENGTH_LONG).show();\n            return;\n        }\n\n        activityRecognitionClient.requestActivityUpdates(\n                5000, // detection interval in ms\n                activityPendingIntent\n        );\n\n    }\n</code></pre>\n<p><strong>Stop Tracking method</strong></p>\n<pre><code> private void stopTracking() {\n        if (ActivityCompat.checkSelfPermission(this, Manifest.permission.ACTIVITY_RECOGNITION) != PackageManager.PERMISSION_GRANTED) {\n            // TODO: Consider calling\n            //    ActivityCompat#requestPermissions\n            // here to request the missing permissions, and then overriding\n            //   public void onRequestPermissionsResult(int requestCode, String[] permissions,\n            //                                          int[] grantResults)\n            // to handle the case where the user grants the permission. See the documentation\n            // for ActivityCompat#requestPermissions for more details.\n            return;\n        }\n        activityRecognitionClient.removeActivityUpdates(activityPendingIntent)\n                .addOnSuccessListener(aVoid -&gt; {\n                    Toast.makeText(this, &quot;Tracking stopped&quot;, Toast.LENGTH_SHORT).show();\n\n                    // Example: display distance\n                    float totalDistance = BikeService.getTotalDistance(); // or SharedPreferences\n                    textView.setText(&quot;Total Distance: &quot; + totalDistance + &quot; m&quot;);\n                })\n                .addOnFailureListener(e -&gt;\n                        Toast.makeText(this, &quot;Failed to stop tracking&quot;, Toast.LENGTH_SHORT).show()\n                );\n    }\n</code></pre>\n<p><strong>Permissions requested from user even on runtime</strong></p>\n<pre><code>manifest\n    package=&quot;com.example.bikedistancetracker&quot;\n    xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;\n    xmlns:tools=&quot;http://schemas.android.com/tools&quot;&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACCESS_COARSE_LOCATION&quot;/&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACCESS_FINE_LOCATION&quot; /&gt;\n    &lt;uses-permission android:name=&quot;android.permission.ACTIVITY_RECOGNITION&quot; /&gt;\n    &lt;application\n        android:allowBackup=&quot;true&quot;\n        android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;\n        android:fullBackupContent=&quot;@xml/backup_rules&quot;\n        android:icon=&quot;@mipmap/ic_launcher&quot;\n        android:label=&quot;@string/app_name&quot;\n        android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;\n        android:supportsRtl=&quot;true&quot;\n        android:theme=&quot;@style/Theme.BikeDistanceTracker&quot; &gt;\n        &lt;receiver android:name=&quot;.BikeReceiver&quot;\n            android:exported=&quot;false&quot;&gt;\n        &lt;/receiver&gt;\n        &lt;activity android:name=&quot;.MainActivity&quot;\n            android:exported=&quot;true&quot;&gt;\n            &lt;intent-filter&gt;\n                &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;\n                &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;\n            &lt;/intent-filter&gt;\n        &lt;/activity&gt;\n\n    &lt;/application&gt;\n&lt;/manifest&gt;\n</code></pre>\n<p><strong>Broadcast Receiver for On Bicycle filters</strong></p>\n<pre><code>public class BikeReceiver extends BroadcastReceiver {\n    @Override\n    public void onReceive(Context context, Intent intent) {\n        int activityType = intent.getIntExtra(&quot;activity_type&quot;, -1);\n\n        if (activityType == DetectedActivity.ON_BICYCLE) {\n            // Start the distance tracking service\n            Intent serviceIntent = new Intent(context, BikeService.class);\n            ContextCompat.startForegroundService(context, serviceIntent);\n        }\n        else if (activityType == DetectedActivity.ON_FOOT) {\n            // Stop the distance tracking service\n            Intent serviceIntent = new Intent(context, BikeService.class);\n            context.stopService(serviceIntent);\n        }\n    }\n};\n</code></pre>\n<p>Where am I going wrong, please help.</p>\n",
    "tags" : [ "java", "android", "android-activity", "location", "gesture-recognition" ],
    "owner" : {
      "account_id" : 15123707,
      "reputation" : 147,
      "user_id" : 30532921,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-6EyKrzo2EUU/AAAAAAAAAAI/AAAAAAAAASM/R-HEOF0Wpjk/s256-rj/photo.jpg",
      "display_name" : "So Few Against So Many",
      "link" : "https://stackoverflow.com/users/30532921/so-few-against-so-many"
    },
    "is_answered" : false,
    "view_count" : 71,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1758838929,
    "creation_date" : 1758799719,
    "link" : "https://stackoverflow.com/questions/79774753/how-to-make-an-android-app-detect-on-bike-activity-calculates-total-distance-in",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}