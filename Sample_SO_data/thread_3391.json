{
  "question" : {
    "question_id" : 79552191,
    "title" : "Cancel running task on separate thread when user clicks on cancel button",
    "body" : "<p>I have implemented an API <code>/transferFile</code> that downloads a file from a server and writes it to a specific location. To ensure the file transfer runs in the separate thread, I am using <code>ExecutorService</code> with a single-thread executor like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>ExecutorService executorService = Executors.newSingleThreadExecutor();\nFuture&gt; future = executorService.submit(() -&gt; {\n    return transferFileMethod(someparameters);\n});\n</code></pre>\n<p>The <code>transferFileMethod</code> looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Map transferFileMethod(someparameters) {\n    // Downloading from server\n    HttpURLConnection urlConnection = (HttpURLConnection) requestUrl.openConnection();\n    InputStream inputStream = urlConnection.getInputStream();\n\n    // Writing to specific location\n    try (BufferedOutputStream fileOutputStream = new BufferedOutputStream(new FileOutputStream(filePath, true))) {\n        byte[] buffer = new byte[4096];\n        int bytesRead;\n        while ((bytesRead = inputStream.read(buffer, 0, 4096)) != -1) {\n            fileOutputStream.write(buffer, 0, bytesRead);\n        }\n    }\n}\n</code></pre>\n<h3>Problem:</h3>\n<p>If the user cancels the API call while the file is being transferred, the background process continues to write the file. I want to stop the file transfer immediately when the user cancels the API call.</p>\n",
    "tags" : [ "java", "multithreading", "future", "executorservice", "file-transfer" ],
    "owner" : {
      "account_id" : 24948833,
      "reputation" : 38,
      "user_id" : 18813886,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GjxwjRYh-IwnRo5O2_ORyqIoeV8x7joTw0qo0XW=k-s256",
      "display_name" : "Amit J.",
      "link" : "https://stackoverflow.com/users/18813886/amit-j"
    },
    "is_answered" : false,
    "view_count" : 80,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743740859,
    "creation_date" : 1743663177,
    "link" : "https://stackoverflow.com/questions/79552191/cancel-running-task-on-separate-thread-when-user-clicks-on-cancel-button",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79552711,
    "question_id" : 79552191,
    "body" : "<p>I have had to add another endpoint to receive the canceled signal, and exit the while, so far, I can't get a <code>SocketException</code> or any other cancel signal.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@RestController\npublic class CancelTestController {\n\n    private Future&lt;?&gt; future;\n    private final AtomicBoolean atomicCancel = new AtomicBoolean(true);\n\n    @GetMapping(value = &quot;/cancel&quot;)\n    public String cancel() {\n        if(future != null) {\n            future.cancel(true);\n            this.atomicCancel.set(false);\n            System.out.println(&quot;inputStream is closed&quot;);\n        }\n        return &quot;cancel&quot;; //dummy response\n    }\n\n    @GetMapping(value = &quot;/download&quot;)\n    public String test() throws ExecutionException, InterruptedException {\n        ExecutorService executorService = Executors.newSingleThreadExecutor();\n        this.future = executorService.submit(() -&gt; {\n            try {\n                this.transferFileMethod();\n                try {\n                    Thread.sleep(5000);\n                } catch (InterruptedException e) {\n                    throw new RuntimeException(e);\n                }\n            } catch (IOException e) {\n                System.out.println(&quot;some error &quot; + e.getMessage());\n            }\n        });\n        return &quot;ok&quot;; //dummy response\n    }\n\n    private void transferFileMethod() throws IOException {\n        this.atomicCancel.set(true);\n        HttpURLConnection urlConnection = (HttpURLConnection) new java.net.URL(&quot;https://filesamples.com/samples/document/txt/sample1.txt&quot;).openConnection();\n        final InputStream inputStream = urlConnection.getInputStream();\n\n        try (BufferedOutputStream fileOutputStream = new BufferedOutputStream(new FileOutputStream(&quot;src/main/resources/sample1.txt&quot;))) {\n\n            byte[] buffer = new byte[4096];\n            int bytesRead;\n            while ((bytesRead = inputStream.read(buffer, 0, 4096)) != -1 &amp;&amp; this.atomicCancel.get()) {\n                fileOutputStream.write(buffer, 0, bytesRead);\n            }\n\n        } catch (IOException ex) {\n            ex.printStackTrace();\n        }\n    }\n\n}\n</code></pre>\n<blockquote>\n<p>The <code>Thread.sleep(...)</code> is for testing purposes only, I should not use it, and I should be able to cancel since it is a fast download in this test of mine.</p>\n</blockquote>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 9808985,
      "reputation" : 194,
      "user_id" : 7267818,
      "user_type" : "registered",
      "accept_rate" : 57,
      "profile_image" : "https://i.sstatic.net/xDbzS.jpg?s=256",
      "display_name" : "0x52",
      "link" : "https://stackoverflow.com/users/7267818/0x52"
    },
    "creation_date" : 1743677299,
    "last_activity_date" : 1743687384,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140302299,
    "post_id" : 79552191,
    "body" : "@user207421 But with the flag and cancel the Future, I see no problems from my side either, and the file cancels the scan correctly and that&#39;s it, just with the code implementation that he has.",
    "score" : 0,
    "owner" : {
      "account_id" : 9808985,
      "reputation" : 194,
      "user_id" : 7267818,
      "user_type" : "registered",
      "accept_rate" : 57,
      "profile_image" : "https://i.sstatic.net/xDbzS.jpg?s=256",
      "display_name" : "0x52",
      "link" : "https://stackoverflow.com/users/7267818/0x52"
    },
    "creation_date" : 1743855255,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140297699,
    "post_id" : 79552191,
    "body" : "<code>java.net</code> sockets are non-interruptible. If you rewrite it all using a <code>SocketChannel</code>, you can interrupt the thread, which will cause the read to throw <code>ClosedByInterruptException</code>. This is better than a flag because it will interrupt the pending read immediately, rather than letting the thread run until the read returns. However you will have to deal with all the HTTP protocol stuff yourself.",
    "score" : 1,
    "owner" : {
      "account_id" : 71739,
      "reputation" : 311869,
      "user_id" : 207421,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=256&d=identicon&r=PG",
      "display_name" : "user207421",
      "link" : "https://stackoverflow.com/users/207421/user207421"
    },
    "creation_date" : 1743741788,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140293411,
    "post_id" : 79552191,
    "body" : "How to determine the flag when user hits cancel? It simply like hitting the api using postman, which starts file transfer process and just after few seconds hitting on cancel button",
    "score" : 0,
    "owner" : {
      "account_id" : 24948833,
      "reputation" : 38,
      "user_id" : 18813886,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GjxwjRYh-IwnRo5O2_ORyqIoeV8x7joTw0qo0XW=k-s256",
      "display_name" : "Amit J.",
      "link" : "https://stackoverflow.com/users/18813886/amit-j"
    },
    "creation_date" : 1743663757,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140293388,
    "post_id" : 79552191,
    "body" : "Add a flag in the while condition that&#39;s set when the user hits cancel?",
    "score" : 0,
    "owner" : {
      "account_id" : 8362430,
      "reputation" : 856,
      "user_id" : 6280255,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/579e86ed5089abcb535b4e05ead3f6f6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Just another Java programmer",
      "link" : "https://stackoverflow.com/users/6280255/just-another-java-programmer"
    },
    "creation_date" : 1743663361,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79552711" : [ {
      "comment_id" : 140833704,
      "post_id" : 79552711,
      "body" : "If you have the future, just call future.cancel(true);",
      "score" : 0,
      "owner" : {
        "user_type" : "does_not_exist",
        "display_name" : "user18179479"
      },
      "creation_date" : 1762179118,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}