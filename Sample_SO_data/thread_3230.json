{
  "question" : {
    "question_id" : 79563142,
    "title" : "Is there a way to exclude certain classes from being picked up by gradle&#39;s jar task?",
    "body" : "<p>I've been developing my own gradle plugin, and I need to skip bundling some classes from the default classes directory and instead bundle mine instead. I managed to &quot;do&quot; this by changing the output directories of source-sets, but this breaks a lot of things in our build chain. Currently, I'm trying to exclude classes if they exist in the modified source set, but they don't seem to be excluded. It's like gradle copies the classes by default any, and then processes my exclude closure.</p>\n<p>I have tried the following:</p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>tasks.named&lt;Jar&gt;(&quot;jar&quot;) {\n    from(sourceSets.main.get().output) {\n        exclude(&quot;*&quot;)\n    }\n}\n</code></pre>\n<p>I have also tried:</p>\n<pre class=\"lang-java prettyprint-override\"><code>jar.from(freshTree, copySpec -&gt; {\n    copySpec.eachFile(file -&gt; {\n        System.out.println(&quot;[CUSTOM] adding: &quot; + file.getRelativePath().getPathString());\n    });\n});\n\njar.from(sourceSet.getOutput(), copySpec -&gt; {\n    copySpec.exclude(details -&gt; {\n        Set&lt;String&gt; altClassNames = freshTree.get().getFiles().stream()\n            .map(file -&gt; {\n                String relative = project.relativePath(file);\n                return relative.replace(File.separatorChar, '/');\n            })\n            .map(str -&gt; {\n                String loc = &quot;build/weaved-classes/java/&quot; + sourceSetName + &quot;/&quot;;\n                int idx = str.indexOf(loc);\n                return idx &gt;= 0 ? str.substring(idx + loc.length()) : str;\n            })\n            .collect(Collectors.toSet());\n\n        String archivePath = details.getRelativePath().getPathString();\n        boolean shouldSkip = altClassNames.contains(archivePath);\n\n        System.out.println((shouldSkip ? &quot;[SOURCESET] skipped: &quot; : &quot;[SOURCESET] included: &quot;) + archivePath);\n\n        return true; // debug purposes, skip all files\n    });\n\n    copySpec.setDuplicatesStrategy(DuplicatesStrategy.EXCLUDE);\n});\n</code></pre>\n<p>Unfortunately, it fails:</p>\n<pre><code>&gt; Task :jar FAILED\n[SOURCESET] included: com\n[SOURCESET] included: main\n[SOURCESET] included: com\n[SOURCESET] included: integration\n[SOURCESET] included: com\n[SOURCESET] included: test\n[CUSTOM] adding: some/package/MyClazz.class\n\n...\n\n&gt; Entry some/package/MyClazz.class is a duplicate but no duplicate handling strategy has been set.\n</code></pre>\n<p>Preferably, I can do this within my gradle plugin.</p>\n<p>EDIT: I have tried using doFirst {} to attempt to configure the inputs before gradle registers the default inputs, but gradle disallows configuration during execution :(</p>\n",
    "tags" : [ "java", "gradle", "gradle-plugin", "gradle-kotlin-dsl" ],
    "owner" : {
      "account_id" : 31346676,
      "reputation" : 43,
      "user_id" : 24896942,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocJiC5HIQgxQe5NHQImT0xO8lEUnJ1CHtEuczqdACTQKiNmQ8g=k-s256",
      "display_name" : "a a",
      "link" : "https://stackoverflow.com/users/24896942/a-a"
    },
    "is_answered" : true,
    "view_count" : 89,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744152098,
    "creation_date" : 1744150244,
    "link" : "https://stackoverflow.com/questions/79563142/is-there-a-way-to-exclude-certain-classes-from-being-picked-up-by-gradles-jar-t",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79563169,
    "question_id" : 79563142,
    "body" : "<p>As @Slaw stated in comments, I can use AbstractCopyTask#exclude. I don't know how I broke that before, but it works now with the following code:</p>\n<pre><code>jar.exclude((fileTreeElem) -&gt; {\n    File theFile = fileTreeElem.getFile();\n\n    if (theFile.getPath().startsWith(customDir.getPath()))\n        return false;\n\n    // ... rest of the code\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 31346676,
      "reputation" : 43,
      "user_id" : 24896942,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocJiC5HIQgxQe5NHQImT0xO8lEUnJ1CHtEuczqdACTQKiNmQ8g=k-s256",
      "display_name" : "a a",
      "link" : "https://stackoverflow.com/users/24896942/a-a"
    },
    "creation_date" : 1744152098,
    "last_activity_date" : 1744152098,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140313888,
    "post_id" : 79563142,
    "body" : "Ah, thank you @Slaw! This works now, I think I messed up previously when I tried to do as such. I&#39;ll mark my post as closed now. Thank you once again!",
    "score" : 0,
    "owner" : {
      "account_id" : 31346676,
      "reputation" : 43,
      "user_id" : 24896942,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocJiC5HIQgxQe5NHQImT0xO8lEUnJ1CHtEuczqdACTQKiNmQ8g=k-s256",
      "display_name" : "a a",
      "link" : "https://stackoverflow.com/users/24896942/a-a"
    },
    "creation_date" : 1744151992,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140313883,
    "post_id" : 79563142,
    "body" : "Include duplicates strategy, try below.  tasks.named&lt;Jar&gt;(&quot;jar&quot;) {     duplicatesStrategy = DuplicatesStrategy.EXCLUDE      // Exclude specific classes from main source set     exclude(&quot;some/package/MyClazz.class&quot;)      // Include your alternative files explicitly     from(&quot;build/weaved-classes/java/main&quot;) }",
    "score" : 0,
    "owner" : {
      "account_id" : 7645025,
      "reputation" : 440,
      "user_id" : 5795975,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-6KwPUS4RnyA/AAAAAAAAAAI/AAAAAAAAC8w/auZqreI45x0/s256-rj/photo.jpg",
      "display_name" : "Vijay",
      "link" : "https://stackoverflow.com/users/5795975/vijay"
    },
    "creation_date" : 1744151752,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140313828,
    "post_id" : 79563142,
    "body" : "The <code>Jar</code> class inherits from <a href=\"https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/AbstractCopyTask.html\" rel=\"nofollow noreferrer\"><code>AbstractCopyTask</code></a> which provides multiple <code>exclude</code> methods. Does using one of those work for you? Though if I&#39;m not mistaken, the exclusion will apply to all sources, not just the specific <code>from</code> source like your first attempt. So you&#39;d probably need to be more specific in your exclude pattern.",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1744150615,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}