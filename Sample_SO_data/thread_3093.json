{
  "question" : {
    "question_id" : 79572483,
    "title" : "Do I need to add &#39;remove&#39; before using threadlocal for each set in my class below?",
    "body" : "<p>Here is a class I wrote myself. Do I need to remove it before each set?</p>\n<pre class=\"lang-java prettyprint-override\"><code>public final class BusinessThreadSession {\n    private static ThreadLocal&lt;String&gt; currentRedisClusterCode = new ThreadLocal&lt;&gt;();\n\n    private BusinessThreadSession() {\n\n    }\n\n    public static void setCurrentRedisClusterCode(String redisClusterCode) {\n        //currentRedisClusterCode.remove();\n        currentRedisClusterCode.set(redisClusterCode);\n    }\n\n    public static String getCurrentRedisClusterCode() {\n        return currentRedisClusterCode.get();\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "thread-local" ],
    "owner" : {
      "account_id" : 3624157,
      "reputation" : 259,
      "user_id" : 3022220,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/aec14702723e6ffc4de7fbaa694bc2b2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Rebecca",
      "link" : "https://stackoverflow.com/users/3022220/rebecca"
    },
    "is_answered" : true,
    "view_count" : 63,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1744613486,
    "creation_date" : 1744612220,
    "link" : "https://stackoverflow.com/questions/79572483/do-i-need-to-add-remove-before-using-threadlocal-for-each-set-in-my-class-belo",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79572505,
    "question_id" : 79572483,
    "body" : "<p>There's no need to call <code>remove</code> before calling <code>set</code>. Calling <code>set</code> will overwrite the previous value, and if that's the only reference to it, it will become eligable for garbage collection.</p>\n<p>Note, however, that you may want to have a way to remove values from your <code>ThreadLocal</code> without setting a new value instead.</p>\n",
    "score" : 3,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2818342,
      "reputation" : 315967,
      "user_id" : 2422776,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2353050223ebecb113741c29458de4b2?s=256&d=identicon&r=PG",
      "display_name" : "Mureinik",
      "link" : "https://stackoverflow.com/users/2422776/mureinik"
    },
    "creation_date" : 1744612990,
    "last_activity_date" : 1744612990,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140331879,
    "post_id" : 79572483,
    "body" : "@Rebecca Why do you think setting <code>null</code> (or any other value) would keep the previous value?",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1744617961,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140331854,
    "post_id" : 79572483,
    "body" : "@MarkRotteveel,Afraid of memory leaks,In addition, calling set(null) to remove the value might keep the reference to this pointer in the map, which can cause memory leak in some scenarios. Using remove is safer to avoid this issue.",
    "score" : 0,
    "owner" : {
      "account_id" : 3624157,
      "reputation" : 259,
      "user_id" : 3022220,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/aec14702723e6ffc4de7fbaa694bc2b2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Rebecca",
      "link" : "https://stackoverflow.com/users/3022220/rebecca"
    },
    "creation_date" : 1744617657,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140331605,
    "post_id" : 79572483,
    "body" : "@Torben You don&#39;t even need to use a search engine, IDEs generally allow you to navigate to the JDK classes and their sources.",
    "score" : 1,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1744613897,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140331594,
    "post_id" : 79572483,
    "body" : "The <a href=\"https://docs.oracle.com/en/java/javase/21/docs/api/java.base/java/lang/ThreadLocal.html#set(T)\" rel=\"nofollow noreferrer\">documentation</a> states <i>&quot;Sets the current thread&#39;s copy of this thread-local variable to the specified value&quot;</i> and <i>&quot;<b>value</b> - the value to be stored in the current thread&#39;s copy of this thread-local.&quot;</i> To me that means it replaces any previous value. If you&#39;d need to remove first, I would expect that to be documented, as that would be a rather odd way of doing things. Why do you think you&#39;d need to remove first?",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1744613595,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140331570,
    "post_id" : 79572483,
    "body" : "No you don&#39;t. You can actually see the source code for ThreadLocal by searching in with your favourite search engine and check what it does beneath the surface.",
    "score" : 0,
    "owner" : {
      "account_id" : 1041463,
      "reputation" : 3917,
      "user_id" : 1047418,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3deab5aa1be96fe145d3103251263523?s=256&d=identicon&r=PG",
      "display_name" : "Torben",
      "link" : "https://stackoverflow.com/users/1047418/torben"
    },
    "creation_date" : 1744612872,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79572505" : [ {
      "comment_id" : 140343405,
      "post_id" : 79572505,
      "body" : "@Rebecca The <i>&quot;<code>this</code> pointer in the map&quot;</i> the author of that blog is referring to is the <code>ThreadLocal</code> itself. So, yes, if you&#39;re never going to use the thread local itself again, then you may want to call <code>remove()</code>, but given it&#39;s static, I guess that is unlikely to become eligible for garbage collection (that would require that the <code>BusinessThreadSession</code> class itself needs to become eligible for garbage collection). And yes, if that specific thread local will never get used again on that thread, you&#39;re wasting a little bit of space (a few bytes) in the thread local map of that thread.",
      "score" : 0,
      "owner" : {
        "account_id" : 213468,
        "reputation" : 110282,
        "user_id" : 466862,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
        "display_name" : "Mark Rotteveel",
        "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
      },
      "creation_date" : 1744872708,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140343322,
      "post_id" : 79572505,
      "body" : "@MarkRotteveel,The web is here:blog.csdn.net/Dongguabai/article/details/121266686",
      "score" : 0,
      "owner" : {
        "account_id" : 3624157,
        "reputation" : 259,
        "user_id" : 3022220,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/aec14702723e6ffc4de7fbaa694bc2b2?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Rebecca",
        "link" : "https://stackoverflow.com/users/3022220/rebecca"
      },
      "creation_date" : 1744870544,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140331888,
      "post_id" : 79572505,
      "body" : "@Rebecca No, it doesn&#39;t do that. You might want to provide a reference for that <i>&quot;The web say&quot;</i>. I guess that source meant it keeps an entry in the map for the thread, while a <code>remove()</code> will remove the entry for the thread from the map entirely (this will make a difference when calling <code>get()</code>  after <code>set(null)</code> vs <code>remove()</code> if your <code>ThreadLocal</code> has an <i>initial value</i>). That is <code>set(null)</code> will have an entry for the thread with the value <code>null</code>, while remove will have no entry for the thread.",
      "score" : 1,
      "owner" : {
        "account_id" : 213468,
        "reputation" : 110282,
        "user_id" : 466862,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
        "display_name" : "Mark Rotteveel",
        "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
      },
      "creation_date" : 1744618118,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140331860,
      "post_id" : 79572505,
      "body" : "The web say:In addition, calling set(null) to remove the value might keep the reference to this pointer in the map, which can cause memory leak in some scenarios. Using remove is safer to avoid this issue.",
      "score" : 0,
      "owner" : {
        "account_id" : 3624157,
        "reputation" : 259,
        "user_id" : 3022220,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/aec14702723e6ffc4de7fbaa694bc2b2?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Rebecca",
        "link" : "https://stackoverflow.com/users/3022220/rebecca"
      },
      "creation_date" : 1744617750,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140331849,
      "post_id" : 79572505,
      "body" : "@Rebecca no - thinks of a ThreadLocal as a map - overwriting a value (with <code>set</code>) means the old value is no longer pointed to, and the garbage collection is free to collect it (again - assuming you aren&#39;t referencing anywhere else in your code)",
      "score" : 0,
      "owner" : {
        "account_id" : 2818342,
        "reputation" : 315967,
        "user_id" : 2422776,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/2353050223ebecb113741c29458de4b2?s=256&d=identicon&r=PG",
        "display_name" : "Mureinik",
        "link" : "https://stackoverflow.com/users/2422776/mureinik"
      },
      "creation_date" : 1744617609,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140331841,
      "post_id" : 79572505,
      "body" : "If the old values are not remove first when setting new values, won&#39;t this cause memory leaks? Especially when the set is not a String but an object.Here is the web:<a href=\"https://blog.csdn.net/Dongguabai/article/details/121266686\" rel=\"nofollow noreferrer\">blog.csdn.net/Dongguabai/article/details/121266686</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 3624157,
        "reputation" : 259,
        "user_id" : 3022220,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/aec14702723e6ffc4de7fbaa694bc2b2?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Rebecca",
        "link" : "https://stackoverflow.com/users/3022220/rebecca"
      },
      "creation_date" : 1744617511,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}