{
  "question" : {
    "question_id" : 79573645,
    "title" : "Integrating Microsoft Entra SSO Saml with Spring Boot",
    "body" : "<p>I am facing some problem with integrating my Entra with my spring boot application for SSO using Saml. My environment is spring boot 3.4.3, Java 17. I have created a user on entra to implement SSO and the login part is working fine but when it is redirected to my application from the reply url, spring security should create the Authentication object with proper values where as I am receiving them as null. I have created customized authentication object using SAMLResponse from the params of request which I validated through debugger is correct but the Saml2AuthenticationToken when created has null values again.</p>\n<p>This is my SAMLController class</p>\n<pre><code>import jakarta.servlet.http.HttpServletRequest;\nimport org.opensaml.saml.saml2.core.Response;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.security.core.Authentication;\nimport org.springframework.security.core.GrantedAuthority;\nimport org.springframework.security.saml2.provider.service.authentication.AbstractSaml2AuthenticationRequest;\nimport org.springframework.security.saml2.provider.service.authentication.Saml2AuthenticationToken;\nimport org.springframework.security.saml2.provider.service.authentication.Saml2AuthenticatedPrincipal;\nimport org.springframework.security.saml2.provider.service.registration.RelyingPartyRegistration;\nimport org.springframework.security.saml2.provider.service.registration.RelyingPartyRegistrationRepository;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.web.bind.annotation.*;\n\nimport java.util.Base64;\nimport java.util.List;\n\n@RestController\n@RequestMapping(&quot;/saml&quot;)\npublic class SamlController {\n\n    @Autowired\n    private RelyingPartyRegistrationRepository repository;\n\n    @PostMapping(&quot;/acs&quot;)\n    public String processSamlResponse(HttpServletRequest request) throws Exception {\n        // Get the SAML Response from the request\n        String samlResponseFromRequest = request.getParameter(&quot;SAMLResponse&quot;);\n\n        if (samlResponseFromRequest == null) {\n            return &quot;No SAML Response received&quot;;\n        }\n\n        // Decode the Base64 encoded SAML response\n        String decodedResponse = new String(Base64.getDecoder().decode(samlResponseFromRequest));\n\n        // Delegate the response parsing and authentication to Spring Security's built-in mechanism\n        // Spring Security will automatically create the Saml2AuthenticationToken\n        Saml2AuthenticationToken token = parseSamlResponse(decodedResponse);\n\n        if (token.getPrincipal() == null) {\n            return &quot;SAML response parsing failed, no principal found.&quot;;\n        }\n\n        // Set the Authentication object in the SecurityContext\n        Authentication authentication = createAuthentication(token);\n        SecurityContextHolder.getContext().setAuthentication(authentication);\n\n        // Process the authentication\n        if (authentication != null) {\n            Saml2AuthenticatedPrincipal principal = (Saml2AuthenticatedPrincipal) authentication.getPrincipal();\n\n            // Get user details from the principal\n            String name = principal.getName();\n            List&lt;Object&gt; emailList = principal.getAttributes().get(&quot;email&quot;);\n            String email = (emailList != null &amp;&amp; !emailList.isEmpty()) ? emailList.get(0).toString() : &quot;Email not found&quot;;\n\n            System.out.println(&quot;Authenticated User: &quot; + name + &quot;, Email: &quot; + email);\n\n            return &quot;SAML authentication successful for: &quot; + name + &quot;, Email: &quot; + email;\n        } else {\n            return &quot;Authentication failed or incorrect SAML response.&quot;;\n        }\n    }\n\n    private Saml2AuthenticationToken parseSamlResponse(String samlResponse) throws Exception {\n        // Spring Security automatically parses the SAML response and creates a Saml2AuthenticationToken\n        // The token will have the principal and authorities populated if the response is valid\n        Saml2AuthenticationToken token = new Saml2AuthenticationToken(repository.findByRegistrationId(&quot;microsoft&quot;), samlResponse);\n\n        // Spring Security's internal filters should handle the population of the principal and authorities\n        return token;\n       // return OpenSamlUtils.parseResponse(samlResponse);\n    }\n\n    private Authentication createAuthentication(Saml2AuthenticationToken token) {\n        if (token == null || token.getPrincipal() == null) {\n            return null;\n        }\n\n        // Create the authentication object with the user's principal and authorities\n        List&lt;GrantedAuthority&gt; authorities = token.getAuthorities().stream().toList();\n\n        return new Saml2AuthenticationToken(\n                (RelyingPartyRegistration) token.getPrincipal(),\n                (String) token.getCredentials(),\n                (AbstractSaml2AuthenticationRequest) authorities\n        );\n    }\n}\n</code></pre>\n<p>Here is my Security Config</p>\n<pre><code>\nimport org.cryptacular.io.ClassPathResource;\nimport org.opensaml.security.x509.X509Credential;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.Customizer;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.saml2.provider.service.registration.*;\nimport org.springframework.security.web.SecurityFilterChain;\n\nimport java.io.FileInputStream;\nimport java.io.InputStream;\nimport java.security.cert.CertificateFactory;\nimport java.security.cert.X509Certificate;\n\n@Configuration\n@EnableWebSecurity\npublic class SecurityConfig {\n\n    public static final String IDP_METADATA_URL = &quot;my idp metadata url&quot;;\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(csrf -&gt; csrf\n                        .ignoringRequestMatchers(&quot;/saml/acs&quot;, &quot;/saml/metadata&quot;, &quot;/saml/testing&quot;) // Disable CSRF for SAML endpoints\n                )\n                .authorizeHttpRequests(auth -&gt; auth\n                        .requestMatchers(&quot;/saml/testing&quot; ,&quot;/saml/acs&quot;, &quot;/saml/metadata&quot;, &quot;/saml/metadata/**&quot;, &quot;/error&quot;).permitAll()\n                        .anyRequest().authenticated()\n                )\n                .saml2Login(Customizer.withDefaults())\n                .logout(Customizer.withDefaults());\n\n        http.cors(AbstractHttpConfigurer::disable);\n\n        return http.build();\n    }\n\n\n    @Bean\n    public RelyingPartyRegistrationRepository relyingPartyRegistrationRepository() {\n        RelyingPartyRegistration registration = RelyingPartyRegistrations\n                .fromMetadataLocation(IDP_METADATA_URL)  // Ensure this is correct\n                .registrationId(&quot;microsoft&quot;)\n                .entityId(&quot;my idp url&quot;)\n                .assertionConsumerServiceLocation(&quot;http://localhost:8080/saml/acs&quot;)\n\n                .assertionConsumerServiceBinding(Saml2MessageBinding.POST)\n                .build();\n\n        return new InMemoryRelyingPartyRegistrationRepository(registration);\n    }\n\n\n    @Bean\n    public AuthenticationManager authenticationManager(HttpSecurity http) throws Exception {\n        return http.getSharedObject(AuthenticationManagerBuilder.class).build();\n    }\n\n}\n\n</code></pre>\n<p>Here is my pom dependencies</p>\n<pre><code>&lt;dependencies&gt;\n        &lt;!-- Spring Boot Starter Security for basic authentication and security features --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n\n\n\n        &lt;!-- Spring Boot Starter Web for building web applications --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;!-- Spring Boot Starter Test for testing purposes --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n        &lt;!-- Spring Security Test for security-related tests --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-saml2-service-provider&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.opensaml&lt;/groupId&gt;\n            &lt;artifactId&gt;opensaml-core&lt;/artifactId&gt;\n            &lt;version&gt;4.0.1&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.opensaml&lt;/groupId&gt;\n            &lt;artifactId&gt;opensaml-saml-api&lt;/artifactId&gt;\n            &lt;version&gt;4.0.1&lt;/version&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.opensaml&lt;/groupId&gt;\n            &lt;artifactId&gt;opensaml-saml-impl&lt;/artifactId&gt;\n            &lt;version&gt;4.0.1&lt;/version&gt;\n        &lt;/dependency&gt;\n\n    &lt;/dependencies&gt;\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "spring-security", "saml-2.0", "microsoft-entra-id" ],
    "owner" : {
      "account_id" : 41396648,
      "reputation" : 1,
      "user_id" : 30269493,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9bc75c36fb1ba6e006b19dad5829915b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Michael",
      "link" : "https://stackoverflow.com/users/30269493/michael"
    },
    "is_answered" : false,
    "view_count" : 288,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1744648956,
    "creation_date" : 1744648956,
    "link" : "https://stackoverflow.com/questions/79573645/integrating-microsoft-entra-sso-saml-with-spring-boot",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}