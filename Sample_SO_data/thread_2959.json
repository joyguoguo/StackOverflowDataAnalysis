{
  "question" : {
    "question_id" : 79582447,
    "title" : "View created fine before, now fails every time on Postgres using Liquibase",
    "body" : "<p>This is the view:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>SELECT DISTINCT d.comic_book_id   as comic_book_id,\n                            d.comic_detail_id as comic_detail_id,\n                            d.archive_type    as archive_type,\n                            d.comic_state     as comic_state,\n                            CASE\n                                WHEN EXISTS(SELECT *\n                                            FROM comic_metadata_sources s\n                                            WHERE s.comic_book_id = d.comic_book_id)\n                                    THEN false\n                                ELSE true END AS is_unscraped,\n                            d.comic_type      as comic_type,\n                            d.publisher       as publisher,\n                            d.series          as series,\n                            d.volume          as volume,\n                            d.issue_number    as issue_number,\n                            d.description     as description,\n                            d.notes           as notes,\n                            (SELECT RIGHT(CONCAT('0000000000', d.issue_number), 10)) as sortable_issue_number, d.title as title, (\n            SELECT COUNT(*)\n            FROM comic_pages cp\n            WHERE cp.comic_book_id = d.comic_book_id) as page_count\n                , d.cover_date as cover_date\n                , CASE WHEN d.cover_date IS NULL THEN 0 ELSE MONTH (cover_date)\n            END\n            as month_published\n                    , CASE WHEN d.cover_date IS NULL THEN 0 ELSE YEAR (cover_date)\n            END\n            as year_published,\n                            d.store_date as store_date,\n                            d.added_date as added_date\n            FROM comic_details d\n</code></pre>\n<p>In v2 of our project, this view created and worked just fine.</p>\n<p>I'm currently working on v3 of the project, and part of the requirement is to provide a new set of migrations to let users create the tables from scratch and have them look identical to what an existing user would get. So I copied the contents of the view from our v2 codebase into the migration for v3.</p>\n<p>When I run the migration on all other supported databases (H2, MySQL, Mariadb) it, and all related operations, works fine.</p>\n<p>But, when I run it on Postgres, it errors out with:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Caused by: org.postgresql.util.PSQLException: ERROR: function month(date) does not exist\n  Hint: No function matches the given name and argument types. You might need to add explicit type casts.\n</code></pre>\n<p>But, when I go back to our v2 code and run <strong>the exact same Liquibase migration content</strong> it works just fine, no problems. I even copied the body of the old migration into the new one and it <strong>fails</strong>. But the old code still works on the same Postgres instance and creates a working view.</p>\n<p>I tried replacing the call to <code>month()</code> and <code>year()</code> with:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>THEN SELECT EXTRACT(MONTH FROM cover_date)\n</code></pre>\n<p>and:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>THEN SELECT EXTRACT(YEAR FROM cover_date)\n</code></pre>\n<p>The view gets created fine then, but the runtime replaces them with a call to <code>MONTH()</code> and <code>YEAR()</code> respectively and Postgres again gives the same error message.</p>\n<p>Another difference between our v2 and v3 code is that v3 is that we migrated from Spring Boot 3.2.3 to 3.4.1. I'm not sure if the Liquibase version changed between them, but could there be some kind of bug in the newer LB version? I'm assuming Spring bumped it to a newer version.</p>\n",
    "tags" : [ "java", "postgresql", "view", "migration", "liquibase" ],
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "is_answered" : true,
    "view_count" : 106,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1745324762,
    "creation_date" : 1745069493,
    "link" : "https://stackoverflow.com/questions/79582447/view-created-fine-before-now-fails-every-time-on-postgres-using-liquibase",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79583652,
    "question_id" : 79582447,
    "body" : "<p>Ultimately I modified the view to use:</p>\n<pre><code>EXTRACT(month from cover_date)\n</code></pre>\n<p>And found that one of the classes had an instance variable that uses was annotated with a formula that was also using the month() function. Updating that to use the above fixed all the issues.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "creation_date" : 1745174660,
    "last_activity_date" : 1745265887,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79585256,
    "question_id" : 79582447,
    "body" : "<p>IN response to @Adrian, the following is taken directly from a running instance of our v2 release that uses a Postgres server:</p>\n<pre><code>comixed=# \\d+ displayable_comics_view\n                                  View &quot;public.displayable_comics_view&quot;\n        Column         |          Type          | Collation | Nullable | Default | Storage  | Description\n-----------------------+------------------------+-----------+----------+---------+----------+-------------\n comic_book_id         | bigint                 |           |          |         | plain    |\n comic_detail_id       | bigint                 |           |          |         | plain    |\n archive_type          | character varying(4)   |           |          |         | extended |\n comic_state           | character varying(64)  |           |          |         | extended |\n is_unscraped          | boolean                |           |          |         | plain    |\n comic_type            | character varying(32)  |           |          |         | extended |\n publisher             | character varying(255) |           |          |         | extended |\n series                | character varying(255) |           |          |         | extended |\n volume                | character varying(4)   |           |          |         | extended |\n issue_number          | character varying(16)  |           |          |         | extended |\n sortable_issue_number | text                   |           |          |         | extended |\n title                 | character varying(255) |           |          |         | extended |\n page_count            | bigint                 |           |          |         | plain    |\n cover_date            | date                   |           |          |         | plain    |\n month_published       | integer                |           |          |         | plain    |\n year_published        | integer                |           |          |         | plain    |\n store_date            | date                   |           |          |         | plain    |\n added_date            | date                   |           |          |         | plain    |\nView definition:\n SELECT DISTINCT d.comic_book_id,\n    d.id AS comic_detail_id,\n    d.archive_type,\n    d.comic_state,\n        CASE\n            WHEN (EXISTS ( SELECT s.id,\n                s.comic_book_id,\n                s.metadata_source_id,\n                s.reference_id\n               FROM comic_metadata_sources s\n              WHERE s.comic_book_id = d.comic_book_id)) THEN false\n            ELSE true\n        END AS is_unscraped,\n    d.comic_type,\n    d.publisher,\n    d.series,\n    d.volume,\n    d.issue_number,\n    ( SELECT &quot;right&quot;(concat('0000000000', d.issue_number), 10) AS &quot;right&quot;) AS sortable_issue_number,\n    d.title,\n    ( SELECT count(*) AS count\n           FROM comic_pages cp\n          WHERE cp.comic_book_id = d.comic_book_id) AS page_count,\n    d.cover_date,\n        CASE\n            WHEN d.cover_date IS NULL THEN 0\n            ELSE month(d.cover_date)\n        END AS month_published,\n        CASE\n            WHEN d.cover_date IS NULL THEN 0\n            ELSE year(d.cover_date)\n        END AS year_published,\n    d.store_date,\n    d.added_date\n   FROM comic_details d;\n\n\n\ncomixed=# select * from displayable_comics_view limit 5;\n comic_book_id | comic_detail_id | archive_type | comic_state | is_unscraped | comic_type | publisher |          series          | volume | issue_number | sortable_issue_number |               title               | page_count | cover_date | month_published | year_published | store_date | added_date\n---------------+-----------------+--------------+-------------+--------------+------------+-----------+--------------------------+--------+--------------+-----------------------+-----------------------------------+------------+------------+-----------------+----------------+------------+------------\n         34944 |           34944 | CBZ          | STABLE      | f            | ISSUE      | Ablaze    | Lovecraft Unknown Kadath | 2022   | 1            | 0000000001            | Episode 1: Dylath-Leen            |         36 | 2022-09-13 |               9 |           2022 | 2022-09-13 | 2025-03-08\n         34945 |           34945 | CBZ          | STABLE      | f            | ISSUE      | Ablaze    | Lovecraft Unknown Kadath | 2022   | 2            | 0000000002            | Episode 2: Mount Ngranek          |         35 | 2022-10-29 |              10 |           2022 | 2022-10-25 | 2025-03-08\n         34946 |           34946 | CBZ          | STABLE      | f            | ISSUE      | Ablaze    | Lovecraft Unknown Kadath | 2022   | 3            | 0000000003            | Episode 3: In the Valley of Pnoth |         34 | 2022-11-24 |              11 |           2022 | 2022-11-22 | 2025-03-08\n         34947 |           34947 | CBZ          | STABLE      | f            | ISSUE      | Ablaze    | Lovecraft Unknown Kadath | 2022   | 4            | 0000000004            | Episode 4: The Tower of Koth      |         36 | 2022-12-15 |              12 |           2022 | 2022-12-13 | 2025-03-08\n         34948 |           34948 | CBZ          | STABLE      | f            | ISSUE      | Ablaze    | Lovecraft Unknown Kadath | 2022   | 5            | 0000000005            | Episode 5: Celephais              |         36 | 2023-01-23 |               1 |           2023 | 2023-01-24 | 2025-03-08\n(5 rows)\n</code></pre>\n<p>If Postgres doesn't have a month() or year() method, then how do the above work?</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "creation_date" : 1745266094,
    "last_activity_date" : 1745266094,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140361283,
    "post_id" : 79582447,
    "body" : "Nothing in our domain objects changed, other than renaming the primary key columns for each table from &quot;id&quot; to &quot;$TABLE_NAME_id&quot;.",
    "score" : 0,
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "creation_date" : 1745410616,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140355667,
    "post_id" : 79582447,
    "body" : "<i>... we migrated from Spring Boot 3.2.3 to 3.4.1.</i>? Something changed in how the mapping was done for this sort of conversion?",
    "score" : 0,
    "owner" : {
      "account_id" : 9513375,
      "reputation" : 20363,
      "user_id" : 7070613,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
      "display_name" : "Adrian Klaver",
      "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
    },
    "creation_date" : 1745266350,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140355658,
    "post_id" : 79582447,
    "body" : "Not arguing with you, but can you explain then why the above worked for seven years on Postgres servers prior to this release?",
    "score" : 0,
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "creation_date" : 1745265996,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140352900,
    "post_id" : 79582447,
    "body" : "There are no <code>month</code> or <code>year</code>  functions in Postgres, see <a href=\"https://www.postgresql.org/docs/current/functions-datetime.html\" rel=\"nofollow noreferrer\">Datetime functions</a>. For further confirmation use <code>psql</code> and do <code>select month(current_date);</code>, you will get: <code>ERROR:  function month(date) does not exist</code>.  <code>extract</code> or <code>date_part</code> are your options.",
    "score" : 0,
    "owner" : {
      "account_id" : 9513375,
      "reputation" : 20363,
      "user_id" : 7070613,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
      "display_name" : "Adrian Klaver",
      "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
    },
    "creation_date" : 1745177503,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140352830,
    "post_id" : 79582447,
    "body" : "There’s definitely a month function or equivalent in Postgres since that code was in the project for the past seven years and worked. Not sure what changed between the PG jar file between versions in the Spring Boot upgrade but it’s working now.",
    "score" : 0,
    "owner" : {
      "account_id" : 176410,
      "reputation" : 320,
      "user_id" : 407088,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
      "display_name" : "mcpierce",
      "link" : "https://stackoverflow.com/users/407088/mcpierce"
    },
    "creation_date" : 1745174760,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140350649,
    "post_id" : 79582447,
    "body" : "Also can you elaborate on &#39;... but the runtime replaces ...&#39; means? Add as text update to question text.",
    "score" : 0,
    "owner" : {
      "account_id" : 9513375,
      "reputation" : 20363,
      "user_id" : 7070613,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
      "display_name" : "Adrian Klaver",
      "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
    },
    "creation_date" : 1745075995,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140350624,
    "post_id" : 79582447,
    "body" : "There is no <code>month()</code> and <code>year()</code> functions in Postgres, that is a SQL Server, MySQL thing. I&#39;m going to say this is a Liquibase issue.",
    "score" : 0,
    "owner" : {
      "account_id" : 9513375,
      "reputation" : 20363,
      "user_id" : 7070613,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
      "display_name" : "Adrian Klaver",
      "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
    },
    "creation_date" : 1745075330,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79585256" : [ {
      "comment_id" : 140370247,
      "post_id" : 79585256,
      "body" : "I&#39;m not going to continue the conversation. I appreciate your interest, but I&#39;ve solved the problem I was having and am moving on. Peace out!",
      "score" : 0,
      "owner" : {
        "account_id" : 176410,
        "reputation" : 320,
        "user_id" : 407088,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
        "display_name" : "mcpierce",
        "link" : "https://stackoverflow.com/users/407088/mcpierce"
      },
      "creation_date" : 1745605893,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140366485,
      "post_id" : 79585256,
      "body" : "1) You need to show the output of <code>\\df+ *.year</code>, I am looking for where it is was created. 2) Looks like some(one/thing) created a user defined function as a compatibility layer.",
      "score" : 0,
      "owner" : {
        "account_id" : 9513375,
        "reputation" : 20363,
        "user_id" : 7070613,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
        "display_name" : "Adrian Klaver",
        "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
      },
      "creation_date" : 1745515062,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140366473,
      "post_id" : 79585256,
      "body" : "Pulled out the guts of \\df+ *.year:  declare the_month int; begin                            select date_part(&#39;year&#39;, source) into the_month;                  return the_month; end;",
      "score" : 0,
      "owner" : {
        "account_id" : 176410,
        "reputation" : 320,
        "user_id" : 407088,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
        "display_name" : "mcpierce",
        "link" : "https://stackoverflow.com/users/407088/mcpierce"
      },
      "creation_date" : 1745514867,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140366468,
      "post_id" : 79585256,
      "body" : "What does <code>\\df+ *.year</code> show? Also where did you install Postgres from?",
      "score" : 0,
      "owner" : {
        "account_id" : 9513375,
        "reputation" : 20363,
        "user_id" : 7070613,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
        "display_name" : "Adrian Klaver",
        "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
      },
      "creation_date" : 1745514817,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140366460,
      "post_id" : 79585256,
      "body" : "comixed=# select version();                           version ------------------------------------------------------------  PostgreSQL 15.4, compiled by Visual C++ build 1914, 64-bit (1 row)",
      "score" : 0,
      "owner" : {
        "account_id" : 176410,
        "reputation" : 320,
        "user_id" : 407088,
        "user_type" : "registered",
        "accept_rate" : 75,
        "profile_image" : "https://www.gravatar.com/avatar/4a8632084a26acb9c096afd674ad773d?s=256&d=identicon&r=PG",
        "display_name" : "mcpierce",
        "link" : "https://stackoverflow.com/users/407088/mcpierce"
      },
      "creation_date" : 1745514640,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140361992,
      "post_id" : 79585256,
      "body" : "Also what does <code>select version()</code> return?",
      "score" : 0,
      "owner" : {
        "account_id" : 9513375,
        "reputation" : 20363,
        "user_id" : 7070613,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
        "display_name" : "Adrian Klaver",
        "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
      },
      "creation_date" : 1745421035,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140361966,
      "post_id" : 79585256,
      "body" : "1) Something is adding <code>year()</code> and <code>month()</code>, where something could be an extension or a fork of Postgres.  In the community version of Postgres there is no <code>year()</code> or <code>month()</code>. In <code>psql</code> do <code>\\df+ *.year</code> and see what it returns. 2) If the above is true then how did you get the error?: <i>... function month(date) does not exist ...</i> .",
      "score" : 0,
      "owner" : {
        "account_id" : 9513375,
        "reputation" : 20363,
        "user_id" : 7070613,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/iZQNZ.jpg?s=256",
        "display_name" : "Adrian Klaver",
        "link" : "https://stackoverflow.com/users/7070613/adrian-klaver"
      },
      "creation_date" : 1745420715,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}