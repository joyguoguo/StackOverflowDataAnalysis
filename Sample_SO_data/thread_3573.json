{
  "question" : {
    "question_id" : 79539718,
    "title" : "Cannot inject already loaded type: class",
    "body" : "<p>I have deployed the spring boot application with 6 k8 pods for first time not faced any issue. but once redeployed it giving below error. 500 concurrent requests. out of those 23 requests failed.</p>\n<pre><code>Generic event exception: Error creating event class: Cannot inject already loaded type: class com.kafka.events.DynamicSampleEvent\n</code></pre>\n<p>on local i tried stress test with 500 sequential request but it have not failed.</p>\n<p>added caching layer as well</p>\n<pre><code>eventClassCache = new LinkedHashMap&lt;&gt;(100, 0.75f, true) {\n            protected boolean removeEldestEntry(Map.Entry&lt;String, Class&lt;? extends KafkaPublishEvent&lt;Object&gt;&gt;&gt; eldest) {\n                return size() &gt; 100;\n            }\n        };\n</code></pre>\n<pre><code>private Class&lt;? extends KafkaPublishEvent&lt;Object&gt;&gt; generateEventClass(String eventType) {\n        String sanitizedEventType = eventType.replaceAll(&quot;[^a-zA-Z0-9_.]&quot;, &quot;&quot;);\n        try (DynamicType.Unloaded&lt;KafkaPublishEvent&gt; unloadedType = new ByteBuddy()\n                .subclass(KafkaPublishEvent.class)\n                .name(&quot;com.kafka.events.Dynamic&quot; + sanitizedEventType + &quot;Event&quot;)\n                .make()) {\n            return (Class&lt;? extends KafkaPublishEvent&lt;Object&gt;&gt;) unloadedType\n                    .load(getClass().getClassLoader(), ClassLoadingStrategy.Default.INJECTION)\n                    .getLoaded();\n        } catch (Exception e) {\n            throw new EventGenerationException(ERR_0033, &quot;Error creating event class: &quot; + e.getMessage());\n        }\n    }\n</code></pre>\n<p>is there any problem with <code>ClassLoadingStrategy</code> ?</p>\n",
    "tags" : [ "java", "spring-boot", "byte-buddy" ],
    "owner" : {
      "account_id" : 10627664,
      "reputation" : 71,
      "user_id" : 7826848,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/suMvt.jpg?s=256",
      "display_name" : "ShubhamK",
      "link" : "https://stackoverflow.com/users/7826848/shubhamk"
    },
    "is_answered" : false,
    "view_count" : 38,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743099303,
    "creation_date" : 1743099303,
    "link" : "https://stackoverflow.com/questions/79539718/cannot-inject-already-loaded-type-class",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140271069,
    "post_id" : 79539718,
    "body" : "Also, this is not thread safe. So should be synchronized.",
    "score" : 0,
    "owner" : {
      "account_id" : 1601399,
      "reputation" : 638,
      "user_id" : 1482356,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d6160b6e40d230fa92c6da8072b2f7e5?s=256&d=identicon&r=PG",
      "display_name" : "Peter Adrian",
      "link" : "https://stackoverflow.com/users/1482356/peter-adrian"
    },
    "creation_date" : 1743100125,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140271066,
    "post_id" : 79539718,
    "body" : "Bytebudy creates a class and adds it into the classloader. It will only work once per event type. Try to see it the class already exists, using Class.forName(&quot;com.kafka.events.Dynamic&quot; + sanitizedEventType + &quot;Event&quot;) before trying to create it.",
    "score" : 0,
    "owner" : {
      "account_id" : 1601399,
      "reputation" : 638,
      "user_id" : 1482356,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d6160b6e40d230fa92c6da8072b2f7e5?s=256&d=identicon&r=PG",
      "display_name" : "Peter Adrian",
      "link" : "https://stackoverflow.com/users/1482356/peter-adrian"
    },
    "creation_date" : 1743100066,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}