{
  "question" : {
    "question_id" : 79831984,
    "title" : "HTTP-403 when authentication in spring authentication server after /login in spring cloud gateway",
    "body" : "<p>I trying to setup cooperation of gateway and authorization server.</p>\n<p>help me to find error in the program, when i authenticate me and enter to web authentication form username=<code>admin</code> and password=<code>1</code> i getting http error code <code>403</code> - forbidden and browser shows web page with words 'Access denied'. The project consists two maven modules: <code>spring cloud gateway and spring authorization server</code></p>\n<p>authorization server returns the <code>authorization code</code> when i put link <a href=\"http://localhost:9000/oauth2/authorize?response_type=code&amp;client_id=gateway&amp;redirect_uri=http://localhost:8080/\" rel=\"nofollow noreferrer\">http://localhost:9000/oauth2/authorize?response_type=code&amp;client_id=gateway&amp;redirect_uri=http://localhost:8080/</a> to the browser. And returns <code>access_token</code> when i execute code:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>curl -X POST 'http://localhost:9000/oauth2/token' \\\n--header &quot;Authorization: Basic Z2F0...&quot; \\\n--header &quot;Content-Type: application/x-www-form-urlencoded&quot; \\\n-d &quot;client_id=gateway&quot; \\\n-d &quot;redirect_uri=http://localhost:8080/&quot; \\\n-d &quot;grant_type=authorization_code&quot; \\\n-d &quot;code=EHZl1xZY7WNF0hNzcWbA8jgBYzlAoQWphmBUEaZLUE2VAw0hDIDB4A-E6emLZl_rK3tRm8HCEYRb8vvAKvc9NVACQnFJ6RO3Yeo19O9ibyFtU2gYmn3BJKgM0zep6CF9&quot;\n</code></pre>\n<p>but when i trying to authenticate through localhost:8080/login i get <code>403</code> in <code>Network</code>. Authorizations server has empty log and gateway shows :</p>\n<p>No RouteDefinition found for [Exchange: GET http://localhost:8080/favicon.ico]</p>\n<p>Another glitch - when i follow the link with localhost:8080 - <a href=\"http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=gateway&amp;redirect_uri=http://localhost:8080/\" rel=\"nofollow noreferrer\">http://localhost:8080/oauth2/authorize?response_type=code&amp;client_id=gateway&amp;redirect_uri=http://localhost:8080/</a> browser redirects to localhost:9000/login</p>\n<pre class=\"lang-java prettyprint-override\"><code>//Auth2CloudGatewayApplication.java\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class Auth2CloudGatewayApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(Auth2CloudGatewayApplication.class, args);\n    }\n\n}\n//GatewaySecurityConfig.java\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;\nimport org.springframework.security.config.web.server.ServerHttpSecurity;\nimport org.springframework.security.oauth2.core.DelegatingOAuth2TokenValidator;\nimport org.springframework.security.oauth2.core.OAuth2TokenValidator;\nimport org.springframework.security.oauth2.jwt.Jwt;\nimport org.springframework.security.oauth2.jwt.JwtValidators;\nimport org.springframework.security.oauth2.jwt.NimbusReactiveJwtDecoder;\nimport org.springframework.security.oauth2.jwt.ReactiveJwtDecoder;\nimport org.springframework.security.web.server.SecurityWebFilterChain;\nimport org.springframework.security.web.server.context.NoOpServerSecurityContextRepository;\n\nimport static org.springframework.security.config.Customizer.withDefaults;\n\n@Configuration\n@EnableWebFluxSecurity\npublic class GatewaySecurityConfig {\n    @Value(&quot;${provider.issuer-uri}/oauth2/jwks&quot;)\n    private String jwkSetUri;\n    @Value(&quot;${provider.issuer-uri}&quot;)\n    private String issuerUri;\n    @Bean\n    SecurityWebFilterChain defaultSecurityFilterChain(ServerHttpSecurity http) throws Exception {\n        http.securityContextRepository(NoOpServerSecurityContextRepository.getInstance())\n                .authorizeExchange(exchanges -&gt; {\n                    exchanges.pathMatchers(&quot;/login&quot;).permitAll();\n                    exchanges.pathMatchers(&quot;/oauth2/**&quot;).permitAll();\n                    exchanges.pathMatchers(&quot;/index.html&quot;).permitAll();\n                    exchanges.pathMatchers(&quot;/favicon.ico&quot;).permitAll();\n                    exchanges.pathMatchers(&quot;/assets/**&quot;).permitAll();\n                    exchanges.pathMatchers(&quot;/**&quot;).permitAll();\n                    exchanges.anyExchange().authenticated();\n                })\n                .oauth2ResourceServer(oauth2 -&gt; oauth2\n                        .jwt(\n                                withDefaults())\n                );\n        return http.build();\n    }\n\n    @Bean\n    public ReactiveJwtDecoder jwtDecoder() {\n        NimbusReactiveJwtDecoder jwtDecoder= NimbusReactiveJwtDecoder.withJwkSetUri(jwkSetUri).build();\n        OAuth2TokenValidator&lt;Jwt&gt; withIssuer = JwtValidators.createDefaultWithIssuer(issuerUri);\n        jwtDecoder.setJwtValidator(  new DelegatingOAuth2TokenValidator&lt;&gt;(withIssuer));//, withOperation)  );\n        return jwtDecoder;\n    }\n}\n//GatewayRoutesConfig.java\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.cloud.gateway.route.builder.RouteLocatorBuilder;\nimport org.springframework.cloud.gateway.route.RouteLocator;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\n\npublic class GatewayRoutesConfig {\n    @Value(&quot;${provider.issuer-uri}&quot;)\n    String authorization_server;\n    @Bean\n    public RouteLocator gatewayRoutes(RouteLocatorBuilder routeLocatorBuilder)\n    {\n            return routeLocatorBuilder.routes()\n                    .route(&quot;login_page&quot;, rt -&gt; rt.path(&quot;/login/**&quot;)\n                            .filters(f -&gt; f.removeRequestHeader(&quot;Cookie&quot;)\n                                    .removeRequestHeader(&quot;Set-Cookie&quot;))\n                            .uri(authorization_server))\n                    .route(&quot;/oauth2_path&quot;, rt -&gt; rt.path(&quot;/oauth2/**&quot;)\n                            .uri(authorization_server))\n                    .route(&quot;tiktok_path&quot;, rt -&gt; rt.path(&quot;/tiktok/**&quot;)\n                            .uri(authorization_server))\n                    .build();\n    }\n}\n</code></pre>\n<pre class=\"lang-yaml prettyprint-override\"><code>#application.yml\nserver:\n  port: 8080\n\nspring:\n  web:\n    resources:\n      static-locations: classpath:/static/\n  security:\n    oauth2:\n      client:\n        registration:\n          gateway:\n            provider: spring\n            client-id: gateway\n            client-secret: secret\n            authorization-grant-type: authorization_code\n            redirect-uri: &quot;{baseUrl}/login/oauth2/code/{registrationId}&quot;\n            scope: openid,resource.read\n        provider:\n          spring:\n            issuer-uri: ${provider.issuer-uri}\n      resourceserver:\n        jwt:\n          issuer-uri: ${app.auth-server}\n\nlogging:\n  level:\n    root: INFO\n    org.springframework.security: trace\n    org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator: INFO\n    org.springframework.cloud.gateway: trace\n    org.springframework.security.oauth2: trace\n\nprovider:\n  issuer-uri: http://localhost:9000\n\neureka:\n  defaultZoneUrl: http://u:p@localhost:8761/eureka/\n\napp:\n  auth-server: http://localhost:9000\n</code></pre>\n<p>and pom.xml for spring cloud gateway:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;4.0.0&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;com.forum&lt;/groupId&gt;\n    &lt;artifactId&gt;auth2_cloud_gateway&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;auth2_cloud_gateway&lt;/name&gt;\n    &lt;description&gt;auth2_cloud_gateway&lt;/description&gt;\n    \n    &lt;properties&gt;\n        &lt;java.version&gt;17&lt;/java.version&gt;\n        &lt;spring-cloud.version&gt;2025.1.0-RC1&lt;/spring-cloud.version&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security-oauth2-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-cloud-starter-gateway-server-webflux&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security-oauth2-client-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;\n            &lt;artifactId&gt;reactor-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-oauth2-resource-server&lt;/artifactId&gt;\n            &lt;!--&lt;version&gt;7.0.0&lt;/version&gt;--&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;\n                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n    \n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n&lt;/project&gt;\n</code></pre>\n<p>and spring authorization server sources:</p>\n<pre class=\"lang-java prettyprint-override\"><code>//AuthorizationServerApplication.java\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class AuthorizationServerApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(AuthorizationServerApplication.class, args);\n    }\n\n}\n\n\n//AuthorizationServerConfig.java\nimport com.nimbusds.jose.JOSEException;\nimport com.nimbusds.jose.jwk.JWKSet;\nimport com.nimbusds.jose.jwk.RSAKey;\nimport com.nimbusds.jose.jwk.source.JWKSource;\nimport com.nimbusds.jose.proc.SecurityContext;\n\n\n\nimport java.security.KeyPair;\nimport java.security.KeyPairGenerator;\nimport java.security.interfaces.RSAPrivateKey;\nimport java.security.interfaces.RSAPublicKey;\nimport java.time.Duration;\nimport java.time.temporal.ChronoUnit;\nimport java.util.Arrays;\nimport java.util.List;\nimport java.util.UUID;\nimport java.util.function.Consumer;\n\nimport static org.springframework.security.config.Customizer.withDefaults;\n\n@Configuration(proxyBeanMethods = false)\n@EnableWebSecurity\npublic class AuthorizationServerConfig {\n    private static final Logger LOG = LoggerFactory.getLogger(AuthorizationServerConfig.class);\n\n    @Value(&quot;${auth-provider.issuer-uri}&quot;)\n    private String issuer_uri;\n@Bean\n@Order(Ordered.HIGHEST_PRECEDENCE)\npublic SecurityFilterChain authorizationServerSecurityFilterChain(HttpSecurity http) throws Exception {\n    OAuth2AuthorizationServerConfigurer authorizationServerConfigurer =\n            new OAuth2AuthorizationServerConfigurer();\n    authorizationServerConfigurer\n            .authorizationEndpoint(authorizationEndpoint -&gt;\n                    authorizationEndpoint\n                            .authenticationProviders(configureAuthenticationValidator())\n            );\n    RequestMatcher endpointsMatcher = authorizationServerConfigurer\n            .getEndpointsMatcher();\n            http.securityMatcher(endpointsMatcher)\n            .authorizeHttpRequests(authorize -&gt;{\n                authorize.requestMatchers(&quot;/oauth2&quot;).permitAll();\n                authorize.requestMatchers(&quot;/login&quot;).permitAll();\n                    authorize.anyRequest().authenticated();\n            })\n            .apply(authorizationServerConfigurer);\n    http.getConfigurer(OAuth2AuthorizationServerConfigurer.class)\n            .oidc(Customizer.withDefaults()); // Enable OpenID Connect 1.0\n    http\n            .exceptionHandling(exceptions -&gt;\n                    exceptions.authenticationEntryPoint(new LoginUrlAuthenticationEntryPoint(&quot;/login&quot;))\n            )\n            .oauth2ResourceServer(oauth2 -&gt; oauth2\n            .jwt(withDefaults()));\n    WebMvcAutoConfiguration a=null;\n    return http.build();\n}\n\n    @Bean\n    public RegisteredClientRepository registeredClientRepository() {\n        RegisteredClient registeredClient = RegisteredClient.withId(UUID.randomUUID().toString())\n                .clientId(&quot;gateway&quot;)\n                .clientSecret(&quot;{noop}secret&quot;)\n                .clientAuthenticationMethod(ClientAuthenticationMethod.CLIENT_SECRET_BASIC)\n                .authorizationGrantType(AuthorizationGrantType.AUTHORIZATION_CODE)\n                .authorizationGrantType(AuthorizationGrantType.REFRESH_TOKEN)\n                .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS) // it was not heer\n                .redirectUri(&quot;http://localhost:8080/swagger-ui/index.html&quot;)\n                .scope(OidcScopes.OPENID)\n                .scope(&quot;resource.write&quot;)\n                .scope(&quot;resource.read&quot;)\n                .clientSettings(ClientSettings.builder().requireProofKey(false).build())\n                .tokenSettings(TokenSettings.builder()\n                        .accessTokenTimeToLive(Duration.of(60*24*140, ChronoUnit.MINUTES))\n                        .refreshTokenTimeToLive(Duration.of(120*24*140, ChronoUnit.MINUTES))\n                        .build())\n                .build();\n        return new InMemoryRegisteredClientRepository(registeredClient);\n    }@Bean\n    public UserDetailsService users() {\n        UserDetails user = User.withDefaultPasswordEncoder()\n                .username(&quot;admin&quot;)\n                .password(&quot;1&quot;)\n                .roles(&quot;ADMIN&quot;)\n                .build();\n\n        return new InMemoryUserDetailsManager(user);\n    }\n\n    @Bean\n    public JWKSet getJwkSet(){\n        RSAKey rsaKey = generateRsa();\n        JWKSet jwkSet = new JWKSet(rsaKey);\n        return jwkSet;\n    }\n    @Bean\n    public JWKSource&lt;SecurityContext&gt; jwkSource(JWKSet jwkSet) {\n\n\n        return (jwkSelector, securityContext) -&gt; jwkSelector.select(jwkSet);\n    }\n    @Bean\n    public JwtDecoder jwtDecoder(JWKSource&lt;SecurityContext&gt; jwkSource) {\n        return OAuth2AuthorizationServerConfiguration.jwtDecoder(jwkSource);\n    }\n    private static RSAKey generateRsa() {\n        KeyPair keyPair = generateRsaKey();\n        RSAPublicKey publicKey = (RSAPublicKey) keyPair.getPublic();\n        // delete next line if you can\n        System.out.println(&quot;Oper RSA key &quot;+keyPair.getPublic() );\n        RSAPrivateKey privateKey = (RSAPrivateKey) keyPair.getPrivate();\n        return new RSAKey.Builder(publicKey)\n                .privateKey(privateKey)\n                .keyID(UUID.randomUUID().toString())\n                .build();\n    }\n\n    private static KeyPair generateRsaKey() {\n        KeyPair keyPair;\n        try {\n            KeyPairGenerator keyPairGenerator = KeyPairGenerator.getInstance(&quot;RSA&quot;);\n            keyPairGenerator.initialize(2048);\n            keyPair = keyPairGenerator.generateKeyPair();\n        } catch (Exception ex) {\n            throw new IllegalStateException(ex);\n        }\n        return keyPair;\n    }\n    @Bean\n    public AuthorizationServerSettings authorizationServerSettings() {\n        return AuthorizationServerSettings.builder().issuer(issuer_uri).build();\n    }\n   /* @Bean\n    public ProviderSettings providerSettings() {\n        return ProviderSettings.builder()\n                .issuer(issuer_uri) //&quot;http://localhost:9000&quot;) ////\n                .build();\n    }*/\n\n    private Consumer&lt;List&lt;AuthenticationProvider&gt;&gt; configureAuthenticationValidator() {\n        return (authenticationProviders) -&gt;\n                authenticationProviders.forEach((authenticationProvider) -&gt; {\n                    if (authenticationProvider instanceof OAuth2AuthorizationCodeRequestAuthenticationProvider) {\n                        Consumer&lt;OAuth2AuthorizationCodeRequestAuthenticationContext&gt; authenticationValidator =\n                                // Override default redirect_uri validator\n                                new CustomRedirectUriValidator()\n                                        // Reuse default scope validator\n                                        .andThen(OAuth2AuthorizationCodeRequestAuthenticationValidator.DEFAULT_SCOPE_VALIDATOR);\n\n                        ((OAuth2AuthorizationCodeRequestAuthenticationProvider) authenticationProvider)\n                                .setAuthenticationValidator(authenticationValidator);\n                    }\n                });\n    }\n    static class CustomRedirectUriValidator implements Consumer&lt;OAuth2AuthorizationCodeRequestAuthenticationContext&gt; {\n\n        @Override\n        public void accept(OAuth2AuthorizationCodeRequestAuthenticationContext authenticationContext) {\n            OAuth2AuthorizationCodeRequestAuthenticationToken authorizationCodeRequestAuthentication =\n                    authenticationContext.getAuthentication();\n            RegisteredClient registeredClient = authenticationContext.getRegisteredClient();\n            String requestedRedirectUri = authorizationCodeRequestAuthentication.getRedirectUri();\n\n            LOG.trace(&quot;Will validate the redirect uri {}&quot;, requestedRedirectUri);\n\n            // Use exact string matching when comparing client redirect URIs against pre-registered URIs\n            if (!registeredClient.getRedirectUris().contains(requestedRedirectUri)) {\n                LOG.trace(&quot;Redirect uri is invalid!&quot;);\n                OAuth2Error error = new OAuth2Error(OAuth2ErrorCodes.INVALID_REQUEST);\n//ithing i dont need it                throw new OAuth2AuthorizationCodeRequestAuthenticationException(error, null); //i think i dont need IT\n            }\n            LOG.trace(&quot;Redirect uri is OK!&quot;);\n        }\n    }\n\n    @Bean //https://stackoverflow.com/questions/36809528/spring-boot-cors-filter-cors-preflight-channel-did-not-succeed\n    public CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration configuration = new CorsConfiguration();\n        configuration.setAllowedOrigins(Arrays.asList(&quot;*&quot;));\n        configuration.setAllowedMethods(Arrays.asList(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;PATCH&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;));\n        configuration.setAllowCredentials(true);\n        configuration.setAllowedHeaders(Arrays.asList(&quot;*&quot;));\n        configuration.setAllowedHeaders(Arrays.asList(&quot;authorization&quot;, &quot;content-type&quot;, &quot;x-auth-token&quot;));\n        configuration.setExposedHeaders(Arrays.asList(&quot;x-auth-token&quot;));\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration(&quot;/**&quot;, configuration);\n        LOG.error(&quot;CorsConfigurationSource corsConfigurationSource&quot;);\n        return source;\n    }\n\n    @Bean\n    public WebMvcConfigurer corsConfigurer() {\n        return new WebMvcConfigurer() {\n            @Override\n            public void addCorsMappings(CorsRegistry registry) {\n                registry.addMapping(&quot;/**&quot;).allowedOrigins(&quot;http://localhost:3000&quot;);\n                LOG.error(&quot;Cors Mapping from configurer&quot;);\n            }\n        };\n    }\n}\n//DefaultSecurityConfig.java\n\n@Configuration\n@EnableWebSecurity\npublic class DefaultSecurityConfig {\n    @Bean\n    SecurityFilterChain defaultSecurityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(CsrfConfigurer::disable)\n                .authorizeHttpRequests(authorizeRequests -&gt; {\n                            authorizeRequests.requestMatchers(&quot;/index.html&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/favicon.ico&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/assets/**&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/jwks&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/oauth2&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/oauth2/**&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/login&quot;).permitAll();\n                            authorizeRequests.requestMatchers(&quot;/**&quot;).permitAll();\n                            authorizeRequests\n                                    .anyRequest()\n                                    .authenticated();\n                        }\n                );\n        http\n                .formLogin(withDefaults());\n        return http.build();\n    }\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        PasswordEncoder PASSWORD_ENCODER = PasswordEncoderFactories.createDelegatingPasswordEncoder();\n        return PASSWORD_ENCODER;\n    }\n}\n//JwkKeyEndpoint.java\nimport com.nimbusds.jose.jwk.JWK;\nimport com.nimbusds.jose.jwk.JWKSet;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.ResponseBody;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport java.util.*;\n\n@RestController\npublic class JwkKeyEndpoint {\n    @Autowired\n    private JWKSet jwkSet;\n\n    @GetMapping(&quot;/jwks&quot;)\n    @ResponseBody\n    public String getKey() {\n        jwkSet.toPublicJWKSet().getKeys();\n        List&lt;JWK&gt; jwkValueList = jwkSet.toPublicJWKSet().getKeys();\n        return jwkValueList.get(0).toString();\n    }\n}\n</code></pre>\n<pre class=\"lang-yaml prettyprint-override\"><code>#application.yml\nserver:\n  port: 9000\nlogging:\n  level:\n    #root: TRACE\n    org.springframework.security: trace\napplication.localhost-path: localhost\n\nauth-provider:\n  issuer-uri: &quot;http://localhost:9000&quot;\nauth-server:\n  get-jwk-link: &quot;http://localhost:9000/jwks&quot;\nspring:\n  security:\n    oauth2:\n      resourceserver:\n        jwt:\n          issuer-uri: http://${application.localhost-path}:9000\n</code></pre>\n<p>and pom.xml for spring authorization server:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;4.0.0&lt;/version&gt; &lt;!-- was 3.0.4 --&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository 2.7.5 --&gt;\n    &lt;/parent&gt;\n\n    &lt;groupId&gt;com.forum&lt;/groupId&gt;\n    &lt;artifactId&gt;authorization-server&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;authorization-server&lt;/name&gt;\n    &lt;description&gt;authorization-server&lt;/description&gt;\n\n    &lt;properties&gt;\n        &lt;java.version&gt;17&lt;/java.version&gt;\n        &lt;spring-cloud.version&gt;2025.0.0&lt;/spring-cloud.version&gt;&lt;!-- 2022.0.1 --&gt;\n        &lt;spring-auth-server.version&gt;7.0.0&lt;/spring-auth-server.version&gt;&lt;!-- 1.0.0 but was 0.3.1 --&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencies&gt;\n        &lt;!--   --&gt;&lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-oauth2-authorization-server&lt;/artifactId&gt;\n            &lt;version&gt;${spring-auth-server.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-autoconfigure&lt;/artifactId&gt;\n\n        &lt;/dependency&gt;&lt;!-- --&gt;&lt;!-- added in boot 4.0.0 --&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;!--&lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;\n        &lt;/dependency&gt;--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n            &lt;version&gt;1.18.42&lt;/version&gt;&lt;!-- was 1.18.30 --&gt;\n            &lt;scope&gt;provided&lt;/scope&gt;\n        &lt;/dependency&gt;\n&lt;!--        &lt;dependency&gt;\n            &lt;groupId&gt;com.h2database&lt;/groupId&gt;\n            &lt;artifactId&gt;h2&lt;/artifactId&gt;\n            &lt;scope&gt;runtime&lt;/scope&gt;\n            &lt;version&gt;1.4.199&lt;/version&gt;\n        &lt;/dependency&gt;--&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.postgresql&lt;/groupId&gt;\n            &lt;artifactId&gt;postgresql&lt;/artifactId&gt;\n&lt;!--            &lt;version&gt;42.7.5&lt;/version&gt;  --&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n        &lt;groupId&gt;org.hibernate&lt;/groupId&gt;\n        &lt;artifactId&gt;hibernate-core&lt;/artifactId&gt;\n               &lt;version&gt;7.0.10.Final&lt;/version&gt; &lt;!--was 6.5.3.Final; but before it was empty version --&gt;\n        &lt;/dependency&gt;\n       \n        &lt;dependency&gt;\n            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;\n            &lt;artifactId&gt;jjwt-api&lt;/artifactId&gt;\n            &lt;version&gt;0.12.6&lt;/version&gt;\n            &lt;!--     --&gt;    &lt;scope&gt;compile&lt;/scope&gt;\n        &lt;/dependency&gt; &lt;!--  --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;\n            &lt;artifactId&gt;jjwt-impl&lt;/artifactId&gt;\n            &lt;version&gt;0.12.6&lt;/version&gt;\n            &lt;scope&gt;runtime&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;\n            &lt;artifactId&gt;jjwt-jackson&lt;/artifactId&gt;\n            &lt;version&gt;0.12.6&lt;/version&gt;\n            &lt;scope&gt;runtime&lt;/scope&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-config&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;commons-logging&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-logging&lt;/artifactId&gt;\n            &lt;version&gt;1.3.5&lt;/version&gt;\n        &lt;/dependency&gt;&lt;!-- because of boot 4.0.0 --&gt;\n    &lt;/dependencies&gt;\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt;\n                &lt;version&gt;${spring-cloud.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n    \n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n\n            &lt;!--&lt;plugin&gt;\n            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n            &lt;artifactId&gt;maven-resources-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.3.1&lt;/version&gt;\n                &lt;configuration&gt;\n\n                    &lt;nonFilteredFileExtensions&gt;\n                        &lt;nonFilteredFileExtension&gt;esbuild&lt;/nonFilteredFileExtension&gt;\n                        &lt;nonFilteredFileExtension&gt;swf&lt;/nonFilteredFileExtension&gt;\n                    &lt;/nonFilteredFileExtensions&gt;\n\n                &lt;/configuration&gt;\n            &lt;executions&gt;\n                &lt;execution&gt;\n                    &lt;id&gt;Copy my VueJS app into my Spring Boot target static\n                        folder\n                    &lt;/id&gt;\n                    &lt;phase&gt;process-resources&lt;/phase&gt;\n                    &lt;goals&gt;\n                        &lt;goal&gt;copy-resources&lt;/goal&gt;\n                    &lt;/goals&gt;\n                    &lt;configuration&gt;\n                        &lt;outputDirectory&gt;target/classes/static&lt;/outputDirectory&gt;\n                        &lt;resources&gt;\n                            &lt;resource&gt;\n                                &lt;directory&gt;/home/user/Downloads/vscode/BuildingRealWorldVue3/vue-3-pinia-jwt-authentication-example-master/dist&lt;/directory&gt;\n                                &lt;filtering&gt;true&lt;/filtering&gt;\n                            &lt;/resource&gt;\n                        &lt;/resources&gt;\n                    &lt;/configuration&gt;\n                &lt;/execution&gt;\n            &lt;/executions&gt;\n        &lt;/plugin&gt;--&gt;\n\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n&lt;/project&gt;\n</code></pre>\n<p><strong>Edit</strong>\ni was need to add <code>http.formLogin(formLogin -&gt; formLogin.defaultSuccessUrl(&quot;http://localhost:8080&quot;))</code> to DefaultSecurityConfig.class\nBut .formLogin needs <code>AuthenticationManager</code> bean, so i add</p>\n<pre class=\"lang-java prettyprint-override\"><code>Component\npublic class JwtReactiveAuthenticationManager implements ReactiveAuthenticationManager {\n\n    private static final Logger logger = LogManager.getLogger(JwtReactiveAuthenticationManager.class);\n\n    @Override\n    public Mono&lt;Authentication&gt; authenticate(Authentication authentication) {\n        String authHeader = (String) authentication.getPrincipal();\n        if (authHeader.isEmpty()) {\n            logger.error(&quot;Authentication  authHeader is empty &quot;+authHeader);\n        \n            return Mono.empty();\n        }\n        return Mono.just(new UsernamePasswordAuthenticationToken(authHeader, null));\n\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "spring-cloud-gateway" ],
    "owner" : {
      "account_id" : 42774795,
      "reputation" : 3,
      "user_id" : 31067338,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/70b79462e4a710d068c7195291faf3f7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Snilspefad",
      "link" : "https://stackoverflow.com/users/31067338/snilspefad"
    },
    "is_answered" : true,
    "view_count" : 72,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1765117724,
    "creation_date" : 1764265982,
    "link" : "https://stackoverflow.com/questions/79831984/http-403-when-authentication-in-spring-authentication-server-after-login-in-spr",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}