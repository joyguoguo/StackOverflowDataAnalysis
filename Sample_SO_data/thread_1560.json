{
  "question" : {
    "question_id" : 79695550,
    "title" : "Unable to load tcnatve openssl in native image",
    "body" : "<p>I have a Spring Boot webflux app, running Netty. When enabling SSL performance hurts more than expected, and I want to check if using native OpenSSL (netty-tcnative) helps.</p>\n<p>I think I have everything set up correctly, but the app reports OpenSSL unavailable. I've reproduced in a simple Spring Boot app, but when running the image I get the following stacktrace:</p>\n<pre><code>java.lang.IllegalArgumentException: Failed to load any of the given libraries: [netty_tcnative_linux_aarch_64, netty_tcnative_linux_aarch_64_fedora, netty_tcnative_aarch_64, netty_tcnative]\n    at io.netty.util.internal.NativeLibraryLoader.loadFirstAvailable(NativeLibraryLoader.java:114)\n    at io.netty.handler.ssl.OpenSsl.loadTcNative(OpenSsl.java:716)\n    at io.netty.handler.ssl.OpenSsl.&lt;clinit&gt;(OpenSsl.java:110)\n    at com.example.OpensslTestApplication.main(OpensslTestApplication.java:23)\n    at java.base@21.0.7/java.lang.invoke.LambdaForm$DMH/sa346b79c.invokeStaticInit(LambdaForm$DMH)\n    Suppressed: java.lang.UnsatisfiedLinkError: Can't load library: /tmp/libnetty_tcnative_linux_aarch_6413650046406937568812.so\n        at org.graalvm.nativeimage.builder/com.oracle.svm.core.jdk.NativeLibrarySupport.loadLibraryAbsolute(NativeLibrarySupport.java:100)\n        at java.base@21.0.7/java.lang.ClassLoader.loadLibrary(ClassLoader.java:114)\n        at java.base@21.0.7/java.lang.Runtime.load0(Runtime.java:852)\n        at java.base@21.0.7/java.lang.System.load(System.java:2025)\n        at io.netty.util.internal.NativeLibraryUtil.loadLibrary(NativeLibraryUtil.java:36)\n        at io.netty.util.internal.NativeLibraryLoader.loadLibrary(NativeLibraryLoader.java:396)\n        at io.netty.util.internal.NativeLibraryLoader.load(NativeLibraryLoader.java:218)\n        at io.netty.util.internal.NativeLibraryLoader.loadFirstAvailable(NativeLibraryLoader.java:105)\n        ... 4 more\n        Suppressed: java.lang.UnsatisfiedLinkError: Can't load library: /tmp/libnetty_tcnative_linux_aarch_6413650046406937568812.so\n            at org.graalvm.nativeimage.builder/com.oracle.svm.core.jdk.NativeLibrarySupport.loadLibraryAbsolute(NativeLibrarySupport.java:100)\n            at java.base@21.0.7/java.lang.ClassLoader.loadLibrary(ClassLoader.java:114)\n            at java.base@21.0.7/java.lang.Runtime.load0(Runtime.java:852)\n            at java.base@21.0.7/java.lang.System.load(System.java:2025)\n            at io.netty.util.internal.NativeLibraryUtil.loadLibrary(NativeLibraryUtil.java:36)\n            at java.base@21.0.7/java.lang.reflect.Method.invoke(Method.java:580)\n            at io.netty.util.internal.NativeLibraryLoader$1.run(NativeLibraryLoader.java:430)\n            at java.base@21.0.7/java.security.AccessController.executePrivileged(AccessController.java:129)\n            at java.base@21.0.7/java.security.AccessController.doPrivileged(AccessController.java:319)\n            at io.netty.util.internal.NativeLibraryLoader.loadLibraryByHelper(NativeLibraryLoader.java:422)\n            at io.netty.util.internal.NativeLibraryLoader.loadLibrary(NativeLibraryLoader.java:388)\n            ... 6 more\n\n</code></pre>\n<p>I've used resource logging (<code>-H:Log=registerResource:3</code>) to verify that <code>META-INF/native/libnetty_tcnative_linux_aarch_64.so</code> is included, and from what I understand the fact that it's trying to load that file from /tmp with some random string appended means that it was able to find that file in the jar and extract it to /tmp. I'm building on my M2 MacBook Air and using Rancher Desktop.</p>\n<p>Any tips on how to proceed in debugging? It should be possible to use native OpenSSL in GraalVM native image, right?</p>\n<p>My app class:</p>\n<pre><code>@SpringBootApplication\n@ImportRuntimeHints(OpensslTestApplication.NettyNativeRuntimeHints.class)\npublic class OpensslTestApplication {\n\n    public static void main(String[] args) {\n        System.setProperty(&quot;io.netty.native.workdir&quot;, &quot;/tmp&quot;);\n\n        if (!OpenSsl.isAvailable()) {\n            System.err.println(&quot;❌ OpenSSL unavailable:&quot;);\n            OpenSsl.unavailabilityCause().printStackTrace();\n        } else {\n            System.out.println(&quot;✅ OpenSSL available: &quot; + OpenSsl.versionString());\n        }\n\n        SpringApplication.run(OpensslTestApplication.class, args);\n    }\n\n    static class NettyNativeRuntimeHints implements RuntimeHintsRegistrar {\n        @Override\n        public void registerHints(RuntimeHints hints, ClassLoader classLoader) {\n            hints.jni().registerType(OpenSsl.class);\n            hints.resources().registerPattern(&quot;META-INF/native/libnetty_tcnative_linux_aarch_64.so&quot;);\n            hints.resources().registerPattern(&quot;test.p12&quot;);\n        }\n    }\n\n    @Bean\n    RouterFunction&lt;ServerResponse&gt; route() {\n        return RouterFunctions.route(RequestPredicates.GET(&quot;/&quot;), req -&gt;\n                ServerResponse.ok().body(Mono.just(&quot;Hello from native SSL!&quot;), String.class)\n        );\n    }\n\n}\n</code></pre>\n<p>build.gradle:</p>\n<pre><code>import org.springframework.boot.gradle.plugin.SpringBootPlugin\n\nplugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.5.3'\n    id 'org.graalvm.buildtools.native' version '0.10.6'\n}\n\njava {\n    toolchain {\n        languageVersion = JavaLanguageVersion.of(21)\n    }\n}\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    implementation platform(SpringBootPlugin.BOM_COORDINATES)\n    implementation 'org.springframework.boot:spring-boot-starter-webflux'\n\n    implementation(&quot;io.netty:netty-tcnative-boringssl-static:2.0.72.Final:linux-aarch_64&quot;)\n    // Adding this makes OpenSSL available during aot processing when buliding on macos, not sure if necessary\n    implementation(&quot;io.netty:netty-tcnative-boringssl-static:2.0.72.Final:osx-aarch_64&quot;)\n}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "openssl", "netty", "graalvm" ],
    "owner" : {
      "account_id" : 42949321,
      "reputation" : 1,
      "user_id" : 31001393,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/36b479f7546b434a6ed7386943531ada?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "johnarne",
      "link" : "https://stackoverflow.com/users/31001393/johnarne"
    },
    "is_answered" : false,
    "view_count" : 70,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1752061015,
    "creation_date" : 1752061015,
    "link" : "https://stackoverflow.com/questions/79695550/unable-to-load-tcnatve-openssl-in-native-image",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}