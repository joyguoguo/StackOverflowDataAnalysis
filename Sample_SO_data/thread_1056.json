{
  "question" : {
    "question_id" : 79748100,
    "title" : "TCP Connection Refused Given multiple concurrent connection",
    "body" : "<p>I try to play with multiple concurrent tcp connection in Java.\nGiven 250 concurrent tcp connection, some of them will get connection refused.\nIt surprises me due to only 250 connection.<br />\nIn large web application, there should be much more concurrent connection. Actually, I test it similarly in spring boot web application. I got same connection refused error.<br />\nAny idea why?  (Note: Below example is tested on Windows 11 PC)</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class TcpServer {\n\n    public static void main(String[] args) throws Exception {\n        ServerSocketChannel serverSocketChannel = ServerSocketChannel.open();\n        serverSocketChannel.socket().bind(new InetSocketAddress(8090), 500);\n\n        while (true) {\n            var socketChannel = serverSocketChannel.accept();\n            System.out.println(&quot;client connected: &quot; + socketChannel.getRemoteAddress());\n            socketChannel.close();\n        }\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class TcpStressTest {\n\n    static AtomicInteger successCount = new AtomicInteger(0);\n    static AtomicInteger failureCount = new AtomicInteger(0);\n\n    public static void main(String[] args) throws Exception {\n        // create 10k threads to connect to server\n        int N = 250;\n        ExecutorService executorService = java.util.concurrent.Executors.newFixedThreadPool(50);\n        List&lt;Future&lt;Object&gt;&gt; futures = new java.util.ArrayList&lt;&gt;();\n        for (int i = 0; i &lt; N; i++) {\n            Future&lt;?&gt; submit = executorService.submit(() -&gt; {\n                TcpClient client = new TcpClient();\n                int start = client.start();\n                if (start == 1) {\n                    successCount.incrementAndGet();\n                } else {\n                    failureCount.incrementAndGet();\n                }\n            });\n            futures.add((Future&lt;Object&gt;) submit);\n        }\n        for (Future&lt;Object&gt; future : futures) {\n            try {\n                future.get();\n            } catch (Exception e) {\n                e.printStackTrace();\n            }\n        }\n        System.out.println(&quot;All clients finished&quot;);\n        System.out.println(&quot;Success count: &quot; + successCount.get());\n        System.out.println(&quot;Failure count: &quot; + failureCount.get());\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class TcpClient {\n\n    private static final String SERVER_HOST = &quot;localhost&quot;;\n    private static final int SERVER_PORT = 8090;\n\n    public int start() {\n        try {\n            SocketChannel socketChannel = SocketChannel.open();\n            socketChannel.connect(new java.net.InetSocketAddress(SERVER_HOST, SERVER_PORT));\n            socketChannel.close();\n            return 1;\n        } catch (java.io.IOException e) {\n            System.out.println(&quot;[Thread: &quot; + Thread.currentThread().getName() + &quot; Connection failed: &quot; + e.getMessage());\n            return 0;\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "tcp", "nio" ],
    "owner" : {
      "account_id" : 8602812,
      "reputation" : 871,
      "user_id" : 7390103,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6c30a51e7297b944219221ea0fa01d18?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Spaceship222",
      "link" : "https://stackoverflow.com/users/7390103/spaceship222"
    },
    "is_answered" : true,
    "view_count" : 154,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1757407222,
    "creation_date" : 1756304408,
    "link" : "https://stackoverflow.com/questions/79748100/tcp-connection-refused-given-multiple-concurrent-connection",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79749139,
    "question_id" : 79748100,
    "body" : "<p>Your client uses a fixed thread pool of only 50 threads . But you're trying to create 250 connections. The thread pool can only process 50 connections at a time, but the connection attempts are being made rapidly, potentially overwhelming the server.</p>\n<p>Check your operating system's limits:</p>\n<p>Various TCP/IP stack settings</p>\n<p>Some systems have artificial limits on localhost connections to prevent denial-of-service.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 29047872,
      "reputation" : 1,
      "user_id" : 22251306,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTtdGWPXEeb1gFeTbGXvf-o5wXcFfRxKKNX9T1OsoQ26W=k-s256",
      "display_name" : "mohammad aliani",
      "link" : "https://stackoverflow.com/users/22251306/mohammad-aliani"
    },
    "creation_date" : 1756386537,
    "last_activity_date" : 1756386537,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79759664,
    "question_id" : 79748100,
    "body" : "<p>This looks like it could be an issue which is resolved in <a href=\"https://jdk.java.net/26/\" rel=\"nofollow noreferrer\">JDK26</a>.\nSee <a href=\"https://bugs.openjdk.org/browse/JDK-8330940\" rel=\"nofollow noreferrer\">JDK-8330940 Impossible to create a socket backlog greater than 200 on Windows 8+</a> .</p>\n<p>If I run your sample on Windows 11 with JDK25 I get:</p>\n<pre><code>All clients finished\nSuccess count: 241\nFailure count: 9\n</code></pre>\n<p>If I run same build of the sample in JDK26 (Early Access) I get no errors:</p>\n<pre><code>All clients finished\nSuccess count: 250\nFailure count: 0\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 5998820,
      "reputation" : 16283,
      "user_id" : 4712734,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f6e922a2cb7e2da59286f27b162aaca5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "DuncG",
      "link" : "https://stackoverflow.com/users/4712734/duncg"
    },
    "creation_date" : 1757406607,
    "last_activity_date" : 1757407222,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140700918,
    "post_id" : 79748100,
    "body" : "@JohnBollinger thanks. I tested it on Linux. Looks good for now.",
    "score" : 0,
    "owner" : {
      "account_id" : 8602812,
      "reputation" : 871,
      "user_id" : 7390103,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6c30a51e7297b944219221ea0fa01d18?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Spaceship222",
      "link" : "https://stackoverflow.com/users/7390103/spaceship222"
    },
    "creation_date" : 1756455799,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140696344,
    "post_id" : 79748100,
    "body" : "Then I&#39;m not particularly surprised.  I can&#39;t advise you about the details on Windows client operating systems, but a default limit of a few hundred concurrent connections is about right.  Your &quot;large web applications&quot; are not deployed on this kind of hardware or OS.",
    "score" : 1,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1756307428,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140696306,
    "post_id" : 79748100,
    "body" : "@JohnBollinger tested on windows 11 PC",
    "score" : 0,
    "owner" : {
      "account_id" : 8602812,
      "reputation" : 871,
      "user_id" : 7390103,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6c30a51e7297b944219221ea0fa01d18?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Spaceship222",
      "link" : "https://stackoverflow.com/users/7390103/spaceship222"
    },
    "creation_date" : 1756306535,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140696273,
    "post_id" : 79748100,
    "body" : "On what kind of machine are you running the server?  There may be relevant limits placed by the OS.  And if so, these might be configurable.  On Linux, for example, <a href=\"https://stackoverflow.com/q/410616/2402272\">Increasing the maximum number of TCP/IP connections in Linux</a> might be relevant.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1756305897,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140696235,
    "post_id" : 79748100,
    "body" : "ah, I see now, via bind",
    "score" : 0,
    "owner" : {
      "account_id" : 3415144,
      "reputation" : 24355,
      "user_id" : 2864275,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f1f73deb5983ac46af2a74732752292e?s=256&d=identicon&r=PG",
      "display_name" : "Iłya Bursov",
      "link" : "https://stackoverflow.com/users/2864275/i%c5%82ya-bursov"
    },
    "creation_date" : 1756305060,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140696232,
    "post_id" : 79748100,
    "body" : "@IłyaBursov I have increased backlog from 50 to 500. Still not much helpful in this  case",
    "score" : 0,
    "owner" : {
      "account_id" : 8602812,
      "reputation" : 871,
      "user_id" : 7390103,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6c30a51e7297b944219221ea0fa01d18?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Spaceship222",
      "link" : "https://stackoverflow.com/users/7390103/spaceship222"
    },
    "creation_date" : 1756305011,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}