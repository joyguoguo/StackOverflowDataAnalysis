{
  "question" : {
    "question_id" : 79544715,
    "title" : "Custom ServerSocketChannel not keeping track of my added variables",
    "body" : "<p><strong>Short Introduction:</strong></p>\n<p>I have a mini-chat feature where users can join a server of a specific project posted in my app. Each time someone clicks the button: &quot;Join chat&quot;, the program checks whether someone is currently hosting a server for that specific project or the user that clicked the button can be the admin, hosting the server.</p>\n<p>Every single user should be able to see how many users are there online in the server, this being displayed. Every single Admin should be able to close the whole chat and get everyone out when exiting. These two features of the chat are handled by two lists kept in the server, the <code>clientChannels</code>(the size of it is the number of online users) and the <code>clientInterfaces</code>(allowing for closing all the chats of the users and their interfaces displaying the chat when Admin exits the chat).</p>\n<p>Everything works just fine if I test it from one single projectInterface, but if I try to join the same project on two different interfaces displaying it, the user that is not the admin can not see the online count and won't get forced to disconnect from the chat when the Admin does. The main feature, of actual communicating, is working just fine.</p>\n<p><strong>Why I think I get this problem:</strong></p>\n<p>Each interface will have its own server instance with the data parsed for it to work: host, port etc. Even if the host and port are the same for the two interfaces, the lists get a new instance for each Server Object. Therefore, I can still communicate, the non-admin user joining the first created server, but the lists that I need for the other features aren't the same.</p>\n<p><strong>What have I tried:</strong></p>\n<p>Create a custom ServerSocketChannel so I can obtain the instance already created rather than creating a new server and parsing the same data. The custom serverChannel will have the two lists with the data unchanged and public for all clients that join. However, this doesn't work either for some reason and this is what I am trying to find out, why?</p>\n<p>I know that the easiest way to solve this is to keep track of online count and of the users that are in the chat in the database, and extract those when I need, but this will be too slow, as I have to update the online count each 1.5 sec. Also, I don't know if there is possible to store the whole Server Instance in MySQL, this would have solved the porblem.</p>\n<p><strong>CODE (Only the relevant parts):</strong></p>\n<blockquote>\n<p>The project interface, where you can access the chat:</p>\n</blockquote>\n<pre><code>    joinChatButton.addActionListener(e -&gt; {\n        joinChatButton.setEnabled(false);\n        \n        String selectQuery = &quot;SELECT id, name, ip_address, port FROM servers.locations WHERE name = ?&quot;;\n        String addQuery = &quot;INSERT INTO servers.locations (name, ip_address, port) VALUES (?, ?, ?)&quot;;\n        frame.setState(Frame.ICONIFIED);\n        try (Connection connection = ds.getConnection();\n             PreparedStatement statement = connection.prepareStatement(selectQuery);\n             PreparedStatement ps = connection.prepareStatement(addQuery)) {\n             statement.setString(1, projectName);\n             ResultSet resultSet = statement.executeQuery();\n            \n            if (!resultSet.next()) {\n                String IP_ADDRESS = InetAddress.getLocalHost().getHostAddress();\n                new Chat_Interface(serverChannel, true, IP_ADDRESS, projectName, frame, joinChatButton);\n                ps.setString(1, projectName);\n                ps.setString(2, IP_ADDRESS);\n                ps.setInt(3, 5000);\n                ps.addBatch();\n                \n                ps.executeBatch();\n                ps.clearBatch();\n            } else {\n                new Chat_Interface(serverChannel, false, resultSet.getString(3), projectName, frame, joinChatButton);\n            }\n        } catch (SQLException | UnknownHostException ex) {\n            throw new RuntimeException(ex);\n        }\n    });\n    frame.add(joinChatButton);\n    \n    // Make the frame visible\n    frame.setVisible(true);\n    \n    frame.addWindowListener(new WindowAdapter() {\n        @Override\n        public void windowClosed(WindowEvent e) {\n            area.setEnabled(true);\n        }\n    });\n}\n\npublic static void main(String[] args) throws IOException {\n    // Example usage\n    new ProjectInterface(&quot;Amazing Project&quot;, &quot;Andrei&quot;,\n            &quot;This is a detailed and captivating project description that will now be displayed over multiple lines. &quot;\n                    + &quot;The description can go on and on to test how it dynamically adjusts in the label.&quot;,\n            &quot;https://example.com&quot;, new JTextArea());\n}\n</code></pre>\n<p>}</p>\n<blockquote>\n<p>The Server:</p>\n</blockquote>\n<pre><code>CustomServerSocket serverChannel = new CustomServerSocket(SelectorProvider.provider(), clientChannels, clientInterfaces)) {\n            serverChannel.socket().bind(new InetSocketAddress(5000));\n            serverChannel.configureBlocking(false);\n            System.out.println(&quot;Server is listening on port &quot; + serverChannel.socket().getLocalPort());\n            ByteBuffer buffer = ByteBuffer.allocate(1024);\n            \n            clientChannels = serverChannel.getClientChannels();\n            clientInterfaces = serverChannel.getClientInterfaces();\n            \n            while (true) {\n                SocketChannel clientChannel = serverChannel.accept();\n                Iterator&lt;SocketChannel&gt; iterator = clientChannels.iterator();\n                if (clientChannel != null) {\n                    clientChannel.configureBlocking(false);\n                        clientChannels.add(clientChannel);\n                    System.out.printf(&quot;Client %s connected%n&quot;, clientChannel.socket().getRemoteSocketAddress());\n                }\n                \n                    while (iterator.hasNext()) {\n                        SocketChannel client = iterator.next();\n                        try {\n                            buffer.clear();\n                            int bytesRead = client.read(buffer);\n                            if (bytesRead == -1) {\n                                System.out.printf(&quot;Client %s disconnected%n&quot;, client.socket().getRemoteSocketAddress());\n                                clientChannels.remove(client);\n                                client.close();\n                            } else if (bytesRead &gt; 0) {\n                                buffer.flip();\n                                byte[] data = new byte[buffer.remaining()];\n                                buffer.get(data);\n                                String message = String.format(&quot;%s&quot;, new String((data), StandardCharsets.UTF_8));\n                                \n                                for (SocketChannel otherClient : clientChannels) {\n                                    buffer.clear();\n                                    buffer.put((message).getBytes());\n                                    buffer.flip();\n                                    while (buffer.hasRemaining()) {\n                                        otherClient.write(buffer);\n                                    }\n                                }\n                            }\n                        } catch (IOException e) {\n                            System.out.printf(&quot;Client %s disconnected due to error%n&quot;, client.socket().getRemoteSocketAddress());\n                            clientChannels.remove(client);\n                            client.close();\n                        }\n                    }\n            }\n        } catch (IOException e) {\n            throw new RuntimeException(e);\n        }\n}\n\n\npublic List&lt;SocketChannel&gt; getClientChannels() {\n    return clientChannels;\n}\n\npublic List&lt;Chat_Interface&gt; getClientInterfaces() {\n    return clientInterfaces;\n}\n</code></pre>\n<p>}</p>\n<blockquote>\n<p>The Chat Interface:</p>\n</blockquote>\n<pre><code>    public Chat_Interface(SimpleServerChannel serverChannel, boolean ownerOfServer, String IPAddress, String projectName, Frame projectInterface, JButton joinButton) {\n    if (ownerOfServer) {\n        new Thread(serverChannel::start).start();\n    }\n    serverChannel.getClientInterfaces().add(this);\n    //code...\n         iconLabel.addMouseListener(new MouseAdapter() {\n        @Override\n        public void mouseClicked(MouseEvent e) {\n            if (e.getButton() != 1) return;\n            if (nameField.getText().trim().isEmpty()) return;\n            \n            try {\n                if (iconLabel.isEnabled()) {\n                    client.sendMessageToServer(nameField.getText(), ownerOfServer);\n                    statusButton.setText(serverChannel.getClientChannels().size()+&quot;&quot;);\n                    nameField.setText(&quot;&quot;);\n                }\n            } catch (IOException ex) {\n                throw new RuntimeException(ex);\n            }\n            \n            if (iconLabel.isEnabled()) {\n                iconLabel.setEnabled(false);\n                Timer timer = new Timer(1500, new ActionListener() {\n                    @Override\n                    public void actionPerformed(ActionEvent e) {\n                        iconLabel.setEnabled(true);\n                    }\n                });\n                timer.setRepeats(false);\n                timer.start();\n            }\n        }\n    });\n    \n    \n    \n    Properties props = new Properties();\n    try {\n        props.load(Files.newInputStream(Path.of(&quot;storefront.properties&quot;), StandardOpenOption.READ));\n    } catch (IOException e) {\n        JOptionPane.showMessageDialog(frame, &quot;An error occurred&quot;, &quot;Error&quot;, JOptionPane.ERROR_MESSAGE);\n    }\n    MysqlDataSource ds = new MysqlDataSource();\n    ds.setServerName(&quot;localhost&quot;);\n    ds.setPortNumber(3306);\n    ds.setUser(props.getProperty(&quot;user&quot;));\n    ds.setPassword(props.getProperty(&quot;pass&quot;));\n    String removeQuery = &quot;DELETE FROM servers.locations WHERE name = ?&quot;;\n    Consumer&lt;Client&gt; closeClient = c -&gt; {\n        frame.dispose();\n        client.close();\n        projectInterface.setState(Frame.NORMAL);\n        \n        if (ownerOfServer) {\n            serverChannel.getClientChannels().forEach(client1 -&gt; {\n                try {\n                    client1.close();\n                } catch (IOException ex) {\n                    //do nothing\n                }\n            });\n            serverChannel.getClientInterfaces().forEach(client1 -&gt; client1.frame.dispose());\n        }\n        \n        try (Connection connection = ds.getConnection();\n             PreparedStatement preparedStatement = connection.prepareStatement(removeQuery)) {\n            preparedStatement.setString(1, projectName);\n            preparedStatement.execute();\n        } catch (SQLException e) {\n            throw new RuntimeException(e);\n        }\n    };\n</code></pre>\n<blockquote>\n<p>The CustomServerSocketChannel:</p>\n</blockquote>\n<pre><code>public class CustomServerSocket extends ServerSocketChannel {\nprivate final ServerSocketChannel delegate; // Real instance\nprivate List&lt;SocketChannel&gt; clientChannels;\nprivate List&lt;Chat_Interface&gt; clientInterfaces;\n\npublic CustomServerSocket(SelectorProvider provider, List&lt;SocketChannel&gt; clientChannels, List&lt;Chat_Interface&gt; clientInterfaces) throws IOException {\n    super(provider);\n    this.delegate = ServerSocketChannel.open(); // Create a real instance\n    this.clientChannels = clientChannels;\n    this.clientInterfaces = clientInterfaces;\n}\n\n@Override\npublic ServerSocketChannel bind(SocketAddress local, int backlog) throws IOException {\n    return delegate.bind(local, backlog); // Delegate the call\n}\n\n@Override\npublic &lt;T&gt; ServerSocketChannel setOption(SocketOption&lt;T&gt; name, T value) throws IOException {\n    return delegate.setOption(name, value); // Delegate the call\n}\n\n@Override\npublic &lt;T&gt; T getOption(SocketOption&lt;T&gt; name) throws IOException {\n    return delegate.getOption(name); // Delegate the call\n}\n\n@Override\npublic Set&lt;SocketOption&lt;?&gt;&gt; supportedOptions() {\n    return delegate.supportedOptions(); // Delegate the call\n}\n\n@Override\npublic ServerSocket socket() {\n    return delegate.socket(); // Delegate the call\n}\n\n@Override\npublic SocketChannel accept() throws IOException {\n    return delegate.accept(); // Delegate the call\n}\n\n@Override\npublic SocketAddress getLocalAddress() throws IOException {\n    return delegate.getLocalAddress(); // Delegate the call\n}\n\n@Override\nprotected void implCloseSelectableChannel() throws IOException {\n    delegate.close(); // Close the delegate\n}\n\n@Override\nprotected void implConfigureBlocking(boolean block) throws IOException {\n    delegate.configureBlocking(block); // Delegate the call\n}\n\npublic List&lt;SocketChannel&gt; getClientChannels() {\n    return clientChannels;\n}\n\npublic List&lt;Chat_Interface&gt; getClientInterfaces() {\n    return clientInterfaces;\n}\n</code></pre>\n<p>}</p>\n",
    "tags" : [ "java", "network-programming", "intellij-idea", "initialization", "serversocket" ],
    "owner" : {
      "user_type" : "does_not_exist",
      "display_name" : "user29054521"
    },
    "is_answered" : false,
    "view_count" : 43,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743344445,
    "creation_date" : 1743344309,
    "link" : "https://stackoverflow.com/questions/79544715/custom-serversocketchannel-not-keeping-track-of-my-added-variables",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140285678,
    "post_id" : 79544715,
    "body" : "sorry, my bad, I mis-read your try-with-resources in the first snippet wrong yesterday. As you only give snippets I will not try to make a compiler to work with it, but I still don&#39;t want to delete my first comment since I stand with it that you should extract the networking logic into something simpler than a GUI program. As you don&#39;t find the problem yourself, it doesn&#39;t look like it is &quot;readable enough to debug it&quot; for me.",
    "score" : 0,
    "owner" : {
      "account_id" : 3391382,
      "reputation" : 5360,
      "user_id" : 2846138,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/2sp68.png?s=256",
      "display_name" : "cyberbrain",
      "link" : "https://stackoverflow.com/users/2846138/cyberbrain"
    },
    "creation_date" : 1743492586,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140282781,
    "post_id" : 79544715,
    "body" : "There are no syntax errors, as the compiler that I use in IntelliJ doesn&#39;t point something wrong.  Also, it will be a waste of time to remake all of this in sample text, as the logic is already implemented and I don&#39;t really know if it will help me a lot, as the code for me is readable enough to debug it in this form.",
    "score" : 0,
    "owner" : {
      "user_type" : "does_not_exist",
      "display_name" : "user29054521"
    },
    "creation_date" : 1743429693,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140279752,
    "post_id" : 79544715,
    "body" : "In your code snippets there is at least one syntax error, please try to fix it. Also I would recommend that you try to implement a simple version of your software without GUI but just with a text based interface. Just start that very simple with the first steps that don&#39;t work. This will remove the complexity of multithreaded GUI code and make debugging easier.",
    "score" : 1,
    "owner" : {
      "account_id" : 3391382,
      "reputation" : 5360,
      "user_id" : 2846138,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/2sp68.png?s=256",
      "display_name" : "cyberbrain",
      "link" : "https://stackoverflow.com/users/2846138/cyberbrain"
    },
    "creation_date" : 1743353574,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}