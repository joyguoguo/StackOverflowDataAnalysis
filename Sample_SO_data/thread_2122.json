{
  "question" : {
    "question_id" : 79644846,
    "title" : "KeyStore fails to load in container",
    "body" : "<p>I have a self signed cert and a password protected pkcs 12 keystore created with openssl (<a href=\"https://serverfault.com/questions/831394/how-can-i-create-a-pkcs12-file-using-openssl-self-signed-certs\">like this</a>).</p>\n<p>The following java code succeeds on my local machine but fails in docker. <code>certificate</code> and <code>password</code> below are both <code>String</code> and are loaded from aws secrets. <code>certificate</code> is the keystore encoded as a base64 string. I get the same behavior in both places if I replace <code>certificate</code> and <code>password</code> with string literals.</p>\n<pre><code>byte[] bytes = Base64.getDecoder().decode(certificate);\nByteArrayInputStream byteStream = new ByteArrayInputStream(bytes);\nKeyStore keyStore = KeyStore.getInstance(&quot;PKCS12&quot;);\nkeyStore.load(byteStream, password.toCharArray());\n</code></pre>\n<p>Error:</p>\n<pre><code>java.io.IOException: keystore password was incorrect\n    at java.base/sun.security.pkcs12.PKCS12KeyStore.engineLoad(PKCS12KeyStore.java:2108)\n    at java.base/sun.security.util.KeyStoreDelegator.engineLoad(KeyStoreDelegator.java:222)\n    at java.base/java.security.KeyStore.load(KeyStore.java:1479)\nCaused by: java.security.UnrecoverableKeyException: failed to decrypt safe contents entry: javax.crypto.BadPaddingException: Given final block not properly padded. Such issues can arise if a bad key is used during decryption.\n</code></pre>\n<p>Another older key, which I didn't create works in both contexts. What's going on? Is the problem with the keystore or the container or both?</p>\n<p>Here's an example base64 encoded certifcate string and password that I see this behavior with:</p>\n<pre><code>String certificate = &quot;MIIFTwIBAzCCBQUGCSqGSIb3DQEHAaCCBPYEggTyMIIE7jCCAsoGCSqGSIb3DQEHBqCCArswggK3AgEAMIICsAYJKoZIhvcNAQcBMF8GCSqGSIb3DQEFDTBSMDEGCSqGSIb3DQEFDDAkBBBCrYg1YD4gc0QhDER3Z6OtAgIIADAMBggqhkiG9w0CCQUAMB0GCWCGSAFlAwQBKgQQytbCuG3C/e5JQfNWuArblYCCAkDFlPA0ysyxPVNqvRtb+lW0kuD2m/KavYbqS5fHEtn1jiDoBeTxMdSF4azK0XJgb3JFgPS+cp+kxBWisK7Tq2C0J6aGYcenXX+wdWRIog3xB9xO92j/HBxxS0JAIdLNZcLJZWAs0xHMmpsFNy3EG4GzyO2XbVprHh+nAKml1OIzbhlV3DzDk70u6XcDrHdAqsZTpghsedw+yhFDXrUEZVtZtlBqFO0qY7J3ZBC8eLpJBFcWAqjsyNrRUNtAD4li9F6qe9LJC6Aj+0FzbYPgLYYgMGAv+wUqdnhHiUXnVPGUoG6sLn+6PIgKQlrCNDdmQE+50u8X1QdNXQ4/9leiSw9glsED1WW5yBAIQyG6nhF7ix4xrDHwqmMbWDF/933MkQtMMgER2xbAEb4qK/TB9oMbydv9uVFijxrrfLQrIsznWu1qn4L1uDTbvljA5zeQXvJ9KYzV0HDx0fnZ7btNzj2FrkCNH8gZeQmwOCn26GnQxnOpTRg0F4/4YGmZpfNpPZre+woNDK5wIUUzJoZtE/7+RmTqDkPyAK/MoFM4OOWJQv7KDqLnKTYMV3zcggUJGpn6ebqUEZUmG27BE9N9ORYp/GyeAHqftW+exqsv4X28sgo6EuVEeAvvmngY6GhtYA6Xf+Ka3rZ6HA/qQGGtHL/nUu0SrIAOHrGDlI1CIIflZ+Bva4r5HQt1xAIL0ibxJs2nG2q4AvNvCV8e8SuSVUA0L9zEg/8xxKVopLFDGLk5C2MZd6vPPxI5ZSz8f6KffEIwggIcBgkqhkiG9w0BBwGgggINBIICCTCCAgUwggIBBgsqhkiG9w0BDAoBAqCCAckwggHFMF8GCSqGSIb3DQEFDTBSMDEGCSqGSIb3DQEFDDAkBBA47ptcuc1fb5kVu/RS1ArWAgIIADAMBggqhkiG9w0CCQUAMB0GCWCGSAFlAwQBKgQQ8z/ZeizUvNy1WjT9a+wqLgSCAWChjNpdZc+L1ptEUk/op1oZCmB6113SSyj52qXXNxNK7SjqLEUY3+fuXdoww6mPpnkFNnBe4zN0m1F/XEibVDl31xJrIt3+9M5iNHQ52dTg6An5t7UlkTiA2b2xgWoxlgv5V0JnTm94x23b4R39qlCkkrqtu8D/sOCP6oxXJpzjxcTTglyxnmtySKqm+HFgmtbmJB8sGPHP6C3DqwcI27VC5vItTGaxRWSWsYfcTP2+bt6LSuJb2ccMgpsoPhsHYuPBZlrNaHnQEtpX8cYZ0YkCkscdVXyT4vza+O0B6RXh4zRT7UdRSdCedKNqQAZiRRgICGDhx+i6z8+yC0IBt3UHfxpcgTB1rFgflUDNhw6WtBfdA8zMxXQe7cZsiNEF2AfrY1lZejo3aaiDY9tKovaGjDxZUjMF8fkfjfVJqBvCSeU3AfYnsPPQuUI4XIKoM2ZnyC1p7a75RTJYWB8JfXb4MSUwIwYJKoZIhvcNAQkVMRYEFOVpCcUcSm/K/xvSvh5w/Kxt4s71MEEwMTANBglghkgBZQMEAgEFAAQg84/Bh428JhGvSkiNiuDc498lN4Skw71O9nRgQOkGluYECIPjiKlApsCWAgIIAA==&quot;;\nString password = &quot;password&quot;;\n</code></pre>\n",
    "tags" : [ "java", "docker", "keystore", "pkcs#12" ],
    "owner" : {
      "account_id" : 19456362,
      "reputation" : 61,
      "user_id" : 14231605,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Gi3NVlgjgHYRZBIk6rmVUNbJI0R_W_cv_nqhhvwlaM=k-s256",
      "display_name" : "Adam B",
      "link" : "https://stackoverflow.com/users/14231605/adam-b"
    },
    "is_answered" : false,
    "view_count" : 83,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1748885004,
    "creation_date" : 1748575402,
    "link" : "https://stackoverflow.com/questions/79644846/keystore-fails-to-load-in-container",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140481014,
    "post_id" : 79644846,
    "body" : "The base64 string is definitely clean (I just generated an example base64 string and password which I see this behavior with, I&#39;ll add them to the question). The hashes are the same in the working local as the failing container. I suppose it must be something to do with the environment in that case?",
    "score" : 0,
    "owner" : {
      "account_id" : 19456362,
      "reputation" : 61,
      "user_id" : 14231605,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Gi3NVlgjgHYRZBIk6rmVUNbJI0R_W_cv_nqhhvwlaM=k-s256",
      "display_name" : "Adam B",
      "link" : "https://stackoverflow.com/users/14231605/adam-b"
    },
    "creation_date" : 1748884672,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140473060,
    "post_id" : 79644846,
    "body" : "@AdamB Make sure Base64 string is one single line and no extra quotes, line breaks, or escapes. Assuming your password doesn&#39;t contain non ascii chars. Most prolly your Keystore is corrupted at runtime. Try printing the same and you will get to know.       <code>System.out.println(&quot;Keystore hash: &quot; + Arrays.hashCode(Base64.getDecoder().decode(certificate))); System.out.println(&quot;Password hash: &quot; + password.hashCode());</code>",
    "score" : 0,
    "owner" : {
      "account_id" : 6471354,
      "reputation" : 1402,
      "user_id" : 5011400,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://i.sstatic.net/Ro0pI.png?s=256",
      "display_name" : "Yati Sawhney - Yates",
      "link" : "https://stackoverflow.com/users/5011400/yati-sawhney-yates"
    },
    "creation_date" : 1748619189,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140472961,
    "post_id" : 79644846,
    "body" : "@Frox, I get this behavior with both specificed as string literals.",
    "score" : 0,
    "owner" : {
      "account_id" : 19456362,
      "reputation" : 61,
      "user_id" : 14231605,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Gi3NVlgjgHYRZBIk6rmVUNbJI0R_W_cv_nqhhvwlaM=k-s256",
      "display_name" : "Adam B",
      "link" : "https://stackoverflow.com/users/14231605/adam-b"
    },
    "creation_date" : 1748617160,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140472953,
    "post_id" : 79644846,
    "body" : "@YatiSawhney-Yates, when I run locally the the keystore is valid and the password is correct. In both contexts I specify the password and base64 encoded certificate are the same string literals.",
    "score" : 0,
    "owner" : {
      "account_id" : 19456362,
      "reputation" : 61,
      "user_id" : 14231605,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Gi3NVlgjgHYRZBIk6rmVUNbJI0R_W_cv_nqhhvwlaM=k-s256",
      "display_name" : "Adam B",
      "link" : "https://stackoverflow.com/users/14231605/adam-b"
    },
    "creation_date" : 1748617100,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140471472,
    "post_id" : 79644846,
    "body" : "Something is inconsistent in how you procure &quot;certificate&quot; and &quot;password&quot;. Please share code for that.",
    "score" : 0,
    "owner" : {
      "account_id" : 38870157,
      "reputation" : 679,
      "user_id" : 28993166,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/40f55b63213d62c189e6dfd59ab06e04?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Frox",
      "link" : "https://stackoverflow.com/users/28993166/frox"
    },
    "creation_date" : 1748587461,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140471363,
    "post_id" : 79644846,
    "body" : "Either password is incorrect or the certificate is not a valid PKCS12 keystore",
    "score" : 0,
    "owner" : {
      "account_id" : 6471354,
      "reputation" : 1402,
      "user_id" : 5011400,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://i.sstatic.net/Ro0pI.png?s=256",
      "display_name" : "Yati Sawhney - Yates",
      "link" : "https://stackoverflow.com/users/5011400/yati-sawhney-yates"
    },
    "creation_date" : 1748582893,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}