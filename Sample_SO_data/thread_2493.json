{
  "question" : {
    "question_id" : 79617072,
    "title" : "Database level design for undo operation",
    "body" : "<p>I have an entity &quot;MyEntity&quot; which has some fields - &quot;StartDate&quot;, &quot;EndDate&quot;, &quot;Color&quot;.</p>\n<p>It can have multiple records, and each record is sometimes updated. I need to keep track of what updates were performed on each record and perform an &quot;undo&quot; operation and restore that record to previous state.</p>\n<p>I have heard of memento design pattern, but that's mostly in-memory. I need a solution where this information is stored at database level. If i go to a record of MyEntity, and click &quot;Undo&quot; button, it should revert the last update.</p>\n<p>Are there any recommendation on best data model on how to store that info in database?</p>\n<p>Example,</p>\n<p>MyEntityRecord1 (created) -&gt; Jan1-2025, Dec31-2025, Blue</p>\n<p>MyEntityRecord1 (updated) -&gt; Jan1-2025, May30-2025, Blue</p>\n<p>MyEntityRecord1 (updated) -&gt; Jan1-2025, May30-2025, Red</p>\n<p>MyEntityRecord1 (updated) -&gt; Jan20-2025, May30-2025, Purple</p>\n<p>MyEntityRecord1 (first undo) -&gt; Jan1-2025, May30-2025, Red</p>\n<p>MyEntityRecord1 (second undo) -&gt; Jan1-2025, May30-2025, Blue</p>\n<p>Thats the kind of functionality i am looking at. Side note: We cannot undo and undo operation.</p>\n<p>Our database stores only the latest state of MyEntityRecord1. For undo to work, i need some sort of diff on what changes were made on last operation.</p>\n<p>At the top of my head, I probably need to create another entity in database (MyEntityUpdates), that stores all intermediate states (and reference to the MyEntity record), but not too sure if thats the best design.</p>\n<p>We use a relational database, if that information is any use and run SQL queries</p>\n",
    "tags" : [ "java", "database-design", "software-design" ],
    "owner" : {
      "account_id" : 3540288,
      "reputation" : 235,
      "user_id" : 2957592,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a39f8b65ec1b59ebca937052d2bcd895?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user2957592",
      "link" : "https://stackoverflow.com/users/2957592/user2957592"
    },
    "is_answered" : true,
    "view_count" : 65,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1747013789,
    "creation_date" : 1747013352,
    "link" : "https://stackoverflow.com/questions/79617072/database-level-design-for-undo-operation",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79617076,
    "question_id" : 79617072,
    "body" : "<p>You'll probably want some kind of audit/history table. This is a common pattern in some apps, often referred to as &quot;event sourcing&quot; or &quot;audit trails&quot;, depending on depth and use case.</p>\n<h1>A little schema</h1>\n<p>MyEntity</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>INTEGER</td>\n<td>primary key</td>\n</tr>\n<tr>\n<td>start_date</td>\n<td>DATE</td>\n<td>start date of the entity</td>\n</tr>\n<tr>\n<td>end_date</td>\n<td>DATE</td>\n<td>end date of the entity</td>\n</tr>\n<tr>\n<td>color</td>\n<td>TEXT</td>\n<td>color of the entity</td>\n</tr>\n</tbody>\n</table></div>\n<hr />\n<p>MyEntityHistory</p>\n<div class=\"s-table-container\"><table class=\"s-table\">\n<thead>\n<tr>\n<th>Column Name</th>\n<th>Type</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>id</td>\n<td>INTEGER</td>\n<td>primary key</td>\n</tr>\n<tr>\n<td>entity_id</td>\n<td>INTEGER</td>\n<td>foregin key to MyEntity(id)</td>\n</tr>\n<tr>\n<td>start_date</td>\n<td>DATE</td>\n<td>snapshot start date</td>\n</tr>\n<tr>\n<td>end_date</td>\n<td>DATE</td>\n<td>snapshot end date</td>\n</tr>\n<tr>\n<td>color</td>\n<td>TEXT</td>\n<td>color of snapshot</td>\n</tr>\n<tr>\n<td>version</td>\n<td>INTEGER</td>\n<td>auto increment per entity</td>\n</tr>\n<tr>\n<td>updated_at</td>\n<td>TIMESTAMP</td>\n<td>time when the update occurred</td>\n</tr>\n<tr>\n<td>change_type</td>\n<td>TEXT</td>\n<td>(optional) what kind of change 'update', 'undo', 'create', etc.</td>\n</tr>\n<tr>\n<td>performed_by</td>\n<td>TEXT</td>\n<td>(optional) who made the change (useful depending on use case)</td>\n</tr>\n</tbody>\n</table></div>\n<p>update to <code>MyEntity</code> triggers insert into <code>MyEntityHistory</code> <em>before</em> the change is applied, storing the pre-change state. Or you can do it <em>after</em> applying and store the new state; both are valid depending on what you want.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 41920369,
      "reputation" : 41,
      "user_id" : 30509974,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/tC6jKpcy.jpg?s=256",
      "display_name" : "displaynameishere",
      "link" : "https://stackoverflow.com/users/30509974/displaynameishere"
    },
    "creation_date" : 1747013789,
    "last_activity_date" : 1747013789,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140416475,
    "post_id" : 79617072,
    "body" : "Please clarify:  You say &quot;We cannot undo and undo operation.&quot; ... but your example shows a sequence of two undo operations for MyEntityRecord1.  That is contradictory.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1747018172,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79617076" : [ {
      "comment_id" : 140416450,
      "post_id" : 79617076,
      "body" : "Event sourcing  and history tables can both help with this, but they&#39;re very different things. Don&#39;t conflate them.",
      "score" : 0,
      "owner" : {
        "account_id" : 145051,
        "reputation" : 139014,
        "user_id" : 354577,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://i.sstatic.net/dI6cA.jpg?s=256",
        "display_name" : "Chris",
        "link" : "https://stackoverflow.com/users/354577/chris"
      },
      "creation_date" : 1747015154,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}