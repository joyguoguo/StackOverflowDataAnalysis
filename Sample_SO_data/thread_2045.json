{
  "question" : {
    "question_id" : 79653158,
    "title" : "Can&#39;t implement custom TokenExchangeProvider in Keycloak 26.2.x",
    "body" : "<p>I am migrating from Keycloak 15 to 26 and faced follwong problem when trying to implement custom token exchange provider for external token exchange purposes.</p>\n<p>Earlier there was class DefaultTokenExchangeProvider I extended from and everything was fine and clear. In release 26.2.x there are new AbstractTokenExchangeProvider class and 2 childs: StandardTokenExchangeProvider (for internal-internal) and V1TokenExchangeProvider (for others purposes), moreover last one is not recomended to use as it's in preview mode.</p>\n<p>I developed my custom token exchange provider extending from first or second classes but faced following: I can't enable my provider - either Standard or V1 keeps working.</p>\n<p>My factory is:</p>\n<pre><code>public class MyTokenExchangeProviderFactory implements TokenExchangeProviderFactory, EnvironmentDependentProviderFactory {\n\n    private static final String PROVIDER_ID = &quot;standard&quot; (or &quot;default&quot;);\n\n    @Override\n    public TokenExchangeProvider create(KeycloakSession keycloakSession) {\n        return new MyTokenExchangeProvider();\n    }\n\n    @Override\n    public void init(Config.Scope scope) {}\n\n    @Override\n    public void postInit(KeycloakSessionFactory keycloakSessionFactory) {}\n\n    @Override\n    public void close() {}\n\n    @Override\n    public String getId() {\n        return PROVIDER_ID;\n    }\n\n    @Override\n    public int order() {\n        return 20; // 10 - for Standard and specifying more than 10 should have set priority to my provider but it seems not work\n    }\n\n    @Override\n    public boolean isSupported(Config.Scope scope) {\n        return Profile.isFeatureEnabled(Profile.Feature.TOKEN_EXCHANGE_STANDARD_V2);\n    }\n</code></pre>\n<p>or</p>\n<pre><code>@Override\n    public boolean isSupported(Config.Scope scope) {\n        return Profile.isFeatureEnabled(Profile.Feature.TOKEN_EXCHANGE);\n    }\n</code></pre>\n<p>depending on what class I'm extending from.</p>\n<p>META-INF/services:org.keycloak.protocol.oidc.TokenExchangeProviderFactory</p>\n<pre><code>org.example.factory.MyTokenExchangeProviderFactory\n</code></pre>\n<p>MyTokenExchangeProvider class:</p>\n<pre><code>public class MyTokenExchangeProvider extends StandardTokenExchangeProvider (or V1TokenExchangeProvider) {\n\n@Override\n    public boolean supports(TokenExchangeContext tokenExchangeContext) {\n        return false;\n    }\n\n@Override\n    public Response exchange(TokenExchangeContext context) {\n        this.params = context.getParams();\n        this.formParams = context.getFormParams();\n        this.session = context.getSession();\n        this.cors = context.getCors();\n        this.realm = context.getRealm();\n        this.client = context.getClient();\n        this.event = context.getEvent();\n        this.clientConnection = context.getClientConnection();\n        this.headers = context.getHeaders();\n        this.tokenManager = (TokenManager) context.getTokenManager();\n        this.clientAuthAttributes = context.getClientAuthAttributes();\n        this.context = context;\n\n        this.audience = context.getFormParams().getFirst(&quot;audience&quot;);\n\n        if (client.getClientId().equals(KEYCLOAK_EXCHANGE_CLIENT_ID)) {\n            return tokenExchange(); // Class for custom logic I'd like to implement\n        }\n\n        return super.exchange(context);\n    }\n\n@Override\n    public Response tokenExchange() {\n//My custom logic here }\n\n</code></pre>\n<p>I enable --features=token-exchange when startin Keycloak if V1 mode is required in acc. with Keycloak guide.</p>\n<p>My questions is: why I can't enable my custom provider and how to disable Standard or V1?</p>\n<p>Thanks in advance for any help.</p>\n",
    "tags" : [ "java", "keycloak" ],
    "owner" : {
      "account_id" : 40650301,
      "reputation" : 19,
      "user_id" : 29884518,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1b7bdda82579bc3e718f854529269401?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "KommRex",
      "link" : "https://stackoverflow.com/users/29884518/kommrex"
    },
    "is_answered" : false,
    "view_count" : 86,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749054278,
    "creation_date" : 1749054278,
    "link" : "https://stackoverflow.com/questions/79653158/cant-implement-custom-tokenexchangeprovider-in-keycloak-26-2-x",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}