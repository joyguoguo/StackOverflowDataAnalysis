{
  "question" : {
    "question_id" : 79652927,
    "title" : "Why does using instanceof pattern matching on a record field with a switch expression in the same method cause a java.lang.VerifyError?",
    "body" : "<p>I found this minimal set of code which seems to break any Java version I can find. (Also reproducible in <a href=\"https://www.onlinegdb.com/online_java_compiler\" rel=\"nofollow noreferrer\">https://www.onlinegdb.com/online_java_compiler</a> with Java <code>23.0.2+7-58</code>). The example is not meant to do anything useful except to demonstrate the issue â€” my actual code is more complex.</p>\n<pre class=\"lang-java prettyprint-override\"><code>record VehicleInput(Vehicle vehicle) {}\n\nsealed interface Vehicle permits Car {}\n\nrecord Car(String licensePlate) implements Vehicle {}\n\nsealed interface Animal permits Cat, Dog {}\n\nrecord Cat() implements Animal {}\n\nrecord Dog() implements Animal {}\n\nclass VehicleProgressor {\n  private boolean progress(VehicleInput input, Animal animal) {\n    if (input.vehicle() instanceof Car(String licensePlate)) {\n      return true;\n    }\n\n    return switch (animal) {\n      case Cat cat -&gt; true;\n      case Dog dog -&gt; true;\n    };\n  }\n}\n\npublic class Main {\n  public static void main(String[] args) {\n    System.out.println(Runtime.version());\n\n    new VehicleProgressor();\n  }\n}\n</code></pre>\n<p>(Versions managed with <a href=\"https://sdkman.io/install/\" rel=\"nofollow noreferrer\">sdkman</a>)</p>\n<pre class=\"lang-none prettyprint-override\"><code>$ sdk install java 24.0.1-amzn\n$ sdk use java 24.0.1-amzn\n</code></pre>\n<p>(The error output is exactly the same with <code>java 21.0.7-amzn</code>, <code>java 24.0.1-amzn</code>, <code>java 25.ea.25-open</code>, and <code>java 25.ea.25-graal</code>.)</p>\n<p>Compiling works:</p>\n<pre class=\"lang-none prettyprint-override\"><code>$ javac Main.java\n</code></pre>\n<p>but running fails with:</p>\n<pre class=\"lang-none prettyprint-override\"><code>$ java Main\n24.0.1+9-FR\nException in thread &quot;main&quot; java.lang.VerifyError: Inconsistent stackmap frames at branch target 96\nException Details:\n  Location:\n    VehicleProgressor.progress(LVehicleInput;LAnimal;)Z @96: aload_3\n  Reason:\n    Type top (current frame, locals[5]) is not assignable to 'Cat' (stack map, locals[5])\n  Current Frame:\n    bci: @50\n    flags: { }\n    locals: { 'VehicleProgressor', 'VehicleInput', 'Animal', 'Animal', integer }\n    stack: { integer }\n  Stackmap Frame:\n    bci: @96\n    flags: { }\n    locals: { 'VehicleProgressor', 'VehicleInput', 'Animal', 'Animal', integer, 'Cat' }\n    stack: { }\n  Bytecode:\n    0000000: 2bb6 0007 3a05 1905 c100 0d99 0015 1905\n    0000010: c000 0d4e 2db6 000f 3a06 1906 3a04 04ac\n    0000020: 2c59 b800 1357 4e03 3604 2d15 04ba 0019\n    0000030: 0000 ab00 0000 001a 0000 0002 0000 0000\n    0000040: 0000 0024 0000 0001 0000 002e bb00 1d59\n    0000050: 0101 b700 1fbf 2dc0 0022 3a05 04a7 000a\n    0000060: 2dc0 0024 3a06 04ac 4ebb 001d 592d b600\n    0000070: 282d b700 1fbf\n  Exception Handler Table:\n    bci [21, 24] =&gt; handler: 104\n  Stackmap Table:\n    same_frame(@32)\n    append_frame(@42,Object[#50],Integer)\n    same_frame(@76)\n    same_frame(@86)\n    append_frame(@96,Object[#34])\n    full_frame(@103,{Object[#43],Object[#8],Object[#50]},{Integer})\n    same_locals_1_stack_item_frame(@104,Object[#38])\n\n    at Main.main(Main.java:30)\n</code></pre>\n<p>Is this a bug in Java/JDK?</p>\n<p>If I change the class in the above code into:</p>\n<pre class=\"lang-java prettyprint-override\"><code>class VehicleProgressor {\n  private boolean progress(VehicleInput input, Animal animal) {\n    if (input.vehicle() instanceof Car) {\n      return true;\n    }\n\n    return switch (animal) {\n      case Cat cat -&gt; true;\n      case Dog dog -&gt; true;\n    };\n  }\n}\n</code></pre>\n<p>or into:</p>\n<pre class=\"lang-java prettyprint-override\"><code>class VehicleProgressor {\n  private boolean progress(VehicleInput input, Animal animal) {\n    if (input.vehicle() instanceof Car(String licensePlate)) {\n      return true;\n    }\n    return true;\n  }\n}\n</code></pre>\n<p>or into:</p>\n<pre class=\"lang-java prettyprint-override\"><code>class VehicleProgressor {\n  private boolean progress(Vehicle vehicle, Animal animal) {\n    if (vehicle instanceof Car(String licensePlate)) {\n      return true;\n    }\n\n    return switch (animal) {\n      case Cat cat -&gt; true;\n      case Dog dog -&gt; true;\n    };\n  }\n}\n</code></pre>\n<p>it runs fine just printing the version number.</p>\n<p>The super strange part is that I'm not even calling the <code>progress</code> method anywhere. I also tried having everything in separate files as <code>public</code> <code>interface</code>s/<code>record</code>s, but that made no difference.</p>\n",
    "tags" : [ "java", "javac", "java-24" ],
    "owner" : {
      "account_id" : 13634501,
      "reputation" : 24845,
      "user_id" : 9835872,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/k0ksC.jpg?s=256",
      "display_name" : "ruohola",
      "link" : "https://stackoverflow.com/users/9835872/ruohola"
    },
    "is_answered" : true,
    "view_count" : 342,
    "answer_count" : 1,
    "score" : 7,
    "last_activity_date" : 1758099390,
    "creation_date" : 1749045670,
    "link" : "https://stackoverflow.com/questions/79652927/why-does-using-instanceof-pattern-matching-on-a-record-field-with-a-switch-expre",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79653341,
    "question_id" : 79652927,
    "body" : "<p>Turned out to be a clear bug. Reported based on <a href=\"https://stackoverflow.com/users/3699139/jorn-vernee\">@Jorn Vernee</a>'s suggestion to <code>compiler-dev@openjdk.org</code>.</p>\n<p>Based on the commenters, seems to only be an issue with javac and not with Eclipse  Compiler for Java (ECJ).</p>\n<p><strong>Update:</strong> The bug could be reproduced with an even more minimal example; PR for the bugfix with additional details: <a href=\"https://github.com/openjdk/jdk/pull/25849\" rel=\"nofollow noreferrer\">https://github.com/openjdk/jdk/pull/25849</a></p>\n<p>Targeted to be included in version 26: <a href=\"https://bugs.openjdk.org/browse/JDK-8358801\" rel=\"nofollow noreferrer\">https://bugs.openjdk.org/browse/JDK-8358801</a></p>\n",
    "score" : 6,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 13634501,
      "reputation" : 24845,
      "user_id" : 9835872,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/k0ksC.jpg?s=256",
      "display_name" : "ruohola",
      "link" : "https://stackoverflow.com/users/9835872/ruohola"
    },
    "creation_date" : 1749063279,
    "last_activity_date" : 1750513742,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140742010,
    "post_id" : 79652927,
    "body" : "@StephenC Yeah that was a more general statement for explaining why ECJ and javac are different (not necessarily about what exactly happened here) and the JLS is more relevant for most differences (the JLS specifies what should happen given some source code after all) but yes, <i>in this case</i> the generated bytecode doesn&#39;t seem to satisfy the requirements from the JVMS (in other words, the code doesn&#39;t do what would be considered acceptable by the JLS given a JVMS compatible runtime). I guess I could have been clearer on that.",
    "score" : 0,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1758106351,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140741861,
    "post_id" : 79652927,
    "body" : "@dan1st - <i>&quot;(specifically the JLS)&quot;</i>.  In this case, it is the JVMS that governs.  The compiler is emitting code that doesn&#39;t conform to the requirements of section 4.10 of the Java Virtual Machine Specification in some way.  That leads to the verification error.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1758103402,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487895,
    "post_id" : 79652927,
    "body" : "@user85421 Yep, that&#39;s clear now after the more extensive testing. Perhaps the new title can be answered with an interesting recap from the eventual bug fix.",
    "score" : 0,
    "owner" : {
      "account_id" : 13634501,
      "reputation" : 24845,
      "user_id" : 9835872,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/k0ksC.jpg?s=256",
      "display_name" : "ruohola",
      "link" : "https://stackoverflow.com/users/9835872/ruohola"
    },
    "creation_date" : 1749061104,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487881,
    "post_id" : 79652927,
    "body" : "&quot;<i>Is this a bug in Java/JDK?</i>&quot; -- Yes (from the <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/VerifyError.html\" rel=\"nofollow noreferrer\">javadoc</a> of <code>VerifyError</code>: &quot;<i>Thrown when the &quot;verifier&quot; detects that a class file, though well formed, contains some sort of internal inconsistency or security problem.</i>&quot;)",
    "score" : 3,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1749060956,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487440,
    "post_id" : 79652927,
    "body" : "@JorgeCampos Both compilers are pretty much independent so they have different bugs. They are just both written in an attempt to adhere to the same specifications (specifically the JLS). Sometimes EJC is right and sometimes javac is right. Having multiple compilers can be useful as a mutual quality check - if they behave differently, one of them likely has a bug (or in very rare cases, the specification might not be exactly clear for example on whether <code>record Abc(){}</code> is a valid <code>module-info.java</code> IIRC).",
    "score" : 3,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1749053857,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487431,
    "post_id" : 79652927,
    "body" : "@dan1st thanks for the info, had read that somewhere and forgot about it, though it is still interesting that EJC will compile it for v21 without having the same problem.",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1749053677,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487398,
    "post_id" : 79652927,
    "body" : "@JorgeCampos The Eclipse IDE uses the Eclipse Java Compiler (EJC) and not javac.",
    "score" : 1,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1749053059,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487176,
    "post_id" : 79652927,
    "body" : "An interesting thing happened here. I&#39;ve tried this code on Eclipse IDE <code>2024-09 (4.33.0)</code> in a maven project configured to use JavaSE-21 more precisely 21.0.5+11-LTS from Temurin dist <code>21.0.5-tem</code> Compiling and running it on on Eclipse IDE worked fine. But it failed using the terminal (javac/java): <a href=\"https://imgur.com/a/xVBPVhE\" rel=\"nofollow noreferrer\">imgur.com/a/xVBPVhE</a> (I&#39;m using sdkman.io for my java versions)",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1749049740,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140487021,
    "post_id" : 79652927,
    "body" : "Could you please report this issue to <code>compiler-dev@openjdk.org</code> or report it through the Oracle bug tracker at <code>bugreport.java.com</code>. Thanks",
    "score" : 7,
    "owner" : {
      "account_id" : 4555218,
      "reputation" : 34325,
      "user_id" : 3699139,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4a510c6ed90917ec02dd4d572cf9e78c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Jorn Vernee",
      "link" : "https://stackoverflow.com/users/3699139/jorn-vernee"
    },
    "creation_date" : 1749046952,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140486949,
    "post_id" : 79652927,
    "body" : "I don&#39;t think the compiler is expected to produce invalid bytecode for <i>any</i> source code. The JVM verifies a class file during <i>link time</i>, so whether or not you call <code>progress</code> is irrelevant.",
    "score" : 7,
    "owner" : {
      "account_id" : 6651855,
      "reputation" : 292025,
      "user_id" : 5133585,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/dfqcw.png?s=256",
      "display_name" : "Sweeper",
      "link" : "https://stackoverflow.com/users/5133585/sweeper"
    },
    "creation_date" : 1749046187,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}