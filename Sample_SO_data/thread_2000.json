{
  "question" : {
    "question_id" : 79656710,
    "title" : "Grpc netty always establishing TLS1.2 even if configured TLS1.3 in ssl context in both server and client",
    "body" : "<p>I am using NettyChannelBuilder in grpc client and NettyServerBuilder in grpc server.</p>\n<p>I have created NettyServerBuilder with sslcontext with TLS1.3 and started the server as below</p>\n<pre><code>import io.grpc.ServerCredentials;\nimport io.grpc.TlsServerCredentials;\nimport io.grpc.netty.shaded.io.netty.handler.ssl.SslContext;\nimport io.grpc.netty.shaded.io.netty.handler.ssl.SslContextBuilder;\nimport io.grpc.util.AdvancedTlsX509TrustManager;\nimport io.grpc.Server;\nimport io.grpc.netty.shaded.io.grpc.netty.NettyServerBuilder;\nimport io.grpc.netty.shaded.io.netty.handler.ssl.SslContext;\nimport io.grpc.stub.StreamObserver;\n\nprivate Server myServer;\nCertificateData grpcCertificateData = CertificateData.SERVER_CERT;\ntry {\n    KeyManager serverKeyManager = myCertificateHandlerService.getServerKeyManagers(grpcCertificateData.getServiceGroup())[0];\n    LOG.info(&quot;Retrieved key manager: {}&quot;, serverKeyManager);\n    X509TrustManager trustManager =\n        (X509TrustManager) myCertificateHandlerService.getServerTrustManagers(grpcCertificateData.getServiceGroup())[0];\n    X509Certificate[] acceptedIssuers = trustManager.getAcceptedIssuers();\n    LOG.info(&quot;Retrieved CA certificates: {}&quot;, acceptedIssuers);\n    SslContextBuilder builder = SslContextBuilder.forServer(serverKeyManager)\n        .trustManager(trustManager)\n        .clientAuth(ClientAuth.REQUIRE)\n        .ciphers(CIPHER_SUITES_SUPPORTED)\n        .protocols(TLS_VERSION_1_3); // Explicitly set TLSv1.3\n    .sslProvider(SslProvider.JDK);\n    NettyServerBuilder.forPort(PORT)\n        .sslContext(GrpcSslContexts.configure(builder).build())\n        .addService(new LoadReportingRpcService());\n    myServer = serverBuilder.directExecutor().build();\n    myServer.start();\n} catch (Exception e) {\n    LimitedLogger.logOrSuppressError(LOG, LOG_MESSAGE_DATA, &quot;Failed to build SSL context {}&quot;, e);\n}\n</code></pre>\n<p>Also I have created NettyChannelBuilder with sslContext with TLS1.3 and invoked rpc method in grpc server as below</p>\n<pre><code>import io.grpc.LoadBalancerRegistry;\nimport io.grpc.ManagedChannel;\nimport io.grpc.ManagedChannelBuilder;\nimport io.grpc.NameResolverRegistry;\nimport io.grpc.StatusRuntimeException;\nimport io.grpc.internal.DnsNameResolverProvider;\nimport io.grpc.internal.PickFirstLoadBalancerProvider;\nimport io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\nimport io.grpc.netty.shaded.io.netty.handler.ssl.SslContext;\nimport io.grpc.stub.StreamObserver;\n\nString serviceGroup = CertificateData.CERT_CLIENT.getServiceGroup();\ntry {\n    TrustManager[] caTrustManagers = myCertificateHandlerService.getServerTrustManagers(serviceGroup);\n    KeyManager[] clientKeyManagers = myCertificateHandlerService.getClientKeyManagers(serviceGroup);\n    if (caTrustManagers == null || clientKeyManagers == null) {\n        LOG.error(&quot;NN Failed to retrieve PKI components. Server trust manager was {}, client key manager was {}, for service group {}&quot;,\n            caTrustManagers,\n            clientKeyManagers,\n            serviceGroup);\n    } else {\n        LOG.error(&quot;NN Configure TLS1.3 client&quot;);\n        X509TrustManager caTrustManager = (X509TrustManager) caTrustManagers[0];\n        KeyManager keyManager = clientKeyManagers[0];\n        SslContextBuilder sslContextBuilder = SslContextBuilder.forClient()\n            .trustManager(caTrustManager)\n            .keyManager(keyManager)\n            .protocols(TLS_VERSION_1_3);\n        .sslProvider(SslProvider.JDK)\n            .ciphers(CIPHER_SUITES_SUPPORTED);\n        ManagedChannelBuilder &lt;&lt; ? &gt; channelBuilder = NettyChannelBuilder.forAddress(target, GRPC_PORT);\n        channelBuilder.directExecutor();\n        LOG.error(&quot;NN tls enabled {}&quot;, isTlsEnabled());\n        if (isTlsEnabled()) {\n            LOG.error(&quot;NN tls enabled and start secure grpc client&quot;);\n            ((NettyChannelBuilder) channelBuilder).sslContext(GrpcSslContexts.configure(sslContextBuilder).build())).useTransportSecurity();\n    }\n    foundChannel = channelBuilder.build();\n    ReportingServiceGrpc.ReportingServiceStub stub = ReportingServiceGrpc.newStub(foundChannel);\n    stub.invokeRpcMethod();\n}\n} catch (Exception e) {\n    LOG.error(&quot;Failed to create ssl context for {}&quot;, serviceGroup, e);\n}\n</code></pre>\n<p>I was using below TLS1.3 ciphers in both server and client</p>\n<pre><code>private static final Iterable &lt; String &gt; CIPHER_SUITES_SUPPORTED =\n         Arrays.asList(&quot;TLS_AES_256_GCM_SHA384&quot;, &quot;TLS_AES_128_GCM_SHA256&quot;,\n             &quot;TLS_CHACHA20_POLY1305_SHA256&quot;);\n</code></pre>\n<p>But observed that TLS1.2 connection is established always from client to server communication. Here i have configured with TLS1.3 in sslcontext in both client and server and i am using java 11. It should establish TLS1.3 right?</p>\n<p>is it a bug in GRPC?   Otherwise please clarify me with the solution with what am i missing ?</p>\n",
    "tags" : [ "java", "grpc", "netty", "grpc-java", "tls1.3" ],
    "owner" : {
      "account_id" : 20577733,
      "reputation" : 41,
      "user_id" : 15104532,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3d079cc3b0100ba20be099c5a42ee88e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ganesh91",
      "link" : "https://stackoverflow.com/users/15104532/ganesh91"
    },
    "is_answered" : false,
    "view_count" : 54,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1749613236,
    "creation_date" : 1749276945,
    "link" : "https://stackoverflow.com/questions/79656710/grpc-netty-always-establishing-tls1-2-even-if-configured-tls1-3-in-ssl-context-i",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140504265,
    "post_id" : 79656710,
    "body" : "Anyone pls check and reply for this query?",
    "score" : 0,
    "owner" : {
      "account_id" : 20577733,
      "reputation" : 41,
      "user_id" : 15104532,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3d079cc3b0100ba20be099c5a42ee88e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ganesh91",
      "link" : "https://stackoverflow.com/users/15104532/ganesh91"
    },
    "creation_date" : 1749613135,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}