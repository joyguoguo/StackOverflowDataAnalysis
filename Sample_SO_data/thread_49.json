{
  "question" : {
    "question_id" : 79832652,
    "title" : "Can&#39;t open more than 8000 TCP connections with Java",
    "body" : "<p>I am trying to open to open 10K+ connections to a server, but my app stops at 8K connections when looking at the server logs. When using two remote servers, it will struggles when reaching between 8K and 9K connections. This makes me belief the problem is on the client side.</p>\n<p>I tried the following settings on the client:</p>\n<ul>\n<li><p>Setting the ephemeral ports:net.ipv4.ip_local_port_range = 32768 60999</p>\n</li>\n<li><p>Setting the ulimit to 65535</p>\n</li>\n</ul>\n<p>But still my Java application can't open more than 8K outgoing connections.</p>\n<p>Some experimenting showed that:</p>\n<ul>\n<li><p>Doing a little less than 8K in rapid succession is fine.</p>\n</li>\n<li><p>Doing 8.1K requests causes a 30 delay before it continues with only little bursts.</p>\n</li>\n<li><p>During the tests the machine never runs out of CPU or memory. During the delay it goes back to running at an idle 1-2%.</p>\n</li>\n<li><p>No error or exception is being thrown.</p>\n</li>\n</ul>\n<p>The code:</p>\n<pre><code>import java.io.IOException;\nimport java.net.URI;\nimport java.net.URL;\nimport java.net.http.HttpClient;\nimport java.net.http.HttpRequest;\nimport java.net.http.HttpResponse;\nimport java.time.Duration;\nimport java.util.concurrent.ExecutorService;\nimport java.util.concurrent.Executors;\nimport java.util.stream.IntStream;\n\npublic class SimpleRunner {\n    HttpClient client = HttpClient.newBuilder()\n            .version(HttpClient.Version.HTTP_1_1)\n            .followRedirects(HttpClient.Redirect.NORMAL)\n            .connectTimeout(Duration.ofDays(1))\n            .build();\n\n\n    public void main(String... args) throws IOException {\n        long pid = ProcessHandle.current().pid();\n        System.out.println(&quot;pid = &quot; + pid);\n\n        try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {\n            benchmarkingMethod(executor);\n        }\n    }\n\n\n    private void benchmarkingMethod(ExecutorService executor) {\n        IntStream.range(0, 10_000).forEach(i -&gt;\n                executor.submit(() -&gt; {\n                    try {\n                        String response1 =  fetchJavaNineStyle(URI.create(&quot;http://localhost:8080/v1/delay/0&quot;).toURL());\n                    } catch (Exception e) {\n                        throw new RuntimeException(e);\n                    }\n                })\n        );\n    }\n\n    String fetchJavaNineStyle(URL url){\n        try {\n            return client.sendAsync(HttpRequest.newBuilder().GET().uri(url.toURI()).build(), HttpResponse.BodyHandlers.ofString()).get().body();\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "tcp", "limit" ],
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "is_answered" : false,
    "view_count" : 178,
    "closed_date" : 1764643064,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1764642570,
    "creation_date" : 1764340056,
    "link" : "https://stackoverflow.com/questions/79832652/cant-open-more-than-8000-tcp-connections-with-java",
    "closed_reason" : "Not suitable for this site"
  },
  "answers" : [ {
    "answer_id" : 79832656,
    "question_id" : 79832652,
    "body" : "<p>write a service unit for systemd and put it into system slice (/etc/systemd/system).<br />\nas long as you execute it under a user (even root), you will be restricted.</p>\n",
    "score" : -1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 26544556,
      "reputation" : 362,
      "user_id" : 20174801,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e3f952db11e56496176482f3c0122776?s=256&d=identicon&r=PG",
      "display_name" : "Synopsis",
      "link" : "https://stackoverflow.com/users/20174801/synopsis"
    },
    "creation_date" : 1764340331,
    "last_activity_date" : 1764340331,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140882406,
    "post_id" : 79832652,
    "body" : "Iâ€™m voting to close this question because it was a problem on the server side, not their code - see their deleted answer: <a href=\"https://stackoverflow.com/a/79834768/1394729\">stackoverflow.com/a/79834768/1394729</a>",
    "score" : 2,
    "owner" : {
      "account_id" : 1486587,
      "reputation" : 15586,
      "user_id" : 1394729,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/B9Ri8.jpg?s=256",
      "display_name" : "tink",
      "link" : "https://stackoverflow.com/users/1394729/tink"
    },
    "creation_date" : 1764636257,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881762,
    "post_id" : 79832652,
    "body" : "@aled Yeah thats probably the case. Thanks for the link!",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764606444,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881468,
    "post_id" : 79832652,
    "body" : "The one client could be out of some resources or hitting some limits. It may not be related to the program. You are testing the limits on the client rather than the servers. You should try some distributed client testing. See this article related to this topic: <a href=\"https://serverframework.com/asynchronousevents/2010/10/how-to-support-10000-or-more-concurrent-tcp-connections---part-2---perf-tests-from-day-0.html\" rel=\"nofollow noreferrer\">serverframework.com/asynchronousevents/2010/10/&hellip;</a>. Note that it doesn&#39;t look like this question is about programming but about designing the right test architecture. Probably not a good fit for <a href=\"https://stackoverflow.com\">Stack Overflow</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1764598178,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140881012,
    "post_id" : 79832652,
    "body" : "@aled I tried 3 physical machines 2 servers and 1 client. Using two servers I got around 9K total. Still stalled in the end",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764578646,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140880501,
    "post_id" : 79832652,
    "body" : "How many physical clients and servers are you using?",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1764535412,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140879888,
    "post_id" : 79832652,
    "body" : "@Aled Using C I get the same result",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764495506,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877967,
    "post_id" : 79832652,
    "body" : "If you try the same in other languages do you get the same result?",
    "score" : 3,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1764350457,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877861,
    "post_id" : 79832652,
    "body" : "@Robert I tried both Java 21 and 25 and the result is the same",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764346179,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877851,
    "post_id" : 79832652,
    "body" : "What Java version is used to run the program?",
    "score" : 0,
    "owner" : {
      "account_id" : 50585,
      "reputation" : 43459,
      "user_id" : 150978,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
      "display_name" : "Robert",
      "link" : "https://stackoverflow.com/users/150978/robert"
    },
    "creation_date" : 1764345689,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877849,
    "post_id" : 79832652,
    "body" : "@Robert Expect for the imports, its everything. The server is also a basic Spring app with a single endpoint. Nothing special.",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764345471,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877841,
    "post_id" : 79832652,
    "body" : "@Robert The application exits when the last request has finished. But it takes ages to get to that point",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764345192,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877732,
    "post_id" : 79832652,
    "body" : "@SteffenUllrich -n returns 65535 and -u returns 256115",
    "score" : 0,
    "owner" : {
      "account_id" : 9717480,
      "reputation" : 17,
      "user_id" : 7207333,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "davidto",
      "link" : "https://stackoverflow.com/users/7207333/davidto"
    },
    "creation_date" : 1764341502,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140877725,
    "post_id" : 79832652,
    "body" : "*&quot;Setting the ulimit to 65535&quot; - what is the output of <code>ulimit -n</code> after you&#39;ve made this change? And what is the output of <code>ulimit -u</code> (limit on processes/threads)?",
    "score" : 0,
    "owner" : {
      "account_id" : 3701398,
      "reputation" : 125076,
      "user_id" : 3081018,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Z2NYm.png?s=256",
      "display_name" : "Steffen Ullrich",
      "link" : "https://stackoverflow.com/users/3081018/steffen-ullrich"
    },
    "creation_date" : 1764341099,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79832656" : [ {
      "comment_id" : 140879466,
      "post_id" : 79832656,
      "body" : "And in the service unit: [Service]    TasksMax=infinity",
      "score" : 0,
      "owner" : {
        "account_id" : 26544556,
        "reputation" : 362,
        "user_id" : 20174801,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e3f952db11e56496176482f3c0122776?s=256&d=identicon&r=PG",
        "display_name" : "Synopsis",
        "link" : "https://stackoverflow.com/users/20174801/synopsis"
      },
      "creation_date" : 1764451710,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140879463,
      "post_id" : 79832656,
      "body" : "/etc/sysctl.conf: kernel.threads-max = 200000    kernel.pid_max = 200000",
      "score" : 0,
      "owner" : {
        "account_id" : 26544556,
        "reputation" : 362,
        "user_id" : 20174801,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e3f952db11e56496176482f3c0122776?s=256&d=identicon&r=PG",
        "display_name" : "Synopsis",
        "link" : "https://stackoverflow.com/users/20174801/synopsis"
      },
      "creation_date" : 1764451657,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140879462,
      "post_id" : 79832656,
      "body" : "What says &#39;cat /proc/sys/kernel/threads-max&#39; ?",
      "score" : 0,
      "owner" : {
        "account_id" : 26544556,
        "reputation" : 362,
        "user_id" : 20174801,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/e3f952db11e56496176482f3c0122776?s=256&d=identicon&r=PG",
        "display_name" : "Synopsis",
        "link" : "https://stackoverflow.com/users/20174801/synopsis"
      },
      "creation_date" : 1764451496,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140877824,
      "post_id" : 79832656,
      "body" : "Did not do the trick, it still hangs at 8K threads",
      "score" : 0,
      "owner" : {
        "account_id" : 9717480,
        "reputation" : 17,
        "user_id" : 7207333,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/4ebc6ab660b287803e50b763ac666e08?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "davidto",
        "link" : "https://stackoverflow.com/users/7207333/davidto"
      },
      "creation_date" : 1764344287,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}