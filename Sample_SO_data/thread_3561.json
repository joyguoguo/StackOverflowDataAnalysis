{
  "question" : {
    "question_id" : 79540500,
    "title" : "How does Java handle weak reference with cycle?",
    "body" : "<p>Suppose I have objects A and B which strong/regular reference each others, forming a reference cycle. The path from A to the GC root is dominated by a weak reference (represented by the dashed arrow in the image below). In this case, what is the reachability of object A?</p>\n<p>Specifically, if I call <code>java.lang.ref.Cleaner.register(A, cleanup_action)</code>, is cleanup_action going to run? (the document specifies that only happens when A is <em>phantom reachable</em>)</p>\n<p><a href=\"https://i.sstatic.net/yrVQhoQ0.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/yrVQhoQ0.png\" alt=\"illustration of the reference graph\" /></a></p>\n",
    "tags" : [ "java", "garbage-collection" ],
    "owner" : {
      "account_id" : 3953309,
      "reputation" : 1554,
      "user_id" : 3262785,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://i.sstatic.net/XqvLk.jpg?s=256",
      "display_name" : "sqd",
      "link" : "https://stackoverflow.com/users/3262785/sqd"
    },
    "is_answered" : true,
    "view_count" : 98,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1745579913,
    "creation_date" : 1743135026,
    "link" : "https://stackoverflow.com/questions/79540500/how-does-java-handle-weak-reference-with-cycle",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79540567,
    "question_id" : 79540500,
    "body" : "<blockquote>\n<p>How does Java handle weak reference with cycle?</p>\n</blockquote>\n<p>Correctly.  And consistently with the way that the GC handles cycles in general.</p>\n<p><sup>I am assuming that you are not asking about how the JVM / GC implements <code>Reference</code> classes and their special behavior.  But even at that level, cycles involving <code>Reference</code> objects are dealt with the same way as cycles that don't involve <code>Reference</code> objects.</sup></p>\n<p>In your example, you registered A with the cleaner, so A will be &quot;cleaned&quot;, and the existence of the cycle involving another phantom reachable object (B) doesn't change that.</p>\n<blockquote>\n<p>In this case, what is the reachability of object A?</p>\n</blockquote>\n<p>It is weakly reachable ... unless A or B are strongly reachable via references that you haven't shown.</p>\n<blockquote>\n<p>Specifically, if I call <code>java.lang.ref.Cleaner.register(A, cleanup_action)</code> is cleanup_action going to run?</p>\n</blockquote>\n<p>The cleanup action registered with the cleaner should happen after the weak reference has been broken and the GC detects that A is now only phantom reachable.  That will probably be <em>after</em> a GC run <em>after</em> the weak reference has been broken.</p>\n<p>You can view the phantom reference that is created when you register an object with a cleaner as being &quot;internal&quot; to the cleaner.  Either way, the cleaner doesn't do its thing until the object is phantom reachable; i.e. it is no longer strongly, softly or weakly reachable.  And ... of course ... the cleaner only knows about the <code>PhantomReference</code> objects that it created itself.</p>\n<hr />\n<blockquote>\n<p>The path from A to the GC root is dominated by a weak reference ...</p>\n</blockquote>\n<p>Actually, reachability paths <em>start</em> at a GC root.  I don't think this is at root of your uncertainty, but it is a good idea to use the terminology correctly.  It makes it easier for other people to understand what you are trying to saying.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1743138540,
    "last_activity_date" : 1745579913,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140290341,
    "post_id" : 79540500,
    "body" : "“<i>The path from A to the GC root is dominated by a weak reference</i>” This is the wrong thinking. There is no path from the object to the root. It’s always the other way round. You (or rather the JVM does) check all paths from all GC roots to the object. Is there a path from a root to the object entirely consisting of strong references? Then, the object strongly reachable. Since this does not apply, neither to A nor to B, both are weakly reachable.",
    "score" : 1,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300981,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1743596001,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140282968,
    "post_id" : 79540500,
    "body" : "My goodness.  Whomever decided to close this as &quot;needs to be more focused&quot; is absolutely ridiculous.",
    "score" : 2,
    "owner" : {
      "account_id" : 2687220,
      "reputation" : 1714,
      "user_id" : 2321368,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/02976c5560774d0fd4336cc6e4fad075?s=256&d=identicon&r=PG",
      "display_name" : "dan.m was user2321368",
      "link" : "https://stackoverflow.com/users/2321368/dan-m-was-user2321368"
    },
    "creation_date" : 1743432321,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}