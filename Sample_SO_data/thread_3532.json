{
  "question" : {
    "question_id" : 79542567,
    "title" : "How to configure SpringBoot and Keycloak pod in kubernetes for successful authentication flow?",
    "body" : "<p>I want to configure SpringBoot Thymeleaf app together with Keycloak in the kubernetes namespace that runs on my local computer. In the way that Springboot app runs on its own pod and Keycloak app on its own pod and they communicate with each other in order to authenticate users and etc... I do not know how to correctly configure SpringBoot with Keycloak in my local k8s cluster so they can successfully communicate with each other.</p>\n<p>Here is what I have:</p>\n<ol>\n<li>My <code>pom.xml</code></li>\n</ol>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;3.4.1&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;pl.jacekhorabik&lt;/groupId&gt;\n    &lt;artifactId&gt;urlshortener&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;urlshortener&lt;/name&gt;\n    &lt;description&gt;urlshortener&lt;/description&gt;\n\n    &lt;properties&gt;\n        &lt;java.version&gt;21&lt;/java.version&gt;\n        &lt;commons-codec.commons-codec.version&gt;1.17.1&lt;/commons-codec.commons-codec.version&gt;\n        &lt;io.seruco.encoding.base62.version&gt;0.1.3&lt;/io.seruco.encoding.base62.version&gt;\n        &lt;org.jetbrains.annotations.version&gt;13.0&lt;/org.jetbrains.annotations.version&gt;\n        &lt;org.liquibase.liquibase-maven-plugin.version&gt;4.27.0&lt;/org.liquibase.liquibase-maven-plugin.version&gt;\n        &lt;org.keycloak.keycloak-spring-boot-starter.version&gt;25.0.3&lt;/org.keycloak.keycloak-spring-boot-starter.version&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencies&gt;\n        &lt;!--    spring-boot-starter    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-data-jpa&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-thymeleaf&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-oauth2-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.keycloak&lt;/groupId&gt;\n            &lt;artifactId&gt;keycloak-spring-boot-starter&lt;/artifactId&gt;\n            &lt;version&gt;${org.keycloak.keycloak-spring-boot-starter.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;!--    spring-boot-starter-test    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.security&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-security-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;!--    database    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.liquibase&lt;/groupId&gt;\n            &lt;artifactId&gt;liquibase-core&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.h2database&lt;/groupId&gt;\n            &lt;artifactId&gt;h2&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.mysql&lt;/groupId&gt;\n            &lt;artifactId&gt;mysql-connector-j&lt;/artifactId&gt;\n            &lt;scope&gt;runtime&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;!--    frontend    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.thymeleaf.extras&lt;/groupId&gt;\n            &lt;artifactId&gt;thymeleaf-extras-springsecurity6&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;!--    encoding    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;commons-codec&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-codec&lt;/artifactId&gt;\n            &lt;version&gt;${commons-codec.commons-codec.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.seruco.encoding&lt;/groupId&gt;\n            &lt;artifactId&gt;base62&lt;/artifactId&gt;\n            &lt;version&gt;${io.seruco.encoding.base62.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;!--    annotations    --&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.jetbrains&lt;/groupId&gt;\n            &lt;artifactId&gt;annotations&lt;/artifactId&gt;\n            &lt;version&gt;${org.jetbrains.annotations.version}&lt;/version&gt;\n            &lt;scope&gt;compile&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n&lt;/project&gt; \n</code></pre>\n<ol start=\"2\">\n<li>My spring security config in <code>application.yml</code>:</li>\n</ol>\n<pre><code>spring:\n  security:\n    oauth2:\n      client:\n        provider:\n          urlshortener-keycloak-provider:\n            issuer-uri: http://urlshortener-keycloak-service.urlshortener-dev:8080/realms/urlshortener-keycloak-realm\n        registration:\n          keycloak:\n            provider: urlshortener-keycloak-provider\n            authorization-grant-type: authorization_code\n            client-id: urlshortener-keycloak-client\n            client-secret: secret\n            scope: openid\n</code></pre>\n<ol start=\"3\">\n<li>My <code>SecurityConfig.java</code> class:</li>\n</ol>\n<pre><code>import org.jetbrains.annotations.NotNull;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.oauth2.client.oidc.web.logout.OidcClientInitiatedLogoutSuccessHandler;\nimport org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\nimport org.springframework.security.web.SecurityFilterChain;\n\n@Configuration\n@EnableWebSecurity\nclass SecurityConfig {\n\n  @Bean\n  SecurityFilterChain clientSecurityFilterChain(\n      @NotNull HttpSecurity http, ClientRegistrationRepository clientRegistrationRepository)\n      throws Exception {\n    http.oauth2Login(\n        login -&gt; {\n          login.defaultSuccessUrl(&quot;/v1/&quot;);\n        });\n    http.logout(\n        logout -&gt; {\n          final var logoutSuccessHandler =\n              new OidcClientInitiatedLogoutSuccessHandler(clientRegistrationRepository);\n          logoutSuccessHandler.setPostLogoutRedirectUri(&quot;{baseUrl}/v1/&quot;);\n          logout.logoutSuccessHandler(logoutSuccessHandler);\n        });\n\n    http.authorizeHttpRequests(\n        requests -&gt; {\n          requests.requestMatchers(&quot;/v1/**&quot;, &quot;/actuator/health&quot;, &quot;/favicon.ico&quot;).permitAll();\n          requests.requestMatchers(&quot;/admin&quot;).hasAuthority(&quot;ADMIN&quot;);\n          requests.requestMatchers(&quot;/user&quot;).hasAuthority(&quot;USER&quot;);\n          requests.anyRequest().denyAll();\n        });\n    return http.build();\n  }\n}\n</code></pre>\n<ol start=\"4\">\n<li>Keycloak Docker image I use, with my own realm import:</li>\n</ol>\n<pre><code>FROM quay.io/keycloak/keycloak:25.0.1\n\nEXPOSE 8080/tcp\n\nENV KEYCLOAK_ADMIN=&quot;admin&quot;\nENV KEYCLOAK_ADMIN_PASSWORD=&quot;admin&quot;\n\nADD ./realm/urlshortener-keycloak-realm.json /opt/keycloak/data/import/\n\nCMD [ &quot;start&quot;, \\\n&quot;--verbose&quot;, \\\n&quot;--features&quot;, &quot;hostname:v2&quot;, \\\n&quot;--http-port&quot;, &quot;8080&quot;, \\\n&quot;--hostname&quot; , &quot;localhost&quot;, \\\n&quot;--hostname-debug&quot;, &quot;true&quot;, \\\n&quot;--http-relative-path&quot;, &quot;/&quot;, \\\n&quot;--http-enabled&quot;, &quot;true&quot;, \\\n&quot;--health-enabled&quot;, &quot;true&quot;, \\\n&quot;--metrics-enabled&quot;, &quot;true&quot;, \\\n&quot;--import-realm&quot;, \\\n&quot;--db&quot;, &quot;mysql&quot;, \\\n&quot;--db-username&quot;, &quot;keycloak-admin&quot;, \\\n&quot;--db-password&quot;, &quot;password&quot;, \\\n&quot;--db-url-host&quot;, &quot;urlshortener-db-service.urlshortener-dev&quot;, \\\n&quot;--db-schema&quot;, &quot;keycloak&quot;, \\\n&quot;--db-url-port&quot;, &quot;3306&quot; \\\n]\n</code></pre>\n<p>Now k8s resources:</p>\n<ol start=\"5\">\n<li>K8s namespace, SpringBoot app deployment and service &amp; Keycloak deployment and service:</li>\n</ol>\n<pre><code>apiVersion: v1\nkind: Namespace\nmetadata:\n  name: urlshortener-dev\n  \n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: urlshortener-backend-deployment\n  labels:\n    app: urlshortener\n    layer: backend\n  namespace: urlshortener-dev\nspec:\n  template:\n    metadata:\n      name: urlshortener-backend-pod\n      labels:\n        app: urlshortener\n        layer: backend\n    spec:\n      containers:\n        - image: urlshortener-backend:latest\n          name: urlshortener-backend-container\n          ports:\n            - containerPort: 8080\n          imagePullPolicy: IfNotPresent\n  replicas: 1\n  selector:\n    matchLabels:\n      app: urlshortener\n      layer: backend\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 0\n      maxSurge: 1\n\n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: urlshortener-backend-service\n  namespace: urlshortener-dev\n  labels:\n    app: urlshortener\n    layer: backend\nspec:\n  ports:\n    - port: 8080\n      protocol: TCP\n      targetPort: 8080\n      nodePort: 30008\n  selector:\n    app: urlshortener\n    layer: backend\n  type: NodePort\n\n---\n\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: urlshortener-keycloak-deployment\n  labels:\n    app: urlshortener\n    layer: keycloak\n  namespace: urlshortener-dev\nspec:\n  template:\n    metadata:\n      name: urlshortener-backend-pod\n      labels:\n        app: urlshortener\n        layer: keycloak\n    spec:\n      containers:\n        - image: urlshortener-keycloak:latest\n          name: urlshortener-keycloak-container\n          ports:\n            - containerPort: 8080\n          imagePullPolicy: IfNotPresent\n  replicas: 1\n  selector:\n    matchLabels:\n      app: urlshortener\n      layer: keycloak\n  strategy:\n    type: RollingUpdate\n    rollingUpdate:\n      maxUnavailable: 0\n      maxSurge: 1\n  \n---\n\napiVersion: v1\nkind: Service\nmetadata:\n  name: urlshortener-keycloak-service\n  namespace: urlshortener-dev\n  labels:\n    app: urlshortener\n    layer: keycloak\nspec:\n  ports:\n    - protocol: TCP\n      port: 8080\n      targetPort: 8080\n      nodePort: 30009\n  selector:\n    app: urlshortener\n    layer: keycloak\n  type: NodePort\n  \n</code></pre>\n<p>As you can see I also have MySQL db deployed in this k8s namespace, but it does not matter in the context of this problem.\nYou can browse the code here <a href=\"https://github.com/HorabikJ/urlshortener/tree/stackoverflow-question\" rel=\"nofollow noreferrer\">https://github.com/HorabikJ/urlshortener/tree/stackoverflow-question</a>, it is my public repo for this project.\nIf you want to start the k8s setup please run <code>./k8s-run.sh</code> in the root of the repo.</p>\n<p>When I start this setup, I get below error log from SpringBoot app pod (<code>urlshortener-backend-deployment</code>):</p>\n<pre><code>Caused by: org.springframework.beans.BeanInstantiationException:\n Failed to instantiate [org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository]:\n Factory method 'clientRegistrationRepository' threw exception with message:\n The Issuer &quot;http://localhost:8080/realms/urlshortener-keycloak-realm&quot;\n provided in the configuration metadata did not match the requested issuer\n &quot;http://urlshortener-keycloak-service.urlshortener-dev:8080/realms/urlshortener-keycloak-realm&quot;\n</code></pre>\n<p>How I can setup correct Keycloak url in Springboot app so it can can communicate with Keycloak pod and redirect users to login using Keycloak console and after succesfull login redirect back to SpringBoot?</p>\n",
    "tags" : [ "java", "spring-boot", "kubernetes", "keycloak" ],
    "owner" : {
      "account_id" : 14039231,
      "reputation" : 23,
      "user_id" : 10141116,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-uhzLZwrKaL8/AAAAAAAAAAI/AAAAAAAAAAA/AAnnY7o1mwcDI51j4dFpOs08H-yRKACSTQ/mo/s256-rj/photo.jpg",
      "display_name" : "Jasiu",
      "link" : "https://stackoverflow.com/users/10141116/jasiu"
    },
    "is_answered" : false,
    "view_count" : 108,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743343982,
    "creation_date" : 1743203799,
    "link" : "https://stackoverflow.com/questions/79542567/how-to-configure-springboot-and-keycloak-pod-in-kubernetes-for-successful-authen",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140292853,
    "post_id" : 79542567,
    "body" : "<a href=\"https://www.baeldung.com/spring-boot-keycloak\" rel=\"nofollow noreferrer\">baeldung.com/spring-boot-keycloak</a> paying attention to what is set as hostname in the docker file for Keycloak",
    "score" : 0,
    "owner" : {
      "account_id" : 308139,
      "reputation" : 13879,
      "user_id" : 619830,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/f4d00b0a82e9307b1d68b29867fee4e5?s=256&d=identicon&r=PG",
      "display_name" : "ch4mp",
      "link" : "https://stackoverflow.com/users/619830/ch4mp"
    },
    "creation_date" : 1743645527,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}