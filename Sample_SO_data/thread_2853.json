{
  "question" : {
    "question_id" : 79590199,
    "title" : "Graal.js returns SafeInteger, causes !(result instanceof TruffleObject) assertion to fail in TestNG but pass in standalone Java app",
    "body" : "<p>We're migrating legacy code from Nashorn to Graal.js, and facing issues with how numeric values are mapped internally. In Nashorn, large numbers like 15-digit integers were mapped to java.lang.Double. Now, with Graal.js, those are being interpreted as SafeInteger, which implements TruffleObject.</p>\n<p>This breaks the following assertion in our polyglot interop logic:</p>\n<p>assert !(result instanceof TruffleObject);\nWhat’s confusing is that this assertion fails during TestNG tests, but passes when run as a standalone Java application —  the returned value is a SafeInteger in standalone and gets null when in test environment.</p>\n<p>Here’s a simplified test case:</p>\n<pre><code>@Test\npublic static void test() throws ScriptException {\n    Scope scope = ScriptManager.createScope();\n    \n    String test = &quot;314159265358979&quot;;\n\n    scope.setValue(new Variable(&quot;maxPrecisionJavascript&quot;, DataType.NUMBER), test);\n    Expression expr1 = ScriptManager.createExpression(&quot;result = maxPrecisionJavascript;&quot;);\n    expr1.eval(scope);\n    String actual = scope.getValueAsString(&quot;result&quot;);\n    System.out.println(&quot;Result: &quot; + actual);\n\n}\n</code></pre>\n<p>This test results in a java.lang.AssertionError in HostToGuestRootNode.java when run in the test environment at scope.getValueAsString(&quot;result&quot;)</p>\n<p>Here’s the full stack trace:</p>\n<pre><code>org.graalvm.polyglot.PolyglotException: java.lang.AssertionError\n    at com.oracle.truffle.polyglot.HostToGuestRootNode.execute(HostToGuestRootNode.java:125)\n    ...\n    at com.tibco.bpm.se.core.test.GraalTest.test(GraalTest.java:56)\nCaused by: java.lang.AssertionError\n    at com.oracle.truffle.polyglot.HostToGuestRootNode.execute(HostToGuestRootNode.java:125)\n</code></pre>\n<p><strong>Question:</strong></p>\n<p>Why does SafeInteger (a TruffleObject) cause the !(result instanceof TruffleObject) assertion to fail in the test environment but not in the standalone app — even though the object appears to be the same? Are there any known differences in Graal.js behavior or polyglot engine setup between test (e.g. TestNG) and runtime environments? and How to solve for Large Number.</p>\n",
    "tags" : [ "javascript", "java", "graalvm", "graaljs" ],
    "owner" : {
      "account_id" : 33442216,
      "reputation" : 21,
      "user_id" : 25890401,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4bb505d6ff34e9206a322c23298a811?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Srikanth Allapu",
      "link" : "https://stackoverflow.com/users/25890401/srikanth-allapu"
    },
    "is_answered" : false,
    "view_count" : 85,
    "closed_date" : 1745924791,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1745485842,
    "creation_date" : 1745485509,
    "link" : "https://stackoverflow.com/questions/79590199/graal-js-returns-safeinteger-causes-result-instanceof-truffleobject-assertio",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140368048,
    "post_id" : 79590199,
    "body" : "If you are also interested in the root of the AssertionError, it would be nice to provide a test-case that has minimal/clear dependencies. I have no idea where the classes <code>ScriptManager</code>, <code>Expression</code> or <code>Variable</code> come from. Also your &quot;full stack trace&quot; is not full at all. It contains just two stack-frames.",
    "score" : 1,
    "owner" : {
      "account_id" : 6557903,
      "reputation" : 1208,
      "user_id" : 5070046,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/eec51a02e98bb6a91d3361c64701b001?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Jan Štola",
      "link" : "https://stackoverflow.com/users/5070046/jan-%c5%a0tola"
    },
    "creation_date" : 1745565178,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140367956,
    "post_id" : 79590199,
    "body" : "Thanks @S&#246;ren, now the test fails consistently as expected. That clears up the assertion behavior.  But the core issue I’m trying to solve is this: When evaluating a large number like &quot;314159265358979&quot; in Graal.js, the result is a SafeInteger (TruffleObject), whereas Nashorn used to give us a Double.  Polyglot interop logic has an assertion to guard against TruffleObject, which now fails.  What’s the best way to handle or convert these large JavaScript numeric values to appropriate Java types (e.g. Long, BigInteger, or Double) in Graal.js without breaking interop assumptions?",
    "score" : 0,
    "owner" : {
      "account_id" : 33442216,
      "reputation" : 21,
      "user_id" : 25890401,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4bb505d6ff34e9206a322c23298a811?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Srikanth Allapu",
      "link" : "https://stackoverflow.com/users/25890401/srikanth-allapu"
    },
    "creation_date" : 1745562575,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140365381,
    "post_id" : 79590199,
    "body" : "Just guessing: You have disabled assertions for tests in your pom.xml.",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1745498296,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140364927,
    "post_id" : 79590199,
    "body" : "Good point @S&#246;ren  TestNG is running with -ea enabled, but our standalone app isn’t. That explains why the assertion triggers in tests but not in the standalone app.  Another interesting case: if I run mvn test for the whole suite, the test passes — but if I run it individually, it fails. Any idea why that might be?",
    "score" : 0,
    "owner" : {
      "account_id" : 33442216,
      "reputation" : 21,
      "user_id" : 25890401,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c4bb505d6ff34e9206a322c23298a811?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Srikanth Allapu",
      "link" : "https://stackoverflow.com/users/25890401/srikanth-allapu"
    },
    "creation_date" : 1745491893,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140364541,
    "post_id" : 79590199,
    "body" : "Are you running your application with <code>-enableassertions</code> (short form: <code>-ea</code>)?",
    "score" : 0,
    "owner" : {
      "account_id" : 1888781,
      "reputation" : 2498,
      "user_id" : 1707427,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d1a2608ee35e2df7d2400a02e62bb20?s=256&d=identicon&r=PG",
      "display_name" : "S&#246;ren",
      "link" : "https://stackoverflow.com/users/1707427/s%c3%b6ren"
    },
    "creation_date" : 1745485893,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}