{
  "question" : {
    "question_id" : 79624370,
    "title" : "PDFBox acroform unable to find fields previously added, on an iText signed pdf",
    "body" : "<p>i have a pdf that has a couple of signatures added using iText : <a href=\"https://drive.google.com/file/d/10o5XOxGZgjjDtlNn3RX99sxS6Me1TYS6/view?usp=sharing\" rel=\"nofollow noreferrer\">iText signed file</a></p>\n<p>I am using PDFBox(version 3.0.4) to add more signature fields into the same PDF using <code>createEmptySignature()</code> with fieldname <code>asb_191025_0</code>(and more) then save it using <code>doc.saveIncremental()</code>. Using <code>inspectFields()</code> i can see that the fields have been added. (<code>inspectFields()</code> is basically <code>printFields()</code> from <a href=\"https://github.com/apache/pdfbox/blob/d43b45689fcee27813fbe036900b937ab9e7af3a/examples/src/main/java/org/apache/pdfbox/examples/interactive/form/PrintFields.java#L46\" rel=\"nofollow noreferrer\">github sample</a>)</p>\n<p><a href=\"https://drive.google.com/file/d/1XruNOYDl7DL476CyriP53gXlTQo9rVER/view?usp=sharing\" rel=\"nofollow noreferrer\">This is the updated/ saved file</a>.</p>\n<p>After that, i open the same file to place signature into the fields. However <code>inspectFields()</code> only returns the 2 iText signed fields and not the newly added ones. Calling <code>acroForm.getField(&quot;asb_191025_0&quot;)</code> returns <code>null</code> as well.</p>\n<p>Opening the file in both Acrobat and notepad++ do show all the fields.</p>\n<p>This only happens when I put new fields into an iText signed pdf. Theres no problem if i start with a clean pdf.</p>\n<p>What did I miss?</p>\n<p>Thank you.</p>\n<pre><code>    public static void createEmptySignature(PDDocument doc, int pageIndex, PDRectangle rect, String fieldName) throws Exception {\n        PDAcroForm acroForm = doc.getDocumentCatalog().getAcroForm();\n        if (acroForm == null) {\n            acroForm = new PDAcroForm(doc);\n            doc.getDocumentCatalog().setAcroForm(acroForm);\n        }\n        \n        if(acroForm.getFields() instanceof AbstractList){\n            acroForm.setFields(new ArrayList&lt;&gt;());\n        }\n        \n        inspectFields(acroForm);\n\n        PDSignatureField signatureField = new PDSignatureField(acroForm);\n        signatureField.setPartialName(fieldName);\n        PDAnnotationWidget widget = signatureField.getWidgets().get(0);\n        widget.setRectangle(rect);\n        widget.setPage(doc.getPage(pageIndex));\n        widget.setPrinted(true);\n\n        doc.getPage(pageIndex).getAnnotations().add(widget);\n\n        acroForm.getFields().add(signatureField);\n    }\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "pdf", "itext", "pdfbox" ],
    "owner" : {
      "account_id" : 19849834,
      "reputation" : 23,
      "user_id" : 14540557,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d165330cef67f164e528f6c98ce9dede?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "rec7y33",
      "link" : "https://stackoverflow.com/users/14540557/rec7y33"
    },
    "is_answered" : true,
    "view_count" : 79,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1747382907,
    "creation_date" : 1747360504,
    "link" : "https://stackoverflow.com/questions/79624370/pdfbox-acroform-unable-to-find-fields-previously-added-on-an-itext-signed-pdf",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79624749,
    "question_id" : 79624370,
    "body" : "<p>You say you use <code>doc.saveIncremental()</code>. The JavaDocs of that method start with:</p>\n<pre class=\"lang-java prettyprint-override\"><code>/**\n * Save the PDF as an incremental update. This is only possible if the PDF was loaded from a file or a stream, not\n * if the document was created in PDFBox itself. There must be a path of objects that have\n * {@link COSUpdateInfo#isNeedToBeUpdated()} set, starting from the document catalog. For signatures this is taken\n * care by PDFBox itself.\n</code></pre>\n<p>I don't see you setting <code>NeedToBeUpdated</code> at all. Thus, it is pure luck that any of your changes make it into the result document at all.</p>\n<p>So to be sure your changes are saved incrementally, make sure all your changes are reachable from the catalog via chains of objects all having <code>isNeedToBeUpdated</code> set.</p>\n<hr />\n<p>In PDFBox v3 there is an overload of <code>saveIncremental</code> that doesn't require such chains but requires you to collect the indirect dictionaries themselves.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97003,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1747382907,
    "last_activity_date" : 1747382907,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79624749" : [ {
      "comment_id" : 140438604,
      "post_id" : 79624749,
      "body" : "I&#39;ve added  <code>signatureField.getCOSObject().setNeedToBeUpdated(true);</code> <code>acroForm.getCOSObject().setNeedToBeUpdated(true);</code> and now it is able to find the fields. Thank you @mkl",
      "score" : 0,
      "owner" : {
        "account_id" : 19849834,
        "reputation" : 23,
        "user_id" : 14540557,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d165330cef67f164e528f6c98ce9dede?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "rec7y33",
        "link" : "https://stackoverflow.com/users/14540557/rec7y33"
      },
      "creation_date" : 1747646297,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}