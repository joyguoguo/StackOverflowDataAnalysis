{
  "question" : {
    "question_id" : 79560225,
    "title" : "Hibernate MappingException - Foreign key column count mismatch with referenced primary key",
    "body" : "<p>I am encountering an error when trying to save data using JPA and Hibernate. The error message is:</p>\n<pre><code>Caused by: org.hibernate.MappingException: Foreign key (FKi3uxs48nod3arim7hhpwx1anb:role_group [app_group_id])) must have same number of columns as the referenced primary key (app_group [id, app_id, group_id])\n</code></pre>\n<p>I have the following table definitions and entity mappings:</p>\n<p>app_group table creation:</p>\n<pre><code>create table app_group\n(\n    id           varchar(36) not null,\n    group_id     varchar(36) not null,\n    app_id       varchar(36) not null,\n    primary key (id),\n    unique (group_id, app_id),\n    constraint app_group_group_fk foreign key (group_id) references `group` (id),\n    constraint app_group_app_fk foreign key (app_id) references `app` (id)\n);\n</code></pre>\n<p>AppGroup JPA entity:</p>\n<pre><code>@Entity\n@Table(name = &quot;app_group&quot;)\npublic class AppGroup implements Serializable {\n    @Id \n    @Size(min = 36, max = 36)\n    protected String id;\n\n    @ManyToOne \n    @JoinColumn(name = &quot;app_id&quot;)\n    private App app;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;group_id&quot;)\n    private Group group;\n\n    @OneToMany(mappedBy = &quot;appGroup&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    private Set&lt;RoleGroup&gt; groupRoles = new HashSet&lt;&gt;();\n}\n</code></pre>\n<p>role_group table creation:</p>\n<pre><code>create table role_group\n(\n    id           varchar(36) not null,\n    group_id     varchar(36) not null,\n    role_id       varchar(36) not null,\n    app_group_id varchar(36) not null,\n    primary key (id),\n    unique (group_id, role_id),\n    constraint role_group_group_fk foreign key (group_id) references `group` (id),\n    constraint role_group_role_fk foreign key (role_id) references `role` (id),\n    constraint role_group_app_group_fk foreign key (app_group_id) references `app_group` (id)\n);\n</code></pre>\n<p>RoleGroup JPA entity:</p>\n<pre><code>@Entity\n@Table(name = &quot;role_group&quot;)\n@Accessors(fluent = true)\npublic class RoleGroup {\n    @Id \n    @Size(min = 36, max = 36)\n    protected String id;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;role_id&quot;)\n    private Role role;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;group_id&quot;)\n    private Group group;\n\n    @ManyToOne\n    @JoinColumn(name = &quot;app_group_id&quot;)\n    private AppGroup appGroup;\n}\n</code></pre>\n<p>Issue:\nThe <code>app_group</code> table has a primary key <code>id</code> and a unique constraint on <code>(group_id, app_id)</code>, which should work fine.</p>\n<p>The error indicates that the <code>app_group</code> table has a composite key, referring to <code>(id, app_id, group_id)</code> as the primary key, but that’s not the case in the schema.</p>\n<p>Could anyone help explain why Hibernate is treating <code>app_group</code> as having a composite primary key instead of just <code>id</code>? And how can I resolve this issue?</p>\n<p>[EDIT]</p>\n<p>To provide additional information, here are my <code>App</code> and <code>Group</code> JPA entities.</p>\n<p>Group JPA entity:</p>\n<pre><code>@Entity\n@Table(name = &quot;`group`&quot;)\npublic class Group {\n    @Id \n    @Size(min = 36, max = 36)\n    protected String id;\n\n    @ManyToMany(mappedBy = &quot;groups&quot;)\n    private final Set&lt;App&gt; apps;\n}\n</code></pre>\n<p>App JPA entity:</p>\n<pre><code>@Entity\n@Table(name = &quot;app&quot;)\npublic class App {\n    @Id \n    @Size(min = 36, max = 36)\n    protected String id;\n\n    @ManyToMany\n    @JoinTable(\n            name = &quot;app_group&quot;,\n            joinColumns = {@JoinColumn(name = &quot;app_id&quot;)}, inverseJoinColumns = {@JoinColumn(name = &quot;group_id&quot;)}\n    )\n    private Set&lt;Group&gt; groups;\n}\n</code></pre>\n",
    "tags" : [ "java", "hibernate", "jpa", "unique-constraint" ],
    "owner" : {
      "account_id" : 28594286,
      "reputation" : 31,
      "user_id" : 21892813,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AGNmyxY7reYO_0UIpeBEn7SkDS8OrNaiEMVJIiDw6AZx=k-s256",
      "display_name" : "Mahdi Sahebzamani",
      "link" : "https://stackoverflow.com/users/21892813/mahdi-sahebzamani"
    },
    "is_answered" : false,
    "view_count" : 86,
    "answer_count" : 0,
    "score" : 3,
    "last_activity_date" : 1748966360,
    "creation_date" : 1744038456,
    "link" : "https://stackoverflow.com/questions/79560225/hibernate-mappingexception-foreign-key-column-count-mismatch-with-referenced-p",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140309088,
    "post_id" : 79560225,
    "body" : "Again, I think the cause of the problem presented is not captured by the question.  But I also observe that you have a data modeling problem, in that the structure of your database does not capture all of the application&#39;s constraints.  Your use of surrogate keys is getting in the way of that, as they are not well suited to handling the kinds of overlappping, multilateral relationships you actually have.  You should be able to keep the surrogate keys, but you probably want to use different candidate keys in modeling this combination of relationships.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744050723,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308916,
    "post_id" : 79560225,
    "body" : "@JohnBollinger You&#39;re right to question the cascade rationale. This is driven by the business requirement. Each <code>Role</code> is associated with a specific <code>App</code>, and a <code>Role</code> can only be assigned to <code>Group</code>s that have access to that <code>App</code>. As a result, when an <code>AppGroup</code> is deleted, the corresponding <code>RoleGroup</code>s should also be removed.",
    "score" : 1,
    "owner" : {
      "account_id" : 28594286,
      "reputation" : 31,
      "user_id" : 21892813,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AGNmyxY7reYO_0UIpeBEn7SkDS8OrNaiEMVJIiDw6AZx=k-s256",
      "display_name" : "Mahdi Sahebzamani",
      "link" : "https://stackoverflow.com/users/21892813/mahdi-sahebzamani"
    },
    "creation_date" : 1744047115,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308860,
    "post_id" : 79560225,
    "body" : "I would be inclined to guess that the reason Hibernate is supposing the wrong PK is related to something not presented in the question.  Maybe a relationship field on some other entity, perhaps an XML deployment descriptor somewhere in the mix, or possibly a stale entity class being deployed.",
    "score" : 1,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744046008,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308832,
    "post_id" : 79560225,
    "body" : "Your (3) does not make sense.  Cascading deletes is a contingent consideration.  If <code>RoleGroup</code> does not have some other reason to be related to <code>AppGroup</code> then it has no reason to be removed when an <code>AppGroup</code> is removed.  Do you maybe want a <code>Role</code> and <code>Group</code>, without <code>AppGroup</code>?  With deletes cascading from <code>Group</code> to <code>RoleGroup</code>? That would not reach the issue underlying your problem, but it would prevent it from manifesting where you currently observe it.",
    "score" : 2,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744045278,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308724,
    "post_id" : 79560225,
    "body" : "@JohnBollinger Thanks for the suggestions! To address each of your points: 1- <code>AppGroup</code> entity is needed because it has additional fields like <code>created_date</code>, <code>updated_date</code>, etc., beyond just the join relationship. 2- <code>Group</code> can be removed from <code>RoleGroup</code>, as <code>roleGroup.group() == roleGroup.appGroup().group()</code>, but this doesn&#39;t resolve the Hibernate issue with the composite key in <code>AppGroup</code>. 3- <code>AppGroup</code> is necessary in <code>RoleGroup</code> to handle cascading deletes — when an <code>AppGroup</code> is deleted, I want the corresponding <code>RoleGroup</code> rows to be deleted as well, as roles are defined per app.",
    "score" : 0,
    "owner" : {
      "account_id" : 28594286,
      "reputation" : 31,
      "user_id" : 21892813,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AGNmyxY7reYO_0UIpeBEn7SkDS8OrNaiEMVJIiDw6AZx=k-s256",
      "display_name" : "Mahdi Sahebzamani",
      "link" : "https://stackoverflow.com/users/21892813/mahdi-sahebzamani"
    },
    "creation_date" : 1744043787,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308588,
    "post_id" : 79560225,
    "body" : "Upon observing the name &quot;RoleGroup&quot; and the <code>unique (group_id, role_id)</code> constraint on table <code>row_group</code>, I&#39;m having considerable difficulty understanding where, how, or why <code>AppGroup</code> fits into the <code>RoleGroup</code> picture.",
    "score" : 1,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744042039,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308550,
    "post_id" : 79560225,
    "body" : "As long as you do have <code>AppGroup</code> as its own entity, why does <code>RoleGroup</code> have both a <code>Group</code> and an <code>AppGroup</code>?  Is there any case where it would be correct for its <code>Group</code> to be different from the <code>AppGroup</code>&#39;s <code>Group</code>?",
    "score" : 2,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744041323,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140308532,
    "post_id" : 79560225,
    "body" : "Side note: do you really need an <code>AppGroup</code> entity?  Possibly you do, but at first glance I&#39;m inclined to think that a <code>@ManyToMany</code> between <code>Group</code> and <code>App</code> would be simpler.  Then the <code>app_group</code> table could be a more traditional join table.",
    "score" : 2,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1744041082,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}