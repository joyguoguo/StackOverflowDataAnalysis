{
  "question" : {
    "question_id" : 79718708,
    "title" : "How to get Keycloak to always store the Broker Context",
    "body" : "<p>Keycloak doesn't seem to store broker context in the in the session notes in post login flow.</p>\n<p>I am using a custom keycloak SPI to help with user attribute sanitation, in the context of a saml single sing on provider. When a user logs in for the first time, I run</p>\n<pre><code> String brokerContextData = context.getAuthenticationSession()\n        .getAuthNote(AbstractIdpAuthenticator.BROKERED_CONTEXT_NOTE);\n</code></pre>\n<p>Which gets my broker context data and allows me to execute my logic. But in the post-login flow, although I have the flow setting in the saml provider settings set to also use my spi, AND keycloak debug logs still show the saml assertion coming through, keycloak doesn't store the Broker context and the same code returns null; and keycloak only finds the authenticated user and puts that in the session.</p>\n<p>How can I get keycloak to pass the broker context into my SPI every time?</p>\n",
    "tags" : [ "java", "keycloak", "single-sign-on", "saml", "broker" ],
    "owner" : {
      "account_id" : 40722049,
      "reputation" : 1,
      "user_id" : 29921413,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/978fe043a601f0678cfcd0b6eb7e74b7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "clmil",
      "link" : "https://stackoverflow.com/users/29921413/clmil"
    },
    "is_answered" : false,
    "view_count" : 43,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1753796257,
    "creation_date" : 1753796257,
    "link" : "https://stackoverflow.com/questions/79718708/how-to-get-keycloak-to-always-store-the-broker-context",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140627470,
    "post_id" : 79718708,
    "body" : "After looking into it, I think this may just not be possible, but I would still appreciate it if someone could find a solution still.",
    "score" : 0,
    "owner" : {
      "account_id" : 40722049,
      "reputation" : 1,
      "user_id" : 29921413,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/978fe043a601f0678cfcd0b6eb7e74b7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "clmil",
      "link" : "https://stackoverflow.com/users/29921413/clmil"
    },
    "creation_date" : 1753806030,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}