{
  "question" : {
    "question_id" : 79571004,
    "title" : "custom retry backoff based on exception thrown in batch consumer",
    "body" : "<p><strong>What I am trying to implement:</strong></p>\n<p>I would like to implement a custom retry backoff strategy based on the exception thrown in a batch consumer.</p>\n<p>The logic I want to implement is as follows:</p>\n<ul>\n<li>If an InfiniteRetryableException is thrown, I want to retry infinetely.</li>\n<li>If a LimitedRetryableException is thrown, I want to retry maximum 5 times.</li>\n</ul>\n<p><strong>What I have tried:</strong></p>\n<p>I have configured an error handler with a custom BackOffFunction, using the method <code>handler.setBackOffFunction((record, ex) -&gt; { ... })</code>, as explained in the <a href=\"https://docs.spring.io/spring-kafka/reference/kafka/annotation-error-handling.html#default-eh\" rel=\"nofollow noreferrer\">Spring Kafka documentation</a>.</p>\n<p>I have observed that this configuration works correctly when using a single-record listener. However, when using a batch listener, it seems to be ignored and does not apply the custom retry backoff based on the exception thrown. Instead, it applies the default configuration for all the exceptions (maximum of 10 retries).</p>\n<p>The configuration I have tried is as follows:</p>\n<pre><code>DefaultErrorHandler handler = new DefaultErrorHandler();\nhandler.setBackOffFunction((record, exception) -&gt; {\n\n  if (exception instanceof InfiniteRetryableException) {\n    return new FixedBackOff(1000L, FixedBackOff.UNLIMITED_ATTEMPTS);\n  }\n  else if (exception instanceof LimitedRetryableException) {\n    return new FixedBackOff(1000L, 5L);\n  }\n\n  return null;\n\n});\n</code></pre>\n<p><strong>Questions:</strong></p>\n<ul>\n<li>Are custom retry backoffs based on the exceptions thrown supported for batch listeners?</li>\n<li>If they are supported, how can I implement them?</li>\n</ul>\n<p><strong>Solution:</strong></p>\n<ul>\n<li>After further investigation, I found that the issue occurs when using exceptions that don't extend BatchListenerFailedException, which is specifically designed to prevent retrying the entire batch. Once I updated the two custom exceptions to inherit from BatchListenerFailedException, everything started working as expected.</li>\n</ul>\n",
    "tags" : [ "java", "apache-kafka", "spring-kafka", "retry-logic" ],
    "owner" : {
      "account_id" : 32027672,
      "reputation" : 13,
      "user_id" : 24833794,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/083d37e5f057e2a525b7c8d7172848c1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sergio Garc&#237;a",
      "link" : "https://stackoverflow.com/users/24833794/sergio-garc%c3%ada"
    },
    "is_answered" : false,
    "view_count" : 118,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1744501807,
    "creation_date" : 1744497105,
    "link" : "https://stackoverflow.com/questions/79571004/custom-retry-backoff-based-on-exception-thrown-in-batch-consumer",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140333285,
    "post_id" : 79571004,
    "body" : "Yes. Plus one for putting your solution into an answer and help community to determine that there is an answer for their similar problem.",
    "score" : 1,
    "owner" : {
      "account_id" : 3273937,
      "reputation" : 122596,
      "user_id" : 2756547,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/2158ce6e7c048277890eb64458864c1c?s=256&d=identicon&r=PG",
      "display_name" : "Artem Bilan",
      "link" : "https://stackoverflow.com/users/2756547/artem-bilan"
    },
    "creation_date" : 1744641378,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140329502,
    "post_id" : 79571004,
    "body" : "You should add this as an answer, explaining what you did, and accept the answer yourself (is perfectly correct)",
    "score" : 1,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13577,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1744535254,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328869,
    "post_id" : 79571004,
    "body" : "After investigating more, I have seen that exceptions that inherit from BatchListenerFailedException seem to work well with custom retry backoff logic.  If I throw any other type of exception (for example: to retry the complete batch again), the custom retry backoff logic isn&#39;t applied and the above behavior happens",
    "score" : 1,
    "owner" : {
      "account_id" : 32027672,
      "reputation" : 13,
      "user_id" : 24833794,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/083d37e5f057e2a525b7c8d7172848c1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sergio Garc&#237;a",
      "link" : "https://stackoverflow.com/users/24833794/sergio-garc%c3%ada"
    },
    "creation_date" : 1744501245,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}