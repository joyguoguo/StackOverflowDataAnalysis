{
  "question" : {
    "question_id" : 79659009,
    "title" : "Unable to effectively search the right embeddings using Spring AI VectorStore",
    "body" : "<p><strong>Spring AI version: 1.0.0</strong></p>\n<p>I have created a method to pull raw embedding documents by performing similarity search over given user query. The problem is it pulls everything including user and assistant messages if they are relevant. I want to filter out only the file based embeddings to provide an accurate picture. I'm not able to understand the right filter to use. Here is my implementation:</p>\n<pre class=\"lang-java prettyprint-override\"><code>\n/**\n     * Searches for documents similar to the provided message using vector similarity search.\n     *\n     * @param embeddingSearchRequestDto the search request parameters\n     * @return list of DocumentDto objects containing the search results\n     */\n    public List&lt;DocumentDto&gt; searchDocuments(EmbeddingSearchRequestDto embeddingSearchRequestDto) {\n        log.info(&quot;Searching content from embedding based on given prompt...&quot;);\n        validationHandler.validate(embeddingSearchRequestDto);\n\n        try {\n            SearchRequest.Builder searchQueryBuilder = SearchRequest.builder()\n                    .query(embeddingSearchRequestDto.message());\n            if (embeddingSearchRequestDto.topKResults() &gt; 0) {\n                searchQueryBuilder.topK(embeddingSearchRequestDto.topKResults());\n            }\n            if (embeddingSearchRequestDto.similarityThreshold() &gt; 0) {\n                searchQueryBuilder.similarityThreshold(embeddingSearchRequestDto.similarityThreshold());\n            }\n//          // filter expression to exclude USER messages\n//          searchQueryBuilder.filterExpression(new FilterExpressionBuilder()\n//                  .ne(&quot;messageType&quot;, &quot;USER&quot;)\n//                  .build());\n\n            List&lt;Document&gt; documents = vectorStore.similaritySearch(searchQueryBuilder.build());\n            if (isEmpty(documents)) {\n                log.warn(&quot;No relevant documents found for the given message&quot;);\n                return emptyList();\n            }\n\n            return documents.stream()\n                    .map(doc -&gt; new DocumentDto(\n                            doc.getId(),\n                            doc.getFormattedContent(),\n                            doc.getScore(),\n                            doc.getMetadata()))\n                    .toList();\n        } catch (Exception e) {\n            log.error(&quot;Error searching relevant documents for the given message&quot;, e);\n            return emptyList();\n        }\n    }\n</code></pre>\n<p>Files are saved with a different metadata than regular messages ex. there is no &quot;messageType&quot; field in file based embeddings.</p>\n<p>If i filter out <code>USER</code> messages, it also filters out all file based results for some reason. What am I missing?</p>\n",
    "tags" : [ "java", "pgvector", "spring-ai" ],
    "owner" : {
      "account_id" : 4308682,
      "reputation" : 14426,
      "user_id" : 3520404,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9502e45354f507b40b59c569d9919993?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "saran3h",
      "link" : "https://stackoverflow.com/users/3520404/saran3h"
    },
    "is_answered" : false,
    "view_count" : 67,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749479189,
    "creation_date" : 1749478375,
    "link" : "https://stackoverflow.com/questions/79659009/unable-to-effectively-search-the-right-embeddings-using-spring-ai-vectorstore",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140499548,
    "post_id" : 79659009,
    "body" : "Maybe try using FilterExpression using the operators for exactly what you want to filter? Something like &quot;messageType&quot;= &quot;USER&quot; AND &quot;embedding&quot; = &quot;not file bases&quot; (this is pseudo code). Check the doc: <a href=\"https://docs.spring.io/spring-ai/reference/api/vectordbs.html#_filter_expression\" rel=\"nofollow noreferrer\">docs.spring.io/spring-ai/reference/api/&hellip;</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 209503,
      "reputation" : 23867,
      "user_id" : 460557,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/b4565f97815833390c9c880e9e8522e4?s=256&d=identicon&r=PG",
      "display_name" : "Jorge Campos",
      "link" : "https://stackoverflow.com/users/460557/jorge-campos"
    },
    "creation_date" : 1749482034,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}