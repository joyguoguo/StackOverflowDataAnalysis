{
  "question" : {
    "question_id" : 79809089,
    "title" : "How do I create a file through JNA",
    "body" : "<p>In the java 25 move, we're removing some code that uses reflection in a soon-to-be-disallowed way. Instead, we're looking at using JNA. I need to access a file descriptor (the unix kind) and I thought I'd <code>open(&quot;some_path&quot;,O_CREAT|O_RDWR)</code> , do whatever I need to do with the file descriptor and then open the same path with <code>File</code> instead.\nProblem is I get errno 2 (no such file or directory).<br />\nIf I create the file first with through</p>\n<pre><code>var f = new File(&quot;some_path&quot;);\nf.createNewFile();\nint fd = JNALib.open(&quot;some_path&quot;, O_CREAT|O_RDWR);\n</code></pre>\n<p>Then that works perfectly. I do not understand why the first option fails.\nMac OS X, ARM Mac. JNA 5.18.1</p>\n<p>Code:</p>\n<pre><code>    @Test\n    public void testSOOpenFile() throws Exception {\n\n        String tmpFile = &quot;dummy-file.tst&quot;;\n        var relPath  = Paths.get(&quot;&quot;).toAbsolutePath();\n        Path file = Path.of(relPath + &quot;/&quot; + tmpFile);\n        System.out.println(&quot;Creating &quot; + file);\n        int fd = JNALibMinimal.open(file.toString(), O_CREAT | O_RDWR);\n        if (fd &lt; 0 ) {\n            System.out.println(&quot;JNALib failed to open with error code &quot; + JNALib.getLastError());\n        } else {\n            System.out.println(&quot;JNALib successfully opened &quot; + fd);\n        }\n\n    }\n</code></pre>\n<pre><code>public class JNALibMinimal {\n\n    static {\n        Native.register(Platform.C_LIBRARY_NAME);\n    }\n\n    public static native int open(String pathName, int flags);\n    public static native int open(String pathName, int flags, int mode);\n}\n</code></pre>\n<p><strong>UPDATE</strong>\nI (finally) figured out the problem and it was (not uncommon) CBtK (crap behind the keyboard). I've been too long away from c programming. The problem was that linux and Darwin actually has different values for the symbols O_RDWR &amp; O_CREAT. Once I used Darwin values, the file was created ok.</p>\n",
    "tags" : [ "java", "jna" ],
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "is_answered" : true,
    "view_count" : 129,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1762420115,
    "creation_date" : 1762270030,
    "link" : "https://stackoverflow.com/questions/79809089/how-do-i-create-a-file-through-jna",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79809111,
    "question_id" : 79809089,
    "body" : "<p>You forget the third argument: the file mode (permissions) <a href=\"https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/open.2.html\" rel=\"nofollow noreferrer\">are required when creating a file</a></p>\n<pre><code>import java.io.File;\n\nFile file = new File(&quot;some/complex/path/to/my_file.dat&quot;);\n\nFile parentDir = file.getParentFile();\nif (parentDir != null &amp;&amp; !parentDir.exists()) {\n    parentDir.mkdirs();\n}\n\nint fd = JNALib.INSTANCE.open(\n    file.getAbsolutePath(),\n    JNALib.O_CREAT | JNALib.O_RDWR, \n    JNALib.DEFAULT_MODE\n);\n\n</code></pre>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 17553626,
      "reputation" : 508,
      "user_id" : 12733532,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-EAww28wDCxk/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rcgKS9dXdmUh-hOQPlZYZygBUfLwQ/s256-rj/photo.jpg",
      "display_name" : "Max",
      "link" : "https://stackoverflow.com/users/12733532/max"
    },
    "creation_date" : 1762271600,
    "last_activity_date" : 1762305938,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140837408,
    "post_id" : 79809089,
    "body" : "@g00se We tried that but it was even slower than the pure java solution.",
    "score" : 0,
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "creation_date" : 1762334467,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837405,
    "post_id" : 79809089,
    "body" : "@Holger There&#39;s logic that depends on the file being filled with zeroes. The fallback solution is to use a pure java solution but that is regarded as too slow.",
    "score" : 0,
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "creation_date" : 1762334339,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837336,
    "post_id" : 79809089,
    "body" : "I see. How about using <code>fallocate</code> in conjunction with <code>ProcessBuilder</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1762332343,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837322,
    "post_id" : 79809089,
    "body" : "So, <code>fileChannel.position(intendedSize - 1).write(ByteBuffer.allocate(1))</code> does not work for you?",
    "score" : 1,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1762331771,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140837249,
    "post_id" : 79809089,
    "body" : "@g00se We have journal files that we want to ensure space for at creation. Since linux is our prod env, we use <code>falloc()</code> to reserve space. To use <code>falloc()</code>, we need to use JNA and get the linux file descriptor. To do that, we use reflection to access the fd from the java FileDescriptor and with the tightening of security it&#39;s not really good practice.",
    "score" : 0,
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "creation_date" : 1762328635,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836809,
    "post_id" : 79809089,
    "body" : "I think I slightly misunderstood your point. Having said that, why out of interest would you be using native code to create a file?",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1762298022,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836658,
    "post_id" : 79809089,
    "body" : "@g00se If you actually read the small snippet you&#39;ll notice the <code>f.createNewFile()</code> part.",
    "score" : 0,
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "creation_date" : 1762290549,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836656,
    "post_id" : 79809089,
    "body" : "@Holger While I would dearly love to do so, I still have to support 11 so it&#39;s some time off. I need to support 11 - 25 (as it looks right now)",
    "score" : 0,
    "owner" : {
      "account_id" : 54150,
      "reputation" : 2071,
      "user_id" : 161995,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
      "display_name" : "Erik",
      "link" : "https://stackoverflow.com/users/161995/erik"
    },
    "creation_date" : 1762290498,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836313,
    "post_id" : 79809089,
    "body" : "Also please add a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a> to the question.",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1762279302,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836214,
    "post_id" : 79809089,
    "body" : "Is <code>java.nio.file.Files.setPosixFilePermissions()</code> not enough for your needs?",
    "score" : 1,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26502,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1762275566,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836109,
    "post_id" : 79809089,
    "body" : "When youâ€™re migrating to Java 25, you may consider switching to the <a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/lang/foreign/package-summary.html#ffa\" rel=\"nofollow noreferrer\">built-in facility</a> for invoking native functions instead.",
    "score" : 6,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300941,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1762272595,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140836039,
    "post_id" : 79809089,
    "body" : "<i>If I create the file first with through...</i> That&#39;s because a <code>File</code> is really more of a wrapper around the business of manipulating paths on the file system. Creating an object of type <code>File</code> doesn&#39;t create anything on the file system",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4244,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1762271032,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79809111" : [ {
      "comment_id" : 140838371,
      "post_id" : 79809111,
      "body" : "So is it possible the &quot;random&quot; mode was 0 = no file access to even the user, thus resulting in the &quot;no such file&quot; error?  In any case, I would expect &quot;working&quot; here means &quot;giving nondeterministic results&quot;. :)",
      "score" : 0,
      "owner" : {
        "account_id" : 1187908,
        "reputation" : 9345,
        "user_id" : 1161484,
        "user_type" : "registered",
        "accept_rate" : 93,
        "profile_image" : "https://www.gravatar.com/avatar/371797a0137ad4519049f88afac2d4e7?s=256&d=identicon&r=PG",
        "display_name" : "Daniel Widdis",
        "link" : "https://stackoverflow.com/users/1161484/daniel-widdis"
      },
      "creation_date" : 1762363897,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140837894,
      "post_id" : 79809111,
      "body" : "Want to clarify here, using O_CREAT without mode will grab the next 4 bytes in the frame as mode bytes so you&#39;ll get what is a random mode. I didn&#39;t use explicit mode because I wanted to simplify things.",
      "score" : 1,
      "owner" : {
        "account_id" : 54150,
        "reputation" : 2071,
        "user_id" : 161995,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
        "display_name" : "Erik",
        "link" : "https://stackoverflow.com/users/161995/erik"
      },
      "creation_date" : 1762350357,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140837240,
      "post_id" : 79809111,
      "body" : "Since the c code works without using perms, no.",
      "score" : 0,
      "owner" : {
        "account_id" : 54150,
        "reputation" : 2071,
        "user_id" : 161995,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
        "display_name" : "Erik",
        "link" : "https://stackoverflow.com/users/161995/erik"
      },
      "creation_date" : 1762328357,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140836945,
      "post_id" : 79809111,
      "body" : "@Erik The permissions are optional unless you&#39;re creating a new file. From the <a href=\"https://developer.apple.com/library/archive/documentation/System/Conceptual/ManPages_iPhoneOS/man2/open.2.html\" rel=\"nofollow noreferrer\">man page</a>: &quot;The oflag argument may indicate that the file is to be created if it does      not exist (by specifying the O_CREAT flag).  In this case, open requires a third argument mode_t mode&quot;.    Max is correct here (and this answer could be improved by quoting this).",
      "score" : 1,
      "owner" : {
        "account_id" : 1187908,
        "reputation" : 9345,
        "user_id" : 1161484,
        "user_type" : "registered",
        "accept_rate" : 93,
        "profile_image" : "https://www.gravatar.com/avatar/371797a0137ad4519049f88afac2d4e7?s=256&d=identicon&r=PG",
        "display_name" : "Daniel Widdis",
        "link" : "https://stackoverflow.com/users/1161484/daniel-widdis"
      },
      "creation_date" : 1762305887,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140836650,
      "post_id" : 79809111,
      "body" : "For the libc <code>open()</code> call, file permissions are optional.",
      "score" : 0,
      "owner" : {
        "account_id" : 54150,
        "reputation" : 2071,
        "user_id" : 161995,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://www.gravatar.com/avatar/f2f7d62ddeeb7b96c338131837eb1c6a?s=256&d=identicon&r=PG",
        "display_name" : "Erik",
        "link" : "https://stackoverflow.com/users/161995/erik"
      },
      "creation_date" : 1762290411,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}