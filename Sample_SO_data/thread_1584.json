{
  "question" : {
    "question_id" : 79693414,
    "title" : "Spring Boot 3.3: Import entities with Ids provided in a CSV file while having Id auto-generation for new entities?",
    "body" : "<p>When my Java application was running on Spring Boot 2.6.2, the entities for which Export/Import features applied were using the following custom id generator:</p>\n<pre><code>import org.hibernate.engine.spi.SharedSessionContractImplementor;\nimport org.hibernate.id.IdentityGenerator;\n\nimport java.io.Serializable;\n\npublic class CustomIdGenerator extends IdentityGenerator {\n\n    @Override\n    public Serializable generate(SharedSessionContractImplementor session, Object entity) {\n        Serializable id = session.getEntityPersister(null, entity)\n                .getClassMetadata().getIdentifier(entity, session);\n        return id != null ? id : super.generate(session, entity);\n    }\n}\n</code></pre>\n<p>so that, <strong>when an Id was provided in the CSV file, the import was producing the very same entity in the database, with the very same Id</strong>.</p>\n<p>In particular, I was able to save and restore the whole table by doing these actions in the following order:</p>\n<ol>\n<li>Export (to save as CSV)</li>\n<li>Import an empty CSV file (clears the table)</li>\n<li>Import the saved CSV file\nResult: after these 3 operations, the database content was exactly the same as before.</li>\n</ol>\n<p><strong>Now that I have migrated my application to Spring Boot 3.3.1, this doesn't work anymore.</strong> I was forced to dispose of CustomIdGenerator because this implementation is no more compatible with Spring Boot 3.3.1 (because of its Hibernate dependency). I tried to obtain a similar CustomIdGenerator the new way, but in vain after several attempts and a couple of evenings trying to achieve that...</p>\n<p>To summarize: I need the Ids of my entity to be auto-generated (like with GenerationType.IDENTITY) when they are provided without Id, but I need the Ids to be strictly identical to those provided in the CSV file in case of an import action.</p>\n<p>Any known way to do that with success?</p>\n<p>--</p>\n<p>For example, I tried to implement a CustomIdGenerator this way (Spring Boot 3.3.1):</p>\n<pre><code>public class NewCustomIdGenerator implements IdentifierGenerator {\n\n@Override\npublic Object generate (SharedSessionContractImplementor session, Object entity) {\n    var id = session.getEntityPersister(entity.getClass().toString(), entity).getIdentifier(entity, session);\n    if (id != null) {\n        return id;\n    }\n\n    //var res = super.generate(session, entity); // doesn't work\n    var res = 0L; // doesn't work (here I'd like the auto-generation to take over)\n    return res;\n}\n</code></pre>\n<p>I also tried to extend IncrementGenerator or TableGenerator... in vain.</p>\n<p>Any idea that works?</p>\n",
    "tags" : [ "java", "spring-boot", "hibernate", "import", "export" ],
    "owner" : {
      "account_id" : 377411,
      "reputation" : 2919,
      "user_id" : 729513,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
      "display_name" : "Bludzee",
      "link" : "https://stackoverflow.com/users/729513/bludzee"
    },
    "is_answered" : true,
    "view_count" : 109,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1752015306,
    "creation_date" : 1751922405,
    "link" : "https://stackoverflow.com/questions/79693414/spring-boot-3-3-import-entities-with-ids-provided-in-a-csv-file-while-having-id",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79693606,
    "question_id" : 79693414,
    "body" : "<p>I faced a similar issue after migrating to Spring Boot 3.x. Since Hibernate 6 has removed the old <code>IdentityGenerator</code> compatibility, custom ID generation became tricky.</p>\n<p>Here's how I solved it <strong>without needing a custom <code>IdentifierGenerator</code></strong>:</p>\n<h3>Entity Configuration</h3>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\npublic class MyEntity {\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    private Long id;\n\n    // other fields...\n}\n</code></pre>\n<h3>Import Logic</h3>\n<pre class=\"lang-java prettyprint-override\"><code>if (csvHasId) {\n    entity.setId(csvId); // Use provided ID from CSV\n} else {\n    entity.setId(null);  // Let Hibernate auto-generate ID\n}\nrepository.save(entity);\n</code></pre>\n<p>This approach lets you reuse existing IDs from your CSV during import, and fallback to auto-generated IDs when no ID is supplied. Fully compatible with Spring Boot 3.3.1 + Hibernate 6.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 32663008,
      "reputation" : 1,
      "user_id" : 25384055,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/H3PfDJYO.jpg?s=256",
      "display_name" : "Saurabhh",
      "link" : "https://stackoverflow.com/users/25384055/saurabhh"
    },
    "creation_date" : 1751943027,
    "last_activity_date" : 1751943500,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79694903,
    "question_id" : 79693414,
    "body" : "<p>I finally found this solution based upon hybrid ID generation:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import org.hibernate.engine.spi.SharedSessionContractImplementor;\nimport org.hibernate.generator.BeforeExecutionGenerator;\nimport org.hibernate.generator.EventType;\nimport org.hibernate.id.IdentityGenerator;\n\nimport static java.util.Objects.isNull;\n\npublic class CustomIdGenerator extends IdentityGenerator implements BeforeExecutionGenerator {\n\n    @Override\n    public Object generate(SharedSessionContractImplementor session, Object entity, Object currentValue, EventType eventType) {\n        return getId(entity, session);\n    }\n\n    private static Object getId(Object entity, SharedSessionContractImplementor session) {\n        return session.getEntityPersister(null, entity)\n                .getIdentifier(entity, session);\n    }\n\n    /**\n     * The generate() method above is called if no ID is provided!\n     */\n    @Override\n    public boolean generatedOnExecution(Object entity, SharedSessionContractImplementor session) {\n        Object id = getId(entity, session);\n        return isNull(id);\n    }\n\n    @Override\n    public boolean generatedOnExecution() {\n        return true;\n    }\n}\n</code></pre>\n<p>The following post helped me a great deal:<br />\n<a href=\"https://discourse.hibernate.org/t/hybrid-id-generation-in-hibernate-6-2-is-difficult/7666/7\" rel=\"nofollow noreferrer\">https://discourse.hibernate.org/t/hybrid-id-generation-in-hibernate-6-2-is-difficult/7666/7</a></p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 377411,
      "reputation" : 2919,
      "user_id" : 729513,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
      "display_name" : "Bludzee",
      "link" : "https://stackoverflow.com/users/729513/bludzee"
    },
    "creation_date" : 1752015306,
    "last_activity_date" : 1752015306,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140575068,
    "post_id" : 79693414,
    "body" : "I can see that the ID that I set in the problematic entity before saveAll is changed before <code>@PrePersist</code> and <code>@PostPersist</code> with Spring Boot 3.3.1. It was not changed with Spring Boot 2.6.2.",
    "score" : 0,
    "owner" : {
      "account_id" : 377411,
      "reputation" : 2919,
      "user_id" : 729513,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
      "display_name" : "Bludzee",
      "link" : "https://stackoverflow.com/users/729513/bludzee"
    },
    "creation_date" : 1752009295,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140574281,
    "post_id" : 79693414,
    "body" : "I confirm that is it <code>EntityManager.merge</code> that&#39;s called. Right after this, I see, with Spring Boot 3.3.1, that the Ids of the new entities are not those provided by the CSV file, contrary to the behaviour I had with Spring Boot 2.6.2.",
    "score" : 0,
    "owner" : {
      "account_id" : 377411,
      "reputation" : 2919,
      "user_id" : 729513,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
      "display_name" : "Bludzee",
      "link" : "https://stackoverflow.com/users/729513/bludzee"
    },
    "creation_date" : 1751989582,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140573003,
    "post_id" : 79693414,
    "body" : "I&#39;m not using <code>EntityManager.persit</code> or <code>EntityManager.merge</code>, I&#39;m using <code>JpaRepository.saveAll</code> - I&#39;ll check again if <code>AbstractEntityInformation.isNew</code> returns true or false when it should and if <code>em.persist</code> or <code>em.merge</code> is called. Then I&#39;ll come back to you.",
    "score" : 0,
    "owner" : {
      "account_id" : 377411,
      "reputation" : 2919,
      "user_id" : 729513,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
      "display_name" : "Bludzee",
      "link" : "https://stackoverflow.com/users/729513/bludzee"
    },
    "creation_date" : 1751966272,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140572483,
    "post_id" : 79693414,
    "body" : "Instead of using <code>EntityManager.persist</code> you should try <code>EntityManager.merge</code>. This should in my understanding preserve the id of the entity that is being merged exactly as you demand.",
    "score" : 0,
    "owner" : {
      "account_id" : 1580843,
      "reputation" : 13706,
      "user_id" : 1466267,
      "user_type" : "registered",
      "accept_rate" : 91,
      "profile_image" : "https://www.gravatar.com/avatar/c47d1f7544a8c4a1bb7a41d511f53604?s=256&d=identicon&r=PG",
      "display_name" : "SpaceTrucker",
      "link" : "https://stackoverflow.com/users/1466267/spacetrucker"
    },
    "creation_date" : 1751951401,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79693606" : [ {
      "comment_id" : 140574288,
      "post_id" : 79693606,
      "body" : "This is what my application is doing. It was working fine with Spring Boot 2.6.2, but with Spring Boot 3.3.1, the case <code>entity.setId(csvId)</code> doesn&#39;t keep the provided csvId in case of a new entity.",
      "score" : 0,
      "owner" : {
        "account_id" : 377411,
        "reputation" : 2919,
        "user_id" : 729513,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
        "display_name" : "Bludzee",
        "link" : "https://stackoverflow.com/users/729513/bludzee"
      },
      "creation_date" : 1751989778,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140572991,
      "post_id" : 79693606,
      "body" : "That&#39;s already what my application is doing, unfortunately.",
      "score" : 0,
      "owner" : {
        "account_id" : 377411,
        "reputation" : 2919,
        "user_id" : 729513,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
        "display_name" : "Bludzee",
        "link" : "https://stackoverflow.com/users/729513/bludzee"
      },
      "creation_date" : 1751966088,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79694903" : [ {
      "comment_id" : 140575246,
      "post_id" : 79694903,
      "body" : "This solution seems to do the trick, but I need to test it thoroughly. In the meantime, feel free to post a better answer. Thanks!",
      "score" : 0,
      "owner" : {
        "account_id" : 377411,
        "reputation" : 2919,
        "user_id" : 729513,
        "user_type" : "registered",
        "accept_rate" : 100,
        "profile_image" : "https://i.sstatic.net/lmrmp.jpg?s=256",
        "display_name" : "Bludzee",
        "link" : "https://stackoverflow.com/users/729513/bludzee"
      },
      "creation_date" : 1752015396,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}