{
  "question" : {
    "question_id" : 79687184,
    "title" : "Filter randomly fails to read cookie header unless logs are added",
    "body" : "<p>I'm working on a Spring Boot + Angular application where I'm encountering a strange issue related to cookies and filters.</p>\n<ul>\n<li><p>I have a custom filter (<code>CookieValidationFilter</code>) in Spring Boot that checks for a <code>SessionCookie</code> in the <code>Cookie</code> header.</p>\n</li>\n<li><p>From the Angular front-end, Iâ€™m making a POST request to a secure endpoint.</p>\n</li>\n<li><p>Sometimes, the cookie is not available in the back-end request, resulting in:</p>\n<ul>\n<li><code>401 Unauthorized</code></li>\n<li>CORS errors</li>\n<li><code>no-referrer</code> warnings in the browser console</li>\n</ul>\n</li>\n<li><p>However, if I add some debug logging statements inside the filter, like printing headers, the problem goes away and it starts working as expected.</p>\n</li>\n<li><p>The code is the same otherwise. No change in front-end, back-end, or browser config, just the presence of logging seems to change behavior.</p>\n</li>\n<li><p>The front-end sets the <code>SessionCookie</code> correctly, and I can see it in browser Dev Tools under the &quot;Cookies&quot; tab.</p>\n</li>\n<li><p>When the API fails, the request in the Network tab does not show the <code>Cookie</code> header.</p>\n</li>\n<li><p>When the API works (with logs added), the cookie is sent correctly and the back-end proceeds normally.</p>\n</li>\n<li><p>The cookie is marked as <code>HttpOnly; Secure; SameSite=None</code>.</p>\n</li>\n</ul>\n<p>My code is as below:</p>\n<p><code>ContentCachingRequestFilter</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class ContentCachingRequestFilter implements Filter {\n    @Override\n    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)\n            throws IOException, ServletException {\n        ContentCachingRequestWrapper requestWrapper = new ContentCachingRequestWrapper((HttpServletRequest) servletRequest);\n        filterChain.doFilter(requestWrapper, servletResponse);\n    }\n}\n</code></pre>\n<p><code>CookieValidationFilter</code> (simplified):</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class CookieValidationFilter extends OncePerRequestFilter {\n \n    private final ObjectMapper objectMapper;\n \n    public CookieValidationFilter(ObjectMapper objectMapper) {\n        this.objectMapper = objectMapper;\n    }\n \n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n            throws ServletException, IOException {\n \n        String cookieHeader = request.getHeader(HttpHeaders.COOKIE);\n        boolean hasSessionCookie = cookieHeader != null &amp;&amp; Arrays.stream(cookieHeader.split(&quot;;&quot;))\n                .map(String::trim)\n                .anyMatch(c -&gt; c.startsWith(&quot;SessionCookie=&quot;) &amp;&amp; !c.equalsIgnoreCase(&quot;SessionCookie=&quot;));\n \n        if (!hasSessionCookie) {\n            ApiResponse apiResponse = ApiResponse.builder().httpStatus(Constants.UNAUTHORISED_ACCESS_CODE)\n                    .statusMessage(Constants.UNAUTHORIZED_MSG)\n                    .userMessage(Constants.YOU_ARE_NOT_AUTHORIZED_TO_ACCESS_THE_FEATURE_MSG).errorMessage(null)\n                    .data(null).messageSeverity(null).validationErrors(null).build();\n \n            response.setStatus(Constants.UNAUTHORISED_ACCESS_CODE);\n            response.setContentType(&quot;application/json&quot;);\n            response.getWriter().write(objectMapper.writeValueAsString(apiResponse));\n            return;\n        }\n \n        filterChain.doFilter(request, response);\n    }\n}\n</code></pre>\n<p>Why would accessing or logging headers (e.g., with <code>request.getHeaderNames()</code>) affect whether the <code>Cookie</code> header is received by the backend in Spring Boot?</p>\n<p>Is there something I'm missing related to request wrappers, lazy header parsing, or filter ordering that would explain this inconsistent behavior?</p>\n<p>Things I've already tried:</p>\n<ul>\n<li>Forcing header access via <code>Collections.list(request.getHeaderNames()).forEach(request::getHeader)</code></li>\n<li>Extended OncePerRequestFilter for ContentCachingRequestFilter</li>\n<li>Ensuring correct CORS setup (<code>allowCredentials(true)</code>, exact origin)</li>\n<li>Ensuring frontend uses <code>withCredentials: true</code></li>\n<li>Cookie is sent with <code>SameSite=None; Secure; HttpOnly</code></li>\n</ul>\n<p>Still, the behavior is inconsistent unless debug logging is added, which doesn't make sense.</p>\n<h3>Environment:</h3>\n<ul>\n<li>Java 8</li>\n<li>Spring Boot 2.x</li>\n<li>Tomcat embedded</li>\n<li>Running locally with HTTPS enabled</li>\n</ul>\n<p>Any ideas why this happens or how to ensure consistent cookie handling in custom filters without relying on debug logs?</p>\n",
    "tags" : [ "java", "spring-boot", "cookies", "filter" ],
    "owner" : {
      "account_id" : 16325906,
      "reputation" : 49,
      "user_id" : 11790470,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-0kjhPVzYI5c/AAAAAAAAAAI/AAAAAAAAAMw/bjLlHhbUFmE/s256-rj/photo.jpg",
      "display_name" : "Shailesh Sorathiya",
      "link" : "https://stackoverflow.com/users/11790470/shailesh-sorathiya"
    },
    "is_answered" : false,
    "view_count" : 82,
    "answer_count" : 0,
    "score" : 4,
    "last_activity_date" : 1751472201,
    "creation_date" : 1751448625,
    "link" : "https://stackoverflow.com/questions/79687184/filter-randomly-fails-to-read-cookie-header-unless-logs-are-added",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140560752,
    "post_id" : 79687184,
    "body" : "I agree but I am not able to understand that why it&#39;s working when I am adding the logs statements in my filter. It&#39;s strange but true @MarkRotteveel",
    "score" : 0,
    "owner" : {
      "account_id" : 16325906,
      "reputation" : 49,
      "user_id" : 11790470,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-0kjhPVzYI5c/AAAAAAAAAAI/AAAAAAAAAMw/bjLlHhbUFmE/s256-rj/photo.jpg",
      "display_name" : "Shailesh Sorathiya",
      "link" : "https://stackoverflow.com/users/11790470/shailesh-sorathiya"
    },
    "creation_date" : 1751519918,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140559203,
    "post_id" : 79687184,
    "body" : "If you don&#39;t see the cookie in the request in the Network tab in your browser, I don&#39;t see how changing things in Spring Boot will make a difference.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1751472303,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140558317,
    "post_id" : 79687184,
    "body" : "I already checked with ordering, first is <code>ContentCachingRequestFilter</code> and second is <code>CookieValidationFilter</code> but still its not working as expected. @M.Deinum",
    "score" : 0,
    "owner" : {
      "account_id" : 16325906,
      "reputation" : 49,
      "user_id" : 11790470,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-0kjhPVzYI5c/AAAAAAAAAAI/AAAAAAAAAMw/bjLlHhbUFmE/s256-rj/photo.jpg",
      "display_name" : "Shailesh Sorathiya",
      "link" : "https://stackoverflow.com/users/11790470/shailesh-sorathiya"
    },
    "creation_date" : 1751454695,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140558273,
    "post_id" : 79687184,
    "body" : "Make sure your ordering of fitlers is correct, the wrapping filter needs to always be first if not you already consumed the request and it cannot be cached. When you add logging (not sure where but making assumptions here) it probably triggers early caching and thus reuse but that is a wild assupmtions.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1751453832,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}