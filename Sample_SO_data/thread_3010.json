{
  "question" : {
    "question_id" : 79578181,
    "title" : "@Convert a Map&lt;DayOfWeek, Integer&gt; to Integer[] (Hibernate/Java/JPA)",
    "body" : "<p>With Spring Boot 3.4.4 and PostgreSQL 15, I have a Java <code>Map&lt;DayOfWeek, Integer&gt;</code> mapped to an array in PostgreSQL as <code>integer[7]</code> where each position within the array would be mapped to the <code>DayOfWeek.ordinal()</code> of the original map, so an array of <code>[0,2,3,0,0,0,0]</code> means that <code>TUESDAY</code> has a value of <code>2</code> and <code>WEDNESDAY</code> a value of <code>3</code>, the remaining days are <code>0</code>.</p>\n<p>I have this converter:</p>\n<pre><code>@Converter\npublic class MyConverter implements AttributeConverter&lt;Map&lt;DayOfWeek, Integer&gt;, Integer[]&gt; {\n\n  @Override\n  public Integer[] convertToDatabaseColumn(Map&lt;DayOfWeek, Integer&gt; map) {\n    return Arrays.stream(DayOfWeek.values())\n        .map(type -&gt; map.getOrDefault(type, 0))\n        .toArray(Integer[]::new);\n  }\n\n  @Override\n  public Map&lt;DayOfWeek, Integer&gt; convertToEntityAttribute(Integer[] values) {\n    return Arrays.stream(DayOfWeek.values())\n        .collect(Collectors.toMap(type -&gt; type, dayOfWeek -&gt; values[dayOfWeek.ordinal()]));\n  }\n}\n</code></pre>\n<p>And this property in my <code>@Entity</code>:</p>\n<pre><code>@Convert(converter = MyConverter.class)\n@Column(name = &quot;dow_quantities&quot;, nullable = false, columnDefinition = &quot;integer[7]&quot;)\nprivate Map&lt;FareType, Integer&gt; daysOfWeekQuantities;\n</code></pre>\n<p>And this column in my table:</p>\n<pre><code>dow_quantities       INTEGER[7] NOT NULL,\n</code></pre>\n<p>Well, this just blows up:</p>\n<pre><code>Caused by: java.lang.ClassCastException: class org.hibernate.type.internal.CustomMutabilityConvertedBasicTypeImpl cannot be cast to class org.hibernate.type.BasicPluralType (org.hibernate.type.internal.CustomMutabilityConvertedBasicTypeImpl and org.hibernate.type.BasicPluralType are in unnamed module of loader 'app')\n    at org.hibernate.type.descriptor.sql.internal.ArrayDdlTypeImpl.getCastTypeName(ArrayDdlTypeImpl.java:37) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.ast.spi.AbstractSqlAstTranslator.getCastTypeName(AbstractSqlAstTranslator.java:7088) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.ast.spi.AbstractSqlAstTranslator.visitCastTarget(AbstractSqlAstTranslator.java:7035) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.ast.tree.expression.CastTarget.accept(CastTarget.java:80) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.ast.spi.AbstractSqlAstTranslator.render(AbstractSqlAstTranslator.java:7186) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.query.sqm.produce.function.internal.PatternRenderer.render(PatternRenderer.java:233) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.query.sqm.produce.function.internal.PatternRenderer.render(PatternRenderer.java:167) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.query.sqm.produce.function.internal.PatternRenderer.render(PatternRenderer.java:150) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.function.CastFunction.render(CastFunction.java:87) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.ast.spi.AbstractSqlAstTranslator.renderCasted(AbstractSqlAstTranslator.java:5823) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.SqlAstTranslatorWithMerge.renderMergeUsingQuerySelection(SqlAstTranslatorWithMerge.java:161) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.SqlAstTranslatorWithMerge.renderMergeUsingQuery(SqlAstTranslatorWithMerge.java:150) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.SqlAstTranslatorWithMerge.renderMergeUsing(SqlAstTranslatorWithMerge.java:126) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.SqlAstTranslatorWithMerge.renderMergeStatement(SqlAstTranslatorWithMerge.java:82) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.SqlAstTranslatorWithMerge.createMergeOperation(SqlAstTranslatorWithMerge.java:43) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.PostgreSQLDialect.usingMerge(PostgreSQLDialect.java:1570) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.dialect.PostgreSQLDialect.createOptionalTableUpdateOperation(PostgreSQLDialect.java:1562) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.sql.model.internal.OptionalTableUpdate.createMutationOperation(OptionalTableUpdate.java:144) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.mutation.AbstractMutationCoordinator.createOperationGroup(AbstractMutationCoordinator.java:87) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.mutation.UpdateCoordinatorStandard.buildStaticUpdateGroup(UpdateCoordinatorStandard.java:1663) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.mutation.UpdateCoordinatorStandard.&lt;init&gt;(UpdateCoordinatorStandard.java:93) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.mutation.MergeCoordinator.&lt;init&gt;(MergeCoordinator.java:23) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.AbstractEntityPersister.buildMergeCoordinator(AbstractEntityPersister.java:3827) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.AbstractEntityPersister.doLateInit(AbstractEntityPersister.java:3569) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.persister.entity.AbstractEntityPersister.postInstantiate(AbstractEntityPersister.java:3859) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.metamodel.model.domain.internal.MappingMetamodelImpl.finishInitialization(MappingMetamodelImpl.java:203) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.internal.SessionFactoryImpl.initializeMappingModel(SessionFactoryImpl.java:373) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.internal.SessionFactoryImpl.&lt;init&gt;(SessionFactoryImpl.java:302) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.boot.internal.SessionFactoryBuilderImpl.build(SessionFactoryBuilderImpl.java:463) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.hibernate.jpa.boot.internal.EntityManagerFactoryBuilderImpl.build(EntityManagerFactoryBuilderImpl.java:1517) ~[hibernate-core-6.6.11.Final.jar:6.6.11.Final]\n    at org.springframework.orm.jpa.vendor.SpringHibernateJpaPersistenceProvider.createContainerEntityManagerFactory(SpringHibernateJpaPersistenceProvider.java:66) ~[spring-orm-6.2.5.jar:6.2.5]\n    at org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean.createNativeEntityManagerFactory(LocalContainerEntityManagerFactoryBean.java:390) ~[spring-orm-6.2.5.jar:6.2.5]\n    at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.buildNativeEntityManagerFactory(AbstractEntityManagerFactoryBean.java:419) ~[spring-orm-6.2.5.jar:6.2.5]\n    ... 19 common frames omitted\n</code></pre>\n",
    "tags" : [ "java", "spring", "hibernate", "jpa", "orm" ],
    "owner" : {
      "account_id" : 53420,
      "reputation" : 873,
      "user_id" : 159652,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/6f255efcfdc7de2883f5e19648f18115?s=256&d=identicon&r=PG",
      "display_name" : "Juan Diego",
      "link" : "https://stackoverflow.com/users/159652/juan-diego"
    },
    "is_answered" : false,
    "view_count" : 61,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744880700,
    "creation_date" : 1744840567,
    "link" : "https://stackoverflow.com/questions/79578181/convert-a-mapdayofweek-integer-to-integer-hibernate-java-jpa",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79578871,
    "question_id" : 79578181,
    "body" : "<p>As far as I know, <code>@Converter</code> can only be used for basic types but not for arrays or collections stored as such in postgres. That's the reason why it cannot be cast to <code>org.hibernate.type.BasicPluralType.</code></p>\n<p>You can use a lightweigthed workaround wrapping the conversion methods inside the getter/setter for this attribute. Something like this:</p>\n<pre><code>@Entity\n@Getter\n@Setter\npublic class Table {\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.AUTO)\n  private Long id;\n\n  @Getter(AccessLevel.NONE)\n  @Column(name = &quot;dow_quantities&quot;, nullable = false, columnDefinition = &quot;integer[7]&quot;)\n  private Integer[] daysOfWeekQuantities;\n\n  public void setDaysOfWeekQuantities(Map&lt;DayOfWeek, Integer&gt; map) {\n    daysOfWeekQuantities = Arrays.stream(DayOfWeek.values())\n        .map(type -&gt; map.getOrDefault(type, 0))\n        .toArray(Integer[]::new);\n  }\n\n  public Map&lt;DayOfWeek, Integer&gt; getDaysOfWeekQuantities() {\n    return Arrays.stream(DayOfWeek.values())\n        .collect(Collectors.toMap(type -&gt; type, dayOfWeek -&gt; daysOfWeekQuantities[dayOfWeek.ordinal()]));\n  }\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 11555562,
      "reputation" : 569,
      "user_id" : 8466853,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/cd7f72b426ce3c46739900b8ba014e26?s=256&d=identicon&r=PG",
      "display_name" : "Arno",
      "link" : "https://stackoverflow.com/users/8466853/arno"
    },
    "creation_date" : 1744880700,
    "last_activity_date" : 1744880700,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}