{
  "question" : {
    "question_id" : 79537868,
    "title" : "Rollback test data after unit test",
    "body" : "<p>I use an in-memory database for unit-tests</p>\n<p>I raise the application context, initialize the database, roll out its state through liquibase sql</p>\n<p>As database I use:</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;com.opentable.components&lt;/groupId&gt;\n    &lt;artifactId&gt;otj-pg-embedded&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p>In tests, I create some entities and call methods that generate the creation of entities, which @Transactional cannot always clean up</p>\n<p>And I encounter the fact that as the number of tests increases, the data in my in-memory database begins to interfere with the execution of tests</p>\n<p>I can manually try to track all the created data after each test and clean it up, yes, but does otj-pg-embedded have a mechanism, like a tag in git, to which you can roll back after each test?</p>\n",
    "tags" : [ "java", "spring-boot", "unit-testing", "in-memory-database" ],
    "owner" : {
      "account_id" : 32467947,
      "reputation" : 43,
      "user_id" : 25224125,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/331556bd2946bc085b33d2240d0c63b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mike Sonarov",
      "link" : "https://stackoverflow.com/users/25224125/mike-sonarov"
    },
    "is_answered" : false,
    "view_count" : 70,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743059431,
    "creation_date" : 1743052181,
    "link" : "https://stackoverflow.com/questions/79537868/rollback-test-data-after-unit-test",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79538082,
    "question_id" : 79537868,
    "body" : "<p>One way to cleanup DB is using <code>@Sql</code>.</p>\n<p>You can add <code>@Sql(&quot;clear.sql&quot;)</code> to your tests.</p>\n<p>Inside &quot;clear.sql&quot; you can truncate your tables.</p>\n<p>If you need some test data in DB you can either put script creating it in &quot;clear.sql&quot; or add  specific scripts only for test that requires it.</p>\n<p>PS: <code>org.springframework.test.context.jdbc.Sql</code> is located in <code>spring-test</code>.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20786,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1743059431,
    "last_activity_date" : 1743059431,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140268186,
    "post_id" : 79537868,
    "body" : "I added my answer. You can look into safe points (or backup/restore). Create save point (backup) before test and rollback to safe point (restore from backup) after. I never tried it myself. I foresee some performance drawbacks, but if your DB is small it can work. Also I&#39;m not sure if your particular DB support that :)",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20786,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1743060097,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268166,
    "post_id" : 79537868,
    "body" : "@talex trying to rollback in script all created data in large called methods does not seem like the most reliable way, because now I still miss some data... so I wonder if it is possible to return the state of the database as a whole, as a reliable way. if you can, I will be glad to see your solution, maybe it will really help me",
    "score" : 0,
    "owner" : {
      "account_id" : 32467947,
      "reputation" : 43,
      "user_id" : 25224125,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/331556bd2946bc085b33d2240d0c63b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mike Sonarov",
      "link" : "https://stackoverflow.com/users/25224125/mike-sonarov"
    },
    "creation_date" : 1743059659,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268144,
    "post_id" : 79537868,
    "body" : "You can create scripts that add test data and execute them too.",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20786,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1743059126,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268125,
    "post_id" : 79537868,
    "body" : "@talex now I think I do some like this, but I missing some test dataâ€¦ I can&#39;t just truncate all the tables, some real data add to the tables through liquibase, I shouldn&#39;t delete them",
    "score" : 0,
    "owner" : {
      "account_id" : 32467947,
      "reputation" : 43,
      "user_id" : 25224125,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/331556bd2946bc085b33d2240d0c63b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mike Sonarov",
      "link" : "https://stackoverflow.com/users/25224125/mike-sonarov"
    },
    "creation_date" : 1743058656,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268093,
    "post_id" : 79537868,
    "body" : "We just clean database before each test (we have cleanup SQL script which simply delete data from tables). If you ok with this solution I can add answer explaining how to do it.",
    "score" : 0,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20786,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1743057806,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268031,
    "post_id" : 79537868,
    "body" : "the problem is that some of the tests call controllers and large sections of code where open new transactions and do commits. Now I can&#39;t change this behavior",
    "score" : 0,
    "owner" : {
      "account_id" : 32467947,
      "reputation" : 43,
      "user_id" : 25224125,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/331556bd2946bc085b33d2240d0c63b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mike Sonarov",
      "link" : "https://stackoverflow.com/users/25224125/mike-sonarov"
    },
    "creation_date" : 1743056532,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140267914,
    "post_id" : 79537868,
    "body" : "show one test where you are using <code>@Transactional</code> that doesn&#39;t clean up after itself",
    "score" : 0,
    "owner" : {
      "account_id" : 16657879,
      "reputation" : 4340,
      "user_id" : 12038714,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mAgRe8u2G_kzJJ-KZ2yZwAD1E4kxs9eRlqnY45BUw=k-s256",
      "display_name" : "asgarov1",
      "link" : "https://stackoverflow.com/users/12038714/asgarov1"
    },
    "creation_date" : 1743054002,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}