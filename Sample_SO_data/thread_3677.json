{
  "question" : {
    "question_id" : 79532123,
    "title" : "Wiremock verify lost ThreadLocal Context in quarkus 3.19.1 and wiremock 3.0.1",
    "body" : "<p>I have a question about wiremock</p>\n<p><code>AppResourceTest.class</code> in the link below doesn't work as i expectedwith wiremock-standalone.</p>\n<p>I start Wiremock server inside a <code>QuarkusTestResourceLifecycleManager</code> custom implementations, and I expose a Wiremock as injection property in all test classes annotated with <code>@QuarkusTestResource(value = WiremockTestResourceConfigurableLifecycleManager.class).</code></p>\n<p>All works fine, but there is a problem: when i called Wiremock.verify, seems that the InheritableThreadLocal has never returned the host and port i set previously ,but always the defaults.</p>\n<p>The error is  <code>&quot;Caused by: org.apache.hc.client5.http.HttpHostConnectException: Connect to http://localhost:8080 [localhost/127.0.0.1, localhost/0:0:0:0:0:0:0:1] failed: Connection refused: no further information&quot;.</code></p>\n<p>Otherwise, if i use <code>WireMock.configureFor(wireMockClient);</code> my test works.</p>\n<p>How can solve it? Is it a bug?</p>\n<p>Thanks</p>\n<p>You can find my code here:  <a href=\"https://github.com/robyp1/app-quarkus-wiremock\" rel=\"nofollow noreferrer\">https://github.com/robyp1/app-quarkus-wiremock</a></p>\n<p>my issue is here:</p>\n<pre><code> @Test\nvoid getDrivers() {\n    assert  wireMockClient != null;\n    logger.info(wireMockClient.toString());\n\n    wireMockClient.register(WireMock.get(&quot;/api/2010/drivers&quot;).willReturn(\n            WireMock.aResponse().withStatus(200).withBody(jsonResponse)));\n\n    final Response response = given()\n            .when().get(&quot;/drivers&quot;)\n            .then()\n            .statusCode(200)\n            .assertThat()\n            .statusCode(SC_OK)\n            .contentType(ContentType.JSON)\n            .extract().as(Response.class);\n\n    //FIXME : if i add this, verify works! InnerThreadLocal not work, why? \n    //WireMock.configureFor(wireMockClient);\n\n    verify(1,\n            WireMock.getRequestedFor(WireMock.urlPathEqualTo(&quot;/api/2010/drivers&quot;)));\n    logger.info(&quot;resp:{}&quot;, response ); //throw error!\n}\n</code></pre>\n<p>But WireMock.configureFor(wireMockClient) has already executed before unit test start in the class <code>WireMockServerManager</code>: <a href=\"https://github.com/robyp1/app-quarkus-wiremock/blob/main/src/test/java/org/acme/wiremock/WireMockServerManager.java\" rel=\"nofollow noreferrer\">https://github.com/robyp1/app-quarkus-wiremock/blob/main/src/test/java/org/acme/wiremock/WireMockServerManager.java</a></p>\n",
    "tags" : [ "java", "quarkus", "wiremock", "quarkus-reactive", "wiremock-standalone" ],
    "owner" : {
      "account_id" : 5851066,
      "reputation" : 501,
      "user_id" : 4609725,
      "user_type" : "registered",
      "accept_rate" : 43,
      "profile_image" : "https://www.gravatar.com/avatar/7bcc5c9f9afbddfb706ddffde17145f0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "robyp7",
      "link" : "https://stackoverflow.com/users/4609725/robyp7"
    },
    "is_answered" : true,
    "view_count" : 89,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743537977,
    "creation_date" : 1742849366,
    "link" : "https://stackoverflow.com/questions/79532123/wiremock-verify-lost-threadlocal-context-in-quarkus-3-19-1-and-wiremock-3-0-1",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79549089,
    "question_id" : 79532123,
    "body" : "<p>Thanks to Tom i resolved using:</p>\n<p>wireMockClient.verifyThat(...)</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 5851066,
      "reputation" : 501,
      "user_id" : 4609725,
      "user_type" : "registered",
      "accept_rate" : 43,
      "profile_image" : "https://www.gravatar.com/avatar/7bcc5c9f9afbddfb706ddffde17145f0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "robyp7",
      "link" : "https://stackoverflow.com/users/4609725/robyp7"
    },
    "creation_date" : 1743537977,
    "last_activity_date" : 1743537977,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140284287,
    "post_id" : 79532123,
    "body" : "Hi @Tom, you re right! Thanks it works!",
    "score" : 0,
    "owner" : {
      "account_id" : 5851066,
      "reputation" : 501,
      "user_id" : 4609725,
      "user_type" : "registered",
      "accept_rate" : 43,
      "profile_image" : "https://www.gravatar.com/avatar/7bcc5c9f9afbddfb706ddffde17145f0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "robyp7",
      "link" : "https://stackoverflow.com/users/4609725/robyp7"
    },
    "creation_date" : 1743452769,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268738,
    "post_id" : 79532123,
    "body" : "You&#39;re mixing static and instance calls to the WireMock DSL, which isn&#39;t usually a good idea.  I suggest you use wireMockClient.verifyThat(...) rather than the static verify().  You could simplify things further (assuming WireMockServerManager is your test base class) by making the server protected and calling the DSL on it directly, removing the client.",
    "score" : 0,
    "owner" : {
      "account_id" : 991044,
      "reputation" : 4274,
      "user_id" : 1008361,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a15d69ce57773a0c918ac1e752b29646?s=256&d=identicon&r=PG",
      "display_name" : "Tom",
      "link" : "https://stackoverflow.com/users/1008361/tom"
    },
    "creation_date" : 1743068835,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140262743,
    "post_id" : 79532123,
    "body" : "@Tom i update to 3.12.1 but it doesnt work ..same problem",
    "score" : 0,
    "owner" : {
      "account_id" : 5851066,
      "reputation" : 501,
      "user_id" : 4609725,
      "user_type" : "registered",
      "accept_rate" : 43,
      "profile_image" : "https://www.gravatar.com/avatar/7bcc5c9f9afbddfb706ddffde17145f0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "robyp7",
      "link" : "https://stackoverflow.com/users/4609725/robyp7"
    },
    "creation_date" : 1742934485,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140260768,
    "post_id" : 79532123,
    "body" : "3.0.1 is a very old version of WireMock. Have you tried upgrading to the latest - 3.12.1?",
    "score" : 0,
    "owner" : {
      "account_id" : 991044,
      "reputation" : 4274,
      "user_id" : 1008361,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a15d69ce57773a0c918ac1e752b29646?s=256&d=identicon&r=PG",
      "display_name" : "Tom",
      "link" : "https://stackoverflow.com/users/1008361/tom"
    },
    "creation_date" : 1742905276,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}