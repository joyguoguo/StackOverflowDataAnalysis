{
  "question" : {
    "question_id" : 79739563,
    "title" : "Projected screen using Media Projection API is not showing on a surface view overlay in android studio",
    "body" : "<p>I'm developing an app that records the screen using the Media Projection API and transmit the data to an overlay surface view, however, the surface view and overlay components are visible but the projected display were not visible in the surface view. (here is my repository to try it out: <a href=\"https://github.com/xinzhao2627/eapp3/tree/master/app/src/main/java/com/example/explicitapp3\" rel=\"nofollow noreferrer\">https://github.com/xinzhao2627/eapp3/tree/master/app/src/main/java/com/example/explicitapp3</a>)</p>\n<p>(Using Android 16, API 36)</p>\n<p>My overlay in a service class looks like this:</p>\n<pre><code>@RequiresApi(api = Build.VERSION_CODES.O)\n    private void setupOverlay() {\n        LayoutInflater lf = (LayoutInflater) getSystemService(LAYOUT_INFLATER_SERVICE);\n\n        // this is the overlay view\n        View view = lf.inflate(R.layout.activity_overlay, null);\n        screenMirror = view.findViewById(R.id.screenMirror);\n        mSurface = screenMirror.getHolder().getSurface();\n\n        screenMirror.getHolder().addCallback(new SurfaceHolder.Callback() {\n            @Override\n            public void surfaceCreated(SurfaceHolder holder) {\n                mSurface = holder.getSurface();\n                if (mMediaProjection != null) startScreenCapture();\n            }\n            @Override public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {}\n            @Override public void surfaceDestroyed(SurfaceHolder holder) {}\n        });\n\n        windowManager = (WindowManager) getSystemService(WINDOW_SERVICE);\n        WindowManager.LayoutParams params = new WindowManager.LayoutParams(\n                900,\n                500,\n                WindowManager.LayoutParams.TYPE_APPLICATION_OVERLAY,\n                WindowManager.LayoutParams.FLAG_NOT_FOCUSABLE | WindowManager.LayoutParams.FLAG_NOT_TOUCHABLE,\n                PixelFormat.OPAQUE\n        );\n        params.gravity = Gravity.TOP | Gravity.LEFT;\n        params.x = 100;\n        params.y = 100;\n        // init the imageview\n        windowManager.addView(view, params);\n    }\n</code></pre>\n<p>what this above code do is display the surface view on top of the screen. Then I made the following startScreenCapture() function:</p>\n<pre><code>public void startScreenCapture() {\n    MediaProjection.Callback callback = new MediaProjection.Callback() {\n        @Override\n        public void onStop() {\n            super.onStop();\n            stopScreenCapture();\n        }\n    };\n    mMediaProjection.registerCallback(callback, null);\n\n    mVirtualDisplay = mMediaProjection.createVirtualDisplay(\n            &quot;ScreenCapture&quot;,\n            900,\n            500,\n            getResources().getDisplayMetrics().densityDpi,\n            DisplayManager.VIRTUAL_DISPLAY_FLAG_AUTO_MIRROR,\n            mSurface,\n            null,\n            null\n    );\n}\n</code></pre>\n<p>So the code should project the display into my mSurface. However it's just showing an empty screen and there's no error logs so I can't exactly pinpoint the probable cause.</p>\n<p>Steps I tried to solve the problem:</p>\n<ol>\n<li><p>Applying notification channels and followed a <a href=\"https://youtu.be/IvA2eCOL-j4?si=FwZg6ZyOFceCo4UF\" rel=\"nofollow noreferrer\">guide</a> but it also didnt work.</p>\n</li>\n<li><p>Tried changing the screenMirror component from SurfaceView to TextureView however, there are no visual changes.</p>\n</li>\n<li><p>Configuring Android Manifest and adding user permissions:</p>\n<p>android.permission.FOREGROUND_SERVICE,</p>\n<p>android.permission.FOREGROUND_SERVICE_MEDIA_PROJECTION,</p>\n<p>android.permission.SYSTEM_ALERT_WINDOW</p>\n</li>\n</ol>\n<p>Regarding the notification channels, here are the code snippet:</p>\n<p><strong>From the OverlayService.class</strong></p>\n<pre><code>@Override\npublic int onStartCommand(Intent intent, int flags, int startId) {\n    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {\n        NotificationHelper.createNotificationChannel(getApplicationContext());\n        notification = NotificationHelper.createNotification(getApplicationContext());\n        startForeground(SERVICE_ID, notification, ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION);\n    }\n    int rc = intent.getIntExtra(&quot;resultCode&quot;, -1);\n    Intent d = intent.getParcelableExtra(&quot;data&quot;);\n\n    if (rc != -1 &amp;&amp; d != null) {\n        mMediaProjection = mediaProjectionManager.getMediaProjection(rc, d);\n        if (mMediaProjection != null &amp;&amp; mSurface != null) {\n            startScreenCapture();\n        }\n    }\n    return START_STICKY;\n}\n</code></pre>\n<p><strong>From NotificationHelper.class</strong></p>\n<pre><code>private static final String CHANNEL_ID = &quot;screen_recording_channel&quot;;\n\npublic static Notification createNotification(Context context) {\n    Intent intent = new Intent(context, MainActivity.class);\n    PendingIntent pendingIntent = PendingIntent.getActivity(\n            context,\n            0,\n            intent,\n            PendingIntent.FLAG_IMMUTABLE\n    );\n\n    return new NotificationCompat.Builder(context, CHANNEL_ID)\n            .setContentTitle(&quot;Screen recording&quot;)\n            .setContentText(&quot;Recording in progress...&quot;)\n            .setSmallIcon(R.drawable.ic_launcher_foreground)\n            .setContentIntent(pendingIntent)\n            .build();\n}\n\npublic static void createNotificationChannel(Context context) {\n    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) {\n        NotificationChannel serviceChannel = new NotificationChannel(\n                CHANNEL_ID,\n                &quot;Screen Recording Channel&quot;,\n                NotificationManager.IMPORTANCE_DEFAULT\n        );\n\n        NotificationManager notificationManager =\n                (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);\n\n        if (notificationManager != null) {\n            notificationManager.createNotificationChannel(serviceChannel);\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "android", "android-studio", "android-service", "android-mediaprojection" ],
    "owner" : {
      "account_id" : 35495580,
      "reputation" : 13,
      "user_id" : 27242445,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/18879d75ac241a04ab7e4cd935cf443e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Arrgina 2657",
      "link" : "https://stackoverflow.com/users/27242445/arrgina-2657"
    },
    "is_answered" : false,
    "view_count" : 59,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1755604605,
    "creation_date" : 1755587277,
    "link" : "https://stackoverflow.com/questions/79739563/projected-screen-using-media-projection-api-is-not-showing-on-a-surface-view-ove",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79739867,
    "question_id" : 79739563,
    "body" : "<p>Update: I fixed the problem, turns that a good result code is -1 and not 1 which is why the entire MediaProjection is not working.</p>\n<pre><code>@Override\npublic int onStartCommand(Intent intent, int flags, int startId) {\n    if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.Q) {\n        NotificationHelper.createNotificationChannel(getApplicationContext());\n        notification = NotificationHelper.createNotification(getApplicationContext());\n        startForeground(SERVICE_ID, notification, ServiceInfo.FOREGROUND_SERVICE_TYPE_MEDIA_PROJECTION);\n    }\n    int rc = intent.getIntExtra(&quot;resultCode&quot;, -1);\n    Intent d = intent.getParcelableExtra(&quot;data&quot;);\n\n    // THIS SHOULD BE rc == -1 and not rc != -1\n    if (rc != -1 &amp;&amp; d != null) {\n        mMediaProjection = mediaProjectionManager.getMediaProjection(rc, d);\n        if (mMediaProjection != null &amp;&amp; mSurface != null) {\n            startScreenCapture();\n        }\n    }\n    return START_STICKY;\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 35495580,
      "reputation" : 13,
      "user_id" : 27242445,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/18879d75ac241a04ab7e4cd935cf443e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Arrgina 2657",
      "link" : "https://stackoverflow.com/users/27242445/arrgina-2657"
    },
    "creation_date" : 1755604605,
    "last_activity_date" : 1755604605,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140675643,
    "post_id" : 79739563,
    "body" : "I just set it to public now, my bad. Forgot to set up the visibility earlier",
    "score" : 0,
    "owner" : {
      "account_id" : 35495580,
      "reputation" : 13,
      "user_id" : 27242445,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/18879d75ac241a04ab7e4cd935cf443e?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Arrgina 2657",
      "link" : "https://stackoverflow.com/users/27242445/arrgina-2657"
    },
    "creation_date" : 1755591540,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140675613,
    "post_id" : 79739563,
    "body" : "The GitHub link is not working, do you have your repository set to public?",
    "score" : 0,
    "owner" : {
      "account_id" : 11363645,
      "reputation" : 12671,
      "user_id" : 8331157,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e9bf10e5b98d3834ba27b89e60cafe7b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "BenjyTec",
      "link" : "https://stackoverflow.com/users/8331157/benjytec"
    },
    "creation_date" : 1755590402,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}