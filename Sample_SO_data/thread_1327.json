{
  "question" : {
    "question_id" : 79718670,
    "title" : "How to retrieve metrics from Couchbase query?",
    "body" : "<p>Looking for an async solution? Look <a href=\"https://stackoverflow.com/questions/79775868/how-to-retrieve-metrics-from-couchbase-query-with-async-api\">here</a>. Otherwise read on.</p>\n<p>I am trying to delete documents that have expired via a query. I am not using Couchbase's feature of expiring documents as I need better control over this.</p>\n<p>Now apart from running a delete query like this</p>\n<pre><code>Instant threshold = Instant.now().minus(retention);\nString query = String.format(&quot;delete from %s.%s.%s where _lastmodified &lt; \\&quot;%s\\&quot;&quot;, bucketName, scopeName, collectionName, threshold);\nQueryResult result = cluster.query(query);\n</code></pre>\n<p>I'd like to see some metrics how many documents were impacted. For this I am challenging the <code>returning</code> clause but it only partly works for me. I can do something like</p>\n<pre><code>Instant threshold = Instant.now().minus(retention);\nString query = String.format(&quot;delete from %s.%s.%s where _lastmodified &lt; \\&quot;%s\\&quot; returning _id, _lastmodified&quot;, bucketName, scopeName, collectionName, threshold);\nQueryResult result = cluster.query(query);\n</code></pre>\n<p>and the query result will deliver all the identifiers and timestamps of the documents that were deleted. But I am more or also interested to see the metrics listed here: <a href=\"https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/insert.html#result\" rel=\"nofollow noreferrer\">https://docs.couchbase.com/server/current/n1ql/n1ql-language-reference/insert.html#result</a></p>\n<ul>\n<li>errors</li>\n<li>status</li>\n<li>metrics (elapsedTime, executionTime, resultCount, resultSize, and mutationCount)</li>\n</ul>\n<p>How can I get hold of those?</p>\n",
    "tags" : [ "java", "couchbase", "sql++" ],
    "owner" : {
      "account_id" : 5289146,
      "reputation" : 9940,
      "user_id" : 4222206,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/416696430ab23f397a5dbeda73e72896?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "queeg",
      "link" : "https://stackoverflow.com/users/4222206/queeg"
    },
    "is_answered" : true,
    "view_count" : 158,
    "answer_count" : 1,
    "score" : 4,
    "last_activity_date" : 1760040883,
    "creation_date" : 1753794643,
    "link" : "https://stackoverflow.com/questions/79718670/how-to-retrieve-metrics-from-couchbase-query",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79719191,
    "question_id" : 79718670,
    "body" : "<p>If the JSON returned by the server has a non-empty value for <code>errors</code>, the SDK always propagates the error as an exception.</p>\n<p>Similarly, if the <code>status</code> field in the JSON does not indicate success, the SDK always propagates the failure as an exception.</p>\n<p>If you enable metrics when executing the query, the QueryResult's metadata includes a QueryMetrics object you can inspect:</p>\n<pre class=\"lang-java prettyprint-override\"><code>QueryResult result = clusterOrScope.query(\n  statement,\n  QueryOptions.queryOptions()\n    .metrics(true)\n);\n\nQueryMetaData md = result.metaData();\nQueryMetrics metrics = md.metrics().orElseThrow();\n\nSystem.out.println(&quot;elapsedTime = &quot; + metrics.elapsedTime());\nSystem.out.println(&quot;executionTime = &quot; + metrics.executionTime());\nSystem.out.println(&quot;resultCount = &quot; + metrics.resultCount());\nSystem.out.println(&quot;resultSize = &quot; + metrics.resultSize());\nSystem.out.println(&quot;mutationCount: &quot; + metrics.mutationCount());\n</code></pre>\n<p>References:<br />\n<a href=\"https://docs.couchbase.com/java-sdk/current/howtos/sqlpp-queries-with-sdk.html#the-query-result\" rel=\"nofollow noreferrer\">https://docs.couchbase.com/java-sdk/current/howtos/sqlpp-queries-with-sdk.html#the-query-result</a></p>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 303087,
      "reputation" : 9068,
      "user_id" : 611819,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/oew2B.png?s=256",
      "display_name" : "dnault",
      "link" : "https://stackoverflow.com/users/611819/dnault"
    },
    "creation_date" : 1753821836,
    "last_activity_date" : 1753829726,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79719191" : [ {
      "comment_id" : 140628865,
      "post_id" : 79719191,
      "body" : "Setting queryOptions did the trick. Thank you!",
      "score" : 1,
      "owner" : {
        "account_id" : 5289146,
        "reputation" : 9940,
        "user_id" : 4222206,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/416696430ab23f397a5dbeda73e72896?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "queeg",
        "link" : "https://stackoverflow.com/users/4222206/queeg"
      },
      "creation_date" : 1753858175,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}