{
  "question" : {
    "question_id" : 79560999,
    "title" : "JmsEndpoint garbage collection?",
    "body" : "<p>My service uses Camel to read messages from several queues. Having recently migrated the JDK to Java 17 (and a number of dependencies for compatibility), I've seen a memory leak, tho I don't know that the two are related. I suspect the code presently doesn't properly collect garbage and that my JmsEndpoint interface object needs some combination of stop, shutdown, and close invoked. Presently, we are nowhere invoking any of these, nor are we using a try-with-resources block. A senior engineer I'm working with thinks garbage collection is being done behind the scenes by Spring or Camel. Below are relevant snippets of example code similar to what we've implemented. myMethod is called using the bean method in a route. We have implemented onException in the route, but we also aren't doing any explicit garbage collection there. Am I right that we need to explicitly collect garbage? Any other diagnoses?</p>\n<pre><code>import org.apache.camel.ConsumerTemplate;\nimport org.apache.camel.Exchange;\nimport org.apache.camel.component.jms.JmsComponent;\nimport org.apache.camel.component.jms.JmsEndpoint;\nimport org.springframework.beans.factory.annotation.Autowired;\n...\n\npublic class MyClass {\n\n    private JmsComponent jmsComponent;\n\n    @Autowired\n    ConsumerTemplate consumerTemplate;\n\n    ...\n\n    public void myMethod(Exchange exchange) {\n        //obviously-fake values below to protect the guilty\n        JmsEndpoint jmsEndpoint = new JmsEndpoint(&quot;uri&quot;, jmsComponent, &quot;destinationName&quot;, false, jmsConfiguration);\n\n        Exchange newExchange = null;\n\n        ...//logic for waiting, don't ask\n\n        newExchange = consumer.receiveNoWait(jmsEndpoint);\n\n        //something like the following?\n        //jmsEndpoint.close();\n\n        ...\n</code></pre>\n",
    "tags" : [ "java", "spring", "apache-camel", "ibm-mq" ],
    "owner" : {
      "account_id" : 12812865,
      "reputation" : 21,
      "user_id" : 9270417,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-dHf4ja20dvM/AAAAAAAAAAI/AAAAAAAADfU/2Rt-jqARz2w/s256-rj/photo.jpg",
      "display_name" : "Joshua Bennier",
      "link" : "https://stackoverflow.com/users/9270417/joshua-bennier"
    },
    "is_answered" : false,
    "view_count" : 98,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1745351266,
    "creation_date" : 1744074794,
    "link" : "https://stackoverflow.com/questions/79560999/jmsendpoint-garbage-collection",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140359124,
    "post_id" : 79560999,
    "body" : "@StephenC Sorry for the late reply: I was finally able to reproduce the bug in a test environment. A further response is below.",
    "score" : 0,
    "owner" : {
      "account_id" : 12812865,
      "reputation" : 21,
      "user_id" : 9270417,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-dHf4ja20dvM/AAAAAAAAAAI/AAAAAAAADfU/2Rt-jqARz2w/s256-rj/photo.jpg",
      "display_name" : "Joshua Bennier",
      "link" : "https://stackoverflow.com/users/9270417/joshua-bennier"
    },
    "creation_date" : 1745351235,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310080,
    "post_id" : 79560999,
    "body" : "Well here&#39;s the problem.  If you can&#39;t either reproduce the problem in test or capture a heap snapshot in prod, you are going to be guessing what the actual leak is.  You might get lucky ... or not.  Note that the JVM has to freeze while you capture the heap snapshot.  So, your organization / customers may need to wear a &quot;maintenance outage&quot; while you investigate ... in prod.",
    "score" : 1,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1744081730,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310077,
    "post_id" : 79560999,
    "body" : "@StephenC cont: there might be a better way to do this (than creating / tearing down JMS Endpoints dynamically), but the design I&#39;m inheriting looks at different queues based on an id in the exchange.",
    "score" : 0,
    "owner" : {
      "account_id" : 12812865,
      "reputation" : 21,
      "user_id" : 9270417,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-dHf4ja20dvM/AAAAAAAAAAI/AAAAAAAADfU/2Rt-jqARz2w/s256-rj/photo.jpg",
      "display_name" : "Joshua Bennier",
      "link" : "https://stackoverflow.com/users/9270417/joshua-bennier"
    },
    "creation_date" : 1744081595,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310066,
    "post_id" : 79560999,
    "body" : "Thanks for the replies @StephenC. I don&#39;t know that this is where the memory leak is coming from. I haven&#39;t used a memory profiler before, but anyway I&#39;m not sure I&#39;ll be in a position to use one. I don&#39;t rightly now how to replicate the problem in a test environment, and I don&#39;t think I&#39;ll be allowed to use the kind of tools needed to monitor it in prod. Perhaps I don&#39;t understand memory profilers tho.",
    "score" : 0,
    "owner" : {
      "account_id" : 12812865,
      "reputation" : 21,
      "user_id" : 9270417,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-dHf4ja20dvM/AAAAAAAAAAI/AAAAAAAADfU/2Rt-jqARz2w/s256-rj/photo.jpg",
      "display_name" : "Joshua Bennier",
      "link" : "https://stackoverflow.com/users/9270417/joshua-bennier"
    },
    "creation_date" : 1744081169,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310025,
    "post_id" : 79560999,
    "body" : "Note that you don&#39;t / shouldn&#39;t need to call the garbage collector explicitly in Java except in certain niche scenarios.   This isn&#39;t one of them.   Let the JVM decide when to run the GC. Memory leaks and resource leaks should be managed in other ways.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1744079353,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310021,
    "post_id" : 79560999,
    "body" : "Finally, your thought that calling <code>close()</code> should help is plausible.  Try it!! You should use <i>try with resource</i> to do that, otherwise you risk turning a fast leak into a slow leak; e.g. if <code>myMethod</code> terminates abnormally.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1744079099,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310015,
    "post_id" : 79560999,
    "body" : "Second ... why are you creating / tearing down JMS endpoints dynamically?  It strikes me that is rather heavy-weight and could lead to performance issues ... if done repeatedly.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1744078960,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140310009,
    "post_id" : 79560999,
    "body" : "First of all, have you <i>definitively</i> identified the code in the question as the source of the primary memory leak? Have you used a memory profiler, etc?  If not, there is a possibility that you are trying to fix the wrong leak or something that isn&#39;t a leak at all.",
    "score" : 1,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1744078666,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}