{
  "question" : {
    "question_id" : 79540677,
    "title" : "Security Configuration in Spring Boot Security with different Profiles and component based security",
    "body" : "<p>I am using a custom Spring Boot Starter for developing several microservices. That starter should contain some basic security configurations which I can use depending on which profile I am using in my service.</p>\n<p>I am using a HttpSecurityConfigurer like this:</p>\n<pre><code>@Configuration\n@ConditionalOnSingleCandidate(HttpSecurityConfigurer.class)\npublic class HttpSecurityConfigurerImpl implements HttpSecurityConfigurer {\n    @Override\n    public HttpSecurity configure(HttpSecurity http) throws Exception {\n        http.sessionManagement(c -&gt; c.sessionCreationPolicy(SessionCreationPolicy.STATELESS));\n        http.authorizeHttpRequests(c -&gt; c\n                        .requestMatchers(&quot;/actuator/health&quot;, &quot;/actuator/liveness&quot;).permitAll()\n                        .anyRequest().authenticated())\n                .httpBasic(Customizer.withDefaults())\n                .csrf(AbstractHttpConfigurer::disable);\n        return http;\n    }\n}\n</code></pre>\n<p>Than I have additional configuration to enable / disable Swagger-UI access:</p>\n<pre><code>@Configuration\n@Slf4j\n@EnableWebSecurity\n@RequiredArgsConstructor\n@ConditionalOnProfilesActive(value = Profiles.NOAUTH, match = Matching.NONE)\n@ConditionalOnProperty(name = SwaggerProperties + &quot;unrestricted&quot;, havingValue = &quot;true&quot;)\npublic class SecurityConfigSwaggerUiAutoConfiguration {\n\n    @Bean\n    @Order(2)\n    public SecurityFilterChain swaggerUiSecurityFilterChain(HttpSecurity http) throws Exception {\n        System.out.println(&quot;SwaggerUi&quot;);\n        http.securityMatcher(&quot;/swagger-ui/**).authorizeHttpRequests(requests -&gt;\n                requests.anyRequest().permitAll()\n        );\n        http.httpBasic(Customizer.withDefaults());\n        return http.build();\n    }\n}\n</code></pre>\n<p>Than I can enable LDAP access bei profile:</p>\n<pre><code>@Configuration\n@EnableWebSecurity\n@RequiredArgsConstructor\n@ConditionalOnProfilesActive(LDAP)\n@Slf4j\npublic class SecurityConfigLdapAutoConfiguration {\n    private final HttpSecurityConfigurer httpSecurityConfigurer;\n\n    @Bean\n    @Order(3)\n    public SecurityFilterChain ldapSecurityFilterChain(HttpSecurity http) throws Exception {\n        System.out.println(&quot;LDAP&quot;);\n        return httpSecurityConfigurer.configure(http).build();\n    }\n\n    @Bean\n    public CachingAuthenticationProvider ldapAuthenticationManager() {\n        var authenticationProvider = new ActiveDirectoryLdapAuthenticationProvider(&quot;my.domain&quot;, &quot;my.url&quot;, &quot;my.base&quot;);\n        authenticationProvider.setSearchFilter(&quot;my.searchFilter&quot;);\n        return new CachingAuthenticationProvider(authenticationProvider);\n    }\n}\n</code></pre>\n<p>So far, everything works fine. But now I want to add a new Profile for doing SAML authentication with a SAML Token. Therefore I added another Configuration:</p>\n<pre><code>@Configuration\n@EnableWebSecurity\n@RequiredArgsConstructor\n@ConditionalOnProfilesActive(SAML)\n@Slf4j\npublic class SecurityConfigSamlHeaderAutoConfiguration {\n\n    @Bean\n    @Order(3)\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n\n        System.out.println(&quot;SAML&quot;);\n\n        http.securityMatcher(&quot;/api/**&quot;)\n                .authorizeHttpRequests(authorizeRequests -&gt; authorizeRequests\n                        .anyRequest().authenticated())\n                .apply(samlLogin())\n                ;\n        return http.build();\n    }\n\n    @Bean\n    public CachingAuthenticationProvider authenticationProvider() {\n        var authenticationProvider = new ActiveDirectoryLdapAuthenticationProvider(\n                &quot;my.domain&quot;,\n                &quot;my.url&quot;,\n                &quot;my.base&quot;\n        );\n        authenticationProvider.setSearchFilter(my.searchFilter);\n        return new CachingAuthenticationProvider(authenticationProvider);\n    }\n}\n</code></pre>\n<p>But now, when I choose SAML profile it gives me an error:</p>\n<pre><code>Error creating bean with name 'org.springframework.security.config.annotation.web.configuration.WebSecurityConfiguration': Unsatisfied dependency expressed through method 'setFilterChains' parameter 0: Error creating bean with name 'securityFilterChain' defined in class path resource [com/my/basestarter/config/security/SecurityConfigSamlHeaderAutoConfiguration.class]: Failed to instantiate [org.springframework.security.web.SecurityFilterChain]: Factory method 'securityFilterChain' threw exception with message: Can't configure mvcMatchers after anyRequest&quot;\n</code></pre>\n<p>Can anybody help me finding the error? I thought I could do somethink similar like I did for the Swagger Configuration. But seems that I am missing something.</p>\n",
    "tags" : [ "java", "spring-boot", "spring-security" ],
    "owner" : {
      "account_id" : 4787866,
      "reputation" : 873,
      "user_id" : 3867820,
      "user_type" : "registered",
      "accept_rate" : 22,
      "profile_image" : "https://graph.facebook.com/1112018005/picture?type=large",
      "display_name" : "Daniel Pomrehn",
      "link" : "https://stackoverflow.com/users/3867820/daniel-pomrehn"
    },
    "is_answered" : false,
    "view_count" : 63,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743421657,
    "creation_date" : 1743142885,
    "link" : "https://stackoverflow.com/questions/79540677/security-configuration-in-spring-boot-security-with-different-profiles-and-compo",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}