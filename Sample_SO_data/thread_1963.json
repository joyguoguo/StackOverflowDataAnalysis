{
  "question" : {
    "question_id" : 79659836,
    "title" : "Spring Security WebAuthN confirguration",
    "body" : "<h1>I have a problem with WebAuthN realisation</h1>\n<p>For now I have JWT token authorization with custom <strong>UserDetailsService</strong> and <strong>UserDetails</strong>.</p>\n<p>I want to get <strong>JWT token</strong> after success WebAuthN authorization.</p>\n<p><strong>Problems</strong>:</p>\n<ol>\n<li>I got expection <strong>java.lang.IllegalStateException: Missing UserDetailsService Bean</strong></li>\n</ol>\n<p>After debugging I find out that WebAuthN <strong>can't qualify</strong> witch UserDetailsService bean it should use. So there is question: <strong>How to set my custom UserDetailsService to WebAuthN?</strong></p>\n<ol start=\"2\">\n<li>How to override after success authorization return JWT token?</li>\n</ol>\n<h2>Source code</h2>\n<pre><code>@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity\n@AllArgsConstructor\npublic class SecurityConfig {\n\n    JwtAuthFilter jwtAuthFilter;\n\n    @Bean\n    public UserDetailsService userDetailsService() {\n        return new UserDetailsServiceImpl();\n    }\n\n    @Bean\n    CorsConfigurationSource corsConfigurationSource() {\n        CorsConfiguration configuration = new CorsConfiguration();\n\n        configuration.setAllowedOrigins(Arrays.asList(\n                &quot;ORIGINS&quot;\n        ));\n        configuration.setAllowedHeaders(List.of(&quot;*&quot;));\n        configuration.setAllowedMethods(List.of(&quot;*&quot;));\n        configuration.setAllowCredentials(true);\n\n        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();\n        source.registerCorsConfiguration(&quot;/**&quot;, configuration);\n        return source;\n    }\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http.cors(Customizer.withDefaults()).csrf(AbstractHttpConfigurer::disable);\n        http.authorizeHttpRequests(auth -&gt; auth.requestMatchers(&quot;/api/admin/**&quot;).hasRole(&quot;ADMIN&quot;).requestMatchers(\n         &quot;PUBLIC ROUTERS&quot;\n        ).permitAll().anyRequest().authenticated());\n        http.sessionManagement(manager -&gt; manager.sessionCreationPolicy(SessionCreationPolicy.STATELESS));\n        http.authenticationManager(authenticationProvider());\n        http.logout(logout -&gt; logout.clearAuthentication(true).invalidateHttpSession(true).deleteCookies(&quot;JSESSIONID&quot;));\n        http.addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);\n        http.exceptionHandling(handler -&gt; handler.authenticationEntryPoint(new HttpStatusEntryPoint(HttpStatus.FORBIDDEN)));\n// **Problem code**\n        http.webAuthn(web-&gt; web\n                .allowedOrigins(&quot;localhost&quot;,\n                        &quot;https://app-test.1autokolonna.ru/&quot;,\n                        &quot;https://server-test.1autokolonna.ru/&quot;,\n                        &quot;https://app.1autokolonna.ru/&quot;,\n                        &quot;https://server.1autokolonna.ru/&quot;\n                )\n                .rpId(&quot;1autokolonna.ru&quot;)\n                .rpName(&quot;1Autokolonna rely party&quot;)\n        );\n// **Problem code**\n\n        return http.build();\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    public AuthenticationManager authenticationProvider() {\n        DaoAuthenticationProvider authenticationProvider = new DaoAuthenticationProvider(userDetailsService());\n        authenticationProvider.setPasswordEncoder(passwordEncoder());\n        return new ProviderManager(authenticationProvider);\n    }\n}\n</code></pre>\n<pre><code>@Component\npublic class UserDetailsServiceImpl implements UserDetailsService {\n\n    @Autowired\n    private UserRepository userRepository;\n\n    private static final Logger logger = LoggerFactory.getLogger(UserDetailsServiceImpl.class);\n\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        logger.debug(&quot;Entering in loadUserByUsername Method...&quot;);\n        User user = userRepository.findByPhone(username);\n        if(user == null){\n            logger.error(&quot;Username not found: &quot; + username);\n            throw new UsernameNotFoundException(&quot;could not found user..!!&quot;);\n        }\n        return new CustomUserDetails(user);\n    }\n}\n</code></pre>\n<pre><code>public class CustomUserDetails extends User implements UserDetails {\n\n    private final String username;\n    private final String password;\n    Collection&lt;? extends GrantedAuthority&gt; authorities;\n\n    public CustomUserDetails(User byUsername) {\n        this.username = byUsername.getPhone();\n        this.password = byUsername.getPassword();\n        List&lt;GrantedAuthority&gt; auths = new ArrayList&lt;&gt;();\n\n        for (Roles role : byUsername.getRoles()) {\n            auths.add(new SimpleGrantedAuthority(role.getName().toUpperCase()));\n        }\n        this.authorities = auths;\n    }\n\n    @Override\n    public Collection&lt;? extends GrantedAuthority&gt; getAuthorities() {\n        return authorities;\n    }\n\n    @Override\n    public String getPassword() {\n        return password;\n    }\n\n    @Override\n    public String getUsername() {\n        return username;\n    }\n\n    @Override\n    public boolean isAccountNonExpired() {\n        return true;\n    }\n\n    @Override\n    public boolean isAccountNonLocked() {\n        return true;\n    }\n\n    @Override\n    public boolean isCredentialsNonExpired() {\n        return true;\n    }\n\n    @Override\n    public boolean isEnabled() {\n        return true;\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "spring", "webauthn" ],
    "owner" : {
      "account_id" : 33489426,
      "reputation" : 1,
      "user_id" : 25926677,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/865872470ea6bf86ab38543be15045bd?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Vlad Kostyunin",
      "link" : "https://stackoverflow.com/users/25926677/vlad-kostyunin"
    },
    "is_answered" : false,
    "view_count" : 47,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749533344,
    "creation_date" : 1749533344,
    "link" : "https://stackoverflow.com/questions/79659836/spring-security-webauthn-confirguration",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}