{
  "question" : {
    "question_id" : 79542090,
    "title" : "Calling a Java function from C using Foreign Function &amp; Memory API",
    "body" : "<p>All examples I've come across for calling a Java method from C using the <a href=\"https://openjdk.org/jeps/454\" rel=\"nofollow noreferrer\">Foreign Function &amp; Memory API</a> involve callbacks, that is, a Java method that runs some native function with a Java callback as a parameter.</p>\n<p>What about C calling a Java method directly? Is <a href=\"https://en.m.wikipedia.org/wiki/Java_Native_Interface\" rel=\"nofollow noreferrer\">JNI</a> still the only way to do that?</p>\n",
    "tags" : [ "java", "java-native-interface", "project-panama" ],
    "owner" : {
      "account_id" : 428157,
      "reputation" : 769,
      "user_id" : 810297,
      "user_type" : "registered",
      "accept_rate" : 76,
      "profile_image" : "https://www.gravatar.com/avatar/4ab654de2c71950a720c6cf0302f3621?s=256&d=identicon&r=PG",
      "display_name" : "BCartolo",
      "link" : "https://stackoverflow.com/users/810297/bcartolo"
    },
    "is_answered" : true,
    "view_count" : 560,
    "answer_count" : 2,
    "score" : 4,
    "last_activity_date" : 1743388316,
    "creation_date" : 1743183640,
    "link" : "https://stackoverflow.com/questions/79542090/calling-a-java-function-from-c-using-foreign-function-memory-api",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79545215,
    "question_id" : 79542090,
    "body" : "<p>If you're looking for the equivalent of native functions like <a href=\"https://docs.oracle.com/en/java/javase/24/docs/specs/jni/functions.html#getmethodid\" rel=\"noreferrer\">GetMethodId</a>, <a href=\"https://docs.oracle.com/en/java/javase/24/docs/specs/jni/functions.html#getstaticmethodid\" rel=\"noreferrer\">GetStaticMethodId</a>, <a href=\"https://docs.oracle.com/en/java/javase/24/docs/specs/jni/functions.html#calltypemethod-routines-calltypemethoda-routines-calltypemethodv-routines\" rel=\"noreferrer\">CallMethod</a>, and <a href=\"https://docs.oracle.com/en/java/javase/24/docs/specs/jni/functions.html#callstatictypemethod-routines-callstatictypemethoda-routines-callstatictypemethodv-routines\" rel=\"noreferrer\">CallStaticMethod</a> from <em>Java Native Interface (JNI)</em>, then you're out of luck. The <em>Foreign Function &amp; Memory (FFM) API</em> does not provide an equivalent to those native functions. Keep in mind that JNI is a native library that you include in your own native library, which means there's a native API for interacting with the Java virtual machine. Whereas FFM is an entirely Java API. Not only is there no equivalent to <code>CallMethod</code> and such, there's no equivalent to <em>any</em> of the <em>native</em> API defined by JNI.</p>\n<p>Native code written with JNI is inherently aware that it's running in the context of a JVM. But the FFM API is designed to work with arbitrary native code, at least so long as the interface conforms to the ABI of C. Only the Java code is aware it's using the FFM API. The native code has no idea it's part of a Java application, let alone that the FFM API is being used. It has no way of interacting with the JVM directly.</p>\n<p>That said, the FFM API provides a way to pass <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/Linker.html#function-pointers\" rel=\"noreferrer\">function pointers</a> to native code with <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/Linker.html#upcallStub(java.lang.invoke.MethodHandle,java.lang.foreign.FunctionDescriptor,java.lang.foreign.Arena,java.lang.foreign.Linker.Option...)\" rel=\"noreferrer\">upcall stubs</a> in order to call Java methods from native. However, this is not equivalent to JNI:</p>\n<ul>\n<li><p>You have to create the upcall stub in Java and then pass it to the native code via a  <a href=\"https://docs.oracle.com/en/java/javase/24/docs/api/java.base/java/lang/foreign/Linker.html#downcallHandle(java.lang.foreign.MemorySegment,java.lang.foreign.FunctionDescriptor,java.lang.foreign.Linker.Option...)\" rel=\"noreferrer\">downcall handle</a>. There's no way to create the upcall stub on the native side.</p>\n</li>\n<li><p>You are limited to one Java method per upcall stub. And if it's an instance method, you're limited to calling that method on a single specific instance per upcall stub.</p>\n</li>\n<li><p>In contrast, the JNI functions work nearly the same as reflection, allowing you to call any method of a class or object. You of course need a reference to the <code>jclass</code> or <code>jobject</code>, but you don't necessarily have to get those from the Java side. It's possible to get the desired class or create the object using JNI's native API.</p>\n</li>\n</ul>\n<p>The first two points mean upcall stubs inherently function as callbacks, which is why examples of using upcall stubs demonstrate them as such.</p>\n",
    "score" : 5,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1743372005,
    "last_activity_date" : 1743388316,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79542199,
    "question_id" : 79542090,
    "body" : "<p>Yes, as far as I know JNI is still the only option to call a Java method from C. There are no alternatives currently in Project Panama for calling Java from native C.</p>\n",
    "score" : 4,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 18999437,
      "reputation" : 800,
      "user_id" : 13867124,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3f75c892f3b54042e7400ee33cd8af96?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "AztecCodes",
      "link" : "https://stackoverflow.com/users/13867124/azteccodes"
    },
    "creation_date" : 1743187244,
    "last_activity_date" : 1743187244,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140283642,
    "post_id" : 79542090,
    "body" : "We support both ways. Start with C and go to Java, or from Java it goes into C. Yeah I want to explore using FFM for calling C and passing function pointers and what not, but when it comes to C calling Java, looks like what I have will not change.",
    "score" : 0,
    "owner" : {
      "account_id" : 428157,
      "reputation" : 769,
      "user_id" : 810297,
      "user_type" : "registered",
      "accept_rate" : 76,
      "profile_image" : "https://www.gravatar.com/avatar/4ab654de2c71950a720c6cf0302f3621?s=256&d=identicon&r=PG",
      "display_name" : "BCartolo",
      "link" : "https://stackoverflow.com/users/810297/bcartolo"
    },
    "creation_date" : 1743441674,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140275578,
    "post_id" : 79542090,
    "body" : "What&#39;s the setup? Is the Java code the main program, or the C program? What&#39;s the use case? In the former case, you certainly can use Foreign Function &amp; Memory API and pass function pointers for Java methods that can be called from C.",
    "score" : 2,
    "owner" : {
      "account_id" : 180181,
      "reputation" : 79685,
      "user_id" : 413337,
      "user_type" : "registered",
      "accept_rate" : 64,
      "profile_image" : "https://www.gravatar.com/avatar/783783f968e84cf5047544e9a0f3ccf4?s=256&d=identicon&r=PG",
      "display_name" : "Codo",
      "link" : "https://stackoverflow.com/users/413337/codo"
    },
    "creation_date" : 1743196826,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79542199" : [ {
      "comment_id" : 140278724,
      "post_id" : 79542199,
      "body" : "It&#39;s possible that the original question was asked in this context. The core problem is getting an initial upcall handle to Java when the main program is written in C, and not upcalls in general. The way your answer is phrased, it&#39;s wrong.",
      "score" : 0,
      "owner" : {
        "account_id" : 180181,
        "reputation" : 79685,
        "user_id" : 413337,
        "user_type" : "registered",
        "accept_rate" : 64,
        "profile_image" : "https://www.gravatar.com/avatar/783783f968e84cf5047544e9a0f3ccf4?s=256&d=identicon&r=PG",
        "display_name" : "Codo",
        "link" : "https://stackoverflow.com/users/413337/codo"
      },
      "creation_date" : 1743323657,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140277958,
      "post_id" : 79542199,
      "body" : "@Codo I think the questioner is looking for an FFM equivalent to JNI&#39;s <code>Get[Static]MethodId</code> and <code>Call[Static]&lt;Type&gt;Method</code> functions. But JNI is a native API that&#39;s included in the native code. In contrast, the native code doesn&#39;t know anything about FFM (it&#39;s entirely on the Java side), so there&#39;s no equivalent &quot;call Java method&quot; API on the native side. The only choice is passing function pointers. I believe this answer is answering in that context, but I agree it could be clarified that upcall stubs exist, it&#39;s just that FFM does not provide a reflection-like API for calling Java methods.",
      "score" : 1,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49884,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1743285866,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140277854,
      "post_id" : 79542199,
      "body" : "The typical use of FFM is a downcall: calling a C function from Java (see <a href=\"https://docs.oracle.com/en/java/javase/24/core/calling-c-library-function-foreign-function-and-memory-api.html\" rel=\"nofollow noreferrer\">Calling a C Library Function with the FFM API</a>). The opposite is also available: upcalls for calling Java from C. When dealing with a C library, it&#39;s mainly used for callbacks. But it can be used for any call from C code (see <a href=\"https://docs.oracle.com/en/java/javase/24/core/upcalls-passing-java-code-function-pointer-foreign-function.html\" rel=\"nofollow noreferrer\">Upcalls: Passing Java Code as a Function Pointer to a Foreign Function</a>)",
      "score" : 1,
      "owner" : {
        "account_id" : 180181,
        "reputation" : 79685,
        "user_id" : 413337,
        "user_type" : "registered",
        "accept_rate" : 64,
        "profile_image" : "https://www.gravatar.com/avatar/783783f968e84cf5047544e9a0f3ccf4?s=256&d=identicon&r=PG",
        "display_name" : "Codo",
        "link" : "https://stackoverflow.com/users/413337/codo"
      },
      "creation_date" : 1743280829,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140277289,
      "post_id" : 79542199,
      "body" : "@Codo Are you sure? Seems like FFM Upcalls don&#39;t provide a direct functionality where native C code can call Java methods. I would really appreciate if you could elaborate your comment and maybe send a link to a documentation.",
      "score" : 0,
      "owner" : {
        "account_id" : 18999437,
        "reputation" : 800,
        "user_id" : 13867124,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3f75c892f3b54042e7400ee33cd8af96?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "AztecCodes",
        "link" : "https://stackoverflow.com/users/13867124/azteccodes"
      },
      "creation_date" : 1743264558,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140277240,
      "post_id" : 79542199,
      "body" : "A FFM upcall is calling a Java method from C. So I disagree with this answer. If the C program is the main program, it might be difficult to get an initial handle to Java, however.",
      "score" : 0,
      "owner" : {
        "account_id" : 180181,
        "reputation" : 79685,
        "user_id" : 413337,
        "user_type" : "registered",
        "accept_rate" : 64,
        "profile_image" : "https://www.gravatar.com/avatar/783783f968e84cf5047544e9a0f3ccf4?s=256&d=identicon&r=PG",
        "display_name" : "Codo",
        "link" : "https://stackoverflow.com/users/413337/codo"
      },
      "creation_date" : 1743262492,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}