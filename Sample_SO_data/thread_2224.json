{
  "question" : {
    "question_id" : 79636857,
    "title" : "PDFBox LayerUtility importing page as form double the pdf file size",
    "body" : "<p>I've a two page pdf <a href=\"https://drive.google.com/file/d/1jVrUfHuOz-JmLmN_CEHLND2tgwjtJ-be/view?usp=sharing\" rel=\"nofollow noreferrer\">Original file</a> that has the same PDF resources. When I import the page to form object using LayerUtility and save it to a new PDF (see the code snippet below), the output pdf file size is doubled <a href=\"https://drive.google.com/file/d/12ysd7LfNtySQTwmLSEFqic7QswltD6zE/view?usp=sharing\" rel=\"nofollow noreferrer\">Output pdf</a></p>\n<pre><code>import org.apache.pdfbox.Loader;\nimport org.apache.pdfbox.io.RandomAccessReadBufferedFile;\nimport org.apache.pdfbox.multipdf.LayerUtility;\nimport org.apache.pdfbox.pdmodel.PDDocument;\nimport org.apache.pdfbox.pdmodel.PDPage;\nimport org.apache.pdfbox.pdmodel.PDPageContentStream;\nimport java.util.stream.IntStream;\n\npublic class FormSample {\n    public static void main (String[] args) {\n        try {\n            try (var inputDocument = Loader.loadPDF(new RandomAccessReadBufferedFile(&quot;test.pdf&quot;));\n                 var outputDocument = new PDDocument()) {\n                IntStream.range(0, inputDocument.getNumberOfPages()).forEach(page-&gt; {\n                    try {\n                        var readPage = inputDocument.getPage(page);\n                        var form = new LayerUtility(outputDocument).importPageAsForm(inputDocument, readPage);\n\n                        var newPage = new PDPage(readPage.getMediaBox());\n                        outputDocument.addPage(newPage);\n\n                        try (var contentStream = new PDPageContentStream(outputDocument, newPage)) {\n                            contentStream.drawForm(form);\n                        }\n                    } catch (Exception e) {\n                        throw new RuntimeException(e);\n                    }\n                });\n                outputDocument.save(&quot;form_test.pdf&quot;);\n            }\n        } catch (Exception e) {\n            throw new RuntimeException(e);\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "pdfbox" ],
    "owner" : {
      "account_id" : 41685303,
      "reputation" : 11,
      "user_id" : 30404070,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0e488b6f0ec8626d120a461b7f52bb98?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kyle KYL",
      "link" : "https://stackoverflow.com/users/30404070/kyle-kyl"
    },
    "is_answered" : true,
    "view_count" : 54,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1748181128,
    "creation_date" : 1748096915,
    "link" : "https://stackoverflow.com/questions/79636857/pdfbox-layerutility-importing-page-as-form-double-the-pdf-file-size",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79636860,
    "question_id" : 79636857,
    "body" : "<p>I've noticed that if I move the instantiation of layer utility to an object and outside the loop, the generated PDF file is smaller</p>\n<pre><code>var layerUtility = new LayerUtility(outputDocument)) {\n                IntStream.range(0, inputDocument.getNumberOfPages()).forEach(page-&gt; {\n                    try {\n                        var readPage = inputDocument.getPage(page);\n                        var form = layerUtility.importPageAsForm(inputDocument, readPage);\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 41685303,
      "reputation" : 11,
      "user_id" : 30404070,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0e488b6f0ec8626d120a461b7f52bb98?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kyle KYL",
      "link" : "https://stackoverflow.com/users/30404070/kyle-kyl"
    },
    "creation_date" : 1748097154,
    "last_activity_date" : 1748181128,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140456844,
    "post_id" : 79636857,
    "body" : "@TilmanHausherr What I was trying to test out is to rotation with PDFBox. Let&#39;s say if i were to rotate a PDF with landscape images on each pages to 90 degrees, I&#39;m expecting that the media box and crop box width and height to be swapped. If I do this with PDPage.setRotation, although the page is rotated but the media/crop box width and height is not swapped. This is why I&#39;m forced to resort to form object creation but this would double the PDF file size to if multiple pages has the same PDF resource",
    "score" : 0,
    "owner" : {
      "account_id" : 41685303,
      "reputation" : 11,
      "user_id" : 30404070,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0e488b6f0ec8626d120a461b7f52bb98?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kyle KYL",
      "link" : "https://stackoverflow.com/users/30404070/kyle-kyl"
    },
    "creation_date" : 1748166315,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140455735,
    "post_id" : 79636857,
    "body" : "In the output file the image is there twice, that&#39;s the reason. PDFBox doesn&#39;t know that it&#39;s the same thing and it does a clone each time. (Not cloning might bring other problems). If you just want a background, then extract the image and use that one directly.",
    "score" : 1,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19234,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1748106478,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140455453,
    "post_id" : 79636857,
    "body" : "However if I create my own custom LayerUtility class and replace the following importPageAsForm() code below <code>PDResources formRes = new PDResources();         cloner.cloneMerge(pageRes, formRes);         form.setResources(formRes);</code> to <code>form.setResources(page.getResources());</code> The generated output file size is expected [link]<a href=\"https://drive.google.com/file/d/10hYpkS8iBNZrrYU0Lx34oj_ZXlhhXcrF/view?usp=sharing[/link]\" rel=\"nofollow noreferrer\">drive.google.com/file/d/10hYpkS8iBNZrrYU0Lx34oj_ZXlhhX&zwnj;&#8203;crF/&hellip;</a>. Is there an issue with LayerUtility class in handling multiple pages pdf with shared resources?",
    "score" : 0,
    "owner" : {
      "account_id" : 41685303,
      "reputation" : 11,
      "user_id" : 30404070,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0e488b6f0ec8626d120a461b7f52bb98?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Kyle KYL",
      "link" : "https://stackoverflow.com/users/30404070/kyle-kyl"
    },
    "creation_date" : 1748097213,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}