{
  "question" : {
    "question_id" : 79740212,
    "title" : "Spring Boot application with JDK 24 AOT cache often hangs at startup",
    "body" : "<p>I'm facing a perplexing and frustrating issue with a Spring Boot application that uses a JDK 24 AOT (Ahead-of-Time) cache (this is not native compilation, but just attempting to use the AOT cache). The application often hangs during startup when running with the AOT cache enabled. I'm looking for advice on how to diagnose and, more importantly, resolve this problem.</p>\n<p><strong>Problem Description</strong></p>\n<p>My application, built with <strong>Spring Boot 3</strong> (using version 3.5.4) and <strong>JDK 24</strong>, is packaged into a container image using <strong>Maven Jib</strong>. I have a multi-step process to build the AOT cache:</p>\n<ol>\n<li>I build a fat Spring Boot <code>.jar</code>.</li>\n<li>Inside the target container's exact base image (Java 24), I perform the following steps:\n<ul>\n<li>Unpack the <code>.jar</code> using <code>-Djarmode=tools</code>.</li>\n<li>Copy the unpacked contents (<code>myapp.jar</code> and the <code>lib</code> directory) to <code>/app</code>.</li>\n<li>Run the application as a <code>.jar</code> with <code>AOTMode=record</code> and then create the AOT cache with <code>AOTMode=create</code> (something like <a href=\"https://docs.spring.io/spring-framework/reference/7.0-SNAPSHOT/integration/aot-cache.html#_creating_the_cache\" rel=\"nofollow noreferrer\">this</a>)</li>\n<li>Ensure all file timestamps are set to the start of the Unix epoch, as Jib requires this.</li>\n</ul>\n</li>\n<li>The final container image contains <code>/app/myapp.jar</code>, <code>/app/aot.app</code> (the cache), and all <code>/app/lib</code> libraries. The custom entry point is <code>java -XX:AOTCache=/app/app.aot -jar /app/myapp.jar</code>.</li>\n</ol>\n<p>This setup loads the AOT cache successfully. However, the application's startup behavior is inconsistent: in my tests, it starts successfully only about 20% of the time (faster, as desired and expected), hanging the other 80% of the time (so, startup time is... infinite).</p>\n<p>When the application hangs, it always appears to be stuck in the main startup thread. A thread dump consistently points to the <code>java.lang.invoke.DirectMethodHandleHolder.invokeStatic</code> method. The thread state is <code>RUNNABLE</code>, but it doesn't seem to make any progress. The thread dump looks like this:</p>\n<pre><code>&quot;main&quot; #3 [5925] prio-5 os_prio=0 cpu=32236.90ms elapsed=36.51s tid=0x00007f1a2802bb00 nid=5925 runnable\n[0x00007fla2e085000]\njava.lang.Thread.State: RUNNABLE\nat java.lang.invoke.DirectMethodHandleHolder.invokeStatic(java.base@24.0.2/DirectMethodHandleHolder)\nat java.lang.invoke.DelegatingMethodHandleHolder.delegate (java.base@24.0.2/DelegatingMethodHandleHolder)\nat java.lang.invoke.BootstrapMethodInvoker.invoke(java.base@24.0.2/BootstrapMethodInvoker.java:102)\nat java.lang.invoke.CallSite.makeSite (java.base@24.0.2/CallSite.java:310)\nat java.lang.invoke.MethodHandleNatives.linkCallSiteImpl(java.base@24.0.2/MethodHandleNatives.java:250)\nat java.lang.invoke.MethodHandleNatives.linkCallSite (java.base@24.0.2/MethodHandleNatives.java:240)\nat org.springframework.web.servlet.handler.AbstractHandlerMapping.formatMappingName (AbstractHandlerMapping.java:406)\nat org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.handlerMethodsInitialized (AbstractHandlerMethodMapping.java:366)\nat org.springframework.web.servlet.handler.AbstractHandlerMethodMapping.initHandlerMethods (AbstractHandlerMethodMapping.java:227)\n</code></pre>\n<p>I noticed some warnings when creating the AOT cache, though I haven't been able to correlate them with the hanging issue. Excerpts:</p>\n<pre><code>187 [5.271s] [warning] [cds] Preload Warning: Verification failed for org.springframework.transaction.reactive.TransactionalOperator\n188 [6.378s] [warning] [cds] Preload Warning: Verification failed for org.springframework.web.servlet.view.freemarker.FreeMarkerView\n189 [6.426s] [warning] [cds] Skipping jdk/internal/event/Event: JFR event class\n190 [6.428s] [warning] [cds] Skipping io/github/resilience4j/spring6/circuitbreaker/configure/RxJava3CircuitBreakerAspectExt: Failed verification\n</code></pre>\n<p><strong>Questions</strong></p>\n<ul>\n<li>Has anyone encountered a similar issue with Spring Boot, JDK 24, and AOT caches?</li>\n<li>What debugging techniques can I use to understand why this specific <code>MethodHandleHolder</code> invocation is stalling?</li>\n<li>Could the AOT cache creation warnings be related to the hang, and if so, how might I address them?</li>\n</ul>\n<p>Any insights or suggestions on how to approach this would be greatly appreciated.</p>\n<p><strong>Addendum:</strong></p>\n<p>I have also seen hanging threads like the following, though the one I show above was dominant for me.</p>\n<pre><code>   java.lang.Thread.State: RUNNABLE\n        at java.lang.invoke.DirectMethodHandle$Holder.invokeStatic(java.base@24.0.2/DirectMethodHandle$Holder)\n        at java.lang.invoke.DelegatingMethodHandle$Holder.delegate(java.base@24.0.2/DelegatingMethodHandle$Holder)\n        at java.lang.invoke.BootstrapMethodInvoker.invoke(java.base@24.0.2/BootstrapMethodInvoker.java:102)\n        at java.lang.invoke.CallSite.makeSite(java.base@24.0.2/CallSite.java:310)\n        at java.lang.invoke.MethodHandleNatives.linkCallSiteImpl(java.base@24.0.2/MethodHandleNatives.java:250)\n        at java.lang.invoke.MethodHandleNatives.linkCallSite(java.base@24.0.2/MethodHandleNatives.java:240)\n        at org.apache.tomcat.util.net.NioEndpoint.startInternal(NioEndpoint.java:303)\n        at org.apache.tomcat.util.net.AbstractEndpoint.start(AbstractEndpoint.java:1485)\n        at org.apache.coyote.AbstractProtocol.start(AbstractProtocol.java:644)\n        at org.apache.catalina.connector.Connector.startInternal(Connector.java:1103)\n        at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:164)\n        - locked &lt;0x00000000f2286508&gt; (a org.apache.catalina.connector.Connector)\n        at org.apache.catalina.core.StandardService.addConnector(StandardService.java:219)\n        at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.addPreviouslyRemovedConnectors(TomcatWebServer.java:310)\n        at org.springframework.boot.web.embedded.tomcat.TomcatWebServer.start(TomcatWebServer.java:236)\n</code></pre>\n<p>Turning off <a href=\"https://openjdk.org/jeps/483#:%7E:text=used%20it%20directly.-,The%20AOT%20cache,-builds%20upon%20CDS\" rel=\"nofollow noreferrer\">class linking</a> via <code>XX:-AOTClassLinking</code> makes the application <em>start up without hanging</em>, with some performance penalty.\nAI keeps telling me that the generated <code>app.aotconf</code> can be edited between <code>record</code> and <code>create</code> to exempt classes, but I am doubtful and cannot find any documentation on this. There's the claim that the config file is compatible with <code>jaotc</code>, but I am skeptical. Any comments on this potential approach would be welcome, too.</p>\n<p><strong>Update</strong></p>\n<p>I cannot reproduce this with a <code>openjdk:25-jdk-slim</code> container image, so it is possible I am seeing an already fixed issue in JDK 24. This means my application starts up successfully using an AOT cache <em>with</em> class linking. I will go forward assuming that the JDK 25 release will also be good. Thanks to everyone for looking into this!</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "java-aot" ],
    "owner" : {
      "account_id" : 1153544,
      "reputation" : 556,
      "user_id" : 1134748,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdW7f.jpg?s=256",
      "display_name" : "JanDasWiesel",
      "link" : "https://stackoverflow.com/users/1134748/jandaswiesel"
    },
    "is_answered" : false,
    "view_count" : 487,
    "answer_count" : 0,
    "score" : 5,
    "last_activity_date" : 1756224058,
    "creation_date" : 1755623081,
    "link" : "https://stackoverflow.com/questions/79740212/spring-boot-application-with-jdk-24-aot-cache-often-hangs-at-startup",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140693691,
    "post_id" : 79740212,
    "body" : "The application works fine with openjdk:25-jdk-slim - so maybe I am hitting a bug with JDK 24. I updated my question with this information.",
    "score" : 0,
    "owner" : {
      "account_id" : 1153544,
      "reputation" : 556,
      "user_id" : 1134748,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdW7f.jpg?s=256",
      "display_name" : "JanDasWiesel",
      "link" : "https://stackoverflow.com/users/1134748/jandaswiesel"
    },
    "creation_date" : 1756224108,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140682427,
    "post_id" : 79740212,
    "body" : "I am experiencing this in a highly regulated company environment and cannot simply demonstrate the problem on the internet. It will be some days before I can attempt to. Should I succeed in creating a reproducible example privately, I would update the question with this.",
    "score" : 0,
    "owner" : {
      "account_id" : 1153544,
      "reputation" : 556,
      "user_id" : 1134748,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdW7f.jpg?s=256",
      "display_name" : "JanDasWiesel",
      "link" : "https://stackoverflow.com/users/1134748/jandaswiesel"
    },
    "creation_date" : 1755787594,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140680323,
    "post_id" : 79740212,
    "body" : "Can you please create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>? Can you please also try with <a href=\"https://jdk.java.net/25/\" rel=\"nofollow noreferrer\">the current JDK 25 release candidate</a>?",
    "score" : 0,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1755721465,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140677993,
    "post_id" : 79740212,
    "body" : "Updated the question; I am using Spring Boot 3.5.4",
    "score" : 0,
    "owner" : {
      "account_id" : 1153544,
      "reputation" : 556,
      "user_id" : 1134748,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdW7f.jpg?s=256",
      "display_name" : "JanDasWiesel",
      "link" : "https://stackoverflow.com/users/1134748/jandaswiesel"
    },
    "creation_date" : 1755659637,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140677235,
    "post_id" : 79740212,
    "body" : "Which exact version of Spring Boot?",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1755627295,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}