{
  "question" : {
    "question_id" : 79735538,
    "title" : "@PreAuthorize Failed to evaluate SPeL when expression is a method from an external package",
    "body" : "<p>My microservice depends on an <strong>external package</strong> responsible for securing endpoints.\nThat package uses <strong>Feign</strong> to communicate with another microservice.</p>\n<p>I’m trying to secure a dummy endpoint using <code>@PreAuthorize</code>, but the expression isn’t being recognized.\nI suspected that the relevant dependencies weren’t being scanned, but maybe I am missing a config.</p>\n<pre><code>{\n  &quot;type&quot;: &quot;https://www.jhipster.tech/problem/problem-with-message&quot;,\n  &quot;title&quot;: &quot;Internal Server Error&quot;,\n  &quot;status&quot;: 500,\n  &quot;detail&quot;: &quot;Failed to evaluate expression '@myAuthorizationService.myMethod(#projectId, #reverseProxyHeader)'&quot;,\n  &quot;path&quot;: &quot;/my-API/test-preauthorize/688doomyID314a3a&quot;,\n  &quot;message&quot;: &quot;error.http.500&quot;\n}\n</code></pre>\n<p><strong>Main application class</strong></p>\n<pre><code>@SpringBootApplication\n@ComponentScan({ &quot;my.main.app&quot;, &quot;my.package&quot; })\npublic class MainApplication {...}\n</code></pre>\n<p><strong>Feign Configuration</strong></p>\n<pre><code>@Configuration\n@EnableFeignClients(basePackages = { &quot;my.main.app&quot;, &quot;my.package&quot; })\n@Import(FeignClientsConfiguration.class)\npublic class FeignConfiguration {...}\n</code></pre>\n<p><strong>Doomy securized endpoint</strong></p>\n<pre><code>@GetMapping(&quot;observations/test-preauthorize/{projectId}&quot;)\n@PreAuthorize(&quot;@myAuthorizationService.isProjectExecuteQuery(#projectId, #reverseProxyHeader)&quot;)\npublic void testPreauthorize(\n    @RequestHeader(name = &quot;traefik&quot;, required = false, defaultValue = &quot;false&quot;) Boolean reverseProxyHeader,\n    @PathVariable(name = &quot;projectId&quot;) String projectId\n) {...}\n</code></pre>\n<p>}</p>\n<p><strong>MyAuthorizationService</strong> (in package)</p>\n<pre><code>@Service(&quot;myAuthorizationService&quot;)\npublic class MyAuthorizationService {...}\n</code></pre>\n<p>The service needs 2 dependencies injected via constructor. There are interfaces.</p>\n<p><strong>UPDATED 1</strong></p>\n<p><strong>StackTrace</strong></p>\n<pre><code>        at java.base/java.lang.Thread.run(Unknown Source)   \n    Caused by: org.springframework.expression.spel.SpelEvaluationException: EL1058E: A problem occurred when trying to resolve bean 'authorizationService':'Could not resolve bean reference against BeanFactory'    \n        at org.springframework.expression.spel.ast.BeanReference.getValueInternal(BeanReference.java:59)  \n        at org.springframework.expression.spel.ast.CompoundExpression.getValueRef(CompoundExpression.java:55)    \n        at org.springframework.expression.spel.ast.CompoundExpression.getValueInternal(CompoundExpression.java:91)    \n        at org.springframework.expression.spel.ast.SpelNodeImpl.getTypedValue(SpelNodeImpl.java:117)\n        at org.springframework.expression.spel.standard.SpelExpression.getValue(SpelExpression.java:308)    \n        at org.springframework.security.access.expression.ExpressionUtils.evaluateAsBoolean(ExpressionUtils.java:30)    \n        ... 131 common frames omitted    \n    Caused by: org.springframework.expression.AccessException: Could not resolve bean reference against BeanFactory    \n        at org.springframework.context.expression.BeanFactoryResolver.resolve(BeanFactoryResolver.java:54)    \n        at org.springframework.expression.spel.ast.BeanReference.getValueInternal(BeanReference.java:55)    \n        ... 136 common frames omitted    \n    Caused by: org.springframework.beans.factory.NoSuchBeanDefinitionException: No bean named 'authorizationService' available    \n        at org.springframework.beans.factory.support.DefaultListableBeanFactory.getBeanDefinition(DefaultListableBeanFactory.java:863)    \n        at org.springframework.beans.factory.support.AbstractBeanFactory.getMergedLocalBeanDefinition(AbstractBeanFactory.java:1344)    \n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:309)    \n        at org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:283)    \n        at org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:208)    \n        at org.springframework.context.support.AbstractApplicationContext.getBean(AbstractApplicationContext.java:1154)    \n        at org.springframework.context.expression.BeanFactoryResolver.resolve(BeanFactoryResolver.java:51)    \n        ... 137 common frames omitted\n</code></pre>\n<p><strong>UPDATED 2</strong></p>\n<p>The package was not properly scanned because of a typo.\nIt leads to an error of a missing bean of a MongoRepository.\nI am fixing it using <code>@EnableMongoRepositories</code> pointing to the correct package. However I still have the following error:</p>\n<pre><code>Parameter 1 of constructor in my.package.authorization.service.AuthorizationService required a bean named 'mongoTemplate' that could not be found.\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "javabeans", "feign" ],
    "owner" : {
      "account_id" : 8056132,
      "reputation" : 403,
      "user_id" : 6073219,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/e746f335363b80c443a3b206851f4970?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ryley38",
      "link" : "https://stackoverflow.com/users/6073219/ryley38"
    },
    "is_answered" : false,
    "view_count" : 159,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1755360434,
    "creation_date" : 1755181549,
    "link" : "https://stackoverflow.com/questions/79735538/preauthorize-failed-to-evaluate-spel-when-expression-is-a-method-from-an-extern",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79736845,
    "question_id" : 79735538,
    "body" : "<p>You need to define a custom configuration file in your java application which should configure these things as part of application startup.</p>\n<p>Below are the configuration files I have used in my application, and it is working perfectly fine in production with JWT Authentication and Authorization.</p>\n<p>Please try these and let me know if they work for you:</p>\n<p>Main Config file, <strong>WebConfig.java:</strong></p>\n<pre><code>@Configuration\n@EnableWebSecurity\n@EnableMethodSecurity(prePostEnabled = true)\npublic class WebConfig implements WebMvcConfigurer {\n\n    @Override\n    public void addCorsMappings(CorsRegistry registry) {\n        registry.addMapping(&quot;/**&quot;) // Allow all endpoints\n                .allowedOrigins(&quot;*&quot;) // Allow all origins\n                .allowedMethods(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;)\n                .allowedHeaders(&quot;*&quot;)\n                .exposedHeaders(&quot;Authorization&quot;); // Allow all headers\n    }\n    \n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http, ApiKeyAuthenticationFilter apiKeyAuthenticationFilter) throws Exception {\n        http.csrf(csrf -&gt; csrf.disable())\n            .cors(cors -&gt; cors.configurationSource(request -&gt; {\n                var corsConfiguration = new org.springframework.web.cors.CorsConfiguration();\n                corsConfiguration.setAllowedOrigins(List.of(&quot;*&quot;));\n                corsConfiguration.setAllowedMethods(List.of(&quot;GET&quot;, &quot;POST&quot;, &quot;PUT&quot;, &quot;DELETE&quot;, &quot;OPTIONS&quot;));\n                corsConfiguration.setAllowedHeaders(List.of(&quot;*&quot;));\n                corsConfiguration.setExposedHeaders(List.of(&quot;Authorization&quot;));\n                return corsConfiguration;\n            }))\n            .exceptionHandling()\n            .authenticationEntryPoint((request, response, authException) -&gt; \n                response.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Unauthorized: No token provided&quot;))\n            .and()\n            .authorizeHttpRequests(auth -&gt; \n                auth.requestMatchers(\n                        &quot;/controller/userLoginService/login&quot;, \n                        &quot;/controller/userRegistrationService/signup&quot;).permitAll()\n                    .anyRequest().authenticated()\n            )\n            .addFilterBefore(apiKeyAuthenticationFilter, UsernamePasswordAuthenticationFilter.class);\n        return http.build();\n    }\n\n    @Bean\n    public GrantedAuthorityDefaults grantedAuthorityDefaults() {\n        return new GrantedAuthorityDefaults(&quot;&quot;); // Remove the &quot;ROLE_&quot; prefix\n    }\n    \n    @Bean\n    public ApiKeyAuthenticationFilter apiKeyAuthenticationFilter(JwtUtils jwtUtils) {\n        return new ApiKeyAuthenticationFilter(jwtUtils);\n    }\n\n}\n</code></pre>\n<p><strong>ApiKeyAuthenticationFilter.java:</strong></p>\n<pre><code>public class ApiKeyAuthenticationFilter extends OncePerRequestFilter {\n\n    private static final Logger logger = LoggerFactory.getLogger(ApiKeyAuthenticationFilter.class);\n\n    private final JwtUtils jwtUtils;\n\n    @Autowired\n    public ApiKeyAuthenticationFilter(JwtUtils jwtUtils) {\n        this.jwtUtils = jwtUtils;\n    }\n    \n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)\n            throws ServletException, IOException {\n        String jwt = parseJwt(request);\n        if (jwt != null &amp;&amp; jwtUtils.validateJwtToken(jwt)) {\n            String username = jwtUtils.getUserNameFromJwtToken(jwt);\n            String role = jwtUtils.getRoleFromJwtToken(jwt);\n\n            logger.info(&quot;Authenticated user: &quot; + username + &quot; with role: &quot; + role);\n            logger.info(&quot;roleWithPrefix with role: &quot; + role);\n\n            List&lt;GrantedAuthority&gt; authorities = List.of(new SimpleGrantedAuthority(role));\n            UsernamePasswordAuthenticationToken authentication =\n                new UsernamePasswordAuthenticationToken(username, null, authorities);\n\n            SecurityContextHolder.getContext().setAuthentication(authentication);\n        }\n        filterChain.doFilter(request, response);\n    }\n\n    private String parseJwt(HttpServletRequest request) {\n        String headerAuth = request.getHeader(&quot;Authorization&quot;);\n        if (StringUtils.hasText(headerAuth) &amp;&amp; headerAuth.startsWith(&quot;Bearer &quot;)) {\n            return headerAuth.substring(7);\n        }\n        return null;\n    }\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43521634,
      "reputation" : 1,
      "user_id" : 31283152,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a6eb4bc1d135d6d1dae74ebd264bb7d1?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Himanshu Singh",
      "link" : "https://stackoverflow.com/users/31283152/himanshu-singh"
    },
    "creation_date" : 1755292393,
    "last_activity_date" : 1755292393,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140665860,
    "post_id" : 79735538,
    "body" : "@M.Deinum Correct. It was indeed a typo from my side in the package path. The service name was changed on purpose. I have edited the question with more details",
    "score" : 0,
    "owner" : {
      "account_id" : 8056132,
      "reputation" : 403,
      "user_id" : 6073219,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/e746f335363b80c443a3b206851f4970?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ryley38",
      "link" : "https://stackoverflow.com/users/6073219/ryley38"
    },
    "creation_date" : 1755185462,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140665847,
    "post_id" : 79735538,
    "body" : "Yes it should but we can nowhere verify that the packages are correct. Next to that your error indicates an <code>authorizationService</code> not a <code>myAuthorizationService</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1755185096,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140665795,
    "post_id" : 79735538,
    "body" : "@M.Deinum I guess so but what could be the reason ? Shouldn&#39;t this annotation scans the packages et sub packages? The service has <code>@Service</code>. It&#39;s two dependencies are interfaces. One has @Component annotation, the other has <code>@Repository</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 8056132,
      "reputation" : 403,
      "user_id" : 6073219,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/e746f335363b80c443a3b206851f4970?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ryley38",
      "link" : "https://stackoverflow.com/users/6073219/ryley38"
    },
    "creation_date" : 1755183779,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140665774,
    "post_id" : 79735538,
    "body" : "Well the error is pretty clear <code>No bean named &#39;authorizationService&#39; available</code> there is no service with that name being registered. So this looks like your <code>@ComponentScan</code> isn&#39;t covering the package that the service is in. Note: It also doesn&#39;t look like the full stacktrace to be honest.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1755183362,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140665770,
    "post_id" : 79735538,
    "body" : "@M.Deinum, question is updated with stackTrace. I don&#39;t get why the bean is not resolved",
    "score" : 0,
    "owner" : {
      "account_id" : 8056132,
      "reputation" : 403,
      "user_id" : 6073219,
      "user_type" : "registered",
      "accept_rate" : 80,
      "profile_image" : "https://www.gravatar.com/avatar/e746f335363b80c443a3b206851f4970?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ryley38",
      "link" : "https://stackoverflow.com/users/6073219/ryley38"
    },
    "creation_date" : 1755183339,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79736845" : [ {
      "comment_id" : 140698588,
      "post_id" : 79736845,
      "body" : "@HimanshuSingh That is not how Stack Overflow works. Answers are to actually answer the question asked, not provide a tutorial and then hopefully the reader can figure it out on their own.",
      "score" : 0,
      "owner" : {
        "account_id" : 187094,
        "reputation" : 5301,
        "user_id" : 424903,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
        "display_name" : "Gimby",
        "link" : "https://stackoverflow.com/users/424903/gimby"
      },
      "creation_date" : 1756385616,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140675924,
      "post_id" : 79736845,
      "body" : "@Ryley38 I tried explaining the simple flow which I used in my application for Authentication and Authorization which is working fine in my application. Using this you should be able to introduce Authentication and Authorization in no time.",
      "score" : 0,
      "owner" : {
        "account_id" : 43521634,
        "reputation" : 1,
        "user_id" : 31283152,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/a6eb4bc1d135d6d1dae74ebd264bb7d1?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Himanshu Singh",
        "link" : "https://stackoverflow.com/users/31283152/himanshu-singh"
      },
      "creation_date" : 1755598965,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140672831,
      "post_id" : 79736845,
      "body" : "Could you clarify which part of your code is most relevant to my question?",
      "score" : 0,
      "owner" : {
        "account_id" : 8056132,
        "reputation" : 403,
        "user_id" : 6073219,
        "user_type" : "registered",
        "accept_rate" : 80,
        "profile_image" : "https://www.gravatar.com/avatar/e746f335363b80c443a3b206851f4970?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Ryley38",
        "link" : "https://stackoverflow.com/users/6073219/ryley38"
      },
      "creation_date" : 1755501684,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}