{
  "question" : {
    "question_id" : 79618824,
    "title" : "Security Context Not Propagated When Calling Tools in Spring AI MCP Server",
    "body" : "<p>I'm integrating a Spring Boot application with the Spring AI MCP Server (spring-ai-starter-mcp-server-webmvc). I'm testing it using another Spring Boot application as the client, leveraging the spring-ai-starter-mcp-client dependency.\nThe client is configured to send requests with a bearer token, which works fine for listing tools:</p>\n<pre class=\"lang-java prettyprint-override\"><code> McpSyncClient client = McpClientFactory.getInstance();\n client.listTools();\n</code></pre>\n<p>However, when invoking a tool with:</p>\n<pre class=\"lang-java prettyprint-override\"><code> client.callTool(new McpSchema.CallToolRequest(toolName, params));\n</code></pre>\n<p>I encounter the error: <strong>Security Context is invalid</strong>.\nThe issue seems to be that the MCP server is delegating tool execution to a boundedElastic thread, which does not propagate the original request's SecurityContext. The security context is required at the tool level to determine parameters like organizationId.</p>\n<p><strong>What I've Tried:</strong></p>\n<ul>\n<li><code>DelegatingSecurityContextAsyncTaskExecutor</code> (didn't propagate)</li>\n<li><code>DelegatingSecurityContextTaskExecutor</code> (didn't propagate)</li>\n<li><code>SecurityContextHolder.MODE_INHERITABLETHREADLOCAL</code> (propagates, but a mess for thread pool)</li>\n<li>Swapping SDK's WebMvcSseServerTransportProvider with a custom provider: so I can manually set the context in the new thread, but just copying the SDK's class still changed the behavior and failed to even get the toolList, let alone modifying it.</li>\n</ul>\n<p>Below is basically how I'd enforce use of my custom provider</p>\n<pre><code> @Bean\n @Primary\n public McpServerTransportProvider customWebMvcSseServerTransportProvider(){\n        return new CustomWebMvcSseServerTransportProvider(objectMapper, &quot;/mcp/message&quot;);\n    }\n</code></pre>\n<p>SDK's provider method that leads to the boundedElastic thread:</p>\n<pre class=\"lang-java prettyprint-override\"><code> public Mono&lt;Void&gt; sendMessage(McpSchema.JSONRPCMessage message) {\n    return Mono.fromRunnable(() -&gt; {\n            try {\n                String jsonText = WebMvcSseServerTransportProvider.this.objectMapper.writeValueAsString(message);\n                this.sseBuilder.id(this.sessionId).event(&quot;message&quot;).data(jsonText);\n                WebMvcSseServerTransportProvider.logger.debug(&quot;Message sent to session {}&quot;, this.sessionId);\n            } catch (Exception var3) {\n                Exception e = var3;\n                WebMvcSseServerTransportProvider.logger.error(&quot;Failed to send message to session {}: {}&quot;, this.sessionId, e.getMessage());\n                this.sseBuilder.error(e);\n            }\n        });\n    }\n</code></pre>\n<p><strong>Question:</strong></p>\n<p>How can I ensure the security context is properly propagated to the boundedElastic thread when calling tools in the Spring AI MCP Server? Is there a recommended configuration or workaround for this issue?</p>\n<p>Dependencies used:</p>\n<p><strong>Server:</strong></p>\n<pre class=\"lang-xml prettyprint-override\"><code>    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-ai-bom&lt;/artifactId&gt;\n                &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-ai-starter-mcp-server-webmvc&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n</code></pre>\n<p><strong>Client:</strong></p>\n<pre class=\"lang-xml prettyprint-override\"><code>  &lt;dependencyManagement&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-ai-bom&lt;/artifactId&gt;\n            &lt;version&gt;1.0.0-SNAPSHOT&lt;/version&gt;\n            &lt;type&gt;pom&lt;/type&gt;\n            &lt;scope&gt;import&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n  &lt;/dependencyManagement&gt;\n\n  &lt;dependency&gt;\n    &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt;\n    &lt;artifactId&gt;spring-ai-starter-mcp-client&lt;/artifactId&gt;\n  &lt;/dependency&gt;\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-boot", "spring-ai", "model-context-protocol" ],
    "owner" : {
      "account_id" : 8852135,
      "reputation" : 31,
      "user_id" : 6610998,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/20e19d46c243042732d5a0c02cee55be?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "padmin",
      "link" : "https://stackoverflow.com/users/6610998/padmin"
    },
    "is_answered" : false,
    "view_count" : 542,
    "answer_count" : 0,
    "score" : 3,
    "last_activity_date" : 1747858907,
    "creation_date" : 1747100224,
    "link" : "https://stackoverflow.com/questions/79618824/security-context-not-propagated-when-calling-tools-in-spring-ai-mcp-server",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140589742,
    "post_id" : 79618824,
    "body" : "same here - does anyone from spring security care to comment on that ?",
    "score" : 0,
    "owner" : {
      "account_id" : 12176666,
      "reputation" : 213,
      "user_id" : 8889552,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bf73b5d19badf0b57259bf8c5bd5ac1d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Shlomi Cohen",
      "link" : "https://stackoverflow.com/users/8889552/shlomi-cohen"
    },
    "creation_date" : 1752552106,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}