{
  "question" : {
    "question_id" : 79804267,
    "title" : "Google Oauth authorization is stuck after accepting consent",
    "body" : "<p>I have an app that is failing to continue processing after I consent to the desired API scopes. My process is as follows:</p>\n<p>The app is a Java web app running on Tomcat 10.1. It is an internal, single user app, where I want to be able to read and write to my calendar, list, read, and write to my Google sheets. Because I'm accessing my personal calendar and sheets, that rules out using a service account. So, I'm using an OAuth 2 client ID.</p>\n<p>My app runs the following code:</p>\n<pre><code>if ( credential == null ) {\n    final NetHttpTransport httpTransport = GoogleNetHttpTransport.newTrustedTransport();\n    final JsonFactory JSON_FACTORY = GsonFactory.getDefaultInstance();\n\n    GoogleClientSecrets clientSecrets = GoogleClientSecrets.load( JSON_FACTORY , new StringReader( credentialsString ) );\n\n    File tokenDirectory = new java.io.File( tokensDirectoryPath );\n    LOGGER.debug( String.format( &quot;Token directory: %s&quot; , tokenDirectory.getAbsolutePath() ) );\n\n\n    // Build flow and trigger user authorization request.\n    GoogleAuthorizationCodeFlow flow = new GoogleAuthorizationCodeFlow.Builder(\n            httpTransport , JSON_FACTORY , clientSecrets , Constants.SCOPES )\n            .setDataStoreFactory( new FileDataStoreFactory( new java.io.File( tokensDirectoryPath ) ) )\n            .setAccessType( &quot;offline&quot; )\n            .setApprovalPrompt( &quot;force&quot; )\n            .build();\n\n    LocalServerReceiver receiver = new LocalServerReceiver.Builder().setPort( 8081 ).build();\n    credential = new AuthorizationCodeInstalledApp( flow , receiver ).authorize( &quot;user&quot; );\n}\n</code></pre>\n<p>This logs a message saying I need to open the following address in my browser:</p>\n<pre><code>https://accounts.google.com/o/oauth2/auth?access_type=offline&amp;approval_prompt=force&amp;client_id=xxxx&amp;redirect_uri=http://localhost:8081/Callback&amp;response_type=code&amp;scope=https://www.googleapis.com/auth/calendar%20https://www.googleapis.com/auth/drive.readonly%20https://www.googleapis.com/auth/spreadsheets\n</code></pre>\n<p>I copy that to my browser and sign in and consent.</p>\n<p>I get back a URI that looks like:</p>\n<pre><code>http://localhost:8081/Callback?code=xxxxxxxxxxxxxxxxxx&amp;scope=https://www.googleapis.com/auth/spreadsheets%20https://www.googleapis.com/auth/drive.readonly%20https://www.googleapis.com/auth/calendar\n</code></pre>\n<p>At this point I'm lost. The web page just sits there spinning, waiting for something to happen that never does. I've disabled the firewall thinking maybe the response was being blocked. That didn't make a difference. A <code>sudo netstat -tulpn</code> shows my Java app is listening on port 8081.</p>\n<p>Does anyone see anything I'm doing wrong?</p>\n<p>UPDATE:  I wrote a batch program using the same code, ran it on my local Windows machine and everything worked fine.  Not sure what is going on with the Linux/Tomcat server (headless) given the firewall was disabled.</p>\n",
    "tags" : [ "java", "google-cloud-platform", "google-oauth" ],
    "owner" : {
      "account_id" : 1361814,
      "reputation" : 3052,
      "user_id" : 1299026,
      "user_type" : "registered",
      "accept_rate" : 77,
      "profile_image" : "https://www.gravatar.com/avatar/49a41139b1c8ca6137b158b1d6de87ab?s=256&d=identicon&r=PG",
      "display_name" : "Todd",
      "link" : "https://stackoverflow.com/users/1299026/todd"
    },
    "is_answered" : true,
    "view_count" : 125,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1761990003,
    "creation_date" : 1761776233,
    "link" : "https://stackoverflow.com/questions/79804267/google-oauth-authorization-is-stuck-after-accepting-consent",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79806443,
    "question_id" : 79804267,
    "body" : "<p>The remainder of the OAuth2/OIDC ceremony, namely the exchange of the code for a token, is missing.</p>\n<p>Your server needs to implement a Servlet with the path /Callback to process the callback provided in the callback_url.</p>\n<p>The internal processing of http://localhost:8081/<strong>Callback</strong>?code=xxxxxxxxxxxxxxxxxx should make a call to <a href=\"https://accounts.google.com/o/oauth2/token\" rel=\"nofollow noreferrer\">https://accounts.google.com/o/oauth2/token</a> with the code as a parameter.</p>\n<p>The call to <a href=\"https://accounts.google.com/o/oauth2/token\" rel=\"nofollow noreferrer\">https://accounts.google.com/o/oauth2/token</a> will return the JWT for later use for authorization by the client.</p>\n<p><a href=\"https://developers.google.com/identity/openid-connect/openid-connect?_gl=1*1qtr4pg*_up*MQ..*_ga*MTY0MTY4MjQxMC4xNzYxOTg5NTgy*_ga_SM8HXJ53K2*czE3NjE5ODk1ODIkbzEkZzAkdDE3NjE5ODk1ODIkajYwJGwwJGgw#exchangecode\" rel=\"nofollow noreferrer\">This</a> is the missing step.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 10941198,
      "reputation" : 5803,
      "user_id" : 8041003,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/cAZ4d.jpg?s=256",
      "display_name" : "John Williams",
      "link" : "https://stackoverflow.com/users/8041003/john-williams"
    },
    "creation_date" : 1761990003,
    "last_activity_date" : 1761990003,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}