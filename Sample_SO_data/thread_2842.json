{
  "question" : {
    "question_id" : 79590762,
    "title" : "How to get access and refresh tokens from the code received by developers.google.com/oauthplayground/",
    "body" : "<p>I am trying to use OAuth2, but this line <code>ResponseEntity&lt;Map&gt; tokenResponse = restTemplate.postForEntity(tokenEndpoint, request, Map.class);</code> takes me to the exception of <code>400 â€” BAD REQUEST</code>.</p>\n<p>I hit this endpoint as per the tutorial I am following:</p>\n<pre class=\"lang-none prettyprint-override\"><code>localhost:8080/auth/google/callback?code=2/0872Qbj4HJQtB5n7EiDEiTFv6InSZFatpnWe6X6114hA_0YPuPZ-w\n</code></pre>\n<p>I have changed the URL hardcoded value for security purpose.\nAdditionally, this code value inside the URL is received from <code>https://developers.google.com/oauthplayground</code> in the first step. Then in second step of this site I pasted the code value, and it gave me access and refresh tokens correctly.\nBut when I hit the URL from Postman, it didn't give me the same. Instead, a <code>400 bad req error</code>. The tutorial I am following has done the same thing.\nCode is given below:</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.secure.notes.OAuth;\nimport com.secure.notes.model.User;\nimport com.secure.notes.model.UserRole;\nimport com.secure.notes.repositories.UserRepository;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.http.*;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\nimport org.springframework.util.LinkedMultiValueMap;\nimport org.springframework.util.MultiValueMap;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.bind.annotation.RestController;\nimport org.springframework.web.client.RestTemplate;\nimport java.util.Arrays;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.UUID;\n@Slf4j\n@RestController\n@RequestMapping(&quot;/auth/google&quot;)\npublic class GoogleAuthController {\n    @Value(&quot;${spring.security.oauth2.client.registration.google.client-id}&quot;)\n    private String clientId;\n    @Value(&quot;${spring.security.oauth2.client.registration.google.client-secret}&quot;)\n    private String clientSecret;\n\n    @Autowired\n    private RestTemplate restTemplate;\n\n    @Autowired\n    private UserDetailsService userDetailsService;\n\n    @Autowired\n    private PasswordEncoder passwordEncoder;\n\n    @Autowired\n    private UserRepository userRepository;\n\n    @GetMapping(&quot;/callback&quot;)\n    public ResponseEntity&lt;?&gt; handleGoogleCallback(@RequestParam String code){\n        try{\n            // 1. Exchange auth code from tokens\n            String tokenEndpoint = &quot;https://oauth2.googleapis.com/token&quot;;\n\n            MultiValueMap&lt;String, String&gt; params = new LinkedMultiValueMap&lt;&gt;();\n            params.add(&quot;code&quot;, code);\n            params.add(&quot;client_id&quot;, clientId);\n            params.add(&quot;client_secret&quot;, clientSecret);\n            params.add(&quot;redirect_uri&quot;, &quot;https://developers.google.com/oauthplayground/&quot;); // should be &quot;redirect_uri&quot;, not &quot;redirect_url&quot;\n            params.add(&quot;grant_type&quot;, &quot;authorization_code&quot;);\n\n\n            //By headers, we are telling google that what type of request we are sending\n            HttpHeaders headers = new HttpHeaders();\n            headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n\n            HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; request = new HttpEntity&lt;&gt;(params, headers);\n\n            ResponseEntity&lt;Map&gt; tokenResponse = restTemplate.postForEntity(tokenEndpoint, request, Map.class);\n            String idToken = (String) tokenResponse.getBody().get(&quot;id_token&quot;);\n            String userInfoUrl = &quot;https://oauth2.googleapis.com/tokeninfo?id_token=&quot; + idToken;\n            ResponseEntity&lt;Map&gt; userInfoResponse = restTemplate.getForEntity(userInfoUrl, Map.class);\n            if(userInfoResponse.getStatusCode() == HttpStatus.OK){\n                Map&lt;String, Object&gt; userInfo = userInfoResponse.getBody();\n                String email = (String) userInfo.get(&quot;email&quot;);\n                UserDetails userDetails = userDetailsService.loadUserByUsername(email);\n                if(userDetails == null){\n                    User user = new User();\n                    user.setEmail(email);\n                    user.setName(email);\n                    user.setPassword(passwordEncoder.encode(UUID.randomUUID().toString()));\n                    user.setRole(UserRole.USER);\n                    userRepository.save(user);\n                    userDetails = userDetailsService.loadUserByUsername(email);\n                }\n                UsernamePasswordAuthenticationToken authentication =\n                        new UsernamePasswordAuthenticationToken(userDetails, null, userDetails.getAuthorities());\n\n                SecurityContextHolder.getContext().setAuthentication(authentication);\n\n                return ResponseEntity.status(HttpStatus.OK).build();\n            }\n            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();\n        }catch (Exception e){\n            log.error(&quot;Exception Occurred while handleGoogleCallback &quot;, e);\n            System.out.println(e.getCause()+&quot; &quot;+e.getMessage()+&quot; &quot;+ e.getStackTrace());\n            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();\n        }\n    }\n}\n</code></pre>\n<p>I have added the client ID and secret in the <code>application.config</code>.</p>\n<p>This below is my <code>securityConfig</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>package com.secure.notes.security;\nimport com.secure.notes.services.impl.AuthFilterService;\nimport lombok.RequiredArgsConstructor;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationProvider;\nimport org.springframework.security.config.annotation.method.configuration.EnableMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.web.SecurityFilterChain;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\n\n@Configuration\n@RequiredArgsConstructor\n@EnableWebSecurity\n@EnableMethodSecurity\npublic class SecurityConfiguration {\n    private final AuthFilterService authFilterService;\n    private final AuthenticationProvider authenticationProvider;\n\n    @Bean\n    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {\n        http\n                .csrf(AbstractHttpConfigurer::disable)\n                .authorizeHttpRequests(auth -&gt; auth\n                        .requestMatchers(&quot;/api/v1/auth/**&quot;, &quot;/auth/google/callback&quot;) // Permit OAuth2 and authentication routes\n                        .permitAll()\n                        .anyRequest()\n                        .permitAll())\n                .sessionManagement(session -&gt; session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))\n                .authenticationProvider(authenticationProvider)\n                .addFilterBefore(authFilterService, UsernamePasswordAuthenticationFilter.class)\n                .oauth2Login(oauth2 -&gt; oauth2\n                        .defaultSuccessUrl(&quot;/hello&quot;, true));\n\n        return http.build();\n    }\n\n}\n</code></pre>\n<p>although, here I have added the <code>/hello</code> as result URL just to test.\nThe error was same when it wasn't there.\nStack trace is:</p>\n<pre class=\"lang-none prettyprint-override\"><code>org.springframework.web.client.HttpClientErrorException$BadRequest: 400 Bad Request on POST request for &quot;https://oauth2.googleapis.com/token&quot;: &quot;{&lt;EOL&gt;  &quot;error&quot;: &quot;invalid_grant&quot;,&lt;EOL&gt;  &quot;error_description&quot;: &quot;Bad Request&quot;&lt;EOL&gt;}&quot;\nat org.springframework.web.client.HttpClientErrorException.create(HttpClientErrorException.java:103) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.DefaultResponseErrorHandler.handleError(DefaultResponseErrorHandler.java:186) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.DefaultResponseErrorHandler.handleError(DefaultResponseErrorHandler.java:147) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.RestTemplate.handleResponse(RestTemplate.java:953) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.RestTemplate.doExecute(RestTemplate.java:902) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.RestTemplate.execute(RestTemplate.java:801) ~[spring-web-6.2.5.jar:6.2.5]\nat org.springframework.web.client.RestTemplate.postForEntity(RestTemplate.java:549) ~[spring-web-6.2.5.jar:6.2.5]\nat com.secure.notes.OAuth.GoogleAuthController.handleGoogleCallback(GoogleAuthController.java:71) ~[classes/:na]\n</code></pre>\n<p>I have tried to change URLs, update the &quot;code&quot; that we paste in the URL when hitting the endpoint.</p>\n",
    "tags" : [ "java", "spring-boot", "oauth-2.0", "google-oauth" ],
    "owner" : {
      "account_id" : 40942301,
      "reputation" : 31,
      "user_id" : 30039244,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b95e813d6c3f3b9b671bf21a305f2e67?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user30039244",
      "link" : "https://stackoverflow.com/users/30039244/user30039244"
    },
    "is_answered" : true,
    "view_count" : 169,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1745571768,
    "creation_date" : 1745502612,
    "link" : "https://stackoverflow.com/questions/79590762/how-to-get-access-and-refresh-tokens-from-the-code-received-by-developers-google",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79592172,
    "question_id" : 79590762,
    "body" : "<p>There were 2 issues.<br />\nFirst is to always renew the code that you get from <a href=\"https://developers.google.com/oauthplayground/\" rel=\"nofollow noreferrer\">https://developers.google.com/oauthplayground/</a> as we can only use that code once and after that it will always give 400 BAD REQUEST</p>\n<p>Second is about RestTemplate. RestTemplate default can not handle gzip which is sent by google. so we need to use Apache HttpClient v4.</p>\n<p>Like this:</p>\n<pre><code>HttpClient httpClient = HttpClients.createDefault();\nClientHttpRequestFactory requestFactory = new HttpComponentsClientHttpRequestFactory(httpClient);\nRestTemplate restTemplate = new RestTemplate(requestFactory);\n</code></pre>\n<p>Import statements should be like :</p>\n<pre><code>import org.springframework.http.client.HttpComponentsClientHttpRequestFactory;\nimport org.springframework.web.client.RestTemplate;\nimport org.apache.hc.client5.http.classic.HttpClient;\nimport org.apache.hc.client5.http.impl.classic.HttpClients;\n</code></pre>\n<p>and dependency should be:</p>\n<pre><code>&lt;dependency&gt;\n    &lt;groupId&gt;org.apache.httpcomponents.client5&lt;/groupId&gt;\n    &lt;artifactId&gt;httpclient5&lt;/artifactId&gt;\n&lt;/dependency&gt;\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 40942301,
      "reputation" : 31,
      "user_id" : 30039244,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b95e813d6c3f3b9b671bf21a305f2e67?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user30039244",
      "link" : "https://stackoverflow.com/users/30039244/user30039244"
    },
    "creation_date" : 1745571768,
    "last_activity_date" : 1745571768,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}