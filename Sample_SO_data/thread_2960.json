{
  "question" : {
    "question_id" : 79582395,
    "title" : "Axon NoHandlerForCommandException when using AxonFramework without Spring Boot",
    "body" : "<p>Building upon my 2 previous questions:</p>\n<ul>\n<li><p><a href=\"https://stackoverflow.com/questions/79524365/using-axonframework-without-spring-and-with-kafka-postgresql\">Using AxonFramework without Spring and with Kafka + PostgreSQL</a></p>\n</li>\n<li><p><a href=\"https://stackoverflow.com/questions/79527572/axon-is-unable-to-resolve-the-event-in-the-eventhandler\">Axon is unable to resolve the Event in the EventHandler</a></p>\n</li>\n</ul>\n<p>I have the following structure:</p>\n<ul>\n<li><p>A Spring Boot Backend that runs Axon without Issues, publishes Events to the Kafka Source, etc</p>\n</li>\n<li><p>A normal application that uses the AxonConnector interface to listen to Events and send Commands to the Backend</p>\n</li>\n</ul>\n<p>This is the implementation of the AxonConnector using Kafka:</p>\n<pre><code>@Log4j2\npublic class KafkaPostgresAxonConnector implements AxonConnector {\n\n  private final String kafkaBootstrapServers;\n  private final String postgresUrl;\n  private final String postgresUser;\n  private final String postgresPassword;\n  private final String componentName;\n  private final String groupId;\n  private final Configurer configurer;\n  private final JacksonSerializer serializer;\n\n  private KafkaProducer&lt;String, String&gt; producer;\n  private Configuration axonConfig;\n\n  public KafkaPostgresAxonConnector(String kafkaBootstrapServers, String postgresUrl,\n      String postgresUser, String postgresPassword, String componentName) {\n    this.kafkaBootstrapServers = kafkaBootstrapServers;\n    this.postgresUrl = postgresUrl;\n    this.postgresUser = postgresUser;\n    this.postgresPassword = postgresPassword;\n    this.componentName = componentName;\n    this.groupId = componentName + UUID.randomUUID();\n\n    serializer = JacksonSerializer.builder()\n        .defaultTyping()\n        .lenientDeserialization()\n        .build();\n\n    configurer = DefaultConfigurer.defaultConfiguration()\n        .configureSerializer(c -&gt; serializer)\n        .configureEventSerializer(c -&gt; serializer)\n        .configureMessageSerializer(c -&gt; serializer);\n  }\n\n  @Override\n  public void start() {\n    DataSource dataSource = dataSource();\n\n    initializePostgres(dataSource);\n    initializeKafkaConsumer();\n    initializeKafkaProducer();\n\n    log.info(&quot;Starting AxonFramework with component: {}&quot;, componentName);\n\n    axonConfig = configurer.buildConfiguration();\n    axonConfig.start();\n  }\n\n  @Override\n  public void registerEventHandler(Object eventHandler) {\n    configurer.registerEventHandler(conf -&gt; eventHandler);\n  }\n\n  @Override\n  public &lt;T&gt; void registerAggregate(Class&lt;T&gt; aggregateType) {\n    configurer.configureAggregate(aggregateType);\n  }\n\n  @Override\n  public UUID sendCommand(Object command) {\n    if (axonConfig == null) {\n      throw new IllegalStateException(&quot;Axon Framework not initialized&quot;);\n    }\n\n    CommandGateway commandGateway = axonConfig.commandGateway();\n    return commandGateway.sendAndWait(command);\n  }\n\n  @Override\n  public &lt;R&gt; R sendQuery(Object query, ResponseType&lt;R&gt; responseType) {\n    if (axonConfig == null) {\n      log.warn(&quot;Cannot send query - Axon Framework not initialized&quot;);\n      return null;\n    }\n\n    QueryGateway queryGateway = axonConfig.queryGateway();\n    return queryGateway.query(query, responseType).join();\n  }\n\n  @Override\n  public void close() {\n    if (producer != null) {\n      producer.close();\n    }\n    if (axonConfig != null) {\n      axonConfig.shutdown();\n    }\n  }\n\n  /**\n   * KAFKA\n   * */\n\n  private KafkaMessageConverter&lt;String, byte[]&gt; messageConverter() {\n    return DefaultKafkaMessageConverter.builder()\n        .serializer(serializer)\n        .build();\n  }\n\n  /**\n   * KAFKA PRODUCER\n   * */\n\n  private void initializeKafkaProducer() {\n    ProducerFactory&lt;String, byte[]&gt; producerFactory = producerFactory();\n    KafkaMessageConverter&lt;String, byte[]&gt; messageConverter = messageConverter();\n    KafkaPublisher&lt;String, byte[]&gt; kafkaPublisher = kafkaPublisher(\n        producerFactory,\n        messageConverter\n    );\n    KafkaEventPublisher&lt;String, byte[]&gt; kafkaEventPublisher = kafkaEventPublisher(kafkaPublisher);\n    registerPublisherToEventProcessor(configurer.eventProcessing(), kafkaEventPublisher);\n  }\n\n  public void registerPublisherToEventProcessor(\n      EventProcessingConfigurer eventProcessingConfigurer,\n      KafkaEventPublisher&lt;String, byte[]&gt; kafkaEventPublisher\n  ) {\n    String processingGroup = KafkaEventPublisher.DEFAULT_PROCESSING_GROUP;\n\n    eventProcessingConfigurer\n        .registerEventHandler(configuration -&gt; kafkaEventPublisher)\n        .registerSubscribingEventProcessor(processingGroup)\n        .usingSubscribingEventProcessors();\n  }\n\n  private KafkaPublisher&lt;String, byte[]&gt; kafkaPublisher(\n      ProducerFactory&lt;String, byte[]&gt; producerFactory,\n      KafkaMessageConverter&lt;String, byte[]&gt; kafkaMessageConverter\n  ) {\n    return KafkaPublisher.&lt;String, byte[]&gt;builder()\n        .producerFactory(producerFactory)\n        .messageConverter(kafkaMessageConverter)\n        .serializer(serializer)\n        .build();\n  }\n\n  public KafkaEventPublisher&lt;String, byte[]&gt; kafkaEventPublisher(\n      KafkaPublisher&lt;String, byte[]&gt; kafkaPublisher\n  ) {\n    return KafkaEventPublisher.&lt;String, byte[]&gt;builder()\n        .kafkaPublisher(kafkaPublisher)\n        .build();\n  }\n\n  public ProducerFactory&lt;String, byte[]&gt; producerFactory() {\n    Map&lt;String, Object&gt; producerProps = new HashMap&lt;&gt;();\n    producerProps.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBootstrapServers);\n    producerProps.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);\n    producerProps.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG,\n        StringSerializer.class);\n    producerProps.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG,\n        ByteArraySerializer.class);\n\n    return DefaultProducerFactory.&lt;String, byte[]&gt;builder()\n        .configuration(producerProps)\n        .confirmationMode(ConfirmationMode.NONE)\n        .build();\n  }\n\n  /**\n   * KAFKA CONSUMER\n   * */\n\n  private void initializeKafkaConsumer() {\n    ConsumerFactory&lt;String, byte[]&gt; consumerFactory = consumerFactory();\n    Fetcher&lt;String, byte[], EventMessage&lt;?&gt;&gt; fetcher = fetcher();\n    KafkaMessageConverter&lt;String, byte[]&gt; messageConverter = messageConverter();\n    KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer = kafkaMessageSourceConfigurer(\n        configurer);\n    SubscribableKafkaMessageSource&lt;String, byte[]&gt; messageSource = subscribableKafkaMessageSource(\n        consumerFactory,\n        fetcher,\n        messageConverter,\n        kafkaMessageSourceConfigurer\n    );\n\n    configureSubscribableKafkaSource(configurer.eventProcessing(), messageSource);\n  }\n\n  private Fetcher&lt;String, byte[], EventMessage&lt;?&gt;&gt; fetcher() {\n    return AsyncFetcher.&lt;String, byte[], EventMessage&lt;?&gt;&gt;builder()\n        .pollTimeout(1000)\n        .executorService(Executors.newSingleThreadExecutor())\n        .build();\n  }\n\n  private ConsumerFactory&lt;String, byte[]&gt; consumerFactory() {\n    Map&lt;String, Object&gt; consumerProps = new HashMap&lt;&gt;();\n    consumerProps.put(ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG, kafkaBootstrapServers);\n    consumerProps.put(ConsumerConfig.GROUP_ID_CONFIG, groupId);\n    consumerProps.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG,\n        StringDeserializer.class);\n    consumerProps.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG,\n        ByteArrayDeserializer.class);\n    consumerProps.put(ConsumerConfig.AUTO_OFFSET_RESET_CONFIG, &quot;earliest&quot;);\n\n    return new DefaultConsumerFactory&lt;&gt;(consumerProps);\n  }\n\n  private KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer(Configurer configurer) {\n    KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer = new KafkaMessageSourceConfigurer();\n    configurer.registerModule(kafkaMessageSourceConfigurer);\n    return kafkaMessageSourceConfigurer;\n  }\n\n  private SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource(\n      ConsumerFactory&lt;String, byte[]&gt; consumerFactory,\n      Fetcher&lt;String, byte[], EventMessage&lt;?&gt;&gt; fetcher,\n      KafkaMessageConverter&lt;String, byte[]&gt; messageConverter,\n      KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer\n  ) {\n    SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource = SubscribableKafkaMessageSource.&lt;String, byte[]&gt;builder()\n        .autoStart()\n        .groupId(groupId)\n        .consumerFactory(consumerFactory)\n        .fetcher(fetcher)\n        .messageConverter(messageConverter)\n        .consumerCount(1)\n        .serializer(serializer)\n        .build();\n\n    kafkaMessageSourceConfigurer.configureSubscribableSource(\n        configuration -&gt; subscribableKafkaMessageSource\n    );\n    return subscribableKafkaMessageSource;\n  }\n\n  private void configureSubscribableKafkaSource(EventProcessingConfigurer eventProcessingConfigurer,\n      SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource) {\n    eventProcessingConfigurer.configureDefaultSubscribableMessageSource(\n        configuration -&gt; subscribableKafkaMessageSource\n    );\n    eventProcessingConfigurer.usingSubscribingEventProcessors();\n  }\n\n  /**\n   * POSTGRES\n   */\n\n  private void initializePostgres(DataSource dataSource) {\n    ConnectionProvider connectionProvider = new DataSourceConnectionProvider(dataSource);\n\n    EventSchema schema = EventSchema.builder()\n        .eventTable(&quot;domain_event_entry&quot;)\n        .snapshotTable(&quot;snapshot_event_entry&quot;)\n        .build();\n    // Initialize Postgres connection\n    EventStorageEngine eventStorageEngine = JdbcEventStorageEngine.builder()\n        .transactionManager(transactionManager())\n        .connectionProvider(connectionProvider)\n        .snapshotFilter(SnapshotFilter.allowAll())\n        .eventSerializer(serializer)\n        .snapshotSerializer(serializer)\n        .schema(schema)\n        .build();\n\n    configurer.configureEmbeddedEventStore(c -&gt; eventStorageEngine);\n  }\n\n  private DataSource dataSource() {\n    HikariConfig config = new HikariConfig();\n    config.setJdbcUrl(postgresUrl);\n    config.setUsername(postgresUser);\n    config.setPassword(postgresPassword);\n    config.setDriverClassName(&quot;org.postgresql.Driver&quot;);\n    config.addDataSourceProperty(&quot;cachePrepStmts&quot;, &quot;true&quot;);\n    config.addDataSourceProperty(&quot;prepStmtCacheSize&quot;, &quot;250&quot;);\n    config.addDataSourceProperty(&quot;prepStmtCacheSqlLimit&quot;, &quot;2048&quot;);\n\n    return new HikariDataSource(config);\n  }\n\n  private TransactionManager transactionManager() {\n    return NoTransactionManager.INSTANCE;\n  }\n}\n</code></pre>\n<p>To manually test the AxonConnector, I created this app:</p>\n<pre><code>@Log4j2\npublic class ConnectorTest {\n\n  public static void main(String[] args) {\n    AxonConnector connector = AxonConnector.kafka(\n        &quot;localhost:29092,localhost:39092,localhost:49092&quot;,\n        &quot;jdbc:postgresql://localhost:5432/database&quot;,\n        &quot;postgres-user&quot;,\n        &quot;postgres-password&quot;,\n        &quot;Tester-1&quot;\n    );\n\n    connector.start();\n\n    connector.registerEventHandler(new Handler());\n\n    UUID id =\n        connector.sendCommand(new CreateModuleCommand(&quot;TestModule&quot;, 10, 1, 5, true, true));\n\n    log.info(connector.sendQuery(new FindModuleByIdQuery(id), ResponseTypes.optionalInstanceOf(ModuleDto.class)));\n\n    // Add Shutdown Hook\n    Runtime.getRuntime().addShutdownHook(new Thread(() -&gt; {\n      log.info(&quot;Shutting down Axon Connector...&quot;);\n      try {\n        connector.close();\n      } catch (Exception e) {\n        log.error(&quot;Error while shutting down Axon Connector&quot;, e);\n      }\n    }));\n  }\n\n  @Log4j2\n  public static class Handler {\n\n    @EventHandler\n    public void on(ModuleCreatedEvent event) {\n      System.out.println(&quot;Module Created: &quot; + event.getModule().getId());\n    }\n\n  }\n\n}\n</code></pre>\n<p>The Containers are running like follows:<br />\n<a href=\"https://i.sstatic.net/2fycBmZM.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/2fycBmZM.png\" alt=\"Docker Containers db-1, controller 1 to 3, broker 1 to 3, kafka-ui running with open ports on db-1: 5432, broker2: 39092, broker3: 49092, broker1: 29092, kafka-ui: 8088\" /></a></p>\n<h2>Issue 1</h2>\n<p>But running the main function throws the following exception:</p>\n<pre><code>Exception in thread &quot;main&quot; org.axonframework.commandhandling.NoHandlerForCommandException: No handler was subscribed for command [de.cronixzero.test.messages.commands.modules.CreateModuleCommand].\n    at org.axonframework.commandhandling.SimpleCommandBus.doDispatch(SimpleCommandBus.java:167)\n    at org.axonframework.commandhandling.SimpleCommandBus.lambda$dispatch$1(SimpleCommandBus.java:131)\n    at org.axonframework.tracing.Span.run(Span.java:101)\n    at org.axonframework.commandhandling.SimpleCommandBus.dispatch(SimpleCommandBus.java:125)\n    at org.axonframework.commandhandling.gateway.AbstractCommandGateway.send(AbstractCommandGateway.java:76)\n    at org.axonframework.commandhandling.gateway.DefaultCommandGateway.send(DefaultCommandGateway.java:83)\n    at org.axonframework.commandhandling.gateway.DefaultCommandGateway.sendAndWait(DefaultCommandGateway.java:100)\n    at de.cronixzero.test.messages.connector.kafka.KafkaPostgresAxonConnector.sendCommand(KafkaPostgresAxonConnector.java:136)\n    at de.cronixzero.test.messages.testing.ConnectorTest.main(ConnectorTest.java:30)\n</code></pre>\n<p>ConnectorTest.java:30</p>\n<pre><code>UUID id = connector.sendCommand(new CreateModuleCommand(&quot;TestModule&quot;, 10, 1, 5, true, true));\n</code></pre>\n<p>KafkaPostgresAxonConnector.java:136:</p>\n<pre><code>CommandGateway commandGateway = axonConfig.commandGateway();\nreturn commandGateway.sendAndWait(command);\n</code></pre>\n<p>What is it, that I'm doing wrong here?</p>\n<h2>Issue 2</h2>\n<p>Running the Java Debugger shows that the @EventHandler annotated method never gets reached, even though the application seems to be connected to the kafka source and is even registered as a Consumer.</p>\n<p>Why is this?</p>\n<h2>Issue 3</h2>\n<p>Just now, I noticed that once I start the TestApplication, the messageCount in the Kafka Topic ramps up astronomically (The same messages seem to be resent constantly)</p>\n<p><a href=\"https://i.sstatic.net/AJqYbXE8.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/AJqYbXE8.png\" alt=\"Table showing multiple repeating kafka messages, always with the same id and body while the offset keeps ramping up to 200.000 messages in short succession\" /></a></p>\n<p>They are absolutely identical in their content and easily ramp up to 200.000 repititions in just a couple of minutes</p>\n",
    "tags" : [ "java", "apache-kafka", "axon", "axon-framework" ],
    "owner" : {
      "account_id" : 19115546,
      "reputation" : 37,
      "user_id" : 13960581,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/s9cy5.gif?s=256",
      "display_name" : "CronixZero",
      "link" : "https://stackoverflow.com/users/13960581/cronixzero"
    },
    "is_answered" : true,
    "view_count" : 100,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1747300150,
    "creation_date" : 1745066225,
    "link" : "https://stackoverflow.com/questions/79582395/axon-nohandlerforcommandexception-when-using-axonframework-without-spring-boot",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79622969,
    "question_id" : 79582395,
    "body" : "<p>For the distribution of command messages in Axon Framework, you would need to us a distributed version of the <code>CommandBus</code>. There are roughly two options you have for this:</p>\n<p>1. Axon Server<br />\n2. The <code>DistributedCommandBus</code> with Spring Cloud Service Discovery<br />\n3. The <code>DistributedCommandBus</code> with JGroups</p>\n<p>Using Axon Server is arguably the easiest way to set it up seamlessly. Furthermore, it would mean you also have a dedicated Event Store solution, distributed event messaging, and distributed query messaging. Alongside all other features given by Axon Server to simplify things. Running a single Axon Server instance is very straightforward. You could also follow the setup process on <a href=\"https://console.axoniq.io/\" rel=\"nofollow noreferrer\">AxonIQ Console</a> to simplify it further. Note that Axon Server is <strong>not</strong> necessarily a paid tool.</p>\n<p>If you feel like doing more work, you can try out the <a href=\"https://github.com/AxonFramework/extension-springcloud\" rel=\"nofollow noreferrer\">Spring Cloud</a> or <a href=\"https://github.com/AxonFramework/extension-jgroups\" rel=\"nofollow noreferrer\">JGroups</a> extensions from Axon Framework, in combination with a <code>DistributedCommandBus</code>. For the former, you will need to select a preferred Spring Cloud Service Discovery solution, like Eureka, Consul, Kubernetes, or ZooKeeper. For JGroups you would, well, setup JGroups as the service discovery.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2552081,
      "reputation" : 7445,
      "user_id" : 2215649,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/035084fa9055770efead47147882054c?s=256&d=identicon&r=PG",
      "display_name" : "Steven",
      "link" : "https://stackoverflow.com/users/2215649/steven"
    },
    "creation_date" : 1747300150,
    "last_activity_date" : 1747300150,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140386420,
    "post_id" : 79582395,
    "body" : "@Steven Just a simple interface: <a href=\"https://www.toptal.com/developers/hastebin\" rel=\"nofollow noreferrer\">toptal.com/developers/hastebin</a>  I did find out, though, that I wasn&#39;t using the DistributedCommandBus which caused Axon not to find the CommandHandlers. That&#39;d explain issue 1.",
    "score" : 0,
    "owner" : {
      "account_id" : 19115546,
      "reputation" : 37,
      "user_id" : 13960581,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/s9cy5.gif?s=256",
      "display_name" : "CronixZero",
      "link" : "https://stackoverflow.com/users/13960581/cronixzero"
    },
    "creation_date" : 1746085999,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140375930,
    "post_id" : 79582395,
    "body" : "Could you share where you got this <code>AxonConnector</code> from? As a maintainer of the Axon Framework, I know for a fact that that isn&#39;t a class that exists. Without knowing the origin of the class you&#39;re using, it is hard to give any suggestion on the way forward.",
    "score" : 0,
    "owner" : {
      "account_id" : 2552081,
      "reputation" : 7445,
      "user_id" : 2215649,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/035084fa9055770efead47147882054c?s=256&d=identicon&r=PG",
      "display_name" : "Steven",
      "link" : "https://stackoverflow.com/users/2215649/steven"
    },
    "creation_date" : 1745833597,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}