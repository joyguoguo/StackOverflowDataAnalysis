{
  "question" : {
    "question_id" : 79538186,
    "title" : "UCP pool does not borrow all the active connections",
    "body" : "<p>I am using oracle ons.jar ojdbc8.jar and ucp.jar version 19.24\nUsing <code>poolDataSource.getConnection();</code> to get the connection. Then I log the statistics returned from <code>poolDataSource.getStatistics()</code></p>\n<p>Pool size max is 500\nI have <code>MyCustomPoolDataSource</code> class which takes <code>PoolDataSource</code> instance.  <code>MyCustomPoolDataSource</code> acts as a wrapper around the <code>PoolDataSource</code> instance.</p>\n<pre><code>@Override\npublic Connection getConnection() throws SQLException {\n    //Log all poolDataSource.getStatistics()\n    Connection connection = poolDataSource.getConnection();\n    connection.setAutoCommit(true);\n    //Log all poolDataSource.getStatistics()\n    return connection;\n}\n</code></pre>\n<p>Then <code>MyCustomPoolDataSource</code> is injected to DAOs. That instance is used to create jdbcTemplate.</p>\n<pre><code>@Autowired\npublic RestAct(DataSource myCustomPoolDataSource) {\n    this.jdbcTemplate = new JdbcTemplate(myCustomPoolDataSource);\n}\n</code></pre>\n<p>While I am sending a load, I can see the <code>poolDataSource.getStatistics().getTotalConnectionsCount()</code> value increases gradually untill 500.\nBut the <code>getBorrowedConnectionsCount</code> value barely exceeds 3. Once <code>TotalConnectionsCount</code> reached 500 ucp starts to throw <code>UniversalConnectionPoolException : All connectoins in the Universal Connection Pool are in use</code>\nBut the borrowed count is only 3(or 1 or 2)</p>\n<p>Why it is not borrowing/utilizing all the active connections?</p>\n",
    "tags" : [ "java", "spring", "oracle-database", "ojdbc", "ucp" ],
    "owner" : {
      "account_id" : 3702400,
      "reputation" : 9549,
      "user_id" : 3081714,
      "user_type" : "registered",
      "accept_rate" : 39,
      "profile_image" : "https://i.sstatic.net/UhTiJ.jpg?s=256",
      "display_name" : "bula",
      "link" : "https://stackoverflow.com/users/3081714/bula"
    },
    "is_answered" : false,
    "view_count" : 85,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743488796,
    "creation_date" : 1743062441,
    "link" : "https://stackoverflow.com/questions/79538186/ucp-pool-does-not-borrow-all-the-active-connections",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140285478,
    "post_id" : 79538186,
    "body" : "I am using JdbcTemplate everywhere.  Updated the code",
    "score" : 0,
    "owner" : {
      "account_id" : 3702400,
      "reputation" : 9549,
      "user_id" : 3081714,
      "user_type" : "registered",
      "accept_rate" : 39,
      "profile_image" : "https://i.sstatic.net/UhTiJ.jpg?s=256",
      "display_name" : "bula",
      "link" : "https://stackoverflow.com/users/3081714/bula"
    },
    "creation_date" : 1743488817,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281018,
    "post_id" : 79538186,
    "body" : "That is not what you are stating in your question. You are using <code>poolDataSource.getConnection();</code> so you aren&#39;t using <code>JdbcTemplate</code> everywhere. In the places you aren&#39;t you should take care of closing them.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743399629,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140279947,
    "post_id" : 79538186,
    "body" : "Application  has a wrapper around PoolDataSource. It&#39;s getConnection calls pds.gegetConnection. poolDataSource instance is passed to jdbcTemplate&#39;s constructor",
    "score" : 0,
    "owner" : {
      "account_id" : 3702400,
      "reputation" : 9549,
      "user_id" : 3081714,
      "user_type" : "registered",
      "accept_rate" : 39,
      "profile_image" : "https://i.sstatic.net/UhTiJ.jpg?s=256",
      "display_name" : "bula",
      "link" : "https://stackoverflow.com/users/3081714/bula"
    },
    "creation_date" : 1743357918,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140277294,
    "post_id" : 79538186,
    "body" : "Do you have a stand alone test to reproduce the issue? Is your application directly calling PoolDataSource.getConnection() API or is it JDBC template which internally calls getConnection()?",
    "score" : 0,
    "owner" : {
      "account_id" : 17598499,
      "reputation" : 335,
      "user_id" : 12768970,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0c4303c1f3714a3a91f7e640569795c9?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Saurabh Verma",
      "link" : "https://stackoverflow.com/users/12768970/saurabh-verma"
    },
    "creation_date" : 1743264818,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140272256,
    "post_id" : 79538186,
    "body" : "@Deinum I am using JdbcTemplate. It handles the closing.",
    "score" : 0,
    "owner" : {
      "account_id" : 3702400,
      "reputation" : 9549,
      "user_id" : 3081714,
      "user_type" : "registered",
      "accept_rate" : 39,
      "profile_image" : "https://i.sstatic.net/UhTiJ.jpg?s=256",
      "display_name" : "bula",
      "link" : "https://stackoverflow.com/users/3081714/bula"
    },
    "creation_date" : 1743134499,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268499,
    "post_id" : 79538186,
    "body" : "If you do <code>getConnection</code> make sure you are calling <code>close</code> on the retrieved connection else it won&#39;t be returned.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1743065363,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}