{
  "question" : {
    "question_id" : 79776247,
    "title" : "Authenticated Socks5 With OkHttpClient",
    "body" : "<p>Been spending hours trying to get OkHttpClient to work with a proxy. My proxy supports socks5, https. I cannot get it to work on either. I've now spent hours trying different work arounds from years ago on github and its driving me nuts.</p>\n<blockquote>\n<p>Error: SOCKS server general failure</p>\n</blockquote>\n<pre><code>import okhttp3.*;\nimport java.net.InetSocketAddress;\nimport java.net.Proxy;\n\npublic class MinimalErrorReproduction {\n    \n    public static void main(String[] args) {\n        try {\n            // This reproduces your exact error\n            Proxy sockProxy = new Proxy(Proxy.Type.SOCKS, \n                new InetSocketAddress(&quot;proxy.soax.com&quot;, 5000));\n            \n            Authenticator proxyAuth = new Authenticator() {\n                @Override \n                public Request authenticate(Route route, Response response) {\n                    String credential = Credentials.basic(Settings.PROXY_USERNAME, Settings.PROXY_PASSWORD);\n                    return response.request().newBuilder()\n                        .header(&quot;Proxy-Authorization&quot;, credential)\n                        .build();\n                }\n            };\n            \n            OkHttpClient client = new OkHttpClient.Builder()\n                .proxy(sockProxy)\n                .proxyAuthenticator(proxyAuth)\n                .build();\n            \n            Request request = new Request.Builder()\n                .url(&quot;https://www.reddit.com/api/v1/access_token&quot;)\n                .build();\n            \n            // This will throw: SOCKS server general failure\n            Response response = client.newCall(request).execute();\n            \n        } catch (Exception e) {\n            System.err.println(&quot;ERROR: &quot; + e.getMessage());\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "okhttp", "socks5" ],
    "owner" : {
      "account_id" : 17766668,
      "reputation" : 53,
      "user_id" : 12901395,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/--izSKNoVZyI/AAAAAAAAAAI/AAAAAAAAAAA/ACHi3rfypmy3O_Tu1MZixR-dDMjR59qLSw/s256-rj/photo.jpg",
      "display_name" : "Jacob Krumholz",
      "link" : "https://stackoverflow.com/users/12901395/jacob-krumholz"
    },
    "is_answered" : true,
    "view_count" : 64,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1758954614,
    "creation_date" : 1758909514,
    "link" : "https://stackoverflow.com/questions/79776247/authenticated-socks5-with-okhttpclient",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79776450,
    "question_id" : 79776247,
    "body" : "<pre><code>import okhttp3.*;\nimport javax.net.SocketFactory;\n\nimport fucksocks.client.Socks5;\nimport fucksocks.client.SocksProxy;\nimport fucksocks.client.SocksSocket;\n\nimport java.net.*;\nimport java.io.IOException;\n\npublic class MinimalErrorReproduction {\n    \n    static class SocksLibSocketFactory extends SocketFactory {\n        private final SocksProxy socksProxy;\n        \n        public SocksLibSocketFactory(String proxyHost, int proxyPort, String username, String password) {\n            // Use the constructor that accepts username/password directly\n            this.socksProxy = new Socks5(new InetSocketAddress(proxyHost, proxyPort), username, password);\n        }\n        \n        @Override\n        public Socket createSocket() throws IOException {\n            return new Socket();\n        }\n        \n        @Override\n        public Socket createSocket(String host, int port) throws IOException {\n            return new SocksSocket(socksProxy, new InetSocketAddress(host, port));\n        }\n        \n        @Override\n        public Socket createSocket(InetAddress host, int port) throws IOException {\n            return new SocksSocket(socksProxy, new InetSocketAddress(host, port));\n        }\n        \n        @Override\n        public Socket createSocket(String host, int port, InetAddress localHost, int localPort) throws IOException {\n            Socket socket = createSocket(host, port);\n            socket.bind(new InetSocketAddress(localHost, localPort));\n            return socket;\n        }\n        \n        @Override\n        public Socket createSocket(InetAddress address, int port, InetAddress localAddress, int localPort) throws IOException {\n            return createSocket(address.getHostAddress(), port, localAddress, localPort);\n        }\n    }\n    \n    public static void main(String[] args) {\n        try {\n            String proxyHost = &quot;proxy.soax.com&quot;;\n            int proxyPort = 5000;\n            String proxyUsername = Settings.PROXY_USERNAME;\n            String proxyPassword = Settings.PROXY_PASSWORD;\n\n            OkHttpClient client = new OkHttpClient.Builder()\n                .socketFactory(new SocksLibSocketFactory(proxyHost, proxyPort, proxyUsername, proxyPassword))\n                .build();\n\n            Request request = new Request.Builder()\n                .url(&quot;https://httpbin.org/ip&quot;)\n                .build();\n\n            Response response = client.newCall(request).execute();\n            System.out.println(&quot;Response code: &quot; + response.code());\n            System.out.println(&quot;Response body: &quot; + response.body().string());\n            response.close();\n\n        } catch (IOException e) {\n            System.err.println(&quot;ERROR: &quot; + e.getMessage());\n            e.printStackTrace();\n        }\n    }\n}\n</code></pre>\n<p>Figured it out!</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 18026141,
      "reputation" : 233,
      "user_id" : 13102033,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/29f052cfbce9418ac9a116437a01346d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Jacob",
      "link" : "https://stackoverflow.com/users/13102033/jacob"
    },
    "creation_date" : 1758929007,
    "last_activity_date" : 1758929007,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}