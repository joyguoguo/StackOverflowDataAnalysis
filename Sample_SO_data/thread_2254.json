{
  "question" : {
    "question_id" : 79635136,
    "title" : "Java24 crashes when VirtualThread-u invokes oom-killer",
    "body" : "<p>We have installed java24 with our app on a Linux EL9 server. It's a 64GB server and the heap is 48GB. There is no traffic passing through the app, it's idle at the moment, and after several hours (still idle) crashes with an OOM. The only trace we have found appears on the messages log system.</p>\n<p>We are analysing it, and our question is about what &quot;VirtulThread-u&quot; is, which is the one that seems to be invoking the oom-killer. Trace below:</p>\n<pre class=\"lang-none prettyprint-override\"><code>May 20 19:12:47 ventus kernel: VirtualThread-u invoked oom-killer: gfp_mask=0x140cca(GFP_HIGHUSER_MOVABLE|__GFP_COMP), order=0, oom_score_adj=0\nMay 20 19:12:47 ventus kernel: CPU: 0 PID: 123617 Comm: VirtualThread-u Kdump: loaded Not tainted 5.14.0-583.el9.x86_64 #1\nMay 20 19:12:47 ventus kernel: Hardware name: VMware, Inc. VMware7,1/440BX Desktop Reference Platform, BIOS VMW71.00V.18227214.B64.2106252220 06/25/2021\nMay 20 19:12:47 ventus kernel: Call Trace:\nMay 20 19:12:47 ventus kernel: &lt;TASK&gt;\nMay 20 19:12:47 ventus kernel: dump_stack_lvl+0x34/0x48\nMay 20 19:12:47 ventus kernel: dump_header+0x49/0x212\nMay 20 19:12:47 ventus kernel: oom_kill_process.cold+0xb/0x10\nMay 20 19:12:47 ventus kernel: out_of_memory+0xee/0x2b0\nMay 20 19:12:47 ventus kernel: __alloc_pages_slowpath.constprop.0+0x78f/0xb10\nMay 20 19:12:47 ventus kernel: __alloc_pages+0x21c/0x250\nMay 20 19:12:47 ventus kernel: alloc_pages_mpol+0x93/0x1e0\nMay 20 19:12:47 ventus kernel: ? filemap_get_entry+0xe3/0x140\nMay 20 19:12:47 ventus kernel: folio_alloc+0x12/0x30\nMay 20 19:12:47 ventus kernel: __filemap_get_folio+0x189/0x2e0\nMay 20 19:12:47 ventus kernel: filemap_fault+0x4d5/0x8b0\nMay 20 19:12:47 ventus kernel: __do_fault+0x34/0x150\nMay 20 19:12:47 ventus kernel: do_read_fault+0x11e/0x1d0\nMay 20 19:12:47 ventus kernel: do_pte_missing+0x157/0x200\nMay 20 19:12:47 ventus kernel: __handle_mm_fault+0x2fe/0x650\nMay 20 19:12:47 ventus kernel: handle_mm_fault+0xe7/0x250\nMay 20 19:12:47 ventus kernel: do_user_addr_fault+0x215/0x620\nMay 20 19:12:47 ventus kernel: exc_page_fault+0x61/0x150\nMay 20 19:12:47 ventus kernel: asm_exc_page_fault+0x22/0x30\nMay 20 19:12:47 ventus kernel: RIP: 0033:0x7f94b60872aa\nMay 20 19:12:47 ventus kernel: Code: 24 08 e8 c9 f8 ff ff 4c 8b 54 24 18 45 31 c0 44 89 e2 89 c5 8b 74 24 08 48 8b 7c 24 10 41 b9 ff ff ff ff b8 ca 00 00 00 0f 05 &lt;89&gt; ef 48 89 44 24 08 e8 1a f9 ff ff 48 8b 44 24 08 e9 69 ff ff ff\nMay 20 19:12:47 ventus kernel: RSP: 002b:00007f9484efe450 EFLAGS: 00010246\nMay 20 19:12:47 ventus kernel: RAX: ffffffffffffff92 RBX: 0000000000000000 RCX: 00007f94b60872aa\nMay 20 19:12:47 ventus kernel: RDX: 0000000000188281 RSI: 0000000000000089 RDI: 00007f8f2c07931c\nMay 20 19:12:47 ventus kernel: RBP: 0000000000000000 R08: 0000000000000000 R09: 00000000ffffffff\nMay 20 19:12:47 ventus kernel: R10: 00007f9484efe560 R11: 0000000000000246 R12: 0000000000188281\nMay 20 19:12:47 ventus kernel: R13: 00007f9484efe4c0 R14: 00007f8f2c07931c R15: 0000000000000000\nMay 20 19:12:47 ventus kernel: &lt;/TASK&gt;\nMay 20 19:12:47 ventus kernel: Mem-Info:\nMay 20 19:12:47 ventus kernel: active_anon:12769877 inactive_anon:63866 isolated_anon:0#012 active_file:0 inactive_file:201 isolated_file:0#012 unevictable:0 dirty:12 writeback:0#012 slab_reclaimable:36397 slab_unreclaimable:17034#012 mapped:1229085 shmem:12618959 pagetables:3733#012 sec_pagetables:0 bounce:0#012 kernel_misc_reclaimable:0#012 free:326200 free_pcp:43 free_cma:0\nMay 20 19:12:47 ventus kernel: Node 0 active_anon:51079508kB inactive_anon:255464kB active_file:0kB inactive_file:1228kB unevictable:0kB isolated(anon):0kB isolated(file):0kB mapped:4916340kB dirty:48kB writeback:0kB shmem:50475836kB shmem_thp:0kB shmem_pmdmapped:0kB anon_thp:0kB writeback_tmp:0kB kernel_stack:7296kB pagetables:14932kB sec_pagetables:0kB all_unreclaimable? no\nMay 20 19:12:47 ventus kernel: Node 0 DMA free:11264kB boost:0kB min:244kB low:304kB high:364kB reserved_highatomic:0KB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB writepending:0kB present:15996kB managed:15360kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB\nMay 20 19:12:47 ventus kernel: lowmem_reserve[]: 0 2442 63729 63729 63729\nMay 20 19:12:47 ventus kernel: Node 0 DMA32 free:285892kB boost:0kB min:40756kB low:50944kB high:61132kB reserved_highatomic:0KB active_anon:8kB inactive_anon:0kB active_file:116kB inactive_file:356kB unevictable:0kB writepending:0kB present:3128732kB managed:2538836kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB\nMay 20 19:12:47 ventus kernel: lowmem_reserve[]: 0 0 61286 61286 61286\nMay 20 19:12:47 ventus kernel: Node 0 Normal free:1007540kB boost:0kB min:1007572kB low:1259464kB high:1511356kB reserved_highatomic:0KB active_anon:51129440kB inactive_anon:205528kB active_file:0kB inactive_file:968kB unevictable:0kB writepending:48kB present:63963136kB managed:62764236kB mlocked:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB\nMay 20 19:12:47 ventus kernel: lowmem_reserve[]: 0 0 0 0 0\nMay 20 19:12:47 ventus kernel: Node 0 DMA: 0*4kB 0*8kB 0*16kB 0*32kB 0*64kB 0*128kB 0*256kB 0*512kB 1*1024kB (U) 1*2048kB (M) 2*4096kB (M) = 11264kB\nMay 20 19:12:47 ventus kernel: Node 0 DMA32: 3*4kB (UM) 3*8kB (UM) 4*16kB (UM) 4*32kB (UM) 4*64kB (UM) 2*128kB (M) 1*256kB (U) 1*512kB (U) 1*1024kB (U) 0*2048kB 69*4096kB (UM) = 285156kB\nMay 20 19:12:47 ventus kernel: Node 0 Normal: 29247*4kB (UME) 29462*8kB (UME) 11423*16kB (UME) 3867*32kB (UME) 1522*64kB (UME) 444*128kB (UME) 166*256kB (UM) 88*512kB (UME) 50*1024kB (M) 13*2048kB (M) 7*4096kB (UM) = 1007484kB\nMay 20 19:12:47 ventus kernel: Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=1048576kB\nMay 20 19:12:47 ventus kernel: Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\nMay 20 19:12:47 ventus kernel: 12619057 total pagecache pages\nMay 20 19:12:47 ventus kernel: 0 pages in swap cache\nMay 20 19:12:47 ventus kernel: Free swap  = 0kB\nMay 20 19:12:47 ventus kernel: Total swap = 0kB\nMay 20 19:12:47 ventus kernel: 16776966 pages RAM\nMay 20 19:12:47 ventus kernel: 0 pages HighMem/MovableOnly\nMay 20 19:12:47 ventus kernel: 447358 pages reserved\nMay 20 19:12:47 ventus kernel: 0 pages cma reserved\nMay 20 19:12:47 ventus kernel: 0 pages hwpoisoned\nMay 20 19:12:47 ventus kernel: Tasks state (memory values in pages):\nMay 20 19:12:47 ventus kernel: [  pid  ]   uid  tgid total_vm      rss pgtables_bytes swapents oom_score_adj name\nMay 20 19:12:47 ventus kernel: [    788]     0   788    33741    22778   294912        0          -250 systemd-journal\nMay 20 19:12:47 ventus kernel: [    806]     0   806     9522      973    90112        0         -1000 systemd-udevd\nMay 20 19:12:47 ventus kernel: [    922]     0   922     4938      229    53248        0         -1000 auditd\nMay 20 19:12:47 ventus kernel: [    948]    81   948     2669      160    57344        0          -900 dbus-broker-lau\nMay 20 19:12:47 ventus kernel: [    949]    81   949     1288      128    49152        0          -900 dbus-broker\nMay 20 19:12:47 ventus kernel: [    952]     0   952    32394     5645   155648        0             0 firewalld\nMay 20 19:12:47 ventus kernel: [    953]     0   953    20685      128    61440        0             0 irqbalance\nMay 20 19:12:47 ventus kernel: [    954]     0   954     5630      628    81920        0             0 systemd-logind\nMay 20 19:12:47 ventus kernel: [    956]     0   956     4874      448    77824        0             0 VGAuthService\nMay 20 19:12:47 ventus kernel: [    957]     0   957    60862      544   106496        0             0 vmtoolsd\nMay 20 19:12:47 ventus kernel: [    962]   996   962    21252      115    69632        0             0 chronyd\nMay 20 19:12:47 ventus kernel: [    967]     0   967    65101      736   143360        0             0 NetworkManager\nMay 20 19:12:47 ventus kernel: [   1003]     0  1003     4400      512    73728        0         -1000 sshd\nMay 20 19:12:47 ventus kernel: [   1010]     0  1010    64604     3339   126976        0             0 tuned\nMay 20 19:12:47 ventus kernel: [   1014]     0  1014     2155      192    57344        0             0 crond\nMay 20 19:12:47 ventus kernel: [   1016]     0  1016      761       96    45056        0             0 agetty\nMay 20 19:12:47 ventus kernel: [   1087]    27  1087   830038    56773   876544        0             0 mariadbd\nMay 20 19:12:47 ventus kernel: [   1120]   997  1120   729983     1351   262144        0             0 polkitd\nMay 20 19:12:47 ventus kernel: [   1156]     0  1156    82157     3136   245760        0             0 rsyslogd\nMay 20 19:12:47 ventus kernel: [ 119490]  1000 119490     4330      320    69632        0             0 su\nMay 20 19:12:47 ventus kernel: [ 119532]     0 119532     2122      352    65536        0             0 bash\nMay 20 19:12:47 ventus kernel: [ 123391]     0 123391 207001071  1353437 11857920        0             0 java\nMay 20 19:12:47 ventus kernel: [ 123933]     0 123933     1529       96    53248        0             0 script\nMay 20 19:12:47 ventus kernel: [ 123935]     0 123935     1891      224    57344        0             0 bash\nMay 20 19:12:47 ventus kernel: [ 126185]     0 126185     1814       96    57344        0             0 bash\nMay 20 19:12:47 ventus kernel: [ 139238]     0 139238     5266      608    81920        0             0 sshd\nMay 20 19:12:47 ventus kernel: [ 139245]  1000 139245     5266      587    81920        0             0 sshd\nMay 20 19:12:47 ventus kernel: [ 139246]  1000 139246     1861      160    53248        0             0 bash\nMay 20 19:12:47 ventus kernel: [ 139295]  1000 139295     4330      320    69632        0             0 su\nMay 20 19:12:47 ventus kernel: [ 139326]     0 139326     1923      224    61440        0             0 bash\nMay 20 19:12:47 ventus kernel: [ 140040]     0 140040     1396       32    49152        0             0 sleep\nMay 20 19:12:47 ventus kernel: oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=/,mems_allowed=0,global_oom,task_memcg=/system.slice/sshd.service,task=java,pid=123391,uid=0\nMay 20 19:12:47 ventus kernel: Out of memory: Killed process 123391 (java) total-vm:828004284kB, anon-rss:551156kB, file-rss:0kB, shmem-rss:4862592kB, UID:0 pgtables:11580kB oom_score_adj:0\n</code></pre>\n",
    "tags" : [ "java", "jvm-crash" ],
    "owner" : {
      "account_id" : 966712,
      "reputation" : 321,
      "user_id" : 990038,
      "user_type" : "registered",
      "accept_rate" : 6,
      "profile_image" : "https://www.gravatar.com/avatar/cfef72b07850c54b6f275f7876d9425d?s=256&d=identicon&r=PG",
      "display_name" : "JBalaguero",
      "link" : "https://stackoverflow.com/users/990038/jbalaguero"
    },
    "is_answered" : false,
    "view_count" : 82,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1748163091,
    "creation_date" : 1747989168,
    "link" : "https://stackoverflow.com/questions/79635136/java24-crashes-when-virtualthread-u-invokes-oom-killer",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79637500,
    "question_id" : 79635136,
    "body" : "<p>The oom-killer is part of the (Linux) operating system that responds to excessive paging load by identifying the process that is causing the paging and hard killing it (SIGKILL).  If a <code>java</code> process was killed, that implies that it was causing a lot of paging.</p>\n<p>So what is the root cause and solution?</p>\n<p>Generally speaking it means that your system as a whole doesn't have enough physical RAM.  That is leading to the OS having to move a lot of virtual memory pages back and forth between RAM and swapping store; i.e. excessive paging.</p>\n<p>The general solutions are to get more RAM or to reduce your system's virtual memory footprint.  In the context of Java, reducing the virtual memory footprint means reducing the Java Heap size and/or reducing the application's use of off-heap RAM. Also, if the problem is happening when your Java application is (relatively) idle, this <em>suggests</em> that it has a memory leak.  (Google for &quot;how to find a Java memory leak&quot;.)</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1748161935,
    "last_activity_date" : 1748162349,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140456778,
    "post_id" : 79635136,
    "body" : "<i>&quot;after several hours (still idle) crashes with an OOM&quot;</i> It didn&#39;t crash, it was killed by your OS. Also, a Java application uses more memory than just its heap, like native memory, thread stacks, etc.",
    "score" : 0,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1748163129,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140451996,
    "post_id" : 79635136,
    "body" : "Your server ran out of memory, <code>java</code> process got bonked because it was the largest visible target. Not sure what your question is here. If you are looking for recommendations, add at least 16 GB of swap.",
    "score" : 1,
    "owner" : {
      "account_id" : 19435569,
      "reputation" : 2968,
      "user_id" : 21105992,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKQkV.png?s=256",
      "display_name" : "teapot418",
      "link" : "https://stackoverflow.com/users/21105992/teapot418"
    },
    "creation_date" : 1747989949,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79637500" : [ {
      "comment_id" : 140474607,
      "post_id" : 79637500,
      "body" : "Our app never used off heap memory",
      "score" : 0,
      "owner" : {
        "account_id" : 966712,
        "reputation" : 321,
        "user_id" : 990038,
        "user_type" : "registered",
        "accept_rate" : 6,
        "profile_image" : "https://www.gravatar.com/avatar/cfef72b07850c54b6f275f7876d9425d?s=256&d=identicon&r=PG",
        "display_name" : "JBalaguero",
        "link" : "https://stackoverflow.com/users/990038/jbalaguero"
      },
      "creation_date" : 1748681421,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140474351,
      "post_id" : 79637500,
      "body" : "Be aware that a Java application can use off-heap memory.  Significant amounts ... depending on the app.  Use <code>top</code> or similar to try to figure out how much physical memory each process is using.  If the <code>java</code> process is using a lot of off-heap, that should show up.",
      "score" : 0,
      "owner" : {
        "account_id" : 47283,
        "reputation" : 723428,
        "user_id" : 139985,
        "user_type" : "registered",
        "accept_rate" : 69,
        "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
        "display_name" : "Stephen C",
        "link" : "https://stackoverflow.com/users/139985/stephen-c"
      },
      "creation_date" : 1748667774,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140472407,
      "post_id" : 79637500,
      "body" : "This must be a server side, still investigating ... We have reduced the heap to just 16GB (on a 64GB server) and still killed by the oom, but not only the java process, we can see the oom-killer killing other processes.",
      "score" : 0,
      "owner" : {
        "account_id" : 966712,
        "reputation" : 321,
        "user_id" : 990038,
        "user_type" : "registered",
        "accept_rate" : 6,
        "profile_image" : "https://www.gravatar.com/avatar/cfef72b07850c54b6f275f7876d9425d?s=256&d=identicon&r=PG",
        "display_name" : "JBalaguero",
        "link" : "https://stackoverflow.com/users/990038/jbalaguero"
      },
      "creation_date" : 1748607314,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}