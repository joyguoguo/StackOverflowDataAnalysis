{
  "question" : {
    "question_id" : 79657160,
    "title" : "Playing media in the background and stop it when needed",
    "body" : "<p>I want to create an activity that includes an <code>androidx.media3.ui.PlayerView.</code> The player should play a video using a foreground service, allowing media playback to continue even when the app is minimized. However, I want the player, the service, and its notification to stop completely when the activity's <code>onDestroy()</code> method is called.</p>\n<p>Everything works as expected, except that when the activity is destroyed, the media playback pauses, but the service appears to remain active—its notification stays visible, and the user can still resume playback.</p>\n<p>I tried following the official documentation here: <a href=\"https://developer.android.com/media/implement/playback-app\" rel=\"nofollow noreferrer\">https://developer.android.com/media/implement/playback-app</a>, but I’m not sure how to properly stop the service when needed.</p>\n<p>My Code:</p>\n<ul>\n<li><h2>xml layout</h2>\n</li>\n</ul>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;androidx.media3.ui.PlayerView\n    android:id=&quot;@+id/playerView&quot;\n    android:layout_width=&quot;match_parent&quot;\n    android:layout_height=&quot;200dp&quot;\n    app:layout_constraintTop_toTopOf=&quot;parent&quot;\n    app:layout_constraintStart_toStartOf=&quot;parent&quot;\n    app:layout_constraintEnd_toEndOf=&quot;parent&quot;\n    /&gt;\n</code></pre>\n<ul>\n<li><h2>PlaybackService that i copied from <a href=\"https://developer.android.com/media/implement/playback-app#implementing_a_mediasessionservice\" rel=\"nofollow noreferrer\">developer.android</a></h2>\n</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>public class PlaybackService extends MediaSessionService {\n    private MediaSession mediaSession = null;\n\n    @OptIn(markerClass = UnstableApi.class)\n    @Override\n    public void onCreate() {\n        super.onCreate();\n\n        DataSource.Factory dataSourceFactory = ExoPlayerCache.getDataSourceFactory(this);\n\n        ExoPlayer player = new ExoPlayer.Builder(this)\n                .setMediaSourceFactory(new DefaultMediaSourceFactory(dataSourceFactory)) // for cache\n                .build();\n\n        //DefaultMediaNotificationProvider builder = new DefaultMediaNotificationProvider.Builder(this).build();\n\n        //ExoPlayer player = new ExoPlayer.Builder(this).build();\n        mediaSession = new MediaSession.Builder(this, player).build();\n\n    }\n\n    @Nullable\n    @Override\n    public MediaSession onGetSession(MediaSession.ControllerInfo controllerInfo) {\n        return mediaSession;\n    }\n\n    @Override\n    public void onDestroy() {\n        mediaSession.getPlayer().release();\n        mediaSession.release();\n        mediaSession = null;\n        super.onDestroy();\n    }\n}\n</code></pre>\n<ul>\n<li><h2>In my activity</h2>\n</li>\n</ul>\n<pre class=\"lang-java prettyprint-override\"><code>public class ItemViewerActivity extends AppCompatActivity {\n\n    PlayerView playerView;\n    MediaController mediaController;\n    ListenableFuture&lt;MediaController&gt; controllerFuture;\n\n\n    // I think there’s an issue with my code in the onDestroy() method.\n    @Override\n    protected void onDestroy() {\n        if (playerView.getPlayer() != null){\n            playerView.getPlayer().release();\n            mediaController.releaseFuture(controllerFuture);\n            mediaController = null;\n        }\n        super.onDestroy();\n    }\n\n    @Override\n    protected void onStop() {\n        if (playerView.getPlayer() != null){\n            playerView.getPlayer().pause();\n        }\n        super.onStop();\n    }\n\n    @Override\n    protected void onPause() {\n        if (playerView.getPlayer() != null){\n            playerView.getPlayer().pause();\n        }\n        super.onPause();\n    }\n\n    @Override\n    protected void onResume() {\n        if (playerView.getPlayer() != null){\n            //player.play();\n        }\n        super.onResume();\n    }\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        EdgeToEdge.enable(this);\n        setContentView(R.layout.activity_item_viewer);\n        ViewCompat.setOnApplyWindowInsetsListener(findViewById(R.id.main), (v, insets) -&gt; {\n            Insets systemBars = insets.getInsets(WindowInsetsCompat.Type.systemBars());\n            v.setPadding(systemBars.left, systemBars.top, systemBars.right, systemBars.bottom);\n            return insets;\n        });\n\n        playerView = findViewById(R.id.playerView);\n\n        String finalVideoUrl = &quot;videoUrl&quot;;\n\n        SessionToken sessionToken = new SessionToken(ItemViewerActivity.this, new ComponentName(ItemViewerActivity.this, PlaybackService.class));\n        controllerFuture = new MediaController.Builder(ItemViewerActivity.this, sessionToken).buildAsync();\n        controllerFuture.addListener(() -&gt; {\n            // Call controllerFuture.get() to retrieve the MediaController.\n            // MediaController implements the Player interface, so it can be\n            // attached to the PlayerView UI component.\n            try {\n                mediaController = controllerFuture.get();\n                playerView.setPlayer(mediaController);\n\n                playerView.setControllerShowTimeoutMs(2000);\n                MediaItem mediaItem = MediaItem.fromUri(finalVideoUrl);\n\n                mediaController.setMediaItem(mediaItem);\n                mediaController.setRepeatMode(Player.REPEAT_MODE_OFF);\n                mediaController.prepare();\n                mediaController.play();\n            } catch (ExecutionException | InterruptedException e) {\n                Log.e(TAG, &quot;onResponse: &quot; + e.getMessage());\n                Toast.makeText(ItemViewerActivity.this, &quot;Player Failed&quot;, Toast.LENGTH_SHORT).show();\n            }\n        }, MoreExecutors.directExecutor());\n\n    }\n}\n</code></pre>\n<ul>\n<li><h2>Manifest</h2>\n</li>\n</ul>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;uses-permission android:name=&quot;android.permission.INTERNET&quot; /&gt;\n&lt;uses-permission android:name=&quot;android.permission.ACCESS_NETWORK_STATE&quot; /&gt;\n&lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE&quot; /&gt;\n&lt;uses-permission android:name=&quot;android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK&quot;/&gt;\n\n&lt;application\n    android:allowBackup=&quot;true&quot;\n    android:dataExtractionRules=&quot;@xml/data_extraction_rules&quot;\n    android:fullBackupContent=&quot;@xml/backup_rules&quot;\n    android:icon=&quot;@mipmap/ic_launcher&quot;\n    android:label=&quot;@string/app_name&quot;\n    android:roundIcon=&quot;@mipmap/ic_launcher_round&quot;\n    android:supportsRtl=&quot;true&quot;\n    android:theme=&quot;@style/Theme.NASAMediaExplorer&quot;\n    tools:targetApi=&quot;31&quot;&gt;\n    &lt;activity\n        android:name=&quot;.ItemViewerActivity&quot;\n        android:exported=&quot;false&quot;\n        android:screenOrientation=&quot;portrait&quot;\n        /&gt;\n    &lt;activity\n        android:name=&quot;.MainActivity&quot;\n        android:exported=&quot;true&quot;\n        android:screenOrientation=&quot;portrait&quot;\n        &gt;\n        &lt;intent-filter&gt;\n            &lt;action android:name=&quot;android.intent.action.MAIN&quot; /&gt;\n\n            &lt;category android:name=&quot;android.intent.category.LAUNCHER&quot; /&gt;\n        &lt;/intent-filter&gt;\n    &lt;/activity&gt;\n    &lt;service\n        android:name=&quot;.Services.PlaybackService&quot;\n        android:foregroundServiceType=&quot;mediaPlayback&quot;\n        android:exported=&quot;true&quot;&gt;\n        &lt;intent-filter&gt;\n            &lt;action android:name=&quot;androidx.media3.session.MediaSessionService&quot;/&gt;\n        &lt;/intent-filter&gt;\n    &lt;/service&gt;\n&lt;/application&gt;\n</code></pre>\n<ul>\n<li><h2>Implementations</h2>\n</li>\n</ul>\n<pre class=\"lang-kt prettyprint-override\"><code>implementation(&quot;androidx.media3:media3-exoplayer:1.7.1&quot;)\nimplementation(&quot;androidx.media3:media3-exoplayer-dash:1.7.1&quot;)\nimplementation(&quot;androidx.media3:media3-ui:1.7.1&quot;)\nimplementation(&quot;androidx.media3:media3-session:1.7.1&quot;)\n</code></pre>\n",
    "tags" : [ "java", "android", "android-service", "android-mediaplayer", "exoplayer" ],
    "owner" : {
      "account_id" : 32111831,
      "reputation" : 21,
      "user_id" : 24912663,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/25226738dc03deb2217d0c967f36a905?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "ahmadreza gh",
      "link" : "https://stackoverflow.com/users/24912663/ahmadreza-gh"
    },
    "is_answered" : false,
    "view_count" : 133,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1754386941,
    "creation_date" : 1749314011,
    "link" : "https://stackoverflow.com/questions/79657160/playing-media-in-the-background-and-stop-it-when-needed",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79723955,
    "question_id" : 79657160,
    "body" : "<p>You can try this three things, hope that helps.</p>\n<p>To stop the Service from Activity:</p>\n<pre><code>    myService = new Intent(this, MediaSessionService.class);\n    stopService(myService);\n</code></pre>\n<p>To remove the Notication, add in Service onDestroy() or in an appropriate place:</p>\n<pre><code>    NotificationManagerCompat manager = NotificationManagerCompat.from(this);\n    manager.cancelAll();\n</code></pre>\n<p>The Service can stop when the user dismissed the app from the recent tasks, add in Service:</p>\n<pre><code>\n    @Override\n    public void onTaskRemoved(@Nullable Intent rootIntent) {\n       // do some code if needed\n        stopSelf();\n    }\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 12875748,
      "reputation" : 709,
      "user_id" : 9312516,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0d4c262064036df7dc6f554cee575896?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cor",
      "link" : "https://stackoverflow.com/users/9312516/cor"
    },
    "creation_date" : 1754217084,
    "last_activity_date" : 1754386941,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140496178,
    "post_id" : 79657160,
    "body" : "Please trim your code to make it easier to find your problem. Follow these guidelines to create a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : -1,
      "reputation" : 1,
      "user_id" : -1,
      "user_type" : "moderator",
      "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
      "display_name" : "Community",
      "link" : "https://stackoverflow.com/users/-1/community"
    },
    "creation_date" : 1749333714,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79723955" : [ {
      "comment_id" : 140642971,
      "post_id" : 79723955,
      "body" : "@GabeSechan Hi, thanks for comment. In my mediaplayer-app, the Activity can remain in the background indefinitely without being terminated by the OS. However, I have formulated the answer more generally.",
      "score" : 0,
      "owner" : {
        "account_id" : 12875748,
        "reputation" : 709,
        "user_id" : 9312516,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/0d4c262064036df7dc6f554cee575896?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Cor",
        "link" : "https://stackoverflow.com/users/9312516/cor"
      },
      "creation_date" : 1754386764,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140638955,
      "post_id" : 79723955,
      "body" : "You probably don&#39;t want to stop the service in the Activity&#39;s onDestroy.  The OS will destroy the Activity and recreate it if backgrounded more than very briefly.  If it does this and you stop the service, playback will stop.",
      "score" : 0,
      "owner" : {
        "account_id" : 1790714,
        "reputation" : 94810,
        "user_id" : 1631193,
        "user_type" : "registered",
        "accept_rate" : 71,
        "profile_image" : "https://www.gravatar.com/avatar/ac9dfee58394495fa69f12f58a928be3?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Gabe Sechan",
        "link" : "https://stackoverflow.com/users/1631193/gabe-sechan"
      },
      "creation_date" : 1754233311,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}