{
  "question" : {
    "question_id" : 79617756,
    "title" : "Spring JPA(or Hibernate) use Scala collections instead of Java ones when mapping DB record to Entities",
    "body" : "<p>I'm observing a very strange behavior of our spring application.\nBefore continuing with the main problem let me give you some background. Me and my team are having Spring boot application that is responsible for storing data about projects(Project object) and versions(Version object) and or course they are related as: Many versions can be associated with a One project. For DB we use MySQL and our Spring boot version is 3.4.2. Each version contains several fields and some of them are another objects, that can contains lists or maps with depth max of 3(if this matters).</p>\n<p>The high level of the version object before was:</p>\n<pre><code>@Entity\n@Table(name = &quot;VersionBefore&quot;)\n@Data\npublic class VersionBefore {\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\n  @Column(name = &quot;v_id&quot;, nullable = false)\n  private Long id;\n\n  ......\n\n  @OneToMany(mappedBy = &quot;testObj&quot;, cascade = CascadeType.ALL)\n  @JsonManagedReference\n  private WrapperObjBefore;\n\n  .....\n\n}\n</code></pre>\n<p>In order to make these objects &quot;generic&quot; and add versioning to them, we want to convert them to <code>HashMap&lt;String, Object&gt;</code>. So far so good. I have replaced the objects with their HashMap representation(and fixed the change issues) and run some unit tests and everything looks fine.</p>\n<p>And after I moved to maps it is:</p>\n<pre><code>@Entity\n@Table(name = &quot;VersionAfter&quot;)\n@Data\npublic class VersionAfter {\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\n  @Column(name = &quot;v_id&quot;, nullable = false)\n  private Long id;\n\n  ......\n\n  @OneToMany(mappedBy = &quot;testObj&quot;, cascade = CascadeType.ALL)\n  @JsonManagedReference\n  private Map&lt;String, Object&gt; WrapperObjAfter;\n\n  .....\n\n}\n</code></pre>\n<p>Then I started the component testing by creating SQL script with test data and running tests for some of the impacted endpoints. As a result all of the tests failed because when I run for example <code>getVersionById</code> the output contains scala implementations of the lists or maps, which are different, compared to the java implementation of this collection and the ObjectMapper is not able to convert them.</p>\n<p>Below you can find the expect output(on high level):</p>\n<pre><code>{\n  &quot;WrapperObjAfter&quot; : {\n    &quot;Key1&quot; : &quot;Value1&quot;,\n    &quot;Key2&quot; : {\n      &quot;Key3&quot; : &quot;Value3&quot;,\n    }\n}\n</code></pre>\n<p>And here is the actual output:</p>\n<pre><code>{\n  &quot;WrapperObjAfter&quot; : {\n    &quot;scala$collection$immutable$Map$Map2$$key1&quot; : &quot;Key1&quot;,\n    &quot;scala$collection$immutable$Map$Map2$$value1&quot; : &quot;Value1&quot;,\n    &quot;scala$collection$immutable$Map$Map2$$key2&quot; : &quot;Key2&quot;,\n    &quot;scala$collection$immutable$Map$Map2$$value2&quot; : {\n      .....\n    }\n  }\n}\n</code></pre>\n<p>In the Database everything is okay and the column there is of type JSON but it looks like that something is happening when we map the DB record to the Java object, which is done by ORM we use - Hibernate.</p>\n<p>Is there anyone who faced something similar before? We do not use Scala at all and I do not expect to have any forms of it into our application workflow(excluding the transitive dependencies used by some of the dependencies we use) so this behavior is very surprising to me</p>\n",
    "tags" : [ "java", "spring", "scala", "hibernate" ],
    "owner" : {
      "account_id" : 12221305,
      "reputation" : 1,
      "user_id" : 8920315,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/1560462100659251/picture?type=large",
      "display_name" : "Delcho Dichev",
      "link" : "https://stackoverflow.com/users/8920315/delcho-dichev"
    },
    "is_answered" : false,
    "view_count" : 75,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747079708,
    "creation_date" : 1747049501,
    "link" : "https://stackoverflow.com/questions/79617756/spring-jpaor-hibernate-use-scala-collections-instead-of-java-ones-when-mapping",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140420175,
    "post_id" : 79617756,
    "body" : "Hi @Ga&#235;lJ, you are totally right, somehow Hibernate uses Scala under the hood and cast the objects. Lucky after a lot of debugging and reading , I have managed to find a solution and it is to use custom converter, instead of using the default one. Something that I forgot the add above is that I use  <code>@JdbcTypeCode(SqlTypes.JSON)</code> and this looks like to cause the problems.",
    "score" : 0,
    "owner" : {
      "account_id" : 12221305,
      "reputation" : 1,
      "user_id" : 8920315,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/1560462100659251/picture?type=large",
      "display_name" : "Delcho Dichev",
      "link" : "https://stackoverflow.com/users/8920315/delcho-dichev"
    },
    "creation_date" : 1747115538,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140419274,
    "post_id" : 79617756,
    "body" : "I&#39;m confused: you have a JSON column in the DB, mapped to a Java <code>Map</code> at the entity level and when Hibernate does its job to read from the DB, then the keys in the <code>Map</code> are these Scala r&#233;f&#233;rences and values are messed up as well? Is that what you&#39;re describing? Can you create a minimal reproducible example? This sounds quite strange indeed.",
    "score" : 0,
    "owner" : {
      "account_id" : 7034556,
      "reputation" : 15907,
      "user_id" : 5389127,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/391c01e15f62cee096b758c4c2815c2c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ga&#235;l J",
      "link" : "https://stackoverflow.com/users/5389127/ga%c3%abl-j"
    },
    "creation_date" : 1747079691,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140418152,
    "post_id" : 79617756,
    "body" : "Hey @M.Deinum yes, the only and even test Scala dependencies are those in spring-kafka-test. Unfortunately, without them Im not able to use the test features of Kafka so I can&#39;t exclude them",
    "score" : 0,
    "owner" : {
      "account_id" : 12221305,
      "reputation" : 1,
      "user_id" : 8920315,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/1560462100659251/picture?type=large",
      "display_name" : "Delcho Dichev",
      "link" : "https://stackoverflow.com/users/8920315/delcho-dichev"
    },
    "creation_date" : 1747058101,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140417679,
    "post_id" : 79617756,
    "body" : "Well there must be some scala dependencies still left in there, else it wouldn&#39;t use scala collections.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1747049771,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}