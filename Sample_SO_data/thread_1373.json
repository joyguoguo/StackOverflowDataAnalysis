{
  "question" : {
    "question_id" : 79713637,
    "title" : "Tomcat 11 multipart upload not sending the attachments",
    "body" : "<p>I've some very old PHP code that does a <code>POST multipart/form-data</code> request to a Tomcat server and it passes in it an <code>XML</code> string as one part and a file, as attachment, as second part.</p>\n<p>For completeness, the code is listed below:</p>\n<pre class=\"lang-php prettyprint-override\"><code>function SendTmsNewsToHost($host, $port, $dest_url, $tnixdata, $attachment) {\n\n  global $debug, $TMS_LineId;\n\n  $mime_boundary = md5(date('r', time()));\n  if ($port==0) $port = 8080;\n  $destination = &quot;http://$host:$port/$dest_url&quot;;\n  $eol = &quot;\\r\\n&quot;;\n\n  $tmsnews_xml = '--' . $mime_boundary . $eol;\n  $tmsnews_xml .= 'Content-Disposition: form-data; name=&quot;_tnix&quot;' . $eol . 'Content-Type: text/xml' . $eol . $eol;\n  $tmsnews_xml .= $tnixdata . $eol;\n  $msg_length = strlen($tmsnews_xml);\n\n  $tmsnews_attachment = &quot;&quot;;\n  $fstr=&quot;&quot;;\n\n\n  if($attachment!='') {\n\n    // MIME attachments type recognization, not necessary for DAM\n    /*\n    require('mime_type_lib.php');\n    $mime_type = get_file_mime_type($attachment);\n    */\n    $base_name=basename($attachment);\n\n    $fpr = fopen($attachment, &quot;rb&quot;);\n    $fsize=filesize($attachment);\n    $fstr = fread($fpr, $fsize);\n    fclose($fpr);\n\n    $tmsnews_attachment = '--' . $mime_boundary . $eol;\n    $tmsnews_attachment .= 'Content-Disposition: attachment; name=&quot;attachment&quot;; filename=&quot;' . $base_name . '&quot;' . $eol;\n    $file_length = strlen($fstr);\n    $tmsnews_attachment .= 'Content-Length: ' . $file_length . $eol;\n    $tmsnews_attachment .= 'Content-Transfer-Encoding: binary' . $eol . $eol;\n\n    // include attachment length\n    // (Everything coming after the first empty line (\\r\\n) -- including your boundary delimiters -- should be counted in the total length )\n    // but not first: + strlen($eol);\n    $msg_length += strlen($tmsnews_attachment) + $file_length ;\n  }\n\n$content = $tmsnews_xml . ($attachment!=''? $tmsnews_attachment . $fstr . $eol: '') .  &quot;--$mime_boundary--&quot;. $eol . $eol;\n$curl = curl_init($destination);\nif (is_resource($curl) === true) {\n\n    # TODO content-length check\n    $realContentSize = strlen($content);\n    $contentSize = ($msg_length+strlen($eol . &quot;--$mime_boundary--&quot;. $eol . $eol));\n    flog(FINFO, &quot;content logging&quot;);\n    flog(FINFO, &quot;content logging $realContentSize &quot;.$realContentSize);\n    flog(FINFO, &quot;content logging $contentSize &quot;.$contentSize);\n    flog(FINFO, &quot;content logging&quot;);\n    flog(FINFO, $content);\n    # TODO content-length check\n\n    curl_setopt($curl, CURLOPT_HTTPHEADER, array(\n                  'Content-Type: multipart/form-data; boundary=&quot;' . $mime_boundary . '&quot;',\n                  'Host: ' . &quot;$host:$port&quot;,\n                  'Content-length: ' . ($msg_length+strlen($eol . &quot;--$mime_boundary--&quot;. $eol . $eol)),\n                                    'Connection: Close'\n               ));\n\n    curl_setopt($curl, CURLOPT_FAILONERROR, true);\n    curl_setopt($curl, CURLOPT_FOLLOWLOCATION, true);\n    curl_setopt($curl, CURLOPT_HEADER, false);\n    curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);\n    curl_setopt($curl, CURLOPT_VERBOSE, true);\n    curl_setopt($curl, CURLOPT_POST, true);\n\n    curl_setopt($curl, CURLOPT_POSTFIELDS, $content);\n\n    $response = curl_exec($curl);\n    curl_close($curl);\n\n  return $response;\n}\n</code></pre>\n<p>On the Java side, there is a <code>Servlet</code> which was parsing the entire <code>InputStream</code> by hand and extracting the information from the payload.</p>\n<p>This worked fine with Tomcat 9.x, but it doesn't work anymore with Tomcat 11.0.9.</p>\n<p>In particular, I hit the following problems:</p>\n<ul>\n<li>multipart requests were not possible anymore in general â†’ solved by setting <code>allowCasualMultipartParsing=&quot;true&quot;</code> in the Tomcat context of the app;</li>\n<li>the custom parsing logic was not able to find the boundaries correctly anymore and it was crashing.</li>\n</ul>\n<p>To solve the second point, I tried to rework the existing code to use the capabilities offered by the Servlet API and I refactored it as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>// Already existing code\npublic MultipartFormData(final HttpServletRequest request, final long byteLimit) throws IOException {\n\n    String contentType = getContentType(request);\n    if (contentType == null || !contentType.equalsIgnoreCase(CONTENT_TYPE)) {\n        throw new IllegalArgumentException(&quot;invalid content type: &quot; + contentType);\n    }\n\n    if (getBoundary(request) == null) {\n        throw new IllegalArgumentException(&quot;missing boundary&quot;);\n    }\n\n    try {\n        initFromStream(request, byteLimit);\n    } finally {\n        close();\n    }\n}\n\n// Already existing code\n@Override\npublic void close() {\n    Enumeration&lt;String&gt; fields = getFileFormFields();\n    while (fields.hasMoreElements()) {\n        String field = fields.nextElement();\n        String[] localPaths = getLocalPathValues(field);\n\n        for (String localPath : localPaths) new File(localPath).delete();\n    }\n\n    fileInfos_.clear();\n}\n\n// Already existing code\nprivate String getContentType(final HttpServletRequest request) {\n    String contentType = request.getContentType();\n    if (contentType == null) {\n        return null;\n    }\n\n    int semiColonIndex = contentType.indexOf(';');\n    if (semiColonIndex == -1) {\n        return contentType;\n    }\n\n    return contentType.substring(0, semiColonIndex);\n}\n\n// Already existing code\nprivate byte[] getBoundary(final HttpServletRequest request) {\n    String contentType = request.getContentType();\n    if (contentType == null) {\n        return null;\n    }\n\n    int boundaryIndex = contentType.toLowerCase().indexOf(&quot;boundary&quot;);\n    if (boundaryIndex == -1) {\n        return null;\n    }\n\n    int startIndex = boundaryIndex + 9;\n\n    // fix : gequotete boundaries auch akzeptieren\n    char delimiter = ';';\n    if ((contentType.length() &gt; startIndex)\n            &amp;&amp; (contentType.charAt(startIndex) == '&quot;')) {\n        startIndex++;\n        delimiter = '&quot;';\n    }\n    int endIndex = startIndex;\n    for (int i = startIndex; i &lt; contentType.length()\n            &amp;&amp; contentType.charAt(i) != delimiter; ++i) {\n        ++endIndex;\n    }\n\n    return contentType.substring(startIndex, endIndex).getBytes();\n}\n\n// Refactored code\nprivate void initFromStream(final HttpServletRequest input, final long byteLimit) throws IOException {\n    long requestSize = input.getContentLengthLong();\n    if (requestSize == -1) {\n        try {\n            requestSize = input.getParts().stream().mapToLong(Part::getSize).sum();\n        } catch (ServletException e) {\n            throw new IOException(e);\n        }\n    }\n    if (requestSize &gt; byteLimit) throw new ByteLimitExceededException(&quot;byte limit exceeded: &quot; + byteLimit);\n\n    readParts(input);\n}\n\n// Already existing code\nprivate void addParameter(final String name, final String value) {\n    List&lt;String&gt; values = parameters_.get(name);\n    if (values == null) {\n        values = new LinkedList&lt;&gt;();\n    }\n\n    values.add(value);\n\n    parameters_.put(name, values);\n}\n\n\n\n// Refactored code\nprivate void readParts(final HttpServletRequest input) throws IOException {\n    try {\n        for (Part part : input.getParts()) {\n            if (part.getSubmittedFileName() == null) {\n                addParameter(part.getName(), readValue(part));\n            } else {\n                addFileInfo(part.getName(), new FileInfo(readData(part), part.getSubmittedFileName(), part.getContentType()));\n            }\n        }\n    } catch (ServletException ex) {\n        throw new IOException(ex);\n    }\n}\n\n// Refactored code\nprivate String readValue(Part part) throws IOException {\n    StringBuilder builder = new StringBuilder();\n    try (BufferedReader reader = new BufferedReader(new InputStreamReader(part.getInputStream()))) {\n        String line;\n        while ((line = reader.readLine()) != null) builder.append(line).append(lineSeparator());\n    }\n\n    return builder.toString().strip();\n}\n\n// Refactored code\nprivate String readData(Part part) throws IOException {\n    File file = File.createTempFile(&quot;multipartdatabean&quot;, null);\n    file.deleteOnExit();\n\n    try (BufferedOutputStream out = new BufferedOutputStream(new FileOutputStream(file));\n         BufferedInputStream in = new BufferedInputStream(part.getInputStream())) {\n        byte[] buffer = new byte[8192];\n        int bytesRead;\n        while ((bytesRead = in.read(buffer)) != -1) {\n            out.write(buffer, 0, bytesRead);\n        }\n    }\n    return file.getPath();\n}\n\n// Already existing code\nprivate void addFileInfo(final String name, final FileInfo info) {\n    List&lt;FileInfo&gt; infos = fileInfos_.get(name);\n    if (infos == null) {\n        infos = new LinkedList&lt;&gt;();\n    }\n\n    infos.add(info);\n\n    fileInfos_.put(name, infos);\n}\n</code></pre>\n<p>Result: no errors anymore, but only the XML gets indeed processed. The attachment is simply lost.</p>\n<p>I tried then by removing <code>allowCasualMultipartParsing=&quot;true&quot;</code> and adding an explicit multipart configuration for the Servlet in the <code>web.xml</code> like</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;servlet&gt;\n    &lt;servlet-name&gt;NewsQueryService&lt;/servlet-name&gt;\n    &lt;servlet-class&gt;foo.NSPortal&lt;/servlet-class&gt;\n    &lt;init-param&gt;\n        &lt;param-name&gt;log4j-init-file&lt;/param-name&gt;\n        &lt;param-value&gt;WEB-INF/etc/log4j.properties&lt;/param-value&gt;\n    &lt;/init-param&gt;\n    &lt;init-param&gt;\n        &lt;param-name&gt;log4j-read-intervall&lt;/param-name&gt;\n        &lt;param-value&gt;10000&lt;/param-value&gt;\n    &lt;/init-param&gt;\n    &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;\n    &lt;multipart-config&gt;\n        &lt;location&gt;/home/nsc/tmp&lt;/location&gt;\n        &lt;max-file-size&gt;104857600&lt;/max-file-size&gt;\n        &lt;max-request-size&gt;418018841&lt;/max-request-size&gt;\n        &lt;file-size-threshold&gt;10485760&lt;/file-size-threshold&gt;\n    &lt;/multipart-config&gt;\n&lt;/servlet&gt;\n</code></pre>\n<p>but I got the same result.</p>\n<p>I tried then to rework the implementation by using the Apache Commons FileUpload library and the examples in <a href=\"https://commons.apache.org/proper/commons-fileupload/using.html\" rel=\"nofollow noreferrer\">here</a>, but I got the same result.</p>\n<p>Also, since I've Spring Web 6.x available, I tried using their <code>MultipartFilter</code> in the <code>web.xml</code> like:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;filter&gt;\n    &lt;filter-name&gt;multipart&lt;/filter-name&gt;\n    &lt;filter-class&gt;org.springframework.web.multipart.support.MultipartFilter&lt;/filter-class&gt;\n&lt;/filter&gt;\n&lt;filter-mapping&gt;\n    &lt;filter-name&gt;multipart&lt;/filter-name&gt;\n    &lt;servlet-name&gt;NewsQueryService&lt;/servlet-name&gt;\n&lt;/filter-mapping&gt;\n</code></pre>\n<p>and reworked the implementation above as follows:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public MultipartFormData(final HttpServletRequest request, final long byteLimit) throws IOException {\n    if(!(request instanceof MultipartHttpServletRequest multipartRequest)) throw new IllegalArgumentException(&quot;Not a multipart request&quot;);\n\n    long totalFileSizeBytes = 0;\n    for(Entry&lt;String, MultipartFile&gt; file : multipartRequest.getFileMap().entrySet()) {\n        MultipartFile multipartFile = file.getValue();\n        totalFileSizeBytes += multipartFile.getSize();\n        if (totalFileSizeBytes &gt; byteLimit) throw new ByteLimitExceededException(&quot;byte limits exceeded&quot;);\n\n        File osFile = multipartFile.getResource().getFile();\n        addFileInfo(file.getKey(), new FileInfo(osFile.getPath(), osFile.getName(), multipartFile.getContentType()));\n    }\n    Enumeration&lt;String&gt; parameterNames = multipartRequest.getParameterNames();\n    while (parameterNames.hasMoreElements()) {\n        String parameterName = parameterNames.nextElement();\n        String[] parameterValues = multipartRequest.getParameterValues(parameterName);\n        for (String value : parameterValues) {\n            addParameter(parameterName, value);\n        }\n    }\n}\n</code></pre>\n<p>but I got once more the same outcome.</p>\n<p>Finally, looking at their filter implementation, I tried to mimic it for the limits I need as shown below:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public MultipartFormData(final HttpServletRequest request, final long byteLimit) throws IOException {\n    try {\n        long totalFileSizeBytes = 0;\n        for(Part part : request.getParts()) {\n            totalFileSizeBytes += part.getSize();\n            if (totalFileSizeBytes &gt; byteLimit) throw new ByteLimitExceededException(&quot;byte limits exceeded&quot;);\n\n            String headerValue = part.getHeader(CONTENT_DISPOSITION);\n            ContentDisposition disposition = parse(headerValue);\n            String filename = disposition.getFilename();\n            if (filename == null) {\n                addParameter(part.getName(), readValue(part));\n            } else {\n                addFileInfo(part.getName(), new FileInfo(readData(part), filename, part.getContentType()));\n            }\n            part.delete();\n        }\n    } catch (ServletException ex) {\n        throw new IOException(ex);\n    }\n}\n</code></pre>\n<p>but also this, in the end, produced the same outcome.</p>\n<p>Does somebody have any idea?</p>\n",
    "tags" : [ "java", "tomcat" ],
    "owner" : {
      "account_id" : 7816784,
      "reputation" : 99,
      "user_id" : 5911228,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "cdprete",
      "link" : "https://stackoverflow.com/users/5911228/cdprete"
    },
    "is_answered" : true,
    "view_count" : 92,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1753373750,
    "creation_date" : 1753372258,
    "link" : "https://stackoverflow.com/questions/79713637/tomcat-11-multipart-upload-not-sending-the-attachments",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79713675,
    "question_id" : 79713637,
    "body" : "<p>The root cause is PHP client sends <code>Content-Disposition: attachment</code> instead of <code>Content-Disposition: form-data</code> for file parts.</p>\n<p>Here's how you can fix the code:</p>\n<pre class=\"lang-php prettyprint-override\"><code>// Change this line:\n$tmsnews_attachment .= 'Content-Disposition: attachment; name=&quot;attachment&quot;; filename=&quot;' . $base_name . '&quot;' . $eol;\n\n// To this:\n$tmsnews_attachment .= 'Content-Disposition: form-data; name=&quot;attachment&quot;; filename=&quot;' . $base_name . '&quot;' . $eol;\n</code></pre>\n<p>Also remove the invalid <code>Content-Length</code> header from individual parts:</p>\n<pre class=\"lang-php prettyprint-override\"><code>// Remove this line entirely:\n$tmsnews_attachment .= 'Content-Length: ' . $file_length . $eol;\n</code></pre>\n<p>This way tomcat 11 will properly parse both XML and file parts.</p>\n<p>If you can't modify the PHP client, As an alternative, implement a custom lenient multipart parser on the Java side, but fixing the client is the proper solution.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 11537261,
      "reputation" : 2290,
      "user_id" : 8454203,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/HTEnp.jpg?s=256",
      "display_name" : "OM Bharatiya",
      "link" : "https://stackoverflow.com/users/8454203/om-bharatiya"
    },
    "creation_date" : 1753373750,
    "last_activity_date" : 1753373750,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79713675" : [ {
      "comment_id" : 140615985,
      "post_id" : 79713675,
      "body" : "The revert of some other changes I did for this + this exact change solved indeed the issue. Thanks OM Bharatiya.",
      "score" : 0,
      "owner" : {
        "account_id" : 7816784,
        "reputation" : 99,
        "user_id" : 5911228,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "cdprete",
        "link" : "https://stackoverflow.com/users/5911228/cdprete"
      },
      "creation_date" : 1753381101,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140615858,
      "post_id" : 79713675,
      "body" : "Shouldn&#39;t have failed also in the past then?",
      "score" : 0,
      "owner" : {
        "account_id" : 7816784,
        "reputation" : 99,
        "user_id" : 5911228,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/92c5b1b1551a67b8fbf7bd29d32e4e63?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "cdprete",
        "link" : "https://stackoverflow.com/users/5911228/cdprete"
      },
      "creation_date" : 1753378090,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}