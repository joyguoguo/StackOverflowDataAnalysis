{
  "question" : {
    "question_id" : 79530574,
    "title" : "Hikari 5.1.0 loses connections within Azure",
    "body" : "<p>We have a server.jar and a client.jar, they both use Hikari 5.1.0 to connect to the same SQLServer database. The server.jar is deployed on two machines, they are connected with Hazelcast 5.3.8. The server.jar is always running. The client.jar, connected as a client with Hazelcast, runs only sometimes on the same machines when a user has to have a look in the database for instance. Everything runs on Azure. The database supports 300 connections, we gave each server 150 connections, so Hikari initializes them.\nWe need such a high number of connections because of multithreading; many calculations are done in parallel and they all need access to the database.</p>\n<p>Let's call this ENV1. The problem is that every now and then it seems to lose all of the connections, indicated by total=0:</p>\n<pre><code>2025-03-13 01:03:14.921 [pool-3-thread-1] ERROR - java.sql.SQLTransientConnectionException: HikariPool-1 - Connection is not available, request timed out after 30069ms (total=0, active=0, idle=0, waiting=0)\n</code></pre>\n<p>We did do a downscale yesterday: both server.jars get 120 connections (2 x 120 = 240), leaving 60 (300 - 240 = 60) to support the client.jars. <strong>Question 1</strong>: Would that help?</p>\n<p>In another deployment, ENV2, where we almost never use the client.jar, things seem to go better. Here the total=0 error also occurs, but two minutes after that the database queries run just fine:</p>\n<pre><code>2025-03-18 02:44:46.043 [qtp718505350-94] ERROR  - java.sql.SQLTransientConnectionException: HikariPool-1 - Connection is not available, request timed out after 30004ms (total=0, active=0, idle=0, waiting=0)\n</code></pre>\n<p>Also, we have found that Azure can just capture a random number of database connections;</p>\n<p><a href=\"https://learn.microsoft.com/en-us/azure/azure-sql/database/troubleshoot-common-errors-issues?view=azuresql\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/en-us/azure/azure-sql/database/troubleshoot-common-errors-issues?view=azuresql</a></p>\n<p>This article states the following:</p>\n<p><em>The Azure infrastructure has the ability to dynamically reconfigure servers when heavy workloads arise in the SQL Database service. This dynamic behavior might cause your client program to lose its connection to the database or instance.</em></p>\n<p><strong>Question 2:</strong> Could that also explain why we lose connections in ENV1? But why does it go ok then for ENV2?</p>\n<p><strong>Update</strong>\nENV2 also looses all connections and does not recover. (End update)</p>\n<p>The only difference we found is that in ENV1 the socketTimeout is set to 30000, to let Hikari recover faster, while in ENV2 it is not set.</p>\n<p>NB On our development environment outside of Azure we have no problem running on our SQLServer database.</p>\n<p><strong>Update</strong>\nThe Hikari parameters:</p>\n<pre><code> com.zaxxer.hikari.HikariConfig - HikariPool-1 - configuration:\n com.zaxxer.hikari.HikariConfig - allowPoolSuspension.............false\n com.zaxxer.hikari.HikariConfig - autoCommit......................false\n com.zaxxer.hikari.HikariConfig - catalog.........................none\n com.zaxxer.hikari.HikariConfig - connectionInitSql...............none\n com.zaxxer.hikari.HikariConfig - connectionTestQuery.............none\n com.zaxxer.hikari.HikariConfig - connectionTimeout...............30000\n com.zaxxer.hikari.HikariConfig - credentials.....................com.zaxxer.hikari.util.Credentials@1d8bd0de\n com.zaxxer.hikari.HikariConfig - dataSource......................SQLServerDataSource:1\n com.zaxxer.hikari.HikariConfig - dataSourceClassName.............none\n com.zaxxer.hikari.HikariConfig - dataSourceJNDI..................none\n com.zaxxer.hikari.HikariConfig - dataSourceProperties............{password=&lt;masked&gt;}\n com.zaxxer.hikari.HikariConfig - driverClassName.................none\n com.zaxxer.hikari.HikariConfig - exceptionOverride...............none\n com.zaxxer.hikari.HikariConfig - exceptionOverrideClassName......none\n com.zaxxer.hikari.HikariConfig - healthCheckProperties...........{}\n com.zaxxer.hikari.HikariConfig - healthCheckRegistry.............none\n com.zaxxer.hikari.HikariConfig - idleTimeout.....................600000\n com.zaxxer.hikari.HikariConfig - initializationFailTimeout.......1\n com.zaxxer.hikari.HikariConfig - isolateInternalQueries..........false\n com.zaxxer.hikari.HikariConfig - jdbcUrl.........................none\n com.zaxxer.hikari.HikariConfig - keepaliveTime...................30000\n com.zaxxer.hikari.HikariConfig - leakDetectionThreshold..........0\n com.zaxxer.hikari.HikariConfig - maxLifetime.....................300000\n com.zaxxer.hikari.HikariConfig - maximumPoolSize.................1000\n com.zaxxer.hikari.HikariConfig - metricRegistry..................none\n com.zaxxer.hikari.HikariConfig - metricsTrackerFactory...........none\n com.zaxxer.hikari.HikariConfig - minimumIdle.....................1000\n com.zaxxer.hikari.HikariConfig - password........................&lt;masked&gt;\n com.zaxxer.hikari.HikariConfig - poolName........................&quot;HikariPool-1&quot;\n com.zaxxer.hikari.HikariConfig - readOnly........................false\n com.zaxxer.hikari.HikariConfig - registerMbeans..................false\n com.zaxxer.hikari.HikariConfig - scheduledExecutor...............none\n com.zaxxer.hikari.HikariConfig - schema..........................none\n com.zaxxer.hikari.HikariConfig - threadFactory...................internal\n com.zaxxer.hikari.HikariConfig - transactionIsolation............default\n com.zaxxer.hikari.HikariConfig - username........................none\n com.zaxxer.hikari.HikariConfig - validationTimeout...............10000\n</code></pre>\n<p>The maximumPoolSize.................1000 is set as part of an experiment, normally it will be 120.</p>\n",
    "tags" : [ "java", "azure", "azure-sql-database" ],
    "owner" : {
      "account_id" : 205579,
      "reputation" : 91,
      "user_id" : 1652309,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/795d34cb2f5a408427ce1d007c01fe07?s=256&d=identicon&r=PG",
      "display_name" : "eddy",
      "link" : "https://stackoverflow.com/users/1652309/eddy"
    },
    "is_answered" : false,
    "view_count" : 68,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1744379002,
    "creation_date" : 1742805797,
    "link" : "https://stackoverflow.com/questions/79530574/hikari-5-1-0-loses-connections-within-azure",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}