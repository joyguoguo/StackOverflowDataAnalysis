{
  "question" : {
    "question_id" : 79731453,
    "title" : "Token Exchange to edit existing custom claims",
    "body" : "<p>I want to add a new functionality to a webapp and for that functionality, I want to edit an existing claim in my JWT when the user that interacts with the client chooses to use this feature. Now, would it be correct to do this with a token exchange and custom protocol mapper? Can this work? Or would I sort of fetch a new token after DB update of my federated users? The RFC is quite limited in functionality of the token exchange and Keycloak also has its own sort of version.\nI do not really switch client, so an internal-internal token exchange does not seem to fit my usecase.</p>\n",
    "tags" : [ "java", "keycloak", "openid-connect", "token-exchange" ],
    "owner" : {
      "account_id" : 2664143,
      "reputation" : 985,
      "user_id" : 2303101,
      "user_type" : "registered",
      "accept_rate" : 84,
      "profile_image" : "https://www.gravatar.com/avatar/4f1a181f746483d42b2bb27aa9c3f40b?s=256&d=identicon&r=PG",
      "display_name" : "Programmer1994",
      "link" : "https://stackoverflow.com/users/2303101/programmer1994"
    },
    "is_answered" : false,
    "view_count" : 102,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1754894524,
    "creation_date" : 1754853642,
    "link" : "https://stackoverflow.com/questions/79731453/token-exchange-to-edit-existing-custom-claims",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79731726,
    "question_id" : 79731453,
    "body" : "<p>Usually you would involve Keycloak when you want to change access token scopes. Whenever you issue a scope you issue a collection of claims. To get a new scope you could potentially use one of these mechanisms:</p>\n<ul>\n<li>Step up authentication</li>\n<li>Optional user consent to the new scope</li>\n<li>Token exchange with down-scoping</li>\n<li>Token exchange with up-scoping</li>\n</ul>\n<p>Once an access token is issued its claims are immutable. You should aim to use stable claims that do not change within a user's authenticated session. I always restrict claims to main identity values rather than volatile business settings.</p>\n<p>If you need to edit a claim based on user actions it is perhaps a sign that you need an extra authorization value stored outside of access tokens. For example, your web app xould call an API operation that saves that value and can then use it for authorization.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 12368896,
      "reputation" : 30244,
      "user_id" : 9019885,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/bqpQh.jpg?s=256",
      "display_name" : "Gary Archer",
      "link" : "https://stackoverflow.com/users/9019885/gary-archer"
    },
    "creation_date" : 1754894524,
    "last_activity_date" : 1754894524,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140656877,
    "post_id" : 79731453,
    "body" : "Is this in a Spring context? In which case you can add an authorization converter to add to your authorization context tracking additional information, without actually changing the token.",
    "score" : 0,
    "owner" : {
      "account_id" : 3380632,
      "reputation" : 15109,
      "user_id" : 2837741,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/AEHnE.png?s=256",
      "display_name" : "daniu",
      "link" : "https://stackoverflow.com/users/2837741/daniu"
    },
    "creation_date" : 1754903298,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}