{
  "question" : {
    "question_id" : 79602936,
    "title" : "&quot;Too many open files&quot; after 1 month runtime",
    "body" : "<p>I have a Spring Boot app that checks for files every 10s.</p>\n<pre><code>@Scheduled (fixedRateString = &quot;10000&quot;)\npublic void foo ()\n{   \n    try\n    {\n        List &lt;Path&gt; ps = Files.list (Path.of (&quot;mydir&quot;)).sorted ().collect (Collectors.toList ());       \n                    \n        for (Path p : ps)\n        {\n           bar (p); \n        }\n    }\n    catch (Exception e)\n    {\n      System.out.println (e.getMessage ());\n    }\n}\n</code></pre>\n<p>After about 1 month of permanent runtime, I see an exception:</p>\n<p><strong>too many open files</strong></p>\n<p>It disappears as soon as I restart the app.\nNot sure if it is at the <code>Files.list</code> or <code>bar</code>.</p>\n<p>But I do not have any reading/writing of files without closing.\nSo I have no clue why this happens.</p>\n<p>Any ideas? How can I prevent/monitor this?</p>\n",
    "tags" : [ "java", "spring-boot" ],
    "owner" : {
      "account_id" : 117317,
      "reputation" : 12715,
      "user_id" : 307297,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://i.sstatic.net/e28FD.png?s=256",
      "display_name" : "chris01",
      "link" : "https://stackoverflow.com/users/307297/chris01"
    },
    "is_answered" : true,
    "view_count" : 231,
    "closed_date" : 1746446956,
    "answer_count" : 2,
    "score" : 4,
    "last_activity_date" : 1746447034,
    "creation_date" : 1746169057,
    "link" : "https://stackoverflow.com/questions/79602936/too-many-open-files-after-1-month-runtime",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79602960,
    "question_id" : 79602936,
    "body" : "<p>Those are file descriptors, leaked because the <code>Stream</code> isn't closing properly(<code>Files.list</code>).</p>\n<p>The <strong><code>Files.list(Path)</code></strong> method returns a <code>Stream&lt;Path&gt;</code>.</p>\n<p>This stream must be closed with a <strong><code>try-with-resources</code></strong>, not just a <code>try-catch.</code></p>\n<pre><code>try (Stream&lt;Path&gt; stream = Files.list(Path.of(&quot;mydir&quot;))) {\n    List&lt;Path&gt; ps = stream.sorted().collect(Collectors.toList());\n    for (Path p : ps) \n        bar(p);        \n} catch (Exception e) {\n    System.out.println(e.getMessage());\n}\n</code></pre>\n<p><a href=\"https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html\" rel=\"noreferrer\">https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html</a></p>\n<blockquote>\n<p><em>The <code>try</code>-with-resources statement is a <code>try</code> statement that declares one or more resources. A resource is an object that must be closed after the program is finished with it. The <code>try</code>-with-resources statement ensures that each resource is closed at the end of the statement. Any object that implements <code>java.lang.AutoCloseable</code>, which includes all objects which implement <code>java.io.Closeable</code>, can be used as a resource.</em></p>\n</blockquote>\n",
    "score" : 11,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13577,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1746170730,
    "last_activity_date" : 1746189376,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79602976,
    "question_id" : 79602936,
    "body" : "<p>Close the Stream, as the <a href=\"https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/nio/file/Files.html#list(java.nio.file.Path)\" rel=\"noreferrer\">Files.list API</a> suggests:</p>\n<blockquote>\n<p>API Note:</p>\n<p>This method must be used within a try-with-resources statement or similar control structure to ensure that the stream's open directory is closed promptly after the stream's operations have completed.</p>\n</blockquote>\n",
    "score" : 11,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1920229,
      "reputation" : 4453,
      "user_id" : 1731935,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/c23790f4c3fd69f51d462d4772d89c5b?s=256&d=identicon&r=PG",
      "display_name" : "Manuel",
      "link" : "https://stackoverflow.com/users/1731935/manuel"
    },
    "creation_date" : 1746171403,
    "last_activity_date" : 1746179475,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140390128,
    "post_id" : 79602936,
    "body" : "<i>&quot;I thought there is no need to close streams.&quot;</i> - there is a learning moment here ;) Thinking it is the opposite of confirming it.",
    "score" : 2,
    "owner" : {
      "account_id" : 187094,
      "reputation" : 5301,
      "user_id" : 424903,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/8oHZF.png?s=256",
      "display_name" : "Gimby",
      "link" : "https://stackoverflow.com/users/424903/gimby"
    },
    "creation_date" : 1746191225,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389371,
    "post_id" : 79602936,
    "body" : "&quot;I thought there is no need to close streams&quot; -&gt; read the Stream javadoc: &quot;Generally, only streams whose source is an IO channel, such as those returned by Files.lines(Path), will require closing.&quot;",
    "score" : 6,
    "owner" : {
      "account_id" : 19118721,
      "reputation" : 12469,
      "user_id" : 13963086,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/9df2c3c4c87d8050b8fd6a59c88c7133?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "k314159",
      "link" : "https://stackoverflow.com/users/13963086/k314159"
    },
    "creation_date" : 1746175725,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389200,
    "post_id" : 79602936,
    "body" : "If you&#39;re polling files repeatedly over a very long period, you might do better to use a Watch service. See <a href=\"https://stackoverflow.com/q/63731952/14853083\">stackoverflow.com/q/63731952/14853083</a>",
    "score" : 3,
    "owner" : {
      "account_id" : 2095810,
      "reputation" : 5436,
      "user_id" : 14853083,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/tiedu.png?s=256",
      "display_name" : "Tangentially Perpendicular",
      "link" : "https://stackoverflow.com/users/14853083/tangentially-perpendicular"
    },
    "creation_date" : 1746171649,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389144,
    "post_id" : 79602936,
    "body" : "yeah, they should be. Files.list is the one who&#39;s causing it. I dont understand the downvote to your question thou",
    "score" : 3,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13577,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1746170394,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389109,
    "post_id" : 79602936,
    "body" : "I thought there is no need to close streams.",
    "score" : 0,
    "owner" : {
      "account_id" : 117317,
      "reputation" : 12715,
      "user_id" : 307297,
      "user_type" : "registered",
      "accept_rate" : 62,
      "profile_image" : "https://i.sstatic.net/e28FD.png?s=256",
      "display_name" : "chris01",
      "link" : "https://stackoverflow.com/users/307297/chris01"
    },
    "creation_date" : 1746169564,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140389103,
    "post_id" : 79602936,
    "body" : "Those are file descriptors, leaked because the Stream isnt closing properly(files.list)",
    "score" : 3,
    "owner" : {
      "account_id" : 2465829,
      "reputation" : 13577,
      "user_id" : 2148953,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://i.sstatic.net/DVHoP84E.jpg?s=256",
      "display_name" : "aran",
      "link" : "https://stackoverflow.com/users/2148953/aran"
    },
    "creation_date" : 1746169330,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}