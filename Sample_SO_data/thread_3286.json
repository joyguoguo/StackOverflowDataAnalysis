{
  "question" : {
    "question_id" : 79559170,
    "title" : "Hash mismatch before QES signing with Swisscom and iText 7 – &quot;Hash mismatch! Expected ... Got",
    "body" : "<p>I'm implementing a Qualified Electronic Signature (QES) flow using Swisscom Trust Services and iText 7.2.5 in Java. I'm stuck on the step where I compare the SHA-256 hash generated during PrepareHash with the expected hash (used to generate the signature via Swisscom). The hashes do not match, and therefore, the signing fails.</p>\n<p>Steps:</p>\n<ol>\n<li>Prepare the PDF and hash:\nUse PdfSigner in append mode.</li>\n</ol>\n<p>Add a blank signature field with ExternalBlankSignatureContainer.</p>\n<p>Save the resulting <code>_prepared.pdf</code>.</p>\n<p>Calculate the SHA-256 hash of the full prepared PDF file and send it to Swisscom.</p>\n<ol start=\"2\">\n<li>Sign:</li>\n</ol>\n<p>After receiving the <code>SignatureObject.cms</code> from Swisscom, I reopened the prepared PDF, verified the hash again, and tried to embed the signature using signDeferred.</p>\n<p>My main classes:</p>\n<pre class=\"lang-java prettyprint-override\"><code>import com.itextpdf.io.image.ImageData;\nimport com.itextpdf.io.image.ImageDataFactory;\nimport com.itextpdf.kernel.geom.Rectangle;\nimport com.itextpdf.kernel.pdf.*;\nimport com.itextpdf.layout.Canvas;\nimport com.itextpdf.layout.element.Image;\nimport com.itextpdf.signatures.*;\nimport org.bouncycastle.jce.provider.BouncyCastleProvider;\n\nimport java.io.*;\nimport java.security.MessageDigest;\nimport java.security.Security;\nimport java.util.*;\n\npublic class PrepareHash {\n    public static void main(String[] args) {\n        if (args.length &lt; 3) {\n            System.err.println(&quot;Usage: java PrepareHash &lt;inputPDF&gt; &lt;outputPDF&gt; &lt;signatureImagePath&gt;...&quot;);\n            return;\n        }\n\n        String inputPDF = args[0];\n        String outputPDF = args[1];\n        String[] signatureImagePaths = Arrays.copyOfRange(args, 2, args.length);\n\n        try {\n            Security.addProvider(new BouncyCastleProvider());\n\n            // Add visual overlays\n            ByteArrayOutputStream visualized = new ByteArrayOutputStream();\n            PdfDocument pdfDoc = new PdfDocument(new PdfReader(inputPDF), new PdfWriter(visualized));\n\n            for (int i = 0; i &lt; signatureImagePaths.length; i++) {\n                ImageData imageData = ImageDataFactory.create(signatureImagePaths[i]);\n                Image image = new Image(imageData);\n\n                Rectangle pageSize = pdfDoc.getPage(i + 1).getPageSize();\n                image.setFixedPosition(i + 1, 0, 0);\n                image.setWidth(pageSize.getWidth());\n                image.setHeight(pageSize.getHeight());\n\n                new Canvas(pdfDoc.getPage(i + 1), pageSize).add(image);\n            }\n            pdfDoc.close();\n\n            // Hash and prepare the signed placeholder PDF\n            ByteArrayInputStream hashInput = new ByteArrayInputStream(visualized.toByteArray());\n            FileOutputStream signedOut = new FileOutputStream(outputPDF);\n            PdfSigner signer = new PdfSigner(new PdfReader(hashInput), signedOut, new StampingProperties().useAppendMode());\n            signer.setFieldName(&quot;Signature1&quot;);\n\n            MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);\n\n            IExternalSignatureContainer dummyContainer = new IExternalSignatureContainer() {\n                @Override\n                public byte[] sign(InputStream is) {\n                    try {\n                        byte[] buffer = new byte[8192];\n                        int read;\n                        while ((read = is.read(buffer)) != -1) {\n                            digest.update(buffer, 0, read);\n                        }\n                        byte[] hash = digest.digest();\n                        String base64Hash = Base64.getEncoder().encodeToString(hash);\n                        System.out.println(&quot;✅ SHA-256 hash generated (Base64): &quot; + base64Hash);\n                        return new byte[0];\n                    } catch (IOException e) {\n                        throw new RuntimeException(e);\n                    }\n                }\n\n                @Override\n                public void modifySigningDictionary(PdfDictionary dic) {\n                    dic.put(PdfName.Filter, PdfName.Adobe_PPKLite);\n                    dic.put(PdfName.SubFilter, PdfName.ETSI_CAdES_DETACHED);\n                    dic.put(PdfName.M, new PdfString(new PdfDate().toString()));\n                    dic.put(PdfName.Reason, new PdfString(&quot;Visual signature + Hash&quot;));\n                    dic.put(PdfName.Location, new PdfString(&quot;DS | SIGN&quot;));\n                }\n            };\n\n            signer.signExternalContainer(dummyContainer, 25000);\n            System.out.println(&quot;✅ Placeholder signature field added and PDF saved to: &quot; + outputPDF);\n\n        } catch (Exception e) {\n            System.err.println(&quot;❌ Error: &quot; + e.getMessage());\n            e.printStackTrace();\n        }\n    }\n}\n\n\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>\nimport com.itextpdf.kernel.pdf.*;\nimport com.itextpdf.signatures.*;\nimport org.bouncycastle.jce.provider.BouncyCastleProvider;\n\nimport java.io.*;\nimport java.nio.file.Files;\nimport java.nio.file.Paths;\nimport java.security.Security;\n\npublic class SignQES {\n    public static void main(String[] args) {\n        if (args.length &lt; 4) {\n            System.err.println(&quot;Usage: java SignQES &lt;prepared.pdf&gt; &lt;output_signed.pdf&gt; &lt;signatureObject.cms&gt; &lt;reason&gt;&quot;);\n            System.exit(1);\n        }\n\n        String inputPdf = args[0];\n        String outputPdf = args[1];\n        String signatureCmsPath = args[2];\n        String reason = args[3];\n\n        try {\n            Security.addProvider(new BouncyCastleProvider());\n            byte[] signatureBytes = Files.readAllBytes(Paths.get(signatureCmsPath));\n\n            PdfReader reader = new PdfReader(inputPdf);\n            PdfSigner signer = new PdfSigner(reader, new FileOutputStream(outputPdf), new StampingProperties().useAppendMode());\n\n            IExternalSignatureContainer container = new IExternalSignatureContainer() {\n                @Override\n                public byte[] sign(InputStream data) {\n                    return signatureBytes;\n                }\n\n                @Override\n                public void modifySigningDictionary(PdfDictionary dic) {\n                    dic.put(PdfName.Filter, PdfName.Adobe_PPKLite);\n                    dic.put(PdfName.SubFilter, PdfName.ETSI_CAdES_DETACHED);\n                }\n            };\n\n            signer.signDeferred(signer.getDocument(), &quot;Signature1&quot;, new FileOutputStream(outputPdf), container);\n            System.out.println(&quot;QES Signature applied to: &quot; + outputPdf);\n\n        } catch (Exception e) {\n            System.err.println(&quot;Signing error: &quot; + e.getMessage());\n            e.printStackTrace();\n            System.exit(2);\n        }\n    }\n}\n\n\n\n</code></pre>\n<p>UPDATE3.0\nI'm using iText 7 (v7.2.5, AGPL version) and BouncyCastle (v1.74) to implement Qualified Electronic Signatures (QES) in Java. I generate the signature hash using signDeferred() and later receive a CMS signature from an external Trust Service Provider (Swisscom) which I then embed using signExternalContainer.</p>\n<p>Everything works fine, but I need to ensure the signing-time attribute is explicitly present in the CMS signature. Since I'm manually assembling the CMS structure via BouncyCastle before embedding it, I'm wondering:</p>\n<p>How can I add the signing-time attribute manually when using the signDeferred() method?</p>\n<p>Is there a clean way to inject signing-time using BouncyCastle (since SignerInformation.replaceSignedAttributes() is not available in v1.74)?</p>\n<p>Can this be done before embedding with signExternalContainer()?</p>\n<p>Dependencies:</p>\n<ul>\n<li><p>iText 7.2.5</p>\n</li>\n<li><p>BouncyCastle 1.74</p>\n</li>\n<li><p>Swisscom QES API (ETSI format)\n<img src=\"https://i.sstatic.net/AJFk3Kf8.png\" alt=\"enter image description here\" />\n<img src=\"https://i.sstatic.net/V0sqc31t.png\" alt=\"enter image description here\" />\n<a href=\"https://i.sstatic.net/Cbqd1JVr.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/Cbqd1JVr.png\" alt=\"enter image description here\" /></a>\n<a href=\"https://i.sstatic.net/82WuI2IT.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/82WuI2IT.png\" alt=\"enter image description here\" /></a></p>\n</li>\n</ul>\n<p>Everything else is green and valid.</p>\n<p>Any ideas or working examples would be deeply appreciated!</p>\n",
    "tags" : [ "java", "pdf", "itext", "digital-signature" ],
    "owner" : {
      "account_id" : 29768047,
      "reputation" : 21,
      "user_id" : 22813973,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
      "display_name" : "Igor Stajic",
      "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
    },
    "is_answered" : true,
    "view_count" : 120,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1745312936,
    "creation_date" : 1744005710,
    "link" : "https://stackoverflow.com/questions/79559170/hash-mismatch-before-qes-signing-with-swisscom-and-itext-7-hash-mismatch-exp",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79560411,
    "question_id" : 79559170,
    "body" : "<h2>Your original question</h2>\n<p>Here</p>\n<pre class=\"lang-java prettyprint-override\"><code>        // Compute SHA-256 hash of prepared PDF\n        MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);\n        try (InputStream is = new FileInputStream(outputPreparedPdf)) {\n            byte[] buffer = new byte[8192];\n            int bytesRead;\n            while ((bytesRead = is.read(buffer)) != -1) {\n                digest.update(buffer, 0, bytesRead);\n            }\n        }\n\n        String hashBase64 = Base64.getEncoder().encodeToString(digest.digest());\n</code></pre>\n<p>and here</p>\n<pre class=\"lang-java prettyprint-override\"><code>            byte[] fileBytes = Files.readAllBytes(Paths.get(inputPdf));\n            String actualHash = Base64.getEncoder().encodeToString(\n                    MessageDigest.getInstance(&quot;SHA-256&quot;).digest(fileBytes)\n            );\n            System.out.println(&quot;Java hash before signing: &quot; + actualHash);\n            System.out.println(&quot;Expected hash: &quot; + expectedHash);\n\n            if (!actualHash.equals(expectedHash)) {\n                throw new RuntimeException(&quot;Hash mismatch! Expected: &quot; + expectedHash + &quot;, Got: &quot; + actualHash);\n            }\n</code></pre>\n<p>you calculate the hash of the <em>whole</em> prepared file and use it.</p>\n<p>This is wrong, you have to calculate the hash of only the signed byte ranges. This essentially encompasses the whole file <em>except the place holder</em> for the signature container to embed with <code>signDeferred</code>.</p>\n<h2>Your updated question</h2>\n<h3>signDeferred</h3>\n<p>In comments you mention that you now have overcome the hash mismatch issue and that you now use <code>signDeferred</code>. You have updated the code in your question accordingly.</p>\n<p>There is one problem in your use of <code>signDeferred</code> in your posted code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>            PdfReader reader = new PdfReader(inputPdf);\n            PdfSigner signer = new PdfSigner(reader, new FileOutputStream(outputPdf), new StampingProperties().useAppendMode());\n\n            IExternalSignatureContainer container = new IExternalSignatureContainer() {\n                ...\n            };\n\n            signer.signDeferred(signer.getDocument(), &quot;Signature1&quot;, new FileOutputStream(outputPdf), container);\n</code></pre>\n<p><code>signDeferred</code> is a <strong>static</strong> <code>PdfSigner</code> method. Thus, you don't need a <code>PdfSigner</code> instance, the following should suffice:</p>\n<pre class=\"lang-java prettyprint-override\"><code>            PdfReader reader = new PdfReader(inputPdf);\n            PdfDocument pdfDocument = new PdfDocument(reader);\n\n            IExternalSignatureContainer container = new IExternalSignatureContainer() {\n                ...\n            };\n\n            signer.signDeferred(pdfDocument, &quot;Signature1&quot;, new FileOutputStream(outputPdf), container);\n</code></pre>\n<p>Your current code works more by accident: You open <em>two</em> <code>FileOutputStream</code> instances to your target file which means you could end up with a hodgepodge of the output of both in the result. Fortunately the second one truncates upon construction what the <code>signer</code> put into the first one at the start, and as you don't work with the <code>signer</code> later on, it doesn't output anything anymore thereafter. But this really isn't the intended workflow.</p>\n<h3>signing-time attribute</h3>\n<p>Furthermore, you say you still have an issue when validating your signature with eSig DSS, the validator complains about the signing-time attribute.</p>\n<p>You mention that you interpret the error message of the validator to mean that it misses that attribute</p>\n<blockquote>\n<p>the DSS validator is only missing the signing-time attribute</p>\n</blockquote>\n<p>and wonder</p>\n<blockquote>\n<p>How can I add the signing-time attribute manually when using the signDeferred() method?</p>\n</blockquote>\n<p>First of all, as the CMS signature container you embed in <code>signDeferred</code> is generated externally by <em>an external Trust Service Provider (Swisscom)</em>, you <strong>cannot</strong> add a signing-time attribute manually: The signing-time attribute is a <em>signed</em> attribute, so if you add it to the externally generated CMS container, you will invalidate it.</p>\n<p>But in your case the situation actually is different, you have found a signing-time attribute in the CMS containers. So I think your interpretation of the validation error message is wrong, the validator complains about the <em>existing</em> signing-time attribute.</p>\n<p>Indeed, if you validate your signed PDF with eSig DSS, it assumes you want to validate it as a PAdES BASELINE signature, and for PAdES BASELINE signatures the spec (ETSI EN 319142-1) <em><strong>forbids</strong></em> the presence of a signing-time attribute, cf. the &quot;SPO: signing-time attribute in CMS signature&quot; entry in &quot;Table 1: Requirements on the main attributes for PAdES baseline signatures&quot;.</p>\n<p>So what you actually need to do is ask your TSP Swisscom for an option to produce CMS signature containers for PAdES BASELINE signatures, i.e. in particular <em>without</em> a signing-time attribute.</p>\n",
    "score" : 3,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97003,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1744044594,
    "last_activity_date" : 1745312936,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79560411" : [ {
      "comment_id" : 140370581,
      "post_id" : 79560411,
      "body" : "I managed to fix it somehow using proper handling of ByteRange and checking it after any action on the PDF. Thank you for the help.",
      "score" : 0,
      "owner" : {
        "account_id" : 29768047,
        "reputation" : 21,
        "user_id" : 22813973,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
        "display_name" : "Igor Stajic",
        "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
      },
      "creation_date" : 1745614270,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140349486,
      "post_id" : 79560411,
      "body" : "I  added an image from the DSS report where it states that signing-time is not present, also posted a photo with attributes, not sure really why signDeferred() did not add them properly even if they are present in cms...",
      "score" : 0,
      "owner" : {
        "account_id" : 29768047,
        "reputation" : 21,
        "user_id" : 22813973,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
        "display_name" : "Igor Stajic",
        "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
      },
      "creation_date" : 1745021403,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140349435,
      "post_id" : 79560411,
      "body" : "I just wonder, it&#39;s dss really <i>missing</i> that attribute? Or is it complaining about its <i>presence</i>? A far as PAdES baseline signatures are concerned,  that attribute is forbidden,  the claimed signing time is expected is the signature dictionary.",
      "score" : 0,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97003,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1745018818,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140349405,
      "post_id" : 79560411,
      "body" : "It is there, but I&#39;m not sure why it&#39;s not applied when I use signDeffered. However, when I use signExternalContainer, it appears with a few additional attributes, but then a hash mismatch occurs. It seems that PrepareHash may not insert ByteRange properly. Any advice?",
      "score" : 0,
      "owner" : {
        "account_id" : 29768047,
        "reputation" : 21,
        "user_id" : 22813973,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
        "display_name" : "Igor Stajic",
        "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
      },
      "creation_date" : 1745017539,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140348434,
      "post_id" : 79560411,
      "body" : "The signing time attribute is - if present - a signed attribute in the cms container. To get it the service that creates the signature container must embed it.",
      "score" : 1,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97003,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1744991927,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140348203,
      "post_id" : 79560411,
      "body" : "I managed to overcome the hash mismatch issue by using signDeferred() instead of signExternalContainer. Everything works properly, and the DSS validator is only missing the signing-time attribute. How can I add the signing-time attribute manually when using the signDeferred() method? I posted the new version on my classes.",
      "score" : 0,
      "owner" : {
        "account_id" : 29768047,
        "reputation" : 21,
        "user_id" : 22813973,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
        "display_name" : "Igor Stajic",
        "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
      },
      "creation_date" : 1744986918,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140329707,
      "post_id" : 79560411,
      "body" : "<i>&quot;I need this ASAP&quot;</i> - I&#39;m afraid I&#39;m currently in the middle of my vacation and can only throw in a comment here or there.",
      "score" : 0,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97003,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1744542324,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140329687,
      "post_id" : 79560411,
      "body" : "<i>&quot;Could you clarify how to handle signed byte ranges, exclude the signature placeholder, and ensure the visual signature doesn’t affect the hash?&quot;</i> - Your <code>dummySigContainer</code> instances do calculate the hash values correctly. But as the visual signature is part of the signed data, it does affect the hash. Unless you create the appearance in a later incremental update which PDF viewers should  warn about.",
      "score" : 0,
      "owner" : {
        "account_id" : 1916831,
        "reputation" : 97003,
        "user_id" : 1729265,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
        "display_name" : "mkl",
        "link" : "https://stackoverflow.com/users/1729265/mkl"
      },
      "creation_date" : 1744541830,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140323656,
      "post_id" : 79560411,
      "body" : "Thank you for the help! I’m still facing hash mismatch issues. I prepared the PDF with a signature placeholder, computed the SHA-256 hash, and sent it to Swisscom. After receiving the SignatureObject.cms, I verified the hash and used signDeferred(). Could you clarify how to handle signed byte ranges, exclude the signature placeholder, and ensure the visual signature doesn’t affect the hash?  I posted a new version of the classes and some questions, please take a look.  Feel free to email me at igorstajic10@gmail.com to discuss this or if we can agree on paid assistance, as I need this ASAP.",
      "score" : 0,
      "owner" : {
        "account_id" : 29768047,
        "reputation" : 21,
        "user_id" : 22813973,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocLA8opsl_DED0Ee_aq8ZS-gaCh8eSUezRfDLNV6pXydCJM=k-s256",
        "display_name" : "Igor Stajic",
        "link" : "https://stackoverflow.com/users/22813973/igor-stajic"
      },
      "creation_date" : 1744360139,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}