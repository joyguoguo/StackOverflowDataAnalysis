{
  "question" : {
    "question_id" : 79613410,
    "title" : "Unauthorized 401 when i access /user/{id}/messages through graph api within delegated mode",
    "body" : "<p>I have meet big problem about read mail from my outlook account, it takes me about serval days, however still failed, somebody can help me?</p>\n<p>I am referring to this document：</p>\n<p><a href=\"https://learn.microsoft.com/en-us/graph/auth-v2-user?view=graph-rest-1.0&amp;tabs=http\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/en-us/graph/auth-v2-user?view=graph-rest-1.0&amp;tabs=http</a></p>\n<p><a href=\"https://i.sstatic.net/3KjdFzYl.png\" rel=\"nofollow noreferrer\">Api premission config</a></p>\n<p>Here is my code:</p>\n<p><strong>Step 1: (get code)</strong></p>\n<pre><code>https://login.microsoftonline.com/c4acbf1d-ea8c-4147-8bbf-23e6f48ffb3e/oauth2/v2.0/authorize?client_id=2b331fc4-2778-4ada-93c0-33cbbbeed6db&amp;response_type=code&amp;redirect_uri=http://localhost:8888/auth&amp;response_mode=query&amp;scope=offline_access%20User.Read%20Mail.Read%20Mail.ReadBasic&amp;state=test123\n</code></pre>\n<p>code is: 1.AcYAHb-sxIzqR0GLvyPm9I_7PsQfMyt4J9pKk8Azy7vu1tvpAADGAA.AgABBAIAAABVrSpeuWamRam2jAF1XRQEAwDs_wUA9P_7JtLMtdErg-aeUPnOQWCp.......</p>\n<p><strong>Step 2: (get token)</strong></p>\n<p><a href=\"https://i.sstatic.net/v8kR23bo.png\" rel=\"nofollow noreferrer\">Get token by http post</a></p>\n<p>Then i got token and refresh token, scope is correct</p>\n<p><strong>Step 3: (test get users)</strong></p>\n<p><a href=\"https://i.sstatic.net/IxbJfqjW.png\" rel=\"nofollow noreferrer\">Get user info http GET</a></p>\n<p>Yes, successfully get user info.</p>\n<p><strong>Step 4: (test get user mail messages)</strong></p>\n<p><a href=\"https://i.sstatic.net/3KgzXIXl.png\" rel=\"nofollow noreferrer\">Get user messages fail</a></p>\n<p>Unfortunately, it failed, i don't know why and how to fix it, please help, thanks.</p>\n<p>This is my request header:\n<a href=\"https://i.sstatic.net/gw8DgukI.png\" rel=\"nofollow noreferrer\">Req header snapshot</a></p>\n<hr />\n<p>While when i use another mode, Get access without a user, still have the same problem,\nOf course, I used another method to obtain the new token, which is valid because I have already obtained the user's ID. the doc: <a href=\"https://learn.microsoft.com/en-us/graph/auth-v2-service?tabs=http\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/en-us/graph/auth-v2-service?tabs=http</a></p>\n<pre><code>GET https://graph.microsoft.com/v1.0/users/9dfb85a5-b8bb-4e7d-8e05-a60d418ca16d/messages?$select=sender,subject\nAuthorization: Bearer ey.....TJxBtlAXdJARLAJP4KcQ9mnA\nUser-Agent: IntelliJ HTTP Client/IntelliJ IDEA 2024.2.1\nAccept-Encoding: br, deflate, gzip, x-gzip\nAccept: */*\ncontent-length: 0\n</code></pre>\n<p>Reponse:</p>\n<pre><code>HTTP/2 401 Unauthorized\ncache-control: private\nstrict-transport-security: max-age=31536000\nrequest-id: 7e3e5860-1bf0-4d7f-8701-c593b759f488\nclient-request-id: 7e3e5860-1bf0-4d7f-8701-c593b759f488\nx-ms-ags-diagnostic: {&quot;ServerInfo&quot;:{&quot;DataCenter&quot;:&quot;Korea     Central&quot;,&quot;Slice&quot;:&quot;E&quot;,&quot;Ring&quot;:&quot;4&quot;,&quot;ScaleUnit&quot;:&quot;003&quot;,&quot;RoleInstance&quot;:&quot;SE1PEPF0001058B&quot;}}\ndate: Fri, 09 May 2025 06:39:00 GMT\ncontent-length: 0\nx-http2-stream-id: 3\n\n&lt;Response body is empty&gt;\n\nResponse code: 401 (Unauthorized); Time: 1563ms (1 s 563 ms); Content length: 0 bytes (0 B)\n</code></pre>\n",
    "tags" : [ "java", "azure", "microsoft-graph-api", "msal", "outlook-api" ],
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "is_answered" : true,
    "view_count" : 212,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1746779133,
    "creation_date" : 1746757502,
    "link" : "https://stackoverflow.com/questions/79613410/unauthorized-401-when-i-access-user-id-messages-through-graph-api-within-dele",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79613746,
    "question_id" : 79613410,
    "body" : "<p>As you want to read messages from personal Microsoft account, make sure to create app registration with supported account type as 'Accounts in any organizational directory (any Microsoft Entra ID tenant – multitenant) and personal Microsoft accounts (e.g., Skype, Xbox)</p>\n<p>Initially, I created an app registration with the supported account type set to 'Accounts in any organizational directory (any Microsoft Entra ID tenant – multitenant) and personal Microsoft accounts (e.g., Skype, Xbox)'. I provided the redirect URI as <code>http://localhost:8888/auth</code>,\n<a href=\"https://i.sstatic.net/Cb1zONWr.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/Cb1zONWr.png\" alt=\"enter image description here\" /></a></p>\n<p>Granted below API permissions:</p>\n<p><a href=\"https://i.sstatic.net/WNM7gJwX.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/WNM7gJwX.png\" alt=\"enter image description here\" /></a></p>\n<p>Make sure to invite your outlook personal Microsoft account into azure</p>\n<p>After that, I generated the authorization code using the endpoint below, using 'common' instead of the tenant ID</p>\n<pre><code>https://login.microsoftonline.com/common/oauth2/v2.0/authorize?\nclient_id=&lt;Enter your client ID&gt;\n&amp;response_type=code\n&amp;redirect_uri=http://localhost:8888/auth\n&amp;response_mode=query\n&amp;scope=Mail.Read User.Read openid offline_access\n</code></pre>\n<p><a href=\"https://i.sstatic.net/f5GtcWI6.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/f5GtcWI6.png\" alt=\"enter image description here\" /></a></p>\n<p>After that, you will be prompted to sign in use your personal Microsoft Outlook account</p>\n<p><a href=\"https://i.sstatic.net/o5e3zpA4.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/o5e3zpA4.png\" alt=\"enter image description here\" /></a></p>\n<p>Then after, by using the endpoint below, you can generate an access token to fetch messages from your personal Microsoft Outlook account. Use <code>common</code> instead of <code>tenant ID</code>, and update the parameters in the body such as <code>client_id</code>, <code>scope</code>, <code>code</code>, <code>redirect_uri</code>, <code>grant_type</code>, and <code>client_secret</code>.</p>\n<pre><code>https://login.microsoftonline.com/common/oauth2/v2.0/token\n</code></pre>\n<p><a href=\"https://i.sstatic.net/BOKMT5lz.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/BOKMT5lz.png\" alt=\"enter image description here\" /></a></p>\n<p>To get the messages from a personal Microsoft account, use the endpoint below</p>\n<pre><code>https://graph.microsoft.com/v1.0/me/messages\n</code></pre>\n<p><strong>Response:</strong> I am able to fetch messages; the screenshot below is for your reference.</p>\n<p><a href=\"https://i.sstatic.net/LhCB3Mfd.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/LhCB3Mfd.png\" alt=\"enter image description here\" /></a></p>\n<p>And verified messages in my outlook as well</p>\n<p><a href=\"https://i.sstatic.net/I6zuVHWk.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/I6zuVHWk.png\" alt=\"enter image description here\" /></a></p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 40076437,
      "reputation" : 395,
      "user_id" : 29597264,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3298e42802a4814159b74e70ad420949?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mallikarjuna Vardham",
      "link" : "https://stackoverflow.com/users/29597264/mallikarjuna-vardham"
    },
    "creation_date" : 1746779133,
    "last_activity_date" : 1746779133,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140410172,
    "post_id" : 79613410,
    "body" : "Hi, did you mean i shoud use like this? POST <a href=\"https://login.microsoftonline.com/common/oauth2/v2.0/token\" rel=\"nofollow noreferrer\">login.microsoftonline.com/common/oauth2/v2.0/token</a> HTTP/1.1",
    "score" : 0,
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "creation_date" : 1746777466,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140410027,
    "post_id" : 79613410,
    "body" : "As you want to read messages from personal Microsoft account, make sure to create app registration with supported account type as &#39;Accounts in any organizational directory (any Microsoft Entra ID tenant – multitenant) and personal Microsoft accounts (e.g., Skype, Xbox)&#39; and use /common instead of tenantId to generate token.",
    "score" : 0,
    "owner" : {
      "account_id" : 40076437,
      "reputation" : 395,
      "user_id" : 29597264,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3298e42802a4814159b74e70ad420949?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Mallikarjuna Vardham",
      "link" : "https://stackoverflow.com/users/29597264/mallikarjuna-vardham"
    },
    "creation_date" : 1746774009,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140409989,
    "post_id" : 79613410,
    "body" : "Hello, yes, i have try this mode, however still the same error, i have edit post and paste new information, please help, thanks.",
    "score" : 0,
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "creation_date" : 1746773198,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140409801,
    "post_id" : 79613410,
    "body" : "you can&#39;t read emails of other users with delegated permissions. You need to use application permissions a <a href=\"https://learn.microsoft.com/graph/auth-v2-service\" rel=\"nofollow noreferrer\">get access without a user</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 2596604,
      "reputation" : 22146,
      "user_id" : 2250152,
      "user_type" : "registered",
      "accept_rate" : 72,
      "profile_image" : "https://www.gravatar.com/avatar/b65f1f44f70983a25ac998d1543f85e0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "martinm",
      "link" : "https://stackoverflow.com/users/2250152/martinm"
    },
    "creation_date" : 1746766761,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140409717,
    "post_id" : 79613410,
    "body" : "Thanks for your help, i have attach another snapshot for request headers, thanks.",
    "score" : 0,
    "owner" : {
      "account_id" : 2285518,
      "reputation" : 25,
      "user_id" : 2009576,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
      "display_name" : "Leo",
      "link" : "https://stackoverflow.com/users/2009576/leo"
    },
    "creation_date" : 1746762421,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140409702,
    "post_id" : 79613410,
    "body" : "Are you sure about that you&#39;ve already set the correct authorization? You&#39;d better show your request header in the tab <code>实际请求</code>. If the token&#39;s expired, it can also cause <code>401 error</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 14331879,
      "reputation" : 346,
      "user_id" : 10352428,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/619aa63a0625944a2aa2fd0fdacb95cb?s=256&d=identicon&r=PG",
      "display_name" : "萝莉w",
      "link" : "https://stackoverflow.com/users/10352428/%e8%90%9d%e8%8e%89w"
    },
    "creation_date" : 1746761884,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79613746" : [ {
      "comment_id" : 140412985,
      "post_id" : 79613746,
      "body" : "Can you help me solve another same problem? Thank you",
      "score" : 0,
      "owner" : {
        "account_id" : 2285518,
        "reputation" : 25,
        "user_id" : 2009576,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
        "display_name" : "Leo",
        "link" : "https://stackoverflow.com/users/2009576/leo"
      },
      "creation_date" : 1746857328,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140410426,
      "post_id" : 79613746,
      "body" : "Glad to know that it worked, please post a new question with details so that I can help you there",
      "score" : 0,
      "owner" : {
        "account_id" : 40076437,
        "reputation" : 395,
        "user_id" : 29597264,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/3298e42802a4814159b74e70ad420949?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Mallikarjuna Vardham",
        "link" : "https://stackoverflow.com/users/29597264/mallikarjuna-vardham"
      },
      "creation_date" : 1746783903,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140410309,
      "post_id" : 79613746,
      "body" : "Wow, great, thanks very much. I have another question. The/common part is not mentioned in the API documentation. How did you find it? Also, if I use this method, how can I update my token? The interface did not return a refresh token, and my program may be a daemon process in the background",
      "score" : 0,
      "owner" : {
        "account_id" : 2285518,
        "reputation" : 25,
        "user_id" : 2009576,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/99LeH.gif?s=256",
        "display_name" : "Leo",
        "link" : "https://stackoverflow.com/users/2009576/leo"
      },
      "creation_date" : 1746780979,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}