{
  "question" : {
    "question_id" : 79695066,
    "title" : "Aerospike Big Memory Usage",
    "body" : "<p>Im using Aerospike to store events from 2 Kafka Topics, on production, each of topic would be with 100-300k TPS;\nHowever, in dev environment, I only sampling around 40mio events each, so in total i would insert 80mio events to Aerospike</p>\n<p>In Aerospike, each events will go to separated Sets, imitating original topic; I know that for 1 record, the size will be roughly 64B for Primary Index and 850B for Data;</p>\n<p>Then, i set my config with several points</p>\n<pre><code>service {\n        proto-fd-max 40000\n        cluster-name cakery\n}\n\nnamespace bar {\n        replication-factor 1\n\n        # Enable nsup default expiration for namespace\n        # By default is 0, and no records with ttl &gt; 0 can be written\n        nsup-period 900\n\n        storage-engine device {\n                file /opt/aerospike/data/bar.dat\n                filesize 20G\n        }\n}\n</code></pre>\n<p>I also commented the namespace 'test', so practically i only use 'bar'</p>\n<p>Im using Aerospike 8 Community Edition</p>\n<p>My VM is around 16Core and 16GB RAM and using SSD, i believe this is not big deal because it is not in production nor i do performance test;</p>\n<p>Upon insertion, when the records is around 3-4mio each, i notice on 'top' command, that the memory used is 13GB;</p>\n<p>My confusion and my questions are:</p>\n<ol>\n<li>By stating storage-engine device, Aerospike should be automatically store index on memory and data on disk right?</li>\n<li>Therefore, the memory occupancy should around 2 sets * (64B * 4mio records) which is under 13GB;</li>\n<li>Stopping Aerospike server is not releasing the memory, only after i DELETED the .dat file, the memory goes back to buff/cache</li>\n</ol>\n<p>Why does this mechanism happens? How do i ended with much bigger resources that theoritically needed? And What configurations should i have if i want Index on Memory and Data on disk?</p>\n",
    "tags" : [ "java", "linux", "database", "aerospike" ],
    "owner" : {
      "account_id" : 543997,
      "reputation" : 352,
      "user_id" : 913297,
      "user_type" : "registered",
      "accept_rate" : 56,
      "profile_image" : "https://www.gravatar.com/avatar/9333e3c2233cde71f6e7c040761d5a5f?s=256&d=identicon&r=PG",
      "display_name" : "Lynx777",
      "link" : "https://stackoverflow.com/users/913297/lynx777"
    },
    "is_answered" : true,
    "view_count" : 123,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1752045938,
    "creation_date" : 1752034277,
    "link" : "https://stackoverflow.com/questions/79695066/aerospike-big-memory-usage",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79695107,
    "question_id" : 79695066,
    "body" : "<p>By default linux file write is cached in memory and then flushed to file, eventually. This is why I think you were getting back the memory after deleting the file. If the configuration parameter &quot;direct-files&quot; is set to &quot;true&quot;, the data is forced written down to the file. (ODSYNC and ODIRECT linux settings)  In your shown configuration, add it after the &quot;filesize 20G&quot; line. It should be in namespace context, and under &quot;storage-engine device&quot; sub-context. The parameter is documented here for usage details. <a href=\"https://aerospike.com/docs/database/reference/config#namespace__direct-files\" rel=\"nofollow noreferrer\">https://aerospike.com/docs/database/reference/config#namespace__direct-files</a>   Add this config param, set it to true, restart your node(s) (since it is a static parameter, it cannot be enforced dynamically).  Please retest and share your findings.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2163589,
      "reputation" : 5475,
      "user_id" : 1917187,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/115760c69c4f709ccf66ec14e08882b2?s=256&d=identicon&r=PG",
      "display_name" : "pgupta",
      "link" : "https://stackoverflow.com/users/1917187/pgupta"
    },
    "creation_date" : 1752038795,
    "last_activity_date" : 1752045938,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79695107" : [ {
      "comment_id" : 140575840,
      "post_id" : 79695107,
      "body" : "Oh ... looked at the link again, its documented under context namespace and sub-context &quot;storage-engine device&quot; ... so add it after &quot;filesize 20G&quot; ... Try that.",
      "score" : 0,
      "owner" : {
        "account_id" : 2163589,
        "reputation" : 5475,
        "user_id" : 1917187,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/115760c69c4f709ccf66ec14e08882b2?s=256&d=identicon&r=PG",
        "display_name" : "pgupta",
        "link" : "https://stackoverflow.com/users/1917187/pgupta"
      },
      "creation_date" : 1752044089,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140575798,
      "post_id" : 79695107,
      "body" : "read-page-cache is to cache the reads so if you read same record again, don&#39;t have to fetch from file. it will increase your memory consumption on reads. don&#39;t think that is relevant to your issue right now.",
      "score" : 0,
      "owner" : {
        "account_id" : 2163589,
        "reputation" : 5475,
        "user_id" : 1917187,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/115760c69c4f709ccf66ec14e08882b2?s=256&d=identicon&r=PG",
        "display_name" : "pgupta",
        "link" : "https://stackoverflow.com/users/1917187/pgupta"
      },
      "creation_date" : 1752043081,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140575786,
      "post_id" : 79695107,
      "body" : "I looked the link again. Does not say &quot;enterprise&quot; ... so should work with community edition.  That&#39;s weird.  Let me explain my thinking - since two other commentors are unhappy about me posting the link. By default linux file write is cached in memory and then flushed to file,eventually.  This is why I think you were getting back the memory after deleting the file.  If direct-files is set to true, the data is forced written down to the file. (ODSYNC and ODIRECT linux settings) Not sure why the config is not working for you.  The docs don&#39;t say removed in 8.0.",
      "score" : 0,
      "owner" : {
        "account_id" : 2163589,
        "reputation" : 5475,
        "user_id" : 1917187,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/115760c69c4f709ccf66ec14e08882b2?s=256&d=identicon&r=PG",
        "display_name" : "pgupta",
        "link" : "https://stackoverflow.com/users/1917187/pgupta"
      },
      "creation_date" : 1752042889,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140575776,
      "post_id" : 79695107,
      "body" : "I did, it is under the namespace, i also add &#39;read-page-cache true&#39; but still got uknown config error; It is weird because both are under no deprecated or removed tag; Perhaps im using community edition?",
      "score" : 0,
      "owner" : {
        "account_id" : 543997,
        "reputation" : 352,
        "user_id" : 913297,
        "user_type" : "registered",
        "accept_rate" : 56,
        "profile_image" : "https://www.gravatar.com/avatar/9333e3c2233cde71f6e7c040761d5a5f?s=256&d=identicon&r=PG",
        "display_name" : "Lynx777",
        "link" : "https://stackoverflow.com/users/913297/lynx777"
      },
      "creation_date" : 1752042574,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140575732,
      "post_id" : 79695107,
      "body" : "Did you add under &quot;namespace&quot; context? Like next line after &quot;replication-factor 1&quot; ..",
      "score" : 0,
      "owner" : {
        "account_id" : 2163589,
        "reputation" : 5475,
        "user_id" : 1917187,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/115760c69c4f709ccf66ec14e08882b2?s=256&d=identicon&r=PG",
        "display_name" : "pgupta",
        "link" : "https://stackoverflow.com/users/1917187/pgupta"
      },
      "creation_date" : 1752041655,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140575724,
      "post_id" : 79695107,
      "body" : "Got unknown config parameter name &#39;direct-files&#39;",
      "score" : 0,
      "owner" : {
        "account_id" : 543997,
        "reputation" : 352,
        "user_id" : 913297,
        "user_type" : "registered",
        "accept_rate" : 56,
        "profile_image" : "https://www.gravatar.com/avatar/9333e3c2233cde71f6e7c040761d5a5f?s=256&d=identicon&r=PG",
        "display_name" : "Lynx777",
        "link" : "https://stackoverflow.com/users/913297/lynx777"
      },
      "creation_date" : 1752041177,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}