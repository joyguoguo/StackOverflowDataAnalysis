{
  "question" : {
    "question_id" : 79681927,
    "title" : "Spring Boot and WAS Liberty Transaction manager - TransactionSuspensionNotSupportedException",
    "body" : "<p>I have deployed Spring Boot application on WAS Liberty. The application has JMS and JDBC operations that have to happen in same transaction. But part of the application needs new &quot;isolated&quot; transaction. I have added <code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code> annotation on the method but it throws <code>TransactionSuspensionNotSupportedException</code>.</p>\n<p>The following features are enabled in server.xml</p>\n<pre class=\"lang-xml prettyprint-override\"><code>  &lt;featureManager&gt;\n    &lt;feature&gt;localConnector-1.0&lt;/feature&gt;\n    &lt;feature&gt;servlet-6.0&lt;/feature&gt;\n    &lt;feature&gt;pages-3.1&lt;/feature&gt;\n    &lt;feature&gt;xmlBinding-4.0&lt;/feature&gt;\n    &lt;feature&gt;persistence-3.1&lt;/feature&gt;\n    &lt;feature&gt;messagingClient-3.0&lt;/feature&gt;\n    &lt;feature&gt;messagingServer-3.0&lt;/feature&gt;\n    &lt;feature&gt;appSecurity-5.0&lt;/feature&gt;\n    &lt;feature&gt;restConnector-2.0&lt;/feature&gt;\n  &lt;/featureManager&gt;\n</code></pre>\n<p>Any advice on how to enable transaction suspension or configure TransactionManager in Liberty is greatly appreciated.</p>\n<p>Versions:</p>\n<ul>\n<li>Java 21</li>\n<li>Spring boot 3.4.5</li>\n<li>WAS Liberty 23.0.0.9</li>\n</ul>\n<p>I tried adding .... but got the following error on startup <code>Caused by: javax.naming.NameNotFoundException: javax.naming.NameNotFoundException: java:comp/TransactionManager</code></p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Bean\n    public JtaTransactionManager transactionManager() throws Exception {\n        InitialContext context = new InitialContext();\n\n        UserTransaction utx = (UserTransaction) context.lookup(&quot;java:comp/UserTransaction&quot;);\n        TransactionManager tm = (TransactionManager) context.lookup(&quot;java:comp/TransactionManager&quot;);\n\n        return new JtaTransactionManager(utx, tm);\n    }\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "websphere-liberty" ],
    "owner" : {
      "account_id" : 42756205,
      "reputation" : 11,
      "user_id" : 30908754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c91a3ca4933520846050bb459d2703c7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Emma",
      "link" : "https://stackoverflow.com/users/30908754/emma"
    },
    "is_answered" : true,
    "view_count" : 168,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1751294945,
    "creation_date" : 1751026142,
    "link" : "https://stackoverflow.com/questions/79681927/spring-boot-and-was-liberty-transaction-manager-transactionsuspensionnotsuppor",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79684615,
    "question_id" : 79681927,
    "body" : "<p>I found a working solution. Liberty 23.x does not expose TransactionManager over JNDI, you need to use reflection to obtain TransactionManager.</p>\n<p>This bean definition helped me configure JtaTransactionManager.</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Bean\n    public JtaTransactionManager transactionManager() throws Exception {\n        InitialContext context = new InitialContext();\n\n        UserTransaction utx = (UserTransaction) context.lookup(&quot;java:comp/UserTransaction&quot;);\n\n        TransactionManager ibmTm = (TransactionManager) Class\n            .forName(&quot;com.ibm.tx.jta.TransactionManagerFactory&quot;)\n            .getDeclaredMethod(&quot;getTransactionManager&quot;)\n            .invoke(null);\n\n        return new JtaTransactionManager(utx, ibmTm);\n    }\n</code></pre>\n<p>I found the answer here:\n<a href=\"https://stackoverflow.com/a/79363034/30908754\">https://stackoverflow.com/a/79363034/30908754</a></p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 42756205,
      "reputation" : 11,
      "user_id" : 30908754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/c91a3ca4933520846050bb459d2703c7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Emma",
      "link" : "https://stackoverflow.com/users/30908754/emma"
    },
    "creation_date" : 1751278765,
    "last_activity_date" : 1751278925,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79682549,
    "question_id" : 79681927,
    "body" : "<h3>1. Enable JTA in Liberty:</h3>\n<p>For your specific problem <code>jta-2.0</code> is the minimal required addition. You could use one of convenience and umbrella Jakarta EE features like <code>webProfile-10.0</code> or <code>jakartaee-10.0</code>, which include <code>jta-2.0</code> specification along with many other related features:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;feature&gt;webProfile-10.0&lt;/feature&gt;\n</code></pre>\n<p>Clean up your <code>server.xml</code> and delete all your individual features which’re already included into <code>webProfile</code> feature:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;!--\n&lt;feature&gt;servlet-6.0&lt;/feature&gt;   &lt;!-- DELETE this individual feature --&gt;\n&lt;feature&gt;xmlBinding-4.0&lt;/feature&gt; &lt;!-- DELETE this individual feature --&gt;\n&lt;feature&gt;persistence-3.1&lt;/feature&gt; &lt;!-- DELETE this individual feature --&gt;\n--&gt;\n</code></pre>\n<p>Final version of your updated and less prone to conflicts <code>featureManager</code> configuration :</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;featureManager&gt;\n  &lt;feature&gt;webProfile-10.0&lt;/feature&gt;\n\n  &lt;feature&gt;localConnector-1.0&lt;/feature&gt;\n  &lt;feature&gt;pages-3.1&lt;/feature&gt; &lt;feature&gt;messagingClient-3.0&lt;/feature&gt;\n  &lt;feature&gt;messagingServer-3.0&lt;/feature&gt;\n  &lt;feature&gt;appSecurity-5.0&lt;/feature&gt;\n  &lt;feature&gt;restConnector-2.0&lt;/feature&gt;\n&lt;/featureManager&gt;\n</code></pre>\n<p>This version is cleaner and explicitly enables the set of technologies defined by Jakarta Web Profile, which guarantees the presence of a suspension-capable transaction manager. That's all you need. Now you can remove the manual bean definition from your Java configuration code. It solves the problem correctly, is intended design, robust, future-proof, simpler fix and requires zero custom code.</p>\n<h3>2. Completely remove manual <code>JtaTransactionManager</code> bean from your configuration class:</h3>\n<pre class=\"lang-java prettyprint-override\"><code>// DELETE THIS ENTIRE METHOD\n/*\n@Bean\npublic JtaTransactionManager transactionManager() throws Exception {\n    InitialContext context = new InitialContext();\n\n    UserTransaction utx = (UserTransaction) context.lookup(&quot;java:comp/UserTransaction&quot;);\n    TransactionManager tm = (TransactionManager) context.lookup(&quot;java:comp/TransactionManager&quot;);\n\n    return new JtaTransactionManager(utx, tm);\n}\n*/\n</code></pre>\n<p>This is a crucial step. Spring Boot is excellent at detecting its environment and can now find the bean automatically and robustly without any reflection and custom code. When it starts up inside Liberty and see JTA classes on the classpath which your configured features provides, its <code>JtaAutoConfiguration</code> will automatically detect and configure the correct <code>JtaTransactionManager</code> for you. It knows the specific, often proprietary ways to look up the Liberty Transaction Manager. Your manual bean definition relies on a standard JNDI name that Liberty doesn't use by default and it prevents(!) the smarter auto-configuration from running. Only by deleting your manual bean, you allow Spring Boot <code>JtaAutoConfiguration</code> to run. It'll find Liberty TransactionManager and create the exact same <code>JtaTransactionManager</code> bean for you, but it'll do so using the official supported and resilient to updates integration path.</p>\n<h3>UPD: Why manual configurating <code>JtaTransactionManager</code> is not professionally accepted way to solve this problem:</h3>\n<ul>\n<li><p><strong>Violation of encapsulation</strong>: you're bypassing the framework auto-configuration as a standard, supported mechanisms for integration  and reaching directly into the server's internal machinery.</p>\n</li>\n<li><p><strong>Brittleness</strong>: it's the biggest risk. You're binding your app to a proprietary, internal implementation class (<code>com.ibm.tx.jta.TransactionManagerFactory</code>). This class isn't part of a public, documented API. IBM provides no guarantee that this class will exist, remain in the same package, or have the same method signature in future versions of Liberty or even in the next fix pack. If they refactor their transaction code your application will break with a <code>ClassNotFoundException</code> or <code>NoSuchMethodException</code> on the next server update.The framework solution is better because it's part of Hibernate, a tested maintained library. If IBM ever changes its internal factory, Hibernate team will update <code>WebSphereLibertyJtaPlatform</code> and you'll get the fix by simply updating your Hibernate/Spring Boot version. If you keep your own reflection code you have to fix it yourself.</p>\n</li>\n<li><p><strong>Lack of portability</strong>: this code is now hard-coded to work only on WebSphere Liberty. It'll not work on Open Liberty (which has a different package structure), WildFly, WebLogic or any other application server. Spring is abstracting away these differences.</p>\n</li>\n<li><p><strong>Maintenance overhead</strong>: this code is not self-explanatory. Everyone'll see this reflection and have to spend time understanding why this &quot;hack&quot; was necessary. It introduces technical debt.</p>\n</li>\n</ul>\n<h3>Verification</h3>\n<ol>\n<li><p><strong>Check the Liberty logs (<code>messages.log</code>)</strong>: after restart of your Liberty server you should see a message indicating <code>webProfile-10.0</code> feature has started successfully.</p>\n</li>\n<li><p><strong>Check your Spring Boot application logs</strong>: During startup with logging for the <code>org.springframework.transaction</code> package set to <code>DEBUG</code> or <code>INFO</code>, you should see logs indicating that Spring has found and is using WebSphere JTA transaction manager:</p>\n<p><code>logging.level.org.springframework.transaction.jta=DEBUG</code></p>\n<p>The output will look something like this:</p>\n<pre><code>DEBUG o.s.t.j.JtaTransactionManager       : Using JTA TransactionManager: com.ibm.ws.transaction.services.TransactionManagerImpl@...\n</code></pre>\n</li>\n<li><p><strong>Re-run your test case</strong>: The method call annotated with <code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code> should now execute without throwing the <code>TransactionSuspensionNotSupportedException</code>.</p>\n</li>\n</ol>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1207862,
      "reputation" : 4210,
      "user_id" : 1177031,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
      "display_name" : "kapandron",
      "link" : "https://stackoverflow.com/users/1177031/kapandron"
    },
    "creation_date" : 1751063029,
    "last_activity_date" : 1751294945,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79684615" : [ {
      "comment_id" : 140553534,
      "post_id" : 79684615,
      "body" : "So by <b>deleting your manual bean you&#39;re NOT removing the reflection logic, you&#39;re just removing your redundant copy of it</b> and allowing the official, framework-managed version to do its job. The best code is often the code you don&#39;t have to write. The best code is often the code you don&#39;t have to write",
      "score" : 1,
      "owner" : {
        "account_id" : 1207862,
        "reputation" : 4210,
        "user_id" : 1177031,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
        "display_name" : "kapandron",
        "link" : "https://stackoverflow.com/users/1177031/kapandron"
      },
      "creation_date" : 1751295667,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140553531,
      "post_id" : 79684615,
      "body" : "Remove your reflection code and just let Spring Boot do its job. You don&#39;t need to write custom code where you can solve the problem by simply configuring the framework you are using correctly. Your reflection code is simply a manual re-implementation of the logic that already exists inside Hibernate framework, which Spring Boot automatically configures and already perform this logic for you internally",
      "score" : 0,
      "owner" : {
        "account_id" : 1207862,
        "reputation" : 4210,
        "user_id" : 1177031,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
        "display_name" : "kapandron",
        "link" : "https://stackoverflow.com/users/1177031/kapandron"
      },
      "creation_date" : 1751295628,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140553524,
      "post_id" : 79684615,
      "body" : "It solves the immediate problem but not the best practice and proper fix for a production system.  Brittle, non-portable, high maintenance. You may still get into a lot of trouble with this in the future. Instead this workaround with manually finding the TM using reflection, better configuring Liberty correctly and using embedded and powerful Spring Boot auto-configuration mechanism. It enables full-blown JTA TM implementation, properly supports transaction suspension and resumption, which&#39;s exactly what <code>Propagation.REQUIRES_NEW</code> needs. No any cons at all there. Check my update for the answer",
      "score" : 0,
      "owner" : {
        "account_id" : 1207862,
        "reputation" : 4210,
        "user_id" : 1177031,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
        "display_name" : "kapandron",
        "link" : "https://stackoverflow.com/users/1177031/kapandron"
      },
      "creation_date" : 1751295475,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140553511,
      "post_id" : 79684615,
      "body" : "Yes, <code>Liberty 23.x</code> does not expose <code>javax.transaction.TransactionManager</code> on a standard JNDI name like <code>java:comp&#47;TransactionManager</code>. But if it&#39;s not in JNDI, you do NOT have to use reflection yourself. Not in this case",
      "score" : 0,
      "owner" : {
        "account_id" : 1207862,
        "reputation" : 4210,
        "user_id" : 1177031,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
        "display_name" : "kapandron",
        "link" : "https://stackoverflow.com/users/1177031/kapandron"
      },
      "creation_date" : 1751295278,
      "content_license" : "CC BY-SA 4.0"
    } ],
    "79682549" : [ {
      "comment_id" : 140553508,
      "post_id" : 79682549,
      "body" : "@Emma Use <code>webProfile-10.0</code> feature provides JTA capability you need and simplify your configuration",
      "score" : 0,
      "owner" : {
        "account_id" : 1207862,
        "reputation" : 4210,
        "user_id" : 1177031,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
        "display_name" : "kapandron",
        "link" : "https://stackoverflow.com/users/1177031/kapandron"
      },
      "creation_date" : 1751295177,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140552492,
      "post_id" : 79682549,
      "body" : "Thank you for very in-depth answer! I tried what you suggested but Liberty can not find jta-2.0 feature. I checked feature support in docs and it is not listed there so I am a bit confused. <a href=\"https://www.ibm.com/docs/en/was-liberty/core?topic=management-liberty-features\" rel=\"nofollow noreferrer\">management-liberty-features</a> By looking at log I can indeed confirm that transaction suspension is not supported:  No JTA TransactionManager found: transaction suspension not available Using JTA platform [org.hibernate.engine.transaction.jta.platform.internal.WebS&zwnj;&#8203;phereLibertyJtaPlatf&zwnj;&#8203;orm]",
      "score" : 0,
      "owner" : {
        "account_id" : 42756205,
        "reputation" : 11,
        "user_id" : 30908754,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/c91a3ca4933520846050bb459d2703c7?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Emma",
        "link" : "https://stackoverflow.com/users/30908754/emma"
      },
      "creation_date" : 1751271906,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}