{
  "question" : {
    "question_id" : 79735922,
    "title" : "Post 2.5 versions of commons-io:commons-io crashes apps on Android devices lower than Android 8",
    "body" : "<p>This is related to <a href=\"https://stackoverflow.com/q/78321937/355456\">an earlier question regarding commons-io:commons-io</a>.</p>\n<p>Everything is fine if version 2.5 is used.</p>\n<pre><code>implementation 'commons-io:commons-io:2.5'\n</code></pre>\n<p>If I use any newer version, such as the latest version 2.20</p>\n<pre><code>implementation 'commons-io:commons-io:2.20'\n</code></pre>\n<p>The following crash happens on Android devices lower than Android 8:</p>\n<pre><code>java.lang.NoClassDefFoundError: Failed resolution of: [Ljava/nio/file/OpenOption;\n    at org.apache.commons.io.file.PathUtils.&lt;clinit&gt;(PathUtils.java:201)\n    at org.apache.commons.io.build.AbstractStreamBuilder.&lt;clinit&gt;(AbstractStreamBuilder.java:47)\n    at org.apache.commons.io.output.UnsynchronizedByteArrayOutputStream.builder(UnsynchronizedByteArrayOutputStream.java:101)\n    at org.apache.commons.io.IOUtils.toByteArray(IOUtils.java:2681)\n</code></pre>\n<p>It is caused by the following code:</p>\n<pre><code>InputStream stream\n...\nbyte[] foo = IOUtils.toByteArray(stream);\n</code></pre>\n<p>Desugaring is enabled:</p>\n<pre><code>coreLibraryDesugaringEnabled = false\n\ncoreLibraryDesugaring com.android.tools:desugar_jdk_libs:2.1.5\n</code></pre>\n<p><a href=\"https://stackoverflow.com/questions/78321937/is-it-possible-to-use-newer-versions-of-commons-io-for-older-android-devices?noredirect=1#comment138098201_78321937\">A comment suggests it is related to Java 8</a>.</p>\n<p>Could anyone offer a tip on its remedy?</p>\n",
    "tags" : [ "java", "android", "apache-commons-io" ],
    "owner" : {
      "account_id" : 145567,
      "reputation" : 18679,
      "user_id" : 355456,
      "user_type" : "registered",
      "accept_rate" : 70,
      "profile_image" : "https://www.gravatar.com/avatar/f4f63b1cbaf53262345fadcc4eac11ee?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Hong",
      "link" : "https://stackoverflow.com/users/355456/hong"
    },
    "is_answered" : true,
    "view_count" : 87,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1755251621,
    "creation_date" : 1755207472,
    "link" : "https://stackoverflow.com/questions/79735922/post-2-5-versions-of-commons-iocommons-io-crashes-apps-on-android-devices-lower",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79736254,
    "question_id" : 79735922,
    "body" : "<p>This is because the desugaring library you're using might not support desugaring the <code>java.nio</code> APIs - you would have to use the <code>com.android.tools:desugar_jdk_libs_nio</code> artifact instead:</p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>coreLibraryDesugaring(&quot;com.android.tools:desugar_jdk_libs_nio:2.1.5&quot;)\n</code></pre>\n<p>This <code>java.nio</code> desugaring library was <a href=\"https://github.com/google/desugar_jdk_libs/blob/master/CHANGELOG.md#version-200-2022-09-16\" rel=\"nofollow noreferrer\">first introduced in v2.0.0</a> and is <a href=\"https://developer.android.com/studio/write/java11-nio-support-table\" rel=\"nofollow noreferrer\">also mentioned in the Java 11+ desugaring documentation</a>:</p>\n<blockquote>\n<p><strong>Version 2.0.0 (2022-09-16)</strong></p>\n<ul>\n<li>Release based on JDK-11. Require AGP version 7.4.0-alpha10 or later (Android Studio 2022.1.1).</li>\n<li>Supports three different configurations <code>desugar_jdk_libs_minimal</code>, <code>desugar_jdk_libs</code> and <code>desugar_jdk_libs_nio</code>.\n<ul>\n<li><code>desugar_jdk_libs_minimal</code> limits desugaring to package <code>java.util.function</code> and class <code>java.util.Optional</code>.</li>\n<li><code>desugar_jdk_libs</code> desugars the same APIs as in version 1.1.x and 1.2.x.\n<code>desugar_jdk_libs_nio</code> includes desugaring of package <code>java.nio</code>.</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 9115426,
      "reputation" : 27200,
      "user_id" : 6782707,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/2425200c04f326a53ef0085b703369d6?s=256&d=identicon&r=PG",
      "display_name" : "Edric",
      "link" : "https://stackoverflow.com/users/6782707/edric"
    },
    "creation_date" : 1755247325,
    "last_activity_date" : 1755247325,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140667515,
    "post_id" : 79735922,
    "body" : "It works! Thank you. I changed com.android.tools:desugar_jdk_libs to com.android.tools:desugar_jdk_libs_nio, the crash was gone, then reverted it back to com.android.tools:desugar_jdk_libs again, and the crash was back, then com.android.tools:desugar_jdk_libs_nio again, the crash was gone again. It was done an Android 7 device. I will see if this works reliably on user devices. It may take one or two weeks. Could you turn your comment into an answer for me to accept?",
    "score" : 0,
    "owner" : {
      "account_id" : 145567,
      "reputation" : 18679,
      "user_id" : 355456,
      "user_type" : "registered",
      "accept_rate" : 70,
      "profile_image" : "https://www.gravatar.com/avatar/f4f63b1cbaf53262345fadcc4eac11ee?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Hong",
      "link" : "https://stackoverflow.com/users/355456/hong"
    },
    "creation_date" : 1755246715,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140667064,
    "post_id" : 79735922,
    "body" : "Could you try using the &quot;nio&quot; version as indicated in <a href=\"https://developer.android.com/studio/write/java11-nio-support-table#java-nio-customizations\" rel=\"nofollow noreferrer\">developer.android.com/studio/write/&hellip;</a>? (i.e. <code>com.android.tools:desugar_jdk_libs_nio</code> rather than <code>com.android.tools:desugar_jdk_libs</code>) This should provide desugaring support for the <code>java.nio</code> APIs on earlier versions of Android",
    "score" : 1,
    "owner" : {
      "account_id" : 9115426,
      "reputation" : 27200,
      "user_id" : 6782707,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://www.gravatar.com/avatar/2425200c04f326a53ef0085b703369d6?s=256&d=identicon&r=PG",
      "display_name" : "Edric",
      "link" : "https://stackoverflow.com/users/6782707/edric"
    },
    "creation_date" : 1755226406,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79736254" : [ {
      "comment_id" : 140855599,
      "post_id" : 79736254,
      "body" : "No crash reports related to this from user devices lower than Android 8 for the past three months since this was implemented, so this is definitely the solution.  Thank you again.",
      "score" : 0,
      "owner" : {
        "account_id" : 145567,
        "reputation" : 18679,
        "user_id" : 355456,
        "user_type" : "registered",
        "accept_rate" : 70,
        "profile_image" : "https://www.gravatar.com/avatar/f4f63b1cbaf53262345fadcc4eac11ee?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Hong",
        "link" : "https://stackoverflow.com/users/355456/hong"
      },
      "creation_date" : 1763210804,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}