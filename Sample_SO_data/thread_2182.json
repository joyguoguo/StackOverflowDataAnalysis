{
  "question" : {
    "question_id" : 79640384,
    "title" : "Spring JPA: &#39;Query requires transaction be in progress&#39; error despite @Transactional annotation",
    "body" : "<p>I'm building a Spring Boot <code>3.4.1</code> application using Spring Data JPA and PostgreSQL.\nI have a service method annotated with <code>@Transactional</code> that tries to update a Workflow entity using a pessimistic lock, but I'm consistently getting this error:</p>\n<pre><code>jakarta.persistence.TransactionRequiredException: Query requires transaction be in progress, but no transaction is known to be in progress\n</code></pre>\n<ul>\n<li><p>I'm using Spring's @Transactional at the method level.</p>\n</li>\n<li><p>The method calls a repository query with @Lock(LockModeType.PESSIMISTIC_WRITE).</p>\n</li>\n<li><p>The call is triggered from a listener class that processes AWS SQS messages.</p>\n</li>\n<li><p>The repository method looks like this:</p>\n<p>@Lock(LockModeType.PESSIMISTIC_WRITE)\n@Query(&quot;SELECT w FROM WorkflowEntity w WHERE w.id = :id&quot;)\nOptional findLockedById(@Param(&quot;id&quot;) UUID id);</p>\n</li>\n<li><p>The service method:</p>\n</li>\n</ul>\n<pre><code>    @Service\n    public class WorkflowService {\n    \n        @Transactional\n        public WorkflowEntity updateStep(UUID workflowId, ...) {\n            WorkflowEntity entity = workflowRepository.findLockedById(workflowId)\n                .orElseThrow(() -&gt; new EntityNotFoundException(...));\n            // update and save\n            return workflowRepository.save(entity);\n        }\n    }\n</code></pre>\n<p>Yet, at runtime, I get:</p>\n<pre><code>org.springframework.dao.InvalidDataAccessApiUsageException: Query requires transaction be in progress, but no transaction is known to be in progress\n        at org.springframework.orm.jpa.EntityManagerFactoryUtils.convertJpaAccessExceptionIfPossible(EntityManagerFactoryUtils.java:400) ~[spring-orm-6.2.1.jar:6.2.1]\n        at org.springframework.orm.jpa.vendor.HibernateJpaDialect.translateExceptionIfPossible(HibernateJpaDialect.java:246) ~[spring-orm-6.2.1.jar:6.2.1]\n        at org.springframework.orm.jpa.AbstractEntityManagerFactoryBean.translateExceptionIfPossible(AbstractEntityManagerFactoryBean.java:560) ~[spring-orm-6.2.1.jar:6.2.1]\n        at org.springframework.dao.support.ChainedPersistenceExceptionTranslator.translateExceptionIfPossible(ChainedPersistenceExceptionTranslator.java:61) ~[spring-tx-6.2.1.jar:6.2.1]\n        at org.springframework.dao.support.DataAccessUtils.translateIfNecessary(DataAccessUtils.java:343) ~[spring-tx-6.2.1.jar:6.2.1]\n        at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:160) ~[spring-tx-6.2.1.jar:6.2.1]\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$CrudMethodMetadataPopulatingMethodInterceptor.invoke(CrudMethodMetadataPostProcessor.java:136) ~[spring-data-jpa-3.4.1.jar:3.4.1]\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.aop.framework.JdkDynamicAopProxy.invoke(JdkDynamicAopProxy.java:223) ~[spring-aop-6.2.1.jar:6.2.1]\n        at jdk.proxy2/jdk.proxy2.$Proxy182.findLockedById(Unknown Source) ~[na:na]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowService.updateStep(WorkflowService.java:69) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowService.updateStep(WorkflowService.java:62) ~[classes/:na]\n        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103) ~[na:na]\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580) ~[na:na]\n        at org.springframework.aop.support.AopUtils.invokeJoinpointUsingReflection(AopUtils.java:359) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.aop.framework.CglibAopProxy$DynamicAdvisedInterceptor.intercept(CglibAopProxy.java:723) ~[spring-aop-6.2.1.jar:6.2.1]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowService$$SpringCGLIB$$0.updateStep(&lt;generated&gt;) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowManagerService.updateWorkflow(WorkflowManagerService.java:134) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowManagerService.updateWorkflow(WorkflowManagerService.java:104) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.services.WorkflowManagerService.onEndDicom2Nifti(WorkflowManagerService.java:204) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.sqs.Dicom2NiftiOutReceiver.processMessage(Dicom2NiftiOutReceiver.java:36) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.sqs.Dicom2NiftiOutReceiver.processMessage(Dicom2NiftiOutReceiver.java:10) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.sqs.AbstractSqsReceiver.listen(AbstractSqsReceiver.java:21) ~[classes/:na]\n        at com.predisurge.mysuite.microservices.myproject.sqs.Dicom2NiftiOutReceiver.listen(Dicom2NiftiOutReceiver.java:25) ~[classes/:na]\n        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103) ~[na:na]\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580) ~[na:na]\n        at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.doInvoke(InvocableHandlerMethod.java:169) ~[spring-messaging-6.2.1.jar:6.2.1]\n        at org.springframework.messaging.handler.invocation.InvocableHandlerMethod.invoke(InvocableHandlerMethod.java:119) ~[spring-messaging-6.2.1.jar:6.2.1]\n        at io.awspring.cloud.sqs.listener.adapter.AbstractMethodInvokingListenerAdapter.invokeHandler(AbstractMethodInvokingListenerAdapter.java:56) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.adapter.MessagingMessageListenerAdapter.onMessage(MessagingMessageListenerAdapter.java:41) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.AsyncComponentAdapters$BlockingMessageListenerAdapter.lambda$onMessage$0(AsyncComponentAdapters.java:208) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.AsyncComponentAdapters$AbstractThreadingComponentAdapter.runInSameThread(AsyncComponentAdapters.java:120) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.AsyncComponentAdapters$AbstractThreadingComponentAdapter.execute(AsyncComponentAdapters.java:111) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.AsyncComponentAdapters$BlockingMessageListenerAdapter.onMessage(AsyncComponentAdapters.java:208) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageListenerExecutionStage.process(MessageListenerExecutionStage.java:49) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$ComposingMessagePipelineStage.lambda$process$0(MessageProcessingPipelineBuilder.java:80) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at java.base/java.util.concurrent.CompletableFuture.uniComposeStage(CompletableFuture.java:1231) ~[na:na]\n        at java.base/java.util.concurrent.CompletableFuture.thenCompose(CompletableFuture.java:2385) ~[na:na]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$ComposingMessagePipelineStage.process(MessageProcessingPipelineBuilder.java:80) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$FutureComposingMessagePipelineStage.process(MessageProcessingPipelineBuilder.java:104) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$FutureComposingMessagePipelineStage.process(MessageProcessingPipelineBuilder.java:104) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$FutureComposingMessagePipelineStage.process(MessageProcessingPipelineBuilder.java:104) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.pipeline.MessageProcessingPipelineBuilder$FutureComposingMessagePipelineStage.process(MessageProcessingPipelineBuilder.java:104) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at io.awspring.cloud.sqs.listener.sink.AbstractMessageProcessingPipelineSink.lambda$execute$0(AbstractMessageProcessingPipelineSink.java:99) ~[spring-cloud-aws-sqs-3.3.0-RC1.jar:3.3.0-RC1]\n        at java.base/java.util.concurrent.CompletableFuture$AsyncSupply.run(CompletableFuture.java:1812) ~[na:na]\n        at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1144) ~[na:na]\n        at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:642) ~[na:na]\n        at java.base/java.lang.Thread.run(Thread.java:1575) ~[na:na]\nCaused by: jakarta.persistence.TransactionRequiredException: Query requires transaction be in progress, but no transaction is known to be in progress\n        at org.hibernate.internal.AbstractSharedSessionContract.prepareForQueryExecution(AbstractSharedSessionContract.java:528) ~[hibernate-core-6.6.4.Final.jar:6.6.4.Final]\n        at org.hibernate.query.spi.AbstractSelectionQuery.beforeQuery(AbstractSelectionQuery.java:171) ~[hibernate-core-6.6.4.Final.jar:6.6.4.Final]\n        at org.hibernate.query.spi.AbstractSelectionQuery.beforeQueryHandlingFetchProfiles(AbstractSelectionQuery.java:159) ~[hibernate-core-6.6.4.Final.jar:6.6.4.Final]\n        at org.hibernate.query.spi.AbstractSelectionQuery.list(AbstractSelectionQuery.java:140) ~[hibernate-core-6.6.4.Final.jar:6.6.4.Final]\n        at org.hibernate.query.spi.AbstractSelectionQuery.getSingleResult(AbstractSelectionQuery.java:275) ~[hibernate-core-6.6.4.Final.jar:6.6.4.Final]\n        at java.base/jdk.internal.reflect.DirectMethodHandleAccessor.invoke(DirectMethodHandleAccessor.java:103) ~[na:na]\n        at java.base/java.lang.reflect.Method.invoke(Method.java:580) ~[na:na]\n        at org.springframework.orm.jpa.SharedEntityManagerCreator$DeferredQueryInvocationHandler.invoke(SharedEntityManagerCreator.java:419) ~[spring-orm-6.2.1.jar:6.2.1]\n        at jdk.proxy2/jdk.proxy2.$Proxy214.getSingleResult(Unknown Source) ~[na:na]\n        at org.springframework.data.jpa.repository.query.JpaQueryExecution$SingleEntityExecution.doExecute(JpaQueryExecution.java:224) ~[spring-data-jpa-3.4.1.jar:3.4.1]\n        at org.springframework.data.jpa.repository.query.JpaQueryExecution.execute(JpaQueryExecution.java:93) ~[spring-data-jpa-3.4.1.jar:3.4.1]\n        at org.springframework.data.jpa.repository.query.AbstractJpaQuery.doExecute(AbstractJpaQuery.java:152) ~[spring-data-jpa-3.4.1.jar:3.4.1]\n        at org.springframework.data.jpa.repository.query.AbstractJpaQuery.execute(AbstractJpaQuery.java:140) ~[spring-data-jpa-3.4.1.jar:3.4.1]\n        at org.springframework.data.repository.core.support.RepositoryMethodInvoker.doInvoke(RepositoryMethodInvoker.java:170) ~[spring-data-commons-3.4.1.jar:3.4.1]\n        at org.springframework.data.repository.core.support.RepositoryMethodInvoker.invoke(RepositoryMethodInvoker.java:158) ~[spring-data-commons-3.4.1.jar:3.4.1]\n        at org.springframework.data.repository.core.support.QueryExecutorMethodInterceptor.doInvoke(QueryExecutorMethodInterceptor.java:170) ~[spring-data-commons-3.4.1.jar:3.4.1]\n        at org.springframework.data.repository.core.support.QueryExecutorMethodInterceptor.invoke(QueryExecutorMethodInterceptor.java:149) ~[spring-data-commons-3.4.1.jar:3.4.1]\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.data.projection.DefaultMethodInvokingMethodInterceptor.invoke(DefaultMethodInvokingMethodInterceptor.java:69) ~[spring-data-commons-3.4.1.jar:3.4.1]\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.transaction.interceptor.TransactionAspectSupport.invokeWithinTransaction(TransactionAspectSupport.java:380) ~[spring-tx-6.2.1.jar:6.2.1]\n        at org.springframework.transaction.interceptor.TransactionInterceptor.invoke(TransactionInterceptor.java:119) ~[spring-tx-6.2.1.jar:6.2.1]\n        at org.springframework.aop.framework.ReflectiveMethodInvocation.proceed(ReflectiveMethodInvocation.java:184) ~[spring-aop-6.2.1.jar:6.2.1]\n        at org.springframework.dao.support.PersistenceExceptionTranslationInterceptor.invoke(PersistenceExceptionTranslationInterceptor.java:138) ~[spring-tx-6.2.1.jar:6.2.1]\n        ... 43 common frames omitted\n</code></pre>\n",
    "tags" : [ "java", "spring", "hibernate", "concurrency", "transactions" ],
    "owner" : {
      "account_id" : 7285876,
      "reputation" : 729,
      "user_id" : 5553962,
      "user_type" : "registered",
      "accept_rate" : 38,
      "profile_image" : "https://www.gravatar.com/avatar/69c1666359e4faecb9ebdc7173dc5dc5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "El_Merendero",
      "link" : "https://stackoverflow.com/users/5553962/el-merendero"
    },
    "is_answered" : false,
    "view_count" : 295,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1760603289,
    "creation_date" : 1748345314,
    "link" : "https://stackoverflow.com/questions/79640384/spring-jpa-query-requires-transaction-be-in-progress-error-despite-transacti",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79643117,
    "question_id" : 79640384,
    "body" : "<p>As Alexandru suggested,</p>\n<p>The stack trace shows that another updateStep() method is used to enter WorkflowService, without @Transactional.</p>\n<p>And @Transactional annotations have never been working for local, inner-service calls, thus we get no transaction.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 209006,
      "reputation" : 47,
      "user_id" : 459816,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/aFb6S.jpg?s=256",
      "display_name" : "cheesus",
      "link" : "https://stackoverflow.com/users/459816/cheesus"
    },
    "creation_date" : 1748475002,
    "last_activity_date" : 1748475002,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79791934,
    "question_id" : 79640384,
    "body" : "<p>Try to check below steps to ensure Transaction is initiated properly</p>\n<p>1. Make sure proper propagation level is configured for your @Transactional method, which by default is Propogation.REQUIRED</p>\n<p>2. If method annotated with @Transactional is called within the same class, there is a chance the transaction doesn't get initiated, so you can move the method to separate Service class and check.</p>\n<p>3. If there is any exception thrown in the code flow before to the method execution, then transaction might not be initiated</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 44319639,
      "reputation" : 32,
      "user_id" : 31692030,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6e0828ef5d5b73747b3ad3e528290382?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sathya Priya",
      "link" : "https://stackoverflow.com/users/31692030/sathya-priya"
    },
    "creation_date" : 1760603289,
    "last_activity_date" : 1760603289,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140462313,
    "post_id" : 79640384,
    "body" : "The transactional method <code>updateStep</code> is being called by another method called <code>updateStep</code> within the same class and which doesn&#39;t have <code>@Transactional</code> annotation, right? Spring doesn&#39;t support this.",
    "score" : 1,
    "owner" : {
      "account_id" : 2714938,
      "reputation" : 6448,
      "user_id" : 2342529,
      "user_type" : "registered",
      "accept_rate" : 98,
      "profile_image" : "https://i.sstatic.net/SSkK4.jpg?s=256",
      "display_name" : "Alexandru Severin",
      "link" : "https://stackoverflow.com/users/2342529/alexandru-severin"
    },
    "creation_date" : 1748346007,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}