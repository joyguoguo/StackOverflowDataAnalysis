{
  "question" : {
    "question_id" : 79616486,
    "title" : "How to intercept a MongoRepository in spring-data-mongodb?",
    "body" : "<p>I use spring-data-mongodb in my project. I have some code like that:</p>\n<pre><code>@Repository\npublic interface NameRepository extends MongoRepository&lt;Name, String&gt; {\n  List&lt;Name&gt; findByStatus(String status);\n  Name findFirstById(String Id);\n  ......\n}\n</code></pre>\n<p>Now I need to conditionally add a same Criteria to these queries. For example, a query maybe need to add a Criteria about contry.<br />\nI want to intercept all find methods of NameRepository, and conditionally add a Criteria to the Query. How can I do that?</p>\n",
    "tags" : [ "java", "spring", "mongodb", "spring-data-mongodb" ],
    "owner" : {
      "account_id" : 28743558,
      "reputation" : 15,
      "user_id" : 22013203,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTteBaGkLYu9yTYYxUbeTHbIwWZX7C1PyWlfDyiQ=k-s256",
      "display_name" : "victorli",
      "link" : "https://stackoverflow.com/users/22013203/victorli"
    },
    "is_answered" : true,
    "view_count" : 92,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1746977166,
    "creation_date" : 1746966410,
    "link" : "https://stackoverflow.com/questions/79616486/how-to-intercept-a-mongorepository-in-spring-data-mongodb",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79616630,
    "question_id" : 79616486,
    "body" : "<p>To conditionally add a Criteria (i.e., filtering by country) to every find* method of your NameRepository, you cannot do it directly through the MongoRepository interface because Spring Data repositories do not provide any hooks to be able to alter the query criteria at runtime.</p>\n<p>You can achieve your goal using one of the two following approaches:</p>\n<h2>1- Custom Repository Implementation:</h2>\n<p>Spring Data MongoDB provides you with the possibility to extend your repository with custom implementations where you have full control over the query creation.</p>\n<p>Documention ----&gt; <a href=\"https://docs.spring.io/spring-data/mongodb/reference/repositories/custom-implementations.html\" rel=\"nofollow noreferrer\">https://docs.spring.io/spring-data/mongodb/reference/repositories/custom-implementations.html</a></p>\n<pre class=\"lang-java prettyprint-override\"><code>public interface NameRepositoryCustom {\n    List&lt;Name&gt; findByStatusWithCountry(String status, String country);\n    Name findFirstByIdWithCountry(String id, String country);\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public class NameRepositoryImpl implements NameRepositoryCustom {\n\n    @Autowired\n    private MongoTemplate mongoTemplate;\n\n    @Override\n    public List&lt;Name&gt; findByStatusWithCountry(String status, String country) {\n        Query query = new Query();\n        query.addCriteria(Criteria.where(&quot;status&quot;).is(status));\n        if (country != null) {\n            query.addCriteria(Criteria.where(&quot;country&quot;).is(country));\n        }\n        return mongoTemplate.find(query, Name.class);\n    }\n\n    @Override\n    public Name findFirstByIdWithCountry(String id, String country) {\n        Query query = new Query();\n        query.addCriteria(Criteria.where(&quot;id&quot;).is(id));\n        if (country != null) {\n            query.addCriteria(Criteria.where(&quot;country&quot;).is(country));\n        }\n        return mongoTemplate.findOne(query, Name.class);\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Repository\npublic interface NameRepository extends MongoRepository&lt;Name, String&gt;, NameRepositoryCustom {\n    // Original methods (optional)\n}\n</code></pre>\n<h2>2- Using a Service Class as a Repository with Custom Queries:</h2>\n<pre class=\"lang-java prettyprint-override\"><code>@Service\npublic class NameService {\n\n    @Autowired\n    private MongoTemplate mongoTemplate;\n\n    public List&lt;Name&gt; findByStatus(String status, String country) {\n        Query query = new Query(Criteria.where(&quot;status&quot;).is(status));\n\n        if (country != null) {\n            query.addCriteria(Criteria.where(&quot;country&quot;).is(country));\n        }\n\n        return mongoTemplate.find(query, Name.class);\n    }\n\n    public Name findFirstById(String id, String country) {\n        Query query = new Query(Criteria.where(&quot;id&quot;).is(id));\n\n        if (country != null) {\n            query.addCriteria(Criteria.where(&quot;country&quot;).is(country));\n        }\n\n        return mongoTemplate.findOne(query, Name.class);\n    }\n\n    // Add more methods as needed, each with a `country` parameter\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 18239208,
      "reputation" : 647,
      "user_id" : 13276541,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GgPsMth9rUGvp9lxK_Nky2OaBid5MNfuotaqiF9Bg=k-s256",
      "display_name" : "Ahmed Mera",
      "link" : "https://stackoverflow.com/users/13276541/ahmed-mera"
    },
    "creation_date" : 1746977166,
    "last_activity_date" : 1746977166,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79616630" : [ {
      "comment_id" : 140416948,
      "post_id" : 79616630,
      "body" : "You can try to use the AOP to intercept all find*",
      "score" : 0,
      "owner" : {
        "account_id" : 18239208,
        "reputation" : 647,
        "user_id" : 13276541,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GgPsMth9rUGvp9lxK_Nky2OaBid5MNfuotaqiF9Bg=k-s256",
        "display_name" : "Ahmed Mera",
        "link" : "https://stackoverflow.com/users/13276541/ahmed-mera"
      },
      "creation_date" : 1747035398,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140416456,
      "post_id" : 79616630,
      "body" : "This is a common change, we have a lot of find* methods that need to attach this logic. Rewriting all methods will change a lot of code.",
      "score" : 0,
      "owner" : {
        "account_id" : 28743558,
        "reputation" : 15,
        "user_id" : 22013203,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTteBaGkLYu9yTYYxUbeTHbIwWZX7C1PyWlfDyiQ=k-s256",
        "display_name" : "victorli",
        "link" : "https://stackoverflow.com/users/22013203/victorli"
      },
      "creation_date" : 1747016123,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140415694,
      "post_id" : 79616630,
      "body" : "Intercepting and overriding methods like &quot;findByStatus()&quot; on a &quot;MongoRepository&quot; isn&#39;t currently supported â€” you&#39;d have to redefine those methods or use custom methods.  The least obtrusive and easiest solution is to:  - Keep your MongoRepository for simple CRUD  - Add custom methods for filtered queries (like &quot;findByStatusWithCountry&quot;) using MongoTemplate",
      "score" : 0,
      "owner" : {
        "account_id" : 18239208,
        "reputation" : 647,
        "user_id" : 13276541,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14GgPsMth9rUGvp9lxK_Nky2OaBid5MNfuotaqiF9Bg=k-s256",
        "display_name" : "Ahmed Mera",
        "link" : "https://stackoverflow.com/users/13276541/ahmed-mera"
      },
      "creation_date" : 1746982953,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140415651,
      "post_id" : 79616630,
      "body" : "I think it is to interupt and not to rewrite sa whole new thing",
      "score" : 1,
      "owner" : {
        "account_id" : 1947573,
        "reputation" : 7023,
        "user_id" : 1752366,
        "user_type" : "registered",
        "accept_rate" : 54,
        "profile_image" : "https://i.sstatic.net/HoNYQ.jpg?s=256",
        "display_name" : "silentsudo",
        "link" : "https://stackoverflow.com/users/1752366/silentsudo"
      },
      "creation_date" : 1746981192,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}