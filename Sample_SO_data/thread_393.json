{
  "question" : {
    "question_id" : 79804241,
    "title" : "Netty writeAndFlush fails: io.netty.util.IllegalReferenceCountException: refCnt: 0",
    "body" : "<p>I am having a problem with netty writeAndFlush failing.  Specifically, <code>io.netty.util.IllegalReferenceCountException: refCnt: 0</code> is thrown.  Here is the stack trace:</p>\n<pre><code>12:49:04.062 [Timer-0] ERROR com.ltsllc.miranda.netty.OutboundHeartBeatHandler - heartbeat start failed\nio.netty.util.IllegalReferenceCountException: refCnt: 0\n    at io.netty.buffer.AbstractByteBuf.ensureAccessible(AbstractByteBuf.java:1480)\n    at io.netty.buffer.UnpooledHeapByteBuf.array(UnpooledHeapByteBuf.java:147)\n    at com.ltsllc.miranda.netty.ChannelOutboundMonitor.write(ChannelOutboundMonitor.java:44)\n    at io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:827)\n    at io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:752)\n    at com.ltsllc.miranda.netty.NullTerminatedOutboundFrame.write(NullTerminatedOutboundFrame.java:31)\n    at io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:827)\n    at io.netty.channel.AbstractChannelHandlerContext$WriteTask.run(AbstractChannelHandlerContext.java:1136)\n</code></pre>\n<p>Here is the method:</p>\n<pre><code>    public synchronized void sendHeartBeat() {\n        iterations++;\n\n        if (iterations % 100 == 0) {\n            System.gc();\n        }\n\n        if (channel == null || !channel.isOpen()) {\n            logger.error(&quot;null or closed channel&quot;);\n            return;\n        }\n\n        AlarmClock.getInstance().scheduleOnce(this, Alarms.HEART_BEAT,\n                Miranda.getProperties().getLongProperty(Miranda.PROPERTY_HEART_BEAT_INTERVAL));\n        if (Miranda.getProperties().getBooleanProperty(Miranda.PROPERTY_USE_HEARTBEATS)) {\n            if (System.currentTimeMillis() &gt;\n                    timeOfLastActivity + Miranda.getProperties().getLongProperty(Miranda.PROPERTY_HEART_BEAT_INTERVAL)) {\n                String message = Node.HEART_BEAT_START;\n                ByteBuf byteBuf = Unpooled.copiedBuffer(message.getBytes());\n\n                ChannelFuture future = channel.writeAndFlush(byteBuf);\n                long delay = Miranda.getProperties().getLongProperty(Miranda.PROPERTY_HEART_BEAT_TIMEOUT);\n                AlarmClock.getInstance().scheduleOnce(this, Alarms.HEART_BEAT_TIMEOUT, delay);\n                metTimeout = false;\n                try {\n                    future.await();\n                    if (!future.isSuccess()) {\n                        logger.error(&quot;heartbeat start failed&quot;);\n                        future.cause().printStackTrace();\n                    }\n                } catch (InterruptedException e) {\n                    throw new RuntimeException(e);\n                }\n\n            }\n        }\n</code></pre>\n<p>I am using netty 4.2.7.Final.</p>\n<p>I have used maven dependency tree to ensure that I am pulling in netty 4.2.7.Final</p>\n<p>There are no network issues because this is to the same machine: it doesn't go out on the wire.</p>\n<p>This isn't an encoding/decoding error - the message is well formed.</p>\n<p>This isn't a problem with excessive writes because I'm not making lots of writes.</p>\n<p>This isn't a problem with the channel being closed or inactive because I've checked those.</p>\n<p>I don't know if this is due to the EventLoop being terminated, how do you check?</p>\n<p>What can I try?</p>\n",
    "tags" : [ "java", "netty" ],
    "owner" : {
      "account_id" : 11187949,
      "reputation" : 191,
      "user_id" : 8209535,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/eb05194fa08382285f2ae57db5aa28b4?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Clark Hobbie",
      "link" : "https://stackoverflow.com/users/8209535/clark-hobbie"
    },
    "is_answered" : false,
    "view_count" : 69,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1761794149,
    "creation_date" : 1761773755,
    "link" : "https://stackoverflow.com/questions/79804241/netty-writeandflush-fails-io-netty-util-illegalreferencecountexception-refcnt",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}