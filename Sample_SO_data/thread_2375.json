{
  "question" : {
    "question_id" : 79624518,
    "title" : "Why doesn&#39;t Java Spring Data JPA return nested entities after creation in same request",
    "body" : "<p>I'm writing a Java spring boot/spring data REST application.</p>\n<p>I have an entity named <code>LabPanel</code>,\nand an entity named <code>LabResult</code>.</p>\n<p><code>LabPabel</code> contains a <code>@OneToMany</code> relationship with <code>LabResult</code>,\nso <code>LabResult.labPanelResults</code> is a <code>List&lt;LabResult&gt;</code>.</p>\n<p>I have a JPA <code>@Repository</code> interface for <code>LabPanel</code>, and a separate JPA <code>@Repository</code> interface for <code>LabResult</code>.</p>\n<p>I have a <code>@Service</code> named <code>LabPanelService</code>, within it is a method named <code>createLabPanel()</code> that lets you create a new <code>LabPanel</code>, and the list of <code>LabResult</code>s that it contains.</p>\n<p>The problem I'm having occurs when I make a request to <code>createLabPanel()</code>.</p>\n<p>In the method I create both the <code>LabPanel</code> and all the <code>LabResult</code>s, saving them to their respective repositories,\nthen it calls the <code>LabPanelRepository.getOne()</code> interface method to get the new <code>LabPanel</code> after I saved everything to return it to the user.</p>\n<p>The result returned to the user shows that the new <code>LabPanel</code> was created, but it shows the <code>LabResult.labPanelResults</code> property is an empty list.</p>\n<p>However, if the user then makes a new request to the <code>LabPanelService.getLabPanel</code> method, it then returns the new <code>LabPanel</code> with the <code>LabResult.labPanelResults</code> property populated with the new <code>LabResult</code>s.</p>\n<p>Since the subsequent request has the nested <code>LabResult</code>s, I suspect something is going wrong related to my transaction management, but I don't know what.</p>\n<p>I have annotated my <code>LabPanelService</code> methods with <code>@Transactional</code>, and I have annotated my application entry point class with <code>@EnableTransactionManagement</code>.</p>\n<p>My code is below (note: I am using Lombok to automatically generate my setters, getters, and constructor methods in my entity classes):</p>\n<h4>Application entry point</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootApplication\n@EnableTransactionManagement\npublic class PersonalHealthRecordWebappApplication {\n\n  public static void main(String[] args) {\n    SpringApplication.run(PersonalHealthRecordWebappApplication.class, args);\n  }\n}\n</code></pre>\n<h4>LabPanel (entity)</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity(name = &quot;lab_panel&quot;)\n@AllArgsConstructor\n@NoArgsConstructor\n@Getter\n@Setter\n@Builder\npublic class LabPanel {\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\n  private Long id;\n\n  ...\n\n  @OneToMany(mappedBy = &quot;labPanel&quot;, cascade = CascadeType.ALL, fetch = FetchType.EAGER)\n  private List&lt;LabResult&gt; labPanelResults;\n\n  @ManyToOne\n  @JoinColumn(name = &quot;patient_id&quot;)\n  private Patient patient;\n}\n</code></pre>\n<h4>LabResult (entity)</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity(name = &quot;lab_result&quot;)\n@AllArgsConstructor\n@NoArgsConstructor\n@Getter\n@Setter\n@Builder\npublic class LabResult {\n\n  @Id\n  @GeneratedValue(strategy = GenerationType.IDENTITY)\n  private Long id;\n\n  ...\n\n  @ManyToOne\n  @JoinColumn(name = &quot;lab_panel_id&quot;)\n  private LabPanel labPanel;\n\n  @ManyToOne\n  @JoinColumn(name = &quot;patient_id&quot;)\n  private Patient patient;\n}\n</code></pre>\n<h4>LabPanelRepository</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@Repository\npublic interface LabPanelRepository extends JpaRepository&lt;LabPanel, Long&gt; {\n  ...\n}\n</code></pre>\n<h4>LabResultRepository</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@Repository\npublic interface LabResultRepository extends JpaRepository&lt;LabResult, Long&gt; {\n  ...\n}\n</code></pre>\n<h4>LabPanelService</h4>\n<pre class=\"lang-java prettyprint-override\"><code>@Service\npublic class LabPanelService {\n\n  private final LabPanelRepository labPanelRepository;\n  private final LabResultRepository labResultRepository;\n\n  public LabPanelService(\n    LabPanelRepository labPanelRepository,\n    LabResultRepository labResultRepository\n  ) {\n    this.labPanelRepository = labPanelRepository;\n    this.labResultRepository = labResultRepository;\n  }\n\n  ...\n\n  @Transactional\n  public LabPanelDTO createLabPanel(\n    NewLabPanelRequestDTO newLabPanelRequestDTO\n  ) {\n    ...\n\n    LabPanel newLabPanel = LabPanel.builder()\n      .labPanelUuid(UUID.randomUUID())\n      .labPanelName(newLabPanelRequestDTO.getLabPanelName())\n      .labPanelDate(newLabPanelRequestDTO.labPanelDate)\n      .labPanelResults(new ArrayList&lt;&gt;())\n      .patient(patient)\n      .build();\n\n    LabPanel savedLabPanel = labPanelRepository.save(newLabPanel);\n\n    List&lt;LabResult&gt; newLabResultList = new ArrayList&lt;&gt;();\n\n    newLabPanelRequestDTO\n      .getLabResultsList()\n      .forEach(labResultRequestDTO -&gt; {\n        LabResult newLabResult = LabResult.builder()\n          ...\n          .patient(patient)\n          .labPanel(savedLabPanel)\n          .build();\n\n        newLabResultList.add(newLabResult);\n      });\n\n    labResultRepository.saveAll(newLabResultList);\n    labResultRepository.flush();\n\n    LabPanel updatedLabPanel = labPanelRepository.getOne(savedLabPanel.getId());\n\n    return ConvertDTOUtil.convertLabPanelToLabPanelDTO(updatedLabPanel);\n  }\n}\n</code></pre>\n<h3>UPDATE:</h3>\n<p>I ran the application with the logging set to TRACE, and it looks like, after it does the <code>.saveAll()</code> on the list of <code>LabResult</code>s to create those, it then executes the <code>.flush()</code>, then does the <code>.getOne()</code> to get the updated <code>LabPanel</code>.</p>\n<p>When it does that last step, it retrieves the <code>LabPanel</code> from the session cache instead of querying the database again. I'm not sure if this is what is causing the problem or not.</p>\n<p>I am including a section of the logs I have in TRACE mode. The logs I'm including start from right after the <code>labResultRepository.saveAll()</code> method finishes execution, and runs to the closing of the transaction at the end of the entire <code>createLabPanel()</code> method:</p>\n<pre><code>2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Completing transaction for [org.springframework.data.jpa.repository.support.SimpleJpaRepository.saveAll]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$DefaultCrudMethodMetadata@7c9932a2] for key [public abstract java.util.List org.springframework.data.jpa.repository.JpaRepository.saveAll(java.lang.Iterable)] from thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.b.f.s.DefaultListableBeanFactory     : Returning cached instance of singleton bean 'labPanelRepository'\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$DefaultCrudMethodMetadata@2258d8f8] for key [public abstract void org.springframework.data.jpa.repository.JpaRepository.flush()] to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] toryAnnotationTransactionAttributeSource : Adding transactional method 'org.springframework.data.jpa.repository.support.SimpleJpaRepository.flush' with attribute: PROPAGATION_REQUIRED,ISOLATION_DEFAULT\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.orm.jpa.EntityManagerHolder@301bf7a2] for key [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@15986dd5] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Found thread-bound EntityManager [SessionImpl(1407529646PersistenceContext[entityKeys=[EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabPanel#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#2], EntityKey[mh.michael.personal_health_record_webapp.model.UserRole#1], EntityKey[mh.michael.personal_health_record_webapp.model.Patient#1], EntityKey[mh.michael.personal_health_record_webapp.model.User#1]], collectionKeys=[CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.allergies#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labResults#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.immunizations#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.users#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.roles#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labPanels#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.patients#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.medications#1]]];ActionQueue[insertions=ExecutableList{size=0} updates=ExecutableList{size=0} deletions=ExecutableList{size=0} orphanRemovals=ExecutableList{size=0} collectionCreations=ExecutableList{size=0} collectionRemovals=ExecutableList{size=0} collectionUpdates=ExecutableList{size=0} collectionQueuedOps=ExecutableList{size=0} unresolvedInsertDependencies=null])] for JPA transaction\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@56ef3ef4] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Participating in existing transaction\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Getting transaction for [org.springframework.data.jpa.repository.support.SimpleJpaRepository.flush]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.orm.jpa.EntityManagerHolder@301bf7a2] for key [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@15986dd5] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Flushing session\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Processing flush-time cascades\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.Patient\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.allergies\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.allergies\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.immunizations\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.immunizations\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.labPanels\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.labPanels\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.labResults\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.labResults\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.medications\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.Patient.medications\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.Patient\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.User\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.User\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.UserRole\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.UserRole\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabPanel\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.LabPanel.labPanelResults\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done cascade ACTION_PERSIST_ON_FLUSH for collection: mh.michael.personal_health_record_webapp.model.LabPanel.labPanelResults\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabPanel\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabResult\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabResult\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabResult\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] org.hibernate.engine.internal.Cascade    : Done processing cascade ACTION_PERSIST_ON_FLUSH for: mh.michael.personal_health_record_webapp.model.LabResult\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Dirty checking collections\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Flushing entities and processing referenced collections\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.allergies#1], was: [mh.michael.personal_health_record_webapp.model.Patient.allergies#1] (uninitialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.immunizations#1], was: [mh.michael.personal_health_record_webapp.model.Patient.immunizations#1] (uninitialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.labPanels#1], was: [mh.michael.personal_health_record_webapp.model.Patient.labPanels#1] (uninitialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.labResults#1], was: [mh.michael.personal_health_record_webapp.model.Patient.labResults#1] (uninitialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.medications#1], was: [mh.michael.personal_health_record_webapp.model.Patient.medications#1] (uninitialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.Patient.users#1], was: [mh.michael.personal_health_record_webapp.model.Patient.users#1] (initialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.User.patients#1], was: [mh.michael.personal_health_record_webapp.model.User.patients#1] (initialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.User.roles#1], was: [mh.michael.personal_health_record_webapp.model.User.roles#1] (initialized)\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.engine.internal.Collections  : Collection found: [mh.michael.personal_health_record_webapp.model.LabPanel.labPanelResults#1], was: [&lt;unreferenced&gt;] (initialized)\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Processing unreferenced collections\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Scheduling collection removes/(re)creates/updates\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Flushed: 0 insertions, 0 updates, 0 deletions to 6 objects\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Flushed: 1 (re)creations, 0 updates, 0 removals to 9 collections\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : Listing entities:\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.LabResult{labResultValue=50, labResultProviderLocation=null, labResultReferenceRange=30-60, patient=mh.michael.personal_health_record_webapp.model.Patient#1, labResultProviderName=null, labResultName=White Count, labResultUuid=4ab1e1a8-68dd-40ef-ad63-57573054ebce, id=1, labResultNotes=null, labPanel=mh.michael.personal_health_record_webapp.model.LabPanel#1, labResultDate=Mon Jan 01 00:00:00 EST 1990}\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.LabPanel{labPanelResults=[], labPanelDate=Mon Jan 01 00:00:00 EST 1990, patient=mh.michael.personal_health_record_webapp.model.Patient#1, id=1, labPanelName=Complete Metabolic, labPanelUuid=1d364036-b3f1-42d8-8782-31398646a8e2}\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.LabResult{labResultValue=45, labResultProviderLocation=null, labResultReferenceRange=35-66, patient=mh.michael.personal_health_record_webapp.model.Patient#1, labResultProviderName=null, labResultName=Red Count, labResultUuid=237e8edc-a917-457c-a1db-7fc91b108f73, id=2, labResultNotes=null, labPanel=mh.michael.personal_health_record_webapp.model.LabPanel#1, labResultDate=Mon Jan 01 00:00:00 EST 1990}\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.UserRole{name=ROLE_USER, id=1}\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.Patient{allergies=&lt;uninitialized&gt;, patientName=Mike, patientUuid=793f5307-9895-47a3-9f84-02e832a75d8e, immunizations=&lt;uninitialized&gt;, medications=&lt;uninitialized&gt;, labResults=&lt;uninitialized&gt;, id=1, labPanels=&lt;uninitialized&gt;, users=[mh.michael.personal_health_record_webapp.model.User#1]}\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.hibernate.internal.util.EntityPrinter  : mh.michael.personal_health_record_webapp.model.User{password=$2a$10$L6lOJjiT4hpfnydFGo9X4.5G6q8Bk2kU59aDs6EKoweiOcj3Rv5t., patients=[mh.michael.personal_health_record_webapp.model.Patient#1], roles=[mh.michael.personal_health_record_webapp.model.UserRole#1], userUuid=55774c62-81a2-44dd-81f4-1ce3da2ed6a0, id=1, email=mhadjiosif@gmail.com, username=mhadjiosif}\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Executing flush\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.jdbc.internal.JdbcCoordinatorImpl  : Starting after statement execution processing [ON_CLOSE]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.i.AbstractFlushingEventListener    : Post flush\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Completing transaction for [org.springframework.data.jpa.repository.support.SimpleJpaRepository.flush]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$DefaultCrudMethodMetadata@2258d8f8] for key [public abstract void org.springframework.data.jpa.repository.JpaRepository.flush()] from thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.b.f.s.DefaultListableBeanFactory     : Returning cached instance of singleton bean 'labPanelRepository'\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Bound value [org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$DefaultCrudMethodMetadata@1e1bb812] for key [public abstract java.lang.Object org.springframework.data.jpa.repository.JpaRepository.getOne(java.lang.Object)] to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] toryAnnotationTransactionAttributeSource : Adding transactional method 'org.springframework.data.jpa.repository.support.SimpleJpaRepository.getOne' with attribute: PROPAGATION_REQUIRED,ISOLATION_DEFAULT,readOnly\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.orm.jpa.EntityManagerHolder@301bf7a2] for key [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@15986dd5] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Found thread-bound EntityManager [SessionImpl(1407529646PersistenceContext[entityKeys=[EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabPanel#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#2], EntityKey[mh.michael.personal_health_record_webapp.model.UserRole#1], EntityKey[mh.michael.personal_health_record_webapp.model.Patient#1], EntityKey[mh.michael.personal_health_record_webapp.model.User#1]], collectionKeys=[CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.allergies#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labResults#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.immunizations#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.users#1], CollectionKey[mh.michael.personal_health_record_webapp.model.LabPanel.labPanelResults#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.roles#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labPanels#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.patients#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.medications#1]]];ActionQueue[insertions=ExecutableList{size=0} updates=ExecutableList{size=0} deletions=ExecutableList{size=0} orphanRemovals=ExecutableList{size=0} collectionCreations=ExecutableList{size=0} collectionRemovals=ExecutableList{size=0} collectionUpdates=ExecutableList{size=0} collectionQueuedOps=ExecutableList{size=0} unresolvedInsertDependencies=null])] for JPA transaction\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.jdbc.datasource.ConnectionHolder@56ef3ef4] for key [HikariDataSource (HikariPool-1)] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Participating in existing transaction\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Getting transaction for [org.springframework.data.jpa.repository.support.SimpleJpaRepository.getOne]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Retrieved value [org.springframework.orm.jpa.EntityManagerHolder@301bf7a2] for key [org.springframework.orm.jpa.LocalContainerEntityManagerFactoryBean@15986dd5] bound to thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.internal.DefaultLoadEventListener  : Loading entity: [mh.michael.personal_health_record_webapp.model.LabPanel#1]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.h.e.internal.DefaultLoadEventListener  : Entity found in session cache\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Completing transaction for [org.springframework.data.jpa.repository.support.SimpleJpaRepository.getOne]\n2025-05-16 01:51:12.648 TRACE 23888 --- [nio-8080-exec-7] .s.t.s.TransactionSynchronizationManager : Removed value [org.springframework.data.jpa.repository.support.CrudMethodMetadataPostProcessor$DefaultCrudMethodMetadata@1e1bb812] for key [public abstract java.lang.Object org.springframework.data.jpa.repository.JpaRepository.getOne(java.lang.Object)] from thread [http-nio-8080-exec-7]\n2025-05-16 01:51:12.663 TRACE 23888 --- [nio-8080-exec-7] o.s.t.i.TransactionInterceptor           : Completing transaction for [mh.michael.personal_health_record_webapp.services.LabPanelService.createLabPanel]\n2025-05-16 01:51:12.664 TRACE 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Triggering beforeCommit synchronization\n2025-05-16 01:51:12.664 TRACE 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Triggering beforeCompletion synchronization\n2025-05-16 01:51:12.664 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Initiating transaction commit\n2025-05-16 01:51:12.664 DEBUG 23888 --- [nio-8080-exec-7] o.s.orm.jpa.JpaTransactionManager        : Committing JPA transaction on EntityManager [SessionImpl(1407529646PersistenceContext[entityKeys=[EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabPanel#1], EntityKey[mh.michael.personal_health_record_webapp.model.LabResult#2], EntityKey[mh.michael.personal_health_record_webapp.model.UserRole#1], EntityKey[mh.michael.personal_health_record_webapp.model.Patient#1], EntityKey[mh.michael.personal_health_record_webapp.model.User#1]], collectionKeys=[CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.allergies#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labResults#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.immunizations#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.users#1], CollectionKey[mh.michael.personal_health_record_webapp.model.LabPanel.labPanelResults#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.roles#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.labPanels#1], CollectionKey[mh.michael.personal_health_record_webapp.model.User.patients#1], CollectionKey[mh.michael.personal_health_record_webapp.model.Patient.medications#1]]];ActionQueue[insertions=ExecutableList{size=0} updates=ExecutableList{size=0} deletions=ExecutableList{size=0} orphanRemovals=ExecutableList{size=0} collectionCreations=ExecutableList{size=0} collectionRemovals=ExecutableList{size=0} collectionUpdates=ExecutableList{size=0} collectionQueuedOps=ExecutableList{size=0} unresolvedInsertDependencies=null])]\n2025-05-16 01:51:12.664 DEBUG 23888 --- [nio-8080-exec-7] o.h.e.t.internal.TransactionImpl         : committing\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-boot", "jpa", "transactions" ],
    "owner" : {
      "account_id" : 6647035,
      "reputation" : 43,
      "user_id" : 5130754,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d444e297c5b9d887a19272911b7c40ad?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "compumike08",
      "link" : "https://stackoverflow.com/users/5130754/compumike08"
    },
    "is_answered" : true,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1747377312,
    "creation_date" : 1747372457,
    "link" : "https://stackoverflow.com/questions/79624518/why-doesnt-java-spring-data-jpa-return-nested-entities-after-creation-in-same-r",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79624599,
    "question_id" : 79624518,
    "body" : "<p>Since you have Cascade all you shoud fill the list in LabPanel with the results and save only LabPanel. Give this a try:</p>\n<pre><code>    LabPanel newLabPanel = LabPanel.builder()\n            .labPanelUuid(UUID.randomUUID())\n            .labPanelName(newLabPanelRequestDTO.getLabPanelName())\n            .labPanelDate(newLabPanelRequestDTO.labPanelDate)\n            .patient(patient)\n            .build();\n\n    List&lt;LabResult&gt; newLabResultList = new ArrayList&lt;&gt;();\n\n    newLabPanelRequestDTO\n            .getLabResultsList()\n            .forEach(labResultRequestDTO -&gt; {\n                LabResult newLabResult = LabResult.builder()\n      ...\n      .patient(patient)\n                        .labPanel(newLabPanel)\n                        .build();\n\n                newLabResultList.add(newLabResult);\n            });\n\n    newLabPanel.setLabPanelResults(newLabResultList);\n\n    LabPanel savedLabPanel = labPanelRepository.save(newLabPanel);\n\n    labPanelRepository.flush();\n\n    LabPanel updatedLabPanel = labPanelRepository.getOne(savedLabPanel.getId());\n\n    return ConvertDTOUtil.convertLabPanelToLabPanelDTO(updatedLabPanel);\n</code></pre>\n<p>And there should be no need to read the updatedLabPanel again after saving...</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 8026267,
      "reputation" : 5044,
      "user_id" : 6053084,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/616306286f1da49445d0f5f944440c2d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Turo",
      "link" : "https://stackoverflow.com/users/6053084/turo"
    },
    "creation_date" : 1747376964,
    "last_activity_date" : 1747377312,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140433181,
    "post_id" : 79624518,
    "body" : "Also note, there should be no need to call  labPanelRepository.getOne. Just use the savedLabPanel instance, as it should be the &#39;entity&#39; instance read from the database during the save call anyway, with your changes merged into it.",
    "score" : 1,
    "owner" : {
      "account_id" : 231721,
      "reputation" : 21335,
      "user_id" : 496099,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/efa7510cf47d7bd79e80486246e7e39e?s=256&d=identicon&r=PG",
      "display_name" : "Chris",
      "link" : "https://stackoverflow.com/users/496099/chris"
    },
    "creation_date" : 1747412686,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140433156,
    "post_id" : 79624518,
    "body" : "The issue is your application is not maintaining your object to keep it in sync with what you are doing in the transaction. If labPanelResults isn&#39;t populated.. it is up to your application logic to populate it when you call save, so that your Entity represents what is going in the DB. This is a common mistake when dealing with bidirectional relationships, as users think they only need to update the owning side of the relationship, and then are left with stale cache data. It is more efficient to keep the cache up to date with a simple set call than to force a DB refresh all the time.",
    "score" : 0,
    "owner" : {
      "account_id" : 231721,
      "reputation" : 21335,
      "user_id" : 496099,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/efa7510cf47d7bd79e80486246e7e39e?s=256&d=identicon&r=PG",
      "display_name" : "Chris",
      "link" : "https://stackoverflow.com/users/496099/chris"
    },
    "creation_date" : 1747412334,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79624599" : [ {
      "comment_id" : 140434014,
      "post_id" : 79624599,
      "body" : "This worked! Thank you!",
      "score" : 0,
      "owner" : {
        "account_id" : 6647035,
        "reputation" : 43,
        "user_id" : 5130754,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d444e297c5b9d887a19272911b7c40ad?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "compumike08",
        "link" : "https://stackoverflow.com/users/5130754/compumike08"
      },
      "creation_date" : 1747432898,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}