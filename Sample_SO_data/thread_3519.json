{
  "question" : {
    "question_id" : 79543766,
    "title" : "Difference of behavior between JVM and Native builds in Quarkus",
    "body" : "<p>I'm trying to log CloudWatch metrics to stdout.\nI setup the relevant code, and when testing in <code>dev</code>, the logs are as expected.</p>\n<p>Here is the relevant code -</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class MetricsService {\n    MetricsLogger metricsLogger;\n\n    public MetricsService() {\n        var namespace = ConfigProvider.getConfig()\n                .getOptionalValue(&quot;aws.emf.namespace&quot;, String.class)\n                .orElse(&quot;OceanAnalytics&quot;);\n        this.metricsLogger = new MetricsLogger().setNamespace(namespace);\n    }\n}\n</code></pre>\n<p>I then proceed to build the images, one for JVM and one for Native. The amazon-lambda extension is being used. And I'm using the following commands\nFor jvm -</p>\n<pre><code>./mvnw clean package\n</code></pre>\n<p>For native -</p>\n<pre><code>./mvnw clean package -Dnative=true\n</code></pre>\n<p>When I run the app using the provide SAM template, the JVM one produces the expected logs.\nHowever, the Native one always logs an empty object as <code>{}</code>.</p>\n<p>I tried adding the <code>MetricsService</code> to <code>--initialize-at-run-time=my.package.MetricsService</code> for the Native Image build args, but to no success.</p>\n<p>Any ideas what may be going wrong? I really can't figure it out and it hurts observability a lot.</p>\n<p>My pom.xml</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;properties&gt;\n        &lt;compiler-plugin.version&gt;3.13.0&lt;/compiler-plugin.version&gt;\n        &lt;maven.compiler.release&gt;17&lt;/maven.compiler.release&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n        &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;\n        &lt;quarkus.platform.artifact-id&gt;quarkus-bom&lt;/quarkus.platform.artifact-id&gt;\n        &lt;quarkus.platform.group-id&gt;io.quarkus.platform&lt;/quarkus.platform.group-id&gt;\n        &lt;quarkus.platform.version&gt;3.18.3&lt;/quarkus.platform.version&gt;\n        &lt;aws.sdk.version&gt;2.29.45&lt;/aws.sdk.version&gt;\n        &lt;embedded.metrics.version&gt;4.2.0&lt;/embedded.metrics.version&gt;\n        &lt;lombok.version&gt;1.18.34&lt;/lombok.version&gt;\n        &lt;surefire-plugin.version&gt;3.5.2&lt;/surefire-plugin.version&gt;\n        &lt;skipITs&gt;true&lt;/skipITs&gt;\n    &lt;/properties&gt;\n\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;${quarkus.platform.group-id}&lt;/groupId&gt;\n                &lt;artifactId&gt;${quarkus.platform.artifact-id}&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n                &lt;artifactId&gt;bom&lt;/artifactId&gt;\n                &lt;version&gt;${aws.sdk.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-rest&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-amazon-lambda-rest&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-jackson&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-rest-jackson&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-hibernate-reactive-panache&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-reactive-pg-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-arc&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n            &lt;version&gt;${lombok.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n            &lt;artifactId&gt;secretsmanager&lt;/artifactId&gt;\n            &lt;exclusions&gt;\n                &lt;exclusion&gt;\n                    &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n                    &lt;artifactId&gt;apache-client&lt;/artifactId&gt;\n                &lt;/exclusion&gt;\n            &lt;/exclusions&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n            &lt;artifactId&gt;url-connection-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;software.amazon.cloudwatchlogs&lt;/groupId&gt;\n            &lt;artifactId&gt;aws-embedded-metrics&lt;/artifactId&gt;\n            &lt;version&gt;${embedded.metrics.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;${quarkus.platform.group-id}&lt;/groupId&gt;\n                &lt;artifactId&gt;quarkus-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;extensions&gt;true&lt;/extensions&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;build&lt;/goal&gt;\n                            &lt;goal&gt;generate-code&lt;/goal&gt;\n                            &lt;goal&gt;generate-code-tests&lt;/goal&gt;\n                            &lt;goal&gt;native-image-agent&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${compiler-plugin.version}&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;parameters&gt;true&lt;/parameters&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;systemPropertyVariables&gt;\n                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                    &lt;/systemPropertyVariables&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;integration-test&lt;/goal&gt;\n                            &lt;goal&gt;verify&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n                &lt;configuration&gt;\n                    &lt;systemPropertyVariables&gt;\n                        &lt;native.image.path&gt;${project.build.directory}/${project.build.finalName}-runner\n                        &lt;/native.image.path&gt;\n                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                    &lt;/systemPropertyVariables&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;com.diffplug.spotless&lt;/groupId&gt;\n                &lt;artifactId&gt;spotless-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;2.43.0&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;java&gt;\n                        &lt;palantirJavaFormat&gt;\n                            &lt;version&gt;2.39.0&lt;/version&gt;\n                            &lt;style&gt;PALANTIR&lt;/style&gt;\n                        &lt;/palantirJavaFormat&gt;\n                    &lt;/java&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n    &lt;profiles&gt;\n        &lt;profile&gt;\n            &lt;id&gt;native&lt;/id&gt;\n            &lt;activation&gt;\n                &lt;property&gt;\n                    &lt;name&gt;native&lt;/name&gt;\n                &lt;/property&gt;\n            &lt;/activation&gt;\n            &lt;properties&gt;\n                &lt;skipITs&gt;false&lt;/skipITs&gt;\n                &lt;quarkus.native.enabled&gt;true&lt;/quarkus.native.enabled&gt;\n            &lt;/properties&gt;\n        &lt;/profile&gt;\n    &lt;/profiles&gt;\n&lt;/project&gt;\n</code></pre>\n",
    "tags" : [ "java", "aws-lambda", "quarkus", "amazon-cloudwatch", "quarkus-native" ],
    "owner" : {
      "account_id" : 21795189,
      "reputation" : 31,
      "user_id" : 16336599,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJxToJIa5h-kYYZ8sOHU-QC_Fay9F9garu03d3HS=k-s256",
      "display_name" : "Karan Ahlawat",
      "link" : "https://stackoverflow.com/users/16336599/karan-ahlawat"
    },
    "is_answered" : false,
    "view_count" : 71,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1743347419,
    "creation_date" : 1743275257,
    "link" : "https://stackoverflow.com/questions/79543766/difference-of-behavior-between-jvm-and-native-builds-in-quarkus",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79544786,
    "question_id" : 79543766,
    "body" : "<p>To solve this problem, you need to create a <code>reflection-config.json</code> file which has the following content</p>\n<pre><code>[\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.RootNode&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.Metadata&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.MetricDefinition&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.Unit&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.StorageResolution&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.DimensionSet&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.EmptyMetricsFilter&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.MetricDirective&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.model.MetricsContext&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.serializers.InstantSerializer&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.serializers.UnitSerializer&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.serializers.StorageResolutionSerializer&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  },\n  {\n    &quot;name&quot;: &quot;software.amazon.cloudwatchlogs.emf.serializers.StorageResolutionFilter&quot;,\n    &quot;allDeclaredConstructors&quot;:true,\n    &quot;allPublicConstructors&quot;:true,\n    &quot;allDeclaredMethods&quot;:true,\n    &quot;allPublicMethods&quot;:true,\n    &quot;allDeclaredFields&quot;:true,\n    &quot;allPublicFields&quot;:true\n  }\n]\n</code></pre>\n<p>Basically, all the classes in <code>software.amazon.cloudwatchlogs.emf.model</code> and all the classes except the deserializers <code>software.amazon.cloudwatchlogs.emf.serializers</code></p>\n<p>Then, provide the argument <code>-H:ReflectionConfigurationFiles=reflection-config.json</code> to the native-image command line</p>\n<p>Answer courtesy of @dan1st</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 21795189,
      "reputation" : 31,
      "user_id" : 16336599,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJxToJIa5h-kYYZ8sOHU-QC_Fay9F9garu03d3HS=k-s256",
      "display_name" : "Karan Ahlawat",
      "link" : "https://stackoverflow.com/users/16336599/karan-ahlawat"
    },
    "creation_date" : 1743347419,
    "last_activity_date" : 1743347419,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140279477,
    "post_id" : 79543766,
    "body" : "Okay that worked. I&#39;ll create a proper answer crediting you.",
    "score" : 0,
    "owner" : {
      "account_id" : 21795189,
      "reputation" : 31,
      "user_id" : 16336599,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJxToJIa5h-kYYZ8sOHU-QC_Fay9F9garu03d3HS=k-s256",
      "display_name" : "Karan Ahlawat",
      "link" : "https://stackoverflow.com/users/16336599/karan-ahlawat"
    },
    "creation_date" : 1743347091,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140278714,
    "post_id" : 79543766,
    "body" : "Can you try registering the classes in <code>software.amazon.cloudwatchlogs.emf.model</code> (methods, declared fields and enum constants) for reflection? Specially <code>RootNode</code>, <code>Metadata</code>, <code>MetricDefinition</code>, <code>Unit</code> and <code>StorageResolution</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1743323337,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140278670,
    "post_id" : 79543766,
    "body" : "@dan1st Updated with pom",
    "score" : 0,
    "owner" : {
      "account_id" : 21795189,
      "reputation" : 31,
      "user_id" : 16336599,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJxToJIa5h-kYYZ8sOHU-QC_Fay9F9garu03d3HS=k-s256",
      "display_name" : "Karan Ahlawat",
      "link" : "https://stackoverflow.com/users/16336599/karan-ahlawat"
    },
    "creation_date" : 1743322022,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140278649,
    "post_id" : 79543766,
    "body" : "Can you show your pom.xml?",
    "score" : 0,
    "owner" : {
      "account_id" : 15064163,
      "reputation" : 17100,
      "user_id" : 10871900,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/720202b6e19abc330dcd92e6a1254562?s=256&d=identicon&r=PG",
      "display_name" : "dan1st",
      "link" : "https://stackoverflow.com/users/10871900/dan1st"
    },
    "creation_date" : 1743321332,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}