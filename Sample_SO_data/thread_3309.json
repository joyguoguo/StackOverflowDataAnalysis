{
  "question" : {
    "question_id" : 79557059,
    "title" : "Android Service Client to listen for Service Server response",
    "body" : "<p>I am trying to implement a Bounded Service and Client architecture in Android as an Echo Service where a service echoes out whatever the Client sends while appending a <code>echo.</code> prefix.</p>\n<p>I am able to get Client to send message to Service implementation. The only problem is to get the Service respond to a received message and send it back to Client and for the Client to receive the Service response message.</p>\n<p>I am using two different types of Message.what with one dedicating for Service and another for Client. A Runnable Thread in the Client to actively listen for message on the Client's Message.what for the Service response.</p>\n<p>AppService code:</p>\n<pre><code>public class AppService extends Service {\n    static Messenger mMessenger;\n    static final int MSG_SAY_HELLO_SERVER = 1;\n    static final int MSG_SAY_HELLO_CLIENT = 2;\n    static final String androidPackageName = &quot;com.example.test&quot;;\n    static final String className = &quot;com.example.test.service.AppService&quot;;\n\n    public AppService() {\n    }\n\n    @Override\n    public void onCreate() {\n        System.out.println(&quot;AppService :: onCreate() :: creating AppService ...&quot;);\n        super.onCreate();\n        sDataObserver = new MyContentProviderObserver(null);\n        getContentResolver().registerContentObserver(CONTENT_URI, true, sDataObserver);\n    }\n\n    @Override\n    public IBinder onBind(Intent intent) {\n        System.out.println(&quot;AppService :: onBind() :: binding started ...&quot;);\n        mMessenger = new Messenger(new IncomingHandler(this));\n        return mMessenger.getBinder();\n    }\n\n    static class IncomingHandler extends Handler {\n        private Context applicationContext;\n\n        IncomingHandler(Context context) {\n            applicationContext = context.getApplicationContext();\n        }\n\n        @Override\n        public void handleMessage(Message msg) {\n            switch (msg.what) {\n                case MSG_SAY_HELLO_SERVER:\n                    System.out.println(&quot;AppService :: handleMessage() :: handling a MSG_SAY_HELLO_SERVER message ...&quot;);\n                    Bundle b = msg.getData();\n                    String msgStrData = b.getString(&quot;msg&quot;);\n                    System.out.println(&quot;&lt;&lt;&lt; AppService :: msg: &quot; + msgStrData);\n                    String replyStr = &quot;echo.&quot; + msgStrData;\n                    b.putString(&quot;msg&quot;, replyStr);\n                    Message msgReply = Message.obtain(null, MSG_SAY_HELLO_CLIENT);\n                    msgReply.setData(b);\n                    try {\n                        mMessenger.send(msgReply);\n                    } catch (RemoteException e) {\n                        throw new RuntimeException(e);\n                    }\n                    break;\n                default:\n                    super.handleMessage(msg);\n            }\n        }\n    }\n}\n</code></pre>\n<p>Client's MainActivity:</p>\n<pre><code>public class MainActivity extends AppCompatActivity {\n    private Messenger mService = null;\n    private boolean bound;\n    public static final int MSG_SAY_HELLO_SERVER = 1;\n    static final int MSG_SAY_HELLO_CLIENT = 2;\n    private Button sendMsgBtn = null;\n    private TextView respLbl = null;\n    private Context myContext = null;\n    private Runnable bgMsgRunnable = null;\n    private Thread bgMsgProc = null;\n    static final String androidPackageName = &quot;com.example.test&quot;;\n    static final String className = &quot;com.example.test.service.AppService&quot;;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView(R.layout.activity_main);\n        myContext = this;\n        sendMsgBtn = findViewById(R.id.sendMsgBtn);\n        respLbl = findViewById(R.id.respLbl);\n        sendMsgBtn.setEnabled(false);\n        sendMsgBtn.setOnClickListener(new View.OnClickListener() {\n            @Override\n            public void onClick(View v) {\n                sayHello();\n            }\n        });\n        bgMsgRunnable = new RunnableListener();\n        bgMsgProc = new Thread(bgMsgRunnable);\n        bgMsgProc.start();\n    }\n\n    private ServiceConnection mConnection = new ServiceConnection() {\n        public void onServiceConnected(ComponentName className, IBinder service) {\n            mService = new Messenger(service);\n            bound = true;\n            sendMsgBtn.setEnabled(true);\n        }\n\n        public void onServiceDisconnected(ComponentName className) {\n            mService = null;\n            bound = false;\n            sendMsgBtn.setEnabled(false);\n        }\n    };\n\n    public void sayHello() {\n        if (!bound) return;\n        // Create and send a message to the service, using a supported 'what' value.\n        Bundle bundle = new Bundle();\n        bundle.putString(&quot;msg&quot;, &quot;helloworld&quot;);\n        Message msg = Message.obtain();\n        msg.what = MSG_SAY_HELLO_SERVER;\n        msg.setData(bundle);\n        try {\n            mService.send(msg);\n        } catch (RemoteException e) {\n            e.printStackTrace();\n        }\n    }\n\n    @Override\n    protected void onStart() {\n        super.onStart();\n        System.out.println(&quot;TestIPCApp :: onStart() :: starting ...&quot;);\n        // Bind to the service.\n        Intent i = new Intent();\n        i.setClassName(androidPackageName, className);\n        System.out.println(&quot;TestIPCApp :: onStart() :: binding service ...&quot;);\n        ComponentName c = myContext.startService(i);\n        if (c != null) {\n            if (bindService(i, mConnection, Context.BIND_AUTO_CREATE)) {\n                System.out.println(&quot;TestIPCApp :: onStart() :: bounded to service ...&quot;);\n            } else {\n                System.err.println(&quot;TestIPCApp :: onStart() :: FAILED binding to service ...&quot;);\n            }\n        } else {\n            System.err.println(&quot;TestIPCApp :: onStart() :: FAILED starting service ...&quot;);\n        }\n    }\n\n    @Override\n    protected void onStop() {\n        super.onStop();\n        System.out.println(&quot;TestIPCApp :: onStop() :: stopping ...&quot;);\n        // Unbind from the service.\n        if (bound) {\n            System.out.println(&quot;TestIPCApp :: onStop() :: unbinding service ...&quot;);\n            unbindService(mConnection);\n            bound = false;\n        }\n    }\n\n    class RunnableListener implements Runnable {\n\n        @Override\n        public void run() {\n            while(true) {\n                Message msg = Message.obtain(null, MSG_SAY_HELLO_CLIENT);\n                handleMessage(msg);\n            }\n        }\n\n        public void handleMessage(Message msg) {\n            if (msg != null) {\n                switch (msg.what) {\n                    case MSG_SAY_HELLO_CLIENT:\n                        Bundle b = msg.getData();\n                        String msgStrData = b.getString(&quot;msg&quot;);\n                        if (msgStrData != null) {\n                            System.out.println(&quot;TestIPCApp :: handleMessage() :: handling message ...&quot;);\n                            System.out.println(&quot;&lt;&lt;&lt; mg: &quot; + msgStrData);\n                        }\n                        break;\n                    default:\n                        break;\n                }\n            }\n        }\n    }\n}\n</code></pre>\n<p>activity_main.xml</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;\n&lt;androidx.constraintlayout.widget.ConstraintLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;\n    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;\n    xmlns:tools=&quot;http://schemas.android.com/tools&quot;\n    android:layout_width=&quot;match_parent&quot;\n    android:layout_height=&quot;match_parent&quot;\n    tools:context=&quot;.ui.MainActivity&quot;&gt;\n\n    &lt;Button\n        android:id=&quot;@+id/sendMsgBtn&quot;\n        android:layout_width=&quot;wrap_content&quot;\n        android:layout_height=&quot;wrap_content&quot;\n        android:layout_marginBottom=&quot;316dp&quot;\n        android:text=&quot;Send Message&quot;\n        app:layout_constraintBottom_toBottomOf=&quot;parent&quot;\n        app:layout_constraintEnd_toEndOf=&quot;parent&quot;\n        app:layout_constraintHorizontal_bias=&quot;0.498&quot;\n        app:layout_constraintStart_toStartOf=&quot;parent&quot; /&gt;\n\n    &lt;TextView\n        android:id=&quot;@+id/respLbl&quot;\n        android:layout_width=&quot;wrap_content&quot;\n        android:layout_height=&quot;wrap_content&quot;\n        android:layout_marginBottom=&quot;10dp&quot;\n        android:fontFamily=&quot;sans-serif-condensed-medium&quot;\n        android:text=&quot;Response ?&quot;\n        android:textSize=&quot;20sp&quot;\n        android:textStyle=&quot;bold&quot;\n        app:layout_constraintBottom_toTopOf=&quot;@+id/sendMsgBtn&quot;\n        app:layout_constraintEnd_toEndOf=&quot;parent&quot;\n        app:layout_constraintHorizontal_bias=&quot;0.498&quot;\n        app:layout_constraintStart_toStartOf=&quot;parent&quot;\n        app:layout_constraintTop_toTopOf=&quot;parent&quot;\n        app:layout_constraintVertical_bias=&quot;0.89&quot; /&gt;\n&lt;/androidx.constraintlayout.widget.ConstraintLayout&gt;\n</code></pre>\n<p>AppService service output:</p>\n<pre><code>2025-04-05 21:50:37.692 10774-10774 System.out              com.example.test.service.AppService  I  AppService :: handleMessage() :: handling a MSG_SAY_HELLO_SERVER message ...\n2025-04-05 21:50:37.693 10774-10774 System.out              com.example.test.service.AppService  I  &lt;&lt;&lt; AppService :: msg: helloworld\n2025-04-05 21:50:38.657 10774-10774 System.out              com.example.test.service.AppService  I  AppService :: handleMessage() :: handling a MSG_SAY_HELLO_SERVER message ...\n2025-04-05 21:50:38.658 10774-10774 System.out              com.example.test.service.AppService  I  &lt;&lt;&lt; AppService :: msg: helloworld\n2025-04-05 21:50:39.299 10774-10774 System.out              com.example.test.service.AppService  I  AppService :: handleMessage() :: handling a MSG_SAY_HELLO_SERVER message ...\n2025-04-05 21:50:39.299 10774-10774 System.out              com.example.test.service.AppService  I  &lt;&lt;&lt; AppService :: msg: helloworld\n</code></pre>\n<p>Client output:</p>\n<pre><code>2025-04-05 21:50:06.212 11174-11174 System.out              com.example.test.testipcapp            I  TestIPCApp :: onStart() :: starting ...\n2025-04-05 21:50:06.212 11174-11174 System.out              com.example.test.testipcapp            I  TestIPCApp :: onStart() :: binding service ...\n2025-04-05 21:50:06.220 11174-11174 System.out              com.example.test.testipcapp            I  TestIPCApp :: onStart() :: bounded to service ...\n</code></pre>\n<p>The Client is not able to pick up the Service's response messages.</p>\n",
    "tags" : [ "java", "android", "service", "ipc" ],
    "owner" : {
      "account_id" : 219520,
      "reputation" : 7590,
      "user_id" : 476467,
      "user_type" : "registered",
      "accept_rate" : 65,
      "profile_image" : "https://www.gravatar.com/avatar/1d89d873be4475838546988a4392d1cb?s=256&d=identicon&r=PG",
      "display_name" : "thotheolh",
      "link" : "https://stackoverflow.com/users/476467/thotheolh"
    },
    "is_answered" : false,
    "view_count" : 15,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743861393,
    "creation_date" : 1743861393,
    "link" : "https://stackoverflow.com/questions/79557059/android-service-client-to-listen-for-service-server-response",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}