{
  "question" : {
    "question_id" : 79630654,
    "title" : "Apache HTTP Client 5 throws java.security.AccessControlException, policy file is specified",
    "body" : "<p>I'm writing an OpenSearch plugin in Java, using the provided <a href=\"https://github.com/opensearch-project/opensearch-plugin-template-java\" rel=\"nofollow noreferrer\">template</a>.</p>\n<p>Except communication with OpenSearch Dashboards which works fine, I need to implement communication with external service. Currently, it runs locally at <code>localhost:18880</code> and is available (e.g. via Postman). I decided to use Apache Http Client for this purpose:</p>\n<pre class=\"lang-none prettyprint-override\"><code>dependencies {\n    implementation 'org.apache.httpcomponents.core5:httpcore5:5.3.1'\n    implementation 'org.apache.httpcomponents.core5:httpcore5-h2:5.3.1'\n    implementation 'org.apache.httpcomponents.client5:httpclient5:5.3.1'\n}\n</code></pre>\n<p>However when I try to call it inside my plugin:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public static ServiceResponse&lt;Boolean&gt; busy() throws Exception {\n    URI uri = new URIBuilder(&quot;localhost:18880&quot;)\n            .appendPath(&quot;busy&quot;)\n            .build();\n\n    try (CloseableHttpClient httpClient = HttpClients.createDefault()) {\n        HttpGet request = new HttpGet(uri);\n\n        try (ClassicHttpResponse response = httpClient.executeOpen(null, request, null)) {\n            // ... \n</code></pre>\n<p>I get <code>java.security.AccessControlException: access denied (&quot;java.net.SocketPermission&quot; &quot;127.0.0.1:18880&quot; &quot;connect,resolve&quot;)</code>. Full stack trace is:</p>\n<pre class=\"lang-none prettyprint-override\"><code>java.security.AccessControlException: access denied (&quot;java.net.SocketPermission&quot; &quot;127.0.0.1:18880&quot; &quot;connect,resolve&quot;)\n    at java.base/java.security.AccessControlContext.checkPermission(AccessControlContext.java:488) ~[?:?]\n    at java.base/java.security.AccessController.checkPermission(AccessController.java:1071) ~[?:?]\n    at java.base/java.lang.SecurityManager.checkPermission(SecurityManager.java:411) ~[?:?]\n    at java.base/java.lang.SecurityManager.checkConnect(SecurityManager.java:905) ~[?:?]\n    at java.base/java.net.Socket.connect(Socket.java:747) ~[?:?]\n    at org.apache.hc.client5.http.socket.PlainConnectionSocketFactory.lambda$connectSocket$0(PlainConnectionSocketFactory.java:91) ~[httpclient5-5.3.1.jar:5.3.1]\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:571) ~[?:?]\n    at org.apache.hc.client5.http.socket.PlainConnectionSocketFactory.connectSocket(PlainConnectionSocketFactory.java:90) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.socket.ConnectionSocketFactory.connectSocket(ConnectionSocketFactory.java:123) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.io.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:189) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.io.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:450) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.InternalExecRuntime.connectEndpoint(InternalExecRuntime.java:162) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.InternalExecRuntime.connectEndpoint(InternalExecRuntime.java:172) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ConnectExec.execute(ConnectExec.java:142) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ProtocolExec.execute(ProtocolExec.java:192) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.HttpRequestRetryExec.execute(HttpRequestRetryExec.java:113) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ContentCompressionExec.execute(ContentCompressionExec.java:152) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.RedirectExec.execute(RedirectExec.java:116) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.ExecChainElement.execute(ExecChainElement.java:51) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.InternalHttpClient.doExecute(InternalHttpClient.java:170) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:87) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.impl.classic.CloseableHttpClient.execute(CloseableHttpClient.java:55) ~[httpclient5-5.3.1.jar:5.3.1]\n    at org.apache.hc.client5.http.classic.HttpClient.executeOpen(HttpClient.java:183) ~[httpclient5-5.3.1.jar:5.3.1]\n    at at.risedev.mlbase.idp.ad.service.external.AnomalyDetectionService.busy(AnomalyDetectionService.java:423) ~[IdpAdOpenSearchPlugin-2.19.1.0-SNAPSHOT.jar:2.19.1.0-SNAPSHOT]\n    at at.risedev.mlbase.idp.ad.service.PollService.pollAdService(PollService.java:55) [IdpAdOpenSearchPlugin-2.19.1.0-SNAPSHOT.jar:2.19.1.0-SNAPSHOT]\n    at at.risedev.mlbase.idp.ad.rest.RestPollAdServiceAction.lambda$prepareRequest$0(RestPollAdServiceAction.java:69) [IdpAdOpenSearchPlugin-2.19.1.0-SNAPSHOT.jar:2.19.1.0-SNAPSHOT]\n    at org.opensearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:127) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.rest.RestController.dispatchRequest(RestController.java:381) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.rest.RestController.tryAllHandlers(RestController.java:467) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.rest.RestController.dispatchRequest(RestController.java:287) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.http.AbstractHttpServerTransport.dispatchRequest(AbstractHttpServerTransport.java:374) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.http.AbstractHttpServerTransport.handleIncomingRequest(AbstractHttpServerTransport.java:482) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.http.AbstractHttpServerTransport.incomingRequest(AbstractHttpServerTransport.java:357) [opensearch-2.19.1.jar:2.19.1]\n    at org.opensearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:56) [transport-netty4-client-2.19.1.jar:2.19.1]\n    at org.opensearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:42) [transport-netty4-client-2.19.1.jar:2.19.1]\n    at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:99) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at org.opensearch.http.netty4.Netty4HttpPipeliningHandler.channelRead(Netty4HttpPipeliningHandler.java:72) [transport-netty4-client-2.19.1.jar:2.19.1]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageCodec.channelRead(MessageToMessageCodec.java:120) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:346) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:318) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.timeout.IdleStateHandler.channelRead(IdleStateHandler.java:289) [netty-handler-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:442) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:107) [netty-codec-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:444) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:412) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1357) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:440) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:420) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:868) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:166) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:796) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:697) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:660) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:562) [netty-transport-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.util.concurrent.SingleThreadEventExecutor$4.run(SingleThreadEventExecutor.java:998) [netty-common-4.1.118.Final.jar:4.1.118.Final]\n    at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) [netty-common-4.1.118.Final.jar:4.1.118.Final]\n    at java.base/java.lang.Thread.run(Thread.java:1583) [?:?]\n</code></pre>\n<p>Which indicates exception is thrown from <code>httpClient.executeOpen()</code> method of code above.</p>\n<p>To run, I use <code>./gradlew run</code> which is defined in <code>build.gradle</code>:</p>\n<pre class=\"lang-none prettyprint-override\"><code>testClusters.integTest {\n    testDistribution = &quot;INTEG_TEST&quot;\n    \n    // This installs our plugin into the testClusters\n    plugin(project.tasks.bundlePlugin.archiveFile)\n}\n\nrun {\n    useCluster testClusters.integTest\n}\n</code></pre>\n<h3>1. I tried to disable SecurityManager in app</h3>\n<pre class=\"lang-none prettyprint-override\"><code>testClusters.integTest {\n    testDistribution = &quot;INTEG_TEST&quot;\n    systemProperty 'java.security.manager', 'false'\n\n    // This installs our plugin into the testClusters\n    plugin(project.tasks.bundlePlugin.archiveFile)\n}\n</code></pre>\n<p>But application fails to start:</p>\n<pre class=\"lang-none prettyprint-override\"><code>&gt; Task :run FAILED\nExec output and error:\n| Output for ./bin/opensearch-plugin:warning: no-jdk distributions that do not bundle a JDK are deprecated and will be removed in a future release\n| Error occurred during initialization of VM\n| java.lang.InternalError: Could not create SecurityManager\n|       at java.lang.System.initPhase3(java.base@21.0.6/System.java:2305)\n| Caused by: java.lang.ClassNotFoundException: false\n|       at jdk.internal.loader.BuiltinClassLoader.loadClass(java.base@21.0.6/BuiltinClassLoader.java:641)\n|       at jdk.internal.loader.ClassLoaders$AppClassLoader.loadClass(java.base@21.0.6/ClassLoaders.java:188)\n|       at java.lang.ClassLoader.loadClass(java.base@21.0.6/ClassLoader.java:526)\n|       at java.lang.Class.forName0(java.base@21.0.6/Native Method)\n|       at java.lang.Class.forName(java.base@21.0.6/Class.java:534)\n|       at java.lang.Class.forName(java.base@21.0.6/Class.java:513)\n|       at java.lang.System.initPhase3(java.base@21.0.6/System.java:2289)\n</code></pre>\n<p>I also tried other options (<code>disallow</code>, <code>null</code>, <code>default</code>, <code>&lt;empty string&gt;</code>) for <code>java.security.manager</code> with same result</p>\n<h3>2. I tried to extend security policy</h3>\n<pre class=\"lang-none prettyprint-override\"><code>testClusters.integTest {\n    testDistribution = &quot;INTEG_TEST&quot;\n    systemProperty 'java.security.policy', rootProject.file(&quot;src/main/resources/main.policy&quot;).absolutePath\n\n    // This installs our plugin into the testClusters\n    plugin(project.tasks.bundlePlugin.archiveFile)\n}\n</code></pre>\n<p>Full contents of <code>main.policy</code> file is:</p>\n<pre class=\"lang-none prettyprint-override\"><code>grant {\n    permission java.net.SocketPermission &quot;localhost:*&quot;, &quot;connect,resolve&quot;;\n}\n</code></pre>\n<p>I can verify in logs JVM options are passed correctly from logs when running <code>./gradlew run</code>:</p>\n<pre class=\"lang-none prettyprint-override\"><code>[2025-05-20T14:20:13.115313433Z] [BUILD] Starting OpenSearch process\n[2025-05-20T16:20:16,321][INFO ][o.o.n.Node               ] [integTest-0] version[2.19.1], pid[36612], build[zip/2e4741fb45d1b150aaeeadf66d41445b23ff5982/2025-02-27T01:16:47.726162386Z], OS[Linux/6.13.8-200.fc41.x86_64/amd64], JVM[Red Hat, Inc./OpenJDK 64-Bit Server VM/21.0.6/21.0.6+7]\n[2025-05-20T16:20:16,324][INFO ][o.o.n.Node               ] [integTest-0] JVM home [/usr/lib/jvm/java-21-openjdk]\n[2025-05-20T16:20:16,330][INFO ][o.o.n.Node               ] [integTest-0] JVM arguments [-Xshare:auto, -Dopensearch.networkaddress.cache.ttl=60, -Dopensearch.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -XX:+ShowCodeDetailsInExceptionMessages, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dio.netty.allocator.numDirectArenas=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.security.manager=allow, -Djava.locale.providers=SPI,COMPAT, -Xms1g, -Xmx1g, -XX:+UseG1GC, -XX:G1ReservePercent=25, -XX:InitiatingHeapOccupancyPercent=30, -Djava.io.tmpdir=/home/kaorise/Documents/work/idp-ad-opensearch-plugin/backend/build/testclusters/integTest-0/tmp, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=logs, -XX:ErrorFile=logs/hs_err_pid%p.log, -Xlog:gc*,gc+age=trace,safepoint:file=logs/gc.log:utctime,pid,tags:filecount=32,filesize=64m, -Djava.security.manager=allow, --add-modules=jdk.incubator.vector, -Djava.util.concurrent.ForkJoinPool.common.threadFactory=org.opensearch.secure_sm.SecuredForkJoinWorkerThreadFactory, -Xms512m, -Xmx512m, -ea, -esa, -Djava.security.policy=/home/kaorise/Documents/work/idp-ad-opensearch-plugin/backend/src/main/resources/main.policy, -Djava.security.manager=allow, -XX:MaxDirectMemorySize=268435456, -Dopensearch.path.home=/home/kaorise/Documents/work/idp-ad-opensearch-plugin/backend/build/testclusters/integTest-0/distro/2.19.1-INTEG_TEST, -Dopensearch.path.conf=/home/kaorise/Documents/work/idp-ad-opensearch-plugin/backend/build/testclusters/integTest-0/config, -Dopensearch.distribution.type=zip, -Dopensearch.bundled_jdk=false]\n</code></pre>\n<p>JVM args contain both of my specified arguments. However issue persists</p>\n<p>What is proper way to configure policies for opensearch plugin. It seems like my policy file is ignored. Or is issue in something else?</p>\n",
    "tags" : [ "java", "opensearch", "apache-httpclient-5.x", "java-security-manager", "javapolicy" ],
    "owner" : {
      "account_id" : 16123119,
      "reputation" : 92,
      "user_id" : 11638603,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TNKZTFbhk3w/AAAAAAAAAAI/AAAAAAAAAE4/MGkKHbrckks/s256-rj/photo.jpg",
      "display_name" : "Some_ Person",
      "link" : "https://stackoverflow.com/users/11638603/some-person"
    },
    "is_answered" : true,
    "view_count" : 186,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1748083248,
    "creation_date" : 1747751372,
    "link" : "https://stackoverflow.com/questions/79630654/apache-http-client-5-throws-java-security-accesscontrolexception-policy-file-is",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79632296,
    "question_id" : 79630654,
    "body" : "<p>Migrating my plugin to OpenSearch version 3.0.0 did not resolve issue automatically, but helped me to debug it due to improved logging.</p>\n<p>New logs include lines:</p>\n<pre class=\"lang-none prettyprint-override\"><code>...\n[2025-05-21T17:02:12,142][WARN ][stderr] [integTest-0] java.security.policy: error parsing file:/home/.../plugin/backend/src/main/resources/main.policy:\n[2025-05-21T17:02:12,145][WARN ][stderr] [integTest-0]  expected [;], read [end of file]\n...\n</code></pre>\n<p>Which confirmed the fact that <code>main.policy</code> file located at <code>src/main/resources/</code> is discovered but fails to parse. The logs indicated that the problem was in missing semicolon in policy file. Correct version is:</p>\n<pre class=\"lang-none prettyprint-override\"><code>grant {\n    permission java.net.SocketPermission &quot;localhost:*&quot;, &quot;connect,resolve&quot;;\n};\n</code></pre>\n<p>with semicolon after parentheses.</p>\n<h4>To recap</h4>\n<ol>\n<li><p>As mentioned by @user207421, specifying <code>.policy</code> in gradlew build wouldn't work because policy from <code>src</code> is not included in build and won't work with plugin loaded as jar into existing OpenSearch instance. By inspecting other plugins like <a href=\"https://github.com/opensearch-project/anomaly-detection/tree/main/src/main/plugin-metadata\" rel=\"nofollow noreferrer\">Anomaly Detection plugin</a>, it is seen that <code>plugin-security.policy</code> should be created at <code>src/main/plugin-metadata</code>. Specifying policy that way works without any other modifications to <code>gradlew.build</code> or JVM environment. I verified that <code>plugin-metadata</code> is included to runtime, and tested on non-local environment.</p>\n</li>\n<li><p>Ensure syntax of <code>.policy</code> file is correct</p>\n<pre class=\"lang-none prettyprint-override\"><code>grant {\n    permission java.net.SocketPermission &quot;localhost:*&quot;, &quot;connect,resolve&quot;;\n};\n</code></pre>\n</li>\n</ol>\n<p>Thanks to all who commented, your comments helped me to debug and locate the issue</p>\n",
    "score" : -1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 16123119,
      "reputation" : 92,
      "user_id" : 11638603,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TNKZTFbhk3w/AAAAAAAAAAI/AAAAAAAAAE4/MGkKHbrckks/s256-rj/photo.jpg",
      "display_name" : "Some_ Person",
      "link" : "https://stackoverflow.com/users/11638603/some-person"
    },
    "creation_date" : 1747840702,
    "last_activity_date" : 1748083248,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140444490,
    "post_id" : 79630654,
    "body" : "(1) The <code>src</code> directory isn&#39;t there at runtime. You need to mention a file that will actually be deployed, or at least give it its correct runtime name. (2) Run your program with <code>-Djava.security.debug=access,failure</code> to see what actual policy files are loaded.",
    "score" : 1,
    "owner" : {
      "account_id" : 71739,
      "reputation" : 311869,
      "user_id" : 207421,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=256&d=identicon&r=PG",
      "display_name" : "user207421",
      "link" : "https://stackoverflow.com/users/207421/user207421"
    },
    "creation_date" : 1747786756,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140443356,
    "post_id" : 79630654,
    "body" : "You need to check what that <code>.&#47;bin&#47;opensearch-plugin</code> does. I guess that is what specifies the security manager config,",
    "score" : 1,
    "owner" : {
      "account_id" : 213468,
      "reputation" : 110282,
      "user_id" : 466862,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d873f397779db38cd510d9ee5416fd43?s=256&d=identicon&r=PG",
      "display_name" : "Mark Rotteveel",
      "link" : "https://stackoverflow.com/users/466862/mark-rotteveel"
    },
    "creation_date" : 1747757120,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140443145,
    "post_id" : 79630654,
    "body" : "I edited the question with all the options I have tried for <code>java.security.manager</code>, I&#39;m sorry for the confustion",
    "score" : 0,
    "owner" : {
      "account_id" : 16123119,
      "reputation" : 92,
      "user_id" : 11638603,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TNKZTFbhk3w/AAAAAAAAAAI/AAAAAAAAAE4/MGkKHbrckks/s256-rj/photo.jpg",
      "display_name" : "Some_ Person",
      "link" : "https://stackoverflow.com/users/11638603/some-person"
    },
    "creation_date" : 1747754378,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140443101,
    "post_id" : 79630654,
    "body" : "@aled @stdunbar, if I inspect opensearch 2.19.1 version, which I am currently using, its distribution allows java.security,manager by default in <a href=\"https://github.com/opensearch-project/OpenSearch/blob/2.19.1/distribution/src/config/jvm.options\" rel=\"nofollow noreferrer\">jvm.config</a>. So this flag will always be included. <code>.&#47;gradlew run</code> runs opensearch snapshot installed into build directory so changing it manually isn&#39;t a solution. I inspected newer version 3.0.0 and it doesn&#39;t have this default config. I will try to run plugin for newer version now and see if issue persists",
    "score" : 0,
    "owner" : {
      "account_id" : 16123119,
      "reputation" : 92,
      "user_id" : 11638603,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TNKZTFbhk3w/AAAAAAAAAAI/AAAAAAAAAE4/MGkKHbrckks/s256-rj/photo.jpg",
      "display_name" : "Some_ Person",
      "link" : "https://stackoverflow.com/users/11638603/some-person"
    },
    "creation_date" : 1747753689,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140443029,
    "post_id" : 79630654,
    "body" : "Java Security Manager was deprecated in Java 17 and marked for future removal. Also <code>false</code> is not a valid value for the system property <code>java.security.manager</code>. See <a href=\"https://docs.oracle.com/en/java/javase/22/docs/api/java.base/java/lang/SecurityManager.html\" rel=\"nofollow noreferrer\">docs.oracle.com/en/java/javase/22/docs/api/java.base/java/la&zwnj;&#8203;ng/&hellip;</a> for details.",
    "score" : 2,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1747752628,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140443027,
    "post_id" : 79630654,
    "body" : "Have you tried to run without the <code>-Djava.security.manager=allow</code> command line?  The Java SecurityManager is not enabled by default and should not be used any more.",
    "score" : 2,
    "owner" : {
      "account_id" : 3509196,
      "reputation" : 17640,
      "user_id" : 2933977,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/25308d33862d9b72e0b93160b1fd778c?s=256&d=identicon&r=PG",
      "display_name" : "stdunbar",
      "link" : "https://stackoverflow.com/users/2933977/stdunbar"
    },
    "creation_date" : 1747752598,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79632296" : [ {
      "comment_id" : 140449407,
      "post_id" : 79632296,
      "body" : "@user207421, I now get it, is there other place where i can put policy which will be packaged with build, or should I define policy for each environment I run in",
      "score" : 0,
      "owner" : {
        "account_id" : 16123119,
        "reputation" : 92,
        "user_id" : 11638603,
        "user_type" : "registered",
        "profile_image" : "https://lh4.googleusercontent.com/-TNKZTFbhk3w/AAAAAAAAAAI/AAAAAAAAAE4/MGkKHbrckks/s256-rj/photo.jpg",
        "display_name" : "Some_ Person",
        "link" : "https://stackoverflow.com/users/11638603/some-person"
      },
      "creation_date" : 1747919682,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140447738,
      "post_id" : 79632296,
      "body" : "I repeat. The src directory is not there at runtime. This only worked because you ran it on the machine you developed on. It won&#39;t work in a real deployment.",
      "score" : 0,
      "owner" : {
        "account_id" : 71739,
        "reputation" : 311869,
        "user_id" : 207421,
        "user_type" : "registered",
        "accept_rate" : 82,
        "profile_image" : "https://www.gravatar.com/avatar/5cfe5f7d64f44be04f147295f5c7b88e?s=256&d=identicon&r=PG",
        "display_name" : "user207421",
        "link" : "https://stackoverflow.com/users/207421/user207421"
      },
      "creation_date" : 1747871862,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}