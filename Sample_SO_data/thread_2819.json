{
  "question" : {
    "question_id" : 79592820,
    "title" : "Converting JMS ConnectionFactory to ActiveMQ ConnectionFactory - expected and returned instances are both correct type but fails",
    "body" : "<p>I'm replacing <code>activemq-all 5.18.6</code> with <code>activemq-broker</code> and <code>activemq-client</code>.  I've found a side effect in my Java servlets that <code>javax.jms.ConnectionFactory</code> has to be replaced in the servlet XML and the Java code with <code>org.apache.activemq.ActiveMQConnectionFactory</code>. However, this leads to a runtime error in the Catalina log:</p>\n<pre><code>WARNING [main] XmlWebApplicationContext.refresh Exception encountered during context initialization - cancelling refresh attempt: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'JMSConnectionFactory' defined in ServletContext resoure [/WEB-INF/JmsProcessing-servlet.xml]: Invocation of init method failed; nested exception is javax.naming.NamingException: Unexpected exception resolving reference [Root exception is java.lang.IllegalArgumentException: The local resource link [ConnectionFactory] that refers to global resource [jms/ConnectionFactory] was expected to return an instance of [org.apache.activemq.ActiveMQConnectionFactory] but returned an instance of [org.apache.activemq.ActiveMQConnectionFactory]]\n</code></pre>\n<p>I have verified that <code>org.apache.activemq.ActiveMQConnectionFactory</code> is being referenced in all relevant locations so it's not a simple typo.</p>\n<p><code>context.xml</code>:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml....?&gt;\n&lt;Context docBase=&quot;JmsProcessing&quot; reloadable=&quot;true&quot;&gt;\n   &lt;ResourceLink name=&quot;jdbc/dev&quot; global=&quot;jdbc/dev&quot; type=&quot;javax.sql.DataSource&quot; /&gt;\n   &lt;ResourceLink name=&quot;jms/ConnectionFactory&quot;\n                 global=&quot;jms/ConnectionFactory&quot;\n                 type=&quot;org.apache.activemq.ActiveMQConnectionFactory&quot; /&gt;\n       &lt;!-- was  type=&quot;javax.jms.ConnectionFactory&quot; --&gt;\n&lt;/Context&gt;\n</code></pre>\n<p><code>JmsProcessing-servlet.xml</code>:</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;?xml ... ?&gt;\n&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;\n       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;\n       xmlns:tx=&quot;http://www.springframework.org/schema/tx&quot;\n       xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans\n       http://www.springframework.org/schema/beans/spring-beans-2.5.xsd\n       org/springframework/beans/factory/xml/spring-beans-2.5.xsd\n       spring-beans-2.5.xsd&quot;&gt;\n   &lt;bean id=&quot;JMSConnectionFactory&quot; class=&quot;org.springframework.jndi.JndiObjectFactoryBean&quot;&gt;\n      &lt;property name=&quot;jndiName&quot;&gt;\n         &lt;value&gt;java:comp/env/jms/ConnectionFactory&lt;/value&gt;\n      &lt;/property&gt;\n   &lt;/bean&gt;\n\n   &lt;bean name=&quot;processingBean&quot; class=&quot;com.custom.processing.impl.JmsProcessor&quot;&gt;\n      &lt;property name=&quot;connectionFactory&quot; ref=&quot;JMSConnectionFactory&quot; /&gt;\n   &lt;/bean&gt;\n&lt;/beans&gt;\n</code></pre>\n<p>I'm using Spring 4.3.18, building in Java 17, running in Java 11 on RH9.</p>\n<p>I found <code>activemq-client-5.18.6.jar</code> in two locations.  From the install directory, they are</p>\n<ul>\n<li><code>tomcat/lib/activemq-client-5.18.6.jar</code></li>\n<li><code>tomcat/webapps/JmsProcessing/WEB-INF/lib/activemq-client-5.18.6.jar</code></li>\n</ul>\n<p>I suspect the jar needs to be in the webapp-specific directory and not the Tomcat lib directory, but I could have this backwards.</p>\n",
    "tags" : [ "java", "spring", "activemq-classic" ],
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "is_answered" : false,
    "view_count" : 195,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1745603126,
    "creation_date" : 1745594090,
    "link" : "https://stackoverflow.com/questions/79592820/converting-jms-connectionfactory-to-activemq-connectionfactory-expected-and-re",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79593058,
    "question_id" : 79592820,
    "body" : "<p>This sounds like a classloading problem to me. I've seen this kind of thing before where two instance of the same class are considered <em>different</em> because they came from different classloaders (i.e. different jars). I'm not familiar with Tomcat classloading behavior so my recommendation would be to eliminate one instance of <code>activemq-client-5.18.6.jar</code> and test. If it still doesn't work then restore the one you eliminated and eliminate the other and test.</p>\n<p>Generally speaking, you definitely should be able to use the JMS API rather than implementation-specific ActiveMQ classes. That's one of the main benefits of using an API in the first place.</p>\n<p>Lastly, you typically don't need <code>activemq-broker</code> on your application's classpath. That's usually only necessary if you're running an embedded instance of the broker in the same JVM as the client application.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 11434008,
      "reputation" : 36282,
      "user_id" : 8381946,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-ORs8fPNVzDU/AAAAAAAAAAI/AAAAAAAADBs/F3IsdsProVY/s256-rj/photo.jpg",
      "display_name" : "Justin Bertram",
      "link" : "https://stackoverflow.com/users/8381946/justin-bertram"
    },
    "creation_date" : 1745603126,
    "last_activity_date" : 1745603126,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140369894,
    "post_id" : 79592820,
    "body" : "@JustinBertram I updated my question with the locations of the two <code>activemq-client</code> jars.",
    "score" : 0,
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "creation_date" : 1745598954,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140369787,
    "post_id" : 79592820,
    "body" : "@JustinBertram Because that caused a possibly similar problem (or possibly similar fix) -- expected instance was <code>javax.jms.ConnectionFactory</code> but actual instance was <code>org....ActiveMQConnectionFactory</code>.  I <i>had</i> come across something saying I should only have needed to change the XML files, not the code.....",
    "score" : 0,
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "creation_date" : 1745597036,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140369771,
    "post_id" : 79592820,
    "body" : "@JustinBertram In my previous comment, yes I was referring to the actual text.  If there is a way I can inspect the runtime instances and see why they might not be perfectly identical, please suggest it.",
    "score" : 0,
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "creation_date" : 1745596826,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140369750,
    "post_id" : 79592820,
    "body" : "@JustinBertram: First, visual inspection.  Second, I copied both instances to separate files and ran <code>diff</code> - it said they were identical. Third, a search in vi found both.  I&#39;m trying to get Tomcat to tell me what classpath it&#39;s actually using at runtime, because multiple instances of the same class is quite possible.",
    "score" : 0,
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "creation_date" : 1745596622,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140369740,
    "post_id" : 79592820,
    "body" : "@lance-java I didn&#39;t write it, I&#39;m just maintaining it.",
    "score" : 0,
    "owner" : {
      "account_id" : 3089365,
      "reputation" : 836,
      "user_id" : 2615836,
      "user_type" : "registered",
      "accept_rate" : 66,
      "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
      "display_name" : "Codes with Hammer",
      "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
    },
    "creation_date" : 1745596515,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140369660,
    "post_id" : 79592820,
    "body" : "yikes! spring config in xml? Haven&#39;t seen that in many years",
    "score" : 0,
    "owner" : {
      "account_id" : 1096470,
      "reputation" : 29414,
      "user_id" : 1089967,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
      "display_name" : "lance-java",
      "link" : "https://stackoverflow.com/users/1089967/lance-java"
    },
    "creation_date" : 1745595590,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79593058" : [ {
      "comment_id" : 140370742,
      "post_id" : 79593058,
      "body" : "Understood. I guess that&#39;s a design flaw for these classes in ActiveMQ Classic. Those MBean definitions should almost certainly be pulled out of the broker module and either into their own module or potentially the client module as is done in ActiveMQ Artemis.",
      "score" : 0,
      "owner" : {
        "account_id" : 11434008,
        "reputation" : 36282,
        "user_id" : 8381946,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/-ORs8fPNVzDU/AAAAAAAAAAI/AAAAAAAADBs/F3IsdsProVY/s256-rj/photo.jpg",
        "display_name" : "Justin Bertram",
        "link" : "https://stackoverflow.com/users/8381946/justin-bertram"
      },
      "creation_date" : 1745618725,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140370564,
      "post_id" : 79593058,
      "body" : "In reply to the last paragraph - one of the other web apps imports <code>activemq.broker.jmx.TopicViewMBean</code>. I haven&#39;t touched any of the <code>MBean</code>-related code.",
      "score" : 0,
      "owner" : {
        "account_id" : 3089365,
        "reputation" : 836,
        "user_id" : 2615836,
        "user_type" : "registered",
        "accept_rate" : 66,
        "profile_image" : "https://i.sstatic.net/Oryma.jpg?s=256",
        "display_name" : "Codes with Hammer",
        "link" : "https://stackoverflow.com/users/2615836/codes-with-hammer"
      },
      "creation_date" : 1745613906,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}