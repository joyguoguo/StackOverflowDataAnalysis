{
  "question" : {
    "question_id" : 79822339,
    "title" : "Downloading a large file in spring MVC through Web client",
    "body" : "<p>I'm trying to download a large file with with Spring web client without loading an entire file to the memory. I have such service method:</p>\n<pre><code>@Override\npublic StreamingResponseBody download() {\n    Flux&lt;DataBuffer&gt; dataBufferFlux = webClient.get()\n            .uri(&quot;/download&quot;)\n            .retrieve()\n            .bodyToFlux(DataBuffer.class);\n\n    StreamingResponseBody streamingResponseBody = outputStream -&gt; {\n        DataBufferUtils.write(dataBufferFlux, outputStream)\n                .doOnNext(DataBufferUtils::release)\n                .blockLast();\n    };\n    return streamingResponseBody;\n}\n</code></pre>\n<p>Also we use Spring MVC framework so I can't use Flux in my endpoints. The endpoint code is:</p>\n<pre><code>@GetMapping(value = &quot;/download&quot;, produces = &quot;application/octet-stream&quot;)\npublic ResponseEntity&lt;StreamingResponseBody&gt; down() {\n    var download = service.download();\n    return ResponseEntity.ok().contentType(MediaType.APPLICATION_OCTET_STREAM).body(download);\n}\n</code></pre>\n<p>But this code does not work. When I call my endpoint I get an empty body with 0 content type. I can't load all bytes[] to memory because I'll get OOM.</p>\n",
    "tags" : [ "java", "spring", "rest", "spring-webflux", "octet-stream" ],
    "owner" : {
      "account_id" : 29075771,
      "reputation" : 143,
      "user_id" : 22272977,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTte84Ivji8PRE1ZJ4PbrT8hScfiqYc2zV3zX5YpeaOwC=k-s256",
      "display_name" : "Роман Григорьев",
      "link" : "https://stackoverflow.com/users/22272977/%d0%a0%d0%be%d0%bc%d0%b0%d0%bd-%d0%93%d1%80%d0%b8%d0%b3%d0%be%d1%80%d1%8c%d0%b5%d0%b2"
    },
    "is_answered" : true,
    "view_count" : 87,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1763459577,
    "creation_date" : 1763385576,
    "link" : "https://stackoverflow.com/questions/79822339/downloading-a-large-file-in-spring-mvc-through-web-client",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79823010,
    "question_id" : 79822339,
    "body" : "<h1>Project Tree</h1>\n<pre class=\"lang-bash prettyprint-override\"><code>demo-download-file-spring-mvc-webclient\n├── pom.xml\n├── Dockerfile\n└── src\n    └── main\n        ├── java\n        │   └── com\n        │       └── example\n        │           ├── controller\n        │           │   └── DownloadController.java\n        │           └── DemoDownloadFileSpringMVCApplication.java\n        └── resources\n            └── application.properties\n</code></pre>\n<h2>pom.xml</h2>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n    xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;3.5.7&lt;/version&gt;\n        &lt;relativePath/&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;com.example&lt;/groupId&gt;\n    &lt;artifactId&gt;demo-download-file-spring-mvc-webclient&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;demo-download-file-spring-mvc-webclient&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n\n    &lt;properties&gt;\n            &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;\n                &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;\n                &lt;maven.compiler.encoding&gt;UTF-8&lt;/maven.compiler.encoding&gt;\n                &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n                &lt;project.reporting.outputEncoding&gt;UTF-8&lt;/project.reporting.outputEncoding&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n\n        &lt;dependency&gt;\n            &lt;groupId&gt;commons-io&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-io&lt;/artifactId&gt;\n            &lt;version&gt;2.15.1&lt;/version&gt;\n        &lt;/dependency&gt;\n\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n    &lt;finalName&gt;app&lt;/finalName&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n\n&lt;/project&gt;\n</code></pre>\n<h2>application.properties</h2>\n<ul>\n<li>config remote download url</li>\n</ul>\n<pre class=\"lang-bash prettyprint-override\"><code>spring.application.name=demo-download-file\nremote-download-base-url=http://demo.example.com/download\n</code></pre>\n<h2>DemoDownloadFileSpringMVCApplication.java</h2>\n<pre class=\"lang-java prettyprint-override\"><code>package com.example;\n\nimport org.springframework.boot.SpringApplication;\nimport org.springframework.boot.autoconfigure.SpringBootApplication;\n\n@SpringBootApplication\npublic class DemoDownloadFileSpringMVCApplication {\n\n    public static void main(String[] args) {\n        SpringApplication.run(DemoDownloadFileSpringMVCApplication.class, args);\n    }\n}\n</code></pre>\n<h2>DownloadController.java</h2>\n<pre><code>package com.example.controller;\n\nimport org.apache.commons.io.IOUtils;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.http.HttpHeaders;\nimport org.springframework.http.MediaType;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.stereotype.Controller;\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RequestParam;\nimport org.springframework.web.servlet.mvc.method.annotation.StreamingResponseBody;\nimport org.springframework.web.reactive.function.client.WebClient;\nimport org.springframework.core.io.buffer.DataBuffer;\nimport org.springframework.core.io.buffer.DataBufferUtils;\nimport reactor.core.publisher.Flux;\n\nimport jakarta.servlet.http.HttpServletResponse;\nimport java.io.InputStream;\nimport java.io.OutputStream;\n\nimport org.slf4j.Logger;\nimport org.slf4j.LoggerFactory;\n\n@Controller\npublic class DownloadController {\n    static final Logger log= LoggerFactory.getLogger(DownloadController.class);\n    \n    private final WebClient webClient;\n\n    @Value(&quot;${remote-download-base-url}&quot;)\n    private String baseUrl; // This can be overridden via application.properties + environment.\n\n    public DownloadController(WebClient.Builder builder) {\n        this.webClient = builder.build();\n    }\n\n    @GetMapping(&quot;/download-remote&quot;)\n    public ResponseEntity&lt;StreamingResponseBody&gt; downloadRemote(\n            @RequestParam(&quot;param1&quot;) String param1,\n            @RequestParam(&quot;param2&quot;) String param2) {\n\n        log.info(&quot;param1 = {}, param2 = {}&quot;, param1, param2);\n        \n        String remoteUrl = baseUrl + &quot;?param1=&quot; + param1 +&quot;&amp;param2=&quot;+ param2;\n        log.info(&quot;remoteUrl = {}&quot;, remoteUrl);\n\n        StreamingResponseBody body = outputStream -&gt; {\n\n            // Obtain Flux&lt;DataBuffer&gt; from remote stream\n            Flux&lt;DataBuffer&gt; dataBufferFlux = webClient.get()\n                    .uri(remoteUrl)\n                    .retrieve()\n                    .bodyToFlux(DataBuffer.class);\n           log.info(&quot;dataBufferFlux ok&quot;);\n           \n            // Writing Flux to OutputStream (blocking MVC environment)\n            DataBufferUtils.write(dataBufferFlux, outputStream)\n                    .doOnNext(DataBufferUtils::release)\n                    .blockLast();  // MVC needs to block until the streaming is complete.\n        };\n           log.info(&quot;DataBufferUtils.write ok&quot;);\n           \n           \n        return ResponseEntity.ok()\n                .header(HttpHeaders.CONTENT_DISPOSITION,\n                        &quot;attachment; filename=&quot; + fileName)\n                .contentType(MediaType.APPLICATION_OCTET_STREAM)\n                .body(body);\n    }\n}\n</code></pre>\n<h2>Dockerfile</h2>\n<p>optional - only for verify.</p>\n<pre class=\"lang-bash prettyprint-override\"><code>FROM eclipse-temurin:17-jre-alpine\n\nWORKDIR /app-data\n\nCOPY target/app.jar app.jar\n\nEXPOSE 8080\n\nENTRYPOINT [&quot;java&quot;, &quot;-jar&quot;, &quot;app.jar&quot;]\n</code></pre>\n<h2>Build</h2>\n<pre class=\"lang-bash prettyprint-override\"><code>mvn clean package\n</code></pre>\n<h2>Run</h2>\n<pre><code>export REMOTE_DOWNLOAD_BASE_URL=&quot;http://demo.server.local:58080/download&quot;\n\njava -jar target/app.jar\n</code></pre>\n<h2>Test</h2>\n<p>Open Browser</p>\n<p>http://localhost:8080/download-remote?param1=TEMP&amp;param2=TEST</p>\n<p>NOTE:</p>\n<p>Spring Boot Controller will download file from <a href=\"http://demo.server.local:58080/download?param1=TEMP&amp;param2=TEST\" rel=\"nofollow noreferrer\">http://demo.server.local:58080/download?param1=TEMP&amp;param2=TEST</a></p>\n<p>String remoteUrl = baseUrl + &quot;?param1=&quot; + param1 +&quot;&amp;param2=&quot;+ param2;</p>\n<p>To verify that the program does not download the entire file to memory, we create a Docker image and limit the Docker container's memory to 1GB during execution. We then test downloading a remote file up to 4GB (exceeding the 1GB allocated to the Docker container) to verify that the file is not downloaded entirely to memory.</p>\n<h2>Build Docker Image</h2>\n<pre class=\"lang-bash prettyprint-override\"><code>docker build -t spring-download-remote .\n</code></pre>\n<h2>Run Docker</h2>\n<pre class=\"lang-bash prettyprint-override\"><code>docker run \\\n  -it \\\n  --rm \\\n  --name download-remote \\\n  -p 8080:8080 \\\n  --memory=&quot;1g&quot; \\\n  --memory-swap=&quot;1g&quot; \\\n  -e REMOTE_DOWNLOAD_BASE_URL=&quot;http://demo.server.local:58080/download&quot; \\\n  spring-download-remote\n</code></pre>\n<h2>Test</h2>\n<p>Open Browser:</p>\n<p>http://localhost:8080/download-remote?param1=TEMP&amp;param2=TEST</p>\n<p>In fact, the program will connect to this URL (<a href=\"http://demo.server.local:58080/download?param1=TEMP&amp;param2=TEST\" rel=\"nofollow noreferrer\">http://demo.server.local:58080/download?param1=TEMP&amp;param2=TEST</a>) to download the file.</p>\n<p>Code:</p>\n<p>MVC Controller Download remoteUrl file:</p>\n<pre class=\"lang-java prettyprint-override\"><code>\n    @Value(&quot;${remote-download-base-url}&quot;)\n    private String baseUrl; // This can be overridden via application.properties + environment.\n\n    @GetMapping(&quot;/download-remote&quot;)\n    public ResponseEntity&lt;StreamingResponseBody&gt; downloadRemote(\n            @RequestParam(&quot;param1&quot;) String param1,\n            @RequestParam(&quot;param2&quot;) String param2) {\n\n    ...\n           String remoteUrl = baseUrl + &quot;?param1=&quot; + param1 +&quot;&amp;param2=&quot;+ param2;\n    ...          \n</code></pre>\n<pre class=\"lang-bash prettyprint-override\"><code>+--------+                     +-------------------------+                           +--------+ \n| Broser +-- Download File --&gt; + Spring Boot Application +                           +        +\n|        |                     + (MVC Controller) +------------+                     + Remote +\n+--------+                     +------------------+ Web Client +-- Download File --&gt; + Server +\n                                                  +------------+                     +--------+\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 26698569,
      "reputation" : 4070,
      "user_id" : 20306007,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/98bbc403493aee3681b71dae7abef66e?s=256&d=identicon&r=PG",
      "display_name" : "life888888",
      "link" : "https://stackoverflow.com/users/20306007/life888888"
    },
    "creation_date" : 1763444145,
    "last_activity_date" : 1763459577,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140858260,
    "post_id" : 79822339,
    "body" : "<i>Also we use Spring MVC framework so I can&#39;t use Flux in my endpoints</i>. Sure you can, you will end-up with only the async part of Webflux but there is nothing preventing you from returning a <code>Flux</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763386120,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}