{
  "question" : {
    "question_id" : 79545832,
    "title" : "DATEDIFF function breaks JUnit tests",
    "body" : "<p>I'm working on Java 21 with Spring Boot. I have a batch of Junit tests for my project. As per my last task, I implemented a scheduler that physically deletes rows on my MySql DB which where logically deleted for a fixed time period.</p>\n<p>I pass the number of days that should have passed since a logical deletion to my query, and based on this input, the records will be physically deleted. For example, if I pass 120, it means that any records that were logically deleted more than 120 days ago should be physically deleted now.</p>\n<p>This is the query:</p>\n<pre><code>@Query(&quot;SELECT o FROM OutputStreamJpa o WHERE o.deleted IS NOT NULL &quot; +\n            &quot;AND DATEDIFF(CURRENT_DATE, o.deleted) &gt;= :days&quot;)\n    List&lt;OutputStreamJpa&gt; findDeletedOlderThanFixedDays(Integer days);\n</code></pre>\n<p>Thing is, this breaks all my JUnit tests. It gives really strange errors, like that certain classes have not been autowired correctly. Removing this query fixes it.</p>\n<pre><code>Caused by: java.lang.IllegalArgumentException: org.hibernate.query.sqm.produce.function.FunctionArgumentException: Parameter 1 of function 'timestampdiff()' has type 'TEMPORAL_UNIT', but argument is of type 'java.lang.Object'\n</code></pre>\n<p>I'm using an H2 DB for my JUnit Tests, if it can be of any help to you.</p>\n",
    "tags" : [ "java", "spring-boot", "hibernate", "h2" ],
    "owner" : {
      "account_id" : 28629829,
      "reputation" : 31,
      "user_id" : 21921104,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d8a87a343a3c19fd9ae8cb0c2ebcb3dc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "boh",
      "link" : "https://stackoverflow.com/users/21921104/boh"
    },
    "is_answered" : false,
    "view_count" : 94,
    "answer_count" : 1,
    "score" : 3,
    "last_activity_date" : 1743439022,
    "creation_date" : 1743410767,
    "link" : "https://stackoverflow.com/questions/79545832/datediff-function-breaks-junit-tests",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79546761,
    "question_id" : 79545832,
    "body" : "<p>In both the production MySQL-DB and the H2-DB you are executing a function called <code>DATEDIFF</code>. That is simply not the same function though, they don't even have compatible signatures.</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.4/en/date-and-time-functions.html#function_datediff\" rel=\"nofollow noreferrer\">mysql DATEDIFF(expr1,expr2)</a></p>\n<p><a href=\"https://www.h2database.com/html/functions.html#datediff\" rel=\"nofollow noreferrer\">h2 DATEDIFF(datetimeField, aDateAndTime, bDateAndTime)</a></p>\n<p>So this is not an issue with your code, query or configuration. This is a hard limit on testing a program intended for MySQL-production-use with an H2-replacement.</p>\n<p>What are your options here?</p>\n<p>(1) Verify the query manually and mock it out for tests. Leave a comment explaining this, it will be valuable to anyone changing the query or writing another test using the method.</p>\n<p>(2) Test with a real MySQL-Database - the problems of testing with a real database can be greatly mitigated with <a href=\"https://testcontainers.com/\" rel=\"nofollow noreferrer\">testcontainers</a>.</p>\n<p>(3) Don't use the <code>datediff</code>-function and pull the logic up into your java-program.</p>\n<hr />\n<p>I gathered from comments that H2 has a MySQL 'compatibility mode' which is <a href=\"https://h2database.com/html/features.html#compatibility\" rel=\"nofollow noreferrer\">documented</a> (thanks @ pebble unit).\nThe list of MySQL-features that H2 supports in this mode is limited.\n<code>DATEDIFF</code> is nowhere to be seen in any variant of this mode, and as I understand the wording in this documentation, this is intended to be a complete list of adjustments H2 makes to offer some level of MySQL-compatibility. What they do warn is:</p>\n<blockquote>\n<p>However, only a small subset of the differences between databases are implemented  [...]</p>\n</blockquote>\n<p>So this is no solution to this particular problem.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 9842376,
      "reputation" : 2313,
      "user_id" : 7465516,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e167bc0e9829e026d8c9a4bad92e94b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "julaine",
      "link" : "https://stackoverflow.com/users/7465516/julaine"
    },
    "creation_date" : 1743438458,
    "last_activity_date" : 1743439022,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140399262,
    "post_id" : 79545832,
    "body" : "If your question is answered, you can mark the answer as &#39;accepted&#39;. If the answer is not applicable or helpful, leave a comment.",
    "score" : 0,
    "owner" : {
      "account_id" : 9842376,
      "reputation" : 2313,
      "user_id" : 7465516,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5e167bc0e9829e026d8c9a4bad92e94b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "julaine",
      "link" : "https://stackoverflow.com/users/7465516/julaine"
    },
    "creation_date" : 1746516907,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140282452,
    "post_id" : 79545832,
    "body" : "Wouldn&#39;t it be better to make your code portable and do <code>&quot;SELECT o FROM OutputStreamJpa o WHERE o.deleted IS NOT NULL AND o.deleted &lt;= :calculatedDate&quot;)</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 22124137,
      "reputation" : 4243,
      "user_id" : 16376827,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/1ImPw.png?s=256",
      "display_name" : "g00se",
      "link" : "https://stackoverflow.com/users/16376827/g00se"
    },
    "creation_date" : 1743425179,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281672,
    "post_id" : 79545832,
    "body" : "@Shadow oh ok, i figured so. I was using H2 to make testing easier, but i think it&#39;s not the best way. Maybe i&#39;ll simply use mockito for testing",
    "score" : 0,
    "owner" : {
      "account_id" : 28629829,
      "reputation" : 31,
      "user_id" : 21921104,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d8a87a343a3c19fd9ae8cb0c2ebcb3dc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "boh",
      "link" : "https://stackoverflow.com/users/21921104/boh"
    },
    "creation_date" : 1743413162,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281660,
    "post_id" : 79545832,
    "body" : "@boh H2 and mysql. Compatibility mode is never fully compliant and mysql still may behave differently even if the syntax is the same.",
    "score" : 0,
    "owner" : {
      "account_id" : 7035840,
      "reputation" : 34520,
      "user_id" : 5389997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/50ce1e08eea42756ffa9415a9e8df140?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Shadow",
      "link" : "https://stackoverflow.com/users/5389997/shadow"
    },
    "creation_date" : 1743412943,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281632,
    "post_id" : 79545832,
    "body" : "@Shadow what do you mean by product A and product B? :)",
    "score" : 0,
    "owner" : {
      "account_id" : 28629829,
      "reputation" : 31,
      "user_id" : 21921104,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d8a87a343a3c19fd9ae8cb0c2ebcb3dc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "boh",
      "link" : "https://stackoverflow.com/users/21921104/boh"
    },
    "creation_date" : 1743412526,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281628,
    "post_id" : 79545832,
    "body" : "@Akina unfortunately it didn&#39;t solve my problem. Will look more into it, thanks!",
    "score" : 0,
    "owner" : {
      "account_id" : 28629829,
      "reputation" : 31,
      "user_id" : 21921104,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d8a87a343a3c19fd9ae8cb0c2ebcb3dc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "boh",
      "link" : "https://stackoverflow.com/users/21921104/boh"
    },
    "creation_date" : 1743412496,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281597,
    "post_id" : 79545832,
    "body" : "I would also caution you against testing on product A and then use product B in production - this is recipe for disaster!",
    "score" : 2,
    "owner" : {
      "account_id" : 7035840,
      "reputation" : 34520,
      "user_id" : 5389997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/50ce1e08eea42756ffa9415a9e8df140?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Shadow",
      "link" : "https://stackoverflow.com/users/5389997/shadow"
    },
    "creation_date" : 1743411971,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281589,
    "post_id" : 79545832,
    "body" : "H2 should support MySql compatibility mode. Maybe you can give that a try to make it more MySql-like <a href=\"https://h2database.com/html/features.html#compatibility\" rel=\"nofollow noreferrer\">h2database.com/html/features.html#compatibility</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 21724606,
      "reputation" : 1431,
      "user_id" : 16034206,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/MRBdT.jpg?s=256",
      "display_name" : "pebble unit",
      "link" : "https://stackoverflow.com/users/16034206/pebble-unit"
    },
    "creation_date" : 1743411843,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281573,
    "post_id" : 79545832,
    "body" : "@Shadow i think Hibernate gives this problem because it can&#39;t convert this query to H2. DATEDIFF is a MYSQL Query",
    "score" : 0,
    "owner" : {
      "account_id" : 28629829,
      "reputation" : 31,
      "user_id" : 21921104,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d8a87a343a3c19fd9ae8cb0c2ebcb3dc?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "boh",
      "link" : "https://stackoverflow.com/users/21921104/boh"
    },
    "creation_date" : 1743411718,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281559,
    "post_id" : 79545832,
    "body" : "Try to rewrite the condition to <code>.. AND CURRENT_DATE - INTERVAL :days DAY &gt;= o.deleted</code>. As a bonus the condition will become SARGable.",
    "score" : 1,
    "owner" : {
      "account_id" : 9744358,
      "reputation" : 43176,
      "user_id" : 10138734,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/sf6Zj.jpg?s=256",
      "display_name" : "Akina",
      "link" : "https://stackoverflow.com/users/10138734/akina"
    },
    "creation_date" : 1743411609,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281556,
    "post_id" : 79545832,
    "body" : "Moreover, this error message does not come from mysql, this is a hibernate one. Is this a native sql query or a HQL one?",
    "score" : 0,
    "owner" : {
      "account_id" : 7035840,
      "reputation" : 34520,
      "user_id" : 5389997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/50ce1e08eea42756ffa9415a9e8df140?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Shadow",
      "link" : "https://stackoverflow.com/users/5389997/shadow"
    },
    "creation_date" : 1743411550,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281540,
    "post_id" : 79545832,
    "body" : "The error looks like @Query function (?) decides that DATEDIFF literal is not a function name in the query text which must be transferred as-is but a placeholder which must be substituted or Java function name which must be evaluated. I cannot find any otherr reason why the error refers on timestampdiff() function which is not present in the query text..",
    "score" : 0,
    "owner" : {
      "account_id" : 9744358,
      "reputation" : 43176,
      "user_id" : 10138734,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/sf6Zj.jpg?s=256",
      "display_name" : "Akina",
      "link" : "https://stackoverflow.com/users/10138734/akina"
    },
    "creation_date" : 1743411427,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140281534,
    "post_id" : 79545832,
    "body" : "According to the error message, the code executed has timestampdiff function, not datediff function. Which one do you actually use?",
    "score" : 0,
    "owner" : {
      "account_id" : 7035840,
      "reputation" : 34520,
      "user_id" : 5389997,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/50ce1e08eea42756ffa9415a9e8df140?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Shadow",
      "link" : "https://stackoverflow.com/users/5389997/shadow"
    },
    "creation_date" : 1743411383,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79546761" : [ {
      "comment_id" : 140283437,
      "post_id" : 79546761,
      "body" : "(and be prepared that all three options are things that some people have strong opinions about)",
      "score" : 0,
      "owner" : {
        "account_id" : 9842376,
        "reputation" : 2313,
        "user_id" : 7465516,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/5e167bc0e9829e026d8c9a4bad92e94b?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "julaine",
        "link" : "https://stackoverflow.com/users/7465516/julaine"
      },
      "creation_date" : 1743438550,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}