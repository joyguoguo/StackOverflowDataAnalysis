{
  "question" : {
    "question_id" : 79618670,
    "title" : "APOC Cypher request with date format - Quotation marks error",
    "body" : "<p>I want to run this specific request in Cypher using the APOC plugin. It should transfer data from OracleXE to Neo4j. The problem is that in my OracleXE database, there is a property in timestamp format, which Cypher can't handle. So I decided to use the <code>TO_CHAR</code> method. Up until this point, everything works fine.</p>\n<p>Later, I wanted to make my statement more performant, so I added parallel computation in batches using <code>apoc.periodic.iterate</code>. That's when the issue appeared: I now have to nest quotation marks three times. The problem is that I can't find a way to escape the quotation marks in this statement. Does anyone have an idea?</p>\n<p>I already tried these options:\n<code>\\' &quot; q'! \\\\' \\&quot;</code> â€” but none of them worked.</p>\n<p>This is my Cypher request where the problem occurred:</p>\n<pre><code>CALL apoc.periodic.iterate(\n  &quot;CALL apoc.load.jdbc('oracle', '\n    SELECT s.id, s.destination, s.sequence, s.trip_id, s.start_point, s.end_point, \n           TO_CHAR(s.departure_time, ''YYYY-MM-DD HH24:MI:SS'') as departure_time, \n           TO_CHAR(s.arrival_time, ''YYYY-MM-DD HH24:MI:SS'') as arrival_time, \n           st1.type AS enter_type, st2.type AS descend_type\n    FROM segment s\n    LEFT JOIN stop_type st1 ON s.enter_type = st1.id\n    LEFT JOIN stop_type st2 ON s.descend_type = st2.id\n    WHERE s.id IS NOT NULL') YIELD row RETURN row&quot;,\n  &quot;MERGE (s:segment {id: toInteger(row.ID)})\n   SET s.destination = row.DESTINATION,\n       s.departure_time = date(row.DEPARTURE_TIME),\n       s.arrival_time = date(row.ARRIVAL_TIME),\n       s.sequence = toInteger(row.SEQUENCE),\n       s.enter_type = row.ENTER_TYPE,\n       s.descend_type = row.DESCEND_TYPE\n   WITH s, row\n   MATCH (start:traffic_point {id: toInteger(row.START_POINT)}),\n         (end:traffic_point {id: toInteger(row.END_POINT)}),\n         (t:trip {id: toInteger(row.TRIP_ID)})\n   MERGE (s)-[:starts_at]-&gt;(start)\n   MERGE (s)-[:stops_at]-&gt;(end)\n   MERGE (s)-[:consists_of]-&gt;(t)&quot;,\n  {batchSize:1000, parallel:true}\n)\n</code></pre>\n<p>Leaving he part with TO_CHAR(...) out, results to the following request:</p>\n<pre><code>CALL apoc.periodic.iterate(\n  &quot;CALL apoc.load.jdbc('oracle', '\n    SELECT s.id, s.destination, s.sequence, s.trip_id, s.start_point, s.end_point, \n           s.departure_time, s.arrival_time, st1.type AS enter_type, st2.type AS descend_type\n    FROM segment s\n    LEFT JOIN stop_type st1 ON s.enter_type = st1.id\n    LEFT JOIN stop_type st2 ON s.descend_type = st2.id\n    WHERE s.id IS NOT NULL') YIELD row RETURN row&quot;,\n  &quot;MERGE (s:segment {id: toInteger(row.ID)})\n   SET s.destination = row.DESTINATION,\n       s.departure_time = row.DEPARTURE_TIME,\n       s.arrival_time = row.ARRIVAL_TIME,\n       s.sequence = toInteger(row.SEQUENCE),\n       s.enter_type = row.ENTER_TYPE,\n       s.descend_type = row.DESCEND_TYPE\n   WITH s, row\n   MATCH (start:traffic_point {id: toInteger(row.START_POINT)}),\n         (end:traffic_point {id: toInteger(row.END_POINT)}),\n         (t:trip {id: toInteger(row.TRIP_ID)})\n   MERGE (s)-[:starts_at]-&gt;(start)\n   MERGE (s)-[:stops_at]-&gt;(end)\n   MERGE (s)-[:consists_of]-&gt;(t)&quot;,\n  {batchSize:1000, parallel:true}\n)\n</code></pre>\n<p>This leads to this error:</p>\n<pre><code>Neo.ClientError.Procedure.ProcedureCallFailed\nFailed to invoke procedure `apoc.periodic.iterate`: Caused by: java.lang.Exception: Cannot execute read result-set.\n</code></pre>\n<p>The table I want to collect the data from is created with:</p>\n<pre><code>CREATE TABLE segment (\n            id NUMBER GENERATED ALWAYS AS IDENTITY PRIMARY KEY,\n            destination VARCHAR2(200),\n            trip_id NUMBER,\n            start_point INTEGER NOT NULL,\n            departure_time TIMESTAMP NOT NULL,\n            enter_type INTEGER,\n            end_point INTEGER NOT NULL,\n            arrival_time TIMESTAMP NOT NULL,\n            descend_type INTEGER,\n            sequence INTEGER NOT NULL,\n            CONSTRAINT unique_segment UNIQUE (start_point, end_point, trip_id),\n            CONSTRAINT fk_trip_in_segment FOREIGN KEY (trip_id) REFERENCES trip(id) ON DELETE CASCADE,\n            CONSTRAINT fk_start_point_in_segment FOREIGN KEY (start_point) REFERENCES traffic_point(id) ON DELETE CASCADE,\n            CONSTRAINT fk_enter_type FOREIGN KEY (enter_type) REFERENCES stop_type(id) ON DELETE CASCADE,\n            CONSTRAINT fk_end_point_in_segment FOREIGN KEY (end_point) REFERENCES traffic_point(id) ON DELETE CASCADE,\n            CONSTRAINT fk_descend_type FOREIGN KEY (descend_type) REFERENCES stop_type(id) ON DELETE CASCADE\n        )\n</code></pre>\n",
    "tags" : [ "java", "cypher", "neo4j-apoc", "oracle-xe", "apoc-extended" ],
    "owner" : {
      "account_id" : 31721814,
      "reputation" : 33,
      "user_id" : 24538254,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1a7ba5d274a87343dcbb8b3652b94b14?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user24538254",
      "link" : "https://stackoverflow.com/users/24538254/user24538254"
    },
    "is_answered" : false,
    "view_count" : 53,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1747242457,
    "creation_date" : 1747086040,
    "link" : "https://stackoverflow.com/questions/79618670/apoc-cypher-request-with-date-format-quotation-marks-error",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79621953,
    "question_id" : 79618670,
    "body" : "<p>You are actually asking 2 questions.</p>\n<h4>Q1: How to properly format my first Cypher query so that I can pass single-quoted format strings to the SQL TO_CHAR function?</h4>\n<p>You can use <code>\\'</code> instead of <code>''</code>, but you must also convert your other single-quotes to double-quotes and vice versa:</p>\n<pre><code>CALL apoc.periodic.iterate(\n  'CALL apoc.load.jdbc(&quot;oracle&quot;, &quot;\n    SELECT s.id, s.destination, s.sequence, s.trip_id, s.start_point, s.end_point, \n           TO_CHAR(s.departure_time, \\'YYYY-MM-DD HH24:MI:SS\\') as departure_time, \n           TO_CHAR(s.arrival_time, \\'YYYY-MM-DD HH24:MI:SS\\') as arrival_time, \n           st1.type AS enter_type, st2.type AS descend_type\n    FROM segment s\n    LEFT JOIN stop_type st1 ON s.enter_type = st1.id\n    LEFT JOIN stop_type st2 ON s.descend_type = st2.id\n    WHERE s.id IS NOT NULL&quot;) YIELD row RETURN row',\n  'MERGE (s:segment {id: toInteger(row.ID)})\n   SET s.destination = row.DESTINATION,\n       s.departure_time = date(row.DEPARTURE_TIME),\n       s.arrival_time = date(row.ARRIVAL_TIME),\n       s.sequence = toInteger(row.SEQUENCE),\n       s.enter_type = row.ENTER_TYPE,\n       s.descend_type = row.DESCEND_TYPE\n   WITH s, row\n   MATCH (start:traffic_point {id: toInteger(row.START_POINT)}),\n         (end:traffic_point {id: toInteger(row.END_POINT)}),\n         (t:trip {id: toInteger(row.TRIP_ID)})\n   MERGE (s)-[:starts_at]-&gt;(start)\n   MERGE (s)-[:stops_at]-&gt;(end)\n   MERGE (s)-[:consists_of]-&gt;(t)',\n  {batchSize:1000, parallel:true}\n)\n</code></pre>\n<p><strong>NOTE 1</strong>: Using <code>TO_CHAR</code> to convert timestamps should not even be necessary, since <a href=\"https://neo4j.com/labs/apoc/5/database-integration/load-jdbc/#_load_jdbc_format_date\" rel=\"nofollow noreferrer\">direct ingestion of timestamps is supported since neo4j 3.4</a>. I guess this is why you tried your second query.</p>\n<p><strong>NOTE 2</strong>: Even if the above query fixes the quotation issue, it will probably still fail in the same way as your second query.</p>\n<h4>Question 2. Why is <code>apoc.periodic.iterate</code> failing in my second query?</h4>\n<p>It is possible that the <code>parallel:true</code> is causing the error, because:</p>\n<ul>\n<li>Concurrent attempts to update the same nodes <a href=\"https://neo4j.com/docs/operations-manual/current/database-internals/concurrent-data-access/#lock-contention\" rel=\"nofollow noreferrer\">can cause deadlocks</a>.</li>\n<li>You are running many batches concurrently, which could overtax CPU and memory.</li>\n</ul>\n<p>Try specifying <code>parallel:false</code>, or just let it default to <code>false</code>. And if the query still fails, try reducing the <code>batchSize</code>.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 947871,
      "reputation" : 67304,
      "user_id" : 974731,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/oTDhd4cA.jpg?s=256",
      "display_name" : "cybersam",
      "link" : "https://stackoverflow.com/users/974731/cybersam"
    },
    "creation_date" : 1747241847,
    "last_activity_date" : 1747242457,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140425948,
    "post_id" : 79618670,
    "body" : "OK, I forgot that SQL wants single-quotes for the format string. See my answer for a solution to that issue, and also to your error from your new second query.",
    "score" : 0,
    "owner" : {
      "account_id" : 947871,
      "reputation" : 67304,
      "user_id" : 974731,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/oTDhd4cA.jpg?s=256",
      "display_name" : "cybersam",
      "link" : "https://stackoverflow.com/users/974731/cybersam"
    },
    "creation_date" : 1747242410,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140425658,
    "post_id" : 79618670,
    "body" : "Yes I tried also \\&quot;, but that leaves me wiith the error Neo.ClientError.Procedure.ProcedureCallFailed Failed to invoke procedure <code>apoc.periodic.iterate</code>: Caused by: java.lang.Exception: ORA-00904: &quot;YYYY-MM-DD HH24:MI:SS&quot;: ung&#252;ltige ID <a href=\"https://docs.oracle.com/error-help/db/ora-00904/\" rel=\"nofollow noreferrer\">docs.oracle.com/error-help/db/ora-00904</a>    (I&#39;m german)",
    "score" : 0,
    "owner" : {
      "account_id" : 31721814,
      "reputation" : 33,
      "user_id" : 24538254,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/1a7ba5d274a87343dcbb8b3652b94b14?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "user24538254",
      "link" : "https://stackoverflow.com/users/24538254/user24538254"
    },
    "creation_date" : 1747237034,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140422403,
    "post_id" : 79618670,
    "body" : "Did you try using <code>\\&quot;</code> instead of <code>&#39;&#39;</code> (2 single-quotes)? It should work. Also, ingestion of timestamps should be supported since neo4j 3.4 - see <a href=\"https://neo4j.com/labs/apoc/5/database-integration/load-jdbc/#_load_jdbc_format_date\" rel=\"nofollow noreferrer\">neo4j.com/labs/apoc/5/database-integration/load-jdbc/&hellip;</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 947871,
      "reputation" : 67304,
      "user_id" : 974731,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/oTDhd4cA.jpg?s=256",
      "display_name" : "cybersam",
      "link" : "https://stackoverflow.com/users/974731/cybersam"
    },
    "creation_date" : 1747157266,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}