{
  "question" : {
    "question_id" : 79660447,
    "title" : "Execution failed for task &#39;:rewriteRun&#39;. Cannot invoke &quot;java.util.Set.stream()&quot; because the return value of &quot;java.util.Map.remove(Object)&quot; is null",
    "body" : "<p>I am on IntelliJ IDEA 2025.1.2  with plugin OpenRewrite bundled 251.26094.121Java 18, and Gradle 7.6.5. I am trying to update Spring Boot from version 3.3.12 to version 3.4 but OpenRewrite returns the following error:</p>\n<pre class=\"lang-none prettyprint-override\"><code>15:07:12: Executing 'rewriteRun'…\n\n\n&gt; Task :compileJava\nNote: C:\\Users\\UserName\\IdeaProjects\\test-project\\src\\main\\java\\com\\test\\contactdata\\controller\\util\\CrmFormatterUtils.java uses or overrides a deprecated API.\nNote: Recompile with -Xlint:deprecation for details.\n\n&gt; Task :processResources\n&gt; Task :classes\n&gt; Task :compileTestJava\n\n&gt; Task :rewriteRun\nValidating active recipes\nScanning sources in project :\nUsing active styles []\nThere were problems parsing some source files, run with --info to see full stack traces\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\deployment.yaml\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\hpa.yaml\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\ingress.yaml\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\secretproviderclass.yaml\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\service.yaml\nThere were problems parsing Test_DevOps\\helm\\test-project\\templates\\serviceaccount.yaml\nAll sources parsed, running active recipes: org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_4\nThe recipe produced an error. Please report this to the recipe author.\n\nFAILURE: Build failed with an exception.\n\n* What went wrong:\nExecution failed for task ':rewriteRun'.\n&gt; java.lang.RuntimeException: Error while visiting build.gradle: java.lang.NullPointerException: Cannot invoke &quot;java.util.Set.stream()&quot; because the return value of &quot;java.util.Map.remove(Object)&quot; is null\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.lambda$visitMethodInvocation$4(DependencyInsight.java:237)\n    java.base/java.util.Optional.map(Optional.java:260)\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.visitMethodInvocation(DependencyInsight.java:230)\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.visitMethodInvocation(DependencyInsight.java:192)\n    org.openrewrite.java.tree.J$MethodInvocation.acceptJava(J.java:4281)\n    org.openrewrite.java.tree.J.accept(J.java:63)\n    org.openrewrite.TreeVisitor.visit(TreeVisitor.java:245)\n    org.openrewrite.TreeVisitor.visitAndCast(TreeVisitor.java:311)\n    org.openrewrite.java.JavaVisitor.visitRightPadded(JavaVisitor.java:1380)\n    org.openrewrite.java.JavaVisitor.lambda$visitBlock$4(JavaVisitor.java:400)\n    org.openrewrite.internal.ListUtils.map(ListUtils.java:244)\n    org.openrewrite.internal.ListUtils.map(ListUtils.java:267)\n    org.openrewrite.java.JavaVisitor.visitBlock(JavaVisitor.java:399)\n    org.openrewrite.java.JavaIsoVisitor.visitBlock(JavaIsoVisitor.java:88)\n    org.openrewrite.java.JavaIsoVisitor.visitBlock(JavaIsoVisitor.java:30)\n    org.openrewrite.java.tree.J$Block.acceptJava(J.java:851)\n    ...\n\n* Try:\n&gt; Run with --stacktrace option to get the stack trace.\n&gt; Run with --info or --debug option to get more log output.\n&gt; Run with --scan to get full insights.\n\n* Get more help at https://help.gradle.org\n\nBUILD FAILED in 2m 43s\n\n&gt; Task :rewriteRun FAILED\n4 actionable tasks: 4 executed\n15:09:56: Execution finished 'rewriteRun'.\n</code></pre>\n<p>Unfortunately the error message does not help. What might the issue here?I also tried by removing the helm files, and with different Gradle version but it didn't help either.</p>\n<p>My <code>build.gradle</code> file is as following:</p>\n<pre class=\"lang-none prettyprint-override\"><code>plugins {\n    id 'org.springframework.boot' version '3.3.12'\n    id 'io.spring.dependency-management' version '1.1.7'\n    id 'java'\n    id 'org.sonarqube' version '3.5.0.2730'\n}\n\ngroup = 'com.test'\nversion = '0.0.1-SNAPSHOT'\n\njava {\n    toolchain {\n        languageVersion = JavaLanguageVersion.of(18)\n    }\n}\n\nconfigurations {\n    compileOnly {\n        extendsFrom annotationProcessor\n    }\n}\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-mail'\n    implementation 'org.springframework.boot:spring-boot-starter-freemarker'\n    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'\n    implementation 'io.hypersistence:hypersistence-utils-hibernate-63:3.8.3'\n    implementation &quot;jakarta.validation:jakarta.validation-api:3.0.2&quot;\n    implementation 'org.springframework.boot:spring-boot-starter-actuator'\n    implementation 'org.apache.commons:commons-lang3:3.15.0'\n    implementation 'org.apache.httpcomponents.client5:httpclient5'\n    implementation 'org.flywaydb:flyway-core'\n    implementation 'org.flywaydb:flyway-sqlserver'\n    implementation 'org.keycloak:keycloak-admin-client:16.1.0'\n    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-xml:2.14.1'\n    implementation 'com.googlecode.libphonenumber:libphonenumber:8.13.40'\n    implementation &quot;commons-codec:commons-codec:1.17.2&quot;\n    implementation 'com.google.guava:guava:33.3.1-jre'\n    compileOnly 'org.projectlombok:lombok'\n    developmentOnly 'org.springframework.boot:spring-boot-devtools'\n    runtimeOnly 'com.microsoft.sqlserver:mssql-jdbc:10.2.1.jre17'\n    annotationProcessor 'org.projectlombok:lombok'\n    testImplementation 'org.springframework.boot:spring-boot-starter-test'\n}\n\ntest {\n    useJUnitPlatform()\n}\n</code></pre>\n<p>I also have a <strong>second</strong> Spring Boot 3.3.10 application and again I want to update it to version 3.4. Java 18, Gradle 7.5. OpenRewrite again returns the following error:</p>\n<pre class=\"lang-none prettyprint-override\"><code>15:48:54: Executing 'rewriteRun'…\n\nStarting Gradle Daemon...\nGradle Daemon started in 5 s 716 ms\nDownload https://plugins.gradle.org/m2/org/openrewrite/plugin/maven-metadata.xml, took 59 ms\n\n&gt; Task :compileJava\nC:\\Users\\UserName\\IdeaProjects\\test-project\\test-project\\src\\main\\java\\com\\test\\client\\configuration\\security\\ResourceServerConfig.java:43: warning: [removal] csrf() in HttpSecurity has been deprecated and marked for removal\n                .csrf().disable()\n                ^\nC:\\Users\\UserName\\IdeaProjects\\test-project\\test-project\\src\\main\\java\\com\\test\\client\\configuration\\security\\ResourceServerConfig.java:45: warning: [removal] oauth2ResourceServer() in HttpSecurity has been deprecated and marked for removal\n                .oauth2ResourceServer()\n                ^\nNote: Some input files use or override a deprecated API.\nNote: Recompile with -Xlint:deprecation for details.\nNote: C:\\Users\\UserName\\IdeaProjects\\test-project\\test-project\\src\\main\\java\\com\\test\\client\\service\\backend\\client\\MixedMultiplartFormHttpMessageConverter.java uses unchecked or unsafe operations.\nNote: Recompile with -Xlint:unchecked for details.\n2 warnings\n\n&gt; Task :processResources\n&gt; Task :classes\n&gt; Task :compileTestJava\n\n&gt; Task :rewriteRun\nValidating active recipes\nScanning sources in project :\nUsing active styles []\nAll sources parsed, running active recipes: org.openrewrite.java.spring.boot3.UpgradeSpringBoot_3_4\nThe recipe produced an error. Please report this to the recipe author.\n\nFAILURE: Build failed with an exception.\n\n* What went wrong:\nExecution failed for task ':rewriteRun'.\n&gt; java.lang.RuntimeException: Error while visiting test-project\\build.gradle: java.lang.NullPointerException: Cannot invoke &quot;java.util.Set.stream()&quot; because the return value of &quot;java.util.Map.remove(Object)&quot; is null\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.lambda$visitMethodInvocation$4(DependencyInsight.java:237)\n    java.base/java.util.Optional.map(Optional.java:260)\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.visitMethodInvocation(DependencyInsight.java:230)\n    org.openrewrite.gradle.search.DependencyInsight$MarkIndividualDependency.visitMethodInvocation(DependencyInsight.java:192)\n    org.openrewrite.java.tree.J$MethodInvocation.acceptJava(J.java:4281)\n    org.openrewrite.java.tree.J.accept(J.java:63)\n    org.openrewrite.TreeVisitor.visit(TreeVisitor.java:245)\n    org.openrewrite.TreeVisitor.visitAndCast(TreeVisitor.java:311)\n    org.openrewrite.java.JavaVisitor.visitRightPadded(JavaVisitor.java:1380)\n    org.openrewrite.java.JavaVisitor.lambda$visitBlock$4(JavaVisitor.java:400)\n    org.openrewrite.internal.ListUtils.map(ListUtils.java:244)\n    org.openrewrite.internal.ListUtils.map(ListUtils.java:267)\n    org.openrewrite.java.JavaVisitor.visitBlock(JavaVisitor.java:399)\n    org.openrewrite.java.JavaIsoVisitor.visitBlock(JavaIsoVisitor.java:88)\n    org.openrewrite.java.JavaIsoVisitor.visitBlock(JavaIsoVisitor.java:30)\n    org.openrewrite.java.tree.J$Block.acceptJava(J.java:851)\n    ...\n\n* Try:\n&gt; Run with --stacktrace option to get the stack trace.\n&gt; Run with --info or --debug option to get more log output.\n&gt; Run with --scan to get full insights.\n\n* Get more help at https://help.gradle.org\n\nBUILD FAILED in 3m 58s\n\n&gt; Task :rewriteRun FAILED\n\nDeprecated Gradle features were used in this build, making it incompatible with Gradle 8.0.\n\nYou can use '--warning-mode all' to show the individual deprecation warnings and determine if they come from your own scripts or plugins.\n\nSee https://docs.gradle.org/7.5/userguide/command_line_interface.html#sec:command_line_warnings\n4 actionable tasks: 4 executed\n15:52:57: Execution finished 'rewriteRun'.\n</code></pre>\n<p>Actually later I fixed the warnings but again it didn't help. What I am doing wrong here?</p>\n<p>Content of my <code>gradle.build</code> file is as following:</p>\n<pre class=\"lang-none prettyprint-override\"><code>plugins {\n    id 'java'\n    id 'org.springframework.boot' version '3.3.10'\n    id 'io.spring.dependency-management' version '1.1.0'\n    id &quot;jacoco&quot;\n    id 'org.sonarqube' version '3.5.0.2730'\n}\n\ngroup = 'com.test'\nversion = '0.0.1-SNAPSHOT'\n\njava {\n    toolchain {\n        languageVersion = JavaLanguageVersion.of(18)\n    }\n}\n\nconfigurations {\n    compileOnly {\n        extendsFrom annotationProcessor\n    }\n}\n\nrepositories {\n    mavenCentral()\n}\n\ndependencies {\n    implementation 'org.springframework.boot:spring-boot-starter-oauth2-resource-server'\n    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'\n    implementation 'org.springframework.boot:spring-boot-starter-web'\n    implementation 'org.springframework.boot:spring-boot-starter-webflux'\n    implementation 'org.springframework.boot:spring-boot-starter-security'\n    implementation 'org.springframework.boot:spring-boot-starter-validation'\n    implementation 'org.springframework.data:spring-data-commons:3.1.12'\n    implementation 'org.apache.httpcomponents.client5:httpclient5:5.2.1'\n    implementation 'org.springframework.boot:spring-boot-starter-actuator'\n    implementation 'org.apache.poi:poi-ooxml:5.3.0'\n    implementation 'com.ibm.icu:icu4j:75.1'\n    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-xml:2.11.1'\n    implementation 'com.itextpdf:itextpdf:5.5.13.4'\n\n    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.6.0'\n\n    implementation 'org.keycloak:keycloak-admin-client:16.1.0'\n\n    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'\n    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'\n    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'\n\n    compileOnly 'org.projectlombok:lombok'\n    developmentOnly 'org.springframework.boot:spring-boot-devtools'\n    annotationProcessor 'org.projectlombok:lombok'\n    testImplementation 'org.springframework.boot:spring-boot-starter-test'\n    testImplementation 'org.junit.jupiter:junit-jupiter:5.7.1'\n    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'\n}\n\njacocoTestReport {\n    reports {\n        xml.enabled true\n    }\n}\n\ntasks.named('test', Test) {\n    useJUnitPlatform()\n}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "gradle", "openrewrite" ],
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "is_answered" : true,
    "view_count" : 234,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1749570846,
    "creation_date" : 1749559427,
    "link" : "https://stackoverflow.com/questions/79660447/execution-failed-for-task-rewriterun-cannot-invoke-java-util-set-stream",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79660777,
    "question_id" : 79660447,
    "body" : "<p>This seems to be a bug in Openrewrite that is triggered by having the same dependency twice. It was just reported: <a href=\"https://github.com/openrewrite/rewrite/issues/5578\" rel=\"nofollow noreferrer\">https://github.com/openrewrite/rewrite/issues/5578</a></p>\n<p>The probable dependencies that are triggering the issue are:</p>\n<pre><code>compileOnly 'org.projectlombok:lombok'\nannotationProcessor 'org.projectlombok:lombok'\n</code></pre>\n<p>A similar example with lombok can be found on the bug report.</p>\n<p>You could try to remove one of the dependencies or wait for the bug to be eventually resolved.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1749570846,
    "last_activity_date" : 1749570846,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140505781,
    "post_id" : 79660447,
    "body" : "@MarcePuente The fix was posted today :-) but yeah, not released yet.",
    "score" : 1,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1749651553,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140505579,
    "post_id" : 79660447,
    "body" : "I have visited the link in @aled answer, and it seems that it already has a solution, we have to wait for it to be &quot;uploaded&quot;",
    "score" : 0,
    "owner" : {
      "account_id" : 10843443,
      "reputation" : 916,
      "user_id" : 20882864,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CCQCy.jpg?s=256",
      "display_name" : "Marce Puente",
      "link" : "https://stackoverflow.com/users/20882864/marce-puente"
    },
    "creation_date" : 1749648124,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140504564,
    "post_id" : 79660447,
    "body" : "@MarcePuente, it looks like that part is not in my code but in OpenRewrite.",
    "score" : 0,
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "creation_date" : 1749625161,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140502858,
    "post_id" : 79660447,
    "body" : "Hello ilhan, <i>Cannot invoke &quot;java.util.Set.stream()&quot; because the return value of &quot;java.util.Map.remove( Object )&quot; is null</i>, This seems to be a coding issue, I suggest you edit your question and show the relevant code (as text).",
    "score" : 0,
    "owner" : {
      "account_id" : 10843443,
      "reputation" : 916,
      "user_id" : 20882864,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CCQCy.jpg?s=256",
      "display_name" : "Marce Puente",
      "link" : "https://stackoverflow.com/users/20882864/marce-puente"
    },
    "creation_date" : 1749567268,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140502698,
    "post_id" : 79660447,
    "body" : "@aled, I recently updated from Java 17 to Java 18. I updated my question with <code>build.gradle</code> files.",
    "score" : 0,
    "owner" : {
      "account_id" : 83131,
      "reputation" : 9085,
      "user_id" : 233286,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/0ivuN.jpg?s=256",
      "display_name" : "ilhan",
      "link" : "https://stackoverflow.com/users/233286/ilhan"
    },
    "creation_date" : 1749564801,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140502571,
    "post_id" : 79660447,
    "body" : "Please share a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. Openrewrite seems to be called from Gradle rather than Intellij. Which is the actual version of Openrewrite used? Include the gradle builld file. It could be a bug in Openrewrite. May be not related to the issue but why are you using a non LTS Java version (Java 18) that was end of life in 2022?",
    "score" : 0,
    "owner" : {
      "account_id" : 372682,
      "reputation" : 26512,
      "user_id" : 721855,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
      "display_name" : "aled",
      "link" : "https://stackoverflow.com/users/721855/aled"
    },
    "creation_date" : 1749563215,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79660777" : [ {
      "comment_id" : 140538843,
      "post_id" : 79660777,
      "body" : "No issues with lombok plugin.  <a href=\"https://projectlombok.org/setup/gradle\" rel=\"nofollow noreferrer\">projectlombok.org/setup/gradle</a>   <a href=\"https://plugins.gradle.org/plugin/io.freefair.lombok\" rel=\"nofollow noreferrer\">plugins.gradle.org/plugin/io.freefair.lombok</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 5388976,
        "reputation" : 98,
        "user_id" : 4292085,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/9810780ec1fe46980c0abba276e7c2eb?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "fozersahin",
        "link" : "https://stackoverflow.com/users/4292085/fozersahin"
      },
      "creation_date" : 1750781674,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}