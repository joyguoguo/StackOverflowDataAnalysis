{
  "question" : {
    "question_id" : 79708820,
    "title" : "Why does Collectors.toMap() throw NullPointerException when mapping to null values?",
    "body" : "<p>I'm trying to convert a List of Products to a Map&lt;Long, String&gt; using Java streams. My goal is to collect the DTOs into a map where the key is getId() and the value is getLogoPath(). The logoPath can be null in some cases, and I'm okay with having null values in the resulting map.</p>\n<p>Here's the relevant code:</p>\n<pre><code>Map&lt;Long, String&gt; result = products.stream()\n    .filter(pt -&gt; pt.getId() != null)\n    .collect(Collectors.toMap(Products::getId, Products::getLogoPath));\n</code></pre>\n<p>I know this solution works by creating a Map</p>\n<pre><code>Map&lt;Long, String&gt; productMap = new HashMap&lt;&gt;();\n        for (Products product : products) {\n            if (product.getId() != null) {\n                productMap.put(product.getId(), product.getLogoPath());\n            }\n        }\n        return productMap;\n</code></pre>\n<p><strong>My Question</strong> <br>\nWhy does <strong>Collectors.toMap()</strong> throw a <strong>NullPointerException</strong> when some values are null, even though HashMap allows null values?</p>\n<p>Is there something I'm missing about how Collectors.toMap() is implemented?</p>\n<p>What I want: <br></p>\n<pre><code>{\n   1L=someUrl,\n   2L=null,\n   3L=anotherUrl\n}\n</code></pre>\n<br>\nHow can I safely achieve this without manually iterating over the list and putting entries into the map?\n",
    "tags" : [ "java", "dictionary", "collections", "nullpointerexception", "java-stream" ],
    "owner" : {
      "account_id" : 28809594,
      "reputation" : 282,
      "user_id" : 22064614,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTtffdmv3Zbtv2NMHzaIECU4VqCqcX1hylXQujxepx8o=k-s256",
      "display_name" : "Preet Bista",
      "link" : "https://stackoverflow.com/users/22064614/preet-bista"
    },
    "is_answered" : true,
    "view_count" : 177,
    "closed_date" : 1753108267,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1753106500,
    "creation_date" : 1753088939,
    "link" : "https://stackoverflow.com/questions/79708820/why-does-collectors-tomap-throw-nullpointerexception-when-mapping-to-null-valu",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79708891,
    "question_id" : 79708820,
    "body" : "<p>Because <strong>Collectors.toMap(key, value)</strong> is by default designed to throw NPE if any value is null. This happens due its internal logic( Map**.merge()** ) where it tries to match (key, value) but it crashes if it encounters 'null' value. Although HashMap allows null values, Collectors.toMap() will not allow null and  it will throw NullPointerException. We can handle using custom map supplier or merge functions</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 43119727,
      "reputation" : 29,
      "user_id" : 31088475,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/3f13c8282adf02be44fd8324bed1e22a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bhavana",
      "link" : "https://stackoverflow.com/users/31088475/bhavana"
    },
    "creation_date" : 1753092356,
    "last_activity_date" : 1753092356,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79708937,
    "question_id" : 79708820,
    "body" : "<p><code>Collectors.toMap()</code> throws <code>NullPointerException</code> when values are <code>null</code> because it uses <code>Map.merge()</code> internally, which doesnâ€™t allow <code>null</code> values without a merge function.</p>\n<p>To fix it, use the 4-argument version:</p>\n<pre><code>Map&lt;Long, String&gt; result = products.stream()\n    .filter(p -&gt; p.getId() != null)\n    .collect(Collectors.toMap(\n        Products::getId,\n        Products::getLogoPath,\n        (v1, v2) -&gt; v2,\n        HashMap::new\n    ));\n</code></pre>\n<p>This safely allows <code>null</code> values in the map.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 28079183,
      "reputation" : 35,
      "user_id" : 21450546,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AGNmyxabiTJycSVdM0yuScZoC4o1t0AlVWb230_rswy3=k-s256",
      "display_name" : "Nurlis Kimbiletov",
      "link" : "https://stackoverflow.com/users/21450546/nurlis-kimbiletov"
    },
    "creation_date" : 1753094330,
    "last_activity_date" : 1753094330,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140606325,
    "post_id" : 79708820,
    "body" : "As for a solution, <a href=\"https://stackoverflow.com/a/43299462/6395627\">this answer</a> seems the best in my opinion, at least if you want to have the same behavior as <code>Collectors.toMap</code> except with null values allowed (in particular, duplicate keys are still rejected). It uses a custom <code>Collector</code> implementation (note it defines an anonymous class, but you can instead use one of the <code>Collector.of(...)</code> static factory methods).",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1753109406,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140606298,
    "post_id" : 79708820,
    "body" : "Note the accepted answer to the duplicate mentions <a href=\"https://bugs.openjdk.org/browse/JDK-8148463\" rel=\"nofollow noreferrer\">JDK-8148463 - Collectors.toMap fails on null values</a>. That bug hasn&#39;t been fixed yet, but the comments indicate the fix will be to document this behavior (i.e., throwing an NPE for null values is expected behavior). Also, the duplicate has the NPE being thrown out of <code>Map.merge</code>. That <a href=\"https://bugs.openjdk.org/browse/JDK-8040892\" rel=\"nofollow noreferrer\">no longer happens</a> as of Java 9. Now there&#39;s a more direct and explicit check for null values: <code>V v = Objects.requireNonNull(valueMapper.apply(element));</code>.",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1753108891,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79708937" : [ {
      "comment_id" : 140610735,
      "post_id" : 79708937,
      "body" : "@BasilBourque Exactly i don&#39;t get it too either",
      "score" : 0,
      "owner" : {
        "account_id" : 28809594,
        "reputation" : 282,
        "user_id" : 22064614,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AAcHTtffdmv3Zbtv2NMHzaIECU4VqCqcX1hylXQujxepx8o=k-s256",
        "display_name" : "Preet Bista",
        "link" : "https://stackoverflow.com/users/22064614/preet-bista"
      },
      "creation_date" : 1753244634,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140609634,
      "post_id" : 79708937,
      "body" : "Why the Down-Vote? What is wrong here?",
      "score" : 2,
      "owner" : {
        "account_id" : 322981,
        "reputation" : 346951,
        "user_id" : 642706,
        "user_type" : "registered",
        "accept_rate" : 58,
        "profile_image" : "https://i.sstatic.net/ZWEI3.jpg?s=256",
        "display_name" : "Basil Bourque",
        "link" : "https://stackoverflow.com/users/642706/basil-bourque"
      },
      "creation_date" : 1753200771,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}