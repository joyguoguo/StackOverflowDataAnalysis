{
  "question" : {
    "question_id" : 79567875,
    "title" : "Kotlin JvmScriptCompiler returns failed result NoClassDefFoundError: ArgumentsKt despite class being accessible on updateClasspath",
    "body" : "<pre class=\"lang-kt prettyprint-override\"><code>  // scriptFile is just an empty `script.kts` file\n  val scriptSource = scriptFile.toScriptSource()\n  val compilerConfig = ScriptCompilationConfiguration {\n    jvm {\n      updateClasspath(classpath = scriptClassPath)\n      // this results in the same error: dependenciesFromClassloader(classLoader = scriptClassLoader, wholeClasspath = true)\n    }\n    ide {\n      acceptedLocations(ScriptAcceptedLocation.Everywhere)\n    }\n  }\n  val scriptCompiler = JvmScriptCompiler(defaultJvmScriptingHostConfiguration)\n  runBlocking {\n    val result = scriptCompiler(scriptSource, compilerConfig)\n  }\n</code></pre>\n<p>result:\n<code>Failure(reports=[ERROR org/jetbrains/kotlin/cli/common/ArgumentsKt (emptyScript.kts): java.lang.NoClassDefFoundError: org/jetbrains/kotlin/cli/common/ArgumentsKt])</code></p>\n<p>I have written a custom class loader and verified that it was able to load the <code>ArgumentsKt</code> class with the same class path by running <code>scriptClassLoader.loadClass(&quot;org.jetbrains.kotlin.cli.common.ArgumentsKt&quot;)</code></p>\n<p>I have checked that <code>org/jetbrains/kotlin/cli/common/ArgumentsKt</code> exists in one of the jars on the class path (specifically: <code>kotlin-scripting-compiler-impl-embeddable-2.1.20.jar</code>)</p>\n<p>As a side note, I cannot use <code>dependenciesFromCurrentContext</code> because this is running from an intellij platform plugin which cannot have <code>kotlin-compiler</code> or <code>kotlin-compiler-embeddable</code> on the plugin module's class path (it seems the <code>org.jetbrains.kotlin</code> plugin has an internal <code>kotlin-compiler</code> module that it doesn't expose, which prevents you from including it as a runtime dependency in your intellij platform plugin module, which is why I copy them to a plugin relative directory to be loaded by the script configuration exclusively).</p>\n<p><code>scriptClassPath</code> looks like this:</p>\n<pre class=\"lang-none prettyprint-override\"><code>C:\\path\\to\\scriptRuntime\\trove4j-1.0.20200330.jar\nC:\\path\\to\\scriptRuntime\\kotlinx-coroutines-core-jvm-1.8.0.jar\nC:\\path\\to\\scriptRuntime\\kotlin-stdlib-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-scripting-jvm-host-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-scripting-jvm-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-scripting-compiler-impl-embeddable-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-scripting-compiler-embeddable-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-scripting-common-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-script-runtime-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-reflect-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-daemon-embeddable-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\kotlin-compiler-embeddable-2.1.20.jar\nC:\\path\\to\\scriptRuntime\\annotations-13.0.jar\n</code></pre>\n",
    "tags" : [ "java", "kotlin" ],
    "owner" : {
      "account_id" : 18102346,
      "reputation" : 9,
      "user_id" : 13160039,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ced771a7ae37f7a34e59ad4ed7451599?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "AceHorizon",
      "link" : "https://stackoverflow.com/users/13160039/acehorizon"
    },
    "is_answered" : false,
    "view_count" : 33,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1744339874,
    "creation_date" : 1744338145,
    "link" : "https://stackoverflow.com/questions/79567875/kotlin-jvmscriptcompiler-returns-failed-result-noclassdeffounderror-argumentskt",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}