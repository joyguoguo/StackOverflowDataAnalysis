{
  "question" : {
    "question_id" : 79690345,
    "title" : "Garbage collector or flag/option to force complete collection (no matter how long it takes)",
    "body" : "<p>We are trying to implement memory leak regression tests.</p>\n<p>For this it would be very useful to have a deterministic garbage collector that takes as much time as needed, but collects everything that is possible to collect.</p>\n<p>We couldn't find such a garbage collector or option so far.</p>\n<p>I would expect that this is the first flag a GC-researcher would implement for internal testing.</p>\n<p>Is there such a garbage collector or option?</p>\n<p>Edit / more context:</p>\n<ul>\n<li>we're already considering heap dump analysis, but would like to avoid it if there's a simpler alternative</li>\n<li>we're already trying to force out of memory errors by various means (small -Xmx values, exercising many application features)</li>\n<li>with this question, I would like to explore if it is possible to (1) execute a specific application action that I expect to free a certain class (2) call garbage collector (3) iterate all classes via VM agent instrumentation to check if the class is still there or not.</li>\n</ul>\n",
    "tags" : [ "java", "garbage-collection" ],
    "owner" : {
      "account_id" : 1140418,
      "reputation" : 5946,
      "user_id" : 1124509,
      "user_type" : "registered",
      "accept_rate" : 53,
      "profile_image" : "https://i.sstatic.net/fhxGW.png?s=256",
      "display_name" : "Reto H&#246;hener",
      "link" : "https://stackoverflow.com/users/1124509/reto-h%c3%b6hener"
    },
    "is_answered" : true,
    "view_count" : 133,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1752025337,
    "creation_date" : 1751639454,
    "link" : "https://stackoverflow.com/questions/79690345/garbage-collector-or-flag-option-to-force-complete-collection-no-matter-how-lon",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79693604,
    "question_id" : 79690345,
    "body" : "<p>The answer to your question is No.  There is no GC option that will that will force &quot;complete collection&quot;.</p>\n<p>Even for Java GC's where <code>System.gc()</code> causes a &quot;full&quot; collection to occur synchronously, the call will return before the JVM has processed the finalization and reference queues.</p>\n<p>Even if you can get past the above, you still have the problem of sorting out the real memory leaks from the harmless artifacts in the application itself, and caused by your test framework and the tests themselves.</p>\n<hr />\n<p>Regression tests are not a good way to find memory leak problems.  Certainly, designing tests for memory leaks ahead of time is probably going to be a lot of effort for little return in terms of <em>actual</em> bugs found.</p>\n<p>IMO, you would be better off doing things like the following:</p>\n<ul>\n<li>Use a static code analyzer to pick up the low-hanging fruit; see <a href=\"https://stackoverflow.com/questions/37119336\">Can static analysis detect memory leaks?</a></li>\n<li>Build a comprehensive benchmark for your application, and run it for a few hours / days in the same JVM while monitoring heap usage trends.</li>\n<li>Create a pre-production installation of you application that runs against the production workload, and monitor heap usage trends.</li>\n<li>Perform a phased roll-out of changes to production.  For example, if you have a number of production server instances, deploy your new app version to a fraction of the instances and monitor them for a few hours before deploying to the remaining instances.</li>\n</ul>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1751942675,
    "last_activity_date" : 1752025337,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140565690,
    "post_id" : 79690345,
    "body" : "i.e. your question falls afoul of the X/Y principle. You X is &quot;I want to ensure a memory leak issue will not recur by writing a regression test but how do I do that&quot; and your Y is &quot;I know! I&#39;ll tell the GC to be perfect and then check total RAM load of the java process! But now I have questions about <i>that</i>&quot;. But Y is a bad solution to X. There are other, far superior answers. If truly you just want the regression test thing, ask <i>that</i>. Still commenting - just in case a more useful answer than &quot;there is no such option now and likely never will exist&quot; comes along.",
    "score" : 1,
    "owner" : {
      "account_id" : 401843,
      "reputation" : 107186,
      "user_id" : 768644,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b13bedc5215730fbce5edff6c130988a?s=256&d=identicon&r=PG",
      "display_name" : "rzwitserloot",
      "link" : "https://stackoverflow.com/users/768644/rzwitserloot"
    },
    "creation_date" : 1751651096,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565686,
    "post_id" : 79690345,
    "body" : "You&#39;re skipping steps. You&#39;ve gone straight from &#39;is collectable&#39; to &#39;must be collected&#39;. For the purposes of memory leak tests, you don&#39;t need that second step. You just want to know if the total amount of memory required to store everything that isn&#39;t collectable doesn&#39;t go up / remains within a set limit. You can ask a VM to freeze and heapdump. You can then do such an analysis on the generated dump file. Voila - no need for such a garbage collector.",
    "score" : 2,
    "owner" : {
      "account_id" : 401843,
      "reputation" : 107186,
      "user_id" : 768644,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b13bedc5215730fbce5edff6c130988a?s=256&d=identicon&r=PG",
      "display_name" : "rzwitserloot",
      "link" : "https://stackoverflow.com/users/768644/rzwitserloot"
    },
    "creation_date" : 1751650984,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565679,
    "post_id" : 79690345,
    "body" : "I&#39;m pretty sure the answer is &#39;does not exist at all&#39;, and there&#39;s quite some words that can be spent explaining that, while your request seems quite simple, it is not. This is very lightly useful as an answer for the sole purpose of fortifying &quot;... and don&#39;t bother waiting for Oracle or somebody else to write such a thing&quot; as well as &quot;... I would advise against solving your problems by writing such a garbage collector yourself&quot;. I&#39;m not quite enough of an expert to dare write such an answer, though.",
    "score" : 2,
    "owner" : {
      "account_id" : 401843,
      "reputation" : 107186,
      "user_id" : 768644,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b13bedc5215730fbce5edff6c130988a?s=256&d=identicon&r=PG",
      "display_name" : "rzwitserloot",
      "link" : "https://stackoverflow.com/users/768644/rzwitserloot"
    },
    "creation_date" : 1751650883,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565464,
    "post_id" : 79690345,
    "body" : "@LMC thanks for the tip, I will read up on this option and try it!",
    "score" : 0,
    "owner" : {
      "account_id" : 1140418,
      "reputation" : 5946,
      "user_id" : 1124509,
      "user_type" : "registered",
      "accept_rate" : 53,
      "profile_image" : "https://i.sstatic.net/fhxGW.png?s=256",
      "display_name" : "Reto H&#246;hener",
      "link" : "https://stackoverflow.com/users/1124509/reto-h%c3%b6hener"
    },
    "creation_date" : 1751644065,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140565438,
    "post_id" : 79690345,
    "body" : "Wouldn&#39;t <code>-XX:+UseSerialGC -XX:MinHeapFreeRatio=70 -XX:MaxHeapFreeRatio=70</code> be a hard condition to meet? Or try MinHeapFreeRatio until the JMV complains that it&#39;s not possible,",
    "score" : 1,
    "owner" : {
      "account_id" : 3377022,
      "reputation" : 14393,
      "user_id" : 2834978,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ff9af10001f37bc0de566ca2caf2f558?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "LMC",
      "link" : "https://stackoverflow.com/users/2834978/lmc"
    },
    "creation_date" : 1751643531,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79693604" : [ {
      "comment_id" : 140574499,
      "post_id" : 79693604,
      "body" : "@RetoH&#246;hener Analyzing heap dumps of the OOM and previous is the way to identify leaks.",
      "score" : 0,
      "owner" : {
        "account_id" : 372682,
        "reputation" : 26512,
        "user_id" : 721855,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/vZiox.png?s=256",
        "display_name" : "aled",
        "link" : "https://stackoverflow.com/users/721855/aled"
      },
      "creation_date" : 1751995816,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140573838,
      "post_id" : 79693604,
      "body" : "@RetoH&#246;hener The defaults are already as deterministic as feasible. When your code has a memory leak, repeated execution will fail eventually. When encountering an <code>OutOfMemoryError</code>, the JVM already tried everything it can, to prevent this. There might be cases where this does not imply that all eligible objects were collected, however, in those cases you still have a problem that needs to be addressed. It wouldnâ€™t be helpful if the garbage collector reclaimed more memory during testing than in the production environment.",
      "score" : 1,
      "owner" : {
        "account_id" : 3211603,
        "reputation" : 300981,
        "user_id" : 2711488,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
        "display_name" : "Holger",
        "link" : "https://stackoverflow.com/users/2711488/holger"
      },
      "creation_date" : 1751981811,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140573000,
      "post_id" : 79693604,
      "body" : "Thanks for looking into it. We already have OOM crashes, and we&#39;re already trying to fix the low hanging fruit. We&#39;re building comprehensive test suites that fail eventually if we have memory leaks. I am investigating additional approaches that can identify problems more quickly (even if they miss some problems). System.gc() is already probably good enough if we only get false positives every few weeks. I am just always looking for ways to make it faster and even more deterministic.",
      "score" : 0,
      "owner" : {
        "account_id" : 1140418,
        "reputation" : 5946,
        "user_id" : 1124509,
        "user_type" : "registered",
        "accept_rate" : 53,
        "profile_image" : "https://i.sstatic.net/fhxGW.png?s=256",
        "display_name" : "Reto H&#246;hener",
        "link" : "https://stackoverflow.com/users/1124509/reto-h%c3%b6hener"
      },
      "creation_date" : 1751966210,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}