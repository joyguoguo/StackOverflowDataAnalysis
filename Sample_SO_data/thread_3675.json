{
  "question" : {
    "question_id" : 79532406,
    "title" : "query when HttpSession expires, without extending the session",
    "body" : "<p>I would like to create an endpoint/servlet in tomcat to expose the state of an HttpSession -- basically how long until it expires -- for the sake of giving the user a <strong>warning</strong> that they will be logged out soon. (It would be called queried from javascript on the client, in order to determine if a warning should be given.)</p>\n<p>However, merely calling <code>request.getSession(false)</code> extends the session to its full time, making the call pointless.</p>\n<p>How can I discover the state of the session without having it count as &quot;activity&quot; on the session?</p>\n<p>Keeping track with a client-side timer is failing us, as users often open more than one tab to the application, which extends the session through activity, making the timer incorrect.</p>\n",
    "tags" : [ "java", "tomcat", "httpsession" ],
    "owner" : {
      "account_id" : 1655672,
      "reputation" : 151,
      "user_id" : 1525311,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/MP1D3.png?s=256",
      "display_name" : "Mumonkan",
      "link" : "https://stackoverflow.com/users/1525311/mumonkan"
    },
    "is_answered" : true,
    "view_count" : 48,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1742866889,
    "creation_date" : 1742860605,
    "link" : "https://stackoverflow.com/questions/79532406/query-when-httpsession-expires-without-extending-the-session",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79532521,
    "question_id" : 79532406,
    "body" : "<p>The servlet uses Tomcat's internal <strong><code>Manager</code></strong> and <strong><code>Session</code></strong> classes to retrieve session metadata without updating the last accessed time. The session ID is obtained directly from the cookie to avoid creating a new session via <strong><code>request.getSession()</code></strong></p>\n<pre><code>import org.apache.catalina.Manager;\nimport org.apache.catalina.Session;\nimport javax.servlet.annotation.WebServlet;\nimport javax.servlet.http.*;\nimport java.io.IOException;\n\n@WebServlet(&quot;/session-expiry&quot;)\npublic class SessionExpiryServlet extends HttpServlet {\n\n    @Override\n    protected void doGet(HttpServletRequest request, HttpServletResponse response) throws IOException {\n        // Get the session ID from the cookie without creating a new session\n        String sessionId = getSessionIdFromCookie(request);\n        if (sessionId == null) {\n            respondWithNoSession(response);\n            return;\n        }\n\n        // Access Tomcat's Manager to retrieve session metadata\n        Manager manager = getTomcatManager(request);\n        if (manager == null) {\n            respondWithError(response, &quot;Not running on Tomcat&quot;);\n            return;\n        }\n\n        Session tomcatSession = manager.findSession(sessionId);\n        if (tomcatSession == null) {\n            respondWithSessionExpired(response);\n            return;\n        }\n\n        // Calculate remaining time without touching the session's last access\n        long remainingTime = calculateRemainingTime(tomcatSession);\n        sendResponse(response, remainingTime);\n    }\n\n    private String getSessionIdFromCookie(HttpServletRequest request) {\n        String cookieName = request.getServletContext().getSessionCookieConfig().getName();\n        Cookie[] cookies = request.getCookies();\n        if (cookies != null) {\n            for (Cookie cookie : cookies) {\n                if (cookie.getName().equals(cookieName)) {\n                    return cookie.getValue();\n                }\n            }\n        }\n        return null;\n    }\n\n    private Manager getTomcatManager(HttpServletRequest request) {\n        try {\n            return ((org.apache.catalina.core.ApplicationContext) request.getServletContext()).getManager();\n        } catch (ClassCastException e) {\n            return null; // Not running on Tomcat\n        }\n    }\n\n    private long calculateRemainingTime(Session session) {\n        long lastAccessed = session.getLastAccessedTime();\n        int maxInactive = session.getMaxInactiveInterval() * 1000; // Convert seconds to ms\n        long currentTime = System.currentTimeMillis();\n        return (lastAccessed + maxInactive) - currentTime;\n    }\n  \n\n    private void sendResponse(HttpServletResponse response, long remainingTime) throws IOException {\n        response.setContentType(&quot;text/plain&quot;);\n        response.getWriter().print(remainingTime);\n    }\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 40962313,
      "reputation" : 11,
      "user_id" : 30049285,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/47dfafe4fab32637e21b3d636b01a088?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "luoberto",
      "link" : "https://stackoverflow.com/users/30049285/luoberto"
    },
    "creation_date" : 1742866889,
    "last_activity_date" : 1742866889,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79532521" : [ {
      "comment_id" : 140259221,
      "post_id" : 79532521,
      "body" : "This does seem to be getting the session, however, it seems like the <code>findSession()</code> also updates the lastAccessTime due to <code>session.access()</code> being called, I believe. It seems like this is where that is happening: <a href=\"https://github.com/apache/tomcat/blob/main/java/org/apache/catalina/session/PersistentManagerBase.java#L375\" rel=\"nofollow noreferrer\">github.com/apache/tomcat/blob/main/java/org/apache/catalina/&zwnj;&#8203;&hellip;</a>  I am now trying to see if I can work around this somehow.",
      "score" : 0,
      "owner" : {
        "account_id" : 1655672,
        "reputation" : 151,
        "user_id" : 1525311,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/MP1D3.png?s=256",
        "display_name" : "Mumonkan",
        "link" : "https://stackoverflow.com/users/1525311/mumonkan"
      },
      "creation_date" : 1742875521,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}