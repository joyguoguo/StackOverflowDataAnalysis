{
  "question" : {
    "question_id" : 79815248,
    "title" : "Stack overflow when collecting indirect object keys from recursive PDF structures in Apache PDFBox (PDFBox 3.0.5)",
    "body" : "<p>I'm using the Apache PDFBox library to process PDF files and am encountering a StackOverflowError due to circular references in the PDF structure. The error occurs when PDFBox tries to traverse the COS tree. It used to work fine with PDFBox 3.0.0, getting this error since 3.0.1</p>\n<p>Reproducible example:</p>\n<pre class=\"lang-java prettyprint-override\"><code>PDDocument document = new PDDocument();\nPDPage page = new PDPage(PDRectangle.A4);\n// Create AcroForm\nPDAcroForm acroForm = new PDAcroForm(document);\ndocument.getDocumentCatalog().setAcroForm(acroForm);\n\n// Create a single text field\nPDTextField textField = new PDTextField(acroForm);\ntextField.setPartialName(&quot;testField&quot;);\nPDAnnotationWidget widget = textField.getWidgets().get(0);\nwidget.setRectangle(new PDRectangle(100, 700, 200, 20));\nwidget.setPage(page);\npage.getAnnotations().add(widget);\nacroForm.getFields().add(textField);\n\n// Adding page AFTER creating form fields causes StackOverflowError\ndocument.addPage(page);\n\ndocument.save(&quot;output.pdf&quot;);\ndocument.close();\n</code></pre>\n<p>Environment:<br />\nPDFBox version: 3.0.5</p>\n<pre class=\"lang-none prettyprint-override\"><code>java.lang.StackOverflowError\n    at org.apache.pdfbox.cos.COSDictionary.getIndirectObjectKeys(COSDictionary.java:1495)\n    at org.apache.pdfbox.cos.COSDictionary.getIndirectObjectKeys(COSDictionary.java:1490)\n    at org.apache.pdfbox.cos.COSArray.getIndirectObjectKeys(COSArray.java:842)\n    at org.apache.pdfbox.cos.COSDictionary.getIndirectObjectKeys(COSDictionary.java:1495)\n    at org.apache.pdfbox.cos.COSDictionary.getIndirectObjectKeys(COSDictionary.java:1490)\n    at org.apache.pdfbox.cos.COSArray.getIndirectObjectKeys(COSArray.java:842)\n    [repeating pattern...]\n</code></pre>\n",
    "tags" : [ "java", "pdf-generation", "pdfbox" ],
    "owner" : {
      "account_id" : 11146382,
      "reputation" : 380,
      "user_id" : 8180996,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/rqc5MYkZ.jpg?s=256",
      "display_name" : "Kiran Kandel",
      "link" : "https://stackoverflow.com/users/8180996/kiran-kandel"
    },
    "is_answered" : false,
    "view_count" : 114,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1762797383,
    "creation_date" : 1762755177,
    "link" : "https://stackoverflow.com/questions/79815248/stack-overflow-when-collecting-indirect-object-keys-from-recursive-pdf-structure",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140849858,
    "post_id" : 79815248,
    "body" : "@KiranKandel, thanks for the report. We&#39;ll fix that, so that the order of the code doesn&#39;t matters anymore, see <a href=\"https://issues.apache.org/jira/browse/PDFBOX-6097\" rel=\"nofollow noreferrer\">issues.apache.org/jira/browse/PDFBOX-6097</a>",
    "score" : 1,
    "owner" : {
      "account_id" : 3685504,
      "reputation" : 21,
      "user_id" : 3069341,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/33987b0d68f94a277d8994ce1e16e3b8?s=256&d=identicon&r=PG",
      "display_name" : "Lehmi",
      "link" : "https://stackoverflow.com/users/3069341/lehmi"
    },
    "creation_date" : 1762931730,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140847798,
    "post_id" : 79815248,
    "body" : "Thank you for the help! Really appreciate your quick response. I will try to add the page early.",
    "score" : 0,
    "owner" : {
      "account_id" : 11146382,
      "reputation" : 380,
      "user_id" : 8180996,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/rqc5MYkZ.jpg?s=256",
      "display_name" : "Kiran Kandel",
      "link" : "https://stackoverflow.com/users/8180996/kiran-kandel"
    },
    "creation_date" : 1762830947,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846622,
    "post_id" : 79815248,
    "body" : "I&#39;ve made a posting here: <a href=\"https://lists.apache.org/thread/vx6837g1yj0zxr88odzzkz22p5dr0zdl\" rel=\"nofollow noreferrer\">lists.apache.org/thread/vx6837g1yj0zxr88odzzkz22p5dr0zdl</a>",
    "score" : 1,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19199,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1762774223,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846616,
    "post_id" : 79815248,
    "body" : "ok, what I think happens is that at this moment everything created is direct objects, and it links back to the page itself thus the (correct) circular reference. I&#39;m not yet sure what to do: just change the documentation or somehow detect whether a new page was created locally. I&#39;ll discuss this with the other devs. In the meantime, add the page early, or is there a reason to add it late?",
    "score" : 1,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19199,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1762773629,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846575,
    "post_id" : 79815248,
    "body" : "@TilmanHausherr Sorry, my mistake, the first addPage call should have been commented out. I meant to show that it works when the page is added beforehand, and that it throws a StackOverflow error when the page is added after adding the AcroForm.",
    "score" : 0,
    "owner" : {
      "account_id" : 11146382,
      "reputation" : 380,
      "user_id" : 8180996,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/rqc5MYkZ.jpg?s=256",
      "display_name" : "Kiran Kandel",
      "link" : "https://stackoverflow.com/users/8180996/kiran-kandel"
    },
    "creation_date" : 1762771452,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846520,
    "post_id" : 79815248,
    "body" : "Hey @TilmanHausherr, thank you for the help. Creating an MRE, as you suggested, helped me pinpoint the issue; it happens when a page is added after adding any AcroForm element. addPage -&gt; setHighestImportedObjectNumber -&gt; getIndirectObjectKeys.",
    "score" : 0,
    "owner" : {
      "account_id" : 11146382,
      "reputation" : 380,
      "user_id" : 8180996,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/rqc5MYkZ.jpg?s=256",
      "display_name" : "Kiran Kandel",
      "link" : "https://stackoverflow.com/users/8180996/kiran-kandel"
    },
    "creation_date" : 1762769498,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846429,
    "post_id" : 79815248,
    "body" : "I looked at the code for <code>getIndirectObjectKeys()</code> and it says &quot;Expert use only. You might run into an endless recursion if choosing a wrong starting point.&quot; You&#39;re really in the danger zone. Did this happen when using a tool or did you call that method yourself?",
    "score" : 2,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19199,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1762766279,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140846396,
    "post_id" : 79815248,
    "body" : "Please include code and a link to the problematic PDF. I realize you made the JIRA subscription so this may be frustrating. I&#39;ll try to help.",
    "score" : 1,
    "owner" : {
      "account_id" : 255529,
      "reputation" : 19199,
      "user_id" : 535646,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/yGyps.jpg?s=256",
      "display_name" : "Tilman Hausherr",
      "link" : "https://stackoverflow.com/users/535646/tilman-hausherr"
    },
    "creation_date" : 1762765278,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}