{
  "question" : {
    "question_id" : 79810381,
    "title" : "Why do I need an IvParameter and how do I implement it?",
    "body" : "<p>I'm trying to write a java program that encrypts and decrypts a byte array of text based on a password, but when decrypting, it returns an error</p>\n<p>Error message:</p>\n<pre><code>Exception in thread &quot;main&quot; java.security.InvalidAlgorithmParameterException: Wrong parameter type: IvParameterSpec expected\n        at java.base/sun.security.util.PBEUtil$PBES2Params.initialize(Unknown Source)\n        at java.base/sun.security.util.PBEUtil$PBES2Params.getPBEKeySpec(Unknown Source)\n        at java.base/com.sun.crypto.provider.PBES2Core.engineInit(Unknown Source)\n        at java.base/javax.crypto.Cipher.implInit(Unknown Source)\n        at java.base/javax.crypto.Cipher.chooseProvider(Unknown Source)\n        at java.base/javax.crypto.Cipher.init(Unknown Source)\n        at java.base/javax.crypto.Cipher.init(Unknown Source)\n        at edu.ntnu.idi.idat.encryption.Encryption.decrypt(Encryption.java:130)\n        at edu.ntnu.idi.idat.App.main(App.java:117)\n</code></pre>\n<p>I'm not really sure where the IvParameterSpec is supposed to go, why it's needed or how I should make it.</p>\n<p>The offending code:</p>\n<pre><code>    private final SecretKey passwordKey;\n    private PBEParameterSpec pbeParamSpec;\n    public Encryption(\n        final String password\n        ) throws NoSuchAlgorithmException, InvalidKeySpecException {\n            \n        byte[] salt = {\n            (byte)0xc7, (byte)0x73, (byte)0x21, (byte)0x8c,\n            (byte)0x7e, (byte)0xc8, (byte)0xee, (byte)0x99\n        };\n        int iteration = 20;\n        this.pbeParamSpec = new PBEParameterSpec(salt, iteration);\n\n        PBEKeySpec pbeKeySpec = new PBEKeySpec(\n            password.toCharArray()\n            );\n        SecretKeyFactory keyFac = SecretKeyFactory.getInstance(\n            &quot;PBEWithHmacSHA256AndAES_128&quot;\n            );\n        SecretKey pbeKey = keyFac.generateSecret(pbeKeySpec);\n        this.passwordKey = pbeKey;\n\n    public byte[] encrypt(\n        final byte[] plainText\n        ) throws NoSuchAlgorithmException,\n        NoSuchPaddingException,\n        InvalidKeyException,\n        IllegalBlockSizeException,\n        BadPaddingException, InvalidAlgorithmParameterException {\n        Cipher cipher = Cipher.getInstance(&quot;PBEWithHmacSHA256AndAES_128&quot;);\n        cipher.init(Cipher.ENCRYPT_MODE, this.passwordKey, this.pbeParamSpec);\n        return cipher.doFinal(plainText);\n    }\n\n    public byte[] decrypt(\n        final byte[] cipherText\n        ) throws NoSuchAlgorithmException,\n        NoSuchPaddingException,\n        InvalidKeyException,\n        IllegalBlockSizeException,\n        BadPaddingException, InvalidAlgorithmParameterException {\n        Cipher cipher = Cipher.getInstance(&quot;PBEWithHmacSHA256AndAES_128&quot;);\n        cipher.init(Cipher.DECRYPT_MODE, this.passwordKey, this.pbeParamSpec);\n        return cipher.doFinal(cipherText);\n    }\n</code></pre>\n<p>I originally tried without PBEParameterSpec, but I got an error, so I caved in and added it. From my understanding, the PBEParameterSpec object contains all information about salting and stuff, which should be all that the decryption step needs, so why would it need additional information about initiation vectors?</p>\n",
    "tags" : [ "java", "encryption", "aes", "encryption-symmetric", "javax.crypto" ],
    "owner" : {
      "account_id" : 37604239,
      "reputation" : 105,
      "user_id" : 28332552,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5a84dbd7a917124e895a66d1b7b38d61?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Lucy",
      "link" : "https://stackoverflow.com/users/28332552/lucy"
    },
    "is_answered" : true,
    "view_count" : 166,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1762370928,
    "creation_date" : 1762362142,
    "link" : "https://stackoverflow.com/questions/79810381/why-do-i-need-an-ivparameter-and-how-do-i-implement-it",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79810502,
    "question_id" : 79810381,
    "body" : "<p>The <code>String transformation</code> argument given to <code>getInstance</code> static method of the <code>Cipher</code> class must be in the form specified by the <em>Java Security Standard Algorithm Names Specification</em> (this is stated in the documentation of that method). See the <em>Cipher Algorithms</em> section in this case. For example, for Java version 21 the link to that section is <a href=\"https://docs.oracle.com/en/java/javase/21/docs/specs/security/standard-names.html#cipher-algorithms\" rel=\"nofollow noreferrer\">here</a>.</p>\n<p>From there it can be seen that you are using the <code>PBEWith&lt;digest&gt;And&lt;encryption&gt;</code> variant, which (according to the <em>Description</em> column) refers to the <a href=\"https://tools.ietf.org/html/rfc8018\" rel=\"nofollow noreferrer\"><em>PKCS #5: Password-Based Cryptography Specification, Version 2.1</em> (RFC 8018)</a>. The <em>Description</em> column contains as an example the exact algorithm you are using (<code>&quot;PBEWithHmacSHA256AndAES_128&quot;</code>) and states that it refers to the PBES2 password-based encryption algorithm in the aformentioned specification. Note, for all <code>Cipher</code> variants it is documented that by not fully specifying algorithm, mode and padding, then &quot;<em>the provider will use a default for the mode and padding</em>&quot;.</p>\n<p>PBES2 encryption and decryption operations are defined in <a href=\"https://datatracker.ietf.org/doc/html/rfc8018#section-6.2\" rel=\"nofollow noreferrer\">section 6.2</a> which states that they may require an IV depending on the encryption scheme used. Under supported encryption schemes, looking for AES, it seems it supports at most the CBC mode with padding (&quot;<em>at most</em>&quot; with respect to what is specified in that specific RFC version of course and as far as I understand) (<a href=\"https://datatracker.ietf.org/doc/html/rfc8018#appendix-B.2.5\" rel=\"nofollow noreferrer\">Appendix B.2.5</a>).</p>\n<p>So, based on the above, I assume CBC mode is used by default when given the variant you specified. I will move on with this assumption from now on.</p>\n<p>CBC mode requires an IV. But where is the IV in your <code>PBEParameterSpec</code>? You didn't specify one. The encryption succeeds though. So it seems to me at least that an IV was generated for you. Nevertheless I cannot find documentation wright now which states that the IV was generated, but you can see this IV with <code>cipher.getIV();</code>. Just call it after <code>cipher.init(...);</code>.</p>\n<p>Of course, the IV of the decryption operation must match the one in the corresponding encryption operation. Hence, you have (at least) the following two options here (assuming the transformation remains the same):</p>\n<ol>\n<li>Give your own IV on both encryption and decryption. You can specify it by using the 3 arguments' constructor of <code>PBEParameterSpec</code>, giving a <code>javax.crypto.spec.IvParameterSpec</code> as its third argument.</li>\n<li>Obtain the generated IV during encryption with <code>cipher.getIV();</code> and pass it on to decryption via a new <code>PBEParameterSpec</code>.</li>\n</ol>\n<h3>A few notes about the Initialization Vector (IV):</h3>\n<p>In CBC mode, each plain block is XORed with the previous encrypted block. The IV is used in order to be XORed with the first plain block. This means also that the size of the IV must be equal to the block size. The purpose is to produce a unique cipher text per encryption of the same plain text with the same key. To achieve this, use a different random IV per encryption operation. As far as I know, IVs do not need to be kept secret, but this may be wrong.</p>\n<hr />\n<p><strong>Note</strong>, I am not an expert on cryptographic primitives and in this answer I attempt to find clues of what is going wrong in the code, backing them up with some references. Although I believe some things are not entirely obvious in the documentation, which means that there may be small gaps in the logic of this answer, so I am posting this in order to ease the research towards the actual solution.</p>\n",
    "score" : 5,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 9059972,
      "reputation" : 3471,
      "user_id" : 6746785,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/3zi2O.png?s=256",
      "display_name" : "gthanop",
      "link" : "https://stackoverflow.com/users/6746785/gthanop"
    },
    "creation_date" : 1762369783,
    "last_activity_date" : 1762370928,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140839796,
    "post_id" : 79810381,
    "body" : "No, you have to implement concatenation and separation yourself.",
    "score" : 0,
    "owner" : {
      "account_id" : 12359353,
      "reputation" : 50593,
      "user_id" : 9014097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Y9EVM.jpg?s=256",
      "display_name" : "Topaco",
      "link" : "https://stackoverflow.com/users/9014097/topaco"
    },
    "creation_date" : 1762428704,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140839710,
    "post_id" : 79810381,
    "body" : "@Topaco Should I save the salt and IV at the start of the encrypted text, or is there a way to attach the PBEParameterSpec itself?",
    "score" : 0,
    "owner" : {
      "account_id" : 37604239,
      "reputation" : 105,
      "user_id" : 28332552,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5a84dbd7a917124e895a66d1b7b38d61?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Lucy",
      "link" : "https://stackoverflow.com/users/28332552/lucy"
    },
    "creation_date" : 1762425915,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140838463,
    "post_id" : 79810381,
    "body" : "You can pass the IV in the 3rd parameter of <code>PBEParameterSpec</code> via <code>IvParameterSpec</code>. Note that a hard-coded salt is a vulnerability. Instead, you should use a random salt and a random IV for each encryption!",
    "score" : 2,
    "owner" : {
      "account_id" : 12359353,
      "reputation" : 50593,
      "user_id" : 9014097,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Y9EVM.jpg?s=256",
      "display_name" : "Topaco",
      "link" : "https://stackoverflow.com/users/9014097/topaco"
    },
    "creation_date" : 1762366130,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140838436,
    "post_id" : 79810381,
    "body" : "Welcome to Stack Overflow. Please take the <a href=\"https://stackoverflow.com/tour\">tour</a> to learn how Stack Overflow works and read <a href=\"https://stackoverflow.com/questions/how-to-ask\">How to Ask</a> on how to improve the quality of your question. Then <a href=\"https://stackoverflow.com/posts/79810381/edit\">edit</a> your question to include your source code as a working <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, which can be compiled and tested by others to provide an answer faster. Your code is incomplete.",
    "score" : 0,
    "owner" : {
      "account_id" : 108033,
      "reputation" : 20099,
      "user_id" : 286934,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/f16a184d26b72795ff243464d715cffe?s=256&d=identicon&r=PG",
      "display_name" : "Progman",
      "link" : "https://stackoverflow.com/users/286934/progman"
    },
    "creation_date" : 1762365636,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79810502" : [ {
      "comment_id" : 140850024,
      "post_id" : 79810502,
      "body" : "It is complementary, not an error and the libraries are generally handle this. It is subtle point that random or psueodrandom is not enough. Consider that you use a _true random number generator (TRNG) to generate your next 100 IV&#39;s, they are still randomly generated, however, not secure in some scenarios.",
      "score" : 1,
      "owner" : {
        "account_id" : 899926,
        "reputation" : 5716,
        "user_id" : 1820553,
        "user_type" : "registered",
        "profile_image" : "https://lh4.googleusercontent.com/-NZb6uZzo4Gg/AAAAAAAAAAI/AAAAAAAAAo0/xTr6RvgMTRw/s256-rj/photo.jpg",
        "display_name" : "kelalaka",
        "link" : "https://stackoverflow.com/users/1820553/kelalaka"
      },
      "creation_date" : 1762939640,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140850000,
      "post_id" : 79810502,
      "body" : "@kelalaka Thank you for info. Although, I am not sure if your comment corrects something in my answer or it is only complementary information. I mean I cannot understand which part is wrong, based on your comment and link. Please clarify. I think (but not sure) you may be referring to the <i>randomness</i> part of the IV (since as far as I understand pseudorandomness can be predictable). Eitherway I think I should clarify in the answer that it is only a bird&#39;s eye view of the situation, and not a guide on how to securely use CBC (as much as it can be), which I believe should deserve its own posts.",
      "score" : 0,
      "owner" : {
        "account_id" : 9059972,
        "reputation" : 3471,
        "user_id" : 6746785,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/3zi2O.png?s=256",
        "display_name" : "gthanop",
        "link" : "https://stackoverflow.com/users/6746785/gthanop"
      },
      "creation_date" : 1762938784,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140849006,
      "post_id" : 79810502,
      "body" : "For CBC mode, if the data is not locally encrypted, then the <a href=\"https://crypto.stackexchange.com/q/3883/18298\">IV must be unpredictable</a>",
      "score" : 1,
      "owner" : {
        "account_id" : 899926,
        "reputation" : 5716,
        "user_id" : 1820553,
        "user_type" : "registered",
        "profile_image" : "https://lh4.googleusercontent.com/-NZb6uZzo4Gg/AAAAAAAAAAI/AAAAAAAAAo0/xTr6RvgMTRw/s256-rj/photo.jpg",
        "display_name" : "kelalaka",
        "link" : "https://stackoverflow.com/users/1820553/kelalaka"
      },
      "creation_date" : 1762881839,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}