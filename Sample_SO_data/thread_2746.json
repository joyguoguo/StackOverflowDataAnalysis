{
  "question" : {
    "question_id" : 79598141,
    "title" : "quarkus-websockets: Sec-WebSocket-Protocol subprotocol negotiation seems to be broken",
    "body" : "<p>When using <strong>quarkus-websockets-next</strong>, you can configure supported subprotocols and have Quarkus propagate the client’s <code>Sec-WebSocket-Protocol</code> header via:</p>\n<pre class=\"lang-yaml prettyprint-override\"><code>quarkus:\n  websockets-next:\n    server:\n      supported-subprotocols:\n        - token-carrier\n        - bearer-token-carrier\n      propagate-subprotocol-headers: true\n</code></pre>\n<p>We can make the request via JavaScript and it works:</p>\n<pre><code>const upgradeProto = encodeURIComponent(`quarkus-http-upgrade#Authorization#Bearer ${token}`);\nconst ws = new WebSocket(url, [&quot;openepcis-token-carrier&quot;, upgradeProto]);\n</code></pre>\n<p>As there are some still open issues related to <code>quarkus-websockets-next</code> I am using the old <code>quarkus-websockets</code>, Switching to the legacy quarkus-websockets (JSR-356) extension, no YAML/application.yml keys exist for subprotocols or header propagation. All your attempts results in automatic closure of the WebSocket when using the Sec-WebSocket-Protocol:</p>\n<pre><code>WebSocket connection to 'ws://…' failed\nCloseEvent { code: 1006, reason: &quot;&quot;, wasClean: false }\n</code></pre>\n<p>Following is the quarkus version I am using:</p>\n<pre><code>&lt;properties&gt;\n  &lt;quarkus.platform.version&gt;3.20.0&lt;/quarkus.platform.version&gt;\n&lt;/properties&gt;\n</code></pre>\n<p>Following is my implementation:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@ServerEndpoint(\n  value        = &quot;/queries/{queryName}/events&quot;,\n  configurator = QueriesWebSocketConfigurator.class,\n  subprotocols = {\n    &quot;token-carrier&quot;,   \n    &quot;quarkus-http-upgrade&quot;       \n  }\n)\n@ApplicationScoped\npublic class QueriesWebSocket { … }\n</code></pre>\n<p>Following is the JavaScript client request:</p>\n<pre><code>const token = &quot;&lt;JWT-Token&gt;&quot;;\nconst upgradeProto = encodeURIComponent(\n  `quarkus-http-upgrade#Authorization#Bearer ${token}`\n);\n//const upgradeProto = encodeURIComponent( `Authorization#Bearer ${token}` );\nconst ws = new WebSocket(\n  &quot;ws://localhost:8080/queries/TestQuery/events?stream=true&quot;,\n  [&quot;token-carrier&quot;, upgradeProto]\n);\n</code></pre>\n<p>I tried many things, but still unable to make it work. I can connect by passing the token as a query parameter: <code>wsURL + &quot;&amp;access_token&quot; + token</code>, but I want to use the <code>Sec-WebSocket-Protocol</code>. I am able to see from the browser Network tab that the request being sent contains the <code>sec-websocket-protocol:</code> with the proper token, but for some reason, the server seems to reject it.</p>\n<p>Is there a way to work with <code>Sec_WebSocket-Protocol</code> when using the <code>quarkus-websockets</code>?</p>\n<p>Following is the references:</p>\n<ul>\n<li><a href=\"https://quarkus.io/version/3.15/guides/websockets\" rel=\"nofollow noreferrer\">Quarkus WebSockets</a></li>\n<li><a href=\"https://github.com/quarkusio/quarkus/issues/39082\" rel=\"nofollow noreferrer\">Fixing issue with Sec-WebSocket-Protocol</a></li>\n<li><a href=\"https://github.com/quarkusio/quarkus-http/pull/143\" rel=\"nofollow noreferrer\">Fixing PR with Sec-WebSocket-Protocol</a></li>\n</ul>\n<p>Is this some issue with the <code>quarkus-websockets</code> or am I missing something here?</p>\n",
    "tags" : [ "java", "http", "websocket", "quarkus" ],
    "owner" : {
      "account_id" : 10278040,
      "reputation" : 3642,
      "user_id" : 7584240,
      "user_type" : "registered",
      "accept_rate" : 17,
      "profile_image" : "https://i.sstatic.net/9BMGL.jpg?s=256",
      "display_name" : "BATMAN_2008",
      "link" : "https://stackoverflow.com/users/7584240/batman-2008"
    },
    "is_answered" : false,
    "view_count" : 39,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1745922495,
    "creation_date" : 1745922495,
    "link" : "https://stackoverflow.com/questions/79598141/quarkus-websockets-sec-websocket-protocol-subprotocol-negotiation-seems-to-be-b",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}