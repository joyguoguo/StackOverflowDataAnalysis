{
  "question" : {
    "question_id" : 79652690,
    "title" : "Apache Camel route terminated early during pod scale-down due to in-flight shutdown timeout (HPA + parallel split processing)",
    "body" : "<p>I'm working on an Apache Camel-based Spring Boot application deployed in Kubernetes, where we consume files from an SFTP location, process the contents.\nThe issue occurs when processing a large file (e.g., 20,000 records) using a .split().parallelProcessing() strategy. Here's a simplified version of the route:</p>\n<pre><code>    from(&quot;sftp://my-server/path?options...&quot;)\n    .split()\n        .tokenizeXML(&quot;&lt;record&gt;&quot;, &quot;&lt;/record&gt;&quot;)\n        .streaming()\n        .parallelProcessing()\n        .process(myRecordProcessor)\n    .end();\n</code></pre>\n<p>We are using <strong>Horizontal Pod Autoscaling (HPA)</strong> in Kubernetes. At times, while the route is still processing a large file, the pod is terminated due to scale-down. We have configured the shutdown strategy using the default settings provided by Apache Camel:</p>\n<ul>\n<li><strong>Timeout:</strong> 300 seconds (5 minutes)</li>\n<li><strong>Shutdown Now On Timeout:</strong> true</li>\n<li><strong>Log Inflight Exchanges On Timeout:</strong> true</li>\n<li><strong>Shutdown Routes In Reverse Order:</strong> true\nThese are the default values for DefaultShutdownStrategy in Apache Camel versions 3.x.</li>\n</ul>\n<p><strong>Problem:</strong>\nWhen the pod is terminated (scaled down by HPA), Camel initiates shutdown. If the file is still being processed:</p>\n<ul>\n<li>Camel gives <strong>only 300 seconds</strong> to complete all in-flight exchanges.</li>\n<li>After 300s, it forcefully stops, resulting in <strong>incomplete file processing</strong> (only partial records are processed).</li>\n<li>This leads to <strong>data loss</strong>, as the rest of the records in the file are never processed.</li>\n</ul>\n<p><strong>What I've tried:</strong></p>\n<ul>\n<li>Iâ€™ve looked into increasing the shutdown timeout (setTimeout(600)), but this only delays the issue.</li>\n<li>HPA cannot differentiate between idle pods and those still processing a long file.</li>\n<li>The route uses .streaming().parallelProcessing(), making it harder to track individual record progress or checkpoint.</li>\n</ul>\n<p><strong>Expecting</strong></p>\n<ul>\n<li>Ensure graceful completion of in-flight exchanges</li>\n<li>Avoid data loss during pod shutdown</li>\n<li>Support long processing times for large files</li>\n</ul>\n",
    "tags" : [ "java", "spring-boot", "kubernetes", "apache-camel" ],
    "owner" : {
      "account_id" : 25868954,
      "reputation" : 1,
      "user_id" : 27850387,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/26ecbcb0a9cbbabf8ecfbd476340d49b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "sandeep",
      "link" : "https://stackoverflow.com/users/27850387/sandeep"
    },
    "is_answered" : false,
    "view_count" : 32,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1749185895,
    "creation_date" : 1749037573,
    "link" : "https://stackoverflow.com/questions/79652690/apache-camel-route-terminated-early-during-pod-scale-down-due-to-in-flight-shutd",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}