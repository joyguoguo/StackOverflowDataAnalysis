{
  "question" : {
    "question_id" : 79641971,
    "title" : "How do I implement a flow-controlled Netty pipeline with both a FlowControlHandler and HttpContentDecompressor?",
    "body" : "<p>Duplicating <a href=\"https://github.com/netty/netty/issues/15053\" rel=\"nofollow noreferrer\">https://github.com/netty/netty/issues/15053</a>:</p>\n<p>I'm trying to build a flow-controlled Netty pipeline with (amongst other things) a <code>FlowControlHandler</code> near the top and a <code>HttpContentDecompressor</code> lower down, but the resulting pipeline appears not to be properly flow-controlled in the sense that it emits several messages per call to <code>read()</code>. I've isolated the problem down to an unexpected interaction between <code>FlowControlHandler</code> and <code>HttpContentDecompressor</code>, reproduced in the following test in the Netty test suite:</p>\n<pre class=\"lang-none prettyprint-override\"><code>index d9f5cd5b8d..f8edf63a29 100644\n--- a/codec-http/src/test/java/io/netty/handler/codec/http/HttpContentDecompressorTest.java\n+++ b/codec-http/src/test/java/io/netty/handler/codec/http/HttpContentDecompressorTest.java\n@@ -20,6 +20,7 @@ import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.ChannelInboundHandlerAdapter;\n import io.netty.channel.ChannelOutboundHandlerAdapter;\n import io.netty.channel.embedded.EmbeddedChannel;\n+import io.netty.handler.flow.FlowControlHandler;\n import org.junit.jupiter.api.Test;\n\n import java.util.concurrent.atomic.AtomicInteger;\n@@ -70,4 +71,33 @@ public class HttpContentDecompressorTest {\n         assertEquals(2, readCalled.get());\n         assertFalse(channel.finishAndReleaseAll());\n     }\n+\n+    @Test\n+    public void testFlowController() {\n+        final AtomicInteger messagesEmitted = new AtomicInteger();\n+        final EmbeddedChannel channel = new EmbeddedChannel(\n+                new FlowControlHandler(),\n+                new HttpContentDecompressor(),\n+                new ChannelInboundHandlerAdapter() {\n+                    @Override\n+                    public void channelRead(ChannelHandlerContext ctx, Object msg) {\n+                        messagesEmitted.incrementAndGet();\n+                    }\n+                });\n+\n+        channel.config().setAutoRead(false);\n+\n+        final HttpResponse response = new DefaultHttpResponse(HttpVersion.HTTP_1_1, HttpResponseStatus.OK);\n+        response.headers().set(HttpHeaderNames.TRANSFER_ENCODING, HttpHeaderValues.CHUNKED);\n+\n+        assertFalse(channel.writeInbound(response));\n+        assertFalse(channel.writeInbound(new DefaultHttpContent(Unpooled.buffer(1))));\n+        assertFalse(channel.writeInbound(new DefaultHttpContent(Unpooled.buffer(1))));\n+\n+        assertEquals(1, messagesEmitted.get());\n+        channel.read();\n+        assertEquals(2, messagesEmitted.get());\n+        channel.read();\n+        assertEquals(3, messagesEmitted.get());\n+    }\n }\n</code></pre>\n<p>Specifically, with autoread disabled and a <code>FlowControlHandler</code> in place I would expect the pipeline to emit exactly one message per <code>read()</code> but in fact today it emits all three messages at once:</p>\n<pre><code>org.opentest4j.AssertionFailedError: \nExpected :1\nActual   :3\n&lt;Click to see difference&gt;\n\n    at org.junit.jupiter.api.AssertionFailureBuilder.build(AssertionFailureBuilder.java:151)\n    at org.junit.jupiter.api.AssertionFailureBuilder.buildAndThrow(AssertionFailureBuilder.java:132)\n    at org.junit.jupiter.api.AssertEquals.failNotEqual(AssertEquals.java:197)\n    at org.junit.jupiter.api.AssertEquals.assertEquals(AssertEquals.java:150)\n    at org.junit.jupiter.api.AssertEquals.assertEquals(AssertEquals.java:145)\n    at org.junit.jupiter.api.Assertions.assertEquals(Assertions.java:527)\n    at io.netty.handler.codec.http.HttpContentDecompressorTest.testFlowController(HttpContentDecompressorTest.java:97)\n...\n</code></pre>\n<p>This is happening because the <code>FlowControlHandler</code> <a href=\"https://github.com/netty/netty/blob/ae93d8c544387077fa831101b0c1737922f244f8/handler/src/main/java/io/netty/handler/flow/FlowControlHandler.java#L213\" rel=\"nofollow noreferrer\">fabricates its own <code>READ COMPLETE</code> messages</a> when it empties its queue, but also <a href=\"https://github.com/netty/netty/blob/ae93d8c544387077fa831101b0c1737922f244f8/handler/src/main/java/io/netty/handler/flow/FlowControlHandler.java#L170\" rel=\"nofollow noreferrer\">passes through</a> the <code>READ COMPLETE</code> message from upstream when its internal queue is empty, so the <code>HttpContentDecompressor</code> sees two <code>READ COMPLETE</code> events after processing the first <code>READ</code>. The first such event <a href=\"https://github.com/netty/netty/blob/e5951d46fc89db507ba7d2968d2ede26378f0b04/codec-http/src/main/java/io/netty/handler/codec/http/HttpContentDecoder.java#L191\" rel=\"nofollow noreferrer\">sets <code>HttpContentDecoder#needRead</code> to <code>true</code></a> and then the second of them <a href=\"https://github.com/netty/netty/blob/e5951d46fc89db507ba7d2968d2ede26378f0b04/codec-http/src/main/java/io/netty/handler/codec/http/HttpContentDecoder.java#L197\" rel=\"nofollow noreferrer\">triggers another <code>ctx.read()</code></a>.</p>\n<p>Unfortunately I'm not sure whether the problem is that <code>FlowControlHandler</code> emits two <code>READ COMPLETE</code> events in a row without any intervening <code>READ</code>, or if this is expected but <code>HttpContentDecoder</code> should be able to handle those events without triggering another <code>ctx.read()</code>, or indeed if this overall behaviour is expected and I'm just holding it wrong somehow.</p>\n<p>I expect one message per <code>read()</code> call in a flow-controlled pipeline. Either of these components on their own do so, but when combined they do not.</p>\n",
    "tags" : [ "java", "netty", "diff", "flow-control" ],
    "owner" : {
      "account_id" : 16642487,
      "reputation" : 166,
      "user_id" : 12027625,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AAuE7mDgZx-p0VYpKZONgU_6zmVT7Z5hW41JdP0WKgi4=k-s256",
      "display_name" : "David Turner",
      "link" : "https://stackoverflow.com/users/12027625/david-turner"
    },
    "is_answered" : false,
    "view_count" : 67,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1748426337,
    "creation_date" : 1748426337,
    "link" : "https://stackoverflow.com/questions/79641971/how-do-i-implement-a-flow-controlled-netty-pipeline-with-both-a-flowcontrolhandl",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}