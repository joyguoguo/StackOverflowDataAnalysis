{
  "question" : {
    "question_id" : 79564517,
    "title" : "keycloak-jakarta-servlet-filter-adapter not setting CORS on failed authentication response",
    "body" : "<p>My Jakarta web application is using keycloak-jakarta-servlet-filter-adapter to handle authentication from Keycloak.</p>\n<p>When the user is authenticated and has the required audience, CORS headers are well set to the preflight and actual responses.</p>\n<p>When the user is authenticated but does not have the required audience, the preflight response has CORS headers set, but not the actual response (the one with code 403).</p>\n<pre class=\"lang-none prettyprint-override\"><code>┌───────────────────────────────┐┌─────────────────────────────────┐ \n│ Token with required audience  ││ Token without required audience │ \n│                               ││                                 │ \n│            ┌────────────────┐ ││            ┌────────────────┐   │ \n│ ┌───────┐  │keycloak servlet│ ││ ┌───────┐  │keycloak servlet│   │ \n│ │Browser│  │filter adapter  │ ││ │Browser│  │filter adapter  │   │ \n│ └───┬───┘  └───────┬────────┘ ││ └───┬───┘  └───────┬────────┘   │ \n│     │              │          ││     │              │            │ \n│     │ OPTIONS     ┌┴┐         ││     │ OPTIONS     ┌┴┐           │ \n│     ├────────────►│ │         ││     ├────────────►│ │           │ \n│     │             │ │         ││     │             │ │           │ \n│     │  200 CORS   │ │         ││     │  200 CORS   │ │           │ \n│     │◄────────────┤ │         ││     │◄────────────┤ │           │ \n│     │             └┬┘         ││     │             └┬┘           │ \n│     │ GET         ┌┴┐         ││     │ GET         ┌┴┐           │ \n│     ├────────────►│ │         ││     ├────────────►│ │           │ \n│     │             │ │         ││     │             │ │           │ \n│     │    200 CORS │ │         ││     │ 403 no CORS │ │           │ \n│     │◄────────────┤ │         ││     │◄────────────┤ │           │ \n│     │             └┬┘         ││     │             └┬┘           │ \n└───────────────────────────────┘└─────────────────────────────────┘ \n</code></pre>\n<p>The problem is my frontend cannot handle the 403 response because the browser (tested on Chrome and Firefox) blocks the response because of the CORS policy, what I understand and accept.</p>\n<p>The keycloak filter set the CORS headers either in the method <code>PreAuthActionsHandler.preflightCors()</code> if the request method is <code>&quot;OPTIONS&quot;</code>:</p>\n<pre class=\"lang-none prettyprint-override\"><code>at org.keycloak.adapters.PreAuthActionsHandler.preflightCors()\nat org.keycloak.adapters.PreAuthActionsHandler.handleRequest()\nat org.keycloak.adapters.servlet.KeycloakOIDCFilter.doFilter()\n</code></pre>\n<p>or in the method <code>AuthenticatedActionsHandler.corsRequest()</code> if the token is authenticated :</p>\n<pre class=\"lang-none prettyprint-override\"><code>at org.keycloak.adapters.AuthenticatedActionsHandler.corsRequest()\nat org.keycloak.adapters.AuthenticatedActionsHandler.handledRequest()\nat org.keycloak.adapters.servlet.KeycloakOIDCFilter.doFilter()\n</code></pre>\n<ul>\n<li>Why the filter does not set CORS headers for 401 or 403 responses ?</li>\n<li>Is that a normal behavior ? <br/>\nIf so, how can I handle it in my frontend application ?</li>\n</ul>\n",
    "tags" : [ "java", "jakarta-ee", "cors", "keycloak" ],
    "owner" : {
      "account_id" : 8371967,
      "reputation" : 159,
      "user_id" : 6286793,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/756b8169fdd66036d7f0eb756df3f9b6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Calcimicium",
      "link" : "https://stackoverflow.com/users/6286793/calcimicium"
    },
    "is_answered" : true,
    "view_count" : 46,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1744274370,
    "creation_date" : 1744206722,
    "link" : "https://stackoverflow.com/questions/79564517/keycloak-jakarta-servlet-filter-adapter-not-setting-cors-on-failed-authenticatio",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79566139,
    "question_id" : 79564517,
    "body" : "<p>The filter is not the responsible ! It was a Keycloak configuration issue.</p>\n<h2>The Keycloak behavior</h2>\n<p>When you give the <code>uma_protection</code> role of a client to a user, the <code>roles</code> client scope automatically adds the client to the audience of access token through the <code>audience resolve</code> mapper.</p>\n<h2>My bad</h2>\n<p>To test the authorization I was removing the <code>uma_protection</code> role of the client from the user. Thus, the client was not added to the audience of the access token anymore.</p>\n<h2>The solution</h2>\n<p>The goal is to add the client to the audience of the access token.</p>\n<p>Don't know if other options are available, but the one that we chose is to create a client scope with a token mapper of type <code>Audience</code> having the client included :</p>\n<p><a href=\"https://i.sstatic.net/CdUAVdrkt.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/CdUAVdrkt.png\" alt=\"The Keycloak form for creating a client scope\" title=\"Keycloak - Create client scope\" /></a>\n<a href=\"https://i.sstatic.net/O9bfJ9O1t.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/O9bfJ9O1t.png\" alt=\"The Keycloak form for creating a mapper\" title=\"Keycloak - Create mapper\" /></a></p>\n<p>We then add this scope to each client that needs an access token allowed to request the first one:</p>\n<p><a href=\"https://i.sstatic.net/pBb6QGnft.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/pBb6QGnft.png\" alt=\"The Keycloak client scope tab of a client page\" title=\"Keycloak - Client scope tab\" /></a></p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 8371967,
      "reputation" : 159,
      "user_id" : 6286793,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/756b8169fdd66036d7f0eb756df3f9b6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Calcimicium",
      "link" : "https://stackoverflow.com/users/6286793/calcimicium"
    },
    "creation_date" : 1744274370,
    "last_activity_date" : 1744274370,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}