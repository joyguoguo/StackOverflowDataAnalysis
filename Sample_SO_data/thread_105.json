{
  "question" : {
    "question_id" : 79835509,
    "title" : "Unable to configure SSL Context For Open Feign Client. Getting PKIX Error",
    "body" : "<p>I am seeking to establish a mutual TLS (mTLS) connection between two of my Spring Boot applications: a Backend service and a Web service. For that reason, I have created keystores, certificates, and truststores.</p>\n<p>Here are my commands.</p>\n<pre class=\"lang-bash prettyprint-override\"><code>keytool -genkeypair -alias backend-service -keyalg RSA -keysize 2048 -validity 3650 -keystore backend-keystore.jks -storepass changeit -keypass changeit -ext SAN=dns:localhost,ip:127.0.0.1 -dname &quot;CN=backend, OU=TK, O=AYE, L=Dhaka, C=BD&quot;\nkeytool -genkeypair -alias web-service -keyalg RSA -keysize 2048 -validity 3650 -keystore web-keystore.jks -storepass changeit -keypass changeit -ext SAN=dns:localhost,ip:127.0.0.1 -dname &quot;CN=web, OU=TK, O=AYE, L=Dhaka, C=BD&quot;\nkeytool -exportcert -alias backend-service -keystore backend-keystore.jks -file backend-service.cer -storepass changeit\nkeytool -exportcert -alias web-service -keystore web-keystore.jks -file web-service.cer -storepass changeit\nkeytool -import -alias web-service -file &quot;D:\\projects\\springProjects\\AyeTKVehicleManagement\\web-service\\src\\main\\resources\\web-service.cer&quot; -keystore backend-truststore.jks -storepass changeit -noprompt\nkeytool -import -alias backend-service -file &quot;D:\\projects\\springProjects\\AyeTKVehicleManagement\\backend-service\\src\\main\\resources\\backend-service.cer&quot; -keystore web-truststore.jks -storepass changeit -noprompt\n</code></pre>\n<p><strong>Backend Application Properties file.</strong></p>\n<pre><code>server.port=8443\nserver.servlet.context-path=/aye-backend-service\nserver.ssl.enabled=true\nserver.ssl.key-store-type=PKCS12\nserver.ssl.key-store=classpath:backend-keystore.jks\nserver.ssl.key-store-password=changeit\nserver.ssl.key-alias=backend-service\nserver.ssl.key-password=changeit\nserver.ssl.trust-store=classpath:backend-truststore.jks\nserver.ssl.trust-store-password=changeit\nserver.ssl.trust-store-type=PKCS12\nserver.ssl.client-auth=need\n</code></pre>\n<p><strong>Web Application Properties file.</strong></p>\n<pre><code>server.servlet.context-path=/aye-web-service\nserver.port=8081\nserver.ssl.enabled=true\nserver.ssl.protocol=TLS\nserver.ssl.key-store-type=PKCS12\nserver.ssl.key-store=classpath:web-keystore.jks\nserver.ssl.key-store-password=changeit\nserver.ssl.key-alias=web-service\nserver.ssl.key-password=changeit\nserver.ssl.trust-store=classpath:web-truststore.jks\nserver.ssl.trust-store-password=changeit\nserver.ssl.trust-store-type=PKCS12\nspring.cloud.openfeign.http2client.enabled=true\n</code></pre>\n<p><strong>SSL Configuration for Open Feign</strong></p>\n<pre><code>@Configuration\npublic class ApacheHttp5FeignSslClientConfig {\n\n    @Bean\n    public Feign.Builder feignBuilder(\n            @Value(&quot;${server.ssl.protocol}&quot;) String protocol,\n            @Value(&quot;${server.ssl.key-store-type}&quot;) String keyStoreType,\n            @Value(&quot;${server.ssl.key-store}&quot;) String keyStore,\n            @Value(&quot;${server.ssl.key-store-password}&quot;) String keyStorePassword,\n            @Value(&quot;${server.ssl.key-password}&quot;) String keyPassword,\n            @Value(&quot;${server.ssl.trust-store}&quot;) String trustStore,\n            @Value(&quot;${server.ssl.trust-store-password}&quot;) String trustStorePassword\n\n    ) {\n        SSLContext sslContext = getSSLContext(protocol, keyStoreType, keyStore, keyStorePassword, keyPassword, trustStore, trustStorePassword);\n        SSLConnectionSocketFactory sslConnectionSocketFactory = SSLConnectionSocketFactoryBuilder.create().setSslContext(sslContext).build();\n        HttpClientConnectionManager connectionManager = PoolingHttpClientConnectionManagerBuilder.create().setSSLSocketFactory(sslConnectionSocketFactory).build();\n        return Feign.builder()\n                .retryer(Retryer.NEVER_RETRY)\n                .client(new ApacheHttp5Client(HttpClients.custom()\n                        .setConnectionManager(connectionManager)\n                        .build()));\n    }\n\n    private SSLContext getSSLContext(String protocol, String keyStoreType,\n                                     String keyStore, String keyStorePassword, String keyPassword,\n                                     String trustStore, String trustStorePassword) {\n        try {\n            // Load key store\n            KeyStore keyStoreObj = KeyStore.getInstance(keyStoreType);\n            try (FileInputStream keyStoreStream = new FileInputStream(ResourceUtils.getFile(keyStore))) {\n                keyStoreObj.load(keyStoreStream, keyStorePassword.toCharArray());\n            }\n\n            // Load trust store\n            KeyStore trustStoreObj = KeyStore.getInstance(keyStoreType);\n            try (FileInputStream trustStoreStream = new FileInputStream(ResourceUtils.getFile(trustStore))) {\n                trustStoreObj.load(trustStoreStream, trustStorePassword.toCharArray());\n            }\n\n            // Create key manager factory\n            KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(\n                    KeyManagerFactory.getDefaultAlgorithm());\n            keyManagerFactory.init(keyStoreObj, keyPassword.toCharArray());\n\n            // Create trust manager factory\n            TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(\n                    TrustManagerFactory.getDefaultAlgorithm());\n            trustManagerFactory.init(trustStoreObj);\n\n            // Create SSL context\n            SSLContext sslContext = SSLContext.getInstance(protocol);\n            sslContext.init(keyManagerFactory.getKeyManagers(),\n                    trustManagerFactory.getTrustManagers(), new SecureRandom());\n\n            return sslContext;\n\n        } catch (Exception e) {\n            log.error(&quot;Error while building SSLContext for ApacheHttp5FeignSslClient&quot;, e);\n            throw new RuntimeException(&quot;Error while building SSLContext&quot;, e);\n        }\n    }\n\n\n}\n</code></pre>\n<p><strong>Feign Client</strong></p>\n<pre><code>@FeignClient(name = &quot;StepServiceFeignClient&quot;,\n        url = &quot;${backend.service.url}${backend.service.steps.prefix}&quot;,\n        configuration = ApacheHttp5FeignSslClientConfig.class)\npublic interface StepServiceFeignClient {}\n</code></pre>\n<p>When trying to call backend api from web service using open feign client it is throwing error i am unable understand the point of failure.</p>\n<p>threw exception</p>\n<pre class=\"lang-none prettyprint-override\"><code>[Request processing failed: feign.RetryableException: PKIX path building failed:\n  sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target executing GET https://localhost:8443/aye-backend-service/api/steps?size=20&amp;page=0] with root cause\n  sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "ssl", "jks", "openfeign" ],
    "owner" : {
      "account_id" : 18214005,
      "reputation" : 45,
      "user_id" : 13255966,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a-/AOh14Gj3ig1jfNvNLNc-AUAhnGMEAXgZ9999Z5f2zQzC=k-s256",
      "display_name" : "Miraj Hossain Shawon",
      "link" : "https://stackoverflow.com/users/13255966/miraj-hossain-shawon"
    },
    "is_answered" : false,
    "view_count" : 27,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1764703143,
    "creation_date" : 1764653378,
    "link" : "https://stackoverflow.com/questions/79835509/unable-to-configure-ssl-context-for-open-feign-client-getting-pkix-error",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}