{
  "question" : {
    "question_id" : 79590249,
    "title" : "ActiveMQ Artemis JMS client stuck in LargeMessageControllerImpl.waitCompletion",
    "body" : "<p>We have a Java application consuming messages from a queue on ActiveMQ Artemis 2.39.0. The application is using the Core JMS client version 2.19.1, and it gets stuck without any error messages. Analysing the stack, I realised it is stuck in the <code>LargeMessageControllerImpl.waitCompletion</code> method with the thread state 'TIMED_WAITING'. The messages are not big (150-700KB), but there are a lot of them (262750). The client is stuck for hours. When I restart it it processes some messages in the queue but gets stuck again when trying to process one large message.</p>\n<p>Do you have any idea why it could get stuck there?</p>\n<p>Here is the full stack for this thread:</p>\n<pre><code>&quot;org.springframework.jms.JmsListenerEndpointContainer#0-2&quot; #60 prio=5 os_prio=0 cpu=1009.98ms elapsed=855.18s tid=0x00007f27ba6a51c0 nid=0xd678a in Object.wait()  [0x00007f270f5fa000]\n   java.lang.Thread.State: TIMED_WAITING (on object monitor)\n        at java.lang.Object.wait(java.base@17.0.13/Native Method)\n        - waiting on &lt;no object reference available&gt;\n        at org.apache.activemq.artemis.core.client.impl.LargeMessageControllerImpl.waitCompletion(LargeMessageControllerImpl.java:294)\n        - locked &lt;0x000000070f64f948&gt; (a org.apache.activemq.artemis.core.client.impl.LargeMessageControllerImpl)\n        at org.apache.activemq.artemis.core.client.impl.LargeMessageControllerImpl.saveBuffer(LargeMessageControllerImpl.java:268)\n        - locked &lt;0x000000070f64f948&gt; (a org.apache.activemq.artemis.core.client.impl.LargeMessageControllerImpl)\n        at org.apache.activemq.artemis.core.client.impl.ClientLargeMessageImpl.checkBuffer(ClientLargeMessageImpl.java:157)\n        at org.apache.activemq.artemis.core.client.impl.ClientLargeMessageImpl.checkCompletion(ClientLargeMessageImpl.java:82)\n        at org.apache.activemq.artemis.jms.client.ActiveMQMessage.doBeforeReceive(ActiveMQMessage.java:799)\n        at org.apache.activemq.artemis.jms.client.ActiveMQTextMessage.doBeforeReceive(ActiveMQTextMessage.java:104)\n        at org.apache.activemq.artemis.jms.client.ActiveMQMessageConsumer.getMessage(ActiveMQMessageConsumer.java:230)\n        at org.apache.activemq.artemis.jms.client.ActiveMQMessageConsumer.receive(ActiveMQMessageConsumer.java:134)\n        at org.springframework.jms.support.destination.JmsDestinationAccessor.receiveFromConsumer(JmsDestinationAccessor.java:132)\n        at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveMessage(AbstractPollingMessageListenerContainer.java:431)\n        at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.doReceiveAndExecute(AbstractPollingMessageListenerContainer.java:316)\n        at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveAndExecute(AbstractPollingMessageListenerContainer.java:270)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1237)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.executeOngoingLoop(DefaultMessageListenerContainer.java:1227)\n        at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:1120)\n        at java.lang.Thread.run(java.base@17.0.13/Thread.java:840)\n</code></pre>\n",
    "tags" : [ "java", "activemq-artemis" ],
    "owner" : {
      "account_id" : 2279994,
      "reputation" : 21,
      "user_id" : 2005317,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2dd090851cfd3c1ba556708db5160e2a?s=256&d=identicon&r=PG",
      "display_name" : "user2005317",
      "link" : "https://stackoverflow.com/users/2005317/user2005317"
    },
    "is_answered" : true,
    "view_count" : 93,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1745507289,
    "creation_date" : 1745487323,
    "link" : "https://stackoverflow.com/questions/79590249/activemq-artemis-jms-client-stuck-in-largemessagecontrollerimpl-waitcompletion",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79590930,
    "question_id" : 79590249,
    "body" : "<p>I think you may be hitting <a href=\"https://issues.apache.org/jira/browse/ARTEMIS-3809\" rel=\"nofollow noreferrer\">ARTEMIS-3809</a> so I would definitely recommend a client upgrade to at least 2.29.0 although moving to <a href=\"https://activemq.apache.org/components/artemis/download/\" rel=\"nofollow noreferrer\">the latest</a> (i.e. 2.40.0 at the moment) for both the broker and the client would be ideal.</p>\n<p>If you can't upgrade the client for whatever reason (e.g. you're stuck on Java 8) then you can always back-port the fix and build the client yourself. It's a <a href=\"https://github.com/apache/activemq-artemis/commit/1d4139f278\" rel=\"nofollow noreferrer\">one-line fix</a> so it would be very simple to back-port, e.g.:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>$ git clone git@github.com:apache/activemq-artemis.git\n$ git checkout 2.19.1\n$ git cherry-pick 1d4139f278\n$ mvn clean install -Prelease -DskipTests\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 11434008,
      "reputation" : 36282,
      "user_id" : 8381946,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-ORs8fPNVzDU/AAAAAAAAAAI/AAAAAAAADBs/F3IsdsProVY/s256-rj/photo.jpg",
      "display_name" : "Justin Bertram",
      "link" : "https://stackoverflow.com/users/8381946/justin-bertram"
    },
    "creation_date" : 1745506983,
    "last_activity_date" : 1745507289,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140366007,
    "post_id" : 79590249,
    "body" : "Can you reproduce this using the 2.39.0 client?",
    "score" : 0,
    "owner" : {
      "account_id" : 11434008,
      "reputation" : 36282,
      "user_id" : 8381946,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-ORs8fPNVzDU/AAAAAAAAAAI/AAAAAAAADBs/F3IsdsProVY/s256-rj/photo.jpg",
      "display_name" : "Justin Bertram",
      "link" : "https://stackoverflow.com/users/8381946/justin-bertram"
    },
    "creation_date" : 1745506740,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140365881,
    "post_id" : 79590249,
    "body" : "@JustinBertram   Core JMS Client Version is 2.19.1 and broker version is 2.39.0. The messages are not big (150-700KB) but there are a lot of them (262750).  The client has two threads that are both stuck in that TIMED_WAITING state.  I checked diskspace, memory usage and cpu usage but those are all healthy.  The client is stuck for hours, when I restart it it processes some messages in the queue but gets stuck again when trying to process one large message.",
    "score" : 0,
    "owner" : {
      "account_id" : 2279994,
      "reputation" : 21,
      "user_id" : 2005317,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2dd090851cfd3c1ba556708db5160e2a?s=256&d=identicon&r=PG",
      "display_name" : "user2005317",
      "link" : "https://stackoverflow.com/users/2005317/user2005317"
    },
    "creation_date" : 1745504920,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79590930" : [ {
      "comment_id" : 140366374,
      "post_id" : 79590930,
      "body" : "To be clear, updating the server isn&#39;t necessary to fix the problem. You just need to upgrade/fix the client.",
      "score" : 0,
      "owner" : {
        "account_id" : 11434008,
        "reputation" : 36282,
        "user_id" : 8381946,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/-ORs8fPNVzDU/AAAAAAAAAAI/AAAAAAAADBs/F3IsdsProVY/s256-rj/photo.jpg",
        "display_name" : "Justin Bertram",
        "link" : "https://stackoverflow.com/users/8381946/justin-bertram"
      },
      "creation_date" : 1745512876,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140366281,
      "post_id" : 79590930,
      "body" : "That&#39;s a promising solution thanks! Unfortunately we will not be able to update the server where it currently fails in a short term. But I will come back to give feedback as soon as we updated artemis client on this server.",
      "score" : 0,
      "owner" : {
        "account_id" : 2279994,
        "reputation" : 21,
        "user_id" : 2005317,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/2dd090851cfd3c1ba556708db5160e2a?s=256&d=identicon&r=PG",
        "display_name" : "user2005317",
        "link" : "https://stackoverflow.com/users/2005317/user2005317"
      },
      "creation_date" : 1745511218,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}