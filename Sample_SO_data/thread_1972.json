{
  "question" : {
    "question_id" : 79659407,
    "title" : "Authenticate with Mifare plus EV2 SL3",
    "body" : "<p>good day.\nA few days ago, I purchased a terminal (model P18Q) that supports various authentication methods for MIFARE Plus cards. The provider informed me that I need to implement my own encryption algorithms to communicate with the card, which is operating in SL3 mode, and to authenticate to a specific sector.</p>\n<p>Using the official NXP library, I can successfully authenticate, read, and write to the card. However, when using my custom implementation — where I send my AES key along with the challenge response — I consistently encounter an error during the mplus_firstAuth_f2 process.</p>\n<p>Does anyone know if I'm performing the authentication correctly? Unfortunately, I cannot use the official NXP library on this terminal, as it lacks a standard Android NFC reader. Instead, it communicates only through APDUs with an external terminal.</p>\n<p>In the following images, I receive the challenge from the first authentication step, but I get a 0x06 error during the second step, when I send my AES key. Am I doing something wrong? This is my first time working with this type of card.</p>\n<pre><code> public void test_MifarePlus() {\n    final int CID = 0;\n    final int fsdi = PICC_FSD_256;\n    int DRI = PICC_BITRATE_TXRX_106K;\n    int DSI = PICC_BITRATE_TXRX_106K;\n\n    clearLog();\n    appendLog(&quot;Iniciando autenticación Mifare Plus...&quot;);\n\n    try {\n        appendLog(&quot;&gt;&gt;&gt; Paso 1: Detectando tarjeta...&quot;);\n        String uid = detectNfcCard();\n        if (uid == null || uid.isEmpty()) {\n            appendLog(&quot;Error: No se detectó tarjeta NFC&quot;);\n            return;\n        }\n        appendLog(&quot;Tarjeta detectada. UID: &quot; + uid);\n        \n        appendLog(&quot;\\n&gt;&gt;&gt; Paso 2: Activando tarjeta...&quot;);\n        String ATS = activateTypeACard(fsdi, CID);\n        if (ATS == null || ATS.length() &lt; 2) {\n            appendLog(&quot;Error: Fallo en activación de tarjeta&quot;);\n            return;\n        }\n        \n        byte[] atsBytes = ByteArrayTools.hexStringToByteArray(ATS);\n        int[] rates = PICC_ParseRate(atsBytes);\n        DRI = rates[0];\n        DSI = rates[1];\n\n        appendLog(&quot;ATS recibido: &quot; + ATS);\n        appendLog(&quot;Parámetros negociados - DRI: &quot; + DRI + &quot;, DSI: &quot; + DSI);\n\n       \n        appendLog(&quot;\\n&gt;&gt;&gt; Paso 3: Solicitud PPS...&quot;);\n        int ppsStatus = requestPPS(CID, DRI, DSI);\n        if (ppsStatus != 0) {\n            appendLog(&quot;Error: Fallo en PPS (Código: &quot; + ppsStatus + &quot;)&quot;);\n            return;\n        }\n        appendLog(&quot;PPS exitoso&quot;);\n\n        \n        appendLog(&quot;\\n&gt;&gt;&gt; Paso 4: Configurando autenticación SL3...&quot;);\n        P18QMifarePlus channel = new P18QMifarePlus();\n        MifarePlus mifarePlus = new MifarePlus(channel);\n\n       \n        byte[] keyAES;\n        try {\n            keyAES = ByteArrayTools.hexStringToByteArray(AESKey);\n            if (keyAES == null || keyAES.length != 16) {\n                appendLog(&quot;Error: Clave AES inválida. Debe ser de 16 bytes&quot;);\n                return;\n            }\n        } catch (IllegalArgumentException e) {\n            appendLog(&quot;Error: Formato de clave AES inválido&quot;);\n            return;\n        }\n\n     \n        appendLog(&quot;\\n&gt;&gt;&gt; Paso 5: Autenticación F1...&quot;);\n        int blockToAuth = 0x4002;\n        byte[] encryptedChallenge = mifarePlus.mplus_firstAuth_f1(blockToAuth);\n\n        if (encryptedChallenge == null || encryptedChallenge.length &lt; 16) {\n            appendLog(&quot;Error: Challenge inválido o autenticación F1 fallida&quot;);\n            return;\n        }\n        appendLog(&quot;Challenge cifrado recibido: &quot; +\n                ByteArrayTools.byteArrayToHexString(encryptedChallenge));\n\n        \n        byte[] randB;\n        try {\n            randB = aesDecrypt(Arrays.copyOf(encryptedChallenge, 16), keyAES);\n            if (randB == null || randB.length != 16) {\n                appendLog(&quot;Error: Descifrado de RAND_B fallido&quot;);\n                return;\n            }\n        } catch (Exception e) {\n            appendLog(&quot;Error al descifrar RAND_B: &quot; + e.getMessage());\n            return;\n        }\n\n        appendLog(&quot;RAND_B descifrado: &quot; + ByteArrayTools.byteArrayToHexString(randB));\n\n       \n        byte[] randB_rot = rotateLeftByte(randB);\n        byte[] randA = generateSecureRandom(16);\n        byte[] responseData = concatenateArrays(randA, randB_rot);\n\n        appendLog(&quot;RAND_A generado: &quot; + ByteArrayTools.byteArrayToHexString(randA));\n        appendLog(&quot;RAND_B rotado: &quot; + ByteArrayTools.byteArrayToHexString(randB_rot));\n\n     \n        appendLog(&quot;\\n&gt;&gt;&gt; Paso 6: Autenticación F2...&quot;);\n        byte[] encryptedResponse;\n        try {\n            encryptedResponse = aesEncrypt(responseData, keyAES);\n        } catch (Exception e) {\n            appendLog(&quot;Error al cifrar respuesta F2: &quot; + e.getMessage());\n            return;\n        }\n\n        appendLog(&quot;Datos a enviar (cifrados): &quot; +\n                ByteArrayTools.byteArrayToHexString(encryptedResponse));\n\n        byte[] authResponse = mifarePlus.mplus_firstAuth_f2(encryptedResponse);\n        if (authResponse == null || authResponse.length == 0) {\n            appendLog(&quot;Error: Respuesta de autenticación F2 inválida&quot;);\n            return;\n        }\n\n       \n        if (authResponse[0] != (byte) 0x90) {\n            appendLog(&quot;Autenticación fallida. Código de error: &quot; +\n                    String.format(&quot;%02X&quot;, authResponse[0]));\n            return;\n        }\n\n        appendLog(&quot;\\nAutenticación SL3 completada con éxito!&quot;);\n        appendLog(&quot;Respuesta final: &quot; + ByteArrayTools.byteArrayToHexString(authResponse));\n\n    } catch (Exception e) {\n        appendLog(&quot;Error crítico: &quot; + e.toString());\n        e.printStackTrace();\n    } finally {\n        try {\n            int removalStatus = removeCPUCard();\n            appendLog(removalStatus == 0 ? &quot;Operación completada&quot; : &quot;Error al remover tarjeta&quot;);\n        } catch (Exception e) {\n            appendLog(&quot;Error al limpiar: &quot; + e.getMessage());\n        }\n    }\n}\n\nprivate byte[] aesEncrypt(byte[] data, byte[] key) throws Exception {\n    if (data == null || key == null) {\n        throw new IllegalArgumentException(&quot;Datos o clave nulos&quot;);\n    }\n\n    Cipher cipher = Cipher.getInstance(&quot;AES/ECB/NoPadding&quot;);\n    SecretKeySpec secretKey = new SecretKeySpec(key, &quot;AES&quot;);\n    cipher.init(Cipher.ENCRYPT_MODE, secretKey);\n    return cipher.doFinal(data);\n}\n\nprivate byte[] aesDecrypt(byte[] data, byte[] key) throws Exception {\n    if (data == null || key == null) {\n        throw new IllegalArgumentException(&quot;Datos o clave nulos&quot;);\n    }\n\n    Cipher cipher = Cipher.getInstance(&quot;AES/ECB/NoPadding&quot;);\n    SecretKeySpec secretKey = new SecretKeySpec(key, &quot;AES&quot;);\n    cipher.init(Cipher.DECRYPT_MODE, secretKey);\n    return cipher.doFinal(data);\n}\n\nprivate byte[] rotateLeftByte(byte[] input) {\n    if (input == null || input.length == 0) {\n        throw new IllegalArgumentException(&quot;Array de entrada inválido&quot;);\n    }\n\n    byte[] output = new byte[input.length];\n    System.arraycopy(input, 1, output, 0, input.length - 1);\n    output[input.length - 1] = input[0];\n    return output;\n}\n\nprivate byte[] generateSecureRandom(int length) {\n    byte[] randomBytes = new byte[length];\n    new SecureRandom().nextBytes(randomBytes);\n    return randomBytes;\n}\n\nprivate byte[] concatenateArrays(byte[] a, byte[] b) {\n    byte[] result = new byte[a.length + b.length];\n    System.arraycopy(a, 0, result, 0, a.length);\n    System.arraycopy(b, 0, result, a.length, b.length);\n    return result;\n} \n public byte[] mplus_firstAuth_f1(int key) throws Exception {\n    byte bloque1 = (byte) ( ( key &gt;&gt; 8 ) &amp; 0xFF );\n    byte bloque2 = (byte) ( ( key ) &amp; 0xFF );\n\n    byte[] apdu = new byte[4];\n\n    apdu[0] = 0x70;\n    apdu[1] = bloque2;\n    apdu[2] = bloque1;\n    apdu[3] = 0x00;\n\n    byte[] response = mplusMgr.sendApduCommand(apdu);\n\n    if ( response == null ) {\n        return null;\n    }\n\n    if ( response[0] == (byte) 0x90 ) {\n        return Arrays.copyOfRange(response, 1, response.length);\n    } else {\n        return null;\n    }\n}\n   public byte[] mplus_firstAuth_f2(byte[] data) throws Exception {\n    if ( data == null ) {\n        return null;\n    }\n\n    byte[] apdu = new byte[data.length + 1];\n\n    apdu[0] = (byte) 0x72;\n    System.arraycopy(data, 0, apdu, 1, data.length);\n    byte[] response = mplusMgr.sendApduCommand(apdu);\n    return response;\n}\n</code></pre>\n",
    "tags" : [ "java", "mifare" ],
    "owner" : {
      "account_id" : 27195611,
      "reputation" : 11,
      "user_id" : 20728546,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/458ca1ee39b5f9febb4c5938a2325f98?s=256&d=identicon&r=PG",
      "display_name" : "Kenneth Barrera",
      "link" : "https://stackoverflow.com/users/20728546/kenneth-barrera"
    },
    "is_answered" : false,
    "view_count" : 111,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1749500656,
    "creation_date" : 1749496225,
    "link" : "https://stackoverflow.com/questions/79659407/authenticate-with-mifare-plus-ev2-sl3",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140500272,
    "post_id" : 79659407,
    "body" : "Please don&#39;t post images of code, errors, logs, or other text. Instead <a href=\"https://stackoverflow.com/posts/79659407/edit\">edit</a> your question and make sure your code is a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>. Use <a href=\"https://stackoverflow.com/editing-help#code\">code block</a>s for formatting.",
    "score" : 0,
    "owner" : {
      "account_id" : 1535561,
      "reputation" : 9056,
      "user_id" : 1431720,
      "user_type" : "registered",
      "accept_rate" : 89,
      "profile_image" : "https://www.gravatar.com/avatar/f5a1388d4d3b2bf03b11bb5658c68c29?s=256&d=identicon&r=PG",
      "display_name" : "Robert",
      "link" : "https://stackoverflow.com/users/1431720/robert"
    },
    "creation_date" : 1749496848,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}