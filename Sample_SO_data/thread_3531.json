{
  "question" : {
    "question_id" : 79542601,
    "title" : "ByteBuddy Generated Class Not Working With Jakarta Validation",
    "body" : "<p>I am attempting to create a dynamic class using ByteBuddy with validation built in so that I can verify all required inputs/etc are set before moving further with the object (eventually my classes will be created from an ObjectType from a DB and data from the api input on create requests).</p>\n<p>I can see that my dynamic class does have the jakarta NotEmpty annotations set on its fields, but the validate method is passing and if I check <code>validator.getConstraintsForClass(dynamicClass)</code>, no constraints are found.</p>\n<p>Sample code:</p>\n<ol>\n<li>Gradle configuration:</li>\n</ol>\n<pre><code>plugins {\n    id 'java'\n    id 'io.quarkus'\n    id 'io.freefair.lombok' version '8.12'\n}\nrepositories {\n    mavenCentral()\n    mavenLocal()\n}\n\ndependencies {\n    implementation enforcedPlatform(&quot;${quarkusPlatformGroupId}:${quarkusPlatformArtifactId}:${quarkusPlatformVersion}&quot;)\n    implementation 'io.quarkus:quarkus-rest'\n    implementation 'io.quarkus:quarkus-arc'\n    implementation 'io.quarkus:quarkus-rest-jackson'\n    implementation 'io.quarkus:quarkus-rest-client-jackson'\n    implementation 'io.quarkus:quarkus-hibernate-validator'\n    implementation 'net.bytebuddy:byte-buddy:1.14'\n\n\n    testImplementation 'io.quarkus:quarkus-junit5'\n    testImplementation 'io.rest-assured:rest-assured'\n}\n\ngroup 'org.acme'\nversion '1.0.0-SNAPSHOT'\n\njava {\n    sourceCompatibility = JavaVersion.VERSION_21\n    targetCompatibility = JavaVersion.VERSION_21\n}\n\ntest {\n    systemProperty &quot;java.util.logging.manager&quot;, &quot;org.jboss.logmanager.LogManager&quot;\n}\ncompileJava {\n    options.encoding = 'UTF-8'\n    options.compilerArgs &lt;&lt; '-parameters'\n}\n\ncompileTestJava {\n    options.encoding = 'UTF-8'\n}\n\n</code></pre>\n<ol start=\"2\">\n<li>Java classes</li>\n</ol>\n<pre><code>package org.acme;\n\nimport lombok.extern.slf4j.Slf4j;\n\nimport net.bytebuddy.ByteBuddy;\nimport net.bytebuddy.description.annotation.AnnotationDescription;\nimport net.bytebuddy.dynamic.DynamicType;\n\nimport java.util.HashSet;\nimport java.util.Set;\nimport java.util.UUID;\n\n@Slf4j\npublic class DynamicPojoFactory {\n    private DynamicPojoFactory() {}\n\n    public static Builder builder() {\n        return new Builder();\n    }\n\n    private static String buildName() {\n        return &quot;DynamicClass_&quot;\n                + UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);\n    }\n\n    public static class Builder {\n        private final Set&lt;FieldDefinition&gt; definitions = new HashSet&lt;&gt;();\n\n        public Builder addField(\n                final String fieldName,\n                final Class&lt;?&gt; type,\n                final AnnotationDescription annotation) {\n            final FieldDefinition definition =\n                    new FieldDefinition(fieldName, type, Set.of(annotation));\n            return addField(definition);\n        }\n\n        public Builder addField(final FieldDefinition fieldDefinition) {\n            definitions.add(fieldDefinition);\n            return this;\n        }\n\n        public Class&lt;?&gt; build() {\n            DynamicType.Builder&lt;Object&gt; builder =\n                    new ByteBuddy().subclass(Object.class).name(buildName());\n\n            for (FieldDefinition fieldDefinition : definitions) {\n                builder =\n                        builder.defineProperty(fieldDefinition.name(), fieldDefinition.type())\n                                .annotateField(fieldDefinition.annotations().stream().toList());\n            }\n\n            return builder.make().load(this.getClass().getClassLoader()).getLoaded();\n        }\n    }\n}\n\n</code></pre>\n<pre><code>package org.acme;\n\nimport lombok.AllArgsConstructor;\nimport lombok.Getter;\nimport lombok.experimental.Accessors;\nimport net.bytebuddy.description.annotation.AnnotationDescription;\n\nimport java.util.Set;\n\n@Getter\n@AllArgsConstructor\n@Accessors(fluent = true)\npublic class FieldDefinition {\n    private String name;\n    private Class&lt;?&gt; type;\n    private Set&lt;AnnotationDescription&gt; annotations;\n}\n\n</code></pre>\n<pre><code>package org.acme;\n\nimport jakarta.enterprise.context.ApplicationScoped;\nimport jakarta.inject.Inject;\nimport jakarta.validation.ConstraintViolation;\nimport jakarta.validation.Validator;\nimport jakarta.validation.constraints.NotEmpty;\nimport jakarta.ws.rs.GET;\nimport jakarta.ws.rs.Path;\nimport jakarta.ws.rs.Produces;\nimport jakarta.ws.rs.core.MediaType;\n\nimport lombok.RequiredArgsConstructor;\nimport lombok.SneakyThrows;\nimport lombok.extern.slf4j.Slf4j;\n\nimport net.bytebuddy.description.annotation.AnnotationDescription;\n\nimport java.util.List;\nimport java.util.Set;\n\n@Slf4j\n@Path(&quot;/test&quot;)\n@ApplicationScoped\n@RequiredArgsConstructor\npublic class TestResource {\n\n    @Inject\n    Validator validator;\n\n    @SneakyThrows\n    @GET\n    @Path(&quot;&quot;)\n    @Produces(MediaType.APPLICATION_JSON)\n    public Object test() {\n\n        List&lt;FieldDefinition&gt; fields =\n                List.of(\n                        new FieldDefinition(\n                                &quot;firstName&quot;,\n                                String.class,\n                                Set.of(AnnotationDescription.Builder.ofType(NotEmpty.class).build())),\n                        new FieldDefinition(\n                                &quot;lastName&quot;,\n                                String.class,\n                                Set.of(AnnotationDescription.Builder.ofType(NotEmpty.class).build())));\n\n        final DynamicPojoFactory.Builder dynamicClassBuilder = DynamicPojoFactory.builder();\n        fields.forEach(dynamicClassBuilder::addField);\n\n        Class&lt;?&gt; dynamicClass = dynamicClassBuilder.build();\n        logAnnotations(dynamicClass);\n\n        Object person = dynamicClass.getDeclaredConstructor().newInstance();\n\n        dynamicClass.getMethod(&quot;setFirstName&quot;, String.class).invoke(person, &quot;Bill&quot;);\n//        dynamicClass.getMethod(&quot;setLastName&quot;, String.class).invoke(person, &quot;Nye&quot;); // attempt to cause validation failure by not setting last name\n\n        Set&lt;ConstraintViolation&lt;Object&gt;&gt; violations = validator.validate(person); // TODO: why does this pass??\n\n        if (!violations.isEmpty()) {\n            for (var violation : violations) {\n                System.out.println(&quot;Validation Error: &quot; + violation.getMessage());\n            }\n        } else {\n            System.out.println(&quot;Validation passed.&quot;);\n        }\n\n        return person;\n    }\n\nprivate void logAnnotations(Class&lt;?&gt; dynamicClass) {\n        log.info(&quot;logging annotations.&quot;);\n\n        log.info(&quot;found {} methods&quot;, dynamicClass.getMethods().length);\n\n        // Get all the methods from the dynamic class (which include getters and setters)\n        for (Method method : dynamicClass.getMethods()) {\n            // Check for getter methods that are expected to have annotations\n            if (method.getName().startsWith(&quot;get&quot;) || method.getName().startsWith(&quot;set&quot;)) {\n                // Log method annotations\n                Annotation[] annotations = method.getAnnotations();\n                for (Annotation annotation : annotations) {\n                    log.info(&quot;Method {} has annotation: {}&quot;, method.getName(), annotation);\n                }\n            }\n        }\n\n        log.info(&quot;found {} fields&quot;, dynamicClass.getDeclaredFields().length);\n\n        // You can also check field annotations\n        for (Field field : dynamicClass.getDeclaredFields()) {\n            // Log field annotations\n            Annotation[] fieldAnnotations = field.getAnnotations();\n            for (Annotation annotation : fieldAnnotations) {\n                log.info(&quot;Field {} has annotation: {}&quot;, field.getName(), annotation);\n            }\n        }\n    }\n\n}\n\n</code></pre>\n<p>Run quarkusDev and hit the /test endpoint or set up a simple test class. Console logs show that validation passes.</p>\n",
    "tags" : [ "java", "quarkus", "byte-buddy", "jakarta-validation" ],
    "owner" : {
      "account_id" : 41056173,
      "reputation" : 1,
      "user_id" : 30098183,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d43ff978ceb0abc5a79276a3b07f1ee3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "MJ_Dev",
      "link" : "https://stackoverflow.com/users/30098183/mj-dev"
    },
    "is_answered" : false,
    "view_count" : 72,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743531660,
    "creation_date" : 1743206923,
    "link" : "https://stackoverflow.com/questions/79542601/bytebuddy-generated-class-not-working-with-jakarta-validation",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}