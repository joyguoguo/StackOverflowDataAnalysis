{
  "question" : {
    "question_id" : 79654247,
    "title" : "Mock Java constructors while testing Java-code",
    "body" : "<p>I use Spock to test Java-code. For example, I have the following Java-class:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Github implements RemoteRepository {\n    @Override\n    public Boolean isBranchExist(String branch) {\n        return new HttpRequest().post();\n    }\n}\n</code></pre>\n<p>The HttpRequest class itself is also my Java-class. I am trying to mock the creation of an instance of the HttpRequest class.</p>\n<p>For this I have the following Groovy unit test:</p>\n<pre class=\"lang-java prettyprint-override\"><code>def &quot;mocking HttpRequest constructor&quot;() {\n     given:\n     RemoteRepository repository = new Github()\n    \n     def request = Mock(HttpRequest)\n     GroovyMock(HttpRequest, global: true)\n    \n     new HttpRequest() &gt;&gt; request\n    \n     and:\n     request.post() &gt;&gt; Boolean.FALSE\n    \n     when:\n     def res = repository.isBranchExist(&quot;branch_exist&quot;)\n    \n     then:\n     res == false\n }\n</code></pre>\n<p>Mocking does not occur, the test fails.\nHowever, if I rewrite all my entities (Github, HttpRequest, RemoteRepository) in Groovy, then mocking works successfully and the test passes.</p>\n<p>I use gradle as a build tool, here is my gradle.build, here you can also see the dependency versions + I use Oracle OpenJDK 23.0.1:</p>\n<pre class=\"lang-java prettyprint-override\"><code>plugins {\n    id 'groovy'\n}\n\ndependencies {\n    implementation 'org.apache.groovy:groovy-all:4.0.27'\n    implementation 'net.bytebuddy:byte-buddy:1.17.5'\n    testImplementation 'org.spockframework:spock-core:2.4-M6-groovy-4.0'\n}\n\ntasks.named('test') {\n    useJUnitPlatform()\n}\n</code></pre>\n<p>P.s. I understand that I can redesign the architecture, pass an instance of HttpClientBuilder to the Github constructor, which will provide the ability to send http requests (as is done in the Apache HttpComponents library) and not create HttpRequest objects directly, but I am interested in this particular case, why it works in Groovy code, but does not work in Java code.</p>\n<p>The code in this case is greatly simplified, is not actually applicable, just a silly example</p>\n",
    "tags" : [ "java", "unit-testing", "groovy", "spock" ],
    "owner" : {
      "account_id" : 42381656,
      "reputation" : 11,
      "user_id" : 30726769,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/12fe6d2a47958ffe27f9771f1e8d88c8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ilya Pyatizbyantsev",
      "link" : "https://stackoverflow.com/users/30726769/ilya-pyatizbyantsev"
    },
    "is_answered" : false,
    "view_count" : 171,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1758121746,
    "creation_date" : 1749118477,
    "link" : "https://stackoverflow.com/questions/79654247/mock-java-constructors-while-testing-java-code",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79767508,
    "question_id" : 79654247,
    "body" : "<p>First, refactor your code to inject the <code>HttpRequest</code> instead of calling <code>new</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class Github implements RemoteRepository {\n    private final HttpRequest httpRequest;\n\n    public GitHub(HttpRequest httpRequest) {\n        this.httpRequest = httpRequest;\n    }\n\n    @Override\n    public Boolean isBranchExist(String branch) {\n        return httpRequest.post();\n    }\n}\n</code></pre>\n<p>Then you can use Spock like this:</p>\n<pre><code>def &quot;mocking HttpRequest&quot;() {\n     given:\n     def request = Mock(HttpRequest) {\n        post() &gt;&gt; Boolean.FALSE\n     }\n     RemoteRepository repository = new Github(request)\n        \n     when:\n     def res = repository.isBranchExist(&quot;branch_exist&quot;)\n    \n     then:\n     res == false\n }\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1364678,
      "reputation" : 2232,
      "user_id" : 1301373,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/56eb9a131846d4447ca24b5ea9ecb600?s=256&d=identicon&r=PG",
      "display_name" : "winne2",
      "link" : "https://stackoverflow.com/users/1301373/winne2"
    },
    "creation_date" : 1758121746,
    "last_activity_date" : 1758121746,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140490133,
    "post_id" : 79654247,
    "body" : "As explained by the Spock docs, a Groovy mock behaves like a regular mock when applied to a non-Groovy class. I.e., like this you cannot mock a constructor call. Simply make the dependency injectable instead of creating it inside the method. Whenever it is difficult to test your code, the code needs to be refactored, not the test.",
    "score" : 6,
    "owner" : {
      "account_id" : 1087271,
      "reputation" : 68569,
      "user_id" : 1082681,
      "user_type" : "registered",
      "accept_rate" : 90,
      "profile_image" : "https://i.sstatic.net/lDK9h.png?s=256",
      "display_name" : "kriegaex",
      "link" : "https://stackoverflow.com/users/1082681/kriegaex"
    },
    "creation_date" : 1749125983,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140490056,
    "post_id" : 79654247,
    "body" : "what exactly do you mean &quot;mocking constructors&quot;?",
    "score" : 1,
    "owner" : {
      "account_id" : 3116234,
      "reputation" : 9469,
      "user_id" : 2636929,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/85fa83a02c04af43fcd224821ca9b750?s=256&d=identicon&r=PG",
      "display_name" : "Stultuske",
      "link" : "https://stackoverflow.com/users/2636929/stultuske"
    },
    "creation_date" : 1749123944,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79767508" : [ {
      "comment_id" : 140743776,
      "post_id" : 79767508,
      "body" : "Yes, this is what I meant in my comment 3+ months ago. BTW, in the Spock spec a simple <code>expect:</code> and <code>!repository.isBranchExist(&quot;branch_exist&quot;)</code> instead of <code>when: ... then: ...</code> would be more elegant and readable.",
      "score" : 1,
      "owner" : {
        "account_id" : 1087271,
        "reputation" : 68569,
        "user_id" : 1082681,
        "user_type" : "registered",
        "accept_rate" : 90,
        "profile_image" : "https://i.sstatic.net/lDK9h.png?s=256",
        "display_name" : "kriegaex",
        "link" : "https://stackoverflow.com/users/1082681/kriegaex"
      },
      "creation_date" : 1758166183,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}