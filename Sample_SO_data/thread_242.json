{
  "question" : {
    "question_id" : 79823589,
    "title" : "Spring Framework 5.3.39: javax.jms.IllegalStateException when sending a message with jmstemplate under IBM Websphere 9",
    "body" : "<p>I'm having a problem migrating from Spring 4.3.5 to 5.3.39 (I know community support for these versions has ended, but I need to investigate the problem).</p>\n<p>My application runs on IBM WebSphere 9 (JVM 8, so Spring 5.3.39 is the highest version I can move to) and uses <code>JmsTemplate</code> to send messages to an IBM MQ queue. The parameter <code>sessionTransacted</code> is set to <code>true</code>, everything runs fine with Spring 4.3.5 while with v5.3.39 I'm getting an <code>IllegalStateException</code> with this stacktrace:</p>\n<pre class=\"lang-php prettyprint-override\"><code>Caused by: javax.jms.IllegalStateException: Method not permitted in global transaction\nnull\n    at com.ibm.ejs.jms.JMSSessionHandle.checkNotInGlobalTransaction(JMSSessionHandle.java:1385)\n    at com.ibm.ejs.jms.JMSSessionHandle.commit(JMSSessionHandle.java:700)\n    at com.ibm.ejs.jms.JMSSessionHandle.commit(JMSSessionHandle.java:663)\n    at org.springframework.jms.support.JmsUtils.commitIfNecessary(JmsUtils.java:218)\n    at org.springframework.jms.core.JmsTemplate.doSend(JmsTemplate.java:1278)\n    at org.springframework.jms.core.JmsTemplate.lambda$send$3(JmsTemplate.java:586)\n    at org.springframework.jms.core.JmsTemplate.execute(JmsTemplate.java:504)\n    at orgmsTemplate.send(JmsTemplate.java:584)\n    at org.springframework.jms.core.JmsTemplate.convertAndSend(JmsTemplate.java:661)\n    at it.[REDACTED].sendMessage[REDACTED].java:839)\n    at it.[REDACTED].java:156)\n    at it.[REDACTED].java:63)\n    at it.[REDACTED].java:34)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(NativeMethodAccessorImpl.java:-2)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:90)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:55)\n</code></pre>\n<p>In my scenario, the transaction is manged by the application server container. However, in Spring 5.3.39 the <code>JmsUtils</code> class was changed, and the following block was removed from <code>commitIfNecessary</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>catch (IllegalStateException illegalStateException) {}\n</code></pre>\n<p>So the exception is already happening in Spring 4.3.5, but the framework suppresses it and everything runs fine.</p>\n<p>Another odd thing: according to the Spring documentation (in-code comment), when the transaction is container-managed, the <code>sessionTransacted</code> property on <code>JmsTemplate</code> should be ignored. But that's not what actually happens.</p>\n<p>While debugging, I found that the <code>JmsTemplate.isSessionLocallyTransacted</code> returns <code>true</code> even though the session is globally transacted. That happens because <code>isSessionTransactional </code>returns <code>true</code> due to <code>TransactionSynchronizationManager.getResource(cf)</code> returning <code>null</code>.</p>\n<p>Looking deeper into <code>TransactionSynchronizationManager.getResource(cf)</code>, I noticed that <code>doGetResource</code> returns <code>null</code> when getting the map from resources:</p>\n<pre class=\"lang-java prettyprint-override\"><code>TransactionSynchronizationManager.doGetResource\n...\nMap&lt;Object, Object&gt; map = resources.get();\nif (map == null) {\n    return null;\n}\n...\n</code></pre>\n<p>This means the thread isn't aware of the global transaction. It tries to commit and that ultimately  causes the exception.</p>\n<p>Do you have any suggestion about this? This is the first time I've dug deeply into the Spring Framework, so I'm probably missing something. But I'm in the middle of migrating of hundreds of applications and this is a major issue.</p>\n",
    "tags" : [ "java", "spring", "websphere", "illegalstateexception", "jmstemplate" ],
    "owner" : {
      "account_id" : 7230550,
      "reputation" : 11,
      "user_id" : 5517569,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/F02452hV.jpg?s=256",
      "display_name" : "Benny Evangelista",
      "link" : "https://stackoverflow.com/users/5517569/benny-evangelista"
    },
    "is_answered" : false,
    "view_count" : 59,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1763570281,
    "creation_date" : 1763482644,
    "link" : "https://stackoverflow.com/questions/79823589/spring-framework-5-3-39-javax-jms-illegalstateexception-when-sending-a-message",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140863850,
    "post_id" : 79823589,
    "body" : "I&#39;ve already found the issue and commented it :) The fact is I think there was a reason for Spring to suppress <code>IllegalStateException</code>, this is not valid anymore and in my case it&#39;s a breaking change. My bad I&#39;ll have to modify a lot af applications  :)",
    "score" : 0,
    "owner" : {
      "account_id" : 7230550,
      "reputation" : 11,
      "user_id" : 5517569,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/F02452hV.jpg?s=256",
      "display_name" : "Benny Evangelista",
      "link" : "https://stackoverflow.com/users/5517569/benny-evangelista"
    },
    "creation_date" : 1763627942,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140863740,
    "post_id" : 79823589,
    "body" : "Well it didn&#39;t ran fine because you ran into an exception which was, mistakenly, caught by the framework. It worked because the exception was caught and swallowed. The why can be seen in <a href=\"https://github.com/spring-projects/spring-framework/issues/32473\" rel=\"nofollow noreferrer\">this issue</a>.",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763625327,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140862722,
    "post_id" : 79823589,
    "body" : "thanks for the replies. My fault, <code>isSessionLocallyTransacted</code> is a method defined in <code>JmsTemplate</code> not in <code>JmsUtils</code>. I agree that in my scenario the right value for <code>sessionTransacted</code> should be <code>false</code>, but I have hundreds of applications actually running fine in production because Spring 4 suppresses the <code>IllegalStateException</code> when it tries to commit. With Spring 5 the <code>IllegalStateException</code> is thrown and stops the execution, so I was trying to understand this change to avoid modifying all the applications :)",
    "score" : 0,
    "owner" : {
      "account_id" : 7230550,
      "reputation" : 11,
      "user_id" : 5517569,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/F02452hV.jpg?s=256",
      "display_name" : "Benny Evangelista",
      "link" : "https://stackoverflow.com/users/5517569/benny-evangelista"
    },
    "creation_date" : 1763570230,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140862051,
    "post_id" : 79823589,
    "body" : "Also there appears to be no <code>JmsUtils.isSessionLocallyTransacted</code> in the 5.3.39 version of Spring. Are you mixing jars from different versions? Anyway shouldn&#39;t the <code>sessionTransacted</code> be <code>false</code> as the <code>JmsTemplate</code> shouldn&#39;t manage the transasction to start with (which is actually the default as well).",
    "score" : 1,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763549188,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140861644,
    "post_id" : 79823589,
    "body" : "Feels like a setup error for your global transactions. What does your configuration look like?",
    "score" : 0,
    "owner" : {
      "account_id" : 3192259,
      "reputation" : 126800,
      "user_id" : 2696260,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
      "display_name" : "M. Deinum",
      "link" : "https://stackoverflow.com/users/2696260/m-deinum"
    },
    "creation_date" : 1763535160,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}