{
  "question" : {
    "question_id" : 79546366,
    "title" : "Quarkus Funqy lambda handler returns 404 HTML intermittently, does not execute handler code",
    "body" : "<p><strong>In summary: Sometimes my AWS Lambda handler built with Quarkus Funqy is not invoked and Quarkus seem to return some default 404 HTML, both when running locally with Quarkus Dev Mode and deploying native executable to AWS Lambda. I ask for assistance in fixing this behavior.</strong> Below I define how the application works and how it is configured.</p>\n<p>The purpose of this lambda is registering and fetching a specific entity (POST and GET operations). I intend to build native executable.</p>\n<pre><code>@ApplicationScoped\npublic class DeviceController {\n\n    private static final Logger log = LoggerFactory.getLogger(DeviceController.class);\n    private final DeviceService deviceService;\n    private final ObjectMapper objectMapper;\n    @Inject\n    public DeviceController(DeviceService deviceService) {\n        this.deviceService = deviceService;\n        this.objectMapper = new ObjectMapper().registerModule(new JavaTimeModule())\n                .disable(SerializationFeature.WRITE_DATE_KEYS_AS_TIMESTAMPS);\n    }\n\n    @Funq\n    public Map&lt;String, Object&gt; handler(Map&lt;String, Object&gt; apiRequestEvent) {\n        try {\n            String path = (String) apiRequestEvent.get(&quot;path&quot;);\n            String httpMethod = (String) apiRequestEvent.get(&quot;httpMethod&quot;);\n            String body = (String) apiRequestEvent.get(&quot;body&quot;);\n            Map&lt;String, String&gt; queryStringParameters = readQueryParameters(apiRequestEvent);\n            if (!path.equals(&quot;/device&quot;)) {\n                throw new ServiceException(String.format(&quot;Path %s does not exist&quot;, path)\n                        , GlobalExceptionCode.INVALID_PATH);\n            }\n            return switch (httpMethod) {\n                case &quot;POST&quot;-&gt; this.createDevice(body);\n                case &quot;GET&quot;-&gt; this.getDevice(queryStringParameters);\n                default -&gt;  throw new ServiceException(&quot;Invalid method&quot;, GlobalExceptionCode.INVALID_METHOD);\n            };\n        } catch (ServiceException ex ){\n            return handleServiceException(ex);\n        } catch ( ModelException ex){\n            return handleModelException(ex);\n        } catch (RuntimeException ex){\n            return handleRuntimeException(ex);\n        } catch (Exception e) {\n            return handleGenericException(e);\n        }\n    }\n</code></pre>\n<p>The handler layer is nothing fancy: I can highlight the handler receives a Map&lt;String,Object&gt; for he API Gateway request event (with body, queryStringParameters, httpMethod etc), and returns another Map for the API Gateway response event. It uses dependency injection of a service layer to handle business logic. There's auxiliary methods to parse the input map and to build the output map.\nI'll attach pom.xml and application.properties at the end.</p>\n<p>The handler code mostly fine when debugging locally on Quarkus Dev mode, and also works when building a native executable and deploying to AWS Lambda.\nHowever, there's this weird behavior where sometimes the handler is not invoked (does not even trigger debugger breakpoint on the first line), and calling the handler returns a 404.</p>\n<p>Here's the lambda running succesfully in quarkus dev mode, calling from Postman:</p>\n<p><a href=\"https://i.sstatic.net/GPjqKnCQ.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/GPjqKnCQ.png\" alt=\"Lambda running succesfully\" /></a></p>\n<p>Here's the intermittent error when running locally:</p>\n<p><a href=\"https://i.sstatic.net/0kesiAVC.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/0kesiAVC.png\" alt=\"enter image description here\" /></a></p>\n<p>Here's the intermittent error on AWS Lambda:</p>\n<p><a href=\"https://i.sstatic.net/jtcJeaUF.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/jtcJeaUF.png\" alt=\"Intermittent error on AWS Lambda\" /></a></p>\n<p>Here's application.properties, I don't think there's relevant stuff in here. Today I tried defining the method 'handler' as the Funqy handler, but it changed nothing as I only have one handler annotated with @Funq. There's also configuration for the native build which don't affect the application running locally on Quarkus dev mode.</p>\n<pre><code>quarkus.funqy.export=handler\n\nlambda.bastion.write.arn=${BASTION_WRITE_ARN}\nlambda.bastion.read.arn=${BASTION_READ_ARN}\nquarkus.amazon-services-lambda.sync-client.type=url-connection\n\nquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:23.1-jdk-21\nquarkus.native.container-build=true\nquarkus.native.container-runtime=docker\nquarkus.native.additional-build-args=-march=compatibility\n</code></pre>\n<p>Here's pom.xml. I can highlight the usage of the AWS SDK since I need to call another lambda for database access, MapStruct for DTO mapping and Apache commons commons-lang3 for some legacy utility code I've reused from another company application.</p>\n<pre><code>(Omitted project definitions and properties...)\n    &lt;dependencyManagement&gt;\n        &lt;dependencies&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;${quarkus.platform.group-id}&lt;/groupId&gt;\n                &lt;artifactId&gt;${quarkus.platform.artifact-id}&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus.platform.version}&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n                &lt;artifactId&gt;bom&lt;/artifactId&gt;\n                &lt;version&gt;2.30.37&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n            &lt;dependency&gt;\n                &lt;groupId&gt;io.quarkiverse.amazonservices&lt;/groupId&gt;\n                &lt;artifactId&gt;quarkus-amazon-services-bom&lt;/artifactId&gt;\n                &lt;version&gt;3.3.1&lt;/version&gt;\n                &lt;type&gt;pom&lt;/type&gt;\n                &lt;scope&gt;import&lt;/scope&gt;\n            &lt;/dependency&gt;\n        &lt;/dependencies&gt;\n    &lt;/dependencyManagement&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkiverse.amazonservices&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-amazon-lambda&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;software.amazon.awssdk&lt;/groupId&gt;\n            &lt;artifactId&gt;url-connection-client&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-funqy-amazon-lambda&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-rest-jackson&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;\n            &lt;artifactId&gt;mapstruct&lt;/artifactId&gt;\n            &lt;version&gt;${org.mapstruct.version}&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-amazon-lambda-rest&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-amazon-lambda&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-jacoco&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-junit5&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n            &lt;artifactId&gt;quarkus-junit5-mockito&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;\n            &lt;artifactId&gt;commons-lang3&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;io.quarkus&lt;/groupId&gt;\n                &lt;artifactId&gt;quarkus-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${quarkus-plugin.version}&lt;/version&gt;\n                &lt;executions&gt;\n                    &lt;execution&gt;\n                        &lt;goals&gt;\n                            &lt;goal&gt;build&lt;/goal&gt;\n                        &lt;/goals&gt;\n                    &lt;/execution&gt;\n                &lt;/executions&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;artifactId&gt;maven-surefire-plugin&lt;/artifactId&gt;\n                &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;systemPropertyVariables&gt;\n                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                    &lt;/systemPropertyVariables&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.8.1&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;source&gt;21&lt;/source&gt;\n                    &lt;target&gt;21&lt;/target&gt;\n                    &lt;annotationProcessorPaths&gt;\n                        &lt;path&gt;\n                            &lt;groupId&gt;org.mapstruct&lt;/groupId&gt;\n                            &lt;artifactId&gt;mapstruct-processor&lt;/artifactId&gt;\n                            &lt;version&gt;${org.mapstruct.version}&lt;/version&gt;\n                        &lt;/path&gt;\n                    &lt;/annotationProcessorPaths&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n    &lt;profiles&gt;\n        &lt;profile&gt;\n            &lt;id&gt;native&lt;/id&gt;\n            &lt;activation&gt;\n                &lt;property&gt;\n                    &lt;name&gt;native&lt;/name&gt;\n                &lt;/property&gt;\n            &lt;/activation&gt;\n            &lt;build&gt;\n                &lt;plugins&gt;\n                    &lt;plugin&gt;\n                        &lt;artifactId&gt;maven-failsafe-plugin&lt;/artifactId&gt;\n                        &lt;version&gt;${surefire-plugin.version}&lt;/version&gt;\n                        &lt;executions&gt;\n                            &lt;execution&gt;\n                                &lt;goals&gt;\n                                    &lt;goal&gt;integration-test&lt;/goal&gt;\n                                    &lt;goal&gt;verify&lt;/goal&gt;\n                                &lt;/goals&gt;\n                                &lt;configuration&gt;\n                                    &lt;systemPropertyVariables&gt;\n                                        &lt;native.image.path&gt;${project.build.directory}/${project.build.finalName}-runner&lt;/native.image.path&gt;\n                                        &lt;java.util.logging.manager&gt;org.jboss.logmanager.LogManager&lt;/java.util.logging.manager&gt;\n                                        &lt;maven.home&gt;${maven.home}&lt;/maven.home&gt;\n                                    &lt;/systemPropertyVariables&gt;\n                                &lt;/configuration&gt;\n                            &lt;/execution&gt;\n                        &lt;/executions&gt;\n                    &lt;/plugin&gt;\n                &lt;/plugins&gt;\n            &lt;/build&gt;\n            &lt;properties&gt;\n                &lt;quarkus.native.enabled&gt;true&lt;/quarkus.native.enabled&gt;\n            &lt;/properties&gt;\n        &lt;/profile&gt;\n    &lt;/profiles&gt;\n&lt;/project&gt;\n\n</code></pre>\n",
    "tags" : [ "java", "aws-lambda", "quarkus" ],
    "owner" : {
      "account_id" : 6436922,
      "reputation" : 84,
      "user_id" : 12096971,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/894388433953739/picture?type=large",
      "display_name" : "Bruno",
      "link" : "https://stackoverflow.com/users/12096971/bruno"
    },
    "is_answered" : false,
    "view_count" : 68,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743428219,
    "creation_date" : 1743428219,
    "link" : "https://stackoverflow.com/questions/79546366/quarkus-funqy-lambda-handler-returns-404-html-intermittently-does-not-execute-h",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140283581,
    "post_id" : 79546366,
    "body" : "Small update: one colleague says the issues are related to incompatible dependencies, likely MapStruct and commons-lang3 and claims the problem should go away once they are removed, I&#39;m going to try that, though I don&#39;t understand how these dependencies could cause that.",
    "score" : 0,
    "owner" : {
      "account_id" : 6436922,
      "reputation" : 84,
      "user_id" : 12096971,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/894388433953739/picture?type=large",
      "display_name" : "Bruno",
      "link" : "https://stackoverflow.com/users/12096971/bruno"
    },
    "creation_date" : 1743440952,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}