{
  "question" : {
    "question_id" : 79613515,
    "title" : "Understanding Java version and azure-security-keyvault-secrets 4.2.6 affinity in Azure HDInsight Spark",
    "body" : "<p>Old and new Spark behave differently\nThe associated jar file specifies azure-security-keyvault-secrets_4.2.6\nDoes it work differently depending on the Java version?\nThe new Spark 3. It seems to hang at the point of requesting a token from Azure AD, but I don't know why. What should I do to make the new Spark work?\nーー\nOld Spark Behavior (1.8.0_ 362); Linux; 5.4.0-1109-azure)\n1.Connect to KeyVault\n2.No token information so HttpStatus: 401 (Unauthorized)\n3.Access KeyVault again using the token in the response header\n-&gt;Success at 200!\n<a href=\"https://learn.microsoft.com/ja-jp/azure/key-vault/general/authentication-requests-and-responses#authentication-requirements\" rel=\"nofollow noreferrer\">https://learn.microsoft.com/ja-jp/azure/key-vault/general/authentication-requests-and-responses#authentication-requirements</a></p>\n<p>New Spark (1.8.0_ 382); Linux; 5.4.0-1140-azure)\n1.Connect to KeyVault\n2.No token information so HttpStatus: 401 (Unauthorized)\n3.Attempt to access KeyVault again using the token in the response header\ngetToken appears to stop processing\nClientSecretCredentialBuilder\nDefaultAzureCredentialBuilder\n-&gt;Events are the same no matter which one is used</p>\n",
    "tags" : [ "java", "azure", "azure-hdinsight" ],
    "owner" : {
      "account_id" : 41856578,
      "reputation" : 11,
      "user_id" : 30488308,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ea1c25a6806981e10cfc4588cee9f3c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tkawasaki",
      "link" : "https://stackoverflow.com/users/30488308/tkawasaki"
    },
    "is_answered" : true,
    "view_count" : 73,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1747322947,
    "creation_date" : 1746767554,
    "link" : "https://stackoverflow.com/questions/79613515/understanding-java-version-and-azure-security-keyvault-secrets-4-2-6-affinity-in",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79623562,
    "question_id" : 79613515,
    "body" : "<p>Avoid relying on <code>DefaultAzureCredential</code>, as it tries multiple credentials in order, which can introduce delays or hangs in restricted environments like Spark clusters.</p>\n<pre class=\"lang-java prettyprint-override\"><code>TokenCredential credential = new ClientSecretCredentialBuilder()\n    .clientId(&quot;&lt;your-client-id&gt;&quot;)\n    .clientSecret(&quot;&lt;your-client-secret&gt;&quot;)\n    .tenantId(&quot;&lt;your-tenant-id&gt;&quot;)\n    .build();\n\nSecretClient secretClient = new SecretClientBuilder()\n    .vaultUrl(&quot;&lt;your-keyvault-url&gt;&quot;)\n    .credential(credential)\n    .buildClient();\n</code></pre>\n<p>This checks the direct synchronous token acquisition without falling back to interactive or managed identity flows.</p>\n<ul>\n<li>To investigate why token acquisition hangs (especially with Java 1.8.0_382), enable full TLS/network-level debug logs by adding - <code>-Djavax.net.debug=all</code>.</li>\n</ul>\n<p>Upgrade to the latest versions of these libraries.</p>\n<p><strong>pom.xml:</strong></p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependency&gt;\n  &lt;groupId&gt;com.azure&lt;/groupId&gt;\n  &lt;artifactId&gt;azure-security-keyvault-secrets&lt;/artifactId&gt;\n  &lt;version&gt;4.7.1&lt;/version&gt;\n&lt;/dependency&gt;\n&lt;dependency&gt;\n  &lt;groupId&gt;com.azure&lt;/groupId&gt;\n  &lt;artifactId&gt;azure-identity&lt;/artifactId&gt;\n  &lt;version&gt;1.10.3&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n<p><strong>azure-security-keyvault-secrets:</strong></p>\n<p><img src=\"https://i.sstatic.net/f1AL556t.png\" alt=\"enter image description here\" /></p>\n<p><strong>azure-identity:</strong></p>\n<p><img src=\"https://i.sstatic.net/DdCF7Ks4.png\" alt=\"enter image description here\" /></p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 39678620,
      "reputation" : 177,
      "user_id" : 29395866,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d845119ec3a3f8629556b62e18d1181d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Harish Bodapati",
      "link" : "https://stackoverflow.com/users/29395866/harish-bodapati"
    },
    "creation_date" : 1747318799,
    "last_activity_date" : 1747322947,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140416503,
    "post_id" : 79613515,
    "body" : "Thank you for your comment. Use ClientSecretCredentialBuilder instead of DefaultAzureCredentialBuilder. Is -Djavax.net.debug=all a parameter that can be used with ClientSecretCredentialBuilder?",
    "score" : 0,
    "owner" : {
      "account_id" : 41856578,
      "reputation" : 11,
      "user_id" : 30488308,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ea1c25a6806981e10cfc4588cee9f3c0?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Tkawasaki",
      "link" : "https://stackoverflow.com/users/30488308/tkawasaki"
    },
    "creation_date" : 1747019878,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140409854,
    "post_id" : 79613515,
    "body" : "Use <code>ClientSecretCredentialBuilder</code> directly instead of <code>DefaultAzureCredentialBuilder</code> and enable <code>-Djavax.net.debug=all</code> to debug token hang issue with Java 1.8.0_382 in Spark 3.",
    "score" : 0,
    "owner" : {
      "account_id" : 26618602,
      "reputation" : 4373,
      "user_id" : 20237646,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/fa24d5646e4d1c444b17a77fd8a37337?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Dasari Kamali",
      "link" : "https://stackoverflow.com/users/20237646/dasari-kamali"
    },
    "creation_date" : 1746768888,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79623562" : [ {
      "comment_id" : 140436515,
      "post_id" : 79623562,
      "body" : "Thanks, @Tkawasaki. Since the same code with <code>azure-identity:1.16.0</code> and <code>azure-security-keyvault-secrets:4.9.4</code> works fine in my environment, the issue likely stems from a difference in the runtime environment. especially around Java version, TLS config, or network access from Spark. I recommend running a minimal standalone Java test (outside Spark) on the same node to confirm if the problem is environment-specific. This will help isolate whether Spark or system-level settings are affecting token acquisition.",
      "score" : 0,
      "owner" : {
        "account_id" : 39678620,
        "reputation" : 177,
        "user_id" : 29395866,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/d845119ec3a3f8629556b62e18d1181d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Harish Bodapati",
        "link" : "https://stackoverflow.com/users/29395866/harish-bodapati"
      },
      "creation_date" : 1747558602,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140434069,
      "post_id" : 79623562,
      "body" : "Thank you for your comment. I tried upgrading KeyVaultSecrets 4.9.4 but it didn&#39;t work For Identity 1.16.0, verify that you have done so First, -Djavax.net.debug=all. I&#39;ll try it with",
      "score" : 0,
      "owner" : {
        "account_id" : 41856578,
        "reputation" : 11,
        "user_id" : 30488308,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/ea1c25a6806981e10cfc4588cee9f3c0?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Tkawasaki",
        "link" : "https://stackoverflow.com/users/30488308/tkawasaki"
      },
      "creation_date" : 1747434747,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}