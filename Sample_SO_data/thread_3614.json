{
  "question" : {
    "question_id" : 79536440,
    "title" : "How to create a complex entity without save, in Hibernate 6.6?",
    "body" : "<p>I want to create a &quot;preview&quot; object and want to return the object to a rest entpoint. (String Json)</p>\n<p>In Hibernate 6.3 I had no problems but in 6.6 I got the error message:</p>\n<pre><code>org.hibernate.TransientObjectException: persistent instance references an unsaved transient instance of 'XXX' (save the transient instance before flushing)\n</code></pre>\n<p>I add <code>cascade = {CascadeType.PERSIST}</code> that helps in Hibernate 6.3 but not in 6.6.</p>\n<p>The error message comes in a for-loop. The first run works, the error only occurs on the second run.</p>\n<p>What can I do?</p>\n<p>EDIT:\nI was able to narrow down the problem. I create object A, set a few properties and then go into the FOR loop and create object B. I attach object B to a list property of object A with <code>ObjectA.getList().add(ObjectB)</code>. The loop should run through X times. The error occurs exactly on the second run.</p>\n<p>The error occurs when I access a repository in the for loop and call a select (<code>findByName()</code>) to get more information for the ObjectB and set properties accordingly. Obviously Hibernate does not like that I call a repository / select without having saved the object before. Do I have to somehow annotate the repository method to be ReadOnly or something?</p>\n<p>EDIT 2:\nI have now rebuilt my code so that I first read out all the necessary data and then create the object. Which then goes into performance, but I can't get it to run any other way. Unfortunately, my tests are now failing! Exactly the same thing happens. I create the object in the test without saving! And I want to test exactly that, with <code>objectARepo.findAll().size() = 0</code>. Again, I get the same error message. I have also tried <code>objectARepo.detach(objectA)</code> and <code>objectARepo.flush()</code>. Although the error then comes with <code>objectARepo.flush()</code>.</p>\n",
    "tags" : [ "java", "spring-boot", "hibernate" ],
    "owner" : {
      "account_id" : 3533737,
      "reputation" : 1099,
      "user_id" : 2952564,
      "user_type" : "registered",
      "accept_rate" : 74,
      "profile_image" : "https://i.sstatic.net/zN9XN.png?s=256",
      "display_name" : "Burner",
      "link" : "https://stackoverflow.com/users/2952564/burner"
    },
    "is_answered" : false,
    "view_count" : 90,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1747500507,
    "creation_date" : 1742992796,
    "link" : "https://stackoverflow.com/questions/79536440/how-to-create-a-complex-entity-without-save-in-hibernate-6-6",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79539356,
    "question_id" : 79536440,
    "body" : "<p>I found the Solution for my UnitTest. There I can do</p>\n<pre><code>entityManager.clear();\n</code></pre>\n<p>and the PersistentCache will be cleared. Does not solve the actual problem of why you are not allowed to call a repository method.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 3533737,
      "reputation" : 1099,
      "user_id" : 2952564,
      "user_type" : "registered",
      "accept_rate" : 74,
      "profile_image" : "https://i.sstatic.net/zN9XN.png?s=256",
      "display_name" : "Burner",
      "link" : "https://stackoverflow.com/users/2952564/burner"
    },
    "creation_date" : 1743089959,
    "last_activity_date" : 1743089959,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140270350,
    "post_id" : 79536440,
    "body" : "Can you please share some example code what happens before and inside your loop? The verbal description just is not precise enough IMHO.",
    "score" : 1,
    "owner" : {
      "account_id" : 3391382,
      "reputation" : 5360,
      "user_id" : 2846138,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/2sp68.png?s=256",
      "display_name" : "cyberbrain",
      "link" : "https://stackoverflow.com/users/2846138/cyberbrain"
    },
    "creation_date" : 1743090212,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140268497,
    "post_id" : 79536440,
    "body" : "I updated my question, with more informations",
    "score" : 0,
    "owner" : {
      "account_id" : 3533737,
      "reputation" : 1099,
      "user_id" : 2952564,
      "user_type" : "registered",
      "accept_rate" : 74,
      "profile_image" : "https://i.sstatic.net/zN9XN.png?s=256",
      "display_name" : "Burner",
      "link" : "https://stackoverflow.com/users/2952564/burner"
    },
    "creation_date" : 1743065335,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140265820,
    "post_id" : 79536440,
    "body" : "It&#39;s exactly what I don&#39;t want. I don&#39;t want to save the object! Hibernate wants me to save it!",
    "score" : 0,
    "owner" : {
      "account_id" : 3533737,
      "reputation" : 1099,
      "user_id" : 2952564,
      "user_type" : "registered",
      "accept_rate" : 74,
      "profile_image" : "https://i.sstatic.net/zN9XN.png?s=256",
      "display_name" : "Burner",
      "link" : "https://stackoverflow.com/users/2952564/burner"
    },
    "creation_date" : 1742996737,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140265773,
    "post_id" : 79536440,
    "body" : "I assume you are referencing an entity from your persisted entity. As you correctly said, using <code>CascadeType.PERSIST</code> for the child entity reference is the way to go. Alternatively, you can also manually persist the referenced entity with <code>.save()</code> and then <code>.save()</code> the parent entity. This should avoid the error you&#39;re getting. If this doesn&#39;t help, please provide your entity definition(s) and the for-loop you use for persisting.",
    "score" : 0,
    "owner" : {
      "account_id" : 4646767,
      "reputation" : 19489,
      "user_id" : 3764804,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://i.sstatic.net/fZQON.png?s=256",
      "display_name" : "BullyWiiPlaza",
      "link" : "https://stackoverflow.com/users/3764804/bullywiiplaza"
    },
    "creation_date" : 1742996272,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}