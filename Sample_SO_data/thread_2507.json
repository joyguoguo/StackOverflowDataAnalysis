{
  "question" : {
    "question_id" : 79615721,
    "title" : "Short-circuit propagation with Spring Reactive Webclient",
    "body" : "<p>I have written an integration test which merges five HTTP requests into a flux, short circuits using <code>any()</code>, and then executes a new HTTP request using the same client:</p>\n<pre><code> Map&lt;String, Cookie&gt; cookieMap = new ConcurrentHashMap&lt;&gt;();\n WebClient webClient =\n    WebClient.builder()\n        .clientConnector(\n            followRedirectsWithCookies(\n                cookieMap, (String location) -&gt; !location.matches(&quot;.*/landingMockFe&quot;)))\n        .baseUrl(&quot;http://localhost:&quot; + localPort)\n        .build();\n...\nList&lt;Mono&lt;HttpStatusCode&gt;&gt; responses = new ArrayList&lt;Mono&lt;HttpStatusCode&gt;&gt;(5);\nfor (int i = 0; i &lt; 5; i++) {\n  responses.add(\n      webClient\n          .get()\n          ...\n          .exchangeToMono(response -&gt; Mono.just(response.statusCode())));\n}\n\nBoolean is4xxError = Flux.merge(responses).any(response -&gt; response.is4xxClientError()).block();\n\nString newResponseString = webClient\n    .get()\n    .uri(&quot;some-other-uri&quot;)\n     ...\n    .retrieve()\n    .bodyToMono(String.class)\n    .block();\n</code></pre>\n<p>This worked fine for 1 year with <strong>Spring Webflux v6.1.13</strong>, <strong>Spring Security v6.3.3</strong>, <strong>Spring Boot v3.3.4</strong>, and <strong>Project Reactor Core v3.6.10</strong>.</p>\n<p>Now, I upgraded to <strong>Spring Webflux v6.2.5</strong>, <strong>Spring Security v6.4.4</strong>, <strong>Spring Boot v3.4.4</strong>, <strong>Project Reactor Core v3.7.4</strong>, and occasionally this test fails because the last HTTP call throws:</p>\n<p><em>reactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response</em></p>\n<p>This change seems to solve the issue:</p>\n<pre><code>int count4xxError =\n    Flux.merge(responses)\n        .filter(response -&gt; response.is4xxClientError())\n        .count()\n        .block()\n        .intValue();\n</code></pre>\n<p>Is this a bug (related to <code>any()</code> short circuit) or is it the expected behaviour?</p>\n",
    "tags" : [ "java", "spring", "spring-webflux", "project-reactor" ],
    "owner" : {
      "account_id" : 41898577,
      "reputation" : 1,
      "user_id" : 30501071,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/40ce81131cd9974b352fb49b2fb5328a?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Ilario M",
      "link" : "https://stackoverflow.com/users/30501071/ilario-m"
    },
    "is_answered" : false,
    "view_count" : 75,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747041463,
    "creation_date" : 1746896566,
    "link" : "https://stackoverflow.com/questions/79615721/short-circuit-propagation-with-spring-reactive-webclient",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}