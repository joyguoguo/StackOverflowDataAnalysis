{
  "question" : {
    "question_id" : 79715284,
    "title" : "Spring Boot 4.0.0-M1 java.lang.NoClassDefFoundError: Could not initialize class io.opentelemetry.exporter.sender.okhttp.internal.OkHttpGrpcSender",
    "body" : "<p>I would like to build a native image with the newly released (as of this writing) Spring Boot 4.0.0-M1 and GraalVM AOT</p>\n<p>With this code:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class TracingConfiguration {\n\n    @Bean\n    public SpanExporter otlpGrpcSpanExporter() {\n        return OtlpGrpcSpanExporter.builder().setEndpoint(&quot;https://otlp-gateway-prod-us-central-0.grafana.net/otlp/v1/traces&quot;).addHeader(&quot;Authorization&quot;, &quot;Basic ODY2MTg0OaWRYTWlmWDA9&quot;).build(); //this is fake\n    }\n\n}\n\n</code></pre>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependencies&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-webflux&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-kafka&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-opentelemetry&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-webclient&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.projectreactor&lt;/groupId&gt;\n        &lt;artifactId&gt;reactor-core-micrometer&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;\n        &lt;artifactId&gt;opentelemetry-exporter-otlp&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.micrometer&lt;/groupId&gt;\n        &lt;artifactId&gt;micrometer-tracing-bridge-otel&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.micrometer&lt;/groupId&gt;\n        &lt;artifactId&gt;micrometer-registry-otlp&lt;/artifactId&gt;\n    &lt;/dependency&gt;\n\n    &lt;dependency&gt;\n        &lt;groupId&gt;io.projectreactor.kafka&lt;/groupId&gt;\n        &lt;artifactId&gt;reactor-kafka&lt;/artifactId&gt;\n        &lt;version&gt;1.3.23&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-cloud-function-context&lt;/artifactId&gt;\n        &lt;version&gt;4.3.0&lt;/version&gt;\n    &lt;/dependency&gt;\n    &lt;dependency&gt;\n        &lt;groupId&gt;com.github.loki4j&lt;/groupId&gt;\n        &lt;artifactId&gt;loki-logback-appender&lt;/artifactId&gt;\n        &lt;version&gt;2.0.0&lt;/version&gt;\n    &lt;/dependency&gt;\n&lt;!--        &lt;dependency&gt;--&gt;\n&lt;!--            &lt;groupId&gt;io.opentelemetry&lt;/groupId&gt;--&gt;\n&lt;!--            &lt;artifactId&gt;opentelemetry-exporter-sender-okhttp&lt;/artifactId&gt;--&gt;\n&lt;!--            &lt;version&gt;1.52.0&lt;/version&gt;--&gt;\n&lt;!--        &lt;/dependency&gt;--&gt;\n\n&lt;/dependencies&gt;\n\n</code></pre>\n<pre class=\"lang-bash prettyprint-override\"><code>mvn -U -Pnative spring-boot:build-image -DskipTests\n</code></pre>\n<p>I get this error message:</p>\n<pre><code>Caused by: java.lang.NoClassDefFoundError: Could not initialize class io.opentelemetry.exporter.sender.okhttp.internal.OkHttpGrpcSender\n        at io.opentelemetry.exporter.sender.okhttp.internal.OkHttpGrpcSenderProvider.createSender(OkHttpGrpcSenderProvider.java:23)\n        at io.opentelemetry.exporter.internal.grpc.GrpcExporterBuilder.build(GrpcExporterBuilder.java:236)\n        at io.opentelemetry.exporter.otlp.trace.OtlpGrpcSpanExporterBuilder.build(OtlpGrpcSpanExporterBuilder.java:310)\n        at org.example.TracingConfiguration.otlpGrpcSpanExporter(TracingConfiguration.java:25)\n\n</code></pre>\n<p>With version 3.5.3, this would compile fine and run fine. With version 4.0.0-M1, it will always yield <code>java.lang.NoClassDefFoundError: Could not initialize class io.opentelemetry.exporter.sender.okhttp.internal.OkHttpGrpcSender</code></p>\n<p>I understand Spring Boot has been modularized for 4.0, which is a great thing.</p>\n<p>Which module contains this?</p>\n<p>How to fix this issue so the native image can be built?</p>\n",
    "tags" : [ "java", "spring-boot", "maven", "okhttp", "open-telemetry" ],
    "owner" : {
      "account_id" : 14482834,
      "reputation" : 5468,
      "user_id" : 10461625,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/fgo5D.jpg?s=256",
      "display_name" : "PatPanda",
      "link" : "https://stackoverflow.com/users/10461625/patpanda"
    },
    "is_answered" : true,
    "view_count" : 142,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1753554629,
    "creation_date" : 1753481780,
    "link" : "https://stackoverflow.com/questions/79715284/spring-boot-4-0-0-m1-java-lang-noclassdeffounderror-could-not-initialize-class",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79715907,
    "question_id" : 79715284,
    "body" : "<p>You hit an open bug <a href=\"https://github.com/open-telemetry/opentelemetry-java/issues/7491\" rel=\"nofollow noreferrer\">opentelemetry-exporter-sender-okhttp:1.52.0 consumed in Maven based applications fails due to missing OkHttp classes #7491</a></p>\n<blockquote>\n<p>The version of com.squareup.okhttp3:okhttp used by OpenTelemetry 1.52.0 changed from 4.12.0 to 5.1.0. As documented in the OkHttp release notes since 5.0.0 OkHttp build artifacts now use Gradle module metadata. Also, OkHttp now publishes separate JVM and Android build artifacts. Applications built using Gradle are not affected, as Gradle automatically uses the appropriate build artifact. However, applications built using Maven are affected as they are not Gradle module metadata aware.\nOverriding the transitive dependency on com.squareup.okhttp3:okhttp to instead be com.squareup.okhttp3:okhttp-jvm fixes the example repro detailed above.</p>\n</blockquote>\n<p>As a workaround, add <code>com.squareup.okhttp3:okhttp-jvm</code> dependency</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;dependency&gt;\n  &lt;groupId&gt;com.squareup.okhttp3&lt;/groupId&gt;\n  &lt;artifactId&gt;okhttp-jvm&lt;/artifactId&gt;\n  &lt;version&gt;5.1.0&lt;/version&gt;\n&lt;/dependency&gt;\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1713236,
      "reputation" : 26569,
      "user_id" : 1570854,
      "user_type" : "registered",
      "accept_rate" : 71,
      "profile_image" : "https://i.sstatic.net/ef6Ng.jpg?s=256",
      "display_name" : "Lesiak",
      "link" : "https://stackoverflow.com/users/1570854/lesiak"
    },
    "creation_date" : 1753554629,
    "last_activity_date" : 1753554629,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79715907" : [ {
      "comment_id" : 140622405,
      "post_id" : 79715907,
      "body" : "Related: <a href=\"https://stackoverflow.com/a/79690691/12567365\">How to setup OkHttp v5 with Maven?</a>",
      "score" : 1,
      "owner" : {
        "account_id" : 12743722,
        "reputation" : 22621,
        "user_id" : 12567365,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/zNR3x.png?s=256",
        "display_name" : "andrewJames",
        "link" : "https://stackoverflow.com/users/12567365/andrewjames"
      },
      "creation_date" : 1753651741,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}