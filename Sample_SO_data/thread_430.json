{
  "question" : {
    "question_id" : 79799961,
    "title" : "Why does Java FontMetrics return wrong string bounds (specially height) for some .ttf?",
    "body" : "<p>Iâ€™m generating text images for different .ttf fonts in a method using Java2D, most of the fonts it works fine. The issue is with some fonts it return wrong &quot;Y&quot; value.</p>\n<pre><code>// params\nFile workingDir = new File(&quot;/Users/vigo/test-dir/&quot;);\nint verticalPadding = 2;\nint horizontalPadding = 2;\nFile fontFile = new File(workingDir, &quot;Arabella.ttf&quot;);\nString text = &quot;Hello World&quot;;\nFont font = Font.createFont(Font.TRUETYPE_FONT, fontFile).deriveFont(40f);\n\n// calculate bounds\nBufferedImage temp = new BufferedImage(1, 1, BufferedImage.TYPE_INT_ARGB);\nGraphics2D g2d = temp.createGraphics();\nFontMetrics fm = g2d.getFontMetrics(font);\n\n// get image width and height\nint width = fm.stringWidth(text) + (horizontalPadding * 2);\nint height = (int) Math.ceil(fm.getAscent() + fm.getDescent() + fm.getLeading()) + (verticalPadding * 2);\n\n// get x and y draw points\nint x = horizontalPadding;\nint y = verticalPadding + fm.getAscent();\ng2d.dispose();\n\n// create the actual image and draw text\nBufferedImage image = new BufferedImage(width, height, BufferedImage.TYPE_INT_ARGB);\ng2d = image.createGraphics();\ng2d.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON);\ng2d.setBackground(Color.WHITE);\ng2d.fillRect(0, 0, width, height);\ng2d.setColor(Color.BLACK);\ng2d.setFont(font);\ng2d.drawString(text, x, y);\ng2d.dispose();\n\nImageIO.write(image, &quot;png&quot;, new File(workingDir, &quot;text-img.png&quot;));\n</code></pre>\n<p>Code working perfectly with most of the fonts (example image with open sans font):</p>\n<p><a href=\"https://i.sstatic.net/CbaNE3sr.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/CbaNE3sr.png\" alt=\"enter image description here\" /></a></p>\n<p>But with few fonts, example <a href=\"https://www.fontsum.com/arabella-ds-font\" rel=\"nofollow noreferrer\">arabella</a> returns wrong &quot;Y&quot; value:</p>\n<p><a href=\"https://i.sstatic.net/HltJ6s1O.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/HltJ6s1O.png\" alt=\"enter image description here\" /></a></p>\n<p>Is there a better way to get consistent visual height across fonts when rendering text images?</p>\n",
    "tags" : [ "java", "java-2d" ],
    "owner" : {
      "account_id" : 2459590,
      "reputation" : 487,
      "user_id" : 2144031,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bce0dabdb468b315e4eea57adb422f57?s=256&d=identicon&r=PG",
      "display_name" : "spring_dev101",
      "link" : "https://stackoverflow.com/users/2144031/spring-dev101"
    },
    "is_answered" : false,
    "view_count" : 154,
    "answer_count" : 0,
    "score" : 3,
    "last_activity_date" : 1763149301,
    "creation_date" : 1761472133,
    "link" : "https://stackoverflow.com/questions/79799961/why-does-java-fontmetrics-return-wrong-string-bounds-specially-height-for-some",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140817832,
    "post_id" : 79799961,
    "body" : "Please @nineninesevenfour, post your comment as a reply so that it is accessible to all users. That way, &quot;spring_dev101&quot; can mark it as accepted.",
    "score" : 3,
    "owner" : {
      "account_id" : 10843443,
      "reputation" : 918,
      "user_id" : 20882864,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CCQCy.jpg?s=256",
      "display_name" : "Marce Puente",
      "link" : "https://stackoverflow.com/users/20882864/marce-puente"
    },
    "creation_date" : 1761483710,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140817774,
    "post_id" : 79799961,
    "body" : "ahh thank u.. indeed a issue with fonts returning negative descent. Math.abs(fm.getDescent()) did the trick!",
    "score" : 0,
    "owner" : {
      "account_id" : 2459590,
      "reputation" : 487,
      "user_id" : 2144031,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bce0dabdb468b315e4eea57adb422f57?s=256&d=identicon&r=PG",
      "display_name" : "spring_dev101",
      "link" : "https://stackoverflow.com/users/2144031/spring-dev101"
    },
    "creation_date" : 1761479814,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140817720,
    "post_id" : 79799961,
    "body" : "So one answer could be: &quot;Some TrueType fonts have negative descent values because the convention for how a font&#39;s metrics are stored varies between systems and font formats. While &quot;descent&quot; typically represents the distance below the baseline, some implementations store it as a negative value to indicate it&#39;s below the baseline, which is a design convention in systems like FreeType. Other systems store it as a positive value, with the direction being inferred by the application&quot;",
    "score" : 3,
    "owner" : {
      "account_id" : 21851467,
      "reputation" : 974,
      "user_id" : 16143492,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/PMrGU.png?s=256",
      "display_name" : "nineninesevenfour",
      "link" : "https://stackoverflow.com/users/16143492/nineninesevenfour"
    },
    "creation_date" : 1761477608,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140817714,
    "post_id" : 79799961,
    "body" : "Found it: The font from your example uses a negative descent, which can happen, so you can solve your issue using Math.abs(fm.getDescent()). There was a JDK bug reported, but it was closed and they proposed to use getStringBounds() or TextLayout.bounds instead: <a href=\"https://bugs.openjdk.org/browse/JDK-4388831\" rel=\"nofollow noreferrer\">bugs.openjdk.org/browse/JDK-4388831</a>. You can also use your favorite search engine to search for &quot;some truetype fonts have negative descent&quot;",
    "score" : 3,
    "owner" : {
      "account_id" : 21851467,
      "reputation" : 974,
      "user_id" : 16143492,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/PMrGU.png?s=256",
      "display_name" : "nineninesevenfour",
      "link" : "https://stackoverflow.com/users/16143492/nineninesevenfour"
    },
    "creation_date" : 1761477291,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140817668,
    "post_id" : 79799961,
    "body" : "yes! but no luck",
    "score" : 0,
    "owner" : {
      "account_id" : 2459590,
      "reputation" : 487,
      "user_id" : 2144031,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/bce0dabdb468b315e4eea57adb422f57?s=256&d=identicon&r=PG",
      "display_name" : "spring_dev101",
      "link" : "https://stackoverflow.com/users/2144031/spring-dev101"
    },
    "creation_date" : 1761474284,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140817643,
    "post_id" : 79799961,
    "body" : "Did you try using getMaxDescent() instead of getDescent()?",
    "score" : 0,
    "owner" : {
      "account_id" : 21851467,
      "reputation" : 974,
      "user_id" : 16143492,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/PMrGU.png?s=256",
      "display_name" : "nineninesevenfour",
      "link" : "https://stackoverflow.com/users/16143492/nineninesevenfour"
    },
    "creation_date" : 1761473160,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}