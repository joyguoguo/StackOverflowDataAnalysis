{
  "question" : {
    "question_id" : 79540852,
    "title" : "Selecting JTree node on popup",
    "body" : "<p>Here's a task. We need a custom popup menu for our <code>JTree</code> extension. Right click should trigger not only the popup, but also selection of the tree's appropriate node. The analyst was explicit: clicking a node and then right-clicking to trigger a popup won't do, it should all happen on a single right click.</p>\n<p><strong>Important:</strong> selection should beat the popup as the menu composition depends on which tree node is clicked.</p>\n<p>Manually showing the popup in the <code>MouseListener</code> code is not a good idea: we have a complex component composition, many of our components have their own popups, and sometimes we need to make sure a component delegates popup trigger handling to its parent component. While it's possible by setting <code>inheritsPopupMenu</code> to <code>true</code> if the popup is set conventionally, regular <code>MouseListener</code>s do not respect that property.</p>\n<p>Sadly, <code>PopupEvent</code> has no knowledge of x, y coordinates of the click. For that reason, I also can't select a tree node in the <code>javax.swing.event.PopupMenuListener#popupMenuWillBecomeVisible</code> method. It makes sense, if you think about it, as popups may be triggered in a number of ways, not all of them involve mouse clicks.</p>\n<p>Here's a demo that attaches a separate <code>MouseListener</code> to select a node. However, as you may see, no node is ever selected. It's because the event is consumed by a popup trigger handler (see <code>javax.swing.plaf.basic.BasicLookAndFeel.AWTEventHelper#eventDispatched</code>).</p>\n<p>How do I achieve my goal?</p>\n<pre class=\"lang-java prettyprint-override\"><code>import javax.swing.JFrame;\nimport javax.swing.JMenuItem;\nimport javax.swing.JPanel;\nimport javax.swing.JPopupMenu;\nimport javax.swing.JTree;\nimport javax.swing.WindowConstants;\nimport javax.swing.event.PopupMenuEvent;\nimport javax.swing.event.PopupMenuListener;\nimport java.awt.BorderLayout;\nimport java.awt.Container;\nimport java.awt.event.MouseAdapter;\nimport java.awt.event.MouseEvent;\n\npublic class TreePopupDemo {\n\n    private static JTree tree;\n\n    public static void main(String[] args) {\n        Container mainPanel = createMainPanel();\n        JFrame frame = new JFrame(&quot;Tree Popup Demo&quot;);\n        frame.setContentPane(mainPanel);\n        frame.setLocationRelativeTo(null);\n        frame.pack();\n        frame.setDefaultCloseOperation(WindowConstants.EXIT_ON_CLOSE);\n        frame.setVisible(true);\n    }\n\n    private static JPanel createMainPanel() {\n        JPanel panel = new JPanel(new BorderLayout());\n        panel.add(createTree());\n        return panel;\n    }\n\n    private static JTree createTree() {\n        tree = new JTree();\n        tree.setComponentPopupMenu(createTreePopup());\n        tree.addMouseListener(new MouseAdapter() {\n            @Override\n            public void mouseClicked(MouseEvent e) {\n                onTreeClick(e);\n            }\n        });\n        return tree;\n    }\n\n    private static JPopupMenu createTreePopup() {\n        JPopupMenu popup = new JPopupMenu();\n        PopupMenuListener listener = new PopupMenuAdapter() {\n            @Override\n            public void popupMenuWillBecomeVisible(PopupMenuEvent e) {\n                beforePopupAppears();\n            }\n        };\n        popup.addPopupMenuListener(listener);\n        popup.add(createTestPopupItem());\n        return popup;\n    }\n\n    private static void beforePopupAppears() {\n        int[] selectionRows = tree.getSelectionRows();\n        int selectionRow = isEmpty(selectionRows) ? -1 : selectionRows[0];\n        System.out.println(&quot;Selected tree row: &quot; + selectionRow);\n    }\n\n    private static boolean isEmpty(int[] selectionRows) {\n        return selectionRows == null || selectionRows.length == 0;\n    }\n\n    private static JMenuItem createTestPopupItem() {\n        JMenuItem menuItem = new JMenuItem(&quot;Test popup item&quot;);\n        return menuItem;\n    }\n\n    private static void onTreeClick(MouseEvent e) {\n        int x = e.getX();\n        int y = e.getY();\n        int row = tree.getRowForLocation(x, y);\n        if (row &gt;= 0) tree.setSelectionRow(row);\n    }\n\n    private static class PopupMenuAdapter implements PopupMenuListener {\n\n        @Override\n        public void popupMenuWillBecomeVisible(PopupMenuEvent e) {\n        }\n\n        @Override\n        public void popupMenuWillBecomeInvisible(PopupMenuEvent e) {\n        }\n\n        @Override\n        public void popupMenuCanceled(PopupMenuEvent e) {\n        }\n    }\n}\n</code></pre>\n",
    "tags" : [ "java", "swing" ],
    "owner" : {
      "account_id" : 10187542,
      "reputation" : 2679,
      "user_id" : 20692967,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
      "display_name" : "Sergey Zolotarev",
      "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
    },
    "is_answered" : false,
    "view_count" : 91,
    "answer_count" : 2,
    "score" : 2,
    "last_activity_date" : 1743194661,
    "creation_date" : 1743149557,
    "link" : "https://stackoverflow.com/questions/79540852/selecting-jtree-node-on-popup",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79541177,
    "question_id" : 79540852,
    "body" : "<p>You can try and select the node on mouse <em>press</em> thereby circumventing the <code>InputEvent#consume</code> invocation by a popup trigger handler. It doesn't come into play before the button is released.</p>\n<pre><code>tree.addMouseListener(new MouseAdapter() {\n    @Override\n    public void mousePressed(MouseEvent e) {\n        onTreePress(e); // renamed onTreeClick(e)\n    }\n});\n</code></pre>\n<p>Whether it's an acceptable compromise for your application depends on your analyst's expectations.</p>\n<p>Also, make sure the <code>&quot;PopupMenu.consumeEventOnClose&quot;</code> property is set to <code>false</code> unless you are comfortable with your selection not working when the popup is visible. The property's default value depends on L&amp;F.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 10187542,
      "reputation" : 2679,
      "user_id" : 20692967,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/NZSXm.jpg?s=256",
      "display_name" : "Sergey Zolotarev",
      "link" : "https://stackoverflow.com/users/20692967/sergey-zolotarev"
    },
    "creation_date" : 1743157704,
    "last_activity_date" : 1743166640,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79542376,
    "question_id" : 79540852,
    "body" : "<p>It is not possible to (cleanly) achieve what you want while using <code>setComponentPopupMenu</code>.</p>\n<p>You will have to show the context menu manually, like we used to do before Java 1.5:</p>\n<pre><code>private static JTree createTree() {\n    tree = new JTree();\n\n    JPopupMenu menu = createTreePopup();\n    tree.addMouseListener(new MouseAdapter() {\n        private void showMenu(MouseEvent e) {\n            if (menu.isPopupTrigger(e)) {\n                int x = e.getX();\n                int y = e.getY();\n                int row = tree.getClosestRowForLocation(x, y);\n                if (row &gt;= 0 &amp;&amp; !tree.isRowSelected(row)) {\n                    tree.setSelectionRows(new int[] { row });\n                }\n                EventQueue.invokeLater(() -&gt; menu.show(tree, x, y));\n            }\n        }\n\n        @Override\n        public void mouseClicked(MouseEvent e) {\n            showMenu(e);\n        }\n\n        @Override\n        public void mousePressed(MouseEvent e) {\n            showMenu(e);\n        }\n\n        @Override\n        public void mouseReleased(MouseEvent e) {\n            showMenu(e);\n        }\n    });\n    String showMenuID = &quot;showPopupMenu&quot;;\n    tree.getActionMap().put(showMenuID, new AbstractAction() {\n        @Serial\n        private static final long serialVersionUID = 1;\n\n        @Override\n        public void actionPerformed(ActionEvent event) {\n            Point menuLocation;\n            int row = tree.getLeadSelectionRow();\n            if (row &gt;= 0) {\n                Rectangle bounds = tree.getRowBounds(row);\n                menuLocation = new Point(bounds.x + bounds.width / 2,\n                                         bounds.y + bounds.height / 2);\n            } else {\n                menuLocation = tree.getMousePosition();\n                if (menuLocation == null) {\n                    menuLocation = new Point();\n                }\n            }\n            menu.show(tree, menuLocation.x, menuLocation.y);\n        }\n    });\n    tree.getInputMap().put(\n        KeyStroke.getKeyStroke(&quot;CONTEXT_MENU&quot;), showMenuID);\n    tree.getInputMap().put(\n        KeyStroke.getKeyStroke(&quot;shift F10&quot;), showMenuID);\n\n    return tree;\n}\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44936,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1743194661,
    "last_activity_date" : 1743194661,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}