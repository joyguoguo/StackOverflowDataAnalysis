{
  "question" : {
    "question_id" : 79557074,
    "title" : "GluonFX UnsatisfiedLinkError / use .dll in .jar when running native image",
    "body" : "<p>I get</p>\n<pre><code>[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB] Exception in thread &quot;main&quot; java.lang.RuntimeException: Exception in Application start method\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.LauncherImpl.launchApplication1(LauncherImpl.java:893)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.LauncherImpl.lambda$launchApplication$2(LauncherImpl.java:195)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at java.base@23/java.lang.Thread.runWith(Thread.java:1588)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at java.base@23/java.lang.Thread.run(Thread.java:1575)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:836)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at org.graalvm.nativeimage.builder/com.oracle.svm.core.thread.PlatformThreads.threadStartRoutine(PlatformThreads.java:812)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB] Caused by: java.lang.UnsatisfiedLinkError: File /jni/win/x86_64/jd2xx.dll was not found inside JAR.\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at jd2xx.JD2XX.&lt;clinit&gt;(JD2XX.java:760)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at org.example.App.start(App.java:19)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.LauncherImpl.lambda$launchApplication1$9(LauncherImpl.java:839)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.PlatformImpl.lambda$runAndWait$12(PlatformImpl.java:483)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.PlatformImpl.lambda$runLater$10(PlatformImpl.java:456)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at java.base@23/java.security.AccessController.executePrivileged(AccessController.java:132)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at java.base@23/java.security.AccessController.doPrivileged(AccessController.java:400)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.javafx.application.PlatformImpl.lambda$runLater$11(PlatformImpl.java:455)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.glass.ui.InvokeLaterDispatcher$Future.run(InvokeLaterDispatcher.java:95)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.glass.ui.win.WinApplication._runLoop(Native Method)\n[Sat Apr 05 15:47:01 CEST 2025][INFO] [SUB]     at com.sun.glass.ui.win.WinApplication.lambda$runLoop$3(WinApplication.java:185)\n</code></pre>\n<p>When running mvn gluonfx:nativerun</p>\n<p>I have followed the requirements documented at <a href=\"https://docs.gluonhq.com/#_maven_archetype\" rel=\"nofollow noreferrer\">https://docs.gluonhq.com/#_maven_archetype</a> &amp; <a href=\"https://docs.gluonhq.com/#platforms_windows\" rel=\"nofollow noreferrer\">https://docs.gluonhq.com/#platforms_windows</a></p>\n<p>Project created in IntelliJ Idea and I'm using Maven ver. 3.8.8</p>\n<p>I use the X64 Native Tools Command Prompt (using Windows 11 Pro) with below goals:</p>\n<pre><code>mvn gluonfx:run \nmvn gluonfx:runagent\nmvn gluonfx:build \nmvn gluonfx:nativerun\n</code></pre>\n<p>When jd2xx is not included in the project I can run all 4 goals just fine so I guess my setup is done right.</p>\n<p>jd2xx is a library for interactions with ftdi-chips running serial-connection and can be found here: <a href=\"https://github.com/0x6a77/JD2XX/tree/master/jd2xx\" rel=\"nofollow noreferrer\">https://github.com/0x6a77/JD2XX/tree/master/jd2xx</a> -&gt; jd2xx.jar (&quot;added a ready-to-use JAR file&quot;).</p>\n<p>I have updated (using jdeps, javac and jar) the .jar with a module-info.class so it can be used with modular java.</p>\n<p>jd2xx.jar is copied to local Maven repository using</p>\n<pre><code>mvn install:install-file -Dfile=C:\\java\\jd2xx\\jd2xx.jar -DgroupId=com.example -DartifactId=jd2xx -Dversion=1.0.0 -Dpackaging=jar -DlocalRepositoryPath=C:\\xx\\yy\\.m2\\repository\n</code></pre>\n<p>When I include jd2xx in the project I can only run the first three goals and get above exception when running gluonfx:nativerun goal</p>\n<p>This is my MRE:</p>\n<pre><code>package org.example;\n\nimport javafx.application.Application;\nimport javafx.scene.Scene;\nimport javafx.scene.control.Label;\nimport javafx.scene.layout.StackPane;\nimport javafx.stage.Stage;\nimport jd2xx.JD2XX;\n\nimport java.io.IOException;\n\npublic class App extends Application {\n\n    @Override\n    public void start(Stage stage) throws IOException {\n\n        Label labelWithJD2XXInfo = new Label();\n\n        JD2XX chosenPort = new JD2XX();\n        chosenPort.open(0);\n        chosenPort.setBaudRate(250000);\n        chosenPort.setDataCharacteristics(JD2XX.BITS_8, JD2XX.STOP_BITS_2, JD2XX.PARITY_NONE);\n        chosenPort.setFlowControl(JD2XX.FLOW_NONE, 0, 0);\n        labelWithJD2XXInfo.setText(String.valueOf(chosenPort.getDeviceInfo()));\n\n        var scene = new Scene(new StackPane(labelWithJD2XXInfo), 800, 500);\n\n        stage.setScene(scene);\n        stage.show();\n\n    }\n\n    public static void main(String[] args) {\n        launch();\n    }\n\n}\n</code></pre>\n<p>This is my pom.xml:</p>\n<pre><code>&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;groupId&gt;org.example&lt;/groupId&gt;\n    &lt;artifactId&gt;test&lt;/artifactId&gt;\n    &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt;\n    &lt;properties&gt;\n        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;\n        &lt;maven.compiler.source&gt;21&lt;/maven.compiler.source&gt;\n        &lt;maven.compiler.target&gt;21&lt;/maven.compiler.target&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;com.example&lt;/groupId&gt;\n            &lt;artifactId&gt;jd2xx&lt;/artifactId&gt;\n            &lt;version&gt;1.0.0&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.openjfx&lt;/groupId&gt;\n            &lt;artifactId&gt;javafx-controls&lt;/artifactId&gt;\n            &lt;version&gt;24&lt;/version&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;com.gluonhq&lt;/groupId&gt;\n                &lt;artifactId&gt;gluonfx-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;1.0.26&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;mainClass&gt;org.example.App&lt;/mainClass&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;\n                &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;\n                &lt;version&gt;3.8.0&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;release&gt;21&lt;/release&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.openjfx&lt;/groupId&gt;\n                &lt;artifactId&gt;javafx-maven-plugin&lt;/artifactId&gt;\n                &lt;version&gt;0.0.8&lt;/version&gt;\n                &lt;configuration&gt;\n                    &lt;mainClass&gt;org.example.App&lt;/mainClass&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n</code></pre>\n\n<p>This is the module-info.java:</p>\n<pre><code>module org.example {\n    requires javafx.controls;\n    requires jd2xx;\n    exports org.example;\n}\n</code></pre>\n<p>When running <strong>gluonfx:runagent</strong> goal the config files are generated in /native-image/ and if I look in resource-config.json I can see that runagent picked up jd2xx as it is listed with</p>\n<pre><code>{\n&quot;pattern&quot;:&quot;jd2xx:\\\\Qjni\\/win\\/x86_64\\/jd2xx.dll\\\\E&quot;\n}\n</code></pre>\n<p>jni-config.json also have info about jd2xx:</p>\n<pre><code>{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XX$DeviceInfo;&quot;\n},\n{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XX$DeviceInfo;&quot;\n},\n{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XX;&quot;\n},\n{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XX;&quot;\n},\n{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XXEventListener;&quot;\n},\n{\n  &quot;type&quot;:&quot;Ljd2xx.JD2XXEventListener;&quot;\n},\n...\n...\n...\n{\n  &quot;type&quot;:&quot;jd2xx.JD2XX&quot;,\n  &quot;fields&quot;:[{&quot;name&quot;:&quot;event&quot;},{&quot;name&quot;:&quot;handle&quot;},{&quot;name&quot;:&quot;kill&quot;},{&quot;name&quot;:&quot;listener&quot;}]\n},\n{\n  &quot;type&quot;:&quot;jd2xx.JD2XX&quot;,\n  &quot;fields&quot;:[{&quot;name&quot;:&quot;event&quot;},{&quot;name&quot;:&quot;handle&quot;},{&quot;name&quot;:&quot;kill&quot;},{&quot;name&quot;:&quot;listener&quot;}]\n},\n{\n  &quot;type&quot;:&quot;jd2xx.JD2XX$DeviceInfo&quot;,\n  &quot;fields&quot;:[{&quot;name&quot;:&quot;description&quot;},{&quot;name&quot;:&quot;id&quot;},{&quot;name&quot;:&quot;serial&quot;},{&quot;name&quot;:&quot;type&quot;}]\n},\n{\n  &quot;type&quot;:&quot;jd2xx.JD2XX$DeviceInfo&quot;,\n  &quot;fields&quot;:[{&quot;name&quot;:&quot;description&quot;},{&quot;name&quot;:&quot;id&quot;},{&quot;name&quot;:&quot;serial&quot;},{&quot;name&quot;:&quot;type&quot;}]\n}\n</code></pre>\n<p><strong>Not sure this is relevant but:</strong></p>\n<p>Jd2xx.jar contains a .dll (jd2xx.dll) which needs 3 other .dll files:\nftd2xx.dll, kernel32.dll &amp; msvcrt.dll which in my case all can be found  in ../windows/system32</p>\n<p><strong>Updated 8/4/2025</strong></p>\n<p>As you properly know, &quot;File /jni/win/x86_64/jd2xx.dll was not found inside JAR&quot;, is a custom message set in the java class (jd2xx.jar -&gt; NativeUtils -&gt; loadLibraryFromJar) when it tries to load the .dll that is located in the .jar under /jni/win/x86_64/</p>\n<pre><code>      if (!var5.exists()) {\n            throw new FileNotFoundException(&quot;File &quot; + var5.getAbsolutePath() + &quot; does not exist.&quot;);\n        } else {\n            byte[] var6 = new byte[1024];\n            InputStream var8 = NativeUtils.class.getResourceAsStream(var0);\n            if (var8 == null) {\n                throw new FileNotFoundException(&quot;File &quot; + var0 + &quot; was not found inside JAR.&quot;);\n            }\n</code></pre>\n<p>I have no idea how gluonfx handles .dll insides jars but maybe it is worth for someone.</p>\n",
    "tags" : [ "java", "javafx", "graalvm", "graalvm-native-image", "gluonfx" ],
    "owner" : {
      "account_id" : 8022892,
      "reputation" : 184,
      "user_id" : 6050980,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/5ac27bb4f07c147810844d92bfe31bd7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "droid",
      "link" : "https://stackoverflow.com/users/6050980/droid"
    },
    "is_answered" : false,
    "view_count" : 337,
    "answer_count" : 2,
    "score" : 5,
    "last_activity_date" : 1744987620,
    "creation_date" : 1743861923,
    "link" : "https://stackoverflow.com/questions/79557074/gluonfx-unsatisfiedlinkerror-use-dll-in-jar-when-running-native-image",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79571384,
    "question_id" : 79557074,
    "body" : "<p>You should run the project defining the dll path explicitly. It might be troublesome to get the dll out of the jar, anyhow it doesn't seem to be working for you. Try defining -Djava.library.path = &quot;%~dp0natives&quot;, and place the dll in &quot;rundir/natives/jni/win/x86_64/jd2xx.dll&quot;</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 35129257,
      "reputation" : 1,
      "user_id" : 27000213,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ae8d87ec55505d6e495c7c3a4b3f55b2?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Munil Mistera",
      "link" : "https://stackoverflow.com/users/27000213/munil-mistera"
    },
    "creation_date" : 1744536446,
    "last_activity_date" : 1744536446,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79574116,
    "question_id" : 79557074,
    "body" : "<p>JD2XX is 12 years old, I <a href=\"https://github.com/ozkanpakdil/JD2XX/tree/rename-fortest\" rel=\"nofollow noreferrer\">needed to upgrade</a> it a little bit, especially loading libraries and mvn project structure,\nand one classnotfound I could not solve so I comment <a href=\"https://github.com/ozkanpakdil/JD2XX/blob/fe5ec902ced21377158098022659232c89164697/jd2xx/src/JD2XX.c#L176\" rel=\"nofollow noreferrer\">that</a> out</p>\n<p>after that I ran <code>mvn gluonfx:build</code> and then ran the native and got error below</p>\n<pre><code>[Mon Apr 14 23:22:57 BST 2025][INFO] [SUB] Loading /jni/win/x86_64/jd2xx.dll from JAR to C:\\Users\\ozkan\\AppData\\Local\\Temp\\jd2xx8141475470135303702.dll\n[Mon Apr 14 23:22:57 BST 2025][INFO] [SUB] Failed to initialize JD2XX: device not found (2)\n[Mon Apr 14 23:22:57 BST 2025][INFO] [SUB] java.io.IOException: device not found (2)\n</code></pre>\n<p>Meaning it looks like loading dlls nicely from the dependency and tried to open the device and got error.</p>\n<p>This means the DLL extracted from a jar can be loaded with <code>System.load()</code>, short example</p>\n<pre class=\"lang-java prettyprint-override\"><code>if (osName.contains(&quot;win&quot;)) {\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftcserco.dll&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftd2xx.dll&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftdibus.sys&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftlang.dll&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftser2k.sys&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/ftserui2.dll&quot;);\n    NativeUtils.unzipTheDependency(&quot;/jni/win/x86_64/jd2xx.dll&quot;);\n}\nNativeUtils.loadLibraryFromJar(lib.toString());\n\n........\npublic static void unzipTheDependency(String path) {\n    // Create a unique temporary directory for this run\n    String uniqueDir = &quot;jd2xx_&quot; + System.currentTimeMillis();\n    File tempDir = new File(System.getProperty(&quot;java.io.tmpdir&quot;), uniqueDir);\n    File temp = new File(tempDir, path);\n\n    try {\n        try (InputStream is = NativeUtils.class.getResourceAsStream(path)) {\n            if (!temp.exists()) {\n                temp.getParentFile().mkdirs();\n            }\n            Files.copy(Objects.requireNonNull(is), temp.toPath(), StandardCopyOption.REPLACE_EXISTING);\n            System.out.println(&quot;Unzipped &quot; + path + &quot; to &quot; + temp.getAbsolutePath());\n\n            // Add the parent directory to library path\n            String libraryPath = System.getProperty(&quot;java.library.path&quot;);\n            if (libraryPath == null || libraryPath.trim().isEmpty()) {\n                System.setProperty(&quot;java.library.path&quot;, temp.getParent());\n            } else if (!libraryPath.contains(temp.getParent())) {\n                System.setProperty(&quot;java.library.path&quot;, libraryPath + File.pathSeparator + temp.getParent());\n            }\n\n            // Load the library\n            System.load(temp.getAbsolutePath());\n        }\n    } catch (Exception e) {\n        // Clean up on failure\n        deleteDirectory(tempDir);\n        throw new RuntimeException(e);\n    }\n}\n\nprivate static void deleteDirectory(File directory) {\n    if (directory.exists()) {\n        File[] files = directory.listFiles();\n        if (files != null) {\n            for (File file : files) {\n                if (file.isDirectory()) {\n                    deleteDirectory(file);\n                } else {\n                    file.delete();\n                }\n            }\n        }\n        directory.delete();\n    }\n}\n</code></pre>\n<p>You can see the working JD2XX example <a href=\"https://github.com/ozkanpakdil/JD2XX/blob/fe5ec902ced21377158098022659232c89164697/jd2xx/src/main/java/io/github/ozkanpakdil/JD2XX.java#L846\" rel=\"nofollow noreferrer\">here</a> and the example app for using that as dependency <a href=\"https://github.com/ozkanpakdil/java-examlpes/tree/master/gluonfx-jd2xx\" rel=\"nofollow noreferrer\">here</a></p>\n<p>I also provide some jni and reflection config <a href=\"https://github.com/ozkanpakdil/JD2XX/tree/rename-fortest/jd2xx/src/main/resources/META-INF/native-image\" rel=\"nofollow noreferrer\">here</a> probably most of it not necessary but compiling and testing took so long I did not touch after I got the <code>device not found error</code></p>\n<p>So overall answer is gluon is not doing anything special about DLLs coming from jar, we need to do many extra checks and bits for making it work with GraalVM.</p>\n<p>In case anyone wonder why I changed the example name from jd2xx/JD2XX to io.github... because the exception was not understandable, was it having problem to load the dll or the namespace. This way it is more clear.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 58650,
      "reputation" : 4945,
      "user_id" : 175554,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/KmFczdGy.jpg?s=256",
      "display_name" : "ozkanpakdil",
      "link" : "https://stackoverflow.com/users/175554/ozkanpakdil"
    },
    "creation_date" : 1744670209,
    "last_activity_date" : 1744987620,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140325281,
    "post_id" : 79557074,
    "body" : "The jd2xx.dll exist in the JAR at /jni/win/x86_64/.  jd2xx.jar is at classpath, project runs just fine except when project is converted to native image. No have not set java.library.path",
    "score" : 0,
    "owner" : {
      "account_id" : 8022892,
      "reputation" : 184,
      "user_id" : 6050980,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/5ac27bb4f07c147810844d92bfe31bd7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "droid",
      "link" : "https://stackoverflow.com/users/6050980/droid"
    },
    "creation_date" : 1744387249,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140320236,
    "post_id" : 79557074,
    "body" : "I did not understand completely: does the file <i>jd2xx.dll</i> exist in the JAR file at the expected path (<i>/jni/win/x86_64/</i>) ? Is the JAR file <i>jd2xx.jar</i> contained in the classpath of the started application? Do you have set anything into the system property <code>java.library.path</code>?",
    "score" : 0,
    "owner" : {
      "account_id" : 3391382,
      "reputation" : 5360,
      "user_id" : 2846138,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/2sp68.png?s=256",
      "display_name" : "cyberbrain",
      "link" : "https://stackoverflow.com/users/2846138/cyberbrain"
    },
    "creation_date" : 1744286719,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}