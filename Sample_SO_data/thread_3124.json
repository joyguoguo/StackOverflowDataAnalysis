{
  "question" : {
    "question_id" : 79570555,
    "title" : "Spring Data JPA: Persistent Context Unexpected Behavior",
    "body" : "<p>The <code>CategoryRepository</code> is defined like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public interface CategoryRepository extends JpaRepository&lt;Category, Long&gt;{\n    @Transactional\n    @Query(&quot;select c from Category c where name = :name&quot;)\n    Optional&lt;Category&gt; findByName(String name);\n}\n</code></pre>\n<p>Here is the test case:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@SpringBootTest\n@TestInstance(TestInstance.Lifecycle.PER_CLASS)\npublic class CategoryRepositoryTests {\n    @Autowired\n    private CategoryRepository categoryRepository;\n\n    @Test\n    @Transactional\n    public void testCaching(){\n        categoryRepository.findByName(&quot;cat1&quot;);\n        categoryRepository.findByName(&quot;cat1&quot;);\n    }\n}\n</code></pre>\n<p>In db there is always a category named <code>cat1</code>. My expectation is after the 1st statement</p>\n<pre class=\"lang-java prettyprint-override\"><code>categoryRepository.findByName(&quot;cat1&quot;);\n</code></pre>\n<p><code>Category</code> object should be in persistence context and thus the second call shouldn't query the db again. This is not happening. The second call hits the db again. Here are the <a href=\"https://pastebin.com/raw/uwtZHdUm\" rel=\"nofollow noreferrer\">logs</a>.</p>\n",
    "tags" : [ "java", "hibernate", "jpa", "spring-data" ],
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "is_answered" : false,
    "view_count" : 131,
    "answer_count" : 2,
    "score" : 2,
    "last_activity_date" : 1744707307,
    "creation_date" : 1744467611,
    "link" : "https://stackoverflow.com/questions/79570555/spring-data-jpa-persistent-context-unexpected-behavior",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79574521,
    "question_id" : 79570555,
    "body" : "<p>Hibernate does not try to cache the result of every query executed. Only specific operations like findById benefit from the first-level cache. If you want broader caching, you can either use these methods or implement second-level caching.</p>\n<p>In general no transaction using @query will be cached.</p>\n<p><strong>Important note:</strong> when I say no transactions will be cached, I mean the query itself is not cached and if you run the query again it will query the database again; but the result of your query will be cached even if you use @query. for example in code below the second query which is findById will use the cached cat entity and will not query the database.</p>\n<pre><code>public class CategoryRepositoryTests {\n    @Autowired\n    private CategoryRepository categoryRepository;\n\n    @Test\n    @Transactional\n    public void testCaching(){\n            Category cat = categoryRepository.findByName(&quot;cat1&quot;);\n            categoryRepository.findById(cat.getId()).orElseThrow();\n            }\n    }\n</code></pre>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 6581444,
      "reputation" : 370,
      "user_id" : 5085623,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-4FUSM7l0oU8/AAAAAAAAAAI/AAAAAAAAAIs/w7M7J54UDr4/s256-rj/photo.jpg",
      "display_name" : "Mehdi Hamzezadeh",
      "link" : "https://stackoverflow.com/users/5085623/mehdi-hamzezadeh"
    },
    "creation_date" : 1744699743,
    "last_activity_date" : 1744701382,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79574734,
    "question_id" : 79570555,
    "body" : "<p>imagine you changed your test method to:</p>\n<pre><code>    @Test\n    @Transactional\n    public void testCaching(){\n        categoryRepository.findByName(&quot;cat1&quot;); // nothing found\n        Category entity = categoryRepository.findByName(&quot;cat2&quot;);\n        entity.setName(&quot;cat1&quot;);\n        categoryRepository.findByName(&quot;cat1&quot;);\n    }\n</code></pre>\n<p>what should happend? You would want to have that entity returned. This is why default configuration for JPA is to flush the persistence context to the database before a finder ist executed, so the SQL query will pick up that new entity you just created. And the SQL for the finder is always executed on the database.</p>\n<p>JPA doesn't have functionality to search the unflushed persistence context containing the in memory entities.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 3527935,
      "reputation" : 1500,
      "user_id" : 2948478,
      "user_type" : "registered",
      "accept_rate" : 79,
      "profile_image" : "https://www.gravatar.com/avatar/ca7f0a20f396f4f9972b957c13ba4d88?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "EasterBunnyBugSmasher",
      "link" : "https://stackoverflow.com/users/2948478/easterbunnybugsmasher"
    },
    "creation_date" : 1744707307,
    "last_activity_date" : 1744707307,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140329105,
    "post_id" : 79570555,
    "body" : "@RobertNiestroj  even after removing the <code>@Transactional</code> from query. I still see two queries.",
    "score" : 0,
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "creation_date" : 1744513047,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328710,
    "post_id" : 79570555,
    "body" : "Remove @Transactional from the repository method or call the method only once and access the entity again from the same context in test. Category c1 = categoryRepository.findByName(&quot;cat1&quot;).orElseThrow(); Category c2 = entityManager.find(Category.class, c1.getId()); // will not hit the DB",
    "score" : 0,
    "owner" : {
      "account_id" : 7645025,
      "reputation" : 440,
      "user_id" : 5795975,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-6KwPUS4RnyA/AAAAAAAAAAI/AAAAAAAAC8w/auZqreI45x0/s256-rj/photo.jpg",
      "display_name" : "Vijay",
      "link" : "https://stackoverflow.com/users/5795975/vijay"
    },
    "creation_date" : 1744496653,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328629,
    "post_id" : 79570555,
    "body" : "A PersistenceContext is bound to a Transaction. With the @Transactional on the query you have to transactions - two PersistenceContexts.",
    "score" : 0,
    "owner" : {
      "account_id" : 255080,
      "reputation" : 16221,
      "user_id" : 534877,
      "user_type" : "registered",
      "accept_rate" : 65,
      "profile_image" : "https://www.gravatar.com/avatar/b76e3e49d25290e650335ba8c44b84dd?s=256&d=identicon&r=PG",
      "display_name" : "Robert Niestroj",
      "link" : "https://stackoverflow.com/users/534877/robert-niestroj"
    },
    "creation_date" : 1744493289,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328207,
    "post_id" : 79570555,
    "body" : "What comes to mind is that since repo method is transactional, in the end of transaction it has to commit data to db and hence in next transaction (which is your second call of repo method) it has to check db again to make sure that data in persistence context is valid (in meaning that it is as is in db). Don&#39;t know if all this is true, just an idea.",
    "score" : 1,
    "owner" : {
      "account_id" : 16297191,
      "reputation" : 1152,
      "user_id" : 11769133,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d7c2d03d75b1aab69eda7c962b2b35a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Milos Stojanovic",
      "link" : "https://stackoverflow.com/users/11769133/milos-stojanovic"
    },
    "creation_date" : 1744478184,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140328139,
    "post_id" : 79570555,
    "body" : "I don&#39;t know. My previous comment was just an idea I had based on earlier docs readings, I don&#39;t know if it&#39;s true or not. Did you try without <code>@Transactional</code> annotations?",
    "score" : 0,
    "owner" : {
      "account_id" : 16297191,
      "reputation" : 1152,
      "user_id" : 11769133,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d7c2d03d75b1aab69eda7c962b2b35a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Milos Stojanovic",
      "link" : "https://stackoverflow.com/users/11769133/milos-stojanovic"
    },
    "creation_date" : 1744476461,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140327955,
    "post_id" : 79570555,
    "body" : "@MilosStojanovic is it because the objects are cached based on Id by default?",
    "score" : 0,
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "creation_date" : 1744471593,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140327913,
    "post_id" : 79570555,
    "body" : "Maybe it&#39;s got something to do with transactions. Maybe it resets EntityManager after every transaction (not likely I guess, but that&#39;s all that comes up to me).",
    "score" : 0,
    "owner" : {
      "account_id" : 16297191,
      "reputation" : 1152,
      "user_id" : 11769133,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d7c2d03d75b1aab69eda7c962b2b35a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Milos Stojanovic",
      "link" : "https://stackoverflow.com/users/11769133/milos-stojanovic"
    },
    "creation_date" : 1744470746,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140327907,
    "post_id" : 79570555,
    "body" : "@MilosStojanovic removed <code>@Query</code> still hitting db twice.",
    "score" : 0,
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "creation_date" : 1744470657,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140327868,
    "post_id" : 79570555,
    "body" : "What happens if you don&#39;t use custom query but mapping of function name?",
    "score" : 0,
    "owner" : {
      "account_id" : 16297191,
      "reputation" : 1152,
      "user_id" : 11769133,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/d7c2d03d75b1aab69eda7c962b2b35a3?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Milos Stojanovic",
      "link" : "https://stackoverflow.com/users/11769133/milos-stojanovic"
    },
    "creation_date" : 1744469873,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}