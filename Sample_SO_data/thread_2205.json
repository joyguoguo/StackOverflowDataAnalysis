{
  "question" : {
    "question_id" : 79638831,
    "title" : "Getting error while write partitioned data using delta kernel api",
    "body" : "<p>I am trying to write the data to Delta table without using spark. Thus I am exploring the Delta kernel APIs to write the data to delta tables.\nWhen I am trying to write a data which is partitioned on more than 1 column. I am getting an error as\njava.lang.RuntimeException: java.lang.UnsupportedOperationException: org.apache.parquet.column.values.dictionary.DictionaryValuesWriter$PlainIntegerDictionaryValuesWriter</p>\n<p>When I searched around this error I came across a solution which says this error is due to schema mismatch. However same data is being written into a delta table if a table is partitioned on 1 single column.</p>\n<pre><code>public void insertData(String tablePath, DeltaApiConfiguration deltaApiConfiguration) throws IOException {\n    Configuration hadoopConf = new Configuration();\n    Engine engine = DefaultEngine.create(hadoopConf);\n    hadoopConf.set(&quot;fs.defaultFS&quot;, deltaApiConfiguration.getDefaultFS());\n\n    Table table = Table.forPath(engine, tablePath);\n\n    List&lt;Row&gt; dataActions = new ArrayList&lt;&gt;();\n\n    TransactionBuilder txnBuilder =\n            table.createTransactionBuilder(\n                    engine,\n                    &quot;Insert data to delta table&quot;, /* engineInfo */\n                    Operation.MANUAL_UPDATE);\n\n    Transaction txn = txnBuilder.build(engine);\n    List&lt;String&gt; partitionedColumns = txn.getPartitionColumns(engine);\n\n    Row txnState = txn.getTransactionState(engine);\n\n    StructType schema = txn.getSchema(engine);\n\n    FilteredColumnarBatch batch1 = generatedPartitionedDataBatch(5 ,schema, partitionedColumns);\n    CloseableIterator&lt;FilteredColumnarBatch&gt; data = toCloseableIterator(Collections.singletonList(batch1).iterator());\n\n    Map&lt;String, Literal&gt; partitionValues = Map.of(\n            &quot;STATE&quot;, Literal.ofString(&quot;Goa&quot;),\n            &quot;CITY&quot;, Literal.ofString(&quot;Vasco&quot;)\n    );\n\n    CloseableIterator&lt;Row&gt; partitionedDataActions = getPartitionedData(engine, txnState, data, partitionValues);\n\n\n        while (partitionDataActions.hasNext()) {\n            System.out.println(&quot;while loop!!!&quot;);\n            dataActions.add(partitionDataActions.next());\n        }\n\n    CloseableIterable&lt;Row&gt; dataActionsIterable = CloseableIterable.inMemoryIterable(toCloseableIterator(partitionedDataActions));\n\n    txn.commit(engine, dataActionsIterable);\n}\n\npublic static CloseableIterator&lt;Row&gt; getPartitionedData(Engine engine, Row txnState, CloseableIterator&lt;FilteredColumnarBatch&gt; data, Map&lt;String, Literal&gt; partitionValues) throws IOException {\n    CloseableIterator&lt;DataFileStatus&gt; dataFiles = null;\n    DataWriteContext writeContext;\n    try {\n\n        CloseableIterator&lt;FilteredColumnarBatch&gt; physicalData = Transaction.transformLogicalData(engine, txnState, data, partitionValues);\n\n        writeContext = Transaction.getWriteContext(engine, txnState, partitionValues);\n\n        dataFiles = engine.getParquetHandler().writeParquetFiles(writeContext.getTargetDirectory(), physicalData, writeContext.getStatisticsColumns());\n    } catch (Exception e) {\n        e.printStackTrace();\n        throw new IOException(&quot;Error while writing data to delta table&quot;);\n    } finally {\n        if (data != null) {\n            data.close();\n        }\n    }\n    return Transaction.generateAppendActions(engine, txnState, dataFiles, writeContext);\n}\n</code></pre>\n<p>I am getting this error at while loop when the values are being unpacked.</p>\n<p>I am getting an error when the data is partitioned on more than 1 column. For data partitioned on single column this code works fine.</p>\n<p>I am using below link to explore the delta tables.\n<a href=\"https://docs.delta.io/latest/delta-kernel-java.htm\" rel=\"nofollow noreferrer\">https://docs.delta.io/latest/delta-kernel-java.htm</a></p>\n",
    "tags" : [ "java", "spring", "delta" ],
    "owner" : {
      "account_id" : 2863543,
      "reputation" : 9,
      "user_id" : 2458277,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/aqYcz.jpg?s=256",
      "display_name" : "Nikhil",
      "link" : "https://stackoverflow.com/users/2458277/nikhil"
    },
    "is_answered" : false,
    "view_count" : 41,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1748596756,
    "creation_date" : 1748258837,
    "link" : "https://stackoverflow.com/questions/79638831/getting-error-while-write-partitioned-data-using-delta-kernel-api",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140459274,
    "post_id" : 79638831,
    "body" : "Please <b><a href=\"https://stackoverflow.com/posts/79638831/edit\">edit</a></b> your question to include more tags. Like the tag for the language your snippet is written in.",
    "score" : 0,
    "owner" : {
      "account_id" : 196869,
      "reputation" : 411395,
      "user_id" : 440558,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://i.sstatic.net/9ZYta.jpg?s=256",
      "display_name" : "Some programmer dude",
      "link" : "https://stackoverflow.com/users/440558/some-programmer-dude"
    },
    "creation_date" : 1748259424,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}