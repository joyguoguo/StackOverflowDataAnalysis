{
  "question" : {
    "question_id" : 79703537,
    "title" : "MDC.clear() in dependency not working with interceptor",
    "body" : "<p>I have this class in my Spring Boot app:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class LogContextCleanerConfig {\n\n  @Bean\n  public LogContextCleaner logContextCleaner() {\n    return new LogContextCleaner();\n  }\n}\n\n</code></pre>\n<p>I also have WebConfig:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class WebConfig implements WebMvcConfigurer {\n  @Autowired private LogContextCleaner logContextCleaner;\n\n  @Override\n  public void addInterceptors(InterceptorRegistry registry) {\n    registry.addInterceptor(loggingInterceptor(logContextCleaner);\n  }\n\n  private HandlerInterceptor loggingInterceptor(LogContextCleaner logContextCleaner) {\n    return new HandlerInterceptor() {\n      @Override\n      public void afterCompletion(HttpServletRequest req, HttpSerletResponse res, Object hander, Exception ex) throws Exception {\n        logContextCleaner.afterCompletion(req, res, handler, ex);\n      }\n    };\n  } \n}\n</code></pre>\n<p>The afterCompletion is in a dependency and looks like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class LogContextCleaner implements HandlerInterceptor {\n  @Override\npublic void afterCompletion(HttpServletRequest req, HttpServletResponse res, Object handler, Exception ex) throws Exception {\n    MDC.clear();\n}\n</code></pre>\n<p>The <code>MDC.clear()</code> never seems to get executed though. I can't figure out why. Any pointers woud be greatly appreciated.</p>\n<p><strong>UPDATE</strong></p>\n<p>I was wrong to add <code>loggingInterceptor</code> and have now removed it. Also, I was clearing the wrong MDC above. The correct MDC is in OrdersLogContext. OrdersLogContext has the below method which I can see is getting executed but I still have the issue:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public void flush() {\n   try {\n      MDC.clear();\n   { catch(Exception e) {\n      LOGGER.errror(&quot;Unable to clear context&quot;, ex);\n   }\n}\n</code></pre>\n<p>I added <code>LOGGER.info(&quot;clear(): %s.formatted(MDC.getCopyOfContextMap());</code> above <code>MDC.clear()</code> to see if it shows anything. Strangely I'm now unable to recreate the issue. The context is clearing correctly. Is there any reason why this could be happening?</p>\n",
    "tags" : [ "java", "spring", "spring-boot", "logging", "interceptor" ],
    "owner" : {
      "account_id" : 10642398,
      "reputation" : 7580,
      "user_id" : 7836976,
      "user_type" : "registered",
      "accept_rate" : 95,
      "profile_image" : "https://www.gravatar.com/avatar/a57c0f1a2af768690957df659cc28f0f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "runnerpaul",
      "link" : "https://stackoverflow.com/users/7836976/runnerpaul"
    },
    "is_answered" : false,
    "view_count" : 116,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1754030387,
    "creation_date" : 1752674570,
    "link" : "https://stackoverflow.com/questions/79703537/mdc-clear-in-dependency-not-working-with-interceptor",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79704418,
    "question_id" : 79703537,
    "body" : "<p>You   are using the LogContextCleaner inside an anonymous interceptor.You dont register this interceptor directly. Thats why spring cant call the afterCompletion() method â€” you are missing the utilization of life cycle events and trying to do it manually.</p>\n<p>you can use a filter to clear MDC like below appraoch....</p>\n<pre><code>`@Component\npublic class MdcCleaningFilter implements Filter {\n    @Override\n    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) \n            throws IOException, ServletException {\n        try {\n            chain.doFilter(request, response);\n        } finally {\n            MDC.clear();//this block will execute reagdless of how the request processing completes\n        }\n    }\n}`\n</code></pre>\n<p>Or\nin your LogContextCleaner you can implement Handler Interceptor and use the lifecyle method</p>\n<pre><code>@Component\npublic class LogContextCleaner implements HandlerInterceptor {\n  @Override\n  public void afterCompletion(HttpServletRequest req, HttpServletResponse res, Object handler, Exception ex) throws Exception {\n    MDC.clear();\n  }\n}\n</code></pre>\n<p>dont forget to add the logContextCleaner in addInterCeptors in webconfig.</p>\n<pre><code>public class WebConfig implements WebMvcConfigurer {\n\n  @Autowired\n  private LogContextCleaner logContextCleaner;\n\n  @Override\n  public void addInterceptors(InterceptorRegistry registry) {\n    registry.addInterceptor(logContextCleaner);\n  }\n}```\n\n\n</code></pre>\n",
    "score" : -1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 4158688,
      "reputation" : 2485,
      "user_id" : 3409234,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/gS9Uo.jpg?s=256",
      "display_name" : "TanvirChowdhury",
      "link" : "https://stackoverflow.com/users/3409234/tanvirchowdhury"
    },
    "creation_date" : 1752736598,
    "last_activity_date" : 1752736894,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140634621,
    "post_id" : 79703537,
    "body" : "I added some info to my question but this issue seems to have gone away when I added a log line above <code>MDC.clear();</code>. Can&#39;t understand why that might be. Any thoughts would be greatly appreciated.",
    "score" : 0,
    "owner" : {
      "account_id" : 10642398,
      "reputation" : 7580,
      "user_id" : 7836976,
      "user_type" : "registered",
      "accept_rate" : 95,
      "profile_image" : "https://www.gravatar.com/avatar/a57c0f1a2af768690957df659cc28f0f?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "runnerpaul",
      "link" : "https://stackoverflow.com/users/7836976/runnerpaul"
    },
    "creation_date" : 1754030469,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140594420,
    "post_id" : 79703537,
    "body" : "Just check that you are calling <code>MDC.clear()</code> on the correct <code>MDC</code>. I just tried with an example, it worked as expected. Also, in this line <code>registry.addInterceptor(loggingInterceptor(logContextCleaner&zwnj;&#8203;);</code> - why are you creating another object of <code>HandlerInterceptor</code>. You could have just do <code>registry.addInterceptor(logContextCleaner);</code>.  It might be helpful if you add import statements.",
    "score" : 1,
    "owner" : {
      "account_id" : 5680162,
      "reputation" : 523,
      "user_id" : 4491666,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-SZHxcbzaPNE/AAAAAAAAAAI/AAAAAAAAAM4/tY118qIpbvo/s256-rj/photo.jpg",
      "display_name" : "Jitendra Kumar",
      "link" : "https://stackoverflow.com/users/4491666/jitendra-kumar"
    },
    "creation_date" : 1752680455,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79704418" : [ {
      "comment_id" : 140596026,
      "post_id" : 79704418,
      "body" : "@runnerpaul is this something you missed",
      "score" : 0,
      "owner" : {
        "account_id" : 4158688,
        "reputation" : 2485,
        "user_id" : 3409234,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/gS9Uo.jpg?s=256",
        "display_name" : "TanvirChowdhury",
        "link" : "https://stackoverflow.com/users/3409234/tanvirchowdhury"
      },
      "creation_date" : 1752736666,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140596025,
      "post_id" : 79704418,
      "body" : "He is registering the anonymous class, and the <code>HandlerInterceptor</code> doesn&#39;t have lifecycle callbacks.",
      "score" : 1,
      "owner" : {
        "account_id" : 3192259,
        "reputation" : 126800,
        "user_id" : 2696260,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
        "display_name" : "M. Deinum",
        "link" : "https://stackoverflow.com/users/2696260/m-deinum"
      },
      "creation_date" : 1752736664,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}