{
  "question" : {
    "question_id" : 79722940,
    "title" : "A collection with cascade=&quot;all-delete-orphan&quot; was no longer referenced by the owning entity instance: ProcedureStep.subSteps",
    "body" : "<p>My Java code is throwing the following error:\n&quot;A collection with cascade='all-delete-orphan' was no longer referenced by the owning entity instance: br.com.unika.pathdetail.entity.ProcedureStep.subSteps.&quot;</p>\n<p>This happens when trying to save an entity that comes from the client (frontend). The collection subSteps is not being modified or reassigned in the Java code; it is received as-is and directly passed to be saved. Despite that, Hibernate still triggers this error, likely interpreting that the original reference to the collection has been replaced or lost.</p>\n<p>I've already tried everything I can think of to resolve this issue, but nothing has worked.</p>\n<pre><code>@Entity\n@Table(name = &quot;procedure_step&quot;, indexes = {\n    @Index(name = &quot;idx_pstep_code&quot;, columnList = &quot;code, procedure_id&quot;),\n})\n@Data\npublic class ProcedureStep extends AbstractEntity&lt;ProcedureStep, ProcedureStepDTO&gt; {\n\n    @Id\n    @GeneratedValue(strategy = GenerationType.IDENTITY)\n    @Column(name = &quot;id&quot;)\n    private Long id;\n\n    @AuditableObject(mapBy = &quot;id&quot;)\n    @ManyToOne(fetch = FetchType.EAGER, optional = false)\n    @JoinColumn(name = &quot;account_id&quot;, updatable = false)\n    private Account account;\n\n    @AuditableObject(mapBy = &quot;name&quot;)\n    @ManyToOne(fetch = FetchType.LAZY, optional = false)\n    @JoinColumn(name = &quot;procedure_id&quot;, updatable = false)\n    private Procedure procedure;\n\n    @AuditableObject(mapBy = &quot;name&quot;)\n    @ManyToOne(fetch = FetchType.EAGER)\n    @JoinColumn(name = &quot;parent_step_id&quot;)\n    private ProcedureStep parentStep;\n\n    // ex: 1.1.1\n    @Auditable\n    @Column(nullable = false, length = 20)\n    private String code;\n\n    @Auditable\n    @Column(name = &quot;name&quot;, nullable = false)\n    private String name;\n\n    @Temporal(TemporalType.TIMESTAMP)\n    @Column(nullable = false, name = &quot;created_date&quot;, updatable=false)\n    private Date createdDate = new Date();\n\n    @OneToMany(mappedBy = &quot;step&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    private List&lt;StepParameter&gt; parameters = new ArrayList&lt;&gt;();\n\n    @OneToMany(mappedBy = &quot;parentStep&quot;, cascade = CascadeType.ALL, orphanRemoval = true)\n    private List&lt;ProcedureStep&gt; subSteps = new ArrayList&lt;&gt;();\n\n</code></pre>\n<pre><code>    @Transactional(rollbackFor = Exception.class)\n    public List&lt;ProcedureStepDTO&gt; saveMany(List&lt;ProcedureStepDTO&gt; dtoList) throws BusinessRuleException {\n\n        Set&lt;String&gt; newObjs = new HashSet&lt;&gt;();\n\n        // Convert all elements to DTO\n        List&lt;ProcedureStep&gt; toSave = dtoList.stream().map(ProcedureStepDTO::toEntity).toList();\n        for (ProcedureStep entity : toSave) {\n            validateUpdatePermission(entity);\n            if(entity.getId() == null) {\n                newObjs.add(entity.getUuidCheck());\n                beforePersist(entity);\n            } else {\n                beforeSave(entity);\n            }\n            commonValidations(entity);\n        }\n        \n        List&lt;ProcedureStep&gt; saved = repository.saveAll(toSave);\n        for (ProcedureStep s : saved) {\n            if(newObjs.contains(s.getUuidCheck())) {\n                this.afterPersist(s);\n            } else {\n                this.afterSave(s);\n            }\n        }\n        return saved.stream().map(ProcedureStep::toDTO).toList();\n    }\n</code></pre>\n<pre><code>    @Override\n    public ProcedureStep toEntity() {\n        ProcedureStep entity = new ProcedureStep();\n        this.mapCommonFields(entity);\n\n        entity.setCode(this.getCode());\n        entity.setName(this.getName());\n        entity.setCreatedDate(this.getCreatedDate());\n\n        if (this.account != null) {\n            entity.setAccount(this.account.toEntity());\n        }\n\n        if (this.procedure != null) {\n            entity.setProcedure(this.procedure.toEntity());\n        }\n\n        // Update parameters collection\n        if (entity.getParameters() == null) {\n            entity.setParameters(new ArrayList&lt;&gt;());\n        }\n        entity.getParameters().clear();\n        if (this.getParameters() != null &amp;&amp; !this.getParameters().isEmpty()) {\n            this.getParameters().forEach(parameter -&gt;\n                entity.getParameters().add(parameter.toEntity()));\n        }\n\n        // Update subSteps collection\n        if (entity.getSubSteps() == null) {\n            entity.setSubSteps(new ArrayList&lt;&gt;());\n        }\n        entity.getSubSteps().clear();\n        if (this.getSubSteps() != null &amp;&amp; !this.getSubSteps().isEmpty()) {\n            this.getSubSteps().forEach(subStepDTO -&gt;\n                entity.getSubSteps().add(subStepDTO.toEntity()));\n        }\n\n        return entity;\n    }\n</code></pre>\n",
    "tags" : [ "java", "hibernate", "spring-data-jpa" ],
    "owner" : {
      "account_id" : 21418493,
      "reputation" : 35,
      "user_id" : 15909439,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdbKo.jpg?s=256",
      "display_name" : "Arthur Andrade",
      "link" : "https://stackoverflow.com/users/15909439/arthur-andrade"
    },
    "is_answered" : false,
    "view_count" : 59,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1754936316,
    "creation_date" : 1754080929,
    "link" : "https://stackoverflow.com/questions/79722940/a-collection-with-cascade-all-delete-orphan-was-no-longer-referenced-by-the-ow",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140660272,
    "post_id" : 79722940,
    "body" : "Misunderstood of hibernate are made in that code, the best way is maybe to change the framework and use spring-data. It&#39;ll work like you think. If you need to keep hibernate you need to get entity from database (if exists) and modify them, not to create new Entity. I can create new Entity only if it doesn&#39;t exist yet in database.",
    "score" : 0,
    "owner" : {
      "account_id" : 4739993,
      "reputation" : 2062,
      "user_id" : 3833111,
      "user_type" : "registered",
      "accept_rate" : 100,
      "profile_image" : "https://i.sstatic.net/kL1Bd.png?s=256",
      "display_name" : "Mr_Thorynque",
      "link" : "https://stackoverflow.com/users/3833111/mr-thorynque"
    },
    "creation_date" : 1755006172,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140658155,
    "post_id" : 79722940,
    "body" : "@Turo The front sends the whole edited list, then I just try to save it.",
    "score" : 0,
    "owner" : {
      "account_id" : 21418493,
      "reputation" : 35,
      "user_id" : 15909439,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdbKo.jpg?s=256",
      "display_name" : "Arthur Andrade",
      "link" : "https://stackoverflow.com/users/15909439/arthur-andrade"
    },
    "creation_date" : 1754936475,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140658147,
    "post_id" : 79722940,
    "body" : "@rahulP I&#39;ve added the code snippet, thats all",
    "score" : 0,
    "owner" : {
      "account_id" : 21418493,
      "reputation" : 35,
      "user_id" : 15909439,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pdbKo.jpg?s=256",
      "display_name" : "Arthur Andrade",
      "link" : "https://stackoverflow.com/users/15909439/arthur-andrade"
    },
    "creation_date" : 1754936356,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140644657,
    "post_id" : 79722940,
    "body" : "Do you have a Tree-Structure? You have a cascade all on the substeps, so if the frontend doesn&#39;t send the complete tree, the connection from substep to its substeps might be the problem",
    "score" : 0,
    "owner" : {
      "account_id" : 8026267,
      "reputation" : 5044,
      "user_id" : 6053084,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/616306286f1da49445d0f5f944440c2d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Turo",
      "link" : "https://stackoverflow.com/users/6053084/turo"
    },
    "creation_date" : 1754427213,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140641107,
    "post_id" : 79722940,
    "body" : "How you are setting the subSteps in the toSave entity list?",
    "score" : 0,
    "owner" : {
      "account_id" : 5300710,
      "reputation" : 589,
      "user_id" : 4230445,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/LBxxS.png?s=256",
      "display_name" : "rahulP",
      "link" : "https://stackoverflow.com/users/4230445/rahulp"
    },
    "creation_date" : 1754319338,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}