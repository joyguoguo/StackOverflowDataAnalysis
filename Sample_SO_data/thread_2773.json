{
  "question" : {
    "question_id" : 79596635,
    "title" : "Issue with Casting `TraceContext` in `micrometer-tracing-test` Library",
    "body" : "<h3>Description:</h3>\n<p>I am encountering an issue while working with the <code>micrometer-tracing-test</code> library in a Java project.</p>\n<pre class=\"lang-java prettyprint-override\"><code>Map&lt;String, String&gt; baggageFromParent = ((SimpleTraceContext) context).baggageFromParent();\n</code></pre>\n<p>Both <code>OtelTraceContext</code> and <code>SimpleTraceContext</code> share the same parent interface, <code>TraceContext</code>. However, the cast fails at runtime with a <code>ClassCastException</code>.</p>\n<h3>Context:</h3>\n<ul>\n<li><strong>Library</strong>: <code>io.micrometer:micrometer-tracing-test:1.1.9</code></li>\n<li><strong>Additional Library</strong>: <code>micrometer-tracing-bridge-otel</code> (on the classpath)</li>\n<li><strong>Language</strong>: Java</li>\n<li><strong>Build Tool</strong>: Gradle</li>\n<li><strong>Testing Framework</strong>: JUnit 5</li>\n</ul>\n<h3>Code Snippet:</h3>\n<p>Here is the relevant part of the code from micrometer-tracing-test. This code was added in v1.1.9 so if I use version before this, it's working fine.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Override\npublic Scope newScope(TraceContext context) {\n    if (context == null) {\n        SimpleTracer.resetCurrentSpan();\n        return Scope.NOOP;\n    }\n    SimpleSpan previous = SimpleTracer.getCurrentSpan();\n    SimpleTracer.setCurrentSpan(context);\n    Map&lt;String, String&gt; baggageFromParent = ((SimpleTraceContext) context).baggageFromParent(); // Fails here\n    List&lt;BaggageInScope&gt; baggageInScope = baggageFromParent.entrySet()\n        .stream()\n        .map(entry -&gt; simpleTracer.simpleBaggageManager.createBaggageInScope(context, entry.getKey(),\n                entry.getValue()))\n        .collect(Collectors.toList());\n    return previous != null ? new RevertToPreviousScope(previous, baggageInScope) : new RevertToNullScope();\n}\n</code></pre>\n<h3>Error</h3>\n<p>java.lang.ClassCastException: class io.micrometer.tracing.otel.bridge.OtelTraceContext cannot be cast to class io.micrometer.tracing.test.simple.SimpleTraceContext (io.micrometer.tracing.otel.bridge.OtelTraceContext and io.micrometer.tracing.test.simple.SimpleTraceContext are in unnamed module of loader 'app')</p>\n<h3>Observations:</h3>\n<ol>\n<li><code>OtelTraceContext</code> and <code>SimpleTraceContext</code> both implement <code>TraceContext</code>.</li>\n<li>The cast fails because the runtime type of <code>context</code> is <code>OtelTraceContext</code>, not <code>SimpleTraceContext</code>.</li>\n<li>The <code>micrometer-tracing-bridge-otel</code> library is also on the classpath, which likely causes <code>OtelTraceContext</code> to be used in some cases.</li>\n</ol>\n<h3>Question:</h3>\n<p>How can I handle this situation properly? Should I refactor the code to avoid casting, or is there a better way to ensure compatibility between these implementations?</p>\n",
    "tags" : [ "java", "micrometer", "otel", "micrometer-tracing" ],
    "owner" : {
      "account_id" : 8265735,
      "reputation" : 51,
      "user_id" : 6215356,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/964684900267146/picture?type=large",
      "display_name" : "Jagdish Raika",
      "link" : "https://stackoverflow.com/users/6215356/jagdish-raika"
    },
    "is_answered" : true,
    "view_count" : 106,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1745851520,
    "creation_date" : 1745848972,
    "link" : "https://stackoverflow.com/questions/79596635/issue-with-casting-tracecontext-in-micrometer-tracing-test-library",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79596718,
    "question_id" : 79596635,
    "body" : "<p>There are <a href=\"https://github.com/search?q=repo%3Amicrometer-metrics%2Ftracing+%22public+Scope+newScope%22&amp;type=code\" rel=\"nofollow noreferrer\">multiple implementations of <code>newTrace</code></a>. It would seem that the wrong one is being invoked. Are you invoking it directly, or is this happening automatically? A stacktrace from the CCE might be useful.</p>\n<p>Best I can tell, the context implementation is dictated by the Tracer implementation. Where/how are you instantiating your tracer? Is it a SimpleTracer or an OtelTracer? You need to be consistent to avoid this sort of exception.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 255381,
      "reputation" : 2000,
      "user_id" : 535401,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/ltK0q.jpg?s=256",
      "display_name" : "JakeRobb",
      "link" : "https://stackoverflow.com/users/535401/jakerobb"
    },
    "creation_date" : 1745851520,
    "last_activity_date" : 1745851520,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79596718" : [ {
      "comment_id" : 140411859,
      "post_id" : 79596718,
      "body" : "Now we need to clarify: do you want it to do OpenTelemetry-compliant tracing? If so, you need that library. The code with the problematic cast is in SimpleCurrentTraceContext, and is not designed to be used with Otel. If you don&#39;t need Otel, removing that library is the right choice. If you do need Otel, then I&#39;d need at minimum the complete stacktrace from that classCastException (including class names and line numbers from your own project) to help further.",
      "score" : 0,
      "owner" : {
        "account_id" : 255381,
        "reputation" : 2000,
        "user_id" : 535401,
        "user_type" : "registered",
        "accept_rate" : 40,
        "profile_image" : "https://i.sstatic.net/ltK0q.jpg?s=256",
        "display_name" : "JakeRobb",
        "link" : "https://stackoverflow.com/users/535401/jakerobb"
      },
      "creation_date" : 1746810979,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140400380,
      "post_id" : 79596718,
      "body" : "I am not invoking it directly. After debugging it, found that it is OtelTracer as micrometer-tracing-bridge-otel` is on classpath. If I exclude the dependency, the issue is not coming. From 1.0.9 version, explicitly type casting of context is creating the issue.  ` Map&lt;String, String&gt; baggageFromParent = ((SimpleTraceContext) context).baggageFromParent(); `",
      "score" : 0,
      "owner" : {
        "account_id" : 8265735,
        "reputation" : 51,
        "user_id" : 6215356,
        "user_type" : "registered",
        "profile_image" : "https://graph.facebook.com/964684900267146/picture?type=large",
        "display_name" : "Jagdish Raika",
        "link" : "https://stackoverflow.com/users/6215356/jagdish-raika"
      },
      "creation_date" : 1746535053,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}