{
  "question" : {
    "question_id" : 79573235,
    "title" : "Upload file to Redmine API via quarkus Java",
    "body" : "<p>I have an issue that I cannot solve.\nI need to upload files to Redmine via its API, but I can't call the API directly, I need to call our internal API that redirects my calls to the Redmine API.\nI am using Quarkus and just don't know how to pass the document to the API properly.\nI upload the file to my API which passes the file right to the Redmine API.\nBefore the current approach that I post here, I tried tons of different formats. In the beginning I also uploaded the file to my API as InpuStream and passed it, without any changes or parsings to the Redmine API.\nI am going to share my Code and the Redmine API Documentation as well as an example.</p>\n<p><strong>My code:</strong></p>\n<pre class=\"lang-java prettyprint-override\"><code>    @POST\n    @Path(&quot;/uploads&quot;)\n    @Consumes(MediaType.MULTIPART_FORM_DATA)\n    @Produces(MediaType.APPLICATION_JSON)\n    @Operation(summary = &quot;upload a file&quot;)\n    @Blocking\n    public Response uploadFile(\n        @RestPath String mandant,\n        FileForm form\n    ) {\n        return redmineService.uploadFile(form.file.fileName(), form.file);\n    }\n    \n    @Getter\n    @Setter\n    @Builder\n    @ToString\n    @NoArgsConstructor\n    @AllArgsConstructor\n    public static class FileForm {\n        @RestForm String name;\n        @RestForm FileUpload file;\n    }\n\n\n    public Response uploadFile(String fileName, FileUpload file) {\n        getApiCredentials(DEFAULT_MANDANT);\n    \n        try (RestResponse&lt;Upload&gt; response = redmineApi.uploadFile(apiCredentials.getToken(), file.contentType(), fileName, Files.readAllBytes(file.filePath()))) {\n            if (response.getStatus() == 200 &amp;&amp; response.hasEntity()) {\n                return Response.ok(response.getEntity()).build();\n            }\n        \n            return Response.status(response.getStatus()).entity(response.getEntity()).build();\n        } catch (Exception e) {\n            Log.warnv(&quot;Error while uploading file: &quot; + e.getMessage(), e);\n                throw new WebApplicationException(e);\n            }\n        }\n\n\n    @Default\n    @RegisterRestClient(baseUri = &quot;http://redmine.example.com&quot;)\n    @ClientHeaderParam(name = &quot;Content-Type&quot;, value = &quot;application/json&quot;)\n    public interface RedmineApi {\n    \n        @POST\n        @Path(&quot;/uploads.json&quot;)\n        @Consumes(MediaType.APPLICATION_OCTET_STREAM)\n        RestResponse&lt;Upload&gt; uploadFile(\n            @HeaderParam(&quot;X-Redmine-API-Key&quot;) String redmineApiKey,\n            @HeaderParam(&quot;Content-Type&quot;) String contentType,\n            @RestQuery(&quot;filename&quot;) String fileName,\n            byte[] upload\n        );\n    }\n</code></pre>\n<p><strong>Documentation:</strong></p>\n<p><a href=\"https://www.redmine.org/projects/redmine/wiki/Rest_api#Attaching-files\" rel=\"nofollow noreferrer\">https://www.redmine.org/projects/redmine/wiki/Rest_api#Attaching-files</a></p>\n<blockquote>\n<p>POST /uploads.json?filename=image.png\nContent-Type: application/octet-stream\n...\n(request body is the file content)</p>\n<h1>201 response</h1>\n<p>{&quot;upload&quot;:{&quot;token&quot;:&quot;7167.ed1ccdb093229ca1bd0b043618d88743&quot;}}</p>\n</blockquote>\n<p><strong>Examples:</strong></p>\n<p>When calling the Redmine API directly this is fine:</p>\n<pre><code>    ###\n    POST http://redmine.example.com/uploads.json?filename=test.pdf\n    X-Redmine-API-Key: XXXXXX\n    Content-Type: application/octet-stream\n    \n    &lt; .\\test.pdf\n</code></pre>\n<p>But when calling my Quarkus Server API like this:</p>\n<pre><code>    ###\n    POST http://localhost:8086/mandant/redmine/uploads\n    Content-Type: multipart/form-data; boundary=WebAppBoundary\n    \n    --WebAppBoundary\n    Content-Disposition: form-data; name=&quot;file&quot;; filename='test.txt'\n    Content-Type: text/plain\n    \n    &lt; .\\test.txt\n    --WebAppBoundary--\n</code></pre>\n<p>I get the following error in my Redmine Server logs:</p>\n<pre><code>    Started POST &quot;/uploads.json?filename=test.txt&quot; for 192.168.11.207 at 2025-04-14 14:43:04 +0200\n    \n    ActionDispatch::ParamsParser::ParseError (751: unexpected token at 'This is the first line of the test document'):\n      actionpack (4.2.8) lib/action_dispatch/middleware/params_parser.rb:53:in `rescue in parse_formatted_parameters'\n      actionpack (4.2.8) lib/action_dispatch/middleware/params_parser.rb:32:in `parse_formatted_parameters'\n      actionpack (4.2.8) lib/action_dispatch/middleware/params_parser.rb:23:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/flash.rb:260:in `call'\n      rack (1.6.11) lib/rack/session/abstract/id.rb:225:in `context'\n      rack (1.6.11) lib/rack/session/abstract/id.rb:220:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/cookies.rb:560:in `call'\n      activerecord (4.2.8) lib/active_record/query_cache.rb:36:in `call'\n      activerecord (4.2.8) lib/active_record/connection_adapters/abstract/connection_pool.rb:653:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/callbacks.rb:29:in `block in call'\n      activesupport (4.2.8) lib/active_support/callbacks.rb:88:in `__run_callbacks__'\n      activesupport (4.2.8) lib/active_support/callbacks.rb:778:in `_run_call_callbacks'\n      activesupport (4.2.8) lib/active_support/callbacks.rb:81:in `run_callbacks'\n      actionpack (4.2.8) lib/action_dispatch/middleware/callbacks.rb:27:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/remote_ip.rb:78:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/debug_exceptions.rb:17:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/show_exceptions.rb:30:in `call'\n      railties (4.2.8) lib/rails/rack/logger.rb:38:in `call_app'\n      railties (4.2.8) lib/rails/rack/logger.rb:20:in `block in call'\n      activesupport (4.2.8) lib/active_support/tagged_logging.rb:68:in `block in tagged'\n      activesupport (4.2.8) lib/active_support/tagged_logging.rb:26:in `tagged'\n      activesupport (4.2.8) lib/active_support/tagged_logging.rb:68:in `tagged'\n      railties (4.2.8) lib/rails/rack/logger.rb:20:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/request_id.rb:21:in `call'\n      rack (1.6.11) lib/rack/methodoverride.rb:22:in `call'\n      rack (1.6.11) lib/rack/runtime.rb:18:in `call'\n      activesupport (4.2.8) lib/active_support/cache/strategy/local_cache_middleware.rb:28:in `call'\n      actionpack (4.2.8) lib/action_dispatch/middleware/static.rb:120:in `call'\n      rack (1.6.11) lib/rack/content_length.rb:15:in `call'\n      rack (1.6.11) lib/rack/sendfile.rb:113:in `call'\n      railties (4.2.8) lib/rails/engine.rb:518:in `call'\n      railties (4.2.8) lib/rails/application.rb:165:in `call'\n      railties (4.2.8) lib/rails/railtie.rb:194:in `public_send'\n      railties (4.2.8) lib/rails/railtie.rb:194:in `method_missing'\n      passenger (5.1.12) src/ruby_supportlib/phusion_passenger/rack/thread_handler_extension.rb:97:in `process_request'\n      passenger (5.1.12) src/ruby_supportlib/phusion_passenger/request_handler/thread_handler.rb:160:in `accept_and_process_next_request'\n      passenger (5.1.12) src/ruby_supportlib/phusion_passenger/request_handler/thread_handler.rb:113:in `main_loop'\n      passenger (5.1.12) src/ruby_supportlib/phusion_passenger/request_handler.rb:416:in `block (3 levels) in start_threads'\n      passenger (5.1.12) src/ruby_supportlib/phusion_passenger/utils.rb:113:in `block in create_thread_and_abort_on_exception'\n</code></pre>\n",
    "tags" : [ "java", "quarkus", "redmine", "redmine-api" ],
    "owner" : {
      "account_id" : 30726828,
      "reputation" : 33,
      "user_id" : 23561235,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/321f8762baa30c5e05f2044eb25e564b?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Wyatt",
      "link" : "https://stackoverflow.com/users/23561235/wyatt"
    },
    "is_answered" : false,
    "view_count" : 52,
    "answer_count" : 0,
    "score" : 1,
    "last_activity_date" : 1747080487,
    "creation_date" : 1744636519,
    "link" : "https://stackoverflow.com/questions/79573235/upload-file-to-redmine-api-via-quarkus-java",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}