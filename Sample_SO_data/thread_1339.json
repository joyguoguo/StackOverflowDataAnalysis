{
  "question" : {
    "question_id" : 79717194,
    "title" : "How to create an Image component in async block of code?",
    "body" : "<p>Trying to create an Image asynchronously and then update the UI via push, however Image constructor <code>Image(DownloadHandler downloadHandler, String alt)</code> throws exception:</p>\n<pre><code>Exception in thread &quot;&quot; java.lang.NullPointerException: Cannot invoke &quot;com.vaadin.flow.component.UI.getUIId()&quot; because the return value of &quot;com.vaadin.flow.component.UI.getCurrent()&quot; is null\n    at com.vaadin.flow.server.communication.StreamRequestHandler.generateURI(StreamRequestHandler.java:247)\n    at com.vaadin.flow.server.StreamResourceRegistry.getURI(StreamResourceRegistry.java:226)\n    at com.vaadin.flow.server.StreamResourceRegistry.getURI(StreamResourceRegistry.java:209)\n    at com.vaadin.flow.internal.nodefeature.ElementAttributeMap.doSetResource(ElementAttributeMap.java:160)\n    at com.vaadin.flow.internal.nodefeature.ElementAttributeMap.setResource(ElementAttributeMap.java:144)\n    at com.vaadin.flow.dom.impl.BasicElementStateProvider.setAttribute(BasicElementStateProvider.java:332)\n    at com.vaadin.flow.dom.Element.setAttribute(Element.java:346)\n    at com.vaadin.flow.dom.Element.setAttribute(Element.java:380)\n    at com.vaadin.flow.component.html.Image.setSrc(Image.java:168)\n    at com.vaadin.flow.component.html.Image.&lt;init&gt;(Image.java:115)\n</code></pre>\n<p>Code:</p>\n<pre><code>val ui = UI.getCurrent();\nThread.ofVirtual().start(() -&gt; {\n    val img = new Image(DownloadHandler.fromInputStream(downloadEvent -&gt; new DownloadResponse(\n        DriveUtils.getThumbInputStream(fileMetaBO),\n                fileMetaBO.getName(),\n                fileMetaBO.getMimeType(),\n                fileMetaBO.getLength())), &quot;&quot;); // exception in Image constructor\n    ui.access(() -&gt; {\n        ...\n        ui.push();\n    });\n});\n</code></pre>\n<p>Vaadin 24.8</p>\n",
    "tags" : [ "java", "vaadin", "vaadin-flow" ],
    "owner" : {
      "account_id" : 14571259,
      "reputation" : 1186,
      "user_id" : 10524503,
      "user_type" : "registered",
      "profile_image" : "https://lh4.googleusercontent.com/-TTMbFydM2wc/AAAAAAAAAAI/AAAAAAAAIbU/tMY5KezwBbg/s256-rj/photo.jpg",
      "display_name" : "MarekChr",
      "link" : "https://stackoverflow.com/users/10524503/marekchr"
    },
    "is_answered" : true,
    "view_count" : 142,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1753720273,
    "creation_date" : 1753698904,
    "link" : "https://stackoverflow.com/questions/79717194/how-to-create-an-image-component-in-async-block-of-code",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79717635,
    "question_id" : 79717194,
    "body" : "<p>You should move also the <code>Image</code> instantiation in the <code>ui.access(...)</code> block</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 7372513,
      "reputation" : 1006,
      "user_id" : 5612275,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0e96a4fbb6ea05ab0f32beb3bb23099d?s=256&d=identicon&r=PG",
      "display_name" : "Marco C",
      "link" : "https://stackoverflow.com/users/5612275/marco-c"
    },
    "creation_date" : 1753720273,
    "last_activity_date" : 1753720273,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140625080,
    "post_id" : 79717194,
    "body" : "I wonder why you are doing the asynchronouse image initialization in the first place? Although you can fix it like Marco C suggests below, the code somehow looks like it is trying to workaround some other issue.  In general, I&#39;d move that image content creation to a separate class, which would naturally move towards just instantiating and adding it within the UI.access block.   Here is an example. It also uses the simpler lambda expression approach instead of using the weird factory method: <a href=\"https://gist.github.com/mstahv/b399e915b78504d5a28ff60a967976b6\" rel=\"nofollow noreferrer\">gist.github.com/mstahv/b399e915b78504d5a28ff60a967976b6</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 2515523,
      "reputation" : 1964,
      "user_id" : 2187063,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/4d32ebb394b8d37f261da3f1c5009a85?s=256&d=identicon&r=PG",
      "display_name" : "mstahv",
      "link" : "https://stackoverflow.com/users/2187063/mstahv"
    },
    "creation_date" : 1753734064,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79717635" : [ {
      "comment_id" : 140625854,
      "post_id" : 79717635,
      "body" : "@MarekChr Creating the Image component and adding that to your app is very fast, so no need to be scared of that. With the callback based content creation the heavy work related to thumbnail creation happens later in a separate http request by the browser that doesn&#39;t block the UI code. So I&#39;d get rid of that virtual thread &amp; UI.access blocks altogether (please correct me if I&#39;m missing some requirement). The DownloadHandler.fromInputStream method kind of obfuscates the code so I undertand the confusion, I&#39;d thus suggest to use the simpler version I referred in the comment directly to your que",
      "score" : 0,
      "owner" : {
        "account_id" : 2515523,
        "reputation" : 1964,
        "user_id" : 2187063,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/4d32ebb394b8d37f261da3f1c5009a85?s=256&d=identicon&r=PG",
        "display_name" : "mstahv",
        "link" : "https://stackoverflow.com/users/2187063/mstahv"
      },
      "creation_date" : 1753769872,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140625761,
      "post_id" : 79717635,
      "body" : "@mstahv Yes, well, the image is a generated thumbnail from generated document. I wanted this to be done in non-blocking thread. I might move Image instantiation in ui.acess() block and move most of the logic out of it. So, XY problem I guess, however, as you said, it is not how Vaadin components typically behave - instantiation can be done in non-ui thread for all other components.",
      "score" : 0,
      "owner" : {
        "account_id" : 14571259,
        "reputation" : 1186,
        "user_id" : 10524503,
        "user_type" : "registered",
        "profile_image" : "https://lh4.googleusercontent.com/-TTMbFydM2wc/AAAAAAAAAAI/AAAAAAAAIbU/tMY5KezwBbg/s256-rj/photo.jpg",
        "display_name" : "MarekChr",
        "link" : "https://stackoverflow.com/users/10524503/marekchr"
      },
      "creation_date" : 1753766616,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140625056,
      "post_id" : 79717635,
      "body" : "@mstahv Tested and also the older StreamResource API in Vaadin 24.7 and it seems to fail in similar way too, but I&#39;d still claim this is a bug (not how Vaadin components typically behave) \uD83E\uDD13",
      "score" : 0,
      "owner" : {
        "account_id" : 2515523,
        "reputation" : 1964,
        "user_id" : 2187063,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/4d32ebb394b8d37f261da3f1c5009a85?s=256&d=identicon&r=PG",
        "display_name" : "mstahv",
        "link" : "https://stackoverflow.com/users/2187063/mstahv"
      },
      "creation_date" : 1753733675,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140624789,
      "post_id" : 79717635,
      "body" : "I think it is bug in the new Download handler code if one needs to do this. I don&#39;t see any other components require UI to be available on creation. This also makes it impossible to make e.g. Spring create components.",
      "score" : 0,
      "owner" : {
        "account_id" : 2515523,
        "reputation" : 1964,
        "user_id" : 2187063,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/4d32ebb394b8d37f261da3f1c5009a85?s=256&d=identicon&r=PG",
        "display_name" : "mstahv",
        "link" : "https://stackoverflow.com/users/2187063/mstahv"
      },
      "creation_date" : 1753728275,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}