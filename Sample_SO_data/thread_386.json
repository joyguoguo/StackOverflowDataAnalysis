{
  "question" : {
    "question_id" : 79810317,
    "title" : "WildFly 37 – EJB security domain default not applied on 4 out of 5 modules unless @SecurityDomain is explicitly set",
    "body" : "<p>I'm upgrading from Wildfly 27 to Wildfly 37 and I've ran into an interesting issue. I’m deploying an EAR with multiple EJB submodules on WildFly 37.\nIn my ejb3 subsystem I’ve set:</p>\n<pre><code>&lt;default-security-domain value=&quot;mySecurityDomain&quot;/&gt;\n        &lt;application-security-domains&gt;\n            &lt;application-security-domain name=&quot;mySecurityDomain&quot; security-domain=&quot;ApplicationDomain&quot;/&gt;\n        &lt;/application-security-domains&gt;\n</code></pre>\n<p>Authentication works and one module authorizes calls correctly.\nHowever, in four of my five subdeployments, all EJB calls run as anonymous unless I explicitly add</p>\n<pre><code>@SecurityDomain(&quot;mySecurityDomain&quot;)\n</code></pre>\n<p>on the bean</p>\n<p>CLI shows all beans have</p>\n<pre><code>&quot;security-domain&quot; =&gt; &quot;mySecurityDomain&quot;\n</code></pre>\n<p>even if they dont have the annotation and are not working.</p>\n<p>The non-working module has no jboss-ejb3.xml, and all EE APIs are compileOnly.\nStill, the SecurityDomainInterceptor only attaches when the annotation is present.</p>\n<p>Why isn’t the default security domain applied automatically in this subdeployment on WildFly 37, and how can I fix it without adding @SecurityDomain to every bean?</p>\n<p>What I’ve tried:</p>\n<ul>\n<li>Verified no legacy jboss.xml/ejb-jar.xml.</li>\n<li>Confirmed jakarta.jakartaee-api not packaged.</li>\n<li>Same ApplicationDomain works in another subdeployment.</li>\n</ul>\n",
    "tags" : [ "java", "wildfly", "ejb", "elytron" ],
    "owner" : {
      "account_id" : 22029754,
      "reputation" : 53,
      "user_id" : 16297217,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/19aab098a5c33421a2ce2b41d81d6dd7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bence.kovacs",
      "link" : "https://stackoverflow.com/users/16297217/bence-kovacs"
    },
    "is_answered" : true,
    "view_count" : 69,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1762510374,
    "creation_date" : 1762358899,
    "link" : "https://stackoverflow.com/questions/79810317/wildfly-37-ejb-security-domain-default-not-applied-on-4-out-of-5-modules-unles",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79811072,
    "question_id" : 79810317,
    "body" : "<p>In WildFly 27, the <code>&lt;default-security-domain&gt;</code> setting in the ejb3 subsystem was applied globally to all EJB deployments, including every subdeployment of an EAR unless a <code>@SecurityDomain</code> annotation or descriptor explicitly overrode it.</p>\n<p>Starting around WildFly 36 / 37, due to Elytron and EE 10 alignment changes, this behavior was narrowed. The default security domain is only automatically applied if the deployment is recognized as a &quot;legacy&quot; security-domain aware EJB deployment.</p>\n<p>This means that plain Jakarta EE EJB modules without legacy metadata (and compiled only against jakarta.jakartaee-ap) are now treated as Elytron-only deployments, and the default-security-domain does not attach any <code>SecurityDomainInterceptor</code> (unless explicitly annotated).</p>\n<p>So, even though your CLI correctly shows <code>&quot;security-domain&quot; =&gt; &quot;mySecurityDomain&quot;</code>, that value is not being used to attach the interceptor. The default is therefore not applied during component installation (unless legacy metadata or annotation triggers the EJB security chain).</p>\n<p><strong>Why One Module Works and the Others Don’t</strong></p>\n<p>The one module that works probably:</p>\n<ul>\n<li>Has an existing jboss-ejb3.xml, or</li>\n<li>Uses some legacy EJB descriptor (e.g., jboss.xml), or</li>\n<li>Has at least one EJB with a <code>@SecurityDomain</code>, which triggers registration of the interceptor for the deployment.</li>\n</ul>\n<p>That causes WildFly’s <code>EjbSecurityDomainDeploymentProcessor</code> to mark the entire deployment unit as having a security domain.</p>\n<p>Your other subdeployments are pure Jakarta EE, so the processor never attaches.</p>\n<p><strong>Suggested fixes:</strong></p>\n<p><strong>Option 1:</strong> Add a META-INF/jboss-ejb3.xml per subdeployment</p>\n<pre class=\"lang-xml prettyprint-override\"><code>&lt;jboss:ejb-jar xmlns:jboss=&quot;urn:jboss:ejb3:3.2&quot;\n               xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;\n               version=&quot;3.2&quot;&gt;\n    &lt;assembly-descriptor&gt;\n        &lt;security-domain&gt;mySecurityDomain&lt;/security-domain&gt;\n    &lt;/assembly-descriptor&gt;\n&lt;/jboss:ejb-jar&gt;\n</code></pre>\n<p><strong>Option 2:</strong> Apply a global EJB deployment descriptor in the EAR</p>\n<p>Instead of per-module, you can put one META-INF/jboss-ejb3.xml at the EAR root. WildFly merges this into subdeployments (unless overridden).</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 1096470,
      "reputation" : 29414,
      "user_id" : 1089967,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/1f256b904ff621d678598d8fa49f86c5?s=256&d=identicon&r=PG",
      "display_name" : "lance-java",
      "link" : "https://stackoverflow.com/users/1089967/lance-java"
    },
    "creation_date" : 1762421937,
    "last_activity_date" : 1762422486,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79812192,
    "question_id" : 79810317,
    "body" : "<p>Finally managed to make it work. <a href=\"https://stackoverflow.com/questions/79810317/wildfly-37-ejb-security-domain-default-not-applied-on-4-out-of-5-modules-unles/79811072#79811072\">lance-javas answer</a> was mostly correct, my working module was working because i had one bean annotated with @SecurityDomain and it made the whole subdeployment work.</p>\n<p>The valid jboss-ejb3.xml syntax that was working for me (Wildfly 37):</p>\n<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;jboss:ejb-jar xmlns:jboss=&quot;http://www.jboss.com/xml/ns/javaee&quot;\n               xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot; version=&quot;3.2&quot;&gt;\n  &lt;assembly-descriptor&gt;\n    &lt;s:security xmlns:s=&quot;urn:security:1.1&quot;&gt;\n      &lt;ejb-name&gt;*&lt;/ejb-name&gt;\n      &lt;s:security-domain&gt;mySecurityDomain&lt;/s:security-domain&gt;\n    &lt;/s:security&gt;\n  &lt;/assembly-descriptor&gt;\n&lt;/jboss:ejb-jar&gt;\n</code></pre>\n<p>Also, putting the xml in the EARs root wasn't working, WF didn't parse it (didn't throw error on the wrong syntax), and the correct syntax wans't working either. I had to put the xml in every subdeployment.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 22029754,
      "reputation" : 53,
      "user_id" : 16297217,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/19aab098a5c33421a2ce2b41d81d6dd7?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "bence.kovacs",
      "link" : "https://stackoverflow.com/users/16297217/bence-kovacs"
    },
    "creation_date" : 1762510374,
    "last_activity_date" : 1762510374,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}