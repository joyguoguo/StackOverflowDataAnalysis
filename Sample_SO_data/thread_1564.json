{
  "question" : {
    "question_id" : 79695432,
    "title" : "Indexing problem with SOLR after Hybris upgrade (MultiMaxScoreQParserPlugin)",
    "body" : "<p>There was a need to upgrade our Hybris version from 2211.37 to 2211.41. In this new version, it includes Solr 9.8. There were some issues before I managed to run both build and deploy successfully. I was able to access HAC, Backoffice and SmartEdit which wasn't working before I did some fixes. I still can't access Solr as seen below. I'm still using the same link I used before this upgrade. I thought, maybe, I need to index first. I tried that and also got an error.</p>\n<p>I came upon this thread, <a href=\"https://stackoverflow.com/questions/68151903/indexing-problem-with-solr-multimaxscoreqparserplugin\">Indexing problem with SOLR (MultiMaxScoreQParserPlugin)</a>. I saw that MultiMaxScoreQParserPlugin is from <strong>solr-hybris-components-&lt;version_of_solr&gt;.jar</strong>. I checked this directory, <code>/home/username/company/CX-2211/hybris/bin/modules/search-and-navigation/solrserver/resources/solr/9.8/server/modules/hybris/lib</code> and it contains the jar file with version, 9.8.4.</p>\n<p>I also saw this page from SAP, <a href=\"https://help.sap.com/docs/SAP_COMMERCE_CLOUD_PUBLIC_CLOUD/aa417173fe4a4ba5a473c93eb730a417/6847333812f04dafb020841a61ab5ec2.html\" rel=\"nofollow noreferrer\">https://help.sap.com/docs/SAP_COMMERCE_CLOUD_PUBLIC_CLOUD/aa417173fe4a4ba5a473c93eb730a417/6847333812f04dafb020841a61ab5ec2.html</a>. I tried following it based on my understanding of what needs to change. Below, you can see the actions I did.</p>\n<ul>\n<li><p>MOVED analysis-extras AND hybris FROM\n<code>/home/username/company/CX-2211/hybris/bin/modules/search-and-navigation/solrserver/resources/solr/9.8/server/modules</code> TO <code>/home/username/company/commerce/core-customize/_SOLR_/server/solr/modules</code></p>\n</li>\n<li><p>REMOVE BELOW FROM <code>/home/username/company/commerce/core-customize/_SOLR_/server/solr/configsets/default/conf/solrconfig.xml</code></p>\n<p>&lt;lib dir=&quot;${solr.install.dir:../../../..}/analysis-extras/lib&quot; regex=&quot;.*.jar&quot; /&gt;</p>\n<p>&lt;lib dir=&quot;${solr.install.dir:../../../..}/hybris/lib&quot; regex=&quot;.*.jar&quot; /&gt;</p>\n</li>\n<li><p>ADD IN <code>/home/username/company/commerce/core-customize/_SOLR_/server/solr/configsets/default/conf/solr.xml</code></p>\n<p>&lt;str name=&quot;modules&quot;&gt;${solr.modules:analysis-extras,hybris}&lt;/str&gt;</p>\n</li>\n</ul>\n<p>What can I try next?</p>\n<p><a href=\"https://i.sstatic.net/v8fa2RAo.png\" rel=\"nofollow noreferrer\"><img src=\"https://i.sstatic.net/v8fa2RAo.png\" alt=\"Solr admin console not accessible\" /></a></p>\n<p><em><strong>Issue when not following the help page</strong></em></p>\n<pre><code>ERROR [full-dppretailIndex-cronJob::de.hybris.platform.servicelayer.internal.jalo.ServicelayerJob] (full-dppretailIndex-cronJob) [SolrStandaloneSearchProvider] Error from server at https://localhost:8983/solr: Error CREATEing SolrCore 'master_dppretail_Product_flop': Unable to create core [master_dppretail_Product_flop] Caused by: de.hybris.platform.solr.search.MultiMaxScoreQParserPlugin\norg.apache.solr.client.solrj.impl.BaseHttpSolrClient$RemoteSolrException: Error from server at https://localhost:8983/solr: Error CREATEing SolrCore 'master_dppretail_Product_flop': Unable to create core [master_dppretail_Product_flop] Caused by: de.hybris.platform.solr.search.MultiMaxScoreQParserPlugin\n    at org.apache.solr.client.solrj.impl.HttpSolrClient.executeMethod(HttpSolrClient.java:729) ~[solr-solrj-9.8.0.jar:9.8.0 8bf0100e502ade4b8161e4b90f762b117a6ef442 - anshum - 2025-01-13 21:29:10]\n    at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:264) ~[solr-solrj-9.8.0.jar:9.8.0 8bf0100e502ade4b8161e4b90f762b117a6ef442 - anshum - 2025-01-13 21:29:10]\n    at org.apache.solr.client.solrj.impl.HttpSolrClient.request(HttpSolrClient.java:243) ~[solr-solrj-9.8.0.jar:9.8.0 8bf0100e502ade4b8161e4b90f762b117a6ef442 - anshum - 2025-01-13 21:29:10]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider$ClusterSolrClient.request(SolrStandaloneSearchProvider.java:503) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.solr.impl.CachedSolrClient.request(CachedSolrClient.java:64) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider$ClusterSolrClient$ClusterNodeSolrClient.request(SolrStandaloneSearchProvider.java:562) ~[solrfacetsearchserver.jar:?]\n    at org.apache.solr.client.solrj.SolrRequest.process(SolrRequest.java:279) ~[solr-solrj-9.8.0.jar:9.8.0 8bf0100e502ade4b8161e4b90f762b117a6ef442 - anshum - 2025-01-13 21:29:10]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider.clusterRequest(SolrStandaloneSearchProvider.java:341) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider.doCreateIndex(SolrStandaloneSearchProvider.java:303) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider.createIndex(SolrStandaloneSearchProvider.java:155) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.listeners.IndexerOperationListener.afterPrepareContext(IndexerOperationListener.java:79) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerContextFactory.executeAfterPrepareListeners(DefaultIndexerContextFactory.java:161) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerContextFactory.prepareContext(DefaultIndexerContextFactory.java:90) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.strategies.impl.AbstractIndexerStrategy.doExecute(AbstractIndexerStrategy.java:151) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.strategies.impl.AbstractIndexerStrategy.execute(AbstractIndexerStrategy.java:119) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerService.performFullIndex(DefaultIndexerService.java:61) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.SolrIndexerJob.indexItems(SolrIndexerJob.java:71) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.SolrIndexerJob.performIndexingJob(SolrIndexerJob.java:50) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.AbstractIndexerJob.perform(AbstractIndexerJob.java:33) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.servicelayer.internal.jalo.ServicelayerJob.performCronJob(ServicelayerJob.java:31) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.performCronJobWithReadOnlySetting(Job.java:1494) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.execute(Job.java:1429) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.performImpl(Job.java:821) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job$JobRunable.run(Job.java:689) [processingserver.jar:?]\n    at de.hybris.platform.util.threadpool.PoolableThread.internalRun(PoolableThread.java:204) [coreserver.jar:?]\n    at de.hybris.platform.core.threadregistry.RegistrableThread.run(RegistrableThread.java:124) [coreserver.jar:?]\nWARN  [full-dppretailIndex-cronJob::de.hybris.platform.servicelayer.internal.jalo.ServicelayerJob] (full-dppretailIndex-cronJob) [SolrIndexerJob] Error during indexer call: dppretailIndex\nde.hybris.platform.solrfacetsearch.indexer.exceptions.IndexerException: de.hybris.platform.solrfacetsearch.solr.exceptions.SolrServiceException: Could not create index: index=master_dppretail_Product_flop, nodes=[https://localhost:8983/solr]\n    at de.hybris.platform.solrfacetsearch.indexer.listeners.IndexerOperationListener.afterPrepareContext(IndexerOperationListener.java:90) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerContextFactory.executeAfterPrepareListeners(DefaultIndexerContextFactory.java:161) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerContextFactory.prepareContext(DefaultIndexerContextFactory.java:90) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.strategies.impl.AbstractIndexerStrategy.doExecute(AbstractIndexerStrategy.java:151) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.strategies.impl.AbstractIndexerStrategy.execute(AbstractIndexerStrategy.java:119) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.impl.DefaultIndexerService.performFullIndex(DefaultIndexerService.java:61) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.SolrIndexerJob.indexItems(SolrIndexerJob.java:71) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.SolrIndexerJob.performIndexingJob(SolrIndexerJob.java:50) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.cron.AbstractIndexerJob.perform(AbstractIndexerJob.java:33) [solrfacetsearchserver.jar:?]\n    at de.hybris.platform.servicelayer.internal.jalo.ServicelayerJob.performCronJob(ServicelayerJob.java:31) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.performCronJobWithReadOnlySetting(Job.java:1494) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.execute(Job.java:1429) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job.performImpl(Job.java:821) [processingserver.jar:?]\n    at de.hybris.platform.cronjob.jalo.Job$JobRunable.run(Job.java:689) [processingserver.jar:?]\n    at de.hybris.platform.util.threadpool.PoolableThread.internalRun(PoolableThread.java:204) [coreserver.jar:?]\n    at de.hybris.platform.core.threadregistry.RegistrableThread.run(RegistrableThread.java:124) [coreserver.jar:?]\nCaused by: de.hybris.platform.solrfacetsearch.solr.exceptions.SolrServiceException: Could not create index: index=master_dppretail_Product_flop, nodes=[https://localhost:8983/solr]\n    at de.hybris.platform.solrfacetsearch.solr.impl.SolrStandaloneSearchProvider.createIndex(SolrStandaloneSearchProvider.java:162) ~[solrfacetsearchserver.jar:?]\n    at de.hybris.platform.solrfacetsearch.indexer.listeners.IndexerOperationListener.afterPrepareContext(IndexerOperationListener.java:79) ~[solrfacetsearchserver.jar:?]\n    ... 15 more\n</code></pre>\n<p><em><strong>Issue when following the help page (deploy is also aborting automatically)</strong></em></p>\n<pre><code>Error creating Spring application context. Shutting down hybris platform since the system cannot be used without working Spring context...\nshutting down hybris registry..\nInvalid multibyte sequence.\nInvalid multibyte sequence.\nde.hybris.platform.core.UninstantiableCoreApplicationContextException: Error creating Spring application context.\n    at de.hybris.platform.core.AbstractTenant.doStartupSafe(AbstractTenant.java:833)\n    at de.hybris.platform.core.AbstractTenant.doStartUp(AbstractTenant.java:760)\n    at de.hybris.platform.core.Registry.assureTenantStarted(Registry.java:658)\n    at de.hybris.platform.core.Registry.activateTenant(Registry.java:719)\n    at de.hybris.platform.core.Registry.setCurrentTenant(Registry.java:568)\n    at de.hybris.platform.core.Registry.activateMasterTenant(Registry.java:627)\n    at de.hybris.platform.core.Registry.startup(Registry.java:441)\n    at de.hybris.platform.core.ClassLoaderUtils.executeWithWebClassLoaderParentIfNeeded(ClassLoaderUtils.java:35)\n    at de.hybris.platform.spring.HybrisContextLoaderListener.startRegistry(HybrisContextLoaderListener.java:353)\n    at de.hybris.platform.spring.HybrisContextLoaderListener.doInitWebApplicationContext(HybrisContextLoaderListener.java:213)\n    at de.hybris.platform.spring.HybrisContextLoaderListener.initWebApplicationContext(HybrisContextLoaderListener.java:200)\n    at org.springframework.web.context.ContextLoaderListener.contextInitialized(ContextLoaderListener.java:103)\n    at de.hybris.platform.spring.HybrisContextLoaderListener.contextInitializedInternal(HybrisContextLoaderListener.java:97)\n    at de.hybris.platform.spring.HybrisContextLoaderListener.contextInitialized(HybrisContextLoaderListener.java:92)\n    at org.apache.catalina.core.StandardContext.listenerStart(StandardContext.java:4059)\n    at org.apache.catalina.core.StandardContext.startInternal(StandardContext.java:4501)\n    at org.apache.catalina.util.LifecycleBase.start(LifecycleBase.java:164)\n    at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1203)\n    at org.apache.catalina.core.ContainerBase$StartChild.call(ContainerBase.java:1193)\n    at java.base/java.util.concurrent.FutureTask.run(FutureTask.java:264)\n    at java.base/java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:304)\n    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1136)\n    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\n    at org.apache.tomcat.util.threads.TaskThread$WrappingRunnable.run(TaskThread.java:63)\n    at java.base/java.lang.Thread.run(Thread.java:842)\nCaused by: org.springframework.beans.FatalBeanException: Context hybris Global Context Factory  couldn't  be created correctly due to, Error creating bean with name 'defaultSolrServerController' defined in class path resource [global-solrserver-spring.xml]: Invocation of init method failed; nested exception is java.lang.NullPointerException: Cannot read the array length because &quot;libs&quot; is null\n    at de.hybris.platform.core.HybrisContextFactory.build(HybrisContextFactory.java:308)\n    at de.hybris.platform.core.HybrisContextFactory$GlobalContextFactory.buildSelf(HybrisContextFactory.java:179)\n    at de.hybris.platform.core.HybrisContextFactory$GlobalContextFactory.build(HybrisContextFactory.java:165)\n    at de.hybris.platform.core.HybrisContextHolder.getGlobalInstanceCached(HybrisContextHolder.java:122)\n    at de.hybris.platform.core.HybrisContextHolder.getGlobalInstance(HybrisContextHolder.java:101)\n    at de.hybris.platform.core.HybrisContextHolder.getAppCtxFactory(HybrisContextHolder.java:152)\n    at de.hybris.platform.core.HybrisContextHolder.getApplicationInstance(HybrisContextHolder.java:78)\n    at de.hybris.platform.core.AbstractTenant.createCoreApplicationContext(AbstractTenant.java:788)\n    at de.hybris.platform.core.AbstractTenant.doStartupSafe(AbstractTenant.java:829)\n    ... 24 more\n</code></pre>\n",
    "tags" : [ "java", "solr", "sap-commerce-cloud" ],
    "owner" : {
      "account_id" : 11171469,
      "reputation" : 85,
      "user_id" : 8198318,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6193f8702c9a2ca66b40111ae0413e87?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "iamrooovic",
      "link" : "https://stackoverflow.com/users/8198318/iamrooovic"
    },
    "is_answered" : true,
    "view_count" : 534,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1753056679,
    "creation_date" : 1752054842,
    "link" : "https://stackoverflow.com/questions/79695432/indexing-problem-with-solr-after-hybris-upgrade-multimaxscoreqparserplugin",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79700554,
    "question_id" : 79695432,
    "body" : "<p>I contacted an expert from SAP. She was able to help me. I had 2 issues.</p>\n<p>First is the indexing issue. The problem was, I was updating an incorrect solr.xml. I changed <code>/home/username/company/commerce/core-customize/_SOLR_/server/solr/solr.xml</code> instead of <code>/home/username/company/commerce/core-customize/_SOLR_/server/solr/configsets/default/conf/solr.xml</code>.</p>\n<p>The last issue was regarding Solr admin console not accessible even after confirming that Solr is running in local. The expert shared this link, <a href=\"https://community.sap.com/t5/crm-and-cx-q-a/solr-admin-page-connection-refused-after-upgrading-to-9-5-0-and-sap-cx-to/qaq-p/13855922\" rel=\"nofollow noreferrer\">https://community.sap.com/t5/crm-and-cx-q-a/solr-admin-page-connection-refused-after-upgrading-to-9-5-0-and-sap-cx-to/qaq-p/13855922</a>. It turns out that Solr may not be accessible after upgrade in Windows if the server was started in WSL. I haven't tried the solution in the site yet. Since I've already confirmed Solr admin console is now accessible, I will consider this the accepted answer.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 11171469,
      "reputation" : 85,
      "user_id" : 8198318,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/6193f8702c9a2ca66b40111ae0413e87?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "iamrooovic",
      "link" : "https://stackoverflow.com/users/8198318/iamrooovic"
    },
    "creation_date" : 1752478954,
    "last_activity_date" : 1753056679,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140618260,
    "post_id" : 79695432,
    "body" : "In the sap documentation(<a href=\"https://help.sap.com/docs/SAP_COMMERCE_CLOUD_PUBLIC_CLOUD/aa417173fe4a4ba5a473c93eb730a417/6847333812f04dafb020841a61ab5ec2.html?locale=en-US\" rel=\"nofollow noreferrer\">help.sap.com/docs/SAP_COMMERCE_CLOUD_PUBLIC_CL&zwnj;&#8203;OUD/&hellip;</a>)  they mentioned to move only custom modules right?. analysis-extras and hybris are OOB modules, I don&#39;t think they need to be modified.",
    "score" : 0,
    "owner" : {
      "account_id" : 9347215,
      "reputation" : 489,
      "user_id" : 6938132,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/2981d8b03e23cc3cc11f0b759b6aebb5?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "srihitha",
      "link" : "https://stackoverflow.com/users/6938132/srihitha"
    },
    "creation_date" : 1753451846,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79700554" : [ {
      "comment_id" : 140619055,
      "post_id" : 79700554,
      "body" : "I&#39;m getting following issue while upgrading to 2211.41. Full index was sucessful.    Caused by: org.apache.solr.client.solrj.impl.BaseHttpSolrClient$RemoteS&zwnj;&#8203;olrException: Error from server at <a href=\"https://localhost:8983/solr\" rel=\"nofollow noreferrer\">localhost:8983/solr</a>: invalid query parser &#39;multiMaxScore&#39; for query &#39;{!multiMaxScore tie=0.0}((code_partnumber:TEST^70.0) OR (keywords_text_en:TEST^50.0) OR (description_text_en:TEST^25.0) OR (categoryName_text_en_mv:TEST^20.0) OR (name_text_en:TEST^100.0)) OR ((name_text_en:*TEST*)) OR ((ndc_string:&quot;TEST&quot;^160.0))&#39;",
      "score" : 0,
      "owner" : {
        "account_id" : 3890162,
        "reputation" : 3,
        "user_id" : 3220572,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/9c27ade463f5fb1d80925a2d5740c3aa?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Anil M",
        "link" : "https://stackoverflow.com/users/3220572/anil-m"
      },
      "creation_date" : 1753471726,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}