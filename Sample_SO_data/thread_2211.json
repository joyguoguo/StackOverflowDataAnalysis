{
  "question" : {
    "question_id" : 79638622,
    "title" : "Writing large report with a template to byte array using SXSSF",
    "body" : "<p>Currently I have a working excel report writer with the following function using JXLS 2.14.0:</p>\n<pre><code>public byte[] generateReport(String template, Map&lt;String, Object&gt; data) throws Exception {\n  try (InputStream is = new ClassPathResource(template).getInputStream();) {\n    try (ByteArrayOutputStream bos = new ByteArrayOutputStream();) {\n      Context context = new Context(data);\n      JxlsHelper.getInstance().processTemplate(is, bos, context);\n      return bos.toByteArray();\n    }\n  }\n}\n</code></pre>\n<p>So from what I can debug, this works using HSSFWorkbook because the template I'm using is <code>.xls</code></p>\n<p>Currently this function is used to generate report up to 100k rows and triggered using a scheduler, and the memory issue starts to show (normal application only used ~100MB of memory, but spikes up to 2-3GB when the report process is running). I'm trying to optimize this by updating the template to use <code>.xlsx</code> file and using SXSSF, but from what I can gather, you need to have XSSF workbook, and then using <code>PoiTransformer.createSxssfTransformer()</code> to wrap it to SXSSF, but I don't see any way to write it to byte array output stream. This is where I'm at right now :</p>\n<pre><code>public byte[] generateReport(String template, Map&lt;String, Object&gt; data) throws Exception {\n  try (InputStream is = new ClassPathResource(template).getInputStream();\n     ByteArrayOutputStream bos = new ByteArrayOutputStream()) {\n\n    XSSFWorkbook workbook = new XSSFWorkbook(is);\n    PoiTransformer transformer = PoiTransformer.createSxssfTransformer(workbook, 100, true, true);\n    transformer.setOutputStream(bos);\n\n    Context context = new Context(data);\n    JxlsHelper.getInstance()\n          .setUseFastFormulaProcessor(false)\n          .processTemplate(context, transformer);\n\n    transformer.getWorkbook().write(bos);\n    return bos.toByteArray();\n  }\n}\n</code></pre>\n<p>I'm currently testing it with just the following unit test :</p>\n<pre><code>@Test\npublic void generateReportTest() throws Exception {\n  byte[] test = service.generateReport(TEMPLATE_XLSX, data);\n  Assertions.assertNotNull(test);\n}\n</code></pre>\n<p>And this keeps failing with the following exception thrown :</p>\n<pre><code>java.io.FileNotFoundException: D:\\poifiles\\poi-sxssf-sheet-xml10363959800900568820.gz (The system cannot find the file specified)\n</code></pre>\n",
    "tags" : [ "java", "apache-poi", "jxls" ],
    "owner" : {
      "account_id" : 2858236,
      "reputation" : 1347,
      "user_id" : 2453998,
      "user_type" : "registered",
      "accept_rate" : 38,
      "profile_image" : "https://www.gravatar.com/avatar/7643770356f4c4b651561a87d90296f1?s=256&d=identicon&r=PG",
      "display_name" : "Aldibe",
      "link" : "https://stackoverflow.com/users/2453998/aldibe"
    },
    "is_answered" : false,
    "view_count" : 139,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1751539341,
    "creation_date" : 1748250142,
    "link" : "https://stackoverflow.com/questions/79638622/writing-large-report-with-a-template-to-byte-array-using-sxssf",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79688705,
    "question_id" : 79638622,
    "body" : "<p>I guess the line</p>\n<pre><code>transformer.getWorkbook().write(bos);\n</code></pre>\n<p>must not be there because JXLS does it and so it's double. This might be causing the error. (I haven't checked it because I no longer support JXLS &lt;3.)</p>\n<p>If the issue persists, update to JXLS 3.0 and submit a pull request with a test case at <a href=\"https://github.com/jxlsteam/jxls\" rel=\"nofollow noreferrer\">https://github.com/jxlsteam/jxls</a>.</p>\n<p>Until JXLS version 3.0, only POI 5.2.2 can be used! The JXLS project is currently waiting for the next POI release (5.5).</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 4250911,
      "reputation" : 21,
      "user_id" : 3478021,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/b0504914e628e309e6ac8d636ced8597?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "jxls_mw",
      "link" : "https://stackoverflow.com/users/3478021/jxls-mw"
    },
    "creation_date" : 1751539341,
    "last_activity_date" : 1751539341,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140463999,
    "post_id" : 79638622,
    "body" : "I raised <a href=\"https://github.com/jxlsteam/jxls/issues/370\" rel=\"nofollow noreferrer\">github.com/jxlsteam/jxls/issues/370</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 964210,
      "reputation" : 1076,
      "user_id" : 987959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a51610eaffa3f4e8022a07bcd070ab3c?s=256&d=identicon&r=PG",
      "display_name" : "PJ Fanning",
      "link" : "https://stackoverflow.com/users/987959/pj-fanning"
    },
    "creation_date" : 1748379025,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140463983,
    "post_id" : 79638622,
    "body" : "poi-sxssf-sheet-xml10363959800900568820.gz is a temp file created by POI. It is deleted when the SXSSFWorkbook is closed. It is possible that jxls is closing the SXSSFWorkbook too early. Is it possible that you are using a newer version of POI than jxls expects. SXSSFWorkbook close() was changed in POI 5.3.0. Before, you had to make a separate call to dispose() to get rid of the temp files.",
    "score" : 0,
    "owner" : {
      "account_id" : 964210,
      "reputation" : 1076,
      "user_id" : 987959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a51610eaffa3f4e8022a07bcd070ab3c?s=256&d=identicon&r=PG",
      "display_name" : "PJ Fanning",
      "link" : "https://stackoverflow.com/users/987959/pj-fanning"
    },
    "creation_date" : 1748378582,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140463716,
    "post_id" : 79638622,
    "body" : "That sure makes it look like <code>template</code> just doesn&#39;t point to a valid file, so the whole method fails to run.",
    "score" : 0,
    "owner" : {
      "account_id" : 465573,
      "reputation" : 200423,
      "user_id" : 869736,
      "user_type" : "registered",
      "accept_rate" : 82,
      "profile_image" : "https://www.gravatar.com/avatar/ae7bb06b9a23a4dd7eea69e853d47d12?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Louis Wasserman",
      "link" : "https://stackoverflow.com/users/869736/louis-wasserman"
    },
    "creation_date" : 1748372460,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79688705" : [ {
      "comment_id" : 140572857,
      "post_id" : 79688705,
      "body" : "@PJFanning POI issue 66687",
      "score" : 0,
      "owner" : {
        "account_id" : 4250911,
        "reputation" : 21,
        "user_id" : 3478021,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/b0504914e628e309e6ac8d636ced8597?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "jxls_mw",
        "link" : "https://stackoverflow.com/users/3478021/jxls-mw"
      },
      "creation_date" : 1751963127,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140561667,
      "post_id" : 79688705,
      "body" : "what is POI 5.5? there is no POI 5.5 planned (5.4.2 is likely next release) - what change are you waiting for? <a href=\"https://poi.apache.org/changes.html\" rel=\"nofollow noreferrer\">poi.apache.org/changes.html</a>",
      "score" : 1,
      "owner" : {
        "account_id" : 964210,
        "reputation" : 1076,
        "user_id" : 987959,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/a51610eaffa3f4e8022a07bcd070ab3c?s=256&d=identicon&r=PG",
        "display_name" : "PJ Fanning",
        "link" : "https://stackoverflow.com/users/987959/pj-fanning"
      },
      "creation_date" : 1751540515,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}