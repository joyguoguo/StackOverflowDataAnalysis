{
  "question" : {
    "question_id" : 79786700,
    "title" : "Parsing UTF-8 XML using DefaultHandler: when / how does it become UTF-16 in Java?",
    "body" : "<p>I have a Java program that was working perfectly in Corretto 17, but is now having character set encoding issues in Corretto 25.</p>\n<p>I am reading a UTF-8 encoded XML from an <a href=\"https://boardgamegeek.com/xmlapi2/thing?id=164928&amp;type=boardgame,boardgameexpansion&amp;stats=1\" rel=\"nofollow noreferrer\">external API</a>. The code is quite simple: I form an <code>HTTPUrlConnection</code> and I have a class that extends <code>DefaultHandler</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>URI uri = new URI(url);\nURL authenticatedURL = uri.toURL();\nHttpURLConnection connection = (HttpURLConnection) authenticatedURL.openConnection();\nconnection.setRequestMethod(&quot;GET&quot;);\nconnection.setRequestProperty(&quot;Authorization&quot;, &quot;Bearer &quot; + BEARER_TOKEN);\n// connection.setRequestProperty(&quot;Accept-Charset&quot;, &quot;UTF-8&quot;);  // This line of code seems to have no impact.\n[...]\nInputStream connectionInputStream = connection.getInputStream();\nInputSource connectionInputSource = new InputSource(connectionInputStream);\nconnectionInputSource.setEncoding(StandardCharsets.UTF_8.displayName());\nparser.parse(connectionInputSource, dh);\n// parser.parse(connection.getInputStream(), dh);  // This 1 line seems to work the same as the above 4 lines.\n</code></pre>\n<p>My understanding is that Java uses UTF-16 for all <code>String</code>s, but also it assumes some inputs (e.g. XML) will be in UTF-8, for instance the <a href=\"https://docs.oracle.com/javase/8/docs/api/java/util/jar/Attributes.html\" rel=\"nofollow noreferrer\"><code>Attributes</code></a> class used by <code>DefaultHandler</code>. <strong>I'm assuming this UTF-8 assumption is why explicitly setting the charset / encoding in the code above makes no difference. Is this correct?</strong></p>\n<p>The issue I'm having is I don't understand when / how the UTF-8 I read in is converted to UTF-16. For instance, in my extension of <code>DefaultHandler</code>, <code>attributes.getValue()</code> seems to return a UTF-8 encoded <code>String</code>, but <code>Float.parseFloat()</code> works perfectly:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public void startElement(String uri, String localName, String qName, Attributes attributes) {\n  if (&quot;name&quot;.equals(qName)) {\n    if (&quot;primary&quot;.equals(attributes.getValue(&quot;type&quot;))) {\n      if (attributeHasValue(attributes, &quot;value&quot;)) {\n        primaryName = attributes.getValue(&quot;value&quot;);  // Seems to store UTF-8 string.\n      }\n    }\n  } else if (&quot;averageweight&quot;.equals(qName)) {\n    if (attributeHasValue(attributes, &quot;value&quot;)) {\n      averageWeight = Float.parseFloat(attributes.getValue(&quot;value&quot;));\n    }\n  [...]\n</code></pre>\n<p>Outputs (when I print the values to <code>System.out.println</code>):</p>\n<pre class=\"lang-none prettyprint-override\"><code>Primary name = Orl�ans   // NOT GOOD!\nAverage weight = 3.0137  // But Floats and Integers are parsed just fine.\n</code></pre>\n<p>I suppose I have to explicitly convert the value returned by <code>attributes.getValue()</code> from UTF-8 to UTF-16, is that correct?</p>\n<p>But, if so, why are numeric values being parsed correctly?</p>\n<p>And, I currently assume the <code>qName</code> and <code>localName</code> parameters are provided in UTF-16, is that correct?</p>\n<p>I'm just confused in general / don't have the right mental model of what the SAXParser + DefaultHandler are doing encoding-wise, because I don't understand how most of my code is working if the encoding is wrong everywhere.</p>\n",
    "tags" : [ "java", "utf-8", "character-encoding", "utf-16", "saxparser" ],
    "owner" : {
      "account_id" : 12309331,
      "reputation" : 420,
      "user_id" : 8981345,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-AdxH5i2R_Eo/AAAAAAAAAAI/AAAAAAAAAoM/622bLwg0l50/s256-rj/photo.jpg",
      "display_name" : "Philip H",
      "link" : "https://stackoverflow.com/users/8981345/philip-h"
    },
    "is_answered" : true,
    "view_count" : 129,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1760555152,
    "creation_date" : 1760031073,
    "link" : "https://stackoverflow.com/questions/79786700/parsing-utf-8-xml-using-defaulthandler-when-how-does-it-become-utf-16-in-java",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79786898,
    "question_id" : 79786700,
    "body" : "<blockquote>\n<p>My understanding is that Java uses UTF-16 for all Strings</p>\n</blockquote>\n<p><a href=\"https://docs.oracle.com/en/java/javase/25/docs/api/java.base/java/lang/String.html\" rel=\"nofollow noreferrer\">The API docs</a> do say &quot;A String represents a string in the UTF-16 format&quot;. <code>String</code>s are sequences of <code>char</code>s.  <code>char</code>s are 16-bit unsigned integers, and in most contexts they are interpreted as storing UTF-16 code units.  However, it is easy to produce <code>String</code>s that contain invalid UTF-16 code sequences, and such strings are valid as far as Java is concerned.</p>\n<blockquote>\n<p>, but also it assumes some inputs (e.g. XML) will be in UTF-8, for instance the Attributes class used by DefaultHandler</p>\n</blockquote>\n<p>The runtime representation of <code>String</code>s is a characteristic of the Java language (<code>java.lang.String</code> being among the very few classes addressed by the language and VM specs). On the other hand, the behavior and assumptions of <code>org.xml.sax.helpers.DefaultHandler</code> are characteristics specifically of that class, not of &quot;Java&quot;.  Comparing these is a category error.</p>\n<p>Moreover, no, <code>DefaultHandler</code> does not assume any particular implementation of the <code>org.xml.sax.Attributes</code> interface, and it is not sensitive to the implementation details of <code>Attributes</code> objects passed to it (its <code>startElement()</code> method being the only one that receives these).  <code>DefaultHandler</code>'s own methods do nothing with the SAX objects passed to them.</p>\n<p>If you initialize an <code>InputSource</code> with an <code>InputStream</code> (byte stream) instead of with a <code>Reader</code> (character stream) then it is up to the <code>XMLReader</code> you use to parse it to arrange for decoding the bytes to characters.  The API docs don't say how it will do this, but you should expect a quality implementation to</p>\n<ul>\n<li>use the encoding set on the <code>InputSource</code> if there is one, otherwise</li>\n<li>use the encoding specification from the initial <code>&lt;!xml ...&gt;</code> directive of the input if there is one and the reader can successfully read it, otherwise</li>\n<li>use UTF-8, at least if that seems to be working, because that's the default defined by the XML specifications.</li>\n</ul>\n<blockquote>\n<p>I don't understand when / how the UTF-8 I read in is converted to UTF-16.</p>\n</blockquote>\n<p>Most likely, the <code>XMLReader</code> will use the specified or default encoding to construct an <code>InputStreamReader</code> around the <code>InputStream</code>, which it will use to read the data, so that character decoding is performed on the fly as it reads.  You could do much the same yourself to initialize the <code>InputSource</code> with a <code>Reader</code> instead of an <code>InputStream</code>.</p>\n<p>Definitely the decoding will be performed by or on behalf of the <code>XMLReader</code>, before it constructs the various SAX objects that it passes to your handler's callbacks.</p>\n<blockquote>\n<p>For instance, in my extension of DefaultHandler, attributes.getValue seems to return a UTF-8 encoded String, but Float.parseFloat works perfectly</p>\n</blockquote>\n<p>There is no such thing as a UTF-8 encoded <code>java.lang.String</code> object.  The <code>�</code> character you see is the Unicode replacement character (which will have appeared in the String in its UTF-16 form).  Its appearance in this context almost surely corresponds to an invalid code sequence in the input.  It follows that the document in fact is not (wholly) encoded in UTF-8.</p>\n<p>It may be that the document is generally in UTF-8, but this character is encoded erroneously. Or it may be that the document is encoded in some other character set (Windows 1252 or ISO-8859-1 being strong possibilities).  Those alternatives are not necessarily well distinguished, but I would call it an erroneous code sequence if the document specifies or defaults to UTF-8.  I would call it a different encoding only if the document contains an XML declaration specifying an encoding different from UTF-8.</p>\n<blockquote>\n<p>I suppose I have to explicitly convert the value returned by attributes.getValue from UTF-8 to UTF-16. Is that correct?</p>\n</blockquote>\n<p>No, it is not correct.  You already have UTF-16.  And at that point, you no longer have the original bytes so as to reinterpret them.</p>\n<blockquote>\n<p>And I currently assume the qName and localName parameters are provided in UTF-16. Is that correct?</p>\n</blockquote>\n<p>You're dealing with <code>String</code>s.  These are sequences of (16-bit) <code>char</code>, not of bytes.  You have no character decoding to perform on them.</p>\n<blockquote>\n<p>I don't understand how most of my code is working if the encoding is wrong everywhere.</p>\n</blockquote>\n<p>Most likely, the document is (slightly) wrong, not your code.  Character decoding must already have been handled by the time you get strings.  There are numerous character encoding schemes that are congruent with UTF-8 (and US-ASCII) for code points 0 - 127.  I mentioned two of them earlier.  Chances are good that one of these is in use instead of UTF-8, at least for the one bad character you observed.  That mis-encoding could be happening in the web server software, or below it, at the underlying source of the document.</p>\n",
    "score" : 3,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1760049721,
    "last_activity_date" : 1760050029,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79787797,
    "question_id" : 79786700,
    "body" : "<p>Thanks to Slaw for putting me on the right path. It turns out adding <code>-Dstdout.encoding=UTF-8</code> to the Run configuration (VM arguments) in Eclipse fixed the issue.</p>\n<p>When I didn't set that flag, the standard output encoding was Cp1252:</p>\n<pre><code>System.out.println(&quot;Standard Output Encoding: &quot; + System.getProperty(&quot;stdout.encoding&quot;));\n\nOutputs &quot;Standard Output Encoding: Cp1252&quot; before adding &quot;-Dstdout.encoding=UTF-8&quot;\nOutputs &quot;Standard Output Encoding: UTF-8&quot; after adding &quot;-Dstdout.encoding=UTF-8&quot;\n</code></pre>\n<p>Searching further on the internet, I found the following related resources:</p>\n<ol>\n<li><p><a href=\"https://github.com/eclipse-platform/eclipse.platform/issues/530\" rel=\"nofollow noreferrer\">Eclipse bug report #530</a> in 2023.</p>\n</li>\n<li><p>Note that this bug only applies to Java 18+ because of the changes in <a href=\"https://openjdk.org/jeps/400\" rel=\"nofollow noreferrer\">JEP 400</a>. Hence why my Java (Corretto) update from 17 to 25 caused the issue.</p>\n</li>\n</ol>\n<p>So, with the flag, all my code works perfectly fine once more. No issues with the character encodings, logic, output, etc.</p>\n<p>[Side note: The above bug was closed in July 2023, so this only happened because I've been neglecting my Eclipse updates for far longer than I'd thought.]</p>\n",
    "score" : 3,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 12309331,
      "reputation" : 420,
      "user_id" : 8981345,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-AdxH5i2R_Eo/AAAAAAAAAAI/AAAAAAAAAoM/622bLwg0l50/s256-rj/photo.jpg",
      "display_name" : "Philip H",
      "link" : "https://stackoverflow.com/users/8981345/philip-h"
    },
    "creation_date" : 1760155417,
    "last_activity_date" : 1760555152,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140789613,
    "post_id" : 79786700,
    "body" : "@Slaw This was indeed the issue (see my posted answer for more details). Thanks!",
    "score" : 1,
    "owner" : {
      "account_id" : 12309331,
      "reputation" : 420,
      "user_id" : 8981345,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-AdxH5i2R_Eo/AAAAAAAAAAI/AAAAAAAAAoM/622bLwg0l50/s256-rj/photo.jpg",
      "display_name" : "Philip H",
      "link" : "https://stackoverflow.com/users/8981345/philip-h"
    },
    "creation_date" : 1760155573,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140789317,
    "post_id" : 79786700,
    "body" : "“attributes.getValue seems to return a UTF-8 encoded String”–As John said, there is no such thing as a UTF-8 encoded String in Java.  All String objects are UTF-16, all the time, no matter where the character data was read from.",
    "score" : 0,
    "owner" : {
      "account_id" : 2053598,
      "reputation" : 44936,
      "user_id" : 1831987,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/38b1c37530189ec4471a43a618e33f67?s=256&d=identicon&r=PG",
      "display_name" : "VGR",
      "link" : "https://stackoverflow.com/users/1831987/vgr"
    },
    "creation_date" : 1760129069,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140787276,
    "post_id" : 79786700,
    "body" : "@PhilipH Does setting <code>-Dstdout.encoding=UTF-8</code> at launch solve the problem?",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1760046061,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140787230,
    "post_id" : 79786700,
    "body" : "Normally XML parsers rely on the encoding specified at the beginning of the XML data. Does your XML file has such an encoding declaration? Also download the binary data to a file and check if the data is really transmitted with UTF-8 encoding.",
    "score" : 0,
    "owner" : {
      "account_id" : 50585,
      "reputation" : 43459,
      "user_id" : 150978,
      "user_type" : "registered",
      "accept_rate" : 78,
      "profile_image" : "https://www.gravatar.com/avatar/feadc214792e2581c3c750140e3eb2c7?s=256&d=identicon&r=PG",
      "display_name" : "Robert",
      "link" : "https://stackoverflow.com/users/150978/robert"
    },
    "creation_date" : 1760044233,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140786896,
    "post_id" : 79786700,
    "body" : "@JonSkeet Good catch, it did output &quot;Orl�ans&quot;. But now I&#39;m even more confused, because it is the same IDE (Eclipse), code, tests, etc. The only thing I did was upgrade Java (Corretto) version from 17 --&gt; 25. Why would that adversely affect System.out.println when printing \\u00E9 ?? (I guess I need to start a new question...)",
    "score" : 1,
    "owner" : {
      "account_id" : 12309331,
      "reputation" : 420,
      "user_id" : 8981345,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-AdxH5i2R_Eo/AAAAAAAAAAI/AAAAAAAAAoM/622bLwg0l50/s256-rj/photo.jpg",
      "display_name" : "Philip H",
      "link" : "https://stackoverflow.com/users/8981345/philip-h"
    },
    "creation_date" : 1760032492,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140786870,
    "post_id" : 79786700,
    "body" : "Also, check the value of <code>System.getProperty(&quot;file.encoding&quot;)</code> to make sure it&#39;s utf-8 and not something else.",
    "score" : 0,
    "owner" : {
      "account_id" : 3377022,
      "reputation" : 14393,
      "user_id" : 2834978,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/ff9af10001f37bc0de566ca2caf2f558?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "LMC",
      "link" : "https://stackoverflow.com/users/2834978/lmc"
    },
    "creation_date" : 1760031519,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140786865,
    "post_id" : 79786700,
    "body" : "&quot;Outputs (when I print the values to System.out.println)&quot; - are you sure the problem isn&#39;t just that your console doesn&#39;t support the value properly? What happens if you write <code>System.out.println(&quot;Orl\\u00E9ans&quot;);</code>? That&#39;s <i>definitely</i> the right string value... so if that appears the same way in your console, it&#39;s probably nothing to do with the XML side of things...",
    "score" : 5,
    "owner" : {
      "account_id" : 11683,
      "reputation" : 1520862,
      "user_id" : 22656,
      "user_type" : "registered",
      "accept_rate" : 86,
      "profile_image" : "https://www.gravatar.com/avatar/6d8ebb117e8d83d74ea95fbdd0f87e13?s=256&d=identicon&r=PG",
      "display_name" : "Jon Skeet",
      "link" : "https://stackoverflow.com/users/22656/jon-skeet"
    },
    "creation_date" : 1760031222,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79786898" : [ {
      "comment_id" : 140789618,
      "post_id" : 79786898,
      "body" : "Thanks John, the above helped improve my understanding. In the end though, it wasn&#39;t the document (or my code) that was wrong, but rather an Eclipse standard output bug, easily solved by adding the flag &quot;-Dstdout.encoding=UTF-8&quot;.",
      "score" : 1,
      "owner" : {
        "account_id" : 12309331,
        "reputation" : 420,
        "user_id" : 8981345,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/-AdxH5i2R_Eo/AAAAAAAAAAI/AAAAAAAAAoM/622bLwg0l50/s256-rj/photo.jpg",
        "display_name" : "Philip H",
        "link" : "https://stackoverflow.com/users/8981345/philip-h"
      },
      "creation_date" : 1760155928,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140788638,
      "post_id" : 79786898,
      "body" : "Note that you can confirm that the error is in the document, and maybe even figure out what encoding is actually being used, by capturing and examining the raw bytes of the HTTP response body.  You might even find that the web server provides a <code>content-type</code> header that tells you that encoding (or alternatively, one that is incorrect in that respect).  Note well that <code>accept-charset</code> on the request is advisory only, in the sense that it doesn&#39;t guarantee that you will get a response encoded with one of the charsets you designate.  That&#39;s outside your control.",
      "score" : 1,
      "owner" : {
        "account_id" : 2792262,
        "reputation" : 190832,
        "user_id" : 2402272,
        "user_type" : "registered",
        "accept_rate" : 85,
        "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
        "display_name" : "John Bollinger",
        "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
      },
      "creation_date" : 1760105936,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}