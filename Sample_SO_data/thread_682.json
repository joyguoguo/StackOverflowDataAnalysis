{
  "question" : {
    "question_id" : 79782967,
    "title" : "How to deal with Simple Java Mail exception 451-Mails per session limit exceeded",
    "body" : "<p>I get an exception on sending mails using Simple Java Mail:</p>\n<pre class=\"lang-none prettyprint-override\"><code>Caused by: org.eclipse.angus.mail.smtp.SMTPSendFailedException: 451-Requested action aborted\n451-Mails per session limit exceeded.\n451 1M5jA2-1vCMv12nl4-00H7V5\n\n    at org.eclipse.angus.mail.smtp.SMTPTransport.issueSendCommand(SMTPTransport.java:2407)\n    at org.eclipse.angus.mail.smtp.SMTPTransport.mailFrom(SMTPTransport.java:1812)\n    at org.eclipse.angus.mail.smtp.SMTPTransport.sendMessage(SMTPTransport.java:1290)\n    at org.simplejavamail.mailer.internal.util.TransportRunner.lambda$sendMessage$0(TransportRunner.java:61)\n    at org.simplejavamail.mailer.internal.util.TransportRunner.sendUsingConnectionPool(TransportRunner.java:92)\n    at org.simplejavamail.mailer.internal.util.TransportRunner.runOnSessionTransport(TransportRunner.java:77)\n    at org.simplejavamail.mailer.internal.util.TransportRunner.sendMessage(TransportRunner.java:56)\n    at org.simplejavamail.mailer.internal.SendMailClosure.executeClosure(SendMailClosure.java:69)\n</code></pre>\n<p>What is the best strategy to deal with that?</p>\n<p>My current approach is</p>\n<pre class=\"lang-java prettyprint-override\"><code>try {\n    mailer.sendMail(email)\n} catch (e: MailException) {\n    logger.error(&quot;Failed to send mail '${email.subject}' to ${email.recipients}&quot;, e)\n    mailer.shutdownConnectionPool()\n    mailer = createMailer()\n    Thread.sleep(RECONNECTION_DELAY)\n}\n</code></pre>\n<p>I am not sure if that's a good way to do it.</p>\n",
    "tags" : [ "java", "jakarta-mail", "simple-java-mail" ],
    "owner" : {
      "account_id" : 10555285,
      "reputation" : 1269,
      "user_id" : 7776688,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/aQnX0.png?s=256",
      "display_name" : "IEE1394",
      "link" : "https://stackoverflow.com/users/7776688/iee1394"
    },
    "is_answered" : true,
    "view_count" : 70,
    "answer_count" : 1,
    "score" : -1,
    "last_activity_date" : 1761133271,
    "creation_date" : 1759665931,
    "link" : "https://stackoverflow.com/questions/79782967/how-to-deal-with-simple-java-mail-exception-451-mails-per-session-limit-exceeded",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79782994,
    "question_id" : 79782967,
    "body" : "<p>You have a server setting that limits the maximum number of emails that can be set per session. You need to investigate on what this setting is and whether you can increase it. If you can increase that value to a new value which you never reach, then that may be the solution.</p>\n<p>However, if you cannot set it to such a level, then you need to figure out what the exact limit is and have a counter for the session on how many emails were already sent inside the session. If it reaches that level, then destroy the session, create a new one and reset the counter. Then you will not have to rely on exceptions being thrown.</p>\n<p><code>MailException</code> is thrown when an exception occurred during the sending of the email. The exception itself is not necessarily the limitation of the emails to be sent, but it could be some other issue, like the mail was not successfully delivered to the receipient. In such cases it makes little sense to destroy the session and retry. Instead, you should handle separately all distinct causes of mail delivery failure and make sure that all of them are handled via appropriate manner. If the mail has been refused by the receipient, then it could be due to your mail being on a blacklist or something of the like and in such situations, instead of retrying the mail sending, you should log which receipients refused the mail and figure out the solution for each.</p>\n<p>Hence, it is not appropriate to handle all mail exceptions as if they were reaching the limit, because in some cases it's just not the case.</p>\n",
    "score" : 2,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 194308,
      "reputation" : 80465,
      "user_id" : 436560,
      "user_type" : "registered",
      "accept_rate" : 87,
      "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
      "display_name" : "Lajos Arpad",
      "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
    },
    "creation_date" : 1759669917,
    "last_activity_date" : 1759669917,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79782994" : [ {
      "comment_id" : 140781442,
      "post_id" : 79782994,
      "body" : "Since you are using Java and JavaMail, this may be helpful: <a href=\"https://stackoverflow.com/questions/45813483/javamail-how-to-close-connection-after-some-email\" title=\"javamail how to close connection after some email\">stackoverflow.com/questions/45813483/&hellip;</a>",
      "score" : 1,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80465,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1759833481,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140780379,
      "post_id" : 79782994,
      "body" : "i agree with you .. but how to restart the SMTP session with simplejavamail",
      "score" : 0,
      "owner" : {
        "account_id" : 10555285,
        "reputation" : 1269,
        "user_id" : 7776688,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/aQnX0.png?s=256",
        "display_name" : "IEE1394",
        "link" : "https://stackoverflow.com/users/7776688/iee1394"
      },
      "creation_date" : 1759779042,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778999,
      "post_id" : 79782994,
      "body" : "Okay, but the point is that you need to restart the SMTP session if possible.",
      "score" : 0,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80465,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1759737258,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778489,
      "post_id" : 79782994,
      "body" : "nope i am not using spring, i just use plain simplejavamail .. thats all",
      "score" : 1,
      "owner" : {
        "account_id" : 10555285,
        "reputation" : 1269,
        "user_id" : 7776688,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/aQnX0.png?s=256",
        "display_name" : "IEE1394",
        "link" : "https://stackoverflow.com/users/7776688/iee1394"
      },
      "creation_date" : 1759696936,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778199,
      "post_id" : 79782994,
      "body" : "Albeit restarting the SMTP session may not be so simple. I&#39;ve read some sources which say it can&#39;t be triggered (of course, except for restarting the whole thing, which is the nuclear option). You can read more about SMTP sessions here: <a href=\"https://www.atmail.com/blog/smtp-101-manual-smtp-sessions/\" rel=\"nofollow noreferrer\">atmail.com/blog/smtp-101-manual-smtp-sessions</a>",
      "score" : 0,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80465,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1759679707,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778198,
      "post_id" : 79782994,
      "body" : "I think this is an issue happening on a lower-level in your architecture. 451 is an SMTP error and you are using your SMTP via Spring + Simplejavamail under the hood. If you restart your Spring session (which may or may not be the session Simplejavamail is using - is Simplejavamail is using a session at all), but it is, as far as I understand a completely different session from the one your SMTP is using. Nevertheless, using the subclasses of the exception is a good idea you can implement.",
      "score" : 0,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80465,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1759679619,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778192,
      "post_id" : 79782994,
      "body" : "you are talking about the spring framework i am talking about simplejavamail the library .. is that the same? i don&#39;t think so - or am i wrong?",
      "score" : 1,
      "owner" : {
        "account_id" : 10555285,
        "reputation" : 1269,
        "user_id" : 7776688,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/aQnX0.png?s=256",
        "display_name" : "IEE1394",
        "link" : "https://stackoverflow.com/users/7776688/iee1394"
      },
      "creation_date" : 1759679403,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778183,
      "post_id" : 79782994,
      "body" : "@IEE1394 To answer your second question, check the subclasses of the class <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/mail/MailException.html\" rel=\"nofollow noreferrer\">docs.spring.io/spring-framework/docs/current/javadoc-api/org&zwnj;&#8203;/&hellip;</a> . As about the first question . As about your first question, your session, it is a more general problem of SMTP handling. You will need to figure out what SMTP are you using and how to trigger a session restart for that. Sometimes that is not possible, it largely depends on what you are using.",
      "score" : 0,
      "owner" : {
        "account_id" : 194308,
        "reputation" : 80465,
        "user_id" : 436560,
        "user_type" : "registered",
        "accept_rate" : 87,
        "profile_image" : "https://i.sstatic.net/2GESV.jpg?s=256",
        "display_name" : "Lajos Arpad",
        "link" : "https://stackoverflow.com/users/436560/lajos-arpad"
      },
      "creation_date" : 1759679216,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140778173,
      "post_id" : 79782994,
      "body" : "i know the limit is around 40 Mails per Session and i can not change that behavior.   makes sense to me to handle the exceptions separately. But how to destroy the session in simplejavamail? and where to get a list of all possible exceptions?",
      "score" : 0,
      "owner" : {
        "account_id" : 10555285,
        "reputation" : 1269,
        "user_id" : 7776688,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/aQnX0.png?s=256",
        "display_name" : "IEE1394",
        "link" : "https://stackoverflow.com/users/7776688/iee1394"
      },
      "creation_date" : 1759678360,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}