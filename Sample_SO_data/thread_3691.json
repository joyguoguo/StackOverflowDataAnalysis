{
  "question" : {
    "question_id" : 79531180,
    "title" : "@RestClientTest request not being executed/detected",
    "body" : "<p>I have a service that calls a third-party API with RestClient using a default config, when trying to test it using <code>@RestClientTest</code> the mock server does not detect any incoming requests, I am not sure if its because the RestClient is not being injected correctly or because of the Async behaviour.</p>\n<p>How could I test it correctly? Below is the error and the a similar code to what i have</p>\n<pre class=\"lang-bash prettyprint-override\"><code>java.lang.AssertionError: \nNo further requests expected: HTTP GET https://api.foo.com/get-info\n0 request(s) executed\n\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Service\npublic class MyService {\n    private final Logger logger = LoggerFactory.getLogger(this.getClass());\n\n    @Autowired\n    RestClient restClient;\n\n        @Autowired MyRepository\n\n    @Async\n    public CompletableFuture&lt;Void&gt; fetch(Entity e) {\n\n            List&lt;MyDto&gt; info = restClient\n                    .get()\n                    .uri(&quot;/get-info&quot; + e.getId())\n                    .attributes(clientRegistrationId(&quot;oauth2-client&quot;))\n                    .retrieve()\n                    .body(new ParameterizedTypeReference&lt;List&lt;MyDto&gt;&gt;() {});\n\n            repository.saveAll(info);\n\n        return CompletableFuture.completedFuture(null);\n    }\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@RestClientTest({MyService.class})\n@Import({ServiceTest.TestConfig.class})\nclass MyServiceTest {\n\n    @TestConfiguration\n    static class TestConfig {\n\n        @Bean\n        ClientRegistrationRepository clientRegistrationRepository() {\n            return new InMemoryClientRegistrationRepository(ClientRegistration.withRegistrationId(&quot;oauth2-client&quot;)\n                    .authorizationGrantType(AuthorizationGrantType.CLIENT_CREDENTIALS)\n                    .clientId(&quot;test&quot;)\n                    .tokenUri(&quot;test&quot;)\n                    .build());\n        }\n\n        @Bean\n        OAuth2AuthorizedClientService auth2AuthorizedClientService(\n                ClientRegistrationRepository clientRegistrationRepository) {\n            return new InMemoryOAuth2AuthorizedClientService(clientRegistrationRepository);\n        }\n\n        @Bean\n        public Executor asyncTaskExecutor() {\n            return new SyncTaskExecutor();\n        }\n\n                @Bean\n                public RestClient restClient(RestClient.Builder restClientBuilder) {\n                    return restClientBuilder \n                            .baseUrl(&quot;https://api.foo.com&quot;)\n                            .defaultHeader(&quot;X-API-KEY&quot;, &quot;test-api-key&quot;)\n                            .build();\n                }\n    }\n\n    MockRestServiceServer server;\n\n        @MockBean\n        MyRepository myRepository;\n\n    @Autowired\n    private Service service;\n\n        @Autowired\n        RestClient.Builder restClientBuilder;\n\n    @BeforeEach\n    void setUp() {\n        server = MockRestServiceServer.bindTo(restClientBuilder).build();\n    }\n\n    @Test\n    void testFetch() {\n        Entity e = new Entity();\n        Entity.setId(1L);\n\n\n        server.expect(requestTo(&quot;https://api.foo.com/get-info&quot;))\n                .andRespond(\n                        withSuccess().contentType(MediaType.APPLICATION_JSON));\n\n        service.fetchWorkload(e).join();\n\n        server.verify();\n    }\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class RestClientConfig {\n\n    @Value(&quot;api.key&quot;)\n    private String apiKey;\n\n    @Bean\n    public OAuth2AuthorizedClientManager authorizedClientManager(\n            ClientRegistrationRepository clientRegistrationRepository,\n            OAuth2AuthorizedClientService authorizedClientService) {\n\n        AuthorizedClientServiceOAuth2AuthorizedClientManager authorizedClientManager =\n                new AuthorizedClientServiceOAuth2AuthorizedClientManager(\n                        clientRegistrationRepository, authorizedClientService);\n\n        authorizedClientManager.setAuthorizedClientProvider(OAuth2AuthorizedClientProviderBuilder.builder()\n                .authorizationCode()\n                .build());\n\n        return authorizedClientManager;\n    }\n\n    @Bean\n    public RestClient restClient(OAuth2AuthorizedClientManager authorizedClientManager) {\n        return RestClient.builder()\n                .baseUrl(&quot;https://api.foo.com&quot;)\n                .defaultHeader(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE)\n                .defaultHeader(HttpHeaders.ACCEPT, MediaType.APPLICATION_JSON_VALUE)\n                .defaultHeader(&quot;X-API-KEY&quot;, apiKey)\n                .requestInterceptor(new OAuth2ClientHttpRequestInterceptor(authorizedClientManager))\n                .build();\n    }\n}\n\n</code></pre>\n",
    "tags" : [ "java", "spring", "spring-boot", "testing", "rest-client" ],
    "owner" : {
      "account_id" : 18435170,
      "reputation" : 131,
      "user_id" : 13429213,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8150d48ce163b855efee9711d6e4bd82?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "udduu",
      "link" : "https://stackoverflow.com/users/13429213/udduu"
    },
    "is_answered" : false,
    "view_count" : 54,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1742856443,
    "creation_date" : 1742822273,
    "link" : "https://stackoverflow.com/questions/79531180/restclienttest-request-not-being-executed-detected",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}