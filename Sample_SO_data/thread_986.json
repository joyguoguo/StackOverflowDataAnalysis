{
  "question" : {
    "question_id" : 79754729,
    "title" : "Do OkHttpClient instances created with newBuilder() from common client share the same pools?",
    "body" : "<p>According to the docs of <code>OkHttpClient</code>, it is better to use a single shared instance.</p>\n<p>In my case I need a client for HTTP requests and a client for WebSocket connections; both have different configurations.</p>\n<p>So I created this class, which builds a base client and then calls <code>BASE.newBuilder()</code> for both HTTP and WS clients:</p>\n<pre><code>public class OkHttpClients{\n\n    private static final OkHttpClient BASE = new OkHttpClient.Builder().build();\n\n    private static final OkHttpClient HTTP = BASE.newBuilder()\n        .followRedirects(false)\n        .readTimeout(Duration.ofSeconds(5))\n        .retryOnConnectionFailure(true)\n        .build();\n\n    private static final OkHttpClient WS = BASE.newBuilder()\n        .pingInterval(Duration.ofMinutes(1))\n        .readTimeout(Duration.ofMillis(0))\n        .connectTimeout(Duration.ofMillis(0))\n        .build();\n\n    public static OkHttpClient getHttp(){\n        return HTTP;\n    }\n\n    public static OkHttpClient getWS(){\n        return WS;\n    }\n\n}\n</code></pre>\n<p>In my case, are the instances sharing the same inner pools, like <code>OkHttpClient</code> is saying?</p>\n",
    "tags" : [ "java", "okhttp" ],
    "owner" : {
      "account_id" : 11827645,
      "reputation" : 3286,
      "user_id" : 9011164,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://i.sstatic.net/VgSFC.png?s=256",
      "display_name" : "KunLun",
      "link" : "https://stackoverflow.com/users/9011164/kunlun"
    },
    "is_answered" : true,
    "view_count" : 87,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1756942020,
    "creation_date" : 1756909700,
    "link" : "https://stackoverflow.com/questions/79754729/do-okhttpclient-instances-created-with-newbuilder-from-common-client-share-the",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79754873,
    "question_id" : 79754729,
    "body" : "<p>According to the <a href=\"https://github.com/square/okhttp/blob/master/okhttp/src/commonJvmAndroid/kotlin/okhttp3/OkHttpClient.kt#L77\" rel=\"nofollow noreferrer\">docs</a> in the OkHttpClient class, the method <code>newBuilder()</code> allows to build and create a client that shares the same connection pool, thread pools, and configuration of the original one.</p>\n<blockquote>\n<p>Customize Your Client With newBuilder()</p>\n<p>You can customize a shared OkHttpClient instance with [newBuilder]. This builds a client that shares the same connection pool, thread pools, and configuration. Use the builder methods to add configuration to the derived client for a specific purpose.</p>\n</blockquote>\n<p>Regarding your question</p>\n<blockquote>\n<p>In my case the instances are sharing the same inner pools, like OkHttpClient is saying?</p>\n</blockquote>\n<p>Yes, and this can be easily tested by creating two <code>OkHttpClient</code> instances, where the second is created with <code>newBuilder()</code> from the first client, and then checking if both of them share the same instance of <code>ConnectionPool</code>.</p>\n<pre><code>OkHttpClient okHttpClient1 = new OkHttpClient();\nOkHttpClient okHttpClient2 = okHttpClient1.newBuilder().build();\n\n// Prints true\nSystem.out.println(okHttpClient1.connectionPool().equals(okHttpClient2.connectionPool()));\n</code></pre>\n<p>Regarding your last question</p>\n<blockquote>\n<p>Is it good to do this in my case?</p>\n</blockquote>\n<p>Probably not, but I may have misunderstood you case.</p>\n<p>From my understanding, you want to have two separate clients that handle disntinctively HTTP requests and WebSockets requests. The fact that you want them to be two separate instances leads me to think that you do not want them to share any state. So, if you truly want to handle those requests separately, you should create two competely independent instances.</p>\n<pre><code>public class OkHttpClients {\n\n    private static final OkHttpClient HTTP = new OkHttpClient.Builder()\n        .followRedirects(false)\n        .readTimeout(Duration.ofSeconds(5))\n        .retryOnConnectionFailure(true)\n        .build();\n\n    private static final OkHttpClient WS = new OkHttpClient.Builder()\n        .pingInterval(Duration.ofMinutes(1))\n        .readTimeout(Duration.ofMillis(0))\n        .connectTimeout(Duration.ofMillis(0))\n        .build();\n\n    public static OkHttpClient getHttp(){\n        return HTTP;\n    }\n\n    public static OkHttpClient getWS(){\n        return WS;\n    }\n}\n</code></pre>\n<p>Keep in mind that the docs <em>recommend</em> using a single <code>OkHttpClient</code> for an optimal usage; It is not <em>mandatory</em>.</p>\n<p>Instead, if you specifically want the two clients to share their state while having different configurations, you could keep your code as it is.</p>\n",
    "score" : 1,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 5569841,
      "reputation" : 8664,
      "user_id" : 4415625,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/0ea1713807527aa1cf52e40579e35ec4?s=256&d=identicon&r=PG",
      "display_name" : "dani-vta",
      "link" : "https://stackoverflow.com/users/4415625/dani-vta"
    },
    "creation_date" : 1756917566,
    "last_activity_date" : 1756917566,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79754873" : [ {
      "comment_id" : 140712671,
      "post_id" : 79754873,
      "body" : "I want to be different instances/clients for configuration. For example the timeouts.  But I don&#39;t see any reason to not share the inner pools. Unless I will have problems in future.",
      "score" : 0,
      "owner" : {
        "account_id" : 11827645,
        "reputation" : 3286,
        "user_id" : 9011164,
        "user_type" : "registered",
        "accept_rate" : 50,
        "profile_image" : "https://i.sstatic.net/VgSFC.png?s=256",
        "display_name" : "KunLun",
        "link" : "https://stackoverflow.com/users/9011164/kunlun"
      },
      "creation_date" : 1756920896,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}