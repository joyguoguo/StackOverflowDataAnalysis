{
  "question" : {
    "question_id" : 79615354,
    "title" : "Issue in propagation of Trace context among Kafka clients",
    "body" : "<p>I am building Java + Springboot application to consume Kafka messages from a topic and publish it to other topic. The same message is also consumed by another similar application which does the same thing. For simplicity let's consider the following scenario:</p>\n<blockquote>\n<p>Topic 1 --&gt; App A --&gt; Topic 2 --&gt; App B ---&gt; Topic 3</p>\n</blockquote>\n<p>Now, I am enabling zero-code instrumentation using Open-telemetry agent Jar, <code>v2.6.0</code> and additionally using kafka-clients dependency as <code>v2.6.0.-alpha</code>.</p>\n<p>My expectation is that when I provide the Kafka producer and consumer properties for Interceptors as <code>io.instrumentation.kafkaclients.v2_6.TracingProducerInterceptor/TracingConsumerInterceptor</code> respectively. <code>App A</code> should automatically add the tracing context headers and comprehend them in <code>App B</code> once it consumes the same message. I can see the trace parent header is added and received by <code>App B</code> by debugging it, but still its generating a new trace id (expected to use the parent one) rather than using the same one.\nI tried debugging the <code>TracingConsumerInterceptor</code> and found that it calls <code>KafkaTelemetry.buildAndInjectSpan</code> which in turn calls <code>Instrumenter.shouldStart</code> which has a field <code>enabled</code> as <code>false</code>, which is causing the instrumenter to skip the context building (with my broken understanding).</p>\n<p><strong>I would like to know, if I am missing something in Application configurations because of which context is not correctly propagated, if yes, what can be done to fix this.</strong></p>\n<p>My App configuration is:</p>\n<ul>\n<li>Used <code>-javaagent:&lt;path-to-jar&gt;/opentelemetry-javaagent-2.6.0.jar</code> as a VM option</li>\n<li>Added <code>OTEL_SERVICE_NAME</code> as Environment variable.</li>\n<li>Added <code>implementation &quot;io.opentelemetry.instrumentation:opentelemetry-kakfa-clients-2.6:2.6.0.-alpha&quot;</code> in <code>build.gradle</code></li>\n<li>Added <code>interceptor.classes: io.opentelemetry.instrumentation.kafkaclients.v2_6.TracingProducerInterceptor</code> in properties\n<ul>\n<li>Checked in debugger and it is passed to Producer</li>\n</ul>\n</li>\n<li>Similar configuration for consumer is also added.</li>\n<li>I am using Kafka Client's not Springboot's Spring Kafka.</li>\n<li>Same application is also using Rest APIs using Rest template for which context is being propagated without any additional configuration.</li>\n</ul>\n",
    "tags" : [ "java", "spring-boot", "apache-kafka", "open-telemetry", "open-telemetry-java" ],
    "owner" : {
      "account_id" : 14819652,
      "reputation" : 53,
      "user_id" : 10702431,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/2110766185919974/picture?type=large",
      "display_name" : "Arvind Singh Rawat",
      "link" : "https://stackoverflow.com/users/10702431/arvind-singh-rawat"
    },
    "is_answered" : false,
    "view_count" : 166,
    "answer_count" : 0,
    "score" : 2,
    "last_activity_date" : 1748505633,
    "creation_date" : 1746870505,
    "link" : "https://stackoverflow.com/questions/79615354/issue-in-propagation-of-trace-context-among-kafka-clients",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}