{
  "question" : {
    "question_id" : 79684371,
    "title" : "Why read barrier cannot resolve the &quot;Stop The World&quot; in the ZGC garbage collector?",
    "body" : "<p>I've seen some similar posts, but I did not found a exact answer. So please remember that this question is about root marks and read barriers.</p>\n<p>For garbage collectors, such as ZGC, the Mark phase still requires concurrent marking follow-up to prevent issues like missing marking caused by modifications during traversal.</p>\n<p>Since read barriers exist, why not use them directly to capture all modifications? Even if the root is reassigned to another object, and the referenced object is disconnected from references after being copied, leading to the garbage collector failing to update its references during mutation, there's still a consideration. If the object isn't assigned to other objects during the Mark phase, it proves it has no references, so no missing marking occurs. If it is assigned to other objects, the read barrier can still capture the reference change, avoiding missing marking. So why is a &quot;Stop The World&quot; needed?</p>\n<p>Or, if this operation will take much more performance overhead or memory usage than the advantages it has?</p>\n",
    "tags" : [ "java", "garbage-collection", "zgc" ],
    "owner" : {
      "account_id" : 34713064,
      "reputation" : 21,
      "user_id" : 26730952,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/8711e3285436aa673a8da17c6e3b1c36?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Sen Napbad",
      "link" : "https://stackoverflow.com/users/26730952/sen-napbad"
    },
    "is_answered" : true,
    "view_count" : 134,
    "answer_count" : 2,
    "score" : 1,
    "last_activity_date" : 1753807672,
    "creation_date" : 1751268445,
    "link" : "https://stackoverflow.com/questions/79684371/why-read-barrier-cannot-resolve-the-stop-the-world-in-the-zgc-garbage-collecto",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79717109,
    "question_id" : 79684371,
    "body" : "<p>Per @Holger's comment ...</p>\n<p>If you are going to use read (or write) barriers to completely eliminate &quot;stop the world&quot; behavior in a hypothetical garbage collector, then they must be applied to all reads (or writes).  That includes reads (or writes) of local variables.  A read (or write) barrier on every (reference typed) local variables would result in a significant performance hit.</p>\n<p>Per @Pebal's answer ...</p>\n<p>It is also necessary to STW so that the GC can scan the (hardware) registers.  I cannot think of anyway to avoid this.  (Read or write barriers on registers would be impractical.)  However the time needed to scan registers would be too small to be a concern ... unless you were running a JVM on a platform with a huge number of cores or hyperthreads.</p>\n<blockquote>\n<p>Or, if this operation will take much more performance overhead or memory usage than the advantages it has?</p>\n</blockquote>\n<p>That's what is going on here.  There is a trade-off between maximizing Java speed / performance and minimizing GC pauses.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1753694545,
    "last_activity_date" : 1753807672,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79717317,
    "question_id" : 79684371,
    "body" : "<p>It's not possible to scan CPU registers without stopping the thread, which requires an STW phase.<br />\nSome GCs (e.g. SGCL for C++) avoid scanning registers entirely, but doing so requires stronger guarantees when sharing data between mutator threads — such as using atomic types or other synchronization mechanisms. Java does not enforce such guarantees by default, so scanning registers (and thus a brief STW) remains necessary.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 27261245,
      "reputation" : 86,
      "user_id" : 20784044,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6EUAE8fUmWvBNq0YeoEYO_wYM7zDAOQlzsVQIi-A=k-s256",
      "display_name" : "Pebal",
      "link" : "https://stackoverflow.com/users/20784044/pebal"
    },
    "creation_date" : 1753705481,
    "last_activity_date" : 1753705481,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140552680,
    "post_id" : 79684371,
    "body" : "Local variables are garbage collection roots. To my knowledge, there are no barriers for local variables and you don’t want them, as that would impact performance significantly.",
    "score" : 3,
    "owner" : {
      "account_id" : 3211603,
      "reputation" : 300981,
      "user_id" : 2711488,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/t2hoD.jpg?s=256",
      "display_name" : "Holger",
      "link" : "https://stackoverflow.com/users/2711488/holger"
    },
    "creation_date" : 1751276552,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140552589,
    "post_id" : 79684371,
    "body" : "The answer (technically) depends on which GC you are talking about.",
    "score" : 0,
    "owner" : {
      "account_id" : 47283,
      "reputation" : 723428,
      "user_id" : 139985,
      "user_type" : "registered",
      "accept_rate" : 69,
      "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
      "display_name" : "Stephen C",
      "link" : "https://stackoverflow.com/users/139985/stephen-c"
    },
    "creation_date" : 1751274303,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140552588,
    "post_id" : 79684371,
    "body" : "Please provide enough code so others can better understand or reproduce the problem.",
    "score" : 0,
    "owner" : {
      "account_id" : -1,
      "reputation" : 1,
      "user_id" : -1,
      "user_type" : "moderator",
      "profile_image" : "https://www.gravatar.com/avatar/a007be5a61f6aa8f3e85ae2fc18dd66e?s=256&d=identicon&r=PG",
      "display_name" : "Community",
      "link" : "https://stackoverflow.com/users/-1/community"
    },
    "creation_date" : 1751274270,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79717317" : [ {
      "comment_id" : 140627705,
      "post_id" : 79717317,
      "body" : "@StephenC Got it — thanks for clarifying! I agree, the pause to scan registers is indeed minimal. My point was just that the safepoint mechanism still forces all threads to wait, even for something as quick as register scanning, which can stretch the pause when one thread lags.",
      "score" : 0,
      "owner" : {
        "account_id" : 27261245,
        "reputation" : 86,
        "user_id" : 20784044,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6EUAE8fUmWvBNq0YeoEYO_wYM7zDAOQlzsVQIi-A=k-s256",
        "display_name" : "Pebal",
        "link" : "https://stackoverflow.com/users/20784044/pebal"
      },
      "creation_date" : 1753811270,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140627515,
      "post_id" : 79717317,
      "body" : "Yes.  I&#39;m aware of that.  My comment was <i>only</i> referring to your statement about the need to STW to scan registers.",
      "score" : 0,
      "owner" : {
        "account_id" : 47283,
        "reputation" : 723428,
        "user_id" : 139985,
        "user_type" : "registered",
        "accept_rate" : 69,
        "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
        "display_name" : "Stephen C",
        "link" : "https://stackoverflow.com/users/139985/stephen-c"
      },
      "creation_date" : 1753807114,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140626550,
      "post_id" : 79717317,
      "body" : "@StephenC ZGC also scans the stacks during a pause. It also enforces stopping all threads simultaneously, which means that a thread that has already reached a safepoint must wait until all other threads have also reached a safepoint and stopped.",
      "score" : 1,
      "owner" : {
        "account_id" : 27261245,
        "reputation" : 86,
        "user_id" : 20784044,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/AEdFTp6EUAE8fUmWvBNq0YeoEYO_wYM7zDAOQlzsVQIi-A=k-s256",
        "display_name" : "Pebal",
        "link" : "https://stackoverflow.com/users/20784044/pebal"
      },
      "creation_date" : 1753788515,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140626049,
      "post_id" : 79717317,
      "body" : "Well ... yes ... but the &quot;world stop&quot; to scan registers is almost too small to be perceptible.  For any realistic use of Java that world stop would be irrelevant.  (And that includes zero-garbage use-cases too.  Google for &quot;coralblocks&quot;.)",
      "score" : 0,
      "owner" : {
        "account_id" : 47283,
        "reputation" : 723428,
        "user_id" : 139985,
        "user_type" : "registered",
        "accept_rate" : 69,
        "profile_image" : "https://www.gravatar.com/avatar/147c5a9cc1feec049c50da791ac7d144?s=256&d=identicon&r=PG",
        "display_name" : "Stephen C",
        "link" : "https://stackoverflow.com/users/139985/stephen-c"
      },
      "creation_date" : 1753775490,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}