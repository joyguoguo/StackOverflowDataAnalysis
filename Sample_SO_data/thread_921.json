{
  "question" : {
    "question_id" : 79754963,
    "title" : "Trying to set up a websocket servlet in an OSGi environment with Jetty 12. Can&#39;t figure out this error",
    "body" : "<p>I'm working on an OSGi project with Jetty 12, trying to use the HTTP Whiteboard service to register a websocket servlet.  Everything worked just fine when I was testing with an HttpServlet, but when I modified it to a JettyWebSocketServlet and ran I get the following error on the OSGi console:</p>\n<pre class=\"lang-none prettyprint-override\"><code>!MESSAGE Cannot invoke &quot;org.eclipse.jetty.websocket.core.server.WebSocketMappings.clear()&quot; because &quot;this.mappings&quot; is null\n!STACK 0\njava.lang.NullPointerException: Cannot invoke &quot;org.eclipse.jetty.websocket.core.server.WebSocketMappings.clear()&quot; because &quot;this.mappings&quot; is null\n    at org.eclipse.jetty.ee8.websocket.server.JettyWebSocketServlet.destroy(JettyWebSocketServlet.java:172)\n    at org.eclipse.equinox.http.servlet.internal.registration.EndpointRegistration.destroy(EndpointRegistration.java:67)\n    at org.eclipse.equinox.http.servlet.internal.context.ContextController.doAddServletRegistration(ContextController.java:453)\n    at org.eclipse.equinox.http.servlet.internal.context.ContextController.addServletRegistration(ContextController.java:404)\n    at org.eclipse.equinox.http.servlet.internal.customizer.ContextServletTrackerCustomizer.addingService(ContextServletTrackerCustomizer.java:82)\n    at org.eclipse.equinox.http.servlet.internal.customizer.ContextServletTrackerCustomizer.addingService(ContextServletTrackerCustomizer.java:1)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:947)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:1)\n    at org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:257)\n    at org.osgi.util.tracker.AbstractTracked.trackInitial(AbstractTracked.java:184)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:324)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:267)\n    at org.eclipse.equinox.http.servlet.internal.context.ContextController.&lt;init&gt;(ContextController.java:85)\n    at org.eclipse.equinox.http.servlet.internal.HttpServiceRuntimeImpl.addingService(HttpServiceRuntimeImpl.java:135)\n    at org.eclipse.equinox.http.servlet.internal.HttpServiceRuntimeImpl.addingService(HttpServiceRuntimeImpl.java:1)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:947)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:1)\n    at org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:257)\n    at org.osgi.util.tracker.AbstractTracked.trackInitial(AbstractTracked.java:184)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:324)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:267)\n    at org.eclipse.equinox.http.servlet.internal.HttpServiceRuntimeImpl.open(HttpServiceRuntimeImpl.java:121)\n    at org.eclipse.equinox.http.servlet.internal.Activator.addingService(Activator.java:164)\n    at org.eclipse.equinox.http.servlet.internal.Activator.addingService(Activator.java:1)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:947)\n    at org.osgi.util.tracker.ServiceTracker$Tracked.customizerAdding(ServiceTracker.java:1)\n    at org.osgi.util.tracker.AbstractTracked.trackAdding(AbstractTracked.java:257)\n    at org.osgi.util.tracker.AbstractTracked.trackInitial(AbstractTracked.java:184)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:324)\n    at org.osgi.util.tracker.ServiceTracker.open(ServiceTracker.java:267)\n    at org.eclipse.equinox.http.servlet.internal.Activator.start(Activator.java:84)\n    at org.eclipse.osgi.internal.framework.BundleContextImpl$2.run(BundleContextImpl.java:826)\n    at org.eclipse.osgi.internal.framework.BundleContextImpl$2.run(BundleContextImpl.java:1)\n    at java.base/java.security.AccessController.doPrivileged(AccessController.java:569)\n    at org.eclipse.osgi.internal.framework.BundleContextImpl.startActivator(BundleContextImpl.java:818)\n    at org.eclipse.osgi.internal.framework.BundleContextImpl.start(BundleContextImpl.java:768)\n    at org.eclipse.osgi.internal.framework.EquinoxBundle.startWorker0(EquinoxBundle.java:1066)\n    at org.eclipse.osgi.internal.framework.EquinoxBundle$EquinoxModule.startWorker(EquinoxBundle.java:394)\n    at org.eclipse.osgi.container.Module.doStart(Module.java:643)\n    at org.eclipse.osgi.container.Module.start(Module.java:500)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel$2.run(ModuleContainer.java:2110)\n    at org.eclipse.osgi.internal.framework.EquinoxContainerAdaptor$1$1.execute(EquinoxContainerAdaptor.java:146)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel.incStartLevel(ModuleContainer.java:2101)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel.incStartLevel(ModuleContainer.java:2043)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel.doContainerStartLevel(ModuleContainer.java:2003)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel.dispatchEvent(ModuleContainer.java:1915)\n    at org.eclipse.osgi.container.ModuleContainer$ContainerStartLevel.dispatchEvent(ModuleContainer.java:1)\n    at org.eclipse.osgi.framework.eventmgr.EventManager.dispatchEvent(EventManager.java:230)\n    at org.eclipse.osgi.framework.eventmgr.EventManager$EventThread.run(EventManager.java:341)\n</code></pre>\n<p>I have no idea why the mappings object is null.  My guess is that something is not being initialized properly, but I don't know what that would be.</p>\n<p>Here's my code.  Again, this is running in an OSGi environment with Jetty 12.</p>\n<p>Plugin Class:</p>\n<pre><code>package com.example.core.websocket;\n\nimport java.util.Dictionary;\nimport java.util.Hashtable;\n\nimport javax.servlet.Servlet;\n\nimport org.osgi.framework.BundleActivator;\nimport org.osgi.framework.BundleContext;\nimport org.osgi.service.http.whiteboard.HttpWhiteboardConstants;\n\npublic class WebSocketPlugin implements BundleActivator {\n\n    @Override\n    public void start(BundleContext context) throws Exception {\n        System.out.println(&quot;Starting WebSocketPlugin bundle.&quot;);\n        Servlet servlet = new WebSocketServlet();\n        \n        Dictionary&lt;String, Object&gt; servletProps = new Hashtable&lt;String, Object&gt;();\n        servletProps.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_SERVLET_PATTERN, &quot;/ws/*&quot;);\n        \n        context.registerService(Servlet.class, servlet, servletProps);\n        \n        System.out.println(&quot;Registered WebSocket servlet at /ws/*&quot;);\n    }\n\n    @Override\n    public void stop(BundleContext context) throws Exception {\n        System.out.println(&quot;WebSocketPlugin bundle stopped&quot;);\n    }\n\n}\n</code></pre>\n<p>Servlet Class:</p>\n<pre><code>package com.example.core.websocket;\n\nimport java.io.IOException;\n\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\n\nimport org.eclipse.jetty.ee8.websocket.api.Session;\nimport org.eclipse.jetty.ee8.websocket.api.WebSocketAdapter;\nimport org.eclipse.jetty.ee8.websocket.server.JettyWebSocketServlet;\nimport org.eclipse.jetty.ee8.websocket.server.JettyWebSocketServletFactory;\n\npublic class WebSocketServlet extends JettyWebSocketServlet {\n    private static final long serialVersionUID = 5254365488025393690L;\n\n    @Override\n    protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws IOException {\n        resp.getWriter().println(&quot;Hello from WebSocket servlet (EE8)&quot;);\n    }\n    \n    @Override\n    protected void configure(JettyWebSocketServletFactory factory) {\n        factory.setCreator((req, resp) -&gt; new EchoWebSocketListener());\n    }\n    \n    public class EchoWebSocketListener extends WebSocketAdapter {\n        \n        @Override\n        public void onWebSocketConnect(Session s) {\n            System.out.println(&quot;EchoWebSocketListener connected.&quot;);\n        }\n        \n        @Override\n        public void onWebSocketText(String message) {\n            System.out.println(&quot;Received message: &quot; + message);\n            try {\n                if(isConnected()) {\n                    getRemote().sendString(&quot;Echo: &quot; + message);\n                }\n            } catch (IOException ex) {\n                System.out.println(&quot;Error sending message: &quot; + ex.getMessage());\n            }\n        }\n    }\n}\n</code></pre>\n<p>I've tried loading the Jetty and OSGi bundles in different orders, and tried finding different versions of them, but really I'm just stumped.</p>\n<p>Thanks!</p>\n",
    "tags" : [ "java", "websocket", "jetty", "osgi" ],
    "owner" : {
      "account_id" : 40081422,
      "reputation" : 11,
      "user_id" : 29599959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/11b8c6a037dad5512e2a06ce193c8f01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "langri",
      "link" : "https://stackoverflow.com/users/29599959/langri"
    },
    "is_answered" : false,
    "view_count" : 77,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1756923340,
    "creation_date" : 1756923340,
    "link" : "https://stackoverflow.com/questions/79754963/trying-to-set-up-a-websocket-servlet-in-an-osgi-environment-with-jetty-12-cant",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140722550,
    "post_id" : 79754963,
    "body" : "I&#39;m afraid there&#39;s not much I can help with. You could stay with Equinox (that&#39;s OSGi Core implementation), but take the web parts (and websockets out-of-specification stuff) from Pax Web - there are many examples and integration tests. Also Karaf uses Pax Web as it&#39;s implementation of web-related specifications of OSGi CMPN.",
    "score" : 0,
    "owner" : {
      "account_id" : 91170,
      "reputation" : 6257,
      "user_id" : 250517,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/8cbf720ac433d1c71599fd7bcce1bdd5?s=256&d=identicon&r=PG",
      "display_name" : "Grzegorz Grzybek",
      "link" : "https://stackoverflow.com/users/250517/grzegorz-grzybek"
    },
    "creation_date" : 1757350573,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140721805,
    "post_id" : 79754963,
    "body" : "@GrzegorzGrzybek I had wanted to go the whiteboard direction because the current way our software is set up has a whole lot of tight coupling between the http service class and the servlets.  I&#39;m beginning to understand that&#39;s unavoidable.  AI isn&#39;t the only useless thing, as everything I&#39;m finding on the web is ten years old or more.  The little that I&#39;ve found specifically about Jetty 12 in an Equinox environment has only made me more frustrated.",
    "score" : 0,
    "owner" : {
      "account_id" : 40081422,
      "reputation" : 11,
      "user_id" : 29599959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/11b8c6a037dad5512e2a06ce193c8f01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "langri",
      "link" : "https://stackoverflow.com/users/29599959/langri"
    },
    "creation_date" : 1757333267,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140721137,
    "post_id" : 79754963,
    "body" : "AI can&#39;t help you here ;) Jetty 12 is a complete rewrite of Jetty architecture, so there&#39;s a painful road ahead of you. I went this way by upgrading Pax Web from Jetty 9 to Jetty 12... What are the sites telling you that Whiteboard is a better way? Mind that OSGi CMPN Whiteboard specification says nothing about Websockets...",
    "score" : 0,
    "owner" : {
      "account_id" : 91170,
      "reputation" : 6257,
      "user_id" : 250517,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/8cbf720ac433d1c71599fd7bcce1bdd5?s=256&d=identicon&r=PG",
      "display_name" : "Grzegorz Grzybek",
      "link" : "https://stackoverflow.com/users/250517/grzegorz-grzybek"
    },
    "creation_date" : 1757311164,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140720510,
    "post_id" : 79754963,
    "body" : "@GrzegorzGrzybek Yes, I&#39;m stuck with using Equinox.  We&#39;re trying to upgrade our software from Jetty 10 to 12 and it&#39;s not going well.  I&#39;ve been going nuts trying to figure this out.  In our previous version we extended JettyWebSocketServlet and overrode init() to call some setup method including ensureMapping(), but that appears not to work in Jetty 12 because we can&#39;t get a reference to the Server anymore.  Some sites I read indicated that the http whiteboard was a better way to do this, but now that doesn&#39;t seem to work either.  I&#39;m really stumped, and could use some help.",
    "score" : 0,
    "owner" : {
      "account_id" : 40081422,
      "reputation" : 11,
      "user_id" : 29599959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/11b8c6a037dad5512e2a06ce193c8f01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "langri",
      "link" : "https://stackoverflow.com/users/29599959/langri"
    },
    "creation_date" : 1757269616,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140719773,
    "post_id" : 79754963,
    "body" : "<a href=\"https://github.com/ops4j/org.ops4j.pax.web\" rel=\"nofollow noreferrer\">github.com/ops4j/org.ops4j.pax.web</a> is an implementation of web specifications from OSGi CMPN and it supports websockets... But because you already tried websockets and Equinox it means you had such requirements...",
    "score" : 0,
    "owner" : {
      "account_id" : 91170,
      "reputation" : 6257,
      "user_id" : 250517,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/8cbf720ac433d1c71599fd7bcce1bdd5?s=256&d=identicon&r=PG",
      "display_name" : "Grzegorz Grzybek",
      "link" : "https://stackoverflow.com/users/250517/grzegorz-grzybek"
    },
    "creation_date" : 1757225365,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140719772,
    "post_id" : 79754963,
    "body" : "It depends on your requirements, the project you have, other libraries you use and deployment platform...",
    "score" : 0,
    "owner" : {
      "account_id" : 91170,
      "reputation" : 6257,
      "user_id" : 250517,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/8cbf720ac433d1c71599fd7bcce1bdd5?s=256&d=identicon&r=PG",
      "display_name" : "Grzegorz Grzybek",
      "link" : "https://stackoverflow.com/users/250517/grzegorz-grzybek"
    },
    "creation_date" : 1757225307,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140719641,
    "post_id" : 79754963,
    "body" : "@GrzegorzGrzybek:  What should I use instead of org.eclipse.equinox.http.servlet?",
    "score" : 0,
    "owner" : {
      "account_id" : 40081422,
      "reputation" : 11,
      "user_id" : 29599959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/11b8c6a037dad5512e2a06ce193c8f01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "langri",
      "link" : "https://stackoverflow.com/users/29599959/langri"
    },
    "creation_date" : 1757211504,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140715000,
    "post_id" : 79754963,
    "body" : "It&#39;s an eclipse equinox environment. I&#39;m not sure what the exact version is.  The eclipse installation details show a bunch equinox plugins with different versions.",
    "score" : 0,
    "owner" : {
      "account_id" : 40081422,
      "reputation" : 11,
      "user_id" : 29599959,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/11b8c6a037dad5512e2a06ce193c8f01?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "langri",
      "link" : "https://stackoverflow.com/users/29599959/langri"
    },
    "creation_date" : 1757000063,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140713553,
    "post_id" : 79754963,
    "body" : "I see only that you&#39;re using Equinox and <code>org.eclipse.equinox.http.servlet</code> which AFAIK is an implementation of OSGi CMPN HttpService. This specification (and thus - implementation) is not aware of WebSockets and probably doesn&#39;t provide required context attributes (like ServerContainer) for your servlet to initialize.",
    "score" : 0,
    "owner" : {
      "account_id" : 91170,
      "reputation" : 6257,
      "user_id" : 250517,
      "user_type" : "registered",
      "accept_rate" : 75,
      "profile_image" : "https://www.gravatar.com/avatar/8cbf720ac433d1c71599fd7bcce1bdd5?s=256&d=identicon&r=PG",
      "display_name" : "Grzegorz Grzybek",
      "link" : "https://stackoverflow.com/users/250517/grzegorz-grzybek"
    },
    "creation_date" : 1756962191,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140713534,
    "post_id" : 79754963,
    "body" : "what is your OSGi environment ?",
    "score" : 0,
    "owner" : {
      "account_id" : 26698569,
      "reputation" : 4074,
      "user_id" : 20306007,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/98bbc403493aee3681b71dae7abef66e?s=256&d=identicon&r=PG",
      "display_name" : "life888888",
      "link" : "https://stackoverflow.com/users/20306007/life888888"
    },
    "creation_date" : 1756960740,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}