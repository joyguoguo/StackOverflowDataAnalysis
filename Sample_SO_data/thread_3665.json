{
  "question" : {
    "question_id" : 79533122,
    "title" : "Filter executing twice",
    "body" : "<p>here is the filter class. Using <code>@Component</code> annotation because I want to read the value <code>auth.key</code> from <code>application.yml</code> file.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class StaticKeyAuthFilter implements Filter {\n\n    @Value(&quot;${auth.key}&quot;)\n    private String authKey;\n\n    @Override\n    public void doFilter(ServletRequest servletRequest,\n                         ServletResponse servletResponse,\n                         FilterChain filterChain) throws IOException, ServletException {\n        HttpServletRequest request = (HttpServletRequest) servletRequest;\n        HttpServletResponse response = (HttpServletResponse) servletResponse;\n\n        String authorization = request.getHeader(&quot;Authorization&quot;);\n        System.out.println(&quot;StaticKeyAuthFilter:&quot; + request.getRequestURI() );\n\n        if (authorization == null || !authorization.equals(authKey)) {\n            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n            return;\n        }\n\n        filterChain.doFilter(request, response);\n\n    }\n}\n</code></pre>\n<p>Next, I am registering it in the config class.</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Configuration\npublic class ProjectConfig {\n    @Autowired\n    private StaticKeyAuthFilter staticKeyAuthFilter;\n    \n    @Bean\n    SecurityFilterChain configure(HttpSecurity httpSecurity) throws Exception {\n\n        httpSecurity.authorizeHttpRequests(c -&gt; {\n            c.anyRequest().permitAll();\n        });\n\n\n        httpSecurity.addFilterAt(staticKeyAuthFilter, BasicAuthenticationFilter.class);\n        return httpSecurity.build();\n    }\n}\n</code></pre>\n<p>Now, when I visit any controller I get the following output:</p>\n<pre class=\"lang-bash prettyprint-override\"><code>StaticKeyAuthFilter:/category/bb\nStaticKeyAuthFilter:/category/bb\n</code></pre>\n<p>As you can see, it is executing twice. what am I doing wrong?</p>\n",
    "tags" : [ "java", "spring-boot", "spring-security" ],
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "is_answered" : true,
    "view_count" : 93,
    "closed_date" : 1746115960,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1742910511,
    "creation_date" : 1742892772,
    "link" : "https://stackoverflow.com/questions/79533122/filter-executing-twice",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79533192,
    "question_id" : 79533122,
    "body" : "<p>As soon as you register a <code>Filter</code> bean as a component, it's already added to the regular filter chain. In addition, you manually added it to the <code>SecurityFilterChain</code>  as well, which causes it to be registered and called twice.</p>\n<p>Potential solutions:</p>\n<ul>\n<li><p>You can extend from <code>OncePerRequestFilter</code> which guarantees that the filter is only invoked once no matter how many times it's registered within the filter chain. The downside is that it might run it as part of your regular filter chain and not your security filter chain.</p>\n</li>\n<li><p>You can remove the <code>@Component</code> annotation and manually create the filter, e.g:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\nSecurityFilterChain configure(HttpSecurity httpSecurity, @Value(&quot;${auth.key}&quot;) String authKey) throws Exception {\n\n    httpSecurity.authorizeHttpRequests(c -&gt; {\n        c.anyRequest().permitAll();\n    });\n\n\n    httpSecurity.addFilterAt(new StaticKeyAuthFilter(authKey), BasicAuthenticationFilter.class);\n    return httpSecurity.build();\n}\n</code></pre>\n</li>\n<li><p>You can define a <code>FilterRegistrationBean</code> to disable the filter from being automatically added to the filter chain (as suggested by <a href=\"https://stackoverflow.com/questions/79533122/filter-executing-twice/79533192?noredirect=1#comment140260122_79533192\">M. Deinum</a>) and so that it's only present in the security filter chain:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Bean\npublic FilterRegistrationBean staticKeyAuth(StaticKeyAuthFilter filter) {\n    FilterRegistrationBean registration = new FilterRegistrationBean(filter);\n    registration.setEnabled(false);\n    return registration;\n}\n</code></pre>\n</li>\n</ul>\n",
    "score" : 5,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2161358,
      "reputation" : 45211,
      "user_id" : 1915448,
      "user_type" : "registered",
      "accept_rate" : 96,
      "profile_image" : "https://www.gravatar.com/avatar/51afb9344f8a44e60916753d37186513?s=256&d=identicon&r=PG",
      "display_name" : "Dimitri Mestdagh",
      "link" : "https://stackoverflow.com/users/1915448/dimitri-mestdagh"
    },
    "creation_date" : 1742894596,
    "last_activity_date" : 1742910511,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140259962,
    "post_id" : 79533122,
    "body" : "But my application is very simple and doesn&#39;t have multiple servelets",
    "score" : 0,
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "creation_date" : 1742893761,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140259949,
    "post_id" : 79533122,
    "body" : "I did use <code>OncePerRequestFilter</code> its now executing only once. Can you please explain the reason behind this behaviour?",
    "score" : 0,
    "owner" : {
      "account_id" : 2793141,
      "reputation" : 2701,
      "user_id" : 2402971,
      "user_type" : "registered",
      "accept_rate" : 52,
      "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Cody",
      "link" : "https://stackoverflow.com/users/2402971/cody"
    },
    "creation_date" : 1742893616,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140259940,
    "post_id" : 79533122,
    "body" : "Instead of implementing Filter, you should try extending Spring&#39;s OncePerRequestFilter. This is also recommended by the Spring Docs. <a href=\"https://www.baeldung.com/spring-onceperrequestfilter\" rel=\"nofollow noreferrer\">baeldung.com/spring-onceperrequestfilter</a>",
    "score" : 2,
    "owner" : {
      "account_id" : 21724606,
      "reputation" : 1431,
      "user_id" : 16034206,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/MRBdT.jpg?s=256",
      "display_name" : "pebble unit",
      "link" : "https://stackoverflow.com/users/16034206/pebble-unit"
    },
    "creation_date" : 1742893465,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79533192" : [ {
      "comment_id" : 140260870,
      "post_id" : 79533192,
      "body" : "Yes as Spring Boot will now not add it due to the <code>FilterRegistrationBean</code> for said filter.",
      "score" : 1,
      "owner" : {
        "account_id" : 3192259,
        "reputation" : 126800,
        "user_id" : 2696260,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
        "display_name" : "M. Deinum",
        "link" : "https://stackoverflow.com/users/2696260/m-deinum"
      },
      "creation_date" : 1742906753,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140260639,
      "post_id" : 79533192,
      "body" : "@M.Deinum so when I do <code>@Component</code> on a filter it gets added to servlet filter chain (not spring security filter chain). But when I do <code>registration.setEnabled(false)</code>, now its only gets added to spring security filter chain. Right?",
      "score" : 0,
      "owner" : {
        "account_id" : 2793141,
        "reputation" : 2701,
        "user_id" : 2402971,
        "user_type" : "registered",
        "accept_rate" : 52,
        "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Cody",
        "link" : "https://stackoverflow.com/users/2402971/cody"
      },
      "creation_date" : 1742903499,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140260122,
      "post_id" : 79533192,
      "body" : "The <code>OncePerRequestFilter</code> isn&#39;t really a solution for security filters as those should be added to the security filter chain so that they participate in the Spring Security filters. If they don&#39;t you might get unexpected results as it gets executed before the security filter chain. If you want your keep your <code>@Component</code> (for instance due to autowiring or needed dependencies) you should add a <code>FilterRegistrationBean</code> for this specific filter which disables the filter. That way it won&#39;tbe added to the regular filter chain.",
      "score" : 3,
      "owner" : {
        "account_id" : 3192259,
        "reputation" : 126800,
        "user_id" : 2696260,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/qHEzx.png?s=256",
        "display_name" : "M. Deinum",
        "link" : "https://stackoverflow.com/users/2696260/m-deinum"
      },
      "creation_date" : 1742896117,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140260074,
      "post_id" : 79533192,
      "body" : "Is there any way I can see my filter being added twice. I tried printing filters  using <a href=\"https://pastebin.com/raw/h4p9YMQW\" rel=\"nofollow noreferrer\">this</a>, but I don&#39;t see <code>StaticKeyAuthFilter</code> twice.",
      "score" : 0,
      "owner" : {
        "account_id" : 2793141,
        "reputation" : 2701,
        "user_id" : 2402971,
        "user_type" : "registered",
        "accept_rate" : 52,
        "profile_image" : "https://www.gravatar.com/avatar/7be11baed5158c6bb6acd036a15d7b74?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Cody",
        "link" : "https://stackoverflow.com/users/2402971/cody"
      },
      "creation_date" : 1742895388,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}