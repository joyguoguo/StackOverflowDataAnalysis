{
  "question" : {
    "question_id" : 79820016,
    "title" : "Selenium + Serenity BDD cannot find &lt;tbody id=&quot;bodyArchivos&quot;&gt; inside iframe even though it exists in DevTools (Java + Cucumber)",
    "body" : "<p>I’m working on an automated test with <strong>Java + Maven + Selenium WebDriver + Serenity BDD + Cucumber</strong>.</p>\n<p>The test needs to click the “Download” button of the most recent projection file in a table that is rendered inside an iframe.</p>\n<hr />\n<h2>Problem</h2>\n<p>At runtime, my step fails with this assertion:</p>\n<blockquote>\n<p>No se encontró la tabla bodyArchivos ni en el DOM principal ni en ninguno de los iframes de la página. Revisa que la URL sea la de 'Archivos de resultados de proyecciones' y que el id sea exactamente 'bodyArchivos'.</p>\n</blockquote>\n<p>Serenity output (Cucumber scenario):</p>\n<pre class=\"lang-none prettyprint-override\"><code>\nDescargar y validar archivo de proyección ya existente\n\n\\-----------------------------------------------------------------------\n\n23:33:03.045 ERROR \\[           main\\] :     Test failed at step: Y descargo el archivo de proyección más reciente\n\n23:33:03.045 ERROR \\[           main\\] :     No se encontró la tabla bodyArchivos ni en el DOM principal ni en ninguno de los iframes de la página. Revisa que la URL sea la de 'Archivos de resultados de proyecciones' y que el id sea exactamente 'bodyArchivos'.\n\nFailed scenarios:\n\n.../archivos_proyeccion.feature:24 # Descargar y validar archivo de proyección ya existente\n\n\njava.lang.AssertionError: No se encontró la tabla bodyArchivos ni en el DOM principal ni en ninguno de los iframes de la página. Revisa que la URL sea la de 'Archivos de resultados de proyecciones' y que el id sea exactamente 'bodyArchivos'.\n    at org.af.gestion.mi.pension.stepdefinitions.ArchivosProyeccionStepDefinitions.cambiarAFrameConTablaArchivos(ArchivosProyeccionStepDefinitions.java:407)\n    at org.af.gestion.mi.pension.stepdefinitions.ArchivosProyeccionStepDefinitions.descargoArchivoMasReciente(ArchivosProyeccionStepDefinitions.java:202)\n    at ?.descargo el archivo de proyección más reciente(.../archivos_proyeccion.feature:27)\n</code></pre>\n<p>So my helper method cannot find tbody#bodyArchivos either in the main DOM or in any iframe, but in the browser DevTools the element does exist.</p>\n<h1>Step definition that fails</h1>\n<pre class=\"lang-java prettyprint-override\"><code>@Cuando(&quot;descargo el archivo de proyección más reciente&quot;)\npublic void descargoArchivoMasReciente() {\n\n    WebDriver driver = getDriver();\n    WebDriverWait wait = new WebDriverWait(driver, Duration.ofSeconds(40));\n\n    // 1) Switch to the frame (or main DOM) that contains the table\n    cambiarAFrameConTablaArchivos(driver);\n\n    // 2) Wait for the table in the CURRENT context\n    WebElement tabla = wait.until(\n            ExpectedConditions.presenceOfElementLocated(By.id(&quot;bodyArchivos&quot;))\n    );\n\n    // 3) Get the first row (most recent file) and its download button\n    WebElement fila = tabla.findElement(By.cssSelector(&quot;tr:first-child&quot;));\n    WebElement botonDescarga = fila.findElement(By.cssSelector(&quot;td:nth-child(3) &gt; button&quot;));\n\n    // Click using JS in case of overlays\n    ((JavascriptExecutor) driver).executeScript(&quot;arguments[0].click();&quot;, botonDescarga);\n\n    // 4) Go back to main content for the next steps\n    driver.switchTo().defaultContent();\n\n    // (code that waits for the downloaded .csv is omitted)\n}\n</code></pre>\n<h1>Helper method to switch into the iframe</h1>\n<pre class=\"lang-java prettyprint-override\"><code>/**\n * Looks for tbody#bodyArchivos either in the main DOM or inside any iframe.\n * If found, it leaves the driver already switched to the correct context.\n * Otherwise it throws an AssertionError.\n */\nprivate void cambiarAFrameConTablaArchivos(WebDriver driver) {\n\n    // Always start from the main document\n    driver.switchTo().defaultContent();\n    System.out.println(&quot;[DescargaCSV] URL actual: &quot; + driver.getCurrentUrl());\n\n    // 1) First try in the main DOM (no iframe)\n    List&lt;WebElement&gt; tablasEnPrincipal = driver.findElements(By.id(&quot;bodyArchivos&quot;));\n    if (!tablasEnPrincipal.isEmpty()) {\n        System.out.println(&quot;[DescargaCSV] ✔ Tabla bodyArchivos encontrada en el DOM principal (sin iframe).&quot;);\n        return;\n    }\n\n    // 2) If not in main DOM, look into iframes\n    List&lt;WebElement&gt; iframes = driver.findElements(By.tagName(&quot;iframe&quot;));\n    System.out.println(&quot;[DescargaCSV] iframes encontrados en la página: &quot; + iframes.size());\n\n    if (iframes.isEmpty()) {\n        throw new AssertionError(\n            &quot;No se encontró la tabla bodyArchivos ni en el DOM principal ni en iframes (no hay iframes en la página).&quot;\n        );\n    }\n\n    // 3) Try each iframe by index\n    for (int i = 0; i &lt; iframes.size(); i++) {\n        try {\n            driver.switchTo().defaultContent();\n            driver.switchTo().frame(i);\n\n            List&lt;WebElement&gt; tablas = driver.findElements(By.id(&quot;bodyArchivos&quot;));\n            if (!tablas.isEmpty()) {\n                System.out.println(&quot;[DescargaCSV] ✔ Tabla bodyArchivos encontrada en iframe index=&quot; + i);\n                return; // stay in this iframe\n            } else {\n                System.out.println(&quot;[DescargaCSV] iframe index=&quot; + i + &quot; no contiene bodyArchivos&quot;);\n            }\n\n        } catch (NoSuchFrameException e) {\n            System.out.println(&quot;[DescargaCSV] NoSuchFrameException en iframe index=&quot; + i);\n        } catch (StaleElementReferenceException e) {\n            System.out.println(&quot;[DescargaCSV] StaleElementReference en iframe index=&quot; + i +\n                    &quot; → ignoring and continuing with the next one&quot;);\n        }\n    }\n\n    // 4) If we get here, the table was not found anywhere\n    throw new AssertionError(\n        &quot;No se encontró la tabla bodyArchivos ni en el DOM principal ni en ninguno de los iframes de la página. &quot; +\n        &quot;Revisa que la URL sea la de 'Archivos de resultados de proyecciones' y que el id sea exactamente 'bodyArchivos'.&quot;\n    );\n}\n</code></pre>\n<h1>HTML structure (iframe + table)</h1>\n<p>From the Elements tab in DevTools, the page has this iframe:</p>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;iframe\n    name=&quot;ifrcontent&quot;\n    id=&quot;ifrcontent&quot;\n    src=&quot;/PortalAccesoWeb/jsp/templates/blank.jsp&quot;\n    class=&quot;min-width: 500px;&quot;\n    width=&quot;100%&quot;\n    height=&quot;450px&quot;\n    frameborder=&quot;0&quot;\n    allowtransparency=&quot;yes&quot;&gt;\n&lt;/iframe&gt;\n</code></pre>\n<p>When I expand that iframe in DevTools, I see that its document loads another URL and contains the form and the table I need:</p>\n<pre class=\"lang-html prettyprint-override\"><code>&lt;div class=&quot;col-md-12&quot;&gt;\n    &lt;div class=&quot;card-table&quot;&gt;\n        &lt;h5 class=&quot;text-center text-white&quot;&gt;Archivos de resultados de proyecciones&lt;/h5&gt;\n    &lt;/div&gt;\n\n    &lt;div&gt;\n        &lt;table class=&quot;table mb-0&quot;&gt;\n            &lt;caption class=&quot;text-end pb-0&quot;&gt;Últimos archivos de resultados&lt;/caption&gt;\n            &lt;thead&gt;\n                &lt;tr class=&quot;tdtituloAz mx-2&quot;&gt;\n                    &lt;th class=&quot;align-middle&quot;&gt;Archivo&lt;/th&gt;\n                    &lt;th class=&quot;align-middle text-center&quot;&gt;Fecha fin procesamiento&lt;/th&gt;\n                    &lt;th class=&quot;align-middle text-center&quot;&gt;Descargar&lt;/th&gt;\n                &lt;/tr&gt;\n            &lt;/thead&gt;\n            &lt;tbody id=&quot;bodyArchivos&quot;&gt;\n                &lt;tr class=&quot;trTablaImpar&quot;&gt;\n                    &lt;td class=&quot;align-middle&quot;&gt;ProyeccionPensionISSSTE_260925_resultado_58.csv&lt;/td&gt;\n                    &lt;td class=&quot;align-middle text-center&quot;&gt;26/09/2025&lt;/td&gt;\n                    &lt;td class=&quot;align-middle text-center&quot;&gt;\n                        &lt;button class=&quot;btn btn-secondary btn-sm&quot; type=&quot;button&quot;\n                                onclick=&quot;descargarProyeccion('ProyeccionPensionISSSTE_260925_resultado_58.csv');&quot;&gt;\n                            &lt;i class=&quot;fa fa-file-excel-o&quot;&gt;&lt;/i&gt;\n                        &lt;/button&gt;\n                    &lt;/td&gt;\n                &lt;/tr&gt;\n                &lt;!-- several more &lt;tr&gt; rows ... --&gt;\n            &lt;/tbody&gt;\n        &lt;/table&gt;\n    &lt;/div&gt;\n&lt;/div&gt;\n</code></pre>\n<h1>Browser console output</h1>\n<p>In the browser console I tried:</p>\n<pre class=\"lang-js prettyprint-override\"><code>document.querySelectorAll(&quot;iframe&quot;)\ndocument.querySelectorAll(&quot;iframe&quot;).length\n</code></pre>\n<p>and I get:</p>\n<ul>\n<li>NodeList []</li>\n<li>0</li>\n</ul>\n<p>I also tried:</p>\n<pre><code>let frame = window.frames[0];\nframe.document.getElementById(&quot;bodyArchivos&quot;);\n</code></pre>\n<p>and I get:</p>\n<blockquote>\n<p>Uncaught TypeError: Cannot read properties of undefined (reading 'document')</p>\n</blockquote>\n<p>At the same time, in the Console I see a JavaScript error coming from the application:</p>\n<blockquote>\n<p>Uncaught ReferenceError: setUpArchivos is not defined at onload (archivos.do:48)</p>\n</blockquote>\n<p>What I have already tried</p>\n<ul>\n<li>Iterating all iframes by index (driver.switchTo().frame(i)) and searching for By.id(&quot;bodyArchivos&quot;) in each one.</li>\n<li>Looking for the table in the main DOM before switching to frames.</li>\n<li>Confirming in DevTools that the id really is bodyArchivos and that the table is inside ifrcontent.</li>\n<li>Running the test in Edge and Chrome with the same result.</li>\n</ul>\n<p>Question</p>\n<p>What am I doing wrong when trying to locate tbody#bodyArchivos inside this iframe?</p>\n<ul>\n<li>Is there something special about this iframe because its src is /PortalAccesoWeb/jsp/templates/blank.jsp but internally it loads /ProyeccionPensionWeb/archivos.do?</li>\n<li>Could the JavaScript error (setUpArchivos is not defined) prevent the iframe document from being attached to window.frames / document.querySelectorAll(&quot;iframe&quot;) from Selenium’s point of view?</li>\n<li>Do I need a different strategy to switch into this iframe (for example by name or WebElement, or waiting for the inner document to be fully loaded) so that WebDriver can see tbody#bodyArchivos?enter image description hereenter image description here</li>\n</ul>\n",
    "tags" : [ "java", "selenium-webdriver", "iframe", "cucumber", "serenity-bdd" ],
    "owner" : {
      "account_id" : 34563429,
      "reputation" : 1,
      "user_id" : 26636494,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/e8a5aad541aaa29b3e38e7df813993b8?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Daniela Fabra",
      "link" : "https://stackoverflow.com/users/26636494/daniela-fabra"
    },
    "is_answered" : true,
    "view_count" : 43,
    "answer_count" : 2,
    "score" : 0,
    "last_activity_date" : 1763666745,
    "creation_date" : 1763122666,
    "link" : "https://stackoverflow.com/questions/79820016/selenium-serenity-bdd-cannot-find-tbody-id-bodyarchivos-inside-iframe-even",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79820108,
    "question_id" : 79820016,
    "body" : "<pre><code>// 2) Wait for the table in the CURRENT context\n    WebElement tabla = wait.until(\n            ExpectedConditions.presenceOfElementLocated(By.id(&quot;bodyArchivos&quot;))\n    );\n</code></pre>\n<p>You are waiting for the element after you've already thrown an exception that it doesn't exist. Move the wait inside your helper.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 8866,
      "reputation" : 61498,
      "user_id" : 16148,
      "user_type" : "registered",
      "accept_rate" : 73,
      "profile_image" : "https://i.sstatic.net/XTzm1.jpg?s=256",
      "display_name" : "Corey Goldberg",
      "link" : "https://stackoverflow.com/users/16148/corey-goldberg"
    },
    "creation_date" : 1763128735,
    "last_activity_date" : 1763128735,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "answer_id" : 79825891,
    "question_id" : 79820016,
    "body" : "<p>best to use frameToBeAvailableAndSwitchToIt expected condition:  <a href=\"https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/ExpectedConditions.html#frameToBeAvailableAndSwitchToIt(int)\" rel=\"nofollow noreferrer\">https://www.selenium.dev/selenium/docs/api/java/org/openqa/selenium/support/ui/ExpectedConditions.html#frameToBeAvailableAndSwitchToIt(int)</a>  This will wait until the frame has loaded.</p>\n",
    "score" : 0,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 6077817,
      "reputation" : 1362,
      "user_id" : 4744568,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/125cdb7d43927756913b920de016f420?s=256&d=identicon&r=PG",
      "display_name" : "browsermator",
      "link" : "https://stackoverflow.com/users/4744568/browsermator"
    },
    "creation_date" : 1763666745,
    "last_activity_date" : 1763666745,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}