{
  "question" : {
    "question_id" : 79701656,
    "title" : "Why I get error transaction is in progress when my listener phase AFTER_COMMIT",
    "body" : "<p>Why if I set the transaction propagation= Required. I will get error <code>org.springframework.dao.InvalidDataAccessApiUsageException: no transaction is in progress</code>. I cant understand that because my Listner has phase <code>TransactionPhase.AFTER_COMMIT</code> and the transaction should be completed and create new transaction\nBut if I set <code>@Transactional(Transactional.TxType.REQUIRES_NEW)</code> it doesn't throw an error. How it works</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Aspect\n@Component\n@RequiredArgsConstructor\npublic class AspectOffsettingRepository {\n\n  private final ApplicationEventPublisher publisher;\n  private static final String STATUS_FOR_MESSAGE = &quot;REGISTERED&quot;;\n\n  @AfterReturning(\n      pointcut = &quot;execution(* service.repository.impl.OffsettingJpaRepository.save(..))&quot;,\n      returning = &quot;result&quot;\n  )\n  public void afterSave(OffsettingEntity result) {\n    handleAfterSave(result);\n  }\n\n  @AfterReturning(\n      pointcut = &quot;execution(* service.repository.impl.OffsettingJpaRepository.saveAndFlush(..))&quot;,\n      returning = &quot;result&quot;\n  )\n  public void afterSaveAndFlush(OffsettingEntity result) {\n    handleAfterSave(result);\n  }\n\n  private void handleAfterSave(OffsettingEntity entity) {\n    if (entity.getStatus() != null &amp;&amp; STATUS_FOR_MESSAGE.equals(entity.getStatus())) {\n      publisher.publishEvent(new OffsettingRegisteredEvent(\n          entity.getOffsetId(),\n          entity.getCreatedBy(),\n          entity.getFirstPartnerId().toString()\n      ));\n    }\n  }\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@TransactionalEventListener(phase = TransactionPhase.AFTER_COMMIT)\npublic void postSave(OffsettingRegisteredEvent event) {\n    offsettingOutboxService.createMessageToRo(event);\n}\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>@Slf4j\n@Service\n@RequiredArgsConstructor\npublic class OffsettingOutboxService {\n\n  private final OffsettingDebtDao offsettingDebtDao;\n  private final OffsettingDao offsettingDao;\n  private final DebtService debtService;\n  private final OutboxContentBuilder outboxBuilder;\n  private final OutboxService outboxService;\n  private final MdmGateway mdmGateway;\n\n  private static final String OFFSETTING_STATUS = &quot;GLA_CONFIRMATION&quot;;\n\n  @Transactional(Transactional.TxType.REQUIRES_NEW)\n  public void createMessageToRo(OffsettingRegisteredEvent event) {\n    List&lt;PairOffsettingDebtIds&gt; pairsDebtId = findPairsDebtId(event.offsetId());\n    EmployeeInfo employeeInfo = mdmGateway.findEmployeeInfo(event.createdBy());\n    Map&lt;UUID, DebtModel&gt; debtMap = findDebts(pairsDebtId);\n    Map&lt;String, EmployeeInfo&gt; employeeInfoCache = new HashMap&lt;&gt;();\n\n    boolean isRegisterFilled = false;\n\n    for (PairOffsettingDebtIds pair : pairsDebtId) {\n      DebtModel firstDebt = debtMap.get(pair.getFirstDebtId());\n      DebtModel secondDebt = debtMap.get(pair.getSecondDebtId());\n\n      if (firstDebt == null || secondDebt == null) {\n        continue;\n      }\n\n      EmployeeInfo firstEmployeeInfo = employeeInfoCache.computeIfAbsent(\n          firstDebt.getCreatedBy(), mdmGateway::findEmployeeInfo);\n      EmployeeInfo secondEmployeeInfo = employeeInfoCache.computeIfAbsent(\n          secondDebt.getCreatedBy(), mdmGateway::findEmployeeInfo);\n\n      boolean fillRegisterForThisPair = !isRegisterFilled &amp;&amp; Boolean.TRUE.equals(secondDebt.getIsRegisterCreator());\n\n      OutboxRegisterOfOperationContent registerOfOperationContent = createRegisterOfOperationContent(\n          OutboxRegisterOfOperationContentDto.builder()\n              .debtFirstSide(firstDebt)\n              .debtSecondSide(secondDebt)\n              .serviceOriginatorDepartment(event.partnerId())\n              .userName(employeeInfo.fio())\n              .debtFirstSideEmployeeInfo(firstEmployeeInfo)\n              .debtSecondSideEmployeeInfo(secondEmployeeInfo)\n              .debtFirstSideBeginDate(getRelationBeginDate(firstDebt.getRegister().getAccountingPartnerId().toString()))\n              .debtSecondSideBeginDate(getRelationBeginDate(secondDebt.getRegister().getAccountingPartnerId().toString()))\n              .isRegisterFill(fillRegisterForThisPair)\n              .build()\n      );\n\noutboxService.save(outboxBuilder.buildOutbox(registerOfOperationContent, fillRegisterForThisPair));\n\n      if (fillRegisterForThisPair) {\n        isRegisterFilled = true;\n      }\n    }\n\n    OffsettingEntity offsettingEntity = offsettingDao.findByOffsetId(event.offsetId());\n    offsettingEntity.setStatus(OFFSETTING_STATUS);\n\n    offsettingDao.save(offsettingEntity);\n  }\n</code></pre>\n",
    "tags" : [ "java", "spring", "database", "hibernate", "aop" ],
    "owner" : {
      "account_id" : 29890320,
      "reputation" : 7,
      "user_id" : 22906633,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/90bd533be5eb78a6fc2cd70be734f06c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Alexis",
      "link" : "https://stackoverflow.com/users/22906633/alexis"
    },
    "is_answered" : true,
    "view_count" : 75,
    "closed_date" : 1752934672,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1753256898,
    "creation_date" : 1752561240,
    "link" : "https://stackoverflow.com/questions/79701656/why-i-get-error-transaction-is-in-progress-when-my-listener-phase-after-commit",
    "closed_reason" : "Needs details or clarity"
  },
  "answers" : [ {
    "answer_id" : 79703432,
    "question_id" : 79701656,
    "body" : "<p>This seems to be explained in the <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/event/TransactionalEventListener.html\" rel=\"nofollow noreferrer\">docs for <code>@TransactionalEventListener</code></a>:</p>\n<blockquote>\n<p><strong>WARNING</strong>: if the <code>TransactionPhase</code> is set to <code>AFTER_COMMIT</code> (the default), <code>AFTER_ROLLBACK</code>, or <code>AFTER_COMPLETION</code>, the transaction will have been committed or rolled back already, but the transactional resources might still be active and accessible. As a consequence, any data access code triggered at this point will still &quot;participate&quot; in the original transaction, but changes will not be committed to the transactional resource. See <code>TransactionSynchronization.afterCompletion(int)</code> for details.</p>\n</blockquote>\n<p>That explains your observations.  Put another way: an <code>AFTER_COMMIT</code> listener executes (initially) in the context of the transaction that just committed (which is, admittedly, a bit weird), but because that transaction has already committed, you can't actually do much of anything in it that requires a transaction.  But if you enter a method annotated <code>@Transactional(Transactional.TxType.REQUIRES_NEW)</code> then, as that annotation specifies, whatever runs within gets its own, new transaction.</p>\n<p>The referenced <a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/support/TransactionSynchronization.html#afterCompletion(int)\" rel=\"nofollow noreferrer\">docs of <code>TransactionSynchronization.afterCompletion(int)</code></a> recommend a related approach:</p>\n<blockquote>\n<p><strong>NOTE</strong>: The transaction will have been committed or rolled back already, but the transactional resources might still be active and accessible. As a consequence, any data access code triggered at this point will still &quot;participate&quot; in the original transaction, allowing to perform some cleanup (with no commit following anymore!), unless it explicitly declares that it needs to run in a separate transaction. Hence: <strong>Use PROPAGATION_REQUIRES_NEW for any transactional operation that is called from here</strong>.</p>\n</blockquote>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1752669944,
    "last_activity_date" : 1752669944,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140593871,
    "post_id" : 79701656,
    "body" : "So if I will use REQUIRES_NEW, it should resolve problem. I just want the first transaction (before listener) to not wait for the second(after Listener). First Transaction resource will stop during the second transaction?",
    "score" : 0,
    "owner" : {
      "account_id" : 29890320,
      "reputation" : 7,
      "user_id" : 22906633,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/90bd533be5eb78a6fc2cd70be734f06c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Alexis",
      "link" : "https://stackoverflow.com/users/22906633/alexis"
    },
    "creation_date" : 1752669489,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140593859,
    "post_id" : 79701656,
    "body" : "<a href=\"https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/transaction/event/TransactionalEventListener.html\" rel=\"nofollow noreferrer\">The docs</a> say: &quot;<b>WARNING</b>: if the <code>TransactionPhase</code> is set to <code>AFTER_COMMIT</code> (the default) [...] the transaction will have been committed or rolled back already, but the transactional resources might still be active and accessible. As a consequence, any data access code triggered at this point will still &quot;participate&quot; in the original transaction, but changes will not be committed to the transactional resource.&quot;",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1752669125,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140593845,
    "post_id" : 79701656,
    "body" : "most likely, yes, it is unclear. I edit my question maybe its help understand what I want) @kriegaex",
    "score" : 1,
    "owner" : {
      "account_id" : 29890320,
      "reputation" : 7,
      "user_id" : 22906633,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/90bd533be5eb78a6fc2cd70be734f06c?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Alexis",
      "link" : "https://stackoverflow.com/users/22906633/alexis"
    },
    "creation_date" : 1752668952,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140592742,
    "post_id" : 79701656,
    "body" : "Welcome to SO, Alexis. \uD83D\uDE42 I did some reformatting on your behalf, but your description is somewhat difficult to understand. Maybe, you want to write it in your native language and use a translator to translate it to English. Your chances of getting a spot-on answer are much better, if the community members here can clearly understand the question. Also helpful would be a link to a GitHub repository containing a minimal reproducer project (ideally with an automatically populated in-memory DB). That way, everybody could easily reproduce the issue and hopefully help you to fix it.",
    "score" : 0,
    "owner" : {
      "account_id" : 1087271,
      "reputation" : 68569,
      "user_id" : 1082681,
      "user_type" : "registered",
      "accept_rate" : 90,
      "profile_image" : "https://i.sstatic.net/lDK9h.png?s=256",
      "display_name" : "kriegaex",
      "link" : "https://stackoverflow.com/users/1082681/kriegaex"
    },
    "creation_date" : 1752642223,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}