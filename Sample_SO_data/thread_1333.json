{
  "question" : {
    "question_id" : 79718110,
    "title" : "Apache POI FormulaEvaluator returns #VALUE error",
    "body" : "<p>I am using Apache POI 5.2.5 to evaluate an XLOOKUP formula in an Excel sheet. A simple XLOOKUP works fine, but when I combine functions and concatenated ranges, the evaluator returns an error.</p>\n<p><strong>What Iʼm trying to do</strong></p>\n<ol>\n<li>Set a formula on a cell via POI</li>\n<li>Evaluate it with FormulaEvaluator</li>\n</ol>\n<p><strong>What works</strong></p>\n<pre><code>FormulaEvaluator evaluator = workbook.getCreationHelper()\n    .createFormulaEvaluator();\n\n// Simple XLOOKUP\ncell.setCellFormula(&quot;_xlfn.XLOOKUP(C$11,&quot;Sheet2!$A:$A,Sheet2!$Q:$Q)&quot;);\n\nCellValue result = evaluator.evaluate(cell);\n// result.getCellType() == CellType.NUMERIC or STRING as expected\n</code></pre>\n<p><strong>What fails</strong></p>\n<p>When I change the formula to use LEFT, concatenation of three columns and a fallback value</p>\n<pre><code>FormulaEvaluator evaluator = workbook.getCreationHelper()\n    .createFormulaEvaluator();\n\ncell.setCellFormula(&quot;_xlfn.XLOOKUP(LEFT(C$18,11)&amp;C$9&amp;C$11,Sheet2!$A$4:$A$600&amp;Sheet2!$C$4:$C$600&amp;Sheet2!$E$4:$E$600,Sheet2!$N$4:$N$600,\\&quot;Not found\\&quot;)&quot;);\n\nCellValue result = evaluator.evaluate(cell);\n// result.getCellType() == CellType.ERROR\n// result.getErrorValue() == 15 (#VALUE! error)\n</code></pre>\n<p><strong>Environment</strong></p>\n<ol>\n<li>Apache POI 5.2.5</li>\n<li>Java 21</li>\n<li>Excel file created in Office 365 (xlsm)</li>\n</ol>\n",
    "tags" : [ "java", "excel", "apache-poi" ],
    "owner" : {
      "account_id" : 27469937,
      "reputation" : 61,
      "user_id" : 20959052,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/xVRMVNfi.jpg?s=256",
      "display_name" : "Nguyen Tung Son",
      "link" : "https://stackoverflow.com/users/20959052/nguyen-tung-son"
    },
    "is_answered" : true,
    "view_count" : 119,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1753784315,
    "creation_date" : 1753763709,
    "link" : "https://stackoverflow.com/questions/79718110/apache-poi-formulaevaluator-returns-value-error",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79718449,
    "question_id" : 79718110,
    "body" : "<p><strong>Apache POI's <code>FormulaEvaluator</code> does not fully support dynamic array operations</strong> such as concatenating entire cell ranges on the fly within a formula's argument. So use a helper column for working around this evaluation limitation. It simplifies the formula into a structure <code>FormulaEvaluator</code> can successfully process.</p>\n<p>Instead of performing the complex concatenation inside the <code>XLOOKUP</code> formula pre-calculate it in a new column on <code>Sheet2</code>.</p>\n<p>1. In your Excel template (<code>Sheet2</code>) add a new helper column (column <code>X</code>) to hold the concatenated lookup keys.</p>\n<p>2. Set the helper formula in cell <code>X4</code> of <code>Sheet2</code>:</p>\n<pre><code>=A4&amp;C4&amp;E4\n</code></pre>\n<p>3. Apply this formula down to <code>X600</code>. You can do this once in the template file or programmatically using POI if the sheet is dynamic</p>\n<p>4. Simplify your <code>XLOOKUP</code> formula you set in Java code to reference this new helper column</p>\n<p>5. Your Java code would then look like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>FormulaEvaluator evaluator = workbook.getCreationHelper()\n    .createFormulaEvaluator();\n\nString formula = &quot;_xlfn.XLOOKUP(LEFT(C$18,11)&amp;C$9&amp;C$11, Sheet2!$X$4:$X$600, Sheet2!$N$4:$N$600, \\&quot;Not found\\&quot;)&quot;;\ncell.setCellFormula(formula);\n\nCellValue result = evaluator.evaluate(cell);\n</code></pre>\n<p>The lookup value remains the same but the lookup array is now a simple range.</p>\n<p>Alternative option is to perform the entire lookup logic within your code bypassing the <code>FormulaEvaluator</code> for this specific cell. It'll give you complete control but require writing more code to replicate the Excel formula's logic. Use it if you can't modify the structure of the file.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1207862,
      "reputation" : 4210,
      "user_id" : 1177031,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/79eaae35b3331731ecfb9e360bb8380b?s=256&d=identicon&r=PG",
      "display_name" : "kapandron",
      "link" : "https://stackoverflow.com/users/1177031/kapandron"
    },
    "creation_date" : 1753784315,
    "last_activity_date" : 1753784315,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140626734,
    "post_id" : 79718110,
    "body" : "Thanks a lot, @Michal! Based on the answer below, it seems that Apache POI still doesn’t fully support dynamic array operations. The link you shared was also very helpful — really appreciate your support!",
    "score" : 0,
    "owner" : {
      "account_id" : 27469937,
      "reputation" : 61,
      "user_id" : 20959052,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/xVRMVNfi.jpg?s=256",
      "display_name" : "Nguyen Tung Son",
      "link" : "https://stackoverflow.com/users/20959052/nguyen-tung-son"
    },
    "creation_date" : 1753792227,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140625797,
    "post_id" : 79718110,
    "body" : "<a href=\"https://stackoverflow.com/questions/65344447/apache-poi-in-the-formula\" title=\"apache poi in the formula\">stackoverflow.com/questions/65344447/apache-poi-in-the-formu&zwnj;&#8203;la</a>",
    "score" : 0,
    "owner" : {
      "account_id" : 4998137,
      "reputation" : 7674,
      "user_id" : 4017932,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/7oZgXhae.png?s=256",
      "display_name" : "Michal",
      "link" : "https://stackoverflow.com/users/4017932/michal"
    },
    "creation_date" : 1753768137,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79718449" : [ {
      "comment_id" : 140626722,
      "post_id" : 79718449,
      "body" : "Thank you so much for your help! Your solution worked perfectly and saved me a lot of time. I really appreciate your support and clear explanation. \uD83D\uDE4F",
      "score" : 0,
      "owner" : {
        "account_id" : 27469937,
        "reputation" : 61,
        "user_id" : 20959052,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/xVRMVNfi.jpg?s=256",
        "display_name" : "Nguyen Tung Son",
        "link" : "https://stackoverflow.com/users/20959052/nguyen-tung-son"
      },
      "creation_date" : 1753792045,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}