{
  "question" : {
    "question_id" : 79818242,
    "title" : "What exactly is the difference between AverageTime and SingleShotTime in Java Microbenchmark Harness?",
    "body" : "<p>I think I understand the difference between <code>AverageTime</code> and <code>Throughput</code>.\nLet's say we have a method with the following annotations:</p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>@Benchmark\n@Fork(value = 1, warmups = 0)\n@Measurement(iterations = 1, time = 1, timeUnit = TimeUnit.SECONDS)\n</code></pre>\n<p>If I use <code>@BenchmarkMode(Mode.AverageTime)</code>, JMH will launch one fork (because <code>@Fork(value = 1)</code>), perform one iteration (because <code>@Measurement(iterations = 1)</code>), and execute method <code>fooBenchmark</code> as many times as it can complete the invocations (JMH calls it <code>Level.Invocation</code> in <code>org.openjdk.jmh.annotations</code> package) in full in at least one second (because <code>@Measurement(time = 1, timeUnit = TimeUnit.SECONDS)</code>).\nWe divide the elapsed time by invocations.\nThis gives the average time per invocation.</p>\n<p>If I use <code>@BenchmarkMode(Mode.Throughput)</code>, we divide the number of completed invocations by the elapsed time.\nThis gives us the throughput.</p>\n<p>Let's say we have a benchmark class with a state <code>Foo</code>:</p>\n<pre class=\"lang-kotlin prettyprint-override\"><code>@State(Scope.Benchmark)\ninternal open class FooBenchmark {\n    class Foo {\n        private val values = mutableListOf&lt;String&gt;()\n\n        fun add() = values.add(values.size.toString())\n\n        fun size() = values.size\n    }\n\n    private val foo = Foo()\n\n    @Benchmark\n    @Fork(value = 1, warmups = 0)\n    @Measurement(iterations = 1, time = 1, timeUnit = TimeUnit.SECONDS)\n    @BenchmarkMode(Mode.SingleShotTime)\n    fun fooBenchmark(hole: Blackhole) {\n        check(foo.size() == 0)\n        foo.add()\n        check(foo.size() == 1)\n        hole.consume(foo)\n    }\n}\n</code></pre>\n<p>When I use <code>@BenchmarkMode(Mode.SingleShotTime)</code> I expect JMH to make exactly one invocation and measure the time of exactly this one invocation.\nBut for me, for <code>SingleShotTime</code>, JMH calls the method <code>fooBenchmark</code> several times.\n1 fork, 1 iteration, but several invocations.\nAnd it uses the same instance of the <code>FooBenchmark</code> class in different threads.\nThis leads to a conflict when accessing the <code>foo</code> state.</p>\n<p>This is just an example of how multiple calls are definitely happening. I do NOT need to access data from different threads.</p>\n<p>I don't understand how each of the JMH modes works? Or did I configure the <code>SingleShotTime</code> mode incorrectly?</p>\n<p>This is what JMH produces when running the task:</p>\n<pre class=\"lang-none prettyprint-override\"><code>&gt; Task :lib:runBenchmark\n# Detecting actual CPU count: 8 detected\n# JMH version: 1.37\n# VM version: JDK 19.0.1, OpenJDK 64-Bit Server VM, 19.0.1+10-21\n# VM invoker: /opt/jdk-19.0.1/bin/java\n# VM options: -Dfile.encoding=UTF-8 -Duser.country=US -Duser.language=en -Duser.variant\n# Blackhole mode: compiler (auto-detected, use -Djmh.blackhole.autoDetect=false to disable)\n# Warmup: &lt;none&gt;\n# Measurement: 1 iterations, 1 s each\n# Timeout: 10000 ms per iteration\n# Threads: 8 threads\n# Benchmark mode: Single shot invocation time\n# Benchmark: org.kepocnhh.jmh.FooBenchmark.fooBenchmark\n</code></pre>\n",
    "tags" : [ "java", "microbenchmark", "jmh" ],
    "owner" : {
      "account_id" : 5542681,
      "reputation" : 407,
      "user_id" : 4398606,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-YnuEgbNqN_o/AAAAAAAAAAI/AAAAAAAAAoU/aTsjiuToXSQ/s256-rj/photo.jpg",
      "display_name" : "Stanley Wintergreen",
      "link" : "https://stackoverflow.com/users/4398606/stanley-wintergreen"
    },
    "is_answered" : true,
    "view_count" : 107,
    "answer_count" : 1,
    "score" : 2,
    "last_activity_date" : 1763756711,
    "creation_date" : 1762980999,
    "link" : "https://stackoverflow.com/questions/79818242/what-exactly-is-the-difference-between-averagetime-and-singleshottime-in-java-mi",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79820528,
    "question_id" : 79818242,
    "body" : "<p><strong>TL;DR:</strong> You've configured JMH to execute the benchmark with more than one thread. Remove the <code>-t=max</code> argument from the command line.</p>\n<hr />\n<h1>Solution</h1>\n<p>You're right that <code>SingleShotTime</code> will have each thread execute the benchmark method only <em>once</em> per iteration. All other currently available modes are time-based; they will have each thread execute the benchmark method as many times as possible within the configured amount of time.</p>\n<p>Your problem, based on your output, is the number of threads. From <a href=\"https://stackoverflow.com/questions/79818242/what-exactly-is-the-difference-between-averagetime-and-singleshottime-in-java-mi?noredirect=1#comment140854223_79818242\">your comment</a>, you're configuring that via command line arguments with <code>-t=max</code>. A value of <code>max</code> means to use as many threads as there are processors. In your case that's 8 threads. That's how many threads execute the benchmark method <em>concurrently</em> in a <em>single iteration</em>.</p>\n<p>You probably only want one thread. That's the default value, so you should be fine just removing the <code>-t</code> argument. You can also configure the number for threads with the <code>@Threads</code> annotation. Note command line arguments take precedence over annotations.</p>\n<hr />\n<h1>Additional Info - How JMH Executes a Benchmark</h1>\n<p>Since your general understanding of how JMH executes a benchmark <em>seems</em> incomplete to me, a typical flow of JMH looks like the following:</p>\n<ul>\n<li>Benchmark\n<ul>\n<li>Mode and other params\n<ul>\n<li>Warmup fork (if any)\n<ul>\n<li>Warmup iteration (if any)\n<ul>\n<li>Invoke method (operation)</li>\n</ul>\n</li>\n<li>Repeat &quot;warmup iteration&quot; as many times as configured</li>\n<li>Measurement iteration\n<ul>\n<li>Invoke method (operation)</li>\n</ul>\n</li>\n<li>Repeat &quot;measurement iteration&quot; as many times as configured</li>\n</ul>\n</li>\n<li>Repeat &quot;warmup fork&quot; as many times as configured</li>\n<li>Measurement fork\n<ul>\n<li>Warmup iteration (if any)\n<ul>\n<li>Invoke method (operation)</li>\n</ul>\n</li>\n<li>Repeat &quot;warmup iteration&quot; as many times as configured</li>\n<li>Measurement iteration\n<ul>\n<li>Invoke method (operation)</li>\n</ul>\n</li>\n<li>Repeat &quot;measurement iteration&quot; as many times as configured</li>\n</ul>\n</li>\n<li>Repeat &quot;measurement fork&quot; as many times as configured</li>\n</ul>\n</li>\n<li>Repeat &quot;mode and other params&quot; for all combinations of modes and params</li>\n</ul>\n</li>\n<li>Repeat &quot;benchmark&quot; for each selected benchmark</li>\n</ul>\n<p>Some configurations may change that flow (e.g., &quot;warmup mode&quot;, groups, etc.).</p>\n<p>The benchmark method will be invoked <em>once</em> when the mode is <code>SingleShotTime</code>. It will be invoked as many times as possible within the configured duration for all other modes. Note that time is a &quot;minimum&quot;. The last operation of an iteration may cause the iteration to go longer than the configured duration (expected behavior). If an iteration takes too long then it will be interrupted after a configurable timeout.</p>\n<p>During an iteration, a benchmark method will be invoked by one or more threads. By default it will be one thread. If multiple threads, they will invoke the benchmark method <em>concurrently</em>. The number of threads can be configured via the <code>@Threads</code> annotation.</p>\n<p>The number of forks can be configured via the <code>@Fork</code> annotation. The <code>value</code> element controls how many measurement forks there will be. The <code>warmups</code> element controls how many warmup forks there will be. All results from a warmup fork, including the results of its measurement iterations, will be ignored.</p>\n<p>The number of warmup iterations and their duration can be configured via the <code>@Warmup</code> annotation. The results of warmup iterations are ignored.</p>\n<p>The number of measurement iterations and their duration can be configured via the <code>@Measurement</code> annotation.</p>\n<p>All these things can be configured via the command-line or programmatically as well.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1763167538,
    "last_activity_date" : 1763756711,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140854223,
    "post_id" : 79818242,
    "body" : "It looks like the threads are the real issue. Even in SingleShotTime mode, it&#39;s not just one iteration, but as many as there are threads involved. I had previously set -t=max. After manually setting @Threads(1), the method executed exactly once, as I expected. @Slaw, If you format this as an answer, I&#39;ll accept it.",
    "score" : 0,
    "owner" : {
      "account_id" : 5542681,
      "reputation" : 407,
      "user_id" : 4398606,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-YnuEgbNqN_o/AAAAAAAAAAI/AAAAAAAAAoU/aTsjiuToXSQ/s256-rj/photo.jpg",
      "display_name" : "Stanley Wintergreen",
      "link" : "https://stackoverflow.com/users/4398606/stanley-wintergreen"
    },
    "creation_date" : 1763127011,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140853624,
    "post_id" : 79818242,
    "body" : "I was mistaken about the default number of warmup iterations. Looks like it depends on the mode. I don&#39;t have documentation for this, but from testing the default number of warmup iterations for SingleShotTime mode is 0 (as your output shows). For other modes it&#39;s 5 (at least for AverageTime). What&#39;s odd about your output is that it shows the benchmark is using 8 threads. You aren&#39;t configuring the number of threads via annotations, so I believe the default should be 1 thread. Are you configuring the thread count via command line arguments? Does <code>@Threads(1)</code> help?",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1763102151,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140852209,
    "post_id" : 79818242,
    "body" : "sidenote, not sure if relevant: posted code does not look like Java, more like Kotlin",
    "score" : 0,
    "owner" : {
      "account_id" : 31180,
      "reputation" : 29752,
      "user_id" : 85421,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/kKvXH.gif?s=256",
      "display_name" : "user85421",
      "link" : "https://stackoverflow.com/users/85421/user85421"
    },
    "creation_date" : 1763032025,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140852144,
    "post_id" : 79818242,
    "body" : "@Slaw, I determined this because <code>check(foo.size() == 0)</code> does not succeed, because on the second call the size is no longer 0. Also, the @Warmup annotation doesn&#39;t control the number of warmups. It only controls the number of iterations and their time in each warmup. I added Edit #1 where you can see that <code>Warmup: &lt;none&gt;</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 5542681,
      "reputation" : 407,
      "user_id" : 4398606,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/-YnuEgbNqN_o/AAAAAAAAAAI/AAAAAAAAAoU/aTsjiuToXSQ/s256-rj/photo.jpg",
      "display_name" : "Stanley Wintergreen",
      "link" : "https://stackoverflow.com/users/4398606/stanley-wintergreen"
    },
    "creation_date" : 1763029213,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140851689,
    "post_id" : 79818242,
    "body" : "How are you determining the benchmark is invoked more than once? I see you have <code>warmups = 0</code> in the <code>@Fork</code> annotation. That configures the number of warmup <i>forks</i>. You should still be seeing the default number of warmups for the <i>benchmark</i> (which I think is 5). You can control the number of benchmark warmups with the <code>@Warmup</code> annotation. You also say the state is being accessed by different threads. And presumably you believe this access is not properly synchronized. Again, how are you determining this?",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1763011725,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79820528" : [ {
      "comment_id" : 140866987,
      "post_id" : 79820528,
      "body" : "I think that additional info can be helpful to future readers in this context. And I had put the solution at the start, separate from the additional info, so that one would see the solution first and wouldn&#39;t have to read everything if they didn&#39;t want to. But I&#39;ve added headers and a &quot;TL;DR&quot; to make it easier for someone to jump straight to what they want/choose what parts to read.",
      "score" : 0,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49884,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1763756100,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140866185,
      "post_id" : 79820528,
      "body" : "Yes, there was some confusion with @Warmup. In any case, there were no warmups at all in my example. As you wrote above, SingleShotTime has 0 warmups by default. I personally figured out how to configure JMH so it calls the method exactly once. Next time anyone encounters this question here, they can jump straight to the solution. I&#39;ll mark the answer in any case, but for now I recommend keeping it shorter.",
      "score" : 0,
      "owner" : {
        "account_id" : 5542681,
        "reputation" : 407,
        "user_id" : 4398606,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/-YnuEgbNqN_o/AAAAAAAAAAI/AAAAAAAAAoU/aTsjiuToXSQ/s256-rj/photo.jpg",
        "display_name" : "Stanley Wintergreen",
        "link" : "https://stackoverflow.com/users/4398606/stanley-wintergreen"
      },
      "creation_date" : 1763727766,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140865215,
      "post_id" : 79820528,
      "body" : "Your understanding seemed incomplete to me for two reasons. (1) You said, &quot;<i>Also, the @Warmup annotation doesn&#39;t control the number of warmups.</i>&quot;, but that&#39;s incorrect. It does control the number of warmup <i>iterations</i>. Now, it doesn&#39;t control the number of warmup <i>forks</i>. That&#39;s what <code>@Fork(warmups = ...)</code> is for. But you seemingly mixed that up. (2) You said, &quot;<i>it&#39;s not just one iteration, but as many as there are threads involved</i>&quot;, but again that&#39;s incorrect. Multiple threads can invoke the operation in a <i>single iteration</i>. That&#39;s one way you can benchmark multi-threaded code.",
      "score" : 0,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49884,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1763675435,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140865210,
      "post_id" : 79820528,
      "body" : "Based on your question and comments, I believed providing background information of how JMH executes a benchmark was useful for understanding why <code>-t=max</code> gave the output it did and why configuring JMH to use one thread solved your question. Also, half your question was dedicated to trying to explain your understanding of how JMH executes a benchmark. Your understanding <i>seemed</i> incomplete to me, which could have contributed to your confusion. I wanted to address that as well.",
      "score" : 0,
      "owner" : {
        "account_id" : 8532578,
        "reputation" : 49884,
        "user_id" : 6395627,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Slaw",
        "link" : "https://stackoverflow.com/users/6395627/slaw"
      },
      "creation_date" : 1763675206,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140864615,
      "post_id" : 79820528,
      "body" : "The real question is why SingleShotTime can be called more than once. Keep your answer short. Keep it to the essentials. No need to explain every annotation in detail. And I&#39;ll accept your answer.",
      "score" : 0,
      "owner" : {
        "account_id" : 5542681,
        "reputation" : 407,
        "user_id" : 4398606,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/-YnuEgbNqN_o/AAAAAAAAAAI/AAAAAAAAAoU/aTsjiuToXSQ/s256-rj/photo.jpg",
        "display_name" : "Stanley Wintergreen",
        "link" : "https://stackoverflow.com/users/4398606/stanley-wintergreen"
      },
      "creation_date" : 1763652968,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}