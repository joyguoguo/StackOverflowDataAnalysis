{
  "question" : {
    "question_id" : 79537036,
    "title" : "Resilience4j &amp; Spring Boot 3 - Retry works but Circuit Breaker doesn&#39;t",
    "body" : "<p>I'd like to use Resilience4j's Circuit Breaker with Retry, Retry works but Circuit Breaker doesn't unfortunately.</p>\n<pre><code>    public Object execute(Function&lt;String, Object&gt; func, String param) throws Exception {\n        return executeWitCircuitBreaker(func, param);\n    }\n\n    private Object executeWitCircuitBreaker(Function&lt;String, Object&gt; func, String param) throws Exception {\n        // https://resilience4j.readme.io/docs/circuitbreaker\n        CircuitBreakerConfig circuitBreakerConfig = CircuitBreakerConfig.custom()\n                .failureRateThreshold(circuitBreakerFailureRateThreshold)\n                .slidingWindowSize(circuitBreakerSlidingWindowSize)\n                .minimumNumberOfCalls(circuitBreakerMinimumNumberOfCalls)\n                .slowCallDurationThreshold(Duration.ofMillis(circuitBreakerSlowCallDurationThreshold))\n                .permittedNumberOfCallsInHalfOpenState(circuitBreakerPermittedNumberOfCallsInHalfOpenState)\n                .waitDurationInOpenState(Duration.ofMillis(circuitBreakerWaitDurationInOpenState))\n                .enableAutomaticTransitionFromOpenToHalfOpen()\n                .build();\n\n        CircuitBreaker circuitBreaker = CircuitBreaker.of(&quot;lrtServicesCircuitBreaker&quot;, circuitBreakerConfig);\n\n        Callable&lt;Object&gt; decoratedCallable = CircuitBreaker.decorateCallable(\n                circuitBreaker,\n                () -&gt; {\n                    LOGGER.debug(&quot;Inside Circuit Breaker, calling Retry...&quot;);\n                    // for testing purposes I bypassed the Retry but it still doesn't work\n                    // return executeWithRetry(func, param);\n                    return func.apply(param);\n                }\n        );\n\n        return decoratedCallable.call();\n    }\n\n\n    private Object executeWithRetry(Function&lt;String, Object&gt; func, String param) throws Exception {\n        IntervalFunction intervalFn = IntervalFunction.ofExponentialBackoff(retryInitialIntervalMillis, retryMultiplier);\n            RetryConfig retryConfig = RetryConfig.custom()\n                .maxAttempts(retryMaxAttempts)\n                .intervalFunction(intervalFn)\n                .build();\n\n        Retry retry = Retry.of(&quot;lrtServicesRetry&quot;, retryConfig);\n\n        Callable&lt;Object&gt; decoratedCallable = Retry.decorateCallable(\n                retry,\n                () -&gt; {\n                    LOGGER.debug(&quot;Inside Retry, calling the real function...&quot;);\n                    return func.apply(param);\n                }\n        );\n\n        return decoratedCallable.call();\n    }\n</code></pre>\n<p>My config is</p>\n<pre><code>lrt.parallel.circuitBreaker.failureRateThreshold=50\nlrt.parallel.circuitBreaker.waitDurationInOpenState=1000\nlrt.parallel.circuitBreaker.permittedNumberOfCallsInHalfOpenState=3\nlrt.parallel.circuitBreaker.slowCallDurationThreshold=30000\nlrt.parallel.circuitBreaker.slidingWindowSize=2\nlrt.parallel.circuitBreaker.minimumNumberOfCalls=2\n\nlrt.parallel.retry.maxAttempts=3\nlrt.parallel.retry.exponentialBackoff.initialIntervalMillis=100\nlrt.parallel.retry.exponentialBackoff.multiplier=1\n</code></pre>\n<p>The gradle dependencies look like</p>\n<pre><code>    implementation &quot;org.springframework.boot:spring-boot-starter-web&quot;\n    implementation &quot;org.springframework.boot:spring-boot-starter-aop&quot;\n\n    implementation &quot;io.github.resilience4j:resilience4j-spring-boot3:2.3.0&quot;\n</code></pre>\n<p>The test file is</p>\n<pre><code>@SpringBootTest(classes = { RetryAndCircuitBreakerExecutor.class })\n@TestPropertySource(locations = &quot;classpath:application.properties&quot;)\npublic class RetryAndCircuitBreakerExecutorTest {\n\n    @Autowired\n    private RetryAndCircuitBreakerExecutor uut;\n    @Mock private RestTemplate restTemplate;\n\n    @Test\n    public void testRetry_whenTwoCallsFailedThirdSuccessful_thenSuccessful() throws Exception {\n        String url = &quot;https://acme.com&quot;;\n        String data = &quot;&lt;data/&gt;&quot;;\n\n        when(restTemplate.getForEntity(url, Object.class))\n                .thenThrow(new RuntimeException())\n                .thenThrow(new RuntimeException())\n                .thenReturn(ResponseEntity.ok().body(data));\n\n        ResponseEntity&lt;String&gt; responseEntity = (ResponseEntity&lt;String&gt;) uut.execute((u) -&gt; restTemplate.getForEntity(u, Object.class), url);\n\n        assertEquals(data, responseEntity.getBody());\n\n        verify(restTemplate, times(3)).getForEntity(url, Object.class);\n    }\n\n    @Test\n    public void testRetry_threeCallsFailed_thenThrowException() throws Exception {\n        String url = &quot;https://acme.com&quot;;\n        String data = &quot;&lt;data/&gt;&quot;;\n        String exceptionMessage = &quot;TimeoutError&quot;;\n\n        when(restTemplate.getForEntity(url, Object.class))\n                .thenThrow(new RuntimeException(exceptionMessage))\n                .thenThrow(new RuntimeException(exceptionMessage))\n                .thenThrow(new RuntimeException(exceptionMessage))\n                .thenReturn(ResponseEntity.accepted().body(data));\n\n        RuntimeException e = assertThrows(\n                RuntimeException.class,\n                () -&gt; uut.execute((u) -&gt; restTemplate.getForEntity(u, Object.class), url)\n        );\n\n        assertEquals(exceptionMessage, e.getMessage());\n\n        verify(restTemplate, times(3)).getForEntity(url, Object.class);\n    }\n\n    @Test\n    /*\n    - the call will be retried 3 times then the call fails\n    - the slidingWindowSize is 4, the failureRateThreshold is 51 -&gt; if the 51% of the 4 calls fail then the circuit breaker opens =&gt; 3 calls\n         it opens and after 500 ms will go half open\n    3 * 3 calls have to fail to make the circuit breaker open\n     */\n    public void testCircuitBreaker_() {\n        String url = &quot;https://acme.com&quot;;\n        String exceptionMessage = &quot;TimeoutError&quot;;\n        String data = &quot;&lt;data/&gt;&quot;;\n\n        when(restTemplate.getForEntity(url, Object.class))\n                .thenThrow(Collections.nCopies(99, new RuntimeException(exceptionMessage)).toArray(new RuntimeException[0]))\n                .thenReturn(ResponseEntity.accepted().body(data));\n\n        // 3 calls -&gt; retrying 3 times and throwing RuntimeException\n        for(int i = 0; i &lt; 30; i++) {\n            assertThrows(\n                    RuntimeException.class,\n                    () -&gt; uut.execute((u) -&gt; restTemplate.getForEntity(u, Object.class), url)\n            );\n        }\n        // 4th call -&gt; throwing CallNotPermittedException immediately\n        CallNotPermittedException e = assertThrows(\n                CallNotPermittedException.class,\n                () -&gt; uut.execute((u) -&gt; restTemplate.getForEntity(u, Object.class), url)\n        );\n    }\n}\n</code></pre>\n<p>I changed the parameters of the test to make sure the circuit breaker opens so I can see the <code>CallNotPermittedException</code> but it always throws the RuntimeException. My expectation would be that after the 2nd call not the <code>RuntimeException</code> is thrown (as the mock is not called) but the Circuit Breaker will throw <code>CallNotPermittedException</code>. However it is not the case, it always throws the <code>RuntimeException</code> so the Circuit Breaker is not working.</p>\n<p>The Retry works fine.</p>\n<p>Any thoughts please?<br />\nThanks!</p>\n",
    "tags" : [ "java", "circuit-breaker", "resilience4j" ],
    "owner" : {
      "account_id" : 1324418,
      "reputation" : 1519,
      "user_id" : 1269572,
      "user_type" : "registered",
      "accept_rate" : 76,
      "profile_image" : "https://www.gravatar.com/avatar/71bbb43fc9269586beb0688707ebae7c?s=256&d=identicon&r=PG",
      "display_name" : "Viktor",
      "link" : "https://stackoverflow.com/users/1269572/viktor"
    },
    "is_answered" : false,
    "view_count" : 83,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1743015657,
    "creation_date" : 1743015657,
    "link" : "https://stackoverflow.com/questions/79537036/resilience4j-spring-boot-3-retry-works-but-circuit-breaker-doesnt",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}