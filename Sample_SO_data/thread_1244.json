{
  "question" : {
    "question_id" : 79727400,
    "title" : "Test case throwing NPE when calling mocked method",
    "body" : "<p>I am trying to write a Mockito test class to cover some db interaction.  The test case I am writing is supposed to return a stub response when the database call is invoked, but it's throwing an NPE trying to actually build a database connection.</p>\n<p>Here is the method I am trying to test:</p>\n<pre><code>public class AdultDayCenterDBHandler extends DBTemplate implements AppConstants {\n    Logger logger = LogManager.getLogger(AdultDayCenterDBHandler.class);    \n    public List&lt;FacilityEntity&gt; retrieveAllAdultDayCenterFacilities(FacilitySearchCriteriaInf adcSearchCriteria) throws AdultDayCenterException\n        {\n            //Retrieve all the adult day care facilities.\n            logger.info(&quot;[retrieveAllAdultDayCenterFacilities]:[START]&quot;);\n            String sqlQuery = prepareQuery((FacilitySearchCriteriaInf)adcSearchCriteria);\n            \n            SearchQuery searchQuery = new SearchQuery();\n            searchQuery.setSqlQuery(sqlQuery);\n            List&lt;FacilityEntity&gt; adcList;\n            try {\n                if(null != logger) logger.debug(&quot;Sending Executing SQL query : &quot; + searchQuery.getSqlQuery());\n                adcList = (List&lt;FacilityEntity&gt;) callDB((SearchQuery)searchQuery);\n            } catch (DBException e) {\n                throw new AdultDayCenterException(&quot;Error ocurred in AdultDayCenterDBHandler while calling DB&quot;,e);\n            }\n            \n            logger.info(&quot;[retrieveAllAdultDayCenterFacilities]:[END]&quot;);\n            return adcList;\n            \n        }\n</code></pre>\n<p>And here is the test case:</p>\n<pre><code>@ExtendWith(MockitoExtension.class)\npublic class AdultDayCenterDBHandlerTest {\n    \n    @Mock\n    private DBTemplate dbTemplate;\n    @Mock\n    private DBUtil dbUtil;\n    \n    @InjectMocks\n    private AdultDayCenterDBHandler dbHandler;\n    \n    @BeforeEach\n    public void setUp() {\n        assertNotNull(dbUtil);\n        assertNotNull(dbTemplate);\n    }\n    \n    @Test\n    public void testRetrieveAllAdultDayCenterFacilities() throws Exception {\n        //Setup\n        \n        List&lt;FacilityEntity&gt; facilityList = generateStubData();\n        List&lt;FacilityEntity&gt; responseFromTest = null;\n        ADCSearchCriteria adcSearchCriteria = generateSearchCriteria();\n        \n        Mockito.when(dbTemplate.callDB(any(SearchQuery.class))).thenReturn(facilityList);\n        \n        //Get Result Set\n        responseFromTest = dbHandler.retrieveAllAdultDayCenterFacilities(adcSearchCriteria);\n        \n        //Assertions\n        assertNotNull(responseFromTest);\n        assertEquals(responseFromTest.get(0).getFacilityName(),facilityList.get(0).getFacilityName());\n    }\n\n    private List&lt;FacilityEntity&gt; generateStubData() {\n        List&lt;FacilityEntity&gt; response = new ArrayList&lt;FacilityEntity&gt;();\n        \n        FacilityEntity entity = new FacilityEntity();\n        entity.setFacilityName(&quot;Test Facility 1&quot;);\n        entity.setLicenseId(123456);\n        entity.setLocationAddressStreetNumber(&quot;1234&quot;);\n        entity.setLocationAddressLine1(&quot;Main Street&quot;);\n        entity.setLocationAddressCity(&quot;Mechanicsville&quot;);\n        entity.setLocationAddressStateName(&quot;VA&quot;);\n        entity.setLocationAddressZipCode(&quot;23116&quot;);\n        entity.setLocationCountyFips(&quot;51085&quot;);\n        entity.setLocationCountyDesc(&quot;Hanover&quot;);\n        entity.setAdministratorFirstName(&quot;Jane&quot;);\n        entity.setAdministratorSurname(&quot;Doe&quot;);\n        entity.setAdministratorTitle(&quot;Administrator&quot;);\n        entity.setBusinessPhoneNumber(&quot;804-301-2011&quot;);\n        entity.setClientCode(&quot;2101&quot;);\n        \n        response.add(entity);\n        \n        return response;\n    }\n    \n    private ADCSearchCriteria generateSearchCriteria() {\n        ADCSearchCriteria criteria = new ADCSearchCriteria();\n        \n        criteria.setFacilityName(&quot;Test Facility 1&quot;);\n        criteria.setProgramCode(PROGRAM_CODES.ADC_F);\n        \n        return criteria;\n    }\n}\n</code></pre>\n<p>My guess is I need to mock an additional object, but I'm not sure why this line:</p>\n<pre><code>Mockito.when(dbTemplate.callDB(any(SearchQuery.class))).thenReturn(facilityList);\n\n//Get Result Set\nresponseFromTest = dbHandler.retrieveAllAdultDayCenterFacilities(adcSearchCriteria);\n</code></pre>\n<p>isn't returning the mock object I defined.  It's throwing an NPE trying to instantiate DBUtil.</p>\n",
    "tags" : [ "java", "mocking", "mockito" ],
    "owner" : {
      "account_id" : 29986732,
      "reputation" : 23,
      "user_id" : 22980440,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocJRT5o_vnd0NiNQGT8AEgcHuaKKCCxp7WRGAd3Od55zN5w=k-s256",
      "display_name" : "Greg Hazzard",
      "link" : "https://stackoverflow.com/users/22980440/greg-hazzard"
    },
    "is_answered" : true,
    "view_count" : 86,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1754503562,
    "creation_date" : 1754489365,
    "link" : "https://stackoverflow.com/questions/79727400/test-case-throwing-npe-when-calling-mocked-method",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79727688,
    "question_id" : 79727400,
    "body" : "<p>I may be reading this incorrectly, but you mock an instance of <code>DBTemplate</code>. However, the class you're injecting mocks in doesn't <em>contain</em> any <code>DBTemplate</code>, it <em>extends</em> <code>DBTemplate</code>. In other words, your mocked object never goes into the <code>AdultDayCenterDBHandler</code> instance.</p>\n<p>If you want to mock the <code>callDB</code> call of the <code>AdultDayCenterDBHandler</code> instance, you need to create a <em>spy</em>. You can then mock the method call. However, you can't use &quot;when(...).then(...)&quot; because that will already call the actual method. Use the following instead:</p>\n<pre class=\"lang-java prettyprint-override\"><code>Mockito.doReturn(facilityList).when(dbHandler).callDB(any(SearchQuery.class));\n</code></pre>\n<p>This way, the method call (<code>callDB</code>) is performed on an object representing the spied object, not the spied object itself.</p>\n",
    "score" : 2,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1211967,
      "reputation" : 9964,
      "user_id" : 1180351,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/pKB8y.png?s=256",
      "display_name" : "Rob Spoor",
      "link" : "https://stackoverflow.com/users/1180351/rob-spoor"
    },
    "creation_date" : 1754503562,
    "last_activity_date" : 1754503562,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140646530,
    "post_id" : 79727400,
    "body" : "Your <code>dbTemplate</code> object is never used by your production code. Your production class extends the <i>class</i> <code>DbTemplate</code>, but it does not collaborate with an <i>instance</i> of that class. It also looks like you are trying to mock the object which are actually want to test, which is a big smell. Maybe check <a href=\"https://stackoverflow.com/q/74027324/112968\">stackoverflow.com/q/74027324/112968</a> â€“ even though this specific case (creating a Mockito mock instance of a base class and then not using it is not explicitly covered).",
    "score" : 1,
    "owner" : {
      "account_id" : 39208,
      "reputation" : 269387,
      "user_id" : 112968,
      "user_type" : "registered",
      "accept_rate" : 68,
      "profile_image" : "https://i.sstatic.net/zHTaT.png?s=256",
      "display_name" : "knittl",
      "link" : "https://stackoverflow.com/users/112968/knittl"
    },
    "creation_date" : 1754490459,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140646525,
    "post_id" : 79727400,
    "body" : "Perhaps I&#39;m blind to it but I don&#39;t see where method retrieveAllAdultDayCenterFacilities has visibility on a Connection Object.  Unless it&#39;s embedded in the code for callDB(SearchQuery), that could be where the NPE is being thrown. Look at your stacktrace being thrown and there should be information there about where the NPE is being encountered.",
    "score" : 0,
    "owner" : {
      "account_id" : 13607242,
      "reputation" : 1,
      "user_id" : 9816020,
      "user_type" : "registered",
      "profile_image" : "https://lh6.googleusercontent.com/-1_ZOL65-SMg/AAAAAAAAAAI/AAAAAAAAEXg/oSZR8ZSubJA/s256-rj/photo.jpg",
      "display_name" : "Keith Higgs",
      "link" : "https://stackoverflow.com/users/9816020/keith-higgs"
    },
    "creation_date" : 1754490408,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79727688" : [ {
      "comment_id" : 140652135,
      "post_id" : 79727688,
      "body" : "That absolutely solved my problem.  I knew it as something I was doing wrong, I just don&#39;t have enough experience with Mockito yet to answer the question.",
      "score" : 0,
      "owner" : {
        "account_id" : 29986732,
        "reputation" : 23,
        "user_id" : 22980440,
        "user_type" : "registered",
        "profile_image" : "https://lh3.googleusercontent.com/a/ACg8ocJRT5o_vnd0NiNQGT8AEgcHuaKKCCxp7WRGAd3Od55zN5w=k-s256",
        "display_name" : "Greg Hazzard",
        "link" : "https://stackoverflow.com/users/22980440/greg-hazzard"
      },
      "creation_date" : 1754665190,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}