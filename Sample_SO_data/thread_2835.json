{
  "question" : {
    "question_id" : 79591264,
    "title" : "Apache HttpCore 5.3.3 SSLContext Configuration Issue: Server Timeout with NeedClientAuth",
    "body" : "<p>I am encountering an issue with HttpServer from Apache HttpCore after upgrading the library from version 5.2.3 to 5.3. When client authentication (setNeedClientAuth(true)) is enabled and the truststore is not configured, the server does not respond, and the client experiences a timeout.  This issue did not occur in version 5.2.3, where the server would handle the request differently. After the upgrade, the server seems to hang without providing any response.  <hr>\nSteps to Reproduce:\nEnable client authentication on the server using socket.setNeedClientAuth(true).\nDo not configure a truststore for the server.\nAttempt to connect to the server with a client.</p>\n<hr>\nExpected Behavior:\nThe server should respond with  PKIX exception when the truststore is not configured, even with client authentication enabled.  \n<p>org.springframework.web.client.ResourceAccessException: I/O error on POST request for &quot;https:localhost:56433/hello&quot;: PKIX path building failed: sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target.</p>\n<hr>\nActual Behavior:\nThe server does not respond, and the client times out.<hr>\nEnvironment:\n<ul>\n<li>Apache HttpCore Version: 5.3</li>\n<li>Java Version: OpenJDK 17</li>\n<li>Operating System: macOS Sonomo</li>\n</ul>\n<hr>\n<pre class=\"lang-java prettyprint-override\"><code>HttpServer server = ServerBootstrap.bootstrap()\n    .setSocketConfig(SocketConfig.custom()\n        .setSoTimeout(Timeout.ofSeconds(2))\n        .build())\n    .setListenerPort(8443)\n    .setSslContext(createSSLContext()) // SSLContext without truststore\n    .setSslSetupHandler(socket -&gt; socket.setNeedClientAuth(true))\n    .register(&quot;/hello&quot;, (request, response, context) -&gt; {\n        response.setCode(HttpStatus.SC_OK);\n        response.setEntity(new StringEntity(&quot;Hello&quot;, ContentType.TEXT_PLAIN));\n    })\n    .create();\n\nserver.start();\n</code></pre>\n<pre class=\"lang-java prettyprint-override\"><code>public static SSLContext createSSLContext() throws Exception {\n        // Load the keystore\n        KeyStore keyStore = KeyStore.getInstance(&quot;JKS&quot;);\n        keyStore.load(SSLUtil.class.getResourceAsStream(&quot;/keystore.jks&quot;), &quot;keystorePassword&quot;.toCharArray());\n\n        // Initialize KeyManagerFactory with the keystore\n        KeyManagerFactory keyManagerFactory = KeyManagerFactory.getInstance(KeyManagerFactory.getDefaultAlgorithm());\n        keyManagerFactory.init(keyStore, &quot;keyPassword&quot;.toCharArray());\n\n        // Initialize TrustManagerFactory without a truststore (missing truststore configuration)\n        TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(TrustManagerFactory.getDefaultAlgorithm());\n        trustManagerFactory.init((KeyStore) null); // No truststore provided\n\n        // Create and initialize the SSLContext\n        SSLContext sslContext = SSLContext.getInstance(&quot;TLS&quot;);\n        sslContext.init(keyManagerFactory.getKeyManagers(), trustManagerFactory.getTrustManagers(), null);\n\n        return sslContext;\n    }\n</code></pre>\n<p>Due to this issue, some of the unit test cases are started failing after upgrading the library.</p>\n<p>Is this a known issue with Apache HttpCore 5.3? If so, is there a workaround or configuration change required to handle this scenario? Or is there a change in behavior in version 5.3 that I need to account for?</p>\n",
    "tags" : [ "java", "httpserver", "apache-httpcomponents", "apache-http-server" ],
    "owner" : {
      "account_id" : 8265735,
      "reputation" : 51,
      "user_id" : 6215356,
      "user_type" : "registered",
      "profile_image" : "https://graph.facebook.com/964684900267146/picture?type=large",
      "display_name" : "Jagdish Raika",
      "link" : "https://stackoverflow.com/users/6215356/jagdish-raika"
    },
    "is_answered" : false,
    "view_count" : 35,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1745563591,
    "creation_date" : 1745519265,
    "link" : "https://stackoverflow.com/questions/79591264/apache-httpcore-5-3-3-sslcontext-configuration-issue-server-timeout-with-needcl",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140368211,
    "post_id" : 79591264,
    "body" : "This is likely a regression. Please raise an ticket with the project <a href=\"https://issues.apache.org/jira/browse/HTTPCORE\" rel=\"nofollow noreferrer\">issues.apache.org/jira/browse/HTTPCORE</a> and attach a reproducer to it.",
    "score" : 0,
    "owner" : {
      "account_id" : 133909,
      "reputation" : 27881,
      "user_id" : 335638,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/a0176e178f8f08da2ac4524454b4184e?s=256&d=identicon&r=PG",
      "display_name" : "ok2c",
      "link" : "https://stackoverflow.com/users/335638/ok2c"
    },
    "creation_date" : 1745568269,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}