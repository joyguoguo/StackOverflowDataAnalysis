{
  "question" : {
    "question_id" : 79825010,
    "title" : "Tiktok fetch an access token using an authorizaiton code problems in java spring boot",
    "body" : "<p>I am trying to exchange my authorizatoin code for an access token. I keep getting a &quot;request parameters are malformed&quot; error. I can curl the endpoint just fine but for some reason I can't get a valid response in the server.</p>\n<p>Here is the code I am using:</p>\n<pre><code> public TikTokTokenResponse getTiktokAccessToken(String code, String redirectUrl) throws Exception {\n    URI uri = new URI(String.format(&quot;https://open.tiktokapis.com/v2/oauth/token/&quot;));\n\n    MultiValueMap&lt;String, String&gt; body = new LinkedMultiValueMap&lt;&gt;();\n    body.add(&quot;client_key&quot;, tiktokClientKey);\n    body.add(&quot;client_secret&quot;, tiktokClientSecret);\n    body.add(&quot;code&quot;, code);\n    body.add(&quot;grant_type&quot;, &quot;authorization_code&quot;);\n    body.add(&quot;redirect_uri&quot;, redirectUrl);\n\n    HttpHeaders headers = new HttpHeaders();\n    headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n    headers.setCacheControl(&quot;no-cache&quot;);\n\n    HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity = new HttpEntity&lt;&gt;(body, headers);\n\n    log.info(&quot;Getting tiktok access token &quot; + uri.toString());\n    return restTemplate.postForObject(uri, requestEntity, TikTokTokenResponse.class);\n}\n</code></pre>\n",
    "tags" : [ "java", "spring-boot", "tiktok" ],
    "owner" : {
      "account_id" : 19465936,
      "reputation" : 176,
      "user_id" : 14239204,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-UW-OXRXQ310/AAAAAAAAAAI/AAAAAAAAAAA/AMZuuckIexs91XijoLaoec3MmfDA9wiUfA/s256-rj/photo.jpg",
      "display_name" : "Kristian Martinez",
      "link" : "https://stackoverflow.com/users/14239204/kristian-martinez"
    },
    "is_answered" : true,
    "view_count" : 57,
    "answer_count" : 1,
    "score" : -4,
    "last_activity_date" : 1763606580,
    "creation_date" : 1763597686,
    "link" : "https://stackoverflow.com/questions/79825010/tiktok-fetch-an-access-token-using-an-authorizaiton-code-problems-in-java-spring",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79825049,
    "question_id" : 79825010,
    "body" : "<p>After a lot of trial and error I figured out the problem. In comparing my postman and curl requests that were working I noticed that they weren't url encoding the code. And after reviewing the documentation for tiktok I noticed it said the code value should be URL decoded. So looking at my spring boot request above I realized by default it url encoded all the parameters. So I built the request body manually to avoid this and finally it worked! See code below:</p>\n<pre><code>public TikTokTokenResponse getTiktokAccessToken(String code, String redirectUrl) throws Exception {\n    URI uri = new URI(String.format(&quot;https://open.tiktokapis.com/v2/oauth/token/&quot;));\n\n    //Manually construct the body to prevent URL-encoding of the 'code' parameter\n    String body = &quot;client_key=&quot; + URLEncoder.encode(tiktokClientKey, StandardCharsets.UTF_8) +\n            &quot;&amp;client_secret=&quot; + URLEncoder.encode(tiktokClientSecret, StandardCharsets.UTF_8) +\n            &quot;&amp;grant_type=authorization_code&quot; +\n            &quot;&amp;redirect_uri=&quot; + URLEncoder.encode(redirectUrl, StandardCharsets.UTF_8) +\n            &quot;&amp;code=&quot; + code;\n\n    HttpHeaders headers = new HttpHeaders();\n    headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);\n    headers.setCacheControl(&quot;no-cache&quot;);\n\n    HttpEntity&lt;String&gt; requestEntity = new HttpEntity&lt;String&gt;(body, headers);\n\n    log.info(&quot;Getting tiktok access token &quot; + uri.toString());\n    return restTemplate.postForObject(uri, requestEntity, TikTokTokenResponse.class);\n}\n</code></pre>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 19465936,
      "reputation" : 176,
      "user_id" : 14239204,
      "user_type" : "registered",
      "profile_image" : "https://lh5.googleusercontent.com/-UW-OXRXQ310/AAAAAAAAAAI/AAAAAAAAAAA/AMZuuckIexs91XijoLaoec3MmfDA9wiUfA/s256-rj/photo.jpg",
      "display_name" : "Kristian Martinez",
      "link" : "https://stackoverflow.com/users/14239204/kristian-martinez"
    },
    "creation_date" : 1763606580,
    "last_activity_date" : 1763606580,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : { }
}