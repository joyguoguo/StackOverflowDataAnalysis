{
  "question" : {
    "question_id" : 79836804,
    "title" : "Hibernate: Invalid stream header &quot;[-0.&quot; when trying to deserialize pgvector embedding into JPA entity",
    "body" : "<p>I created a PGvector database:</p>\n<pre class=\"lang-sql prettyprint-override\"><code>CREATE TABLE IF NOT EXISTS vector_store (\n    id uuid DEFAULT uuid_generate_v4() PRIMARY KEY,\n    content text,\n    metadata jsonb,\n    embedding vector(1024),\n    created_at timestamptz DEFAULT now()\n);\n</code></pre>\n<p>and defined a JPA entity following <a href=\"https://docs.hibernate.org/orm/current/userguide/html_single/#vector-module\" rel=\"nofollow noreferrer\">Hibernate's documentation regarding vectors</a>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@Table(name = &quot;vector_store&quot;)\npublic class Document {\n    @Id\n    @Column(columnDefinition = &quot;uuid&quot;)\n    private UUID id;\n\n    @Column(columnDefinition = &quot;text&quot;)\n    private String content;\n\n    @JdbcTypeCode(SqlTypes.JSON)\n    @Column(columnDefinition = &quot;jsonb&quot;)\n    private LogMetadata metadata;\n\n    @JdbcTypeCode(SqlTypes.VECTOR)\n    @Column(columnDefinition = &quot;vector(1024)&quot;)\n    @Array(length = 1024)\n    private double[] embedding;\n\n    // getters and setters\n}\n</code></pre>\n<p>However, when trying to deserialize the embedding into a Document object,</p>\n<pre class=\"lang-java prettyprint-override\"><code>public List&lt;Document&gt; fetchAllDocuments() {\n    return documentRepository.findAll();\n}\n</code></pre>\n<p>I get the following error:</p>\n<pre><code>org.hibernate.type.SerializationException: could not deserialize\n...\njava.io.StreamCorruptedException: invalid stream header: 5B2D302E\n</code></pre>\n<p>Info: <code>5B2D302E</code> translates to <code>[-0.</code>, which is the first few characters of the embedding of an entry.</p>\n<p>I tried <code>SqlTypes.VECTOR_FLOAT64</code> as well, but without luck.</p>\n<p>Any idea what this could be?</p>\n",
    "tags" : [ "java", "spring", "hibernate", "jpa", "pgvector" ],
    "owner" : {
      "account_id" : 44226426,
      "reputation" : 21,
      "user_id" : 31642875,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/TwsbxWJj.png?s=256",
      "display_name" : "Iwan de Jong",
      "link" : "https://stackoverflow.com/users/31642875/iwan-de-jong"
    },
    "is_answered" : true,
    "view_count" : 48,
    "answer_count" : 1,
    "score" : 1,
    "last_activity_date" : 1764832132,
    "creation_date" : 1764760794,
    "link" : "https://stackoverflow.com/questions/79836804/hibernate-invalid-stream-header-0-when-trying-to-deserialize-pgvector-embe",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79837618,
    "question_id" : 79836804,
    "body" : "<p>Fixed it by using <code>float[]</code> type <a href=\"https://docs.hibernate.org/orm/current/userguide/html_single/#vector-module\" rel=\"nofollow noreferrer\">as per documentation</a> and making sure there is a getter and setter for the <code>float[]</code> type specifically.</p>\n<p>Previously I had a <code>float[]</code>-to-<code>double[]</code> getter and a <code>double[]</code>-to-<code>float[]</code> setter:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public double[] getEmbedding() {\n    double[] doubleEmbedding = new double[embedding.length];\n    for (int i = 0; i &lt; embedding.length; i++) {\n        doubleEmbedding[i] = embedding[i];\n    }\n    return doubleEmbedding;\n}\n\npublic void setEmbedding(double[] embedding) {\n    this.embedding = new float[embedding.length];\n    for (int i = 0; i &lt; embedding.length; i++) {\n        this.embedding[i] = (float) embedding[i];\n    }\n}\n</code></pre>\n<p>I kept those (because I'm using doubles in my app), but added:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public float[] getFloatEmbedding() {\n    return embedding;\n}\n\npublic void setFloatEmbedding(float[] embedding) {\n    this.embedding = embedding;\n}\n</code></pre>\n<p>Thanks for the help, John! (See comments)</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 44226426,
      "reputation" : 21,
      "user_id" : 31642875,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/TwsbxWJj.png?s=256",
      "display_name" : "Iwan de Jong",
      "link" : "https://stackoverflow.com/users/31642875/iwan-de-jong"
    },
    "creation_date" : 1764832132,
    "last_activity_date" : 1764832132,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140886719,
    "post_id" : 79836804,
    "body" : "@JohnBollinger I tried it before, but used a <code>float[]</code>-to-<code>double[]</code> getter and a <code>double[]</code>-to-<code>float[]</code> setter myself instead of a normal getter and setter. Fixed it by adding a normal <code>float[]</code> getter and setter. Thanks for the help.",
    "score" : 1,
    "owner" : {
      "account_id" : 44226426,
      "reputation" : 21,
      "user_id" : 31642875,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/TwsbxWJj.png?s=256",
      "display_name" : "Iwan de Jong",
      "link" : "https://stackoverflow.com/users/31642875/iwan-de-jong"
    },
    "creation_date" : 1764831873,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140885730,
    "post_id" : 79836804,
    "body" : "The Hibernate docs suggest that the Java data type associated with <code>SqlTypes.VECTOR</code> ought to be <code>float[]</code>, whereas you&#39;re using <code>double[]</code>.  Does changing to <code>float[]</code> make a difference?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1764779358,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140885631,
    "post_id" : 79836804,
    "body" : "@JohnBollinger I am trying to fetch entries from the vector store. The DB was populated using <a href=\"https://docs.spring.io/spring-ai/reference/api/vectordbs/pgvector.html#_auto_configuration\" rel=\"nofollow noreferrer\">vectorStore.add</a>.   Importantly, they&#39;re not the same classes (I defined my own <code>Document</code> class), since Spring AI doesn&#39;t have the flexibility I need to work with metadata and embeddings. I use Spring AI to create the entry with embeddings and use my own <code>Document</code> class for read and update queries.  I updated the original question with an example that fails.",
    "score" : 0,
    "owner" : {
      "account_id" : 44226426,
      "reputation" : 21,
      "user_id" : 31642875,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/TwsbxWJj.png?s=256",
      "display_name" : "Iwan de Jong",
      "link" : "https://stackoverflow.com/users/31642875/iwan-de-jong"
    },
    "creation_date" : 1764776129,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140885388,
    "post_id" : 79836804,
    "body" : "Are you trying to read back entities you previously stored using JPA and these same entity classes?  Else, how was the DB populated?",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1764769156,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140885379,
    "post_id" : 79836804,
    "body" : "I&#39;m not following what you mean by &quot;deserialize the embedding into a Document object&quot;.  How is a <code>Document</code> relevant here?  Code representative of how you obtain the exception would help.  Specifically, a <a href=\"https://stackoverflow.com/help/minimal-reproducible-example\">minimal reproducible example</a>, or as close as you can come to one.",
    "score" : 0,
    "owner" : {
      "account_id" : 2792262,
      "reputation" : 190832,
      "user_id" : 2402272,
      "user_type" : "registered",
      "accept_rate" : 85,
      "profile_image" : "https://www.gravatar.com/avatar/1182b1d5518a596d4e8cfe0567a65c4d?s=256&d=identicon&r=PG",
      "display_name" : "John Bollinger",
      "link" : "https://stackoverflow.com/users/2402272/john-bollinger"
    },
    "creation_date" : 1764768824,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}