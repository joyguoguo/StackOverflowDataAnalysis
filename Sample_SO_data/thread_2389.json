{
  "question" : {
    "question_id" : 79623597,
    "title" : "How to test NONSTRICT_READ_WRITE L2 puts/hits in Hibernate?",
    "body" : "<p>I have <code>@SpringBootTest</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>    @Test\n    void testSecondLevelCachePutAndHit() {\n        Session session = sessionFactory.openSession();\n        Transaction tx = session.beginTransaction();\n\n        UUID materialId = UUID.randomUUID();\n        Material material = Material.builder()\n                .id(materialId)\n                .code(123L)\n                .build();\n        session.persist(material);\n\n        Cargo cargo = Cargobuilder()\n                .cargoCode(Long.MAX_VALUE)\n                .materialId(materialId)\n                .build();\n        session.persist(cargo);\n\n        cargoId = cargo.getId();\n        tx.commit();\n        session.close();\n\n        assertThat(stats.getSecondLevelCacheRegionNames()).contains(\n                Cargo.class.getName(), Material.class.getName()\n        );\n        assertThat(stats.getSecondLevelCachePutCount()).isEqualTo(2L);\n\n        stats.clear();\n\n        session = sessionFactory.openSession();\n        tx = session.beginTransaction();\n        Cargo cargoLoaded = session.get(Cargo.class, cargoId);\n        assertDoesNotThrow(cargoLoaded::getCargoCode, &quot;Cargo was not loaded&quot;);\n        Material materialLoaded = session.get(Material.class, materialId);\n        assertDoesNotThrow(materialLoaded::getCode, &quot;Material was not loaded&quot;);\n        tx.commit();\n        session.close();\n\n        assertThat(stats.getSecondLevelCacheHitCount()).isEqualTo(2L);\n    }\n</code></pre>\n<p>For entities:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Entity\n@Cacheable\n@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)\npublic class Cargo {\n    @Id\n    @GeneratedValue(generator = &quot;UUID&quot;)\n    @GenericGenerator(name = &quot;UUID&quot;, strategy = &quot;org.hibernate.id.UUIDGenerator&quot;)\n    @Column(name = &quot;id&quot;, updatable = false, nullable = false)\n    private UUID id;\n\n    @Column(name = &quot;code&quot;, nullable = false)\n    private Long cargoCode;\n\n    @Column(name = &quot;material_id&quot;)\n    private UUID materialId;\n\n    @ManyToOne(fetch = FetchType.LAZY)\n    @JoinColumn(name = &quot;material_id&quot;, updatable = false, insertable = false)\n    private Material material;\n}\n\n@Entity\n@Cacheable\n@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)\npublic class Material {\n    @Id\n    @Column(name = &quot;id&quot;)\n    private UUID id;\n\n    @Column(name = &quot;code&quot;)\n    private Long code;\n}\n</code></pre>\n<p>For <code>READ_WRITE</code> caching strategy test works, but for <code>NONSTRICT_READ_WRITE</code> it has 0 second level cache puts/hits.</p>\n<p>I've tried adding <code>Thread.sleep</code> and <code>regionFactory.nextTimestamp</code> but it did not seem to work either. Can someone explain to me, please, how to test this?</p>\n<p>Is my configuration even correct? Would it work in Spring Data JPA repository findById scenarios?</p>\n",
    "tags" : [ "java", "hibernate", "jpa", "caching" ],
    "owner" : {
      "account_id" : 23926635,
      "reputation" : 67,
      "user_id" : 17921672,
      "user_type" : "registered",
      "profile_image" : "https://lh3.googleusercontent.com/a/AATXAJz_oDM_-1WGAGNBq4WOGt7NZqrvocPEi6vELy-C=k-s256",
      "display_name" : "Damir Yablonskikh",
      "link" : "https://stackoverflow.com/users/17921672/damir-yablonskikh"
    },
    "is_answered" : false,
    "view_count" : 21,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1747320279,
    "creation_date" : 1747319645,
    "link" : "https://stackoverflow.com/questions/79623597/how-to-test-nonstrict-read-write-l2-puts-hits-in-hibernate",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ ],
  "answer_comments" : { }
}