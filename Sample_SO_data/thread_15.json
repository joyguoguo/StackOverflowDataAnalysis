{
  "question" : {
    "question_id" : 79842774,
    "title" : "The purpose of an if statement condition, it is java21-ConcurrentHashMap-transfer method code:2463Line",
    "body" : "<p>I am using Java 21.<br />\nThe following code is from the source code of class <code>java.util.concurrent.ConcurrentHashMap</code>.</p>\n<pre class=\"lang-java prettyprint-override\"><code>// Method: transfer , line: 2463\nif (i &lt; 0 || i &gt;= n || i + n &gt;= nextn) {\n    int sc;\n    if (finishing) {\n        nextTable = null;\n        table = nextTab;\n        sizeCtl = (n &lt;&lt; 1) - (n &gt;&gt;&gt; 1);\n        return;\n    }\n    if (U.compareAndSetInt(this, SIZECTL, sc = sizeCtl, sc - 1)) {\n        if ((sc - 2) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)\n            return;\n        finishing = advance = true;\n        i = n; // recheck before commit\n    }\n}\n</code></pre>\n<ul>\n<li>Condition 1: <code>i &lt; 0</code>, I can understand it.</li>\n<li>Condition 2: <code>i &gt;= n</code>, I can't think of a special case; it feels like it can't happen.</li>\n<li>Condition 3: <code>i + n &gt;= nextn</code>, is the same.</li>\n</ul>\n<p>Are conditions 2 and 3 for defensive programming?</p>\n",
    "tags" : [ "java", "java.util.concurrent", "concurrenthashmap", "java-21" ],
    "owner" : {
      "account_id" : 14761714,
      "reputation" : 25,
      "user_id" : 10660856,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/lqjCz.png?s=256",
      "display_name" : "杨尚山",
      "link" : "https://stackoverflow.com/users/10660856/%e6%9d%a8%e5%b0%9a%e5%b1%b1"
    },
    "is_answered" : true,
    "view_count" : 88,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1765440025,
    "creation_date" : 1765360113,
    "link" : "https://stackoverflow.com/questions/79842774/the-purpose-of-an-if-statement-condition-it-is-java21-concurrenthashmap-transfe",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79842885,
    "question_id" : 79842774,
    "body" : "<p>I understand that you expect answers for Condition 2 and Condition 3.</p>\n<p>You could say this is used for defensive programming, as this &quot;if&quot; statement seems to be to prevent out-of-bounds access during the table transfer. It is acting like a guard.</p>\n<p>This if statement runs inside the for-loop of line <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2502\" rel=\"nofollow noreferrer\">2471</a>, so it can be evaluated multiple times.</p>\n<p><strong>Condition 2:</strong></p>\n<pre><code>i &gt;= n\n</code></pre>\n<p>Ensures that <code>i</code> is less than the length of the current table, <code>n</code>.</p>\n<p>It can be true, see for instance in line <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2502C21-L2502C26\" rel=\"nofollow noreferrer\">2502</a></p>\n<pre><code>                    i = n; // recheck before commit\n</code></pre>\n<p><strong>Condition 3:</strong></p>\n<pre><code>i + n &gt;= nextn\n</code></pre>\n<p>Ensures that <code>i + n</code> does not exceed the length of the next (resized) table, <code>nextn</code>.</p>\n<p>Again for instance if  nextn==n the assignment in line <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2502C21-L2502C26\" rel=\"nofollow noreferrer\">2502</a></p>\n<pre><code>                    i = n; // recheck before commit\n</code></pre>\n<p>Will make it true. In normal operation <code>nextn == nextTab.length == 2*n</code>, so <code>i + n &gt;= nextn</code> is equivalent to <code>i &gt;= n</code>. The separate check is defensive as it prevents attempts to set <code>nextTab[i + n]</code> when <code>nextTab.length</code> length is not <code>2*n</code> (or if <code>nextTab</code> changed).</p>\n<p>For the above answers I used this <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2490\" rel=\"nofollow noreferrer\">occurrence </a>of the code mentioned by the comment of user <a href=\"https://stackoverflow.com/users/6395627/slaw\">slaw </a>above.<br />\nThat is found in line <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2490\" rel=\"nofollow noreferrer\">2490 </a>of <code>ConcurrentHashMap</code> that is on the .</p>\n<p>In practice, with standard doubling of the table, both checks become true at the same time (when <code>i==n</code> ), which triggers the finishing/commit path. The <code>i + n</code> check is an extra safety guard against an out-of-range write to nextTab.</p>\n<p>Update: The above holds true for <a href=\"https://github.com/openjdk/jdk21/tree/master\" rel=\"nofollow noreferrer\">JDK21 </a>branch of <a href=\"https://github.com/openjdk\" rel=\"nofollow noreferrer\">OpenJDK </a>where the line number is <a href=\"https://github.com/openjdk/jdk21/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2463\" rel=\"nofollow noreferrer\">2463</a> as specified in the question. The code of the method is identical. The initial comments where based on the current state of the main branch of <a href=\"https://github.com/openjdk\" rel=\"nofollow noreferrer\">OpenJDK</a>.</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 7091735,
      "reputation" : 2625,
      "user_id" : 5426703,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/Qj80u.jpg?s=256",
      "display_name" : "Spyros K",
      "link" : "https://stackoverflow.com/users/5426703/spyros-k"
    },
    "creation_date" : 1765366643,
    "last_activity_date" : 1765439954,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140896069,
    "post_id" : 79842774,
    "body" : "@Abra No. I linked to master. Here&#39;s the link to tag jdk-21+35: <a href=\"https://github.com/openjdk/jdk/blob/890adb6410dab4606a4f26a942aed02fb2f55387/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2463\" rel=\"nofollow noreferrer\">github.com/openjdk/jdk/blob/&hellip;</a> (the if statement <i>is</i> 2463 in that version).",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1765368130,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140895937,
    "post_id" : 79842774,
    "body" : "For reference: <a href=\"https://github.com/openjdk/jdk/blob/8eaeb6990b85ac8717f4fc4ce883f674017b91f3/src/java.base/share/classes/java/util/concurrent/ConcurrentHashMap.java#L2490\" rel=\"nofollow noreferrer\">ConcurrentHashMap.java:2490</a>. Current code (as of this comment) has that if statement on line 2490, not 2463.",
    "score" : 1,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1765363504,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140895904,
    "post_id" : 79842774,
    "body" : "Can you add reference to whole source file? It difficult to say what is happened by just that little snippet.",
    "score" : 1,
    "owner" : {
      "account_id" : 4497436,
      "reputation" : 20796,
      "user_id" : 3656904,
      "user_type" : "registered",
      "accept_rate" : 67,
      "profile_image" : "https://www.gravatar.com/avatar/8bdbd1f89f8907e8e8b15ab88c084c65?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "talex",
      "link" : "https://stackoverflow.com/users/3656904/talex"
    },
    "creation_date" : 1765362069,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}