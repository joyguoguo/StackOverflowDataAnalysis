{
  "question" : {
    "question_id" : 79672672,
    "title" : "JavaFX Concurrency: Objects &quot;changing&quot; type",
    "body" : "<p>I'm creating an implementation of Minesweeper using JavaFX. Here, I have some code that runs in another thread and updates the GUI with the state of the game. It loops thru all the cells on the board and draws the correct thing on the screen.</p>\n<pre><code>for (int x = 0; x &lt; boardWidth(); x++) {\n    for (int y = 0; y &lt; boardHeight(); y++) {\n        int finalY = y;\n        int finalX = x;\n        if (isCleared(finalX, finalY)) {\n            Platform.runLater(() -&gt; drawEmptySquare(finalX, finalY));\n            if (getCell(finalX, finalY) instanceof Mine) {\n                Platform.runLater(() -&gt; drawMine(finalX, finalY));\n            } else if (getCell(finalX, finalY) instanceof NumberCell) {\n                Platform.runLater(() -&gt; drawNumber(finalX, finalY, ((NumberCell) getCell(finalX, finalY)).getNumMines()));\n            }\n        } else if (isFlagged(finalX, finalY)) {\n            Platform.runLater(() -&gt; drawFlag(finalX, finalY));\n        } else {\n            Platform.runLater(() -&gt; drawFullSquare(finalX, finalY));\n        } // end if\n    } // end inner for\n} // end outer for\n</code></pre>\n<p>For most of the time that the app is running, there are no problems. However, when I start a new game, an error message is printed to the console:</p>\n<pre><code>Exception in thread &quot;JavaFX Application Thread&quot; java.lang.ClassCastException: class EmptyCell cannot be cast to class NumberCell (EmptyCell and NumberCell are in unnamed module of loader 'app')\n</code></pre>\n<p>This should be impossible, right? I do have an <code>instanceof</code> check right before the casting happens, which should prevent this specific exception.</p>\n<p>Clearly, something is happening in my code that is allowing an <code>EmptyCell</code> to be used where only a <code>NumberCell</code> should be. I think that the root of my problem lies in the fact that this code is running on a second thread, but I don't know exactly why that is causing <code>EmptyCell</code>s to be used right after we checked that it was a <code>NumberCell</code>.</p>\n<p>How is this exception happening, and what is the proper way to do this that avoids the exception?</p>\n",
    "tags" : [ "java", "multithreading", "javafx", "concurrency", "casting" ],
    "owner" : {
      "account_id" : 18463907,
      "reputation" : 185,
      "user_id" : 13468313,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/26fc95693e4b2b6e916c27eeab95a2ed?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Foxler2010",
      "link" : "https://stackoverflow.com/users/13468313/foxler2010"
    },
    "is_answered" : false,
    "view_count" : 98,
    "answer_count" : 0,
    "score" : 0,
    "last_activity_date" : 1750369631,
    "creation_date" : 1750369631,
    "link" : "https://stackoverflow.com/questions/79672672/javafx-concurrency-objects-changing-type",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ ],
  "question_comments" : [ {
    "comment_id" : 140550328,
    "post_id" : 79672672,
    "body" : "I didn&#39;t know &quot;chording&quot; was a thing in Minesweeper. From what I&#39;ve just read about that feature, it involves clicking the primary and secondary mouse buttons simultaneously over a single numbered cell. You should be able to do that with a pair of mouse-pressed and mouse-released handles, keeping some state to track if the two buttons are pressed without either having been released. I&#39;m not sure where the &quot;mouse moving over multiple nodes while held down&quot; comes into play with that. And I&#39;m not saying you should redo your implementation again. Just offering some thoughts.",
    "score" : 0,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1751156542,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140549965,
    "post_id" : 79672672,
    "body" : "@Foxler2010, I&#39;ve only ever dabbled in GUI design, and it&#39;s been some years. Last time I ever wrote anything like, everybody was hyping the <a href=\"https://en.wikipedia.org/wiki/Model%E2%80%93view%E2%80%93controller\" rel=\"nofollow noreferrer\"><i>model-view-controller</i> (MVC)</a> approach. I don&#39;t know what counts as &quot;best practice&quot; these days.",
    "score" : 0,
    "owner" : {
      "account_id" : 422870,
      "reputation" : 27582,
      "user_id" : 801894,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/67f2ccd17aa6fd622152ad88fc2ae784?s=256&d=identicon&r=PG",
      "display_name" : "Solomon Slow",
      "link" : "https://stackoverflow.com/users/801894/solomon-slow"
    },
    "creation_date" : 1751138668,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140549885,
    "post_id" : 79672672,
    "body" : "@SolomonSlow currently the drawing methods are in the Controller kept separate from the business logic. If I were to change it so that <code>draw()</code> is a virtual method of the object being drawn, I would still want to keep my GUI-related stuff in the Controller. What would be the best way to go about doing that?",
    "score" : 0,
    "owner" : {
      "account_id" : 18463907,
      "reputation" : 185,
      "user_id" : 13468313,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/26fc95693e4b2b6e916c27eeab95a2ed?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Foxler2010",
      "link" : "https://stackoverflow.com/users/13468313/foxler2010"
    },
    "creation_date" : 1751134903,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140549873,
    "post_id" : 79672672,
    "body" : "I used to use nodes and react to events when I was making the initial prototype, but when it came time to implement chording, JavaFX&#39;s events didn&#39;t really fit with what I needed with the mouse moving over multiple nodes while held down. I redid everything using a Canvas and some intermediary interfaces, which also allowed me to style it any which way without dealing with CSS.",
    "score" : 0,
    "owner" : {
      "account_id" : 18463907,
      "reputation" : 185,
      "user_id" : 13468313,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/26fc95693e4b2b6e916c27eeab95a2ed?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Foxler2010",
      "link" : "https://stackoverflow.com/users/13468313/foxler2010"
    },
    "creation_date" : 1751134612,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529572,
    "post_id" : 79672672,
    "body" : "In addition to Solomon&#39;s suggestion, I recommend you use the <code>javafx.animation</code> API for the game loop instead of <code>ScheduledService</code>. That way you don&#39;t have to worry about threading issues. Of course, for something like Minesweeper you don&#39;t really need a true game loop if you use nodes (instead of, e.g., <code>Canvas</code>) and just react to events.",
    "score" : 5,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1750424439,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529550,
    "post_id" : 79672672,
    "body" : "My guess is you have a race condition. You call <code>getCell</code> to check the type of the cell in a background thread and then afterwards call <code>getCell</code> <i>again</i> in a <code>runLater</code> call to use the cell in the FX thread. Nothing you provided shows the cell is guaranteed to be the same type between those two calls. Resetting the game may change the cell type before the <code>runLater</code> action executes.",
    "score" : 4,
    "owner" : {
      "account_id" : 8532578,
      "reputation" : 49884,
      "user_id" : 6395627,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/af0f9bfe593f36642a032cd7ea611e7d?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Slaw",
      "link" : "https://stackoverflow.com/users/6395627/slaw"
    },
    "creation_date" : 1750423983,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140529428,
    "post_id" : 79672672,
    "body" : "Have you considered trying an object oriented approach? Instead of having the top-level loop examine each object and decide which method to call to draw it, why not declare a virtual <code>draw</code> method,* let the top level loop <i>unconditionally</i> <code>draw()</code> each object, and let each different class of object implement <code>draw</code> in its own, appropriate way? &#91;*Ha ha! I know, <i>Technically,</i> all Java method calls are virtual method calls, but I&#39;m asking, why not exploit the fact?]",
    "score" : 6,
    "owner" : {
      "account_id" : 422870,
      "reputation" : 27582,
      "user_id" : 801894,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/67f2ccd17aa6fd622152ad88fc2ae784?s=256&d=identicon&r=PG",
      "display_name" : "Solomon Slow",
      "link" : "https://stackoverflow.com/users/801894/solomon-slow"
    },
    "creation_date" : 1750421327,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528821,
    "post_id" : 79672672,
    "body" : "You didn&#39;t post a <a href=\"https://stackoverflow.com/questions/3988788/what-is-a-stack-trace-and-how-can-i-use-it-to-debug-my-application-errors\">stack trace</a>, so I&#39;m guessing that since the code in your question is running in a separate thread that is not the <a href=\"https://docs.oracle.com/javase/8/javafx/interoperability-tutorial/concurrency.htm\" rel=\"nofollow noreferrer\">JavaFX application thread</a>, the <code>if</code> condition is true but the thread is suspended before the <code>if</code> body is executed and when the thread resumes, the value returned by <code>getCell(finalX, finalY)</code> is no longer <code>NumberCell</code>.",
    "score" : 0,
    "owner" : {
      "account_id" : 2485939,
      "reputation" : 20969,
      "user_id" : 2164365,
      "user_type" : "registered",
      "accept_rate" : 40,
      "profile_image" : "https://i.sstatic.net/RKSgV.png?s=256",
      "display_name" : "Abra",
      "link" : "https://stackoverflow.com/users/2164365/abra"
    },
    "creation_date" : 1750406379,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528299,
    "post_id" : 79672672,
    "body" : "after <b>if ( isCleared( finalX, finalY )) {</b>, it is not missing a <b>if( getCell( finalX, finalY ) instanceof EmptyCell ) {</b>?.",
    "score" : 0,
    "owner" : {
      "account_id" : 10843443,
      "reputation" : 916,
      "user_id" : 20882864,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CCQCy.jpg?s=256",
      "display_name" : "Marce Puente",
      "link" : "https://stackoverflow.com/users/20882864/marce-puente"
    },
    "creation_date" : 1750381398,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528121,
    "post_id" : 79672672,
    "body" : "They don&#39;t, on purpose. I use a <code>ScheduledService</code> to run the code over and over to update the screen. As I am playing, the state of the game changes and the code handles it fine. I don&#39;t know why it throws the exception specifically when the game resets itself.",
    "score" : 0,
    "owner" : {
      "account_id" : 18463907,
      "reputation" : 185,
      "user_id" : 13468313,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/26fc95693e4b2b6e916c27eeab95a2ed?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Foxler2010",
      "link" : "https://stackoverflow.com/users/13468313/foxler2010"
    },
    "creation_date" : 1750372411,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140528069,
    "post_id" : 79672672,
    "body" : "Hello Foxler2010, Maybe I&#39;m wrong, but I think that some of your threads don&#39;t end with the game.",
    "score" : 0,
    "owner" : {
      "account_id" : 10843443,
      "reputation" : 916,
      "user_id" : 20882864,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/CCQCy.jpg?s=256",
      "display_name" : "Marce Puente",
      "link" : "https://stackoverflow.com/users/20882864/marce-puente"
    },
    "creation_date" : 1750370563,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : { }
}