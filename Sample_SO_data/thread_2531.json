{
  "question" : {
    "question_id" : 79614421,
    "title" : "Gson custom serializer for PublicKey is never called",
    "body" : "<p>Here is the serializer for <code>java.security.PublicKey</code>:</p>\n<pre class=\"lang-java prettyprint-override\"><code>public class PublicKeySerializer implements JsonSerializer&lt;PublicKey&gt; {\n    @Override\n    public JsonElement serialize(PublicKey key, Type type, JsonSerializationContext context) {\n        System.out.println(&quot;Serialize Public Key&quot;);\n        JsonObject result = new JsonObject();\n\n        // Processing here...\n\n        return result\n    }\n}\n</code></pre>\n<p>Then, I register and use it like this:</p>\n<pre class=\"lang-java prettyprint-override\"><code>@Component\npublic class JsonSerializer {\n    private Gson gson;\n\n    @PostConstruct\n    public void init() {\n        this.gson = new GsonBuilder()\n                .registerTypeAdapter(PublicKey.class, new PublicKeySerializer())\n                .create();\n    }\n\n    public Gson getGson() {\n        return gson;\n    }\n}\n</code></pre>\n<p>And it is used in another component:</p>\n<pre class=\"lang-java prettyprint-override\"><code>JsonElement json = this.jsonSerializer.getGson().toJsonTree(publicKey)\n</code></pre>\n<p>The problem is the custom serializer is never called. Therefore, I got this exception:</p>\n<pre><code>om.google.gson.JsonIOException: Failed making field 'sun.security.rsa.RSAPublicKeyImpl#n' accessible; either increase its visibility or write a custom TypeAdapter for its declaring type.\nSee https://github.com/google/gson/blob/main/Troubleshooting.md#reflection-inaccessible\n    at com.google.gson.internal.reflect.ReflectionHelper.makeAccessible(ReflectionHelper.java:76) ~[gson-2.13.1.jar:na]\n    at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory.getBoundFields(ReflectiveTypeAdapterFactory.java:391) ~[gson-2.13.1.jar:na]\n    at com.google.gson.internal.bind.ReflectiveTypeAdapterFactory.create(ReflectiveTypeAdapterFactory.java:165) ~[gson-2.13.1.jar:na]\n    at com.google.gson.Gson.getAdapter(Gson.java:628) ~[gson-2.13.1.jar:na]\n    at com.google.gson.Gson.toJson(Gson.java:928) ~[gson-2.13.1.jar:na]\n    at com.google.gson.Gson.toJsonTree(Gson.java:802) ~[gson-2.13.1.jar:na]\n    at com.google.gson.Gson.toJsonTree(Gson.java:779) ~[gson-2.13.1.jar:na]\n</code></pre>\n<p>When I switch to Jackson with the same setup, it works fine. However, due to another constraint, I have to stick with Gson.</p>\n<p>The code use Spring Boot without the web server, just for dependency injection and other benefits.</p>\n",
    "tags" : [ "java", "json", "serialization", "gson" ],
    "owner" : {
      "account_id" : 2030610,
      "reputation" : 12183,
      "user_id" : 1814420,
      "user_type" : "registered",
      "accept_rate" : 59,
      "profile_image" : "https://www.gravatar.com/avatar/f42333f84c7e40dc9335028d6ccb13ca?s=256&d=identicon&r=PG",
      "display_name" : "Triet Doan",
      "link" : "https://stackoverflow.com/users/1814420/triet-doan"
    },
    "is_answered" : true,
    "view_count" : 53,
    "closed_date" : 1746810603,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1746805190,
    "creation_date" : 1746803675,
    "link" : "https://stackoverflow.com/questions/79614421/gson-custom-serializer-for-publickey-is-never-called",
    "closed_reason" : "Duplicate"
  },
  "answers" : [ {
    "answer_id" : 79614455,
    "question_id" : 79614421,
    "body" : "<p><code>PublicKey</code> is just an interface:</p>\n<pre><code>package java.security;\n\npublic interface PublicKey extends Key {\n    // Declare serialVersionUID to be compatible with JDK1.1\n    /**\n     * The class fingerprint that is set to indicate serialization\n     * compatibility with a previous version of the class.\n     *\n     * @deprecated A {@code serialVersionUID} field in an interface is\n     * ineffectual. Do not use; no replacement.\n     */\n    @Deprecated\n    @SuppressWarnings(&quot;serial&quot;)\n    @java.io.Serial\n    long serialVersionUID = 7187392471159151072L;\n}\n\n</code></pre>\n<p>The code doesn't show how the <code>PublicKey</code> instance is created, but from context we can assume it's passed in externally:</p>\n<pre><code>JsonElement json = this.jsonSerializer.getGson().toJsonTree(publicKey);\n</code></pre>\n<p>Here's the catch: Gson picks the serializer based on the actual runtime type of the object - not the declared interface type.</p>\n<p>So even if you registered a serializer for <code>PublicKey.class</code>, it won't be used if the actual object is something like:</p>\n<pre><code>RSAPublicKeyImpl implements PublicKey\n</code></pre>\n<p>To make Gson use your <code>PublicKey</code> serializer, you need to explicitly tell it what type to serialize as:</p>\n<pre><code>gson.toJsonTree(publicKey, PublicKey.class);\n</code></pre>\n<p>Now Gson looks at <code>PublicKey</code>, not the real class (<code>RSAPublicKeyImpl</code>), and uses your custom serializer.</p>\n<p>(You can try the same behavior with a simple example using <code>List</code> and <code>ArrayList</code>).</p>\n",
    "score" : 1,
    "is_accepted" : false,
    "owner" : {
      "account_id" : 38931631,
      "reputation" : 671,
      "user_id" : 29023248,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/WxoZEuKw.png?s=256",
      "display_name" : "Aleksey Bykov",
      "link" : "https://stackoverflow.com/users/29023248/aleksey-bykov"
    },
    "creation_date" : 1746805190,
    "last_activity_date" : 1746805190,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ ],
  "answer_comments" : {
    "79614455" : [ {
      "comment_id" : 140630736,
      "post_id" : 79614455,
      "body" : "@Marcono1234 Excellent point, thank you.",
      "score" : 0,
      "owner" : {
        "account_id" : 38931631,
        "reputation" : 671,
        "user_id" : 29023248,
        "user_type" : "registered",
        "profile_image" : "https://i.sstatic.net/WxoZEuKw.png?s=256",
        "display_name" : "Aleksey Bykov",
        "link" : "https://stackoverflow.com/users/29023248/aleksey-bykov"
      },
      "creation_date" : 1753898818,
      "content_license" : "CC BY-SA 4.0"
    }, {
      "comment_id" : 140534934,
      "post_id" : 79614455,
      "body" : "Or alternatively use <a href=\"https://javadoc.io/doc/com.google.code.gson/gson/latest/com.google.gson/com/google/gson/GsonBuilder.html#registerTypeHierarchyAdapter(java.lang.Class,java.lang.Object)\" rel=\"nofollow noreferrer\"><code>GsonBuilder#registerTypeHierarchyAdapter</code></a>, so that the adapter also handles subtypes.",
      "score" : 1,
      "owner" : {
        "account_id" : 5384013,
        "reputation" : 7199,
        "user_id" : 4288506,
        "user_type" : "registered",
        "accept_rate" : 77,
        "profile_image" : "https://www.gravatar.com/avatar/e4dd357b6d026a2f4a9fa090ff2a414c?s=256&d=identicon&r=PG&f=y&so-version=2",
        "display_name" : "Marcono1234",
        "link" : "https://stackoverflow.com/users/4288506/marcono1234"
      },
      "creation_date" : 1750678614,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}