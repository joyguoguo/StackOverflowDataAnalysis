{
  "question" : {
    "question_id" : 79686911,
    "title" : "Converting XML Signature to PKCS#7 and embedding into PDF results in &quot;Signature is invalid&quot; error in Adobe Reader",
    "body" : "<p>I'm working on digitally signing a PDF using an external signature service. The signing flow is as follows:</p>\n<ol>\n<li><p>I add a SignatureField to the existing PDF to generate a valid /ByteRange, and produce a placeholder PDF.</p>\n</li>\n<li><p>I calculate the SHA-256 hash of the byte ranges (i.e., the portions of the PDF that are actually signed).</p>\n</li>\n<li><p>I send this hash to a remote signature provider.</p>\n</li>\n<li><p>The provider returns an XML Signature response containing:</p>\n</li>\n</ol>\n<p>: a base64-encoded PKCS#1 signature</p>\n<p>: a base64-encoded signing certificate</p>\n<ol start=\"5\">\n<li><p>I use these values to construct a PKCS#7 (CMS SignedData) object using BouncyCastle in Java.</p>\n</li>\n<li><p>I embed the generated PKCS#7 into the /Contents field of the original PDF.</p>\n</li>\n</ol>\n<p>However, when I open the resulting PDF in Adobe Reader, I get the error:\n&quot;Signature is invalid&quot;, even though Adobe correctly recognizes and displays the certificate details.</p>\n<p><strong>My Goal:</strong>\nTo convert the XML Signature (PKCS#1 signature + certificate) into a valid PKCS#7 signature, embed it into the PDF, and have Adobe Reader validate it as a proper digital signature.</p>\n<p>Is there anything wrong with converting an XML Signature to a PKCS#7 structure like this?</p>\n<p>Even though I correctly place the digest into messageDigest, could Adobe Reader reject the signature due to subtle ASN.1 or attribute encoding issues?</p>\n<p>I'm not sure which part of my code would be most helpful to share. If you have suggestions on where to focus, I’d be happy to include code snippets.</p>\n",
    "tags" : [ "java", "pdf", "itext", "pkcs#7" ],
    "owner" : {
      "account_id" : 23806549,
      "reputation" : 3,
      "user_id" : 17815996,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5434b4c56506afbb65c6b7c9ffae636a?s=256&d=identicon&r=PG",
      "display_name" : "ahmet",
      "link" : "https://stackoverflow.com/users/17815996/ahmet"
    },
    "is_answered" : true,
    "view_count" : 95,
    "answer_count" : 1,
    "score" : 0,
    "last_activity_date" : 1751470285,
    "creation_date" : 1751437640,
    "link" : "https://stackoverflow.com/questions/79686911/converting-xml-signature-to-pkcs7-and-embedding-into-pdf-results-in-signature",
    "content_license" : "CC BY-SA 4.0"
  },
  "answers" : [ {
    "answer_id" : 79687701,
    "question_id" : 79686911,
    "body" : "<p>First of all, you request a signature value directly for the document byte ranges hash. This implies that you don't want to use signed attributes in your PKCS#7 signature container.</p>\n<p>On the other hand, in your answer with extra information you mentioned that your PKCS#7 signature container actually should be a CAdES signature container. But CAdES signature containers do require the use of signed attributes.</p>\n<p>Thus, your current approach has to be changed to take that into account and support generating signed attributes.</p>\n<p>This means that after hashing the byte ranges in the PDF you have to build the to-be-signed attributes for your signature container, hash and sign that set of attributes, and then put the attributes and their signature into a signature container.</p>\n<p>You can use BC classes to do the heavy lifting for you: If you put your remote signing service call into a <code>ContentSigner</code> implementation, you can use a simple <code>IExternalSignatureContainer</code> implementation like the <a href=\"https://github.com/mkl-public/testarea-itext7/blob/master/src/main/java/mkl/testarea/itext7/signature/PadesSignatureContainerBc.java\" rel=\"nofollow noreferrer\"><code>PadesSignatureContainerBc</code></a> from <a href=\"https://stackoverflow.com/questions/71225696/base64-digest-pfxpkcs12-etsi-cades-detached-signature-pades-ltv\">this answer</a>.</p>\n",
    "score" : 0,
    "is_accepted" : true,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97003,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1751470285,
    "last_activity_date" : 1751470285,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "question_comments" : [ {
    "comment_id" : 140558970,
    "post_id" : 79686911,
    "body" : "Hi @mkl, I’ve added an answer with more details based on your feedback. When you have a moment, I’d really appreciate it if you could take a look and let me know what you think. Thanks again for your guidance so far!",
    "score" : 0,
    "owner" : {
      "account_id" : 23806549,
      "reputation" : 3,
      "user_id" : 17815996,
      "user_type" : "registered",
      "profile_image" : "https://www.gravatar.com/avatar/5434b4c56506afbb65c6b7c9ffae636a?s=256&d=identicon&r=PG",
      "display_name" : "ahmet",
      "link" : "https://stackoverflow.com/users/17815996/ahmet"
    },
    "creation_date" : 1751468165,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140558635,
    "post_id" : 79686911,
    "body" : "Also you should check step 3: &quot;I send this hash to a remote signature provider.&quot; - do you use the correct signature provider endpoint for that? signature providers often offer endpoints both for signing raw data and for signing pre-hashed data. If you send the hash to the endpoint for signing raw data, the hash will be hashed again and your signature is invalid for the PDF.",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97003,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1751462497,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140558608,
    "post_id" : 79686911,
    "body" : "First of all, you request a signature value directly for the document hash. This implies that you don&#39;t want to use signed attributes in your PKCS#7 signature container. Many profiles, though, require the use of signed attributes. But let&#39;s assume you really want no signed attributes, then you need to properly tell BouncyCastle so in step 5. Thus, in particular code of that step would be great to inspect.",
    "score" : 0,
    "owner" : {
      "account_id" : 1916831,
      "reputation" : 97003,
      "user_id" : 1729265,
      "user_type" : "registered",
      "profile_image" : "https://i.sstatic.net/VMMeP.jpg?s=256",
      "display_name" : "mkl",
      "link" : "https://stackoverflow.com/users/1729265/mkl"
    },
    "creation_date" : 1751462132,
    "content_license" : "CC BY-SA 4.0"
  }, {
    "comment_id" : 140557631,
    "post_id" : 79686911,
    "body" : "You can try to inspect your final result with OpenSSL: <code>openssl asn1parse -in filename -inform DER</code> (or <code>-inform PEM</code>). It should fit RFC 2315’s ASN1",
    "score" : 0,
    "owner" : {
      "account_id" : 10054193,
      "reputation" : 1373,
      "user_id" : 7432968,
      "user_type" : "registered",
      "accept_rate" : 50,
      "profile_image" : "https://www.gravatar.com/avatar/5b8764444805e0141a8d5913511ddcf6?s=256&d=identicon&r=PG&f=y&so-version=2",
      "display_name" : "Matteo Meil",
      "link" : "https://stackoverflow.com/users/7432968/matteo-meil"
    },
    "creation_date" : 1751441233,
    "content_license" : "CC BY-SA 4.0"
  } ],
  "answer_comments" : {
    "79687701" : [ {
      "comment_id" : 140562057,
      "post_id" : 79687701,
      "body" : "After including certain certificate information in the signed attributes and hashing them, the signature was successfully validated. Thank you very much for your assistance.",
      "score" : 0,
      "owner" : {
        "account_id" : 23806549,
        "reputation" : 3,
        "user_id" : 17815996,
        "user_type" : "registered",
        "profile_image" : "https://www.gravatar.com/avatar/5434b4c56506afbb65c6b7c9ffae636a?s=256&d=identicon&r=PG",
        "display_name" : "ahmet",
        "link" : "https://stackoverflow.com/users/17815996/ahmet"
      },
      "creation_date" : 1751548156,
      "content_license" : "CC BY-SA 4.0"
    } ]
  }
}