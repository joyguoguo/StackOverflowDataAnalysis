# 数据导入测试说明

## 当前状态

数据导入进程已在后台启动，正在导入 3700 个 JSON 文件到 PostgreSQL 数据库。

## 验证导入结果

### 方法1: 使用 SQL 文件验证

已创建 `verify-data.sql` 文件，包含验证查询。在 PostgreSQL 客户端中运行：

```bash
psql -h localhost -p 5432 -U postgres -d stackoverflow_java -f verify-data.sql
```

### 方法2: 使用监控脚本

运行监控脚本，每30秒自动检查导入进度：

```powershell
.\monitor-import.ps1
```

### 方法3: 手动查询数据库

连接到 PostgreSQL 数据库并运行以下查询：

```sql
-- 查看各表的数据量
SELECT 'Questions' as table_name, COUNT(*) as count FROM questions
UNION ALL
SELECT 'Answers' as table_name, COUNT(*) as count FROM answers
UNION ALL
SELECT 'Question Comments' as table_name, COUNT(*) as count FROM question_comments
UNION ALL
SELECT 'Answer Comments' as table_name, COUNT(*) as count FROM answer_comments
UNION ALL
SELECT 'Users' as table_name, COUNT(*) as count FROM users
UNION ALL
SELECT 'Tags' as table_name, COUNT(*) as count FROM tags
ORDER BY table_name;
```

### 方法4: 检查应用日志

如果应用有日志输出，查看控制台或日志文件以了解导入进度。

## 预期结果

导入完成后，应该看到：
- **Questions**: 约 3700 条记录（对应 3700 个 JSON 文件）
- **Answers**: 根据数据文件中的回答数量
- **Question Comments**: 问题评论数量
- **Answer Comments**: 回答评论数量
- **Users**: 所有唯一的用户
- **Tags**: 所有唯一的标签

## 数据库配置

- **主机**: localhost:5432
- **数据库**: stackoverflow_java
- **用户名**: postgres
- **密码**: 123456

## 注意事项

1. 导入 3700 个文件需要较长时间（可能10-30分钟，取决于数据量和系统性能）
2. 导入过程中会先清空旧数据（因为表结构已改变）
3. 如果导入失败，检查：
   - PostgreSQL 服务是否运行
   - 数据库连接配置是否正确
   - 是否有足够的磁盘空间
   - 查看应用日志中的错误信息

## 导入完成后验证

运行以下查询验证数据完整性：

```sql
-- 检查是否有问题没有评论
SELECT q.question_id, q.title, 
       COUNT(qc.comment_id) as comment_count
FROM questions q
LEFT JOIN question_comments qc ON q.question_id = qc.question_id
GROUP BY q.question_id, q.title
HAVING COUNT(qc.comment_id) = 0
LIMIT 10;

-- 检查是否有回答没有评论
SELECT a.answer_id, a.question_id,
       COUNT(ac.comment_id) as comment_count
FROM answers a
LEFT JOIN answer_comments ac ON a.answer_id = ac.answer_id
GROUP BY a.answer_id, a.question_id
HAVING COUNT(ac.comment_id) = 0
LIMIT 10;

-- 验证外键关系
SELECT COUNT(*) as orphaned_question_comments
FROM question_comments qc
LEFT JOIN questions q ON qc.question_id = q.question_id
WHERE q.question_id IS NULL;

SELECT COUNT(*) as orphaned_answer_comments
FROM answer_comments ac
LEFT JOIN answers a ON ac.answer_id = a.answer_id
WHERE a.answer_id IS NULL;
```

## 如果导入失败

1. 检查 Java 进程是否还在运行：
   ```powershell
   Get-Process | Where-Object {$_.ProcessName -eq "java"}
   ```

2. 重新运行导入（会先清空数据）：
   ```powershell
   if (Test-Path mvnw.cmd) { 
       .\mvnw.cmd spring-boot:run "-Dspring-boot.run.main-class=cs209a.finalproject_demo.DataImporterApplication" "-Dspring-boot.run.arguments=--import.clean=true" 
   }
   ```

3. 查看详细错误日志，检查具体失败原因

